<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>ã€JUC ä¸€ã€åŸºç¡€çŸ¥è¯†ã€‘3.çº¿ç¨‹çš„å£°æ˜å‘¨æœŸä»¥åŠstartæ–¹æ³•æºç å‰–æ</title>
    <link href="/juc-1-3.html"/>
    <url>/juc-1-3.html</url>
    
    <content type="html"><![CDATA[<h1 id="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ"></a>çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ</h1><h2 id="ä»€ä¹ˆæ—¶å€™æ‰æ˜¯Thread"><a href="#ä»€ä¹ˆæ—¶å€™æ‰æ˜¯Thread" class="headerlink" title="ä»€ä¹ˆæ—¶å€™æ‰æ˜¯Thread"></a>ä»€ä¹ˆæ—¶å€™æ‰æ˜¯Thread</h2><p>å½“ä½ å®ä¾‹åŒ–ä¸€ä¸ª<code>Thread</code>ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">new</span> Thread();</code></pre><p>å¦‚æœåœ¨æ²¡æœ‰è°ƒç”¨å®ƒçš„<code>start</code>ä¹‹å‰ï¼Œå®ƒå…¶å®ä¸èƒ½ç§°ä¸º<code>Thread</code>ï¼Œåªæœ‰<code>start</code>ä¹‹åæ‰èƒ½ç§°ä¸º<code>Thread</code>ï¼Œåœ¨å®ƒstartä¹‹åæ˜¯ç«‹åˆ»è¿”å›çš„ï¼Œåœ¨ä¸Šä¸€ç« çš„ä¾‹å­ä¸­<code>Thread</code>çš„runæ–¹æ³•è¿˜æ²¡æ‰§è¡Œå®Œï¼Œ<code>main</code>å°±å·²ç»ç»“æŸå°±æ˜¯è¿™ä¸ªåŸå› ã€‚</p><hr><h2 id="å£°æ˜å‘¨æœŸåŸºæœ¬çŠ¶æ€"><a href="#å£°æ˜å‘¨æœŸåŸºæœ¬çŠ¶æ€" class="headerlink" title="å£°æ˜å‘¨æœŸåŸºæœ¬çŠ¶æ€"></a>å£°æ˜å‘¨æœŸåŸºæœ¬çŠ¶æ€</h2><blockquote><p>ä¸€ä¸ªçº¿ç¨‹å¿…é¡»ç»è¿‡å¥½å‡ ç§çŠ¶æ€çš„åˆ‡æ¢ï¼Œä¸ç®¡åœ¨JDKçš„å¹¶å‘åŒ…ï¼Œçº¿ç¨‹å…¶å®ä»£è¡¨çš„å†…åªæœ‰è¿™ä¸€ä¸ªThreadç±»ï¼Œä¸ç®¡æ˜¯çº¿ç¨‹æ± ã€Callbackã€Futureã€ForkJoinï¼Œå®ƒä»¬éƒ½æ˜¯Threadæ‰èƒ½ä»£è¡¨å®ƒï¼Œæ‰€ä»¥Threadæ˜¯ä¸€ä¸ªåŠ¡å¿…æŒæ¡çš„çŸ¥è¯†</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/7126254-55d47d5ebef3b1e2.jpg" srcset="/img/loading.gif" alt="7126254-55d47d5ebef3b1e2"></p><center>å›¾ 1-1 Threadç”Ÿå‘½å‘¨æœŸ</center> <h3 id="æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰"><a href="#æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰" class="headerlink" title="æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰"></a>æ–°å»ºçŠ¶æ€ï¼ˆNewï¼‰</h3><p>å½“çº¿ç¨‹å¯¹è±¡åˆ›å»ºåï¼Œå³è¿›å…¥æ–°å»ºçŠ¶æ€ï¼Œå¦‚ï¼š<code>Thread t = new MyThread();</code></p><blockquote><p>NOTE</p><p>è¿™é‡Œåªæ˜¯å®ä¾‹åŒ–ï¼Œå®ƒä¸å±äºThreadçš„å£°æ˜å‘¨æœŸï¼Œè¿™ä¸ª<code>new XXXå¯¹è±¡</code>çš„çŠ¶æ€æ˜¯å¯¹è±¡éƒ½æœ‰çš„</p></blockquote><h3 id="å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰"><a href="#å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰" class="headerlink" title="å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰"></a>å°±ç»ªçŠ¶æ€ï¼ˆRunnableï¼‰</h3><p>å½“è°ƒç”¨çº¿ç¨‹å¯¹è±¡çš„ start() æ–¹æ³•æ—¶ï¼Œçº¿ç¨‹å³è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹åªæ˜¯è¯´æ˜æ­¤çº¿ç¨‹å·²ç»åšå¥½å‡†å¤‡ï¼Œéšæ—¶ç­‰å¾… CPU è°ƒåº¦æ‰§è¡Œï¼Œå¹¶ä¸æ˜¯è¯´æ‰§è¡Œäº† start() æ–¹æ³•å°±ç«‹å³æ‰§è¡Œ</p><blockquote><p>NOTE</p><p>åœ¨startä¹‹åå®ƒæ‰èƒ½ç§°ä¸ºä¸€ä¸ªçº¿ç¨‹</p></blockquote><h3 id="è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰"><a href="#è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰" class="headerlink" title="è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰"></a>è¿è¡ŒçŠ¶æ€ï¼ˆRunningï¼‰</h3><p>å½“ CPU å¼€å§‹è°ƒåº¦å¤„äºå°±ç»ªçŠ¶æ€çš„çº¿ç¨‹æ—¶ï¼Œæ­¤æ—¶çº¿ç¨‹æ‰å¾—ä»¥çœŸæ­£æ‰§è¡Œï¼Œå³è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€ã€‚</p><blockquote><p>Note</p><p>åœ¨RunningçŠ¶æ€è¿‡ç¨‹ä¸­æœ‰å¯èƒ½<code>Runnable</code>,å¯èƒ½æŠŠæ‰§è¡Œæƒäº¤ç»™äº†å…¶å®ƒçº¿ç¨‹ï¼Œç°åœ¨ä¸èƒ½<code>Running</code>è¿›å…¥çŸ­æš‚çš„ä¼‘æ¯ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢æ˜¯åŸºäºCPUåšçš„ï¼Œåªä¸è¿‡å®ƒé€Ÿåº¦ç‰¹åˆ«å¿«ï¼Œä½ çœ‹ä¸å‡ºæ¥ï¼Œä½ ä»¥ä¸ºå®ƒæ˜¯åŒæ—¶è·‘äº†å¾ˆå¤šä¸œè¥¿ï¼Œå®ƒçš„åˆ‡æ¢é€Ÿåº¦åœ¨çº³ç§’ã€å¾®ç§’çº§çœ‹ä¸å‡ºæ¥æœ‰å½±å“ä½†æ˜¯å¯¹CPUçš„è°ƒåº¦æ¥è¯´å®ƒæ¯ä¸€ä¸ªæ—¶é—´ç‚¹å®ƒåªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨<code>Running</code>çš„æ—¶å€™è¿›è¡Œåˆ‡æ¢ï¼Œå®ƒä¹Ÿå°±è¿›å…¥äº†<code>Runnable</code>çŠ¶æ€</p></blockquote><h3 id="é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰"><a href="#é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰" class="headerlink" title="é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰"></a>é˜»å¡çŠ¶æ€ï¼ˆBlockedï¼‰</h3><p>å¤„äºè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹ç”±äºæŸç§åŸå› ï¼Œæš‚æ—¶æ”¾å¼ƒå¯¹ CPU çš„ä½¿ç”¨æƒï¼Œåœæ­¢æ‰§è¡Œï¼Œæ­¤æ—¶è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°å…¶è¿›å…¥åˆ°å°±ç»ªçŠ¶æ€ï¼Œæ‰æœ‰æœºä¼šå†æ¬¡è¢« CPU è°ƒç”¨ä»¥è¿›å…¥åˆ°è¿è¡ŒçŠ¶æ€ã€‚</p><blockquote><p>NOTE</p><p><code>Blocked</code>ä¹‹åæ— æ³•ç«‹å³å›åˆ°<code>Running</code>çŠ¶æ€ï¼Œå®ƒå¿…é¡»å…ˆåˆ°<code>Runnable</code>ï¼Œæ¯”å¦‚åœ¨<code>run</code>æ–¹æ³•ä¸­<code>sleep</code>ï¼Œ<code>sleep</code>ä¹‹åæ˜¯æ— æ³•ç«‹å³æ‰§è¡Œçš„ï¼Œ<code>sleep</code>ä¹‹åå®ƒä¼šè¿›å…¥<code>Runnable</code>çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ç»§ç»­èµ°<code>Runnable</code>çš„æµç¨‹ï¼šéšæ—¶ç­‰å¾…CPUè°ƒåº¦æ‰§è¡Œã€‚</p></blockquote><hr><p>é˜»å¡çŠ¶æ€åˆ†ç±»</p><ul><li>ç­‰å¾…é˜»å¡ï¼šè¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹æ‰§è¡Œ <code>wait ()</code> æ–¹æ³•ï¼Œä½¿æœ¬çº¿ç¨‹è¿›å…¥åˆ°ç­‰å¾…é˜»å¡çŠ¶æ€ï¼›</li><li>åŒæ­¥é˜»å¡ï¼šçº¿ç¨‹åœ¨è·å– <code>synchronized</code> åŒæ­¥é”å¤±è´¥ï¼ˆå› ä¸ºé”è¢«å…¶å®ƒçº¿ç¨‹å ç”¨ï¼‰ï¼Œå®ƒä¼šè¿›å…¥åˆ°åŒæ­¥é˜»å¡çŠ¶æ€ï¼›</li><li>å…¶ä»–é˜»å¡ï¼šé€šè¿‡è°ƒç”¨çº¿ç¨‹çš„ <code>sleep () æˆ– join ()</code> æˆ–å‘å‡º I/O è¯·æ±‚æ—¶ï¼Œçº¿ç¨‹ä¼šè¿›å…¥åˆ°é˜»å¡çŠ¶æ€ã€‚å½“ <code>sleep()</code> çŠ¶æ€è¶…æ—¶ã€<code>join()</code> ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢æˆ–è€…è¶…æ—¶ã€æˆ–è€… I/O å¤„ç†å®Œæ¯•æ—¶ï¼Œçº¿ç¨‹é‡æ–°è½¬å…¥å°±ç»ªçŠ¶æ€ã€‚</li></ul><h3 id="æ­»äº¡çŠ¶æ€"><a href="#æ­»äº¡çŠ¶æ€" class="headerlink" title="æ­»äº¡çŠ¶æ€"></a>æ­»äº¡çŠ¶æ€</h3><ul><li>åœ¨<code>Running</code>æ­£å¸¸ç»“æŸä¹‹åçº¿ç¨‹æ˜¯å¯ä»¥ç»ˆç»“çš„ï¼Œ<code>Blocked</code>æŠ¢é”çš„æ—¶å€™ä½ å°†å®ƒæ‰“æ–­äº†ï¼Œæ¯”å¦‚é€šè¿‡<code>wait</code>è¿›è¡Œæ‰“æ–­ï¼Œå®ƒä¹Ÿå¯èƒ½ä¼šçº¿ç¨‹è¿›å…¥ç»ˆç»“çŠ¶æ€ã€‚</li><li>åœ¨<code>Runnable</code>è¿‡ç¨‹ä¸­æ­»äº†ï¼Œä¹Ÿæœ‰å¯èƒ½å‡ºç°ç»ˆç»“çŠ¶æ€</li></ul><h1 id="startæ–¹æ³•æºç å‰–æ"><a href="#startæ–¹æ³•æºç å‰–æ" class="headerlink" title="startæ–¹æ³•æºç å‰–æ"></a>startæ–¹æ³•æºç å‰–æ</h1>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>JUC</category>
      
      <category>åŸºç¡€çŸ¥è¯†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€JUC ä¸€ã€åŸºç¡€çŸ¥è¯†ã€‘2.åˆ›å»ºå¹¶å¯åŠ¨çº¿ç¨‹</title>
    <link href="/juc-1-2.html"/>
    <url>/juc-1-2.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ¡ˆä¾‹æ¼”ç¤º"><a href="#æ¡ˆä¾‹æ¼”ç¤º" class="headerlink" title="æ¡ˆä¾‹æ¼”ç¤º"></a>æ¡ˆä¾‹æ¼”ç¤º</h1><blockquote><p>åœ¨Javaçš„æ–¹æ³•ä½“ä¸­ï¼Œå‡è®¾æŸå¤„åœ°æ–¹è€—æ—¶éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œé‚£ä¹ˆå°±ä¼šé€ æˆåé¢å…¨éƒ¨ç­‰å¾…ï¼Œè€Œåé¢çš„ä»£ç ä¸ä¸Šé¢çš„ä»£ç å®Œå…¨æ²¡æœ‰ä¾èµ–å…³ç³»ï¼Œåœ¨è¿™ä¸ªæ—¶å€™ä½¿ç”¨å¤šçº¿ç¨‹æ›´åˆé€‚ï¼Œä½ å¯ä»¥å¯¹å®ƒä»¬åˆ†åˆ«å»ºç«‹ä¸€ä¸ªçº¿ç¨‹æ¥å¹¶è¡Œæ‰§è¡Œã€‚ç°åœ¨æœ‰ä¸€ä¸ªåŠŸèƒ½ï¼šè¯»å–æ•°æ®åº“çš„æ•°æ®+å†™æ–‡ä»¶</p></blockquote><h2 id="æ™®é€šå®ç°"><a href="#æ™®é€šå®ç°" class="headerlink" title="æ™®é€šå®ç°"></a>æ™®é€šå®ç°</h2><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.shui.juc.chapter1;<span class="hljs-keyword">import</span> java.time.Duration;<span class="hljs-keyword">import</span> java.time.Instant;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è®¤è¯†å¤šçº¿ç¨‹</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Shui</span><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 2020-06-14 23:10:43</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TryConcurrency</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;    Instant start = Instant.now();    <span class="hljs-comment">//1ã€è¯»æ•°æ®åº“æ•°æ®</span>    readDatabase();    <span class="hljs-comment">//2ã€å†™æ–‡ä»¶</span>    writeFile();    Instant end = Instant.now();    print(<span class="hljs-string">"è€—æ—¶-&gt; "</span> + Duration        .between(start, end)        .getSeconds() + <span class="hljs-string">"s"</span>);  &#125;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * è¯»å–æ•°æ®åº“</span><span class="hljs-comment">   */</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">readDatabase</span><span class="hljs-params">()</span> </span>&#123;    print(<span class="hljs-string">"è¯»å–æ•°æ®åº“å¼€å§‹---"</span>);    <span class="hljs-keyword">try</span> &#123;      TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;      e.printStackTrace();    &#125;    print(<span class="hljs-string">"è¯»å–æ•°æ®åº“ç»“æŸ---"</span>);  &#125;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">writeFile</span><span class="hljs-params">()</span> </span>&#123;    print(<span class="hljs-string">"å†™æ–‡ä»¶å¼€å§‹---"</span>);    <span class="hljs-keyword">try</span> &#123;      TimeUnit.SECONDS.sleep(<span class="hljs-number">3</span>);    &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;      e.printStackTrace();    &#125;    print(<span class="hljs-string">"å†™æ–‡ä»¶ç»“æŸ---"</span>);  &#125;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print</span><span class="hljs-params">(Object object)</span> </span>&#123;    System.out.println(object);  &#125;&#125;</code></pre><p>è¿è¡Œç»“æœ</p><pre><code class="hljs elm">è¯»å–æ•°æ®åº“å¼€å§‹<span class="hljs-comment">---</span>è¯»å–æ•°æ®åº“ç»“æŸ<span class="hljs-comment">---</span>å†™æ–‡ä»¶å¼€å§‹<span class="hljs-comment">---</span>å†™æ–‡ä»¶ç»“æŸ<span class="hljs-comment">---</span>è€—æ—¶-&gt; <span class="hljs-number">6</span>s</code></pre><h2 id="å¹¶è¡Œæ‰§è¡Œå®ç°"><a href="#å¹¶è¡Œæ‰§è¡Œå®ç°" class="headerlink" title="å¹¶è¡Œæ‰§è¡Œå®ç°"></a>å¹¶è¡Œæ‰§è¡Œå®ç°</h2><p>å¹¶è¡Œæ‰§è¡Œå®é™…ä¸Šå°±æ˜¯å€¼å¤šçº¿ç¨‹äº†ï¼Œè¿™é‡Œå°†JDKæ–‡æ¡£çš„å®ä¾‹è´´å‡ºæ¥ï¼š</p><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrimeThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>&#123;         <span class="hljs-keyword">long</span> minPrime;         PrimeThread(<span class="hljs-keyword">long</span> minPrime) &#123;             <span class="hljs-keyword">this</span>.minPrime = minPrime;         &#125;         <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;             <span class="hljs-comment">// compute primes larger than minPrime</span>              . . .         &#125;     &#125;</code></pre><p>å¦‚æœæƒ³ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œåªéœ€è¦å®ç°Threadç±»å°±å¯ä»¥äº†ï¼Œè¿™é‡ŒæŠŠä¸šåŠ¡ä»£ç æ”¾åˆ°runæ–¹æ³•å°±OKäº†ã€‚æ¥ä¸‹æ¥ï¼Œé€šè¿‡è¿™ç§æ–¹å¼æ¥çœ‹çœ‹æ•ˆæœï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;    Instant start = Instant.now();    Thread t1 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-string">"readDatabase"</span>) &#123;      <span class="hljs-meta">@Override</span>      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">//1ã€è¯»æ•°æ®åº“æ•°æ®</span>        readDatabase();      &#125;    &#125;;    Thread t2 = <span class="hljs-keyword">new</span> Thread(<span class="hljs-string">"readDatabase"</span>) &#123;      <span class="hljs-meta">@Override</span>      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-comment">//2ã€å†™æ–‡ä»¶</span>        writeFile();      &#125;    &#125;;    t1.start();    t2.start();    Instant end = Instant.now();    print(<span class="hljs-string">"è€—æ—¶-&gt;"</span> + Duration        .between(start, end)        .getSeconds() + <span class="hljs-string">"s"</span>);  &#125;</code></pre><p>è¿è¡Œç»“æœï¼š</p><pre><code class="hljs elm">è¯»å–æ•°æ®åº“å¼€å§‹<span class="hljs-comment">---</span>å†™æ–‡ä»¶å¼€å§‹<span class="hljs-comment">---</span>è€—æ—¶-&gt; <span class="hljs-number">0</span>så†™æ–‡ä»¶ç»“æŸ<span class="hljs-comment">---</span>è¯»å–æ•°æ®åº“ç»“æŸ<span class="hljs-comment">---</span></code></pre><p>TIPSè¿™é‡Œè€—æ—¶0ç§’çš„åŸå› æ˜¯ mainä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œå¯¹äºå®ƒè€Œè¨€ï¼Œå®ƒå·²ç»æ‰§è¡Œå®Œäº†ï¼Œä» â€œè¯»å–æ•°æ®åº“å¼€å§‹â€”    \n å†™æ–‡ä»¶å¼€å§‹â€”â€ å¯ä»¥çœ‹åˆ°è¿™é‡Œå®ƒæ²¡æœ‰ç­‰æ•°æ®åº“ç»“æŸæ‰å¼€å§‹æ‰§è¡Œ å†™æ–‡ä»¶ï¼Œè€Œæ˜¯ç›´æ¥æ‰§è¡Œäº†è‡ªå·±çš„ã€‚</p><h1 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h1><blockquote><p>é€šè¿‡ä¸Šé¢çš„æ¡ˆä¾‹ï¼Œè®¤è¯†äº†Threadç±»ï¼Œé€šè¿‡å®ƒå¯ä»¥ç®€å•çš„å®ç°å¹¶è¡Œæ‰§è¡Œï¼Œå®ƒè¿™é‡Œæœ‰å¾ˆå¤šçš„å­¦é—®ï¼Œè¿™é‡Œå°±æ¥è¿›ä¸€æ­¥çš„è®¤è¯†</p></blockquote><p>Threadæ˜¯ä¸€ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œä¸€ä¸ªç¨‹åºã€‚javaè™šæ‹Ÿæœºçš„åº”ç”¨ç¨‹åºå¯ä»¥æœ‰å¤šä¸ªåŒæ—¶æ‰§è¡Œçš„çº¿ç¨‹ã€‚ </p><p>æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªä¼˜å…ˆæƒã€‚å…·æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹åœ¨ä¼˜å…ˆäºè¾ƒä½ä¼˜å…ˆçº§çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚æ¯ä¸€ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæˆ–å¯èƒ½ä¸ä¼šè¢«æ ‡è®°ä¸ºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚åœ¨ä¸€äº›çº¿ç¨‹ä¸­è¿è¡Œçš„ä»£ç åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„Threadå¯¹è±¡æ—¶ï¼Œæ–°çº¿ç¨‹çš„ä¼˜å…ˆçº§è¢«è®¾ç½®ä¸ºç­‰äºåˆ›å»ºçº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œæ˜¯å®ˆæŠ¤çº¿ç¨‹çš„å½“ä¸”ä»…å½“åˆ›å»ºçº¿ç¨‹æ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚</p><p>å½“ä¸€ä¸ªjavaè™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œé€šå¸¸æœ‰ä¸€ä¸ªå•ä¸€çš„éå®ˆæŠ¤çº¿ç¨‹ï¼ˆé€šå¸¸è°ƒç”¨æ–¹æ³•å‘½åä¸ºmainæŸæŒ‡å®šçš„ç±»ï¼‰ã€‚javaè™šæ‹Ÿæœºç»§ç»­æ‰§è¡Œçº¿ç¨‹ï¼Œç›´åˆ°å‘ç”Ÿä»¥ä¸‹æƒ…å†µï¼š</p><ul><li>Runtime exitç±»çš„æ–¹æ³•è¢«è°ƒç”¨å’Œå®‰å…¨ç»ç†å…è®¸é€€å‡ºæ“ä½œå‘ç”Ÿã€‚ </li><li>éå®ˆæŠ¤çº¿ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½å·²ç»æ­»äº†ï¼Œè¦ä¹ˆè¿”å›ä»ç”µè¯åˆ°runæ³•æˆ–æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ä¼ æ’­åˆ°runæ–¹æ³•ã€‚ </li></ul><h2 id="å¦‚ä½•éªŒè¯å®ƒæœ‰æ²¡æœ‰åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Ÿ"><a href="#å¦‚ä½•éªŒè¯å®ƒæœ‰æ²¡æœ‰åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Ÿ" class="headerlink" title="å¦‚ä½•éªŒè¯å®ƒæœ‰æ²¡æœ‰åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Ÿ"></a>å¦‚ä½•éªŒè¯å®ƒæœ‰æ²¡æœ‰åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Ÿ</h2><p>å¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæ¨èä½¿ç”¨ä¸€ä¸ªJDKæä¾›çš„å·¥å…·<strong>Jconsle</strong>ï¼Œå®ƒå¯ä»¥å¯¹çº¿ç¨‹è¿›è¡Œå¯è§†åŒ–ï¼Œä¸‹é¢å°±æ¥æ¼”ç¤ºä¸€ä¸‹ä½¿ç”¨æ–¹å¼ã€‚</p><p>1ï¼‰ã€ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œè¿™é‡Œå°†readDatabaseã€writeFileçš„sleepä¿®æ”¹åˆ°100ç§’</p><pre><code class="hljs java">TimeUnit.SECONDS.sleep(<span class="hljs-number">100</span>);</code></pre><p>2ï¼‰ã€å¯åŠ¨mainï¼Œåœ¨åˆ°æ§åˆ¶å°è¾“å…¥:</p><pre><code class="hljs shell">jconsole</code></pre><p>3ï¼‰ã€å¼¹å‡ºjconsoleå·¥å…·é€‰æ‹©å¯¹åº”çš„Class</p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200615003039106.png" srcset="/img/loading.gif" alt="image-20200615003039106" style="zoom: 80%;" /><p>4ï¼‰ã€é€‰æ‹©çº¿ç¨‹ï¼Œè¿™é‡Œå°±å¯ä»¥çœ‹åˆ°é‚£2ä¸ªçº¿ç¨‹äº†</p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200615003321805.png" srcset="/img/loading.gif" alt="image-20200615003321805" style="zoom: 50%;" /><blockquote><p>è¡¥å……ï¼šè¿™é‡Œå…¶å®ƒæ˜¯JVMçš„å®ˆæŠ¤çº¿ç¨‹ï¼š</p><p>Reference Handlerï¼šå¼•ç”¨å¥æŸ„å¤„ç†å™¨</p><p>Finalizerï¼šåƒåœ¾å›æ”¶å™¨</p><p>Signal Dispatcherï¼šæ”¶é›†ç³»ç»Ÿå‘å¸ƒä¿¡å·çš„</p><p>â€¦</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>JUC</category>
      
      <category>åŸºç¡€çŸ¥è¯†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€JUC ä¸€ã€åŸºç¡€çŸ¥è¯†ã€‘1.ç®€å•ä»‹ç»ä»€ä¹ˆæ˜¯çº¿ç¨‹</title>
    <link href="/juc-1-1.html"/>
    <url>/juc-1-1.html</url>
    
    <content type="html"><![CDATA[<p><a href="https://blog.csdn.net/linraise/article/details/12979473" target="_blank" rel="noopener">åŸæ–‡é“¾æ¥</a></p><p>å…³äºå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹ï¼Œæ•™ç§‘ä¹¦ä¸Šæœ€ç»å…¸çš„ä¸€å¥è¯æ˜¯ â€œè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„æœ€å°å•ä½ï¼Œçº¿ç¨‹æ˜¯ CPU è°ƒåº¦çš„æœ€å°å•ä½â€ã€‚è¿™å¥è¯åº”ä»˜è€ƒè¯•åŸºæœ¬ä¸Šå¤Ÿäº†ï¼Œä½†å¦‚æœåœ¨å·¥ä½œä¸­é‡åˆ°ç±»ä¼¼çš„é€‰æ‹©é—®é¢˜ï¼Œé‚£å°±æ²¡æœ‰é‚£ä¹ˆç®€å•äº†ï¼Œé€‰çš„ä¸å¥½ï¼Œä¼šè®©ä½ æ·±å—å…¶å®³ã€‚æ‰€ä»¥ä»–ä¹Ÿæ˜¯é¢è¯•è€…æœ€å–œæ¬¢è€ƒå¯Ÿçš„é¢˜ç›®ä¹‹ä¸€ã€‚</p><p>æˆ‘ä»¬æŒ‰ç…§å¤šä¸ªä¸åŒçš„ç»´åº¦ï¼Œæ¥çœ‹çœ‹å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹çš„å¯¹æ¯”ï¼ˆæ³¨ï¼šéƒ½æ˜¯ç›¸å¯¹çš„ï¼Œä¸æ˜¯è¯´ä¸€ä¸ªå¥½å¾—ä¸å¾—äº†ï¼Œå¦ä¸€ä¸ªå·®çš„æ— æ³•å¿å—ï¼‰</p><table><thead><tr><th>ç»´åº¦</th><th>å¤šè¿›ç¨‹</th><th>å¤šçº¿ç¨‹</th><th>æ€»ç»“</th></tr></thead><tbody><tr><td>æ•°æ®å…±äº«ã€åŒæ­¥</td><td>æ•°æ®æ˜¯åˆ†å¼€çš„ï¼šå…±äº«å¤æ‚ï¼Œéœ€è¦ç”¨ IPC; åŒæ­¥ç®€å•</td><td>å¤šçº¿ç¨‹å…±äº«è¿›ç¨‹æ•°æ®ï¼šå…±äº«ç®€å•ï¼›åŒæ­¥å¤æ‚</td><td>å„æœ‰ä¼˜åŠ¿</td></tr><tr><td>å†…å­˜ã€CPU</td><td>å ç”¨å†…å­˜å¤šï¼Œåˆ‡æ¢å¤æ‚ï¼ŒCPU åˆ©ç”¨ç‡ä½</td><td>å ç”¨å†…å­˜å°‘ï¼Œåˆ‡æ¢ç®€å•ï¼ŒCPU åˆ©ç”¨ç‡é«˜</td><td>çº¿ç¨‹å ä¼˜</td></tr><tr><td>åˆ›å»ºé”€æ¯ã€åˆ‡æ¢</td><td>åˆ›å»ºé”€æ¯ã€åˆ‡æ¢å¤æ‚ï¼Œé€Ÿåº¦æ…¢</td><td>å ç”¨å†…å­˜å°‘ï¼Œåˆ‡æ¢ç®€å•ï¼ŒCPU åˆ©ç”¨ç‡é«˜</td><td>çº¿ç¨‹å ä¼˜</td></tr><tr><td>ç¼–ç¨‹è°ƒè¯•</td><td>ç¼–ç¨‹ç®€å•ï¼Œè°ƒè¯•ç®€å•</td><td>ç¼–ç¨‹å¤æ‚ï¼Œè°ƒè¯•å¤æ‚</td><td>è¿›ç¨‹å ä¼˜</td></tr><tr><td>å¯é æ€§</td><td>è¿›ç¨‹é—´ä¸ä¼šç›¸äº’å½±å“</td><td>ä¸€ä¸ªçº¿ç¨‹æŒ‚æ‰å°†å¯¼è‡´æ•´ä¸ªè¿›ç¨‹æŒ‚æ‰</td><td>è¿›ç¨‹å ä¼˜</td></tr><tr><td>åˆ†å¸ƒå¼</td><td>é€‚åº”äºå¤šæ ¸ã€å¤šæœºåˆ†å¸ƒ ï¼›å¦‚æœä¸€å°æœºå™¨ä¸å¤Ÿï¼Œæ‰©å±•åˆ°å¤šå°æœºå™¨æ¯”è¾ƒç®€å•</td><td>é€‚åº”äºå¤šæ ¸åˆ†å¸ƒ</td><td>è¿›ç¨‹å ä¼˜</td></tr></tbody></table><p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹é—´çš„æ¯”è¾ƒ</p><table><thead><tr><th>å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„å±æ€§</th><th>å­çº¿ç¨‹ç»§æ‰¿ä¸»çº¿ç¨‹çš„å±æ€§</th></tr></thead><tbody><tr><td>å®é™…ç”¨æˆ· IDï¼Œå®é™…ç»„ IDï¼Œæœ‰æ•ˆç”¨æˆ· IDï¼Œæœ‰æ•ˆç»„ IDï¼›<br/><br/>é™„åŠ ç»„ IDï¼›<br/><br/>è¿›ç¨‹ç»„ IDï¼›<br/><br/>ä¼šè¯ IDï¼›<br/><br/>æ§åˆ¶ç»ˆç«¯ï¼›<br/><br/>è®¾ç½®ç”¨æˆ· ID æ ‡å¿—å’Œè®¾ç½®ç»„ ID æ ‡å¿—ï¼›<br/><br/>å½“å‰å·¥ä½œç›®å½•ï¼›<br/><br/>æ ¹ç›®å½•ï¼›<br/><br/>æ–‡ä»¶æ¨¡å¼åˆ›å»ºå±è”½å­—ï¼ˆumaskï¼‰ï¼›<br/><br/>ä¿¡å·å±è”½å’Œå®‰æ’ï¼›<br/><br/>é’ˆå¯¹ä»»ä¸€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„åœ¨æ‰§è¡Œæ—¶å…³é—­ï¼ˆclose-on-execï¼‰æ ‡å¿—ï¼›<br/><br/>ç¯å¢ƒï¼›<br/><br/>è¿æ¥çš„å…±äº«å­˜å‚¨æ®µï¼›<br/><br/>å­˜å‚¨æ˜ å°„ï¼›<br/><br/>èµ„æºé™åˆ¶ï¼›<br/></td><td>è¿›ç¨‹ä¸­çš„æ‰€æœ‰ä¿¡æ¯å¯¹è¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„ï¼›<br/><br/>å¯æ‰§è¡Œçš„ç¨‹åºæ–‡æœ¬ï¼›<br/><br/>ç¨‹åºçš„å…¨å±€å†…å­˜ï¼›<br/><br/>å †å†…å­˜ï¼›<br/><br/>æ ˆï¼›<br/><br/>æ–‡ä»¶æè¿°ç¬¦ï¼›<br/><br/>ä¿¡å·çš„å¤„ç†æ˜¯è¿›ç¨‹ä¸­æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ï¼ˆæ³¨æ„ï¼šå¦‚æœä¿¡å·çš„é»˜è®¤å¤„ç†æ˜¯ç»ˆæ­¢è¯¥è¿›ç¨‹é‚£ä¹ˆå³æ˜¯æŠŠä¿¡å·ä¼ ç»™æŸä¸ªçº¿ç¨‹ä¹Ÿä¸€æ ·ä¼šå°†è¿›ç¨‹æ€æ‰ï¼‰ï¼›<br/></td></tr><tr><td>çˆ¶å­è¿›ç¨‹ä¹‹é—´çš„åŒºåˆ«ï¼š</td><td>å­çº¿ç¨‹ç‰¹æœ‰çš„ï¼š</td></tr><tr><td>fork çš„è¿”å›å€¼ (=0 å­è¿›ç¨‹)ï¼›<br/><br/>è¿›ç¨‹ ID ä¸åŒï¼›<br/><br/>ä¸¤ä¸ªè¿›ç¨‹å…·æœ‰ä¸åŒçš„çˆ¶è¿›ç¨‹ IDï¼›<br/><br/>å­è¿›ç¨‹çš„ tms_utime,tms_stime,tms_cutime ä»¥åŠ tms_ustime å‡è¢«è®¾ç½®ä¸º 0ï¼›<br/><br/>ä¸ç»§æ‰¿çˆ¶è¿›ç¨‹è®¾ç½®çš„æ–‡ä»¶é”ï¼›<br/><br/>å­è¿›ç¨‹çš„æœªå¤„ç†é—¹é’Ÿè¢«æ¸…é™¤ï¼›<br/><br/>å­è¿›ç¨‹çš„æœªå¤„ç†ä¿¡å·é›†è®¾ç½®ä¸ºç©ºé›†ï¼›<br/></td><td>çº¿ç¨‹ IDï¼›<br/>ä¸€ç»„å¯„å­˜å™¨å€¼ï¼›<br/>æ ˆ<br/>è°ƒåº¦ä¼˜å…ˆçº§å’Œç­–ç•¥ï¼›<br/>ä¿¡å·å±è”½å­—ï¼›<br/>errno å˜é‡ï¼›<br/>çº¿ç¨‹ç§æœ‰æ•°æ®ï¼›</td></tr></tbody></table><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/2018122721302863.jpg" srcset="/img/loading.gif" alt="img"></p><p>1ï¼‰ã€éœ€è¦é¢‘ç¹åˆ›å»ºé”€æ¯çš„ä¼˜å…ˆç”¨çº¿ç¨‹<br>å®ä¾‹ï¼šweb æœåŠ¡å™¨ã€‚æ¥ä¸€ä¸ªå»ºç«‹ä¸€ä¸ªçº¿ç¨‹ï¼Œæ–­äº†å°±é”€æ¯çº¿ç¨‹ã€‚è¦æ˜¯ç”¨è¿›ç¨‹ï¼Œåˆ›å»ºå’Œé”€æ¯çš„ä»£ä»·æ˜¯å¾ˆéš¾æ‰¿å—çš„;</p><p>2ï¼‰ã€éœ€è¦è¿›è¡Œå¤§é‡è®¡ç®—çš„ä¼˜å…ˆä½¿ç”¨çº¿ç¨‹<br>æ‰€è°“å¤§é‡è®¡ç®—ï¼Œå½“ç„¶å°±æ˜¯è¦æ¶ˆè€—å¾ˆå¤š cpuï¼Œåˆ‡æ¢é¢‘ç¹äº†ï¼Œè¿™ç§æƒ…å†µå…ˆçº¿ç¨‹æ˜¯æœ€åˆé€‚çš„ã€‚<br>å®ä¾‹ï¼šå›¾åƒå¤„ç†ã€ç®—æ³•å¤„ç†ï¼›</p><p>3ï¼‰ã€å¼ºç›¸å…³çš„å¤„ç†ç”¨çº¿ç¨‹ï¼Œè‹¥ç›¸å…³çš„å¤„ç†ç”¨è¿›ç¨‹ï¼›<br>ä»€ä¹ˆå«å¼ºç›¸å…³ã€å¼±ç›¸å…³ï¼Ÿç†è®ºä¸Šå¾ˆéš¾å®šä¹‰ï¼Œç»™ä¸ªç®€å•çš„ä¾‹å­å°±æ˜ç™½äº†ã€‚<br>ä¸€èˆ¬çš„ server éœ€è¦å®Œæˆå¦‚ä¸‹ä»»åŠ¡ï¼šæ¶ˆæ¯æ”¶å‘å’Œæ¶ˆæ¯å¤„ç†ã€‚æ¶ˆæ¯æ”¶å‘å’Œæ¶ˆæ¯å¤„ç†å°±æ˜¯å¼±ç›¸å…³çš„ä»»åŠ¡ï¼Œè€Œæ¶ˆæ¯å¤„ç†é‡Œé¢å¯èƒ½åˆåˆ†ä¸ºæ¶ˆæ¯è§£ç ã€ä¸šåŠ¡å¤„ç†ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡ç›¸å¯¹æ¥è¯´ç›¸å…³æ€§å°±è¦å¼ºå¤šäº†ã€‚å› æ­¤æ¶ˆæ¯æ”¶å‘å’Œæ¶ˆæ¯å¤„ç†å¯ä»¥åˆ†è¿›ç¨‹è®¾è®¡ï¼Œæ¶ˆæ¯è§£ç å’Œä¸šåŠ¡å¤„ç†å¯ä»¥åˆ†çº¿ç¨‹è®¾è®¡ï¼›</p><p>4ï¼‰ã€å¯èƒ½æ‰©å±•åˆ°å¤šæœºåˆ†å¸ƒçš„ç”¨è¿›ç¨‹ï¼Œå¤šæ ¸åˆ†å¸ƒçš„ç”¨çº¿ç¨‹ï¼›</p><p>5ï¼‰ã€éƒ½æ»¡è¶³éœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œç”¨ä½ æœ€ç†Ÿæ‚‰ã€æœ€æ‹¿æ‰‹çš„æ–¹å¼ã€‚</p><blockquote><p> TIPS</p><p>è‡³äºâ€ æ•°æ®å…±äº«ã€åŒæ­¥ â€œã€â€œç¼–ç¨‹ã€è°ƒè¯•â€ã€â€œå¯é æ€§â€ è¿™å‡ ä¸ªç»´åº¦çš„æ‰€è°“çš„ â€œå¤æ‚ã€ç®€å•â€ åº”è¯¥æ€ä¹ˆå–èˆï¼Œåªèƒ½è¯´ï¼šæ²¡æœ‰æ˜ç¡®çš„é€‰æ‹©æ–¹æ³•ã€‚ä¸€èˆ¬æœ‰ä¸€ä¸ªé€‰æ‹©åŸåˆ™ï¼šå¦‚æœå¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹éƒ½èƒ½å¤Ÿæ»¡è¶³è¦æ±‚ï¼Œé‚£ä¹ˆé€‰æ‹©ä½ æœ€ç†Ÿæ‚‰ã€æœ€æ‹¿æ‰‹çš„é‚£ä¸ªã€‚</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>JUC</category>
      
      <category>åŸºç¡€çŸ¥è¯†</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Linuxã€‘ Vmwraeä¸­CentOSæ‰©å®¹</title>
    <link href="/linux-4.html"/>
    <url>/linux-4.html</url>
    
    <content type="html"><![CDATA[<p>æ–‡ç« è½¬è½½ï¼š<a href="https://www.cnblogs.com/Sungeek/p/9084510.html" target="_blank" rel="noopener">é“¾æ¥åœ°å€</a></p><h1 id="æŸ¥çœ‹CentOSçš„ç³»ç»ŸæŒ‚è½½ç‚¹ä¿¡æ¯"><a href="#æŸ¥çœ‹CentOSçš„ç³»ç»ŸæŒ‚è½½ç‚¹ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹CentOSçš„ç³»ç»ŸæŒ‚è½½ç‚¹ä¿¡æ¯"></a>æŸ¥çœ‹CentOSçš„ç³»ç»ŸæŒ‚è½½ç‚¹ä¿¡æ¯</h1><pre><code class="hljs bash">~&gt; df -lhæ–‡ä»¶ç³»ç»Ÿ                 å®¹é‡  å·²ç”¨  å¯ç”¨ å·²ç”¨% æŒ‚è½½ç‚¹devtmpfs                 979M     0  979M    0% /devtmpfs                    991M     0  991M    0% /dev/shmtmpfs                    991M  2.2M  989M    1% /runtmpfs                    991M     0  991M    0% /sys/fs/cgroup/dev/mapper/centos-root   13G  6.8G  5.8G   55% //dev/sda1               1014M  163M  852M   17% /boot...</code></pre><h1 id="æ‰©å±•-VMWare-CentOSç¡¬ç›˜ç©ºé—´"><a href="#æ‰©å±•-VMWare-CentOSç¡¬ç›˜ç©ºé—´" class="headerlink" title="æ‰©å±• VMWare-CentOSç¡¬ç›˜ç©ºé—´"></a>æ‰©å±• VMWare-CentOSç¡¬ç›˜ç©ºé—´</h1><p>â€‹<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200531225705745.png" srcset="/img/loading.gif" alt="image-20200531225705745" style="zoom: 60%;" /></p><h1 id="å¯¹æ‰©å®¹çš„ç¡¬ç›˜ç©ºé—´åˆ›å»ºåˆ†åŒºã€æ ¼å¼åŒ–"><a href="#å¯¹æ‰©å®¹çš„ç¡¬ç›˜ç©ºé—´åˆ›å»ºåˆ†åŒºã€æ ¼å¼åŒ–" class="headerlink" title="å¯¹æ‰©å®¹çš„ç¡¬ç›˜ç©ºé—´åˆ›å»ºåˆ†åŒºã€æ ¼å¼åŒ–"></a>å¯¹æ‰©å®¹çš„ç¡¬ç›˜ç©ºé—´åˆ›å»ºåˆ†åŒºã€æ ¼å¼åŒ–</h1><pre><code class="hljs bash">~&gt; fdisk /dev/sdaã€€ã€€ã€€ã€€ pã€€ã€€ã€€ã€€ã€€ã€€ã€€æŸ¥çœ‹å·²åˆ†åŒºæ•°é‡ï¼ˆæˆ‘çœ‹åˆ°æœ‰ä¸¤ä¸ª /dev/sda1 /dev/sda2ï¼‰ nã€€ã€€ã€€ã€€ã€€ã€€ã€€æ–°å¢åŠ ä¸€ä¸ªåˆ†åŒºpã€€ã€€ã€€ã€€ã€€ã€€ã€€åˆ†åŒºç±»å‹æˆ‘ä»¬é€‰æ‹©ä¸ºä¸»åˆ†åŒº ã€€ã€€ã€€ã€€ã€€ã€€     åˆ†åŒºå·è¾“å…¥3ï¼ˆå› ä¸º1,2å·²ç»ç”¨è¿‡äº†,sda1æ˜¯åˆ†åŒº1,sda2æ˜¯åˆ†åŒº2,sda3åˆ†åŒº3ï¼‰ å›è½¦ã€€ã€€ã€€ã€€ã€€  é»˜è®¤ï¼ˆèµ·å§‹æ‰‡åŒºï¼‰ å›è½¦ã€€ã€€ã€€ã€€ã€€  é»˜è®¤ï¼ˆç»“æŸæ‰‡åŒºï¼‰ tã€€ã€€ã€€ã€€ã€€ã€€ã€€ ä¿®æ”¹åˆ†åŒºç±»å‹ ã€€ã€€ã€€ã€€ã€€ã€€     é€‰åˆ†åŒº3 8eã€€ã€€ã€€ã€€ã€€ ã€€ä¿®æ”¹ä¸ºLVMï¼ˆ8eå°±æ˜¯LVMï¼‰wã€€ã€€ã€€ã€€ã€€  ã€€å†™åˆ†åŒºè¡¨ qã€€ã€€ã€€ã€€ã€€  ã€€å®Œæˆï¼Œé€€å‡ºfdiskå‘½ä»¤<span class="hljs-comment">#ä½¿ç”¨partprobeå‘½ä»¤ æˆ–è€…é‡å¯æœºå™¨ </span>~&gt; partprobe<span class="hljs-comment">#æ ¼å¼åŒ–åˆ†åŒº</span>~&gt; mkfs.ext4 /dev/sda3</code></pre><h1 id="æ·»åŠ æ–°-LVM-åˆ°å·²æœ‰çš„-LVM-ç»„ï¼Œå®ç°æ‰©å®¹"><a href="#æ·»åŠ æ–°-LVM-åˆ°å·²æœ‰çš„-LVM-ç»„ï¼Œå®ç°æ‰©å®¹" class="headerlink" title="æ·»åŠ æ–° LVM åˆ°å·²æœ‰çš„ LVM ç»„ï¼Œå®ç°æ‰©å®¹"></a>æ·»åŠ æ–° LVM åˆ°å·²æœ‰çš„ LVM ç»„ï¼Œå®ç°æ‰©å®¹</h1><pre><code class="hljs bash">~&gt; lvmã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€           <span class="hljs-comment">#è¿›å…¥lvmç®¡ç†</span>lvm&gt;pvcreate /dev/sda3ã€€ã€€           <span class="hljs-comment">#è¿™æ˜¯åˆå§‹åŒ–åˆšæ‰çš„åˆ†åŒº3</span>lvm&gt;vgextend centos /dev/sda3     <span class="hljs-comment">#å°†åˆå§‹åŒ–è¿‡çš„åˆ†åŒºåŠ å…¥åˆ°è™šæ‹Ÿå·ç»„centos (å·å’Œå·ç»„çš„å‘½ä»¤å¯ä»¥é€šè¿‡ vgdisplay )</span>lvm&gt;vgdisplay -væˆ–è€…vgdisplayæŸ¥çœ‹free PE /Sitelvm&gt;lvextend -l+6143 /dev/mapper/centos-rootã€€ã€€<span class="hljs-comment">#æ‰©å±•å·²æœ‰å·çš„å®¹é‡ï¼ˆ6143 æ˜¯é€šè¿‡vgdisplayæŸ¥çœ‹free PE /Siteçš„å¤§å°ï¼‰</span>lvm&gt;pvdisplay <span class="hljs-comment">#æŸ¥çœ‹å·å®¹é‡ï¼Œè¿™æ—¶ä½ ä¼šçœ‹åˆ°ä¸€ä¸ªå¾ˆå¤§çš„å·äº†</span>lvm&gt;quit ã€€<span class="hljs-comment">#é€€å‡º</span></code></pre><p>ä¸Šé¢åªæ˜¯å·æ‰©å®¹äº†ï¼Œä¸‹é¢æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„çœŸæ­£æ‰©å®¹ï¼Œè¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼š</p><pre><code class="hljs bash">~&gt; xfs_growfs /dev/mapper/centos-root</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶ç¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Reactã€‘ Styled-Component + Tailwind CSS + Tailwind Macro</title>
    <link href="/react-1.html"/>
    <url>/react-1.html</url>
    
    <content type="html"><![CDATA[<h3 id="åˆ›å»ºReactå·¥ç¨‹"><a href="#åˆ›å»ºReactå·¥ç¨‹" class="headerlink" title="åˆ›å»ºReactå·¥ç¨‹"></a>åˆ›å»ºReactå·¥ç¨‹</h3><pre><code class="hljs bash">npx create-react-app <span class="hljs-variable">$&#123;name&#125;</span></code></pre><p>æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ„å»ºæ–‡ä»¶å¤¹ï¼š</p><blockquote><p>è¿™é‡Œåªæ˜¾ç¤ºä¸»è¦çš„åœ°æ–¹</p></blockquote><pre><code class="hljs tree">â”œâ”€babel-plugin-macros.config.jsâ”œâ”€package.jsonâ”œâ”€postcss.config.jsâ”œâ”€src|  â”œâ”€index.js|  â”œâ”€tailwind.config.js|  â”œâ”€styled|  |   â”œâ”€Form|  |   |  â””index.js|  â”œâ”€page|  â”œâ”€component|  |     â”œâ”€App|  |     |  â””index.jsx|  â”œâ”€asset|  |   â”œâ”€css|  |   |  â”œâ”€tailwind|  |   |  |    â”œâ”€global.css|  |   |  |    â””index.css</code></pre><h3 id="å®‰è£…ä¾èµ–"><a href="#å®‰è£…ä¾èµ–" class="headerlink" title="å®‰è£…ä¾èµ–"></a>å®‰è£…ä¾èµ–</h3><pre><code class="hljs bash">yarn add tailwindcss tailwind.macro@next styled-components  -Syarn add babel-plugin-macros  postcss-cli npm-run-all cross-env postcss-import -D</code></pre><h3 id="æ·»åŠ tailwindé…ç½®"><a href="#æ·»åŠ tailwindé…ç½®" class="headerlink" title="æ·»åŠ tailwindé…ç½®"></a>æ·»åŠ tailwindé…ç½®</h3><pre><code class="hljs bash">npx tailwind init src/tailwind.config.js</code></pre><p>tailwind.config.js</p><pre><code class="hljs js"><span class="hljs-built_in">module</span>.exports = &#123;purge: [<span class="hljs-string">'./src/**/*.html'</span>,<span class="hljs-string">'./src/**/*.vue'</span>,<span class="hljs-string">'./src/**/*.jsx'</span>,<span class="hljs-string">'./src/**/*.js'</span>,],theme: &#123;&#125;,variants: &#123;&#125;,plugins: [],&#125;;</code></pre><p>postcss.config.js</p><pre><code class="hljs js"><span class="hljs-built_in">module</span>.exports = &#123;plugins: [<span class="hljs-built_in">require</span>(<span class="hljs-string">'postcss-import'</span>),<span class="hljs-built_in">require</span>(<span class="hljs-string">'tailwindcss'</span>)(<span class="hljs-string">'./src/tailwind.config.js'</span>),<span class="hljs-built_in">require</span>(<span class="hljs-string">'autoprefixer'</span>),],&#125;;</code></pre><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><p>package.json</p><pre><code class="hljs json">"scripts": &#123;    "build:css": "cross-env NODE_ENV=production postcss src/asset/css/tailwind/global.css -o src/asset/css/tailwind/index.css",    "build:css-dev": "tailwind build src/asset/css/tailwind/global.css -o src/asset/css/tailwind/index.css",    "start:js": "react-scripts start",    "start": "npm-run-all build:css-dev start:js",    "build:js": "react-scripts build",    "build": "npm-run-all build:css build:js",    "test": "react-scripts test",    "eject": "react-scripts eject",    "serve": "serve.cmd -s  build"  &#125;</code></pre><p>src\asset\css\tailwind\global.css</p><pre><code class="hljs css"><span class="hljs-keyword">@tailwind</span> base;<span class="hljs-keyword">@tailwind</span> components;<span class="hljs-keyword">@tailwind</span> utilities;</code></pre><p>src\styled\Form\index.js</p><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> styled <span class="hljs-keyword">from</span> <span class="hljs-string">'styled-components'</span>;<span class="hljs-keyword">import</span> tw <span class="hljs-keyword">from</span> <span class="hljs-string">'tailwind.macro'</span>;<span class="hljs-keyword">const</span> StyledForm = styled.main.attrs(&#123;className: <span class="hljs-string">'flex flex-col h-screen justify-center items-center bg-gray-100'</span>,&#125;)<span class="hljs-string">`</span><span class="hljs-string">&amp; &#123;</span><span class="hljs-string">form &#123;</span><span class="hljs-string"><span class="hljs-subst">$&#123;tw<span class="hljs-string">`bg-white text-center rounded py-8 px-5 shadow max-w-xs`</span>&#125;</span></span><span class="hljs-string">&#125;</span><span class="hljs-string">input &#123;</span><span class="hljs-string"><span class="hljs-subst">$&#123;tw<span class="hljs-string">`border-gray-300 mb-4 w-full border-solid border rounded py-2 px-4`</span>&#125;</span></span><span class="hljs-string">&#125;</span><span class="hljs-string">button &#123;</span><span class="hljs-string"><span class="hljs-subst">$&#123;tw<span class="hljs-string">`bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 border border-blue-700 rounded`</span>&#125;</span></span><span class="hljs-string">&#125;</span><span class="hljs-string">&#125;</span><span class="hljs-string">`</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> StyledForm;</code></pre><p>src\component\App\index.jsx</p><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;<span class="hljs-keyword">import</span> StyledForm <span class="hljs-keyword">from</span> <span class="hljs-string">'../../styled/Form'</span>;<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> () =&gt; (&lt;StyledForm&gt;&lt;form&gt;&lt;input type=<span class="hljs-string">'text'</span> placeholder=<span class="hljs-string">'Full name'</span> /&gt;&lt;input type=<span class="hljs-string">'text'</span> placeholder=<span class="hljs-string">'Email'</span> /&gt;&lt;input type=<span class="hljs-string">'text'</span> placeholder=<span class="hljs-string">'Password'</span> /&gt;&lt;button&gt;Sign In&lt;<span class="hljs-regexp">/button&gt;</span><span class="hljs-regexp">&lt;/</span>form&gt;&lt;<span class="hljs-regexp">/StyledForm&gt;</span><span class="hljs-regexp">);</span></code></pre><p>src\index.js</p><pre><code class="hljs jsx"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;<span class="hljs-keyword">import</span> ReactDOM <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>;<span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">'./component/App'</span>;<span class="hljs-keyword">import</span> <span class="hljs-string">'./asset/css/tailwind/index.css'</span>;ReactDOM.render(&lt;React.StrictMode&gt;&lt;App /&gt;&lt;<span class="hljs-regexp">/React.StrictMode&gt;,</span><span class="hljs-regexp">document.getElementById('root')</span><span class="hljs-regexp">);</span></code></pre>]]></content>
    
    
    <categories>
      
      <category>å‰ç«¯</category>
      
      <category>React</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶ç¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ OAuth2-å­¦ä¹ ç¬”è®° ã€‘  2.OAuthè¿›é˜¶ç¯‡</title>
    <link href="/oauth2-2.html"/>
    <url>/oauth2-2.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ‰‹åŠ¨é…ç½®è®¤è¯æœåŠ¡"><a href="#æ‰‹åŠ¨é…ç½®è®¤è¯æœåŠ¡" class="headerlink" title="æ‰‹åŠ¨é…ç½®è®¤è¯æœåŠ¡"></a>æ‰‹åŠ¨é…ç½®è®¤è¯æœåŠ¡</h1><p>ç”±äº<code>AuthorizationServerConfig#configure(org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer)</code>éœ€è¦é…ç½®<code>AuthenticationManager</code>ï¼Œæ‰€ä»¥éœ€è¦å…ˆé…ç½®<code>WebSecurityConfig</code>ï¼Œæ¥å°†<code>AuthenticationManager</code>æ³¨å…¥åˆ°IOCä¸­</p><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    http        .formLogin()      .and()        .authorizeRequests()        .anyRequest()        .authenticated()      .and()        .csrf().disable();  &#125;  <span class="hljs-meta">@Bean</span>  <span class="hljs-meta">@Override</span>  <span class="hljs-meta">@SneakyThrows</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> AuthenticationManager <span class="hljs-title">authenticationManagerBean</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.authenticationManagerBean();  &#125;  <span class="hljs-meta">@Bean</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();  &#125;&#125;</code></pre><p>è®¤è¯æœåŠ¡é…ç½®ä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;  <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;  <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    clients        .inMemory()        .withClient(<span class="hljs-string">"mcr"</span>)        .secret(<span class="hljs-string">"mcr"</span>);  &#125;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    endpoints        .allowedTokenEndpointRequestMethods(HttpMethod.GET, HttpMethod.POST)        .userDetailsService(userDetailsService)        .authenticationManager(authenticationManager);  &#125;&#125;</code></pre><p>ä»¥ä¸Šè¿™äº›ä»£ç æ˜¯ä¹‹å‰è€çš„æ–¹å¼ï¼Œåœ¨æ–°çš„ç‰ˆæœ¬ä¸­è¿™æ ·æ˜¯æœ‰é—®é¢˜çš„ï¼Œå½“æˆ‘å»è®¿é—®<code>/oauth/token</code>çš„æ—¶å€™å®ƒä¼šæŠ¥ä¸€ä¸ªé”™è¯¯ï¼š</p><pre><code class="hljs xquery">java<span class="hljs-built_in">.lang</span>.IllegalArgumentException: There <span class="hljs-literal">is</span> no PasswordEncoder mapped <span class="hljs-keyword">for</span> the<span class="hljs-built_in"> id</span> <span class="hljs-string">"null"</span></code></pre><p>è¿™é‡Œé€šè¿‡ä¸‡èƒ½çš„æœç´¢å¼•æ“çŸ¥é“å®ƒçš„é—®é¢˜â€”â€”<a href="https://blog.csdn.net/Hello_World_QWP/article/details/81811462" target="_blank" rel="noopener">é“¾æ¥</a></p><hr><p>è¿™é‡Œæ­£ç¡®çš„æ‰“å¼€æ–¹å¼ï¼š</p><pre><code class="hljs bash">private PasswordEncoder passwordEncoder;    @Override  public void configure(ClientDetailsServiceConfigurer clients) throws Exception &#123;    clients        .inMemory()        .withClient(<span class="hljs-string">"mcr"</span>)        ğŸ‘‡å…³é”®ä»£ç         .secret(passwordEncoder.encode(<span class="hljs-string">"mcr"</span>));  &#125;</code></pre><h1 id="ä½¿ç”¨Rediså­˜å‚¨Token"><a href="#ä½¿ç”¨Rediså­˜å‚¨Token" class="headerlink" title="ä½¿ç”¨Rediså­˜å‚¨Token"></a>ä½¿ç”¨Rediså­˜å‚¨Token</h1><blockquote><p>è¿™ä¸ªåœ¨ä»¥å‰çš„Spring Securityä¸­æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œåœ¨å¤ä¹ ä¸‹</p></blockquote><p>pomåŠ å…¥Redisä¾èµ–</p><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--Redis--&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><hr><p>yml</p><pre><code class="hljs yml"><span class="hljs-attr">spring:</span>  <span class="hljs-attr">redis:</span>    <span class="hljs-attr">host:</span> <span class="hljs-string">mcr.dev.com</span>    <span class="hljs-attr">port:</span> <span class="hljs-number">6380</span></code></pre><hr><p>AuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> RedisConnectionFactory connectionFactory;<span class="hljs-meta">@Bean</span><span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">tokenStore</span><span class="hljs-params">()</span> </span>&#123;  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RedisTokenStore(connectionFactory);&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;  endpoints...              ğŸ‘‡å…³é”®ä»£ç       .tokenStore(tokenStore());&#125;</code></pre><h1 id="æƒé™æ§åˆ¶"><a href="#æƒé™æ§åˆ¶" class="headerlink" title="æƒé™æ§åˆ¶"></a>æƒé™æ§åˆ¶</h1><h2 id="æ•°æ®åº“è®¾è®¡"><a href="#æ•°æ®åº“è®¾è®¡" class="headerlink" title="æ•°æ®åº“è®¾è®¡"></a>æ•°æ®åº“è®¾è®¡</h2><p>å›¾1</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/Diagram2.jpg" srcset="/img/loading.gif" alt=""></p><ul><li>sys_userï¼šç•¥</li><li>sys_roleï¼šç•¥</li><li>sys_user_roleï¼šç•¥</li><li>sys_role_menuï¼šç•¥</li><li>sys_menuï¼šè¿™é‡Œçš„permissionæ˜¯ä¸€ä¸ªæƒé™æ ‡è¯†ï¼Œç”¨å®ƒæ¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦èƒ½è®¿é—®ç‰¹å®šçš„æ¥å£</li></ul><h2 id="è®¤è¯é€»è¾‘"><a href="#è®¤è¯é€»è¾‘" class="headerlink" title="è®¤è¯é€»è¾‘"></a>è®¤è¯é€»è¾‘</h2><p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªç±»ç»§æ‰¿Securityæä¾›çš„Userç±»ï¼Œä¸ªæ€§åŒ–è‡ªå·±éœ€è¦çš„å±æ€§</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.service;<span class="hljs-keyword">import</span> lombok.Getter;<span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<span class="hljs-keyword">import</span> java.io.Serializable;<span class="hljs-keyword">import</span> java.util.Collection;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;  <span class="hljs-meta">@Getter</span>  <span class="hljs-keyword">private</span> Integer id;  <span class="hljs-meta">@Getter</span>  <span class="hljs-keyword">private</span> Integer deptId;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrUser</span><span class="hljs-params">(Integer id, Integer deptId, String username, String password, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;    <span class="hljs-keyword">super</span>(username, password, authorities);    <span class="hljs-keyword">this</span>.id = id;    <span class="hljs-keyword">this</span>.deptId = deptId;  &#125;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrUser</span><span class="hljs-params">(Integer id, Integer deptId, String username, String password, <span class="hljs-keyword">boolean</span> enabled, <span class="hljs-keyword">boolean</span> accountNonExpired, <span class="hljs-keyword">boolean</span> credentialsNonExpired, <span class="hljs-keyword">boolean</span> accountNonLocked, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;    <span class="hljs-keyword">super</span>(username, password, enabled, accountNonExpired, credentialsNonExpired, accountNonLocked, authorities);    <span class="hljs-keyword">this</span>.id = id;    <span class="hljs-keyword">this</span>.deptId = deptId;  &#125;&#125;</code></pre><hr><p>McrUserDetailsServiceï¼šç•¥</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.service;<span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;    <span class="hljs-keyword">private</span> SysUserMapper userMapper;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String BCRYPT = <span class="hljs-string">"&#123;bcrypt&#125;"</span>;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        SysUser sysUser = userMapper.selectOneByUsername(username);        log.info(<span class="hljs-keyword">new</span> Gson().toJson(sysUser));        <span class="hljs-keyword">return</span> getMcrUser(username, sysUser);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> McrUser <span class="hljs-title">getMcrUser</span><span class="hljs-params">(String username, SysUser sysUser)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrUser(sysUser.getUserId(), sysUser.getDeptId(), username,                BCRYPT + sysUser.getPassword(), <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>,                StrUtil.equals(sysUser.getLockFlag(), <span class="hljs-string">"0"</span>),                AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));    &#125;&#125;</code></pre><h2 id="ä»¤ç‰Œå¢å¼º"><a href="#ä»¤ç‰Œå¢å¼º" class="headerlink" title="ä»¤ç‰Œå¢å¼º"></a>ä»¤ç‰Œå¢å¼º</h2><p>AuthorizationServerConfigï¼ˆè®¤è¯æœåŠ¡é…ç½®ç±»ï¼‰åŠ å…¥ä»¥ä¸‹ä»£ç </p><pre><code class="hljs java"><span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;       endpoints               ...               .tokenEnhancer(tokenEnhancer());   &#125;   <span class="hljs-meta">@Bean</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> TokenEnhancer <span class="hljs-title">tokenEnhancer</span><span class="hljs-params">()</span> </span>&#123;       <span class="hljs-keyword">return</span> (accessToken, authentication) -&gt; &#123;           McrUser user = (McrUser) authentication                   .getUserAuthentication()                   .getPrincipal();           <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; additionalInfo = <span class="hljs-keyword">new</span> HashMap&lt;&gt;(<span class="hljs-number">4</span>);           additionalInfo.put(<span class="hljs-string">"userId"</span>, user.getId());           additionalInfo.put(<span class="hljs-string">"deptId"</span>, user.getDeptId());           ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(additionalInfo);           <span class="hljs-keyword">return</span> accessToken;       &#125;;   &#125;</code></pre><hr><p>åœ¨è®¿é—®<code>/oauth/token</code>çš„æ—¶å€™å¾—åˆ°çš„æ•°æ®å˜æˆäº†ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"access_token"</span>: <span class="hljs-string">"059861b7-755c-4ebb-8869-d94b6314a977"</span>,    <span class="hljs-attr">"token_type"</span>: <span class="hljs-string">"bearer"</span>,    <span class="hljs-attr">"expires_in"</span>: <span class="hljs-number">43199</span>,    <span class="hljs-attr">"scope"</span>: <span class="hljs-string">"server"</span>,    <span class="hljs-attr">"deptId"</span>: <span class="hljs-number">1</span>,    <span class="hljs-attr">"userId"</span>: <span class="hljs-number">1</span>&#125;</code></pre><hr><p>ä¸šåŠ¡ä»£ç è·å–<code>McrUser</code>ä¸­çš„æ•°æ®ï¼š</p><pre><code class="hljs java">  SecurityContext context = SecurityContextHolder.getContext();<span class="hljs-keyword">return</span> (McrUser) context        .getAuthentication()        .getPrincipal();</code></pre><p>å¯ä»¥å°†å®ƒå°è£…ä¸ºä¸€ä¸ªå·¥å…·ç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.common.util;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å®‰å…¨å·¥å…·ç±»</span><span class="hljs-comment"> */</span><span class="hljs-meta">@UtilityClass</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityUtils</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–Authentication</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">getAuthentication</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> SecurityContextHolder                .getContext()                .getAuthentication();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–ç”¨æˆ·</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> McrUser <span class="hljs-title">getUser</span><span class="hljs-params">(Authentication authentication)</span> </span>&#123;        Object principal = authentication.getPrincipal();        <span class="hljs-keyword">if</span> (principal <span class="hljs-keyword">instanceof</span> McrUser) &#123;            <span class="hljs-keyword">return</span> (McrUser) principal;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–ç”¨æˆ·</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> McrUser <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>&#123;        Authentication authentication = getAuthentication();        <span class="hljs-keyword">if</span> (authentication == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;        &#125;        <span class="hljs-keyword">return</span> getUser(authentication);    &#125;</code></pre><h2 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="headerlink" title="è®¿é—®æ§åˆ¶"></a>è®¿é—®æ§åˆ¶</h2><blockquote><p>å®ç°åŠŸèƒ½ï¼šæ ¹æ®æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯<code>å›¾1</code>ä¸­çš„<code>sys_menu</code>è¡¨çš„<code>permission</code>æ¥æ§åˆ¶ç‰¹æ®Šçš„æ¥å£</p></blockquote><p>åœ¨<code>Spring Security</code>ä¸­çš„<code>Userç±»</code>çš„<code>authoritieså±æ€§</code>å°±æ˜¯ç”¨äºæ¥å£è®¿é—®æƒé™æ§åˆ¶çš„ï¼Œåœ¨ä¹‹å‰çš„ç¼–å†™çš„<code>McrUserDetailsServiceç±»</code>ä¸­ï¼š</p><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> McrUser get<span class="hljs-constructor">McrUser(String <span class="hljs-params">username</span>, SysUser <span class="hljs-params">sysUser</span>)</span> &#123;        return <span class="hljs-keyword">new</span> <span class="hljs-constructor">McrUser(<span class="hljs-params">sysUser</span>.<span class="hljs-params">getUserId</span>()</span>, sysUser.get<span class="hljs-constructor">DeptId()</span>, username,                BCRYPT + sysUser.get<span class="hljs-constructor">Password()</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>,                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">StrUtil</span>.</span></span>equals(sysUser.get<span class="hljs-constructor">LockFlag()</span>, <span class="hljs-string">"0"</span>),                <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">AuthorityUtils</span>.</span></span>comma<span class="hljs-constructor">SeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>)</span>);    &#125;</code></pre><p>è¿™é‡Œç»™çš„æ˜¯ä¸€ä¸ªæ­»çš„å€¼ï¼Œè¿™é‡Œéœ€è¦å°†å®ƒè¯¥ä¸ºç”¨<code>sys_menuçš„permission</code></p><hr><p>å»ºç«‹ä¸€ä¸ª<code>UserInfo</code>æ¥å…³è”<code>sys_user</code>å’Œ<code>sys_menuçš„permission</code></p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.common.model.dto;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserInfo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">private</span> SysUser sysUser;    <span class="hljs-keyword">private</span> String[] permissions;&#125;</code></pre><hr><p>SysMenuMapper</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.common.mapper;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SysMenuMapper</span> </span>&#123;   <span class="hljs-function">List&lt;SysMenu&gt; <span class="hljs-title">findByRoleId</span><span class="hljs-params">(@Param(<span class="hljs-string">"roleId"</span>)</span> Integer roleId)</span>;&#125;</code></pre><p>SysMenuMapper.xml</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findByRoleId"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"BaseResultMap"</span>&gt;</span>        select *        from sys_menu m                 JOIN sys_role_menu rm ON m.menu_id = rm.menu_id        WHERE rm.role_id = #&#123;roleId,jdbcType=INTEGER&#125;;<span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.common.service.impl;<span class="hljs-meta">@Service</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SysUserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SysUserService</span> </span>&#123;  <span class="hljs-keyword">private</span> SysUserMapper userMapper;  <span class="hljs-keyword">private</span> SysMenuMapper menuMapper;  <span class="hljs-keyword">private</span> SysRoleMapper roleMapper;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å’Œå®ƒçš„æƒé™</span><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> username ç”¨æˆ·å</span><span class="hljs-comment">   * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">   */</span>  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> UserInfo <span class="hljs-title">selectOneByUsername</span><span class="hljs-params">(String username)</span> </span>&#123;    SysUser sysUser = userMapper.selectOneByUsername(username);    <span class="hljs-keyword">if</span> (sysUser == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;    UserInfo userInfo = <span class="hljs-keyword">new</span> UserInfo();    Integer userId = sysUser.getUserId();    Set&lt;String&gt; permissions = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();    roleIdList.forEach(roleId -&gt; &#123;      List&lt;String&gt; permissionList = menuMapper          .findByRoleId(roleId)          .stream()          .filter(menu -&gt; StrUtil.isNotBlank(menu.getPermission()))          .map(SysMenu::getPermission)          .collect(Collectors.toList());      permissions.addAll(permissionList);    &#125;);    userInfo.setSysUser(sysUser);    userInfo.setPermissions(permissions.toArray(<span class="hljs-keyword">new</span> String[<span class="hljs-number">0</span>]));    <span class="hljs-keyword">return</span> userInfo;  &#125;&#125;</code></pre><hr><p>McrUserDetailsServiceå…¨éƒ¨ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.service;<span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;  <span class="hljs-keyword">private</span> SysUserService userService;  <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String BCRYPT = <span class="hljs-string">"&#123;bcrypt&#125;"</span>;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;    UserInfo userInfo = userService.selectOneByUsername(username);    log.info(<span class="hljs-keyword">new</span> Gson().toJson(userInfo));    <span class="hljs-keyword">return</span> getMcrUser(username, userInfo);  &#125;  <span class="hljs-function"><span class="hljs-keyword">private</span> McrUser <span class="hljs-title">getMcrUser</span><span class="hljs-params">(String username, UserInfo userInfo)</span> </span>&#123;    SysUser sysUser = userInfo.getSysUser();    Set&lt;String&gt; permissions = <span class="hljs-keyword">new</span> HashSet&lt;&gt;(Arrays.asList(userInfo.getPermissions()));    List&lt;GrantedAuthority&gt; authorityList = AuthorityUtils.createAuthorityList(permissions.toArray(<span class="hljs-keyword">new</span> String[<span class="hljs-number">0</span>]));    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrUser(sysUser.getUserId(), sysUser.getDeptId(), username,        BCRYPT + sysUser.getPassword(), <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>,        StrUtil.equals(sysUser.getLockFlag(), <span class="hljs-string">"0"</span>),        authorityList);  &#125;&#125;</code></pre><hr><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.component;<span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Component</span>(<span class="hljs-string">"pms"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PermissionService</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hashPermission</span><span class="hljs-params">(String permission)</span> </span>&#123;    Authentication authentication = SecurityContextHolder        .getContext()        .getAuthentication();    <span class="hljs-keyword">if</span> (authentication == <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;    Collection&lt;? extends GrantedAuthority&gt; authorities = authentication.getAuthorities();    <span class="hljs-keyword">return</span> authorities        .stream()        .map(GrantedAuthority::getAuthority)        .filter(StringUtils::hasText)        .anyMatch(x -&gt; PatternMatchUtils.simpleMatch(permission, x));  &#125;&#125;</code></pre><p>è¿™ä¸ªç±»ç”¨äºåˆ¤æ–­å½“å‰æ¥å£ï¼Œç”¨æˆ·æ˜¯å¦å¯ä»¥è®¿é—®ã€‚æ–¹æ³•ä¸­çš„é€»è¾‘ï¼šä»ThreadLocalä¸­å–permissionsï¼Œçœ‹æ˜¯å¦æ»¡è¶³å‚æ•°ä¼ é€’çš„å€¼</p><hr><p>åœ¨IndexControllerä¸­å»ºç«‹ä¸€ä¸ªæ¥å£ï¼Œå¹¶ä½¿ç”¨å®ƒ</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/permissionTest"</span>)<span class="hljs-meta">@PreAuthorize</span>(<span class="hljs-string">"@pms.hashPermission('not')"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">permissionTest</span><span class="hljs-params">()</span> </span>&#123;  <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>;&#125;</code></pre><p>è¿™é‡Œçš„ <code>@PreAuthorize(&quot;@pms.hashPermission(&#39;not&#39;)&quot;)</code>ä¼šåœ¨<code>PermissionService#hashPermission</code>ä¼ é€’notå€¼æ¥éªŒè¯</p><hr><p>åœ¨<code>Spring Security 5.x</code>ä¸­<code>@PreAuthorize</code>é»˜è®¤æ˜¯ä¸ç”Ÿæ•ˆçš„ï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªæ³¨è§£å¼€å¯</p><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="hljs-keyword">true</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;...&#125;</code></pre><hr><p>è®¿é—®è¿™ä¸ªæ¥å£ä¼šå¾—åˆ°ä»¥ä¸‹ä¿¡æ¯ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"error"</span>: <span class="hljs-string">"access_denied"</span>,    <span class="hljs-attr">"error_description"</span>: <span class="hljs-string">"ä¸å…è®¸è®¿é—®"</span>&#125;</code></pre><h2 id="æ•°æ®åº“ä¸­çš„Client"><a href="#æ•°æ®åº“ä¸­çš„Client" class="headerlink" title="æ•°æ®åº“ä¸­çš„Client"></a>æ•°æ®åº“ä¸­çš„Client</h2><p>å¯¹äºä¹‹å‰çš„<code>clientIdå’Œsecret</code>çš„å®šä¹‰æ–¹å¼ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;   <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        clients                .inMemory()                .withClient(<span class="hljs-string">"mcr"</span>)                .secret(passwordEncoder.encode(<span class="hljs-string">"mcr"</span>))                .authorizedGrantTypes(<span class="hljs-string">"password"</span>,<span class="hljs-string">"refresh_token"</span>);    &#125;&#125;</code></pre><p>ä¸‹é¢æ¥å®ç°ä»æ•°æ®åº“ä¸­æ¥å–</p><hr><p>å»ºè¡¨sql</p><pre><code class="hljs mysql">CREATE TABLE sys_oauth_client_details(  client_id               VARCHAR(32)   NOT NULL    PRIMARY KEY,  resource_ids            VARCHAR(256)  NULL,  client_secret           VARCHAR(256)  NULL,  scope                   VARCHAR(256)  NULL,  authorized_grant_types  VARCHAR(256)  NULL,  web_server_redirect_uri VARCHAR(256)  NULL,  authorities             VARCHAR(256)  NULL,  access_token_validity   INT           NULL,  refresh_token_validity  INT           NULL,  additional_information  VARCHAR(4096) NULL,  autoapprove             VARCHAR(256)  NULL)  COMMENT &#39;ç»ˆç«¯ä¿¡æ¯è¡¨&#39;;</code></pre><hr><p>Javaä»£ç ï¼ˆä¸€æŠŠæ¢­ï¼‰</p><p>SecurityConstantï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.constant;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityConstant</span> </span>&#123;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * å­—æ®µ</span><span class="hljs-comment">   */</span>  String CLIENT_FIELDS = <span class="hljs-string">"client_id,"</span> +      <span class="hljs-string">"       CONCAT('&#123;noop&#125;', client_secret) AS client_secret,"</span> +      <span class="hljs-string">"       resource_ids,"</span> +      <span class="hljs-string">"       scope,"</span> +      <span class="hljs-string">"       authorized_grant_types,"</span> +      <span class="hljs-string">"       web_server_redirect_uri,"</span> +      <span class="hljs-string">"       authorities,"</span> +      <span class="hljs-string">"       access_token_validity,"</span> +      <span class="hljs-string">"       refresh_token_validity,"</span> +      <span class="hljs-string">"       additional_information,"</span> +      <span class="hljs-string">"       autoapprove"</span>;  String BASE_FIND_STATEMENT = <span class="hljs-string">"select "</span> + CLIENT_FIELDS      + <span class="hljs-string">" from sys_oauth_client_details"</span>;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * é»˜è®¤çš„æŸ¥è¯¢è¯­å¥</span><span class="hljs-comment">   */</span>  String DEFAULT_FIND_STATEMENT = BASE_FIND_STATEMENT + <span class="hljs-string">" order by client_id"</span>;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * æŒ‰æ¡ä»¶client_id æŸ¥è¯¢</span><span class="hljs-comment">   */</span>  String DEFAULT_SELECT_STATEMENT = BASE_FIND_STATEMENT + <span class="hljs-string">" where client_id = ?"</span>;&#125;</code></pre><p>AuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;  JdbcClientDetailsService jdbcClientDetailsService = <span class="hljs-keyword">new</span> JdbcClientDetailsService(dataSource);  jdbcClientDetailsService.setFindClientDetailsSql(SecurityConstant.DEFAULT_FIND_STATEMENT);  jdbcClientDetailsService.setSelectClientDetailsSql(SecurityConstant.DEFAULT_SELECT_STATEMENT);  clients      .withClientDetails(jdbcClientDetailsService);&#125;</code></pre><h2 id="è‡ªå®šä¹‰å“åº”"><a href="#è‡ªå®šä¹‰å“åº”" class="headerlink" title="è‡ªå®šä¹‰å“åº”"></a>è‡ªå®šä¹‰å“åº”</h2><blockquote><p>æˆ‘åˆšæ¥åˆ°ä¸€å®¶å…¬å¸ä¸Šç­ï¼Œå…¬å¸ç”¨çš„<code>Spring Security</code>åšæƒé™è®¤è¯ï¼Œè¿™é‡Œæˆ‘é‡è§äº†ä¸€ä¸ªé—®é¢˜ï¼šè¯·æ±‚ç™»å½•æ¥å£ã€Tokenè¿‡æœŸçš„æ•°æ®æ ¼å¼ä¿®æ”¹ä¸€ä¸‹ã€‚äºæ˜¯å°±æœ‰äº†è¿™ä¸€ç« èŠ‚</p></blockquote><h3 id="å¼‚å¸¸ç±»å‹"><a href="#å¼‚å¸¸ç±»å‹" class="headerlink" title="å¼‚å¸¸ç±»å‹"></a>å¼‚å¸¸ç±»å‹</h3><p>è‡ªå®šå“åº”å†…å®¹å°±éœ€è¦å…ˆäº†è§£Spring Securityå¸¸è§çš„å¼‚å¸¸éƒ½æœ‰å“ªäº›ï¼Ÿè¿™é‡Œåˆ—å‡ºå¸¸è§çš„å‡ ä¸ªï¼š</p><ul><li>UsernameNotFoundExceptionï¼ˆç”¨æˆ·ä¸å­˜åœ¨ï¼‰</li><li>DisabledExceptionï¼ˆç”¨æˆ·å·²è¢«ç¦ç”¨ï¼‰</li><li>BadCredentialsExceptionï¼ˆåçš„å‡­æ®ï¼‰</li><li>LockedExceptionï¼ˆè´¦æˆ·é”å®šï¼‰</li><li>AccountExpiredException ï¼ˆè´¦æˆ·è¿‡æœŸï¼‰</li><li>CredentialsExpiredExceptionï¼ˆè¯ä¹¦è¿‡æœŸï¼‰<br>â€¦</li></ul><h3 id="ä»å“ªä¸‹æ‰‹ï¼Ÿ"><a href="#ä»å“ªä¸‹æ‰‹ï¼Ÿ" class="headerlink" title="ä»å“ªä¸‹æ‰‹ï¼Ÿ"></a>ä»å“ªä¸‹æ‰‹ï¼Ÿ</h3><p><code>TokenEndpoint</code>æä¾›äº†<code>/oauth/token</code>è¯·æ±‚ï¼Œåœ¨è¿™ä¸ªè¯·æ±‚ä¸­å¯¹ä¸€äº›æƒ…å†µæŠ›å‡ºå¼‚å¸¸ï¼Œå¯¹äºè¿™äº›å¼‚å¸¸ï¼Œå®ƒè‡ªå·±ä¹Ÿåšäº†å¼‚å¸¸çš„æ•è·ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@ExceptionHandler</span>(HttpRequestMethodNotSupportedException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">ResponseEntity</span>&lt;<span class="hljs-title">OAuth2Exception</span>&gt; <span class="hljs-title">handleHttpRequestMethodNotSupportedException</span>(<span class="hljs-title">HttpRequestMethodNotSupportedException</span> <span class="hljs-title">e</span>) <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>&#123;<span class="hljs-comment">//...</span>    <span class="hljs-keyword">return</span> getExceptionTranslator().translate(e);&#125;<span class="hljs-meta">@ExceptionHandler</span>(Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">ResponseEntity</span>&lt;<span class="hljs-title">OAuth2Exception</span>&gt; <span class="hljs-title">handleException</span>(<span class="hljs-title">Exception</span> <span class="hljs-title">e</span>) <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>&#123;<span class="hljs-comment">//...</span><span class="hljs-keyword">return</span> getExceptionTranslator().translate(e);&#125;<span class="hljs-meta">@ExceptionHandler</span>(ClientRegistrationException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">ResponseEntity</span>&lt;<span class="hljs-title">OAuth2Exception</span>&gt; <span class="hljs-title">handleClientRegistrationException</span>(<span class="hljs-title">Exception</span> <span class="hljs-title">e</span>) <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>&#123;<span class="hljs-comment">//...</span><span class="hljs-keyword">return</span> getExceptionTranslator().translate(<span class="hljs-keyword">new</span> BadClientCredentialsException());&#125;<span class="hljs-meta">@ExceptionHandler</span>(OAuth2Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">ResponseEntity</span>&lt;<span class="hljs-title">OAuth2Exception</span>&gt; <span class="hljs-title">handleException</span>(<span class="hljs-title">OAuth2Exception</span> <span class="hljs-title">e</span>) <span class="hljs-title">throws</span> <span class="hljs-title">Exception</span> </span>&#123;<span class="hljs-comment">//...</span><span class="hljs-keyword">return</span> getExceptionTranslator().translate(e);&#125;</code></pre><p>ä»è¿™äº›å¼‚å¸¸å¤„ç†å™¨ä¸­éƒ½èƒ½çœ‹æœ€åçš„ä»£ç éƒ½æ˜¯<code>return getExceptionTranslator().translate(e);</code>ï¼Œå®ƒæ˜¯åšä»€ä¹ˆçš„ï¼Ÿè¿™é‡Œæ¥ç€çœ‹å®ƒè°ƒç”¨çš„è¿™ä¸ªæ–¹æ³•<code>translate</code></p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Translates exceptions into HTTP Responses.</span><span class="hljs-comment"> * </span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> &lt;T&gt; The error model that will be used as the HTTP Response body.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WebResponseExceptionTranslator</span>&lt;<span class="hljs-title">T</span>&gt; </span>&#123;<span class="hljs-function">ResponseEntity&lt;T&gt; <span class="hljs-title">translate</span><span class="hljs-params">(Exception e)</span> <span class="hljs-keyword">throws</span> Exception</span>;&#125;</code></pre><p>Translates exceptions into HTTP Responses.-&gt;å°†å¼‚å¸¸è½¬æ¢ä¸ºå“åº”ã€‚è¿™é‡Œè¯´çš„å¾ˆæ¸…æ¥šäº†ï¼Œå®é™…ä¸Šæ˜¯åªè¦ç¼–å†™ä¸€ä¸ªç±»å®ç°æ¥å£ä¸­çš„æ–¹æ³•å°±èƒ½å®ç°è‡ªå®šä¹‰çš„å“åº”ã€‚æ–¹æ³•ä¸­çš„å†…å®¹è¦æ€ä¹ˆå†™ï¼Ÿå¯ä»¥å‚è€ƒå®ƒçš„é»˜è®¤å®ç°ç±»ï¼š</p><p>DefaultWebResponseExceptionTranslator</p><hr><h3 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h3><p>é¦–å…ˆç¼–å†™ä¸€ä¸ªMcrAuth2ExceptionSerializerï¼Œè¿™é‡Œçš„ä»£ç ä¸åšè¿‡å¤šä»‹ç»ï¼Œå…³äº<code>fasterxml.jackson</code>æœ‰å¾ˆå¤šå†…å®¹è¦è®²ï¼Œæˆ‘ä»¥åä¼šç³»ç»Ÿçš„æ¥å¯¹è¿™ä¸ªå­¦ä¹ ã€‚</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.component;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuth2ExceptionSerializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StdSerializer</span>&lt;<span class="hljs-title">McrAuth2Exception</span>&gt; </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">McrAuth2ExceptionSerializer</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">super</span>(McrAuth2Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;  &#125;      <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">serialize</span><span class="hljs-params">(McrAuth2Exception e, JsonGenerator gen, SerializerProvider serializerProvider)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;    gen.writeStartObject();    gen.writeObjectField(<span class="hljs-string">"code"</span>, <span class="hljs-number">1</span>);    gen.writeObjectField(<span class="hljs-string">"msg"</span>, e.getMessage());    gen.writeObjectField(<span class="hljs-string">"data"</span>, e.getErrorCode());    gen.writeEndObject();  &#125;&#125;</code></pre><p>è‡ªå®šä¹‰å¼‚å¸¸åŸºç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">McrAuth2Exception</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OAuth2Exception</span> </span>&#123;  <span class="hljs-meta">@Getter</span>  <span class="hljs-keyword">private</span> String errorCode;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrAuth2Exception</span><span class="hljs-params">(String msg, String errorCode)</span> </span>&#123;    <span class="hljs-keyword">super</span>(msg);    <span class="hljs-keyword">this</span>.errorCode = errorCode;  &#125;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrAuth2Exception</span><span class="hljs-params">(String msg)</span> </span>&#123;    <span class="hljs-keyword">super</span>(msg);  &#125;&#125;</code></pre><p>è®¿é—®è¢«æ‹’ç»çš„å¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è®¿é—®è¢«æ‹’æ¥</span><span class="hljs-comment"> */</span><span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">ForbiddenException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">McrAuth2Exception</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ForbiddenException</span><span class="hljs-params">(String msg, Throwable t)</span> </span>&#123;    <span class="hljs-keyword">super</span>(msg);  &#125;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOAuth2ErrorCode</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-string">"access_denied"</span>;  &#125;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getHttpErrorCode</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> HttpStatus.FORBIDDEN.value();  &#125;&#125;</code></pre><p>æ— æ•ˆçš„å¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æ— æ•ˆçš„å¼‚å¸¸</span><span class="hljs-comment"> */</span><span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">InvalidException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">McrAuth2Exception</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InvalidException</span><span class="hljs-params">(String msg, Throwable t)</span> </span>&#123;<span class="hljs-keyword">super</span>(msg);&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOAuth2ErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-string">"invalid_exception"</span>;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getHttpErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-number">426</span>;&#125;&#125;</code></pre><p>ä¸å…è®¸çš„æ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ä¸å…è®¸çš„æ–¹æ³•</span><span class="hljs-comment"> */</span><span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">MethodNotAllowed</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">McrAuth2Exception</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MethodNotAllowed</span><span class="hljs-params">(String msg, Throwable t)</span> </span>&#123;<span class="hljs-keyword">super</span>(msg);&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOAuth2ErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-string">"method_not_allowed"</span>;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getHttpErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> HttpStatus.METHOD_NOT_ALLOWED.value();&#125;&#125;</code></pre><p>æœåŠ¡é”™è¯¯</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æœåŠ¡é”™è¯¯</span><span class="hljs-comment"> */</span><span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">ServerErrorException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">McrAuth2Exception</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ServerErrorException</span><span class="hljs-params">(String msg, Throwable t)</span> </span>&#123;<span class="hljs-keyword">super</span>(msg);&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOAuth2ErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-string">"server_error"</span>;&#125;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getHttpErrorCode</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> HttpStatus.INTERNAL_SERVER_ERROR.value();&#125;&#125;</code></pre><p>æœªç»æˆæƒçš„å¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.exception;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æœªç»è¿‡æˆæƒçš„å¼‚å¸¸</span><span class="hljs-comment"> */</span><span class="hljs-meta">@JsonSerialize</span>(using = McrAuth2ExceptionSerializer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">UnauthorizedException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">McrAuth2Exception</span> </span>&#123;  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UnauthorizedException</span><span class="hljs-params">(String msg, Throwable t)</span> </span>&#123;    <span class="hljs-keyword">super</span>(msg);  &#125;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getOAuth2ErrorCode</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-string">"unauthorized"</span>;  &#125;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getHttpErrorCode</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> HttpStatus.UNAUTHORIZED.value();  &#125;&#125;</code></pre><hr><p><code>WebResponseExceptionTranslatorå®ç°ç±»</code>ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.component;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrResponseExceptionTranslator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebResponseExceptionTranslator</span> </span>&#123;  <span class="hljs-keyword">private</span> ThrowableAnalyzer throwableAnalyzer = <span class="hljs-keyword">new</span> DefaultThrowableAnalyzer();  <span class="hljs-meta">@Override</span>  <span class="hljs-meta">@SneakyThrows</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity <span class="hljs-title">translate</span><span class="hljs-params">(Exception e)</span> </span>&#123;    Throwable[] causeChain = throwableAnalyzer.determineCauseChain(e);    Exception ase = (AuthenticationException) throwableAnalyzer.getFirstThrowableOfType(AuthenticationException<span class="hljs-class">.<span class="hljs-keyword">class</span>,</span><span class="hljs-class">        <span class="hljs-title">causeChain</span>)</span>;    <span class="hljs-keyword">if</span> (ase != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> handleOAuth2Exception(<span class="hljs-keyword">new</span> UnauthorizedException(e.getMessage(), e));    &#125;    ase = (AccessDeniedException) throwableAnalyzer        .getFirstThrowableOfType(AccessDeniedException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;    <span class="hljs-keyword">if</span> (ase != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> handleOAuth2Exception(<span class="hljs-keyword">new</span> ForbiddenException(ase.getMessage(), ase));    &#125;    ase = (InvalidGrantException) throwableAnalyzer        .getFirstThrowableOfType(InvalidGrantException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;    <span class="hljs-keyword">if</span> (ase != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> handleOAuth2Exception(<span class="hljs-keyword">new</span> InvalidException(ase.getMessage(), ase));    &#125;    ase = (HttpRequestMethodNotSupportedException) throwableAnalyzer        .getFirstThrowableOfType(HttpRequestMethodNotSupportedException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;    <span class="hljs-keyword">if</span> (ase != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> handleOAuth2Exception(<span class="hljs-keyword">new</span> MethodNotAllowed(ase.getMessage(), ase));    &#125;    ase = (OAuth2Exception) throwableAnalyzer.getFirstThrowableOfType(        OAuth2Exception<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;    <span class="hljs-keyword">if</span> (ase != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">return</span> handleOAuth2Exception((OAuth2Exception) ase);    &#125;    <span class="hljs-keyword">return</span> handleOAuth2Exception(<span class="hljs-keyword">new</span> ServerErrorException(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase(), e));  &#125;  <span class="hljs-function"><span class="hljs-keyword">private</span> ResponseEntity&lt;OAuth2Exception&gt; <span class="hljs-title">handleOAuth2Exception</span><span class="hljs-params">(OAuth2Exception e)</span> </span>&#123;    <span class="hljs-keyword">int</span> status = e.getHttpErrorCode();    HttpHeaders headers = <span class="hljs-keyword">new</span> HttpHeaders();    headers.set(HttpHeaders.CACHE_CONTROL, <span class="hljs-string">"no-store"</span>);    headers.set(HttpHeaders.PRAGMA, <span class="hljs-string">"no-cache"</span>);    <span class="hljs-keyword">if</span> (status == HttpStatus.UNAUTHORIZED.value() || (e <span class="hljs-keyword">instanceof</span> InsufficientScopeException)) &#123;      headers.set(HttpHeaders.WWW_AUTHENTICATE, String.format(<span class="hljs-string">"%s %s"</span>, OAuth2AccessToken.BEARER_TYPE, e.getSummary()));    &#125;    <span class="hljs-comment">// å®¢æˆ·ç«¯å¼‚å¸¸ç›´æ¥è¿”å›å®¢æˆ·ç«¯,ä¸ç„¶æ— æ³•è§£æ</span>    <span class="hljs-keyword">if</span> (e <span class="hljs-keyword">instanceof</span> ClientAuthenticationException) &#123;      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseEntity&lt;&gt;(e, headers,          HttpStatus.valueOf(status));    &#125;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseEntity&lt;&gt;(<span class="hljs-keyword">new</span> McrAuth2Exception(e.getMessage(), e.getOAuth2ErrorCode()), headers,        HttpStatus.valueOf(status));  &#125;&#125;</code></pre><p>åœ¨TokenEndpointä¸Šç»‘å®šä¸Š<code>McrResponseExceptionTranslator</code></p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;<span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    endpoints<span class="hljs-comment">//...       </span>        ğŸ‘‡å…³é”®ä»£ç         .exceptionTranslator(<span class="hljs-keyword">new</span> McrResponseExceptionTranslator());  &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>OAuth</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ OAuth2-å­¦ä¹ ç¬”è®° ã€‘  1.Hello OAuth2</title>
    <link href="/oauth2-1.html"/>
    <url>/oauth2-1.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>Spring Security å·²ç»æ›´æ–°åˆ°5.Xäº†ï¼Œæˆ‘ä¸ºäº†ä¸è¢«æŠ›å¤ªè¿œå†³å®šé‡æ–°å­¦ä¹ Spring Security 5.xä¸­çš„OAuth</p></blockquote><p>åˆ›å»ºä¸€ä¸ªspring bootå·¥ç¨‹</p><p>pomå¦‚ä¸‹ï¼š</p><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8" standalone="no"?&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.mcr<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>auth<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>OAuth Learn<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">spring-cloud.version</span>&gt;</span>Hoxton.SR3<span class="hljs-tag">&lt;/<span class="hljs-name">spring-cloud.version</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>      <span class="hljs-comment">&lt;!--  &lt;dependency&gt;</span><span class="hljs-comment">            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><span class="hljs-comment">            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><span class="hljs-comment">            &lt;version&gt;2.1.2&lt;/version&gt;</span><span class="hljs-comment">        &lt;/dependency&gt;</span><span class="hljs-comment">        &lt;dependency&gt;</span><span class="hljs-comment">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><span class="hljs-comment">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><span class="hljs-comment">            &lt;scope&gt;runtime&lt;/scope&gt;</span><span class="hljs-comment">        &lt;/dependency&gt;--&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>                    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.junit.vintage<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>                    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit-vintage-engine<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>                <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>compile<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.hutool<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hutool-all<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre><hr><p>ymlï¼š</p><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">4444</span><span class="hljs-attr">security:</span>  <span class="hljs-attr">oauth2:</span>    <span class="hljs-attr">client:</span>      <span class="hljs-attr">client-id:</span> <span class="hljs-string">mcr</span>      <span class="hljs-attr">client-secret:</span> <span class="hljs-string">mcr</span></code></pre><hr><p>Webå®‰å…¨é…ç½®ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.config;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.crypto.factory.PasswordEncoderFactories;<span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebSecurityConfig</span> </span>&#123;  <span class="hljs-meta">@Bean</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> PasswordEncoderFactories.createDelegatingPasswordEncoder();  &#125;&#125;</code></pre><p>è¿™é‡Œçš„<code>PasswordEncoderFactories.createDelegatingPasswordEncoder()</code>çš„è§£é‡Šè¿™é‡Œè¯´çš„å¾ˆæ¸…æ¥šï¼š<a href="https://www.cnblogs.com/Irving/p/9579025.html" target="_blank" rel="noopener">é“¾æ¥</a></p><hr><p>è®¤è¯æœåŠ¡é…ç½®ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.config;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizationServerConfig</span> </span>&#123;&#125;</code></pre><hr><p>èµ„æºæœåŠ¡é…ç½®ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.config;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableResourceServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ResourceServerConfig</span> </span>&#123;&#125;</code></pre><hr><p>è¿™é‡Œè‡ªå®šä¹‰ä¸€ä¸ªUserDetailsServiceï¼Œå°†å¯†ç è®¾ç½®ä¸º123æ–¹ä¾¿åšæµ‹è¯•</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.security.service;<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.springframework.security.core.authority.AuthorityUtils;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.User;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<span class="hljs-keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;  <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;    log.info(<span class="hljs-string">"è´¦å·ä¸º-&gt;&#123;&#125;è¿›è¡Œäº†éªŒè¯"</span>, username);    String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));  &#125;&#125;</code></pre><hr><p>ä¸šåŠ¡ç›¸å…³ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.auth.common.controller;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IndexController</span> </span>&#123;  <span class="hljs-meta">@GetMapping</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">index</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello OAuth!"</span>;  &#125;&#125;</code></pre><hr><p>ä¸Šé¢çš„<code>AuthorizationServerConfig</code>é…ç½®ç±»ä¼šæä¾›ä¸€äº›è¯·æ±‚ï¼Œè¿™é‡Œæˆ‘é€šè¿‡è¯·æ±‚å·¥å…·ç±»è¿›è¡Œè®¿é—®ä¸€ä¸‹<code>oauth/token</code>è¿™ä¸ªè¯·æ±‚è·¯å¾„ï¼Œå®ƒæ˜¯æˆæƒæ¨¡å¼ä¸­çš„ä¸€ç§ï¼Œå…·ä½“å…¶å®ƒçš„å¯å‚è€ƒ <a href="https://github.com/jeansfish/RFC6749.zh-cn/blob/master/SUMMARY.md" target="_blank" rel="noopener">OAuth2.0æˆæƒæ¨¡å¼</a>ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨çš„æ˜¯å¯†ç æ¨¡å¼ï¼Œé€šè¿‡IDEAæ¥è®¿é—®ï¼š</p><pre><code class="hljs http">POST http://localhost:4444/oauth/token<span class="hljs-attribute">Authorization</span>: Basic bWNyOm1jcg==<span class="hljs-attribute">Content-Type</span>: multipart/form-data; boundary=WebAppBoundary--WebAppBoundary<span class="hljs-attribute">Content-Disposition</span>: form-data; name="grant_type"<span class="hljs-attribute">password</span><span class="hljs-attribute">--WebAppBoundary</span><span class="hljs-attribute">Content-Disposition</span>: form-data; name="username"<span class="hljs-attribute">test</span><span class="hljs-attribute">--WebAppBoundary</span><span class="hljs-attribute">Content-Disposition</span>: form-data; name="password"<span class="hljs-attribute">123</span><span class="hljs-attribute">--WebAppBoundary</span><span class="hljs-attribute">Content-Disposition</span>: form-data; name="scope"<span class="hljs-attribute">server</span><span class="hljs-attribute">--WebAppBoundary--</span></code></pre><p>ç»“æœï¼š</p><pre><code class="hljs json">&#123;  <span class="hljs-attr">"access_token"</span>: <span class="hljs-string">"13a3d723-71df-4608-8457-718b001d96ce"</span>,  <span class="hljs-attr">"token_type"</span>: <span class="hljs-string">"bearer"</span>,  <span class="hljs-attr">"refresh_token"</span>: <span class="hljs-string">"d0fee4d9-1100-4d8c-922f-06de543ac5bf"</span>,  <span class="hljs-attr">"expires_in"</span>: <span class="hljs-number">43118</span>,  <span class="hljs-attr">"scope"</span>: <span class="hljs-string">"server"</span>&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>OAuth</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Linuxã€‘ Linuxä¸­çš„ä¸€äº›å‘½ä»¤</title>
    <link href="/linux-3.html"/>
    <url>/linux-3.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>è®°å½•ä¸€äº›å®¹æ˜“å¿˜è®°çš„å‘½ä»¤</p></blockquote><h1 id="æŸ¥çœ‹ç«¯å£å’Œpid"><a href="#æŸ¥çœ‹ç«¯å£å’Œpid" class="headerlink" title="æŸ¥çœ‹ç«¯å£å’Œpid"></a>æŸ¥çœ‹ç«¯å£å’Œpid</h1><pre><code class="hljs bash">~&gt; netstat  -luntp | grep 6379</code></pre><h1 id="ç®¡é“ç¬¦"><a href="#ç®¡é“ç¬¦" class="headerlink" title="ç®¡é“ç¬¦"></a>ç®¡é“ç¬¦</h1><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><h3 id="å¿½ç•¥ç¬¬1è¡Œï¼ŒåªæŸ¥1åˆ—"><a href="#å¿½ç•¥ç¬¬1è¡Œï¼ŒåªæŸ¥1åˆ—" class="headerlink" title="å¿½ç•¥ç¬¬1è¡Œï¼ŒåªæŸ¥1åˆ—"></a>å¿½ç•¥ç¬¬1è¡Œï¼ŒåªæŸ¥1åˆ—</h3><pre><code class="hljs bash">~&gt; docker images | awk <span class="hljs-string">'NR &gt; 1'</span> | awk <span class="hljs-string">'&#123; print $1 &#125;'</span>redismcr.harbor.com/library/redismcr.harbor.com/library/mysqlmysqlmcr.harbor.com/library/mysqlanapsix/alpine-java</code></pre><h2 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h2><pre><code class="hljs bash">~&gt; ps -ef | grep redis-serverroot      51475      1  0 22:18 ?        00:00:00 redis-server *:6370 [cluster]root      51479      1  0 22:18 ?        00:00:00 redis-server *:6371 [cluster]root      51483      1  0 22:18 ?        00:00:00 redis-server *:6372 [cluster]root      51487      1  0 22:18 ?        00:00:00 redis-server *:6373 [cluster]root      51492      1  0 22:19 ?        00:00:00 redis-server *:6374 [cluster]root      51497      1  1 22:19 ?        00:00:00 redis-server *:6375 [cluster]root      51502  44468  0 22:19 pts/0    00:00:00 grep --color=auto redis-server<span class="hljs-comment">#æ‰“å°PID</span>~&gt; ps -ef | grep redis-server | grep 637 | awk <span class="hljs-string">'&#123;print $2&#125;'</span>514755147951483514875149251497<span class="hljs-comment">#ä½¿ç”¨xargs</span>~&gt; ps -ef | grep redis-server | grep 637 | awk <span class="hljs-string">'&#123;print $2&#125;'</span> | â†’ å…³é”®ä½ç½® xargs <span class="hljs-built_in">kill</span></code></pre><h1 id="sed"><a href="#sed" class="headerlink" title="sed"></a>sed</h1><h2 id="æ›¿æ¢"><a href="#æ›¿æ¢" class="headerlink" title="æ›¿æ¢"></a>æ›¿æ¢</h2><p>å°†6379å…¨éƒ¨æ›¿æ¢ä¸º6380</p><pre><code class="hljs bash">&gt; sed <span class="hljs-string">'s/6379/6380/g'</span> redis-6379.conf  &gt; redis-6380.conf</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶ç¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Nginxã€‘ 4-æ·±åº¦å­¦ä¹ ç¯‡</title>
    <link href="/nginx-4.html"/>
    <url>/nginx-4.html</url>
    
    <content type="html"><![CDATA[<h1 id="åŠ¨é™åˆ†ç¦»"><a href="#åŠ¨é™åˆ†ç¦»" class="headerlink" title="åŠ¨é™åˆ†ç¦»"></a>åŠ¨é™åˆ†ç¦»</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»ï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»ï¼Ÿ"></a>ä»€ä¹ˆæ˜¯åŠ¨é™åˆ†ç¦»ï¼Ÿ</h3><p>é€šè¿‡ä¸­é—´ä»¶å°†åŠ¨æ€è¯·æ±‚å’Œé™æ€è¯·æ±‚åˆ†ç¦»ã€‚</p><h3 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åŠ¨é™åˆ†ç¦»ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åŠ¨é™åˆ†ç¦»ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åŠ¨é™åˆ†ç¦»ï¼Ÿ"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åŠ¨é™åˆ†ç¦»ï¼Ÿ</h3><p>å¯¹äºæœåŠ¡ç«¯è€Œè¨€å‡å°‘ä¸å¿…è¦çš„è¯·æ±‚æ¶ˆè€—ï¼Œæˆ‘ä¸€äº›é™æ€è¯·æ±‚çš„èµ„æºä¸éœ€è¦åç«¯çš„CPUè¿ç®—ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€æˆ‘è¯·æ±‚é™æ€èµ„æºä¸ç”¨å¤æ‚çš„è¿ç®—äº†é‚£ä¹ˆå°±å¯ä»¥å‡å°‘è¯·æ±‚çš„ç­‰å¾…æ—¶é—´ã€‚</p><p>æ²¡æœ‰åŠ¨é™åˆ†ç¦»çš„è¯·æ±‚æµç¨‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200213091855952-1581556745386.png" srcset="/img/loading.gif" alt="image-20200213091855952"></p><p>ä¸€ä¸ªè¯·æ±‚é¦–å…ˆå»ä¼šå»è¯·æ±‚ä¸­é—´ä»¶ï¼Œç”±ä¸­é—´ä»¶æŠŠè¯·æ±‚è½¬ç»™ç¨‹åºæ¡†æ¶æ‰§è¡Œå¯¹åº”çš„åŠ è½½ï¼Œç¨‹åºæ¡†æ¶å»æ‰§è¡Œè¿ç®—å¯¹åº”çš„ç¨‹åºè·å–ç›¸å…³çš„æ•°æ®èµ„æºã€‚å¦‚æœæ¯ä¸€æ¬¡è¯·æ±‚éƒ½éœ€è¦è¿™äº›å…³ç³»å¯¹äºè¯·æ±‚çš„æ¶ˆè€—å’Œå“åº”éƒ½ä¼šå—åˆ°å½±å“ã€‚</p><p>å¯¹äºé™æ€è¯·æ±‚è€Œè¨€å…¶å®ä¸éœ€è¦ç¨‹åºæ¡†æ¶ï¼Œé€šè¿‡ä¸­é—´ä»¶æ‰§è¡Œä»ç¡¬ç›˜é‡Œè·å–åˆ°è¿™ä¸ªé™æ€èµ„æºå°±å¯ä»¥äº†ã€‚</p><h2 id="åœºæ™¯æ¼”ç¤º"><a href="#åœºæ™¯æ¼”ç¤º" class="headerlink" title="åœºæ™¯æ¼”ç¤º"></a>åœºæ™¯æ¼”ç¤º</h2><p>è¿™é‡Œå‡†å¤‡äº†ä¸€ä¸ª<code>Spring Boot</code>çš„jaråŒ…ï¼Œæä¾›äº†ä¸€ä¸ªåŠ¨æ€çš„è¯·æ±‚</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo.web.controller;<span class="hljs-keyword">import</span> cn.hutool.core.util.RandomUtil;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Shui</span><span class="hljs-comment"> */</span><span class="hljs-meta">@RestController</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/demo"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoController</span> </span>&#123;  <span class="hljs-meta">@GetMapping</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> RandomUtil.randomInt(<span class="hljs-number">999</span>);  &#125;&#125;</code></pre><p>è¿™é‡Œå°†å®ƒå¯åŠ¨</p><pre><code class="hljs bash">/opt/app&gt; lscache  code1  code2  code3  demo.jar/opt/app&gt; nohup  java -jar demo.jar &gt; info.log &amp;</code></pre><p>ç­‰ä¼šæˆ‘ä»¬æ¼”ç¤ºçš„æ—¶å€™ä¼šè®¿é—®çš„é¡µé¢ï¼Œå®ƒçš„å†…å®¹ä¸ºï¼š</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>åŠ¨é™åˆ†ç¦»æµ‹è¯•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dynamic"</span>&gt;</span>Load...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://dev001.com/image/test.png"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://code.jquery.com/jquery-3.4.1.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">$(() =&gt; &#123;</span><span class="javascript">  $.<span class="hljs-keyword">get</span>('http://dev001.com/demo', (data) =&gt; &#123;</span><span class="javascript">    $(<span class="hljs-string">'#dynamic'</span>).text(data);</span>  &#125;, () =&gt; &#123;<span class="actionscript">    alert(<span class="hljs-string">'åŠ¨æ€è¯·æ±‚å¤±è´¥'</span>);</span>  &#125;);&#125;);<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><blockquote><p>è¿™é‡Œçš„imgè®¿é—®çš„å±äºé™æ€èµ„æºï¼Œè€Œé€šè¿‡jquery Ajajxè®¿é—®çš„æ˜¯åŠ¨æ€èµ„æº,è¿™ä¸ªhtmlæ–‡ä»¶æ”¾åœ¨<code>/opt/app/code</code>ä¸­</p></blockquote><p>ä¸Šé¢è¿™ä¸ªé¡µé¢çš„å›¾ç‰‡æ˜¯åœ¨è¿™é‡Œï¼š</p><pre><code class="hljs bash">/opt/app/code/image&gt; lstest.png</code></pre><p>test_mysite.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> ;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">access_log</span>  /var/log/nginx/host.access.log  main;    <span class="hljs-attribute">root</span> /opt/app/code;    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/demo</span> &#123;        <span class="hljs-attribute">proxy_pass</span> http://localhost:8080;    &#125;    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.html$</span> &#123;    &#125;    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.(jpg|png|gif)$</span> &#123;        <span class="hljs-attribute">expires</span> <span class="hljs-number">1h</span>;        <span class="hljs-attribute">gzip</span> <span class="hljs-literal">on</span>;    &#125;&#125;</code></pre><h1 id="Rewriteè§„åˆ™"><a href="#Rewriteè§„åˆ™" class="headerlink" title="Rewriteè§„åˆ™"></a>Rewriteè§„åˆ™</h1><h2 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>å®ç°urlé‡å†™ä»¥åŠé‡å®šå‘</p><h3 id="åœºæ™¯"><a href="#åœºæ™¯" class="headerlink" title="åœºæ™¯"></a>åœºæ™¯</h3><p>1ï¼‰ã€URLè®¿é—®è·³è½¬ï¼Œæ”¯æŒå¼€å‘è®¾è®¡</p><ul><li>é¡µé¢è·³è½¬</li><li>å…¼å®¹æ€§æ”¯æŒï¼šç‰ˆæœ¬å‡çº§çš„æ—¶å€™ä¸ºæ”¯æŒè€çš„ç‰ˆæœ¬ä¸ºäº†å…¼å®¹éƒ¨åˆ†è€çš„ç‰ˆæœ¬æˆ–è€…è€çš„ç”¨æˆ·è¿™ä¸ªæ—¶å€™éœ€è¦ç³»ç»Ÿè€çš„è¯·æ±‚è·¯å¾„ä½¿å¾—èƒ½è®¿é—®åˆ°ã€‚</li><li>å±•ç¤ºæ•ˆæœç­‰ï¼šå¯¹äºå¤æ‚çš„URLå¦‚æœå±•ç¤ºçš„è¿‡äºå¤æ‚è¿™æ ·å¯¹äºé¡µé¢å±•ç¤ºè·¯å¾„å°±æ˜¯å¤§é•¿ä¸²ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>rewriteè§„åˆ™</code>å°†å…¶ç²¾ç®€ç¼©ç•¥</li></ul><p>2ï¼‰ã€SEOä¼˜åŒ–</p><p>æˆ‘ä»¬çŸ¥é“å¯¹äºè°·æ­Œã€ç™¾åº¦è¿™ç§æœç´¢å¼•æ“ä¼˜åŒ–ï¼Œæœç´¢çš„æ•ˆç‡è¿˜æ’åæ˜¯ä¾èµ–ä¸URLè·¯å¾„çš„ï¼Œå¦‚æœæˆ‘ä»¬çš„è·¯å¾„è¿‡äºå¤æ‚ä¸ç¬¦åˆè°·æ­Œã€ç™¾åº¦è¿™äº›è§„åˆ™çš„è¯ï¼Œè¿™ä¸ªæ—¶å€™å¯¹æœç´¢å¼•æ“çš„å½•å…¥å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œåœ¨è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä¾èµ–äº<code>Nginx</code>æ¥è®©æˆ‘ä»¬åç«¯çš„æ¥å£é™æ€çš„æ”¹å†™ä»¥ç¬¦åˆå¯¹åº”æœç´¢å¼•æ“çš„æœç´¢è§„èŒƒ</p><p>3ï¼‰ã€ç»´æŠ¤</p><p>åå°ç»´æŠ¤ã€æµé‡è½¬å‘</p><p>4ï¼‰ã€å®‰å…¨</p><p>æˆ‘ä»¬ç”¨åˆ°<code>rewriteè§„åˆ™</code>å¯ä»¥å®ç°ä¼ªé™æ€ï¼Œæ‰€è°“ä¼ªé™æ€å°±æ˜¯å°†çœŸå®çš„åŠ¨æ€é¡µé¢è¿›è¡Œä¼ªè£…è®©é»‘å®¢è¿›è¡Œè®¿é—®æŠ“å–çš„æ—¶å€™æ„Ÿè§‰ä¸å‡ºæ¥è¿™æ˜¯ä¸€ä¸ªåŠ¨æ€é¡µé¢</p><h3 id="é…ç½®è¯­æ³•"><a href="#é…ç½®è¯­æ³•" class="headerlink" title="é…ç½®è¯­æ³•"></a>é…ç½®è¯­æ³•</h3><p>å¯¹äº<code>rewrite</code>å®ƒä¾èµ–äº<code>ngx_http_rewrite_module</code>è¿™ä¸ªæ¨¡å—ï¼Œè¯¦ç»†çš„é…ç½®å¯ä»¥å‚è€ƒ<a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">æ–‡æ¡£</a>ã€‚æ ¸å¿ƒçš„é…ç½®è¯­æ³•è¿™é‡Œåˆ—å‡ºæ¥å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">Syntax:</th><th><code>**rewrite** *regex* *replacement* [*flag*];</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>server</code>, <code>location</code>, <code>if</code></td></tr></tbody></table><ul><li>regexï¼šæ­£åˆ™è¡¨è¾¾å¼ï¼Œéœ€è¦å»æ”¹å†™çš„è·¯å¾„</li><li>replacementï¼šç›®æ ‡è¦æ›¿æ¢æˆå“ªä¸ªURLæˆ–è€…å¯¹åº”çš„è·¯å¾„</li><li>flagï¼šæ ‡è¯†</li></ul><p>å®ä¾‹ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^(.*)$</span> /pages/maintain.html <span class="hljs-literal">break</span>;</code></pre><blockquote><p>è¿™é‡Œæ„æ€æ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šé‡å®šå‘åˆ°<code>/pages/maintain.html</code>ï¼Œåé¢çš„breakæ˜¯æ ‡è¯†ç¬¦</p></blockquote><h3 id="rewriteæ­£åˆ™è¡¨è¾¾å¼"><a href="#rewriteæ­£åˆ™è¡¨è¾¾å¼" class="headerlink" title="rewriteæ­£åˆ™è¡¨è¾¾å¼"></a>rewriteæ­£åˆ™è¡¨è¾¾å¼</h3><table><thead><tr><th>ç¬¦å·</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>.</td><td>åŒ¹é…é™¤æ¢è¡Œç¬¦ä»¥å¤–çš„ä»»æ„å­—ç¬¦</td></tr><tr><td>?</td><td>é‡å¤0æ¬¡æˆ–1æ¬¡</td></tr><tr><td>*</td><td>æœ€å°‘é“¾æ¥æ•°ï¼Œå“ªä¸ªæœºå™¨è¿æ¥æ•°å°‘å°±åˆ†å‘</td></tr><tr><td>\d</td><td>åŒ¹é…æ•°å­—</td></tr><tr><td>\D</td><td>åŒ¹é…ä¸€ä¸ªéæ•°å­—å­—ç¬¦ã€‚ç­‰ä»·äº<code>[^0-9]</code>ã€‚</td></tr><tr><td>\s</td><td>åŒ¹é…ä¸€ä¸ªç©ºç™½å­—ç¬¦ï¼ŒåŒ…æ‹¬ç©ºæ ¼ã€åˆ¶è¡¨ç¬¦ã€æ¢é¡µç¬¦å’Œæ¢è¡Œç¬¦</td></tr><tr><td>\S</td><td>åŒ¹é…ä¸€ä¸ªéç©ºç™½å­—ç¬¦</td></tr><tr><td>\w</td><td>åŒ¹é…ä¸€ä¸ªå•å­—å­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—æˆ–è€…ä¸‹åˆ’çº¿ï¼‰ï¼Œç­‰ä»·äº <code>[A-Za-z0-9_]</code></td></tr><tr><td>\W</td><td>åŒ¹é…ä¸€ä¸ªéå•å­—å­—ç¬¦,ç­‰ä»·äº <code>[^A-Za-z0-9_]</code></td></tr><tr><td>^</td><td>åŒ¹é…å­—ç¬¦ä¸²çš„å¼€å§‹</td></tr><tr><td>$</td><td>åŒ¹é…å­—ç¬¦ä¸²çš„ä»‹ç»</td></tr><tr><td>{n}</td><td>é‡å¤næ¬¡</td></tr><tr><td>{n,}</td><td>é‡å¤næ¬¡æˆ–æ›´å¤šæ¬¡</td></tr><tr><td>[c]</td><td>åŒ¹é…å•ä¸ªå­—ç¬¦ä¸²c</td></tr><tr><td>[a-z]</td><td>åŒ¹é…a-zå°å†™å­—æ¯çš„ä»»æ„ä¸€ä¸ª</td></tr><tr><td>\</td><td>è½¬ä¹‰å­—ç¬¦ã€‚ä¾‹å¦‚ä½ æƒ³åŒ¹é…<code>index.php</code>è·³è½¬åˆ°å‰ç«¯é¡µé¢ï¼Œå°±æ˜¯è¿™ä¹ˆæ¥å†™ï¼š<code>rewrite index\.php$ /pages/maintain.html break;</code></td></tr><tr><td>()</td><td>ç”¨äºåŒ¹é…æ‹¬å·ä¹‹é—´çš„å†…å®¹ï¼Œé€šè¿‡<code>$1</code>ã€<code>$2</code>è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š<br /><code>rewrite ^(.*)$ /msie/$1 break;</code>ï¼Œè¿™é‡Œçš„æ‹¬å·éƒ¨åˆ†çš„å†…å®¹ä¼šæ”¾åœ¨<code>$1</code>ä¸­</td></tr></tbody></table><blockquote><p>ç”±äºæ­£åˆ™è¡¨è¾¾å¼åœ¨ç¼–ç¨‹è¯­è¨€ä¸­æ˜¯é€šç”¨çš„ï¼Œæƒ³äº†è§£æ›´å¤šå¯ä»¥å‚è€ƒ<code>Javascript</code>çš„<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Regular_Expressions" target="_blank" rel="noopener">æ­£åˆ™è¡¨è¾¾å¼æ–‡æ¡£</a></p></blockquote><p>å¯¹äºæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸ªLinuxæµ‹è¯•å·¥å…·â€œpcretestâ€ï¼Œå®ƒèƒ½å¤Ÿæµ‹è¯•è¡¨è¾¾å¼ï¼Œä½¿ç”¨æ–¹å¼å‚è€ƒ<a href="https://blog.csdn.net/xiao__jia__jia/article/details/84934552" target="_blank" rel="noopener">æ–‡ç« </a></p><h3 id="rewriteè§„åˆ™ä¸­çš„flag"><a href="#rewriteè§„åˆ™ä¸­çš„flag" class="headerlink" title="rewriteè§„åˆ™ä¸­çš„flag"></a>rewriteè§„åˆ™ä¸­çš„flag</h3><p>flagèƒ½æ ‡è®°rewriteå¯¹åº”çš„ç±»å‹ï¼Œå®ƒçš„ç±»å‹å¦‚ä¸‹ï¼š</p><table><thead><tr><th>ç±»å‹</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>last</td><td>åœæ­¢rewriteæ£€æµ‹</td></tr><tr><td>break</td><td>åœæ­¢rewriteæ£€æµ‹</td></tr><tr><td>redirect</td><td>è¿”å›302ä¸´æ—¶é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</td></tr><tr><td>permanent</td><td>è¿”å›301æ°¸ä¹…é‡å®šå‘ï¼Œåœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„åœ°å€</td></tr></tbody></table><h2 id="lastå’Œbreakçš„åŒºåˆ«"><a href="#lastå’Œbreakçš„åŒºåˆ«" class="headerlink" title="lastå’Œbreakçš„åŒºåˆ«"></a>lastå’Œbreakçš„åŒºåˆ«</h2><p>test_rewrite.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;    <span class="hljs-attribute">server_name</span> localhost;    <span class="hljs-attribute">access_log</span> /var/log/nginx/host.access.log main;    <span class="hljs-attribute">root</span> /opt/app/code;    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/break</span> &#123;        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/break</span> /test/ <span class="hljs-literal">break</span>;    &#125;    <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/last</span> &#123;        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/last</span> /test/ <span class="hljs-literal">last</span>;    &#125;    <span class="hljs-attribute">location</span> /test/ &#123;        <span class="hljs-attribute">default_type</span> application/json;        <span class="hljs-attribute">return</span> <span class="hljs-number">200</span> <span class="hljs-string">'&#123;"status","success"&#125;'</span>;    &#125;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; curl localhost/<span class="hljs-built_in">test</span>/&#123;<span class="hljs-string">"status"</span>,<span class="hljs-string">"success"</span>&#125;~&gt; curl localhost/<span class="hljs-built_in">break</span>&lt;html&gt;&lt;head&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;404 Not Found&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx/1.16.1&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;~&gt; curl localhost/last&#123;<span class="hljs-string">"status"</span>,<span class="hljs-string">"success"</span>&#125;</code></pre><p>ä¸Šé¢å¯ä»¥çœ‹åˆ°è®¿é—®è¿™ä¸ª<code>break</code>æ˜¯404ï¼Œå®ƒå°†ä¼šå»<code>root</code>å®šä¹‰çš„<code>/opt/app/code</code>å»æŸ¥æ‰¾å¯¹åº”çš„è®¿é—®è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Œåœ¨è¿™ä¸ªç›®å½•ä¸­æ˜¯æ²¡æœ‰testè¿™ä¸ªç›®å½•çš„ï¼Œæ‰€ä»¥å®ƒè¿™é‡Œä¼šå‡ºç°404ã€‚</p><p><code>last</code>è¿™é‡Œåˆ™æ˜¯æ–°å»ºä¸€ä¸ªè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¼šé‡æ–°è¯·æ±‚ä¸€æ¬¡æœåŠ¡ç«¯çš„åœ°å€ã€‚</p><h2 id="redirectå’Œpermanentçš„åŒºåˆ«"><a href="#redirectå’Œpermanentçš„åŒºåˆ«" class="headerlink" title="redirectå’Œpermanentçš„åŒºåˆ«"></a>redirectå’Œpermanentçš„åŒºåˆ«</h2><p>test_rewrite.confä¸­åŠ å…¥ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/redirect</span> &#123;      <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/redirect</span> https://www.baidu.com <span class="hljs-literal">redirect</span>;  &#125;  <span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/permanent</span> &#123;      <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/permanent</span> https://www.baidu.com <span class="hljs-literal">permanent</span>;  &#125;</code></pre><p>æµ‹è¯•æè¿°</p><blockquote><p>ç”±äºä¸å¤ªæ–¹ä¾¿å†™ï¼Œè¿™é‡Œå°±æ¥è¯´ä¸€è¯´å®ƒä»¬çš„åŒºåˆ«</p></blockquote><p>å®ƒä»¬2ä¸ªéƒ½èƒ½æˆåŠŸè·³è½¬åˆ°ç™¾åº¦ä¸Šå»ï¼Œå½“å°†Nginxå…³é—­æ—¶ï¼Œå»è®¿é—®<code>localhost/permanent</code>è¿˜æ˜¯èƒ½å¤Ÿè·³è½¬åˆ°ç™¾åº¦çš„ï¼Œä½†æ˜¯è®¿é—®<code>localhost/redirect</code>ä¼šå“åº”404ï¼Œè¿™æ˜¯å› ä¸º<code>permanent</code>ä¼šé€šè¿‡<code>Cookie</code>å‘Šè¯‰å®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯æµè§ˆå™¨è¯¥è·³è½¬åˆ°å“ªé‡Œï¼Œå³ä½¿æˆ‘ä»¬NginxæœåŠ¡åœæ‰äº†ï¼Œæµè§ˆå™¨ä¸‹ä¸€æ¬¡å»è®¿é—®<code>localhost/permanent</code>æ˜¯ç›´æ¥è·³è½¬åˆ°ç™¾åº¦ä¸Šå»çš„ï¼Œè€Œ<code>localhost/redirect</code>åˆ™æ˜¯éœ€è¦å…ˆåœ¨Nginxå‘é€ä¸€æ¬¡è¯·æ±‚è€Œè¿™ä¸ªæ—¶å€™Nginxæ˜¯å…³çš„ã€‚</p><h2 id="åœºæ™¯å®æˆ˜"><a href="#åœºæ™¯å®æˆ˜" class="headerlink" title="åœºæ™¯å®æˆ˜"></a>åœºæ™¯å®æˆ˜</h2><h3 id="é‡è§å¤šå±‚çº§ç›®å½•çš„é¡µé¢"><a href="#é‡è§å¤šå±‚çº§ç›®å½•çš„é¡µé¢" class="headerlink" title="é‡è§å¤šå±‚çº§ç›®å½•çš„é¡µé¢"></a>é‡è§å¤šå±‚çº§ç›®å½•çš„é¡µé¢</h3><pre><code class="hljs bash">/opt/app/code/11/22/33&gt; ls<span class="hljs-built_in">test</span>-1.html...<span class="hljs-built_in">test</span>-233.html</code></pre><blockquote><p>å‡è®¾æˆ‘ç»™Nginxçš„confçš„<code>root</code>è®¾ç½®çš„æ˜¯<code>/opt/app/code</code>é‚£ä¹ˆç”¨æˆ·æƒ³æ¥è®¿é—®è¿™ä¸ª<code>test-233.html</code>å°±éœ€è¦è¿™æ ·ï¼š<code>localhost/11/22/33/test-233.html</code>ï¼Œè¿™é‡Œé€šè¿‡rewriteå°†å®ƒçš„è®¿é—®ä¿®æ”¹ä¸€ä¸‹å§</p></blockquote><p>test_rewrite2.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span> default_server;    <span class="hljs-attribute">server_name</span> localhost;    <span class="hljs-attribute">access_log</span> /var/log/nginx/host.access.log main;    <span class="hljs-attribute">root</span> /opt/app/code;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(\d+)-(\d+)-(\d+)-test-(\d+)\.html</span> /<span class="hljs-variable">$1</span>/<span class="hljs-variable">$2</span>/<span class="hljs-variable">$3</span>/test-<span class="hljs-variable">$4</span>.html <span class="hljs-literal">break</span>;    &#125;&#125;</code></pre><p>ç»“æœ</p><pre><code class="hljs bash">curl http://dev001.com/11-22-33-test-233.htmlrewrite <span class="hljs-built_in">test</span></code></pre><h3 id="å¦‚æœæ˜¯è°·æ­Œæµè§ˆå™¨è½¬å‘åˆ°ç™¾åº¦ä¸Š"><a href="#å¦‚æœæ˜¯è°·æ­Œæµè§ˆå™¨è½¬å‘åˆ°ç™¾åº¦ä¸Š" class="headerlink" title="å¦‚æœæ˜¯è°·æ­Œæµè§ˆå™¨è½¬å‘åˆ°ç™¾åº¦ä¸Š"></a>å¦‚æœæ˜¯è°·æ­Œæµè§ˆå™¨è½¬å‘åˆ°ç™¾åº¦ä¸Š</h3><p>test_rewrite2.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(\d+)-(\d+)-(\d+)-test-(\d+)\.html</span> /<span class="hljs-variable">$1</span>/<span class="hljs-variable">$2</span>/<span class="hljs-variable">$3</span>/test-<span class="hljs-variable">$4</span>.html <span class="hljs-literal">break</span>;        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$http_user_agent</span> <span class="hljs-regexp">~* Chrome)</span>&#123;            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/nginx</span> https://www.baidu.com <span class="hljs-literal">redirect</span>;        &#125;    &#125;</code></pre><h3 id="æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†"><a href="#æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†" class="headerlink" title="æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†"></a>æ–‡ä»¶ä¸å­˜åœ¨å¤„ç†</h3><blockquote><p>å¦‚æœè¯·æ±‚çš„æ–‡ä»¶è·¯å¾„å­˜åœ¨å°±è®¿é—®å¯¹åº”çš„æ–‡ä»¶ï¼Œå¦‚æœä¸å­˜åœ¨å°±è·³è½¬ç™¾åº¦ä¸Š</p></blockquote><p>test_rewrite2.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;        <span class="hljs-comment">#...</span>        <span class="hljs-attribute">if</span> (!-f <span class="hljs-variable">$request_filename</span>) &#123;            <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^/(.*)$</span> https://www.baidu.com/s?wd=<span class="hljs-variable">$1</span> <span class="hljs-literal">redirect</span>;        &#125;    &#125;</code></pre><p>ç»“æœï¼š</p><pre><code class="hljs bash">~&gt; curl http://dev001.com/11-22-33-test-233.htmlrewrite <span class="hljs-built_in">test</span>~&gt; curl http://dev001.com/11-22-33-hahah-100.html&lt;html&gt;&lt;head&gt;&lt;title&gt;302 Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;302 Found&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx/1.16.1&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><h2 id="rewriteè§„åˆ™ä¹¦å†™"><a href="#rewriteè§„åˆ™ä¹¦å†™" class="headerlink" title="rewriteè§„åˆ™ä¹¦å†™"></a>rewriteè§„åˆ™ä¹¦å†™</h2><h3 id="Rewriteè§„åˆ™ä¼˜å…ˆçº§"><a href="#Rewriteè§„åˆ™ä¼˜å…ˆçº§" class="headerlink" title="Rewriteè§„åˆ™ä¼˜å…ˆçº§"></a>Rewriteè§„åˆ™ä¼˜å…ˆçº§</h3><ol><li>æ‰§è¡Œserverå—çš„rewriteæŒ‡ä»¤ï¼šå¯¹äºç½‘ç«™ç»´æŠ¤é¡µï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ‰€æœ‰è¯·æ±‚éƒ½é‡å®šå‘åˆ°ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼ŒåŠ åœ¨å¯¹åº”çš„serverä¸‹é¢ï¼Œæˆ–è€…httpä¸‹é¢</li><li>æ‰§è¡ŒlocationåŒ¹é…</li><li>æ‰§è¡Œé€‰å®šçš„locationä¸­çš„rewrite</li></ol><h3 id="ä¼˜é›…çš„Rewriteè§„åˆ™ä¹¦å†™"><a href="#ä¼˜é›…çš„Rewriteè§„åˆ™ä¹¦å†™" class="headerlink" title="ä¼˜é›…çš„Rewriteè§„åˆ™ä¹¦å†™"></a>ä¼˜é›…çš„Rewriteè§„åˆ™ä¹¦å†™</h3><p>åœ¨<code>Apache Tomcat</code>çš„è§„åˆ™é‡Œé¢ï¼ŒNginxçš„å†™æ³•ä¹Ÿæ˜¯å¯ä»¥æ”¯æŒçš„</p><pre><code class="hljs nginx">RewriteCond %&#123;HTTP_HOST&#125; nginx.org<span class="hljs-attribute">RewriteRule</span> (.*)</code></pre><p>åœ¨Nginxä¸­çš„å†™æ³•</p><pre><code class="hljs nginx">server&#123;<span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;  <span class="hljs-attribute">server_name</span> www.nginx.org nginx.org;  <span class="hljs-attribute">if</span> (<span class="hljs-variable">$http_host</span>=nginx.org) &#123;    <span class="hljs-attribute">rewrite</span> (.*) http://www.nginx.org<span class="hljs-variable">$1</span>;  &#125;...&#125;</code></pre><p>å¯¹äºè¿™ç§å†™æ³•ï¼Œå®˜æ–¹æ›´åŠ æ¨èè¿™æ ·ï¼š</p><pre><code class="hljs nginx">server&#123;  <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;  <span class="hljs-attribute">server_name</span> nginx.org;  <span class="hljs-attribute">rewrite</span><span class="hljs-regexp"> ^</span> http://www.nginx.org<span class="hljs-variable">$request_uri</span>?;&#125;</code></pre><blockquote><p>è¿™é‡Œåªéœ€è¦åŠ 1è¡Œå°±æå®šäº†ï¼Œå¯¹ä¸rewriteè§„åˆ™ï¼Œæˆ‘ä»¬ä¹¦å†™å¾—ä¼˜é›…ä»¥åŠåç«¯çš„æ€§èƒ½ä¹¦é¢æ•´æ´æ€§éƒ½æ˜¯éå¸¸æœ‰å­¦é—®çš„</p></blockquote><h1 id="è¿›é˜¶é«˜çº§æ¨¡å—"><a href="#è¿›é˜¶é«˜çº§æ¨¡å—" class="headerlink" title="è¿›é˜¶é«˜çº§æ¨¡å—"></a>è¿›é˜¶é«˜çº§æ¨¡å—</h1><h2 id="secure-link"><a href="#secure-link" class="headerlink" title="secure_link"></a>secure_link</h2><h3 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><blockquote><p>è¯¦ç»†å¯ä»¥å‚è€ƒ<a href="https://nginx.org/en/docs/http/ngx_http_secure_link_module.html" target="_blank" rel="noopener">å®˜ç½‘æ–‡æ¡£</a></p></blockquote><p><strong>ä½œç”¨</strong></p><ul><li>åˆ¶å®šå¹¶å…è®¸æ£€æŸ¥è¯·æ±‚çš„é“¾æ¥çš„çœŸå®æ€§ä»¥åŠä¿æŠ¤èµ„æºå…é­æœªç»æˆæƒçš„è®¿é—®</li><li>é™åˆ¶é“¾æ¥ç”Ÿæ•ˆå‘¨æœŸ</li></ul><hr><p><strong>é…ç½®è¯­æ³•</strong></p><table><thead><tr><th align="left">Syntax:</th><th><code>**secure_link** *expression*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><blockquote><p>å®šä¹‰ä¸€ä¸ªå¸¦æœ‰å˜é‡çš„å­—ç¬¦ä¸²ï¼Œä»ä¸­å°†æå–é“¾æ¥çš„æ ¡éªŒå’Œå€¼å’Œç”Ÿå­˜æœŸã€‚</p></blockquote><table><thead><tr><th align="left">Syntax:</th><th><code>**secure_link_md5** *expression*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><blockquote><p>å®šä¹‰ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œå°†ä¸ºå…¶è®¡ç®—MD5å“ˆå¸Œå€¼å¹¶å°†å…¶ä¸è¯·æ±‚ä¸­ä¼ é€’çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚</p></blockquote><hr><p><strong>å¸¸è§åœºæ™¯</strong></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200213201449276.png" srcset="/img/loading.gif" alt="image-20200213201449276"></p><ol><li>å®¢æˆ·ç«¯ä¸‹è½½æŸä¸ªæ–‡ä»¶ï¼Œç¬¬1æ­¥ï¼šç‚¹å‡»ä¸‹è½½æŒ‰é’®ï¼Œè¿™é‡Œä¼šå‘æœåŠ¡ç«¯å‘èµ·ä¸€æ¬¡è¯·æ±‚ï¼›</li><li>æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€ä¸ªä¸‹è½½åœ°å€å“åº”ç»™å®¢æˆ·ç«¯ï¼Œç”Ÿæˆçš„è¿™ä¸ªåœ°å€æ˜¯ç»è¿‡ä¸€ä¸²ç§˜é’¥ä»¥åŠç›¸åº”çš„ä¿¡æ¯å’Œè¿‡æœŸæ—¶é—´åŠ å¯†çš„ï¼Œä»¥å›¾ä¸­çš„è¯·æ±‚åœ°å€ä¸ºä¾‹ï¼Œè¿™é‡Œç”¨åˆ°äº†md5å­—ç¬¦ä¸²çš„åŠ å¯†ï¼Œå®ƒæ˜¯ä¸å¯åŒ¿çš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯è·å–äº†åŠ å¯†ä¸²å®ƒä¹Ÿè§£å¯†ä¸å‡ºæ¥ï¼Œåªæœ‰æœåŠ¡ç«¯æ‰èƒ½å¯¹åº”åŒ¹é…ï¼Œè¿™ä¸ªè¯·æ±‚åœ°å€ä¸­è¿˜æœ‰ä¸€ä¸ª<code>expires</code>ï¼Œè¿™ä¸ªæ˜¯ç”¨äºè®¾ç½®è¿‡æœŸæ—¶é—´çš„ï¼Œå®ƒè¿™é‡Œæ˜¯ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œä»£è¡¨è¿™ä¸ªè¯·æ±‚ä¼šåœ¨ä»€ä¹ˆæ—¶å€™è¿‡æœŸï¼›</li><li>è¿™ä¸ªæ—¶å€™å®Œæˆæ ¡éªŒï¼Œå¦‚æœæ ¡éªŒé€šè¿‡äº†ä¸‹è½½èµ„æºï¼Œå¦‚æœæ²¡æœ‰é€šè¿‡å°±è¿”å›ç›¸å…³é”™è¯¯ç ã€‚</li></ol><h3 id="å®ç°èµ„æºè¯·æ±‚éªŒè¯"><a href="#å®ç°èµ„æºè¯·æ±‚éªŒè¯" class="headerlink" title="å®ç°èµ„æºè¯·æ±‚éªŒè¯"></a>å®ç°èµ„æºè¯·æ±‚éªŒè¯</h3><p>è¿™é‡Œå‡†å¤‡äº†ä¸€ä¸ªæ–‡ä»¶ï¼š</p><pre><code class="hljs bash">~/opt/app/code/download&gt;  lsfile.txt</code></pre><p>md5url.shï¼šç”¨äºæ¨¡æ‹ŸæœåŠ¡ç«¯è¿”å›çš„åŠ å¯†ä¸‹è½½è¯·æ±‚åœ°å€</p><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash">!/bin/bash</span><span class="hljs-meta">#</span><span class="hljs-meta">#</span><span class="bash">Auth:shui</span>servername="dev001.com"download_file="/download/file.txt"time_num=$(date -d "2020-10-18 00:00:00" +%s)secret_num="mcr"res=$(echo -n "$&#123;time_num&#125;$&#123;download_file&#125; $&#123;secret_num&#125;" | openssl md5 -binary | openssl base64 | tr +/ -_ | tr -d = )echo "http://$&#123;servername&#125;$&#123;download_file&#125;?md5=$&#123;res&#125;&amp;expires=$&#123;time_num&#125;"</code></pre><p>test_safe_down.confï¼ˆnginxçš„é…ç½®ï¼‰</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">80</span>;    <span class="hljs-attribute">server_name</span> localhost;    <span class="hljs-attribute">root</span> /opt/app/code;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">secure_link</span> <span class="hljs-variable">$arg_md5</span>,<span class="hljs-variable">$arg_expires</span>;        <span class="hljs-attribute">secure_link_md5</span> <span class="hljs-string">"<span class="hljs-variable">$secure_link_expires</span><span class="hljs-variable">$uri</span> mcr"</span>;        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$secure_link</span> = <span class="hljs-string">""</span>) &#123;            <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;        &#125;        <span class="hljs-attribute">if</span> (<span class="hljs-variable">$secure_link</span> = <span class="hljs-string">"0"</span>) &#123;            <span class="hljs-attribute">return</span> <span class="hljs-number">410</span>;        &#125;    &#125;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt;./md5url.sh http://dev001.com/download/file.txt?md5=xjbPG9i92jvZWIYZLWVdLQ&amp;expires=1602950400</code></pre><blockquote><p>å°†<code>md5url.sh</code> ä¸­è·å–çš„åœ°å€æ‹¿åˆ°æµè§ˆå™¨ä¸­è¿è¡Œçœ‹ä¸‹ç»“æœæ˜¯å¯ä»¥æ­£å¸¸è®¿é—®çš„ï¼Œä½ è¯•ç€æ”¹å†™å®ƒä»¬çš„å€¼çœ‹èƒ½å¦æ­£å¸¸è®¿é—®ï¼Œå¦‚æœè®¿é—®å¤±è´¥å°±å®ç°åŠŸèƒ½äº†</p></blockquote><h2 id="geoip"><a href="#geoip" class="headerlink" title="geoip"></a>geoip</h2><h3 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><strong>ä½œç”¨</strong></p><p>æ¯”å¦‚è¿™ä¹ˆä¸ªåœºæ™¯ï¼šä¸€ä¸ªä¼ä¸šæœ‰2ä¸ªæœåŠ¡å™¨ï¼Œä¸€ä¸ªåœ¨å›½å†…ä¸€ä¸ªåœ¨å›½å¤–ï¼Œå®ƒ2ä¸ªç«™ç‚¹ä¸Šæ˜¯æ”¾ç€ä¸åŒçš„ä¿¡æ¯ï¼Œå®ƒæƒ³å›½å†…çš„ç”¨æˆ·è®¿é—®çš„æ˜¯å›½å†…æœåŠ¡å™¨çš„IPï¼Œå›½å¤–çš„ç”¨æˆ·å»è®¿é—®å›½å¤–æœåŠ¡å™¨çš„IPï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ä½¿ç”¨geoipæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å®ƒçš„ä½œç”¨ï¼š<strong>åŸºäºIPåœ°å€åŒ¹é…MaxMind GeoIPäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯»å–IPæ‰€åœ¨åœ°åŸŸä¿¡æ¯ã€‚</strong></p><p><code>MaxMind</code>åœ¨æœç´¢å¼•æ“ä¸Šå°±å¯ä»¥ä¸‹è½½ï¼Œgeoipè¿™ä¸ªæ¨¡å—å°±æ˜¯ç”¨æ¥è¯»å–<code>MaxMind</code>å¼€æ”¾çš„IPåº“ä¿¡æ¯ï¼Œç„¶åè·å–åˆ°åŸºäºIPå¯¹åº”çš„åœ°åŸŸä¿¡æ¯ã€‚</p><p><strong>å®‰è£…</strong></p><blockquote><p>æš‚æ— </p></blockquote><h1 id="HTTPSæœåŠ¡"><a href="#HTTPSæœåŠ¡" class="headerlink" title="HTTPSæœåŠ¡"></a>HTTPSæœåŠ¡</h1><h2 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ä¸ºä»€ä¹ˆéœ€è¦HTTPSï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆéœ€è¦HTTPSï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦HTTPSï¼Ÿ"></a>ä¸ºä»€ä¹ˆéœ€è¦HTTPSï¼Ÿ</h3><p>åŸå› ï¼šHTTPä¸å®‰å…¨</p><ul><li>ä¼ è¾“æ•°æ®è¢«ä¸­é—´äººç›—ç”¨ã€ä¿¡æ¯æ³„éœ²</li><li>æ•°æ®å†…å®¹åŠ«æŒã€ç¯¡æ”¹</li></ul><h3 id="HTTPSåè®®çš„å®ç°"><a href="#HTTPSåè®®çš„å®ç°" class="headerlink" title="HTTPSåè®®çš„å®ç°"></a>HTTPSåè®®çš„å®ç°</h3><p>1ï¼‰ã€å¯¹ä¼ è¾“å†…å®¹è¿›è¡ŒåŠ å¯†ä»¥åŠèº«ä»½éªŒè¯</p><p>2ï¼‰ã€å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†</p><p>å¯¹ç§°åŠ å¯†ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200214111011728.png" srcset="/img/loading.gif" alt="image-20200214111011728"></p><p>å‘é€æ–¹è¿›è¡Œæ•°æ®çš„åŠ å¯†ï¼Œæ¥å—æ”¾è¿›è¡Œæ•°æ®çš„è§£å¯†ï¼Œå‘é€æ–¹ç”¨çš„æ˜¯åŠ å¯†ç§˜é’¥ï¼Œæ¥æ”¶æ–¹ç”¨çš„æ˜¯è§£å¯†çš„ç§˜é’¥ï¼Œè¿™ä¸ªå°±æ˜¯å¯¹ç§°åŠ å¯†ï¼Œå¯¹ç§°åŠ å¯†çš„ç‰¹ç‚¹æ˜¯åŠ å¯†ç§˜é’¥å’Œè§£å¯†ç§˜é’¥å¯ä»¥æ˜¯ä¸€æ ·çš„ï¼Œæ•°æ®åœ¨å‘é€æ–¹ç”¨åŒä¸€ä¸ªç§˜é’¥æ‹¿å‡ºæ¥è¿›è¡ŒåŠ å¯†ä»¥åè¿›è¡Œå‘é€ï¼Œä¼ è¾“çš„ä¸­é—´å°±æ˜¯å¯†æ–‡çš„ï¼Œåœ¨é€šè¿‡æ¥å—æ–¹ç”¨åˆ°åŒä¸€ä¸ªå¯†ç ä¸²è¿›è¡Œè§£å¯†æˆä¸ºæ˜æ–‡è¿›è¡Œè¯»å–ã€‚å¯¹ç§°åŠ å¯†çš„ç‰¹ç‚¹æ˜¯åŠ å¯†ç§˜é’¥å’Œè§£å¯†ç§˜é’¥æ˜¯ä¸€æ ·çš„ã€‚</p><p>éå¯¹ç§°åŠ å¯†ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200214111621080.png" srcset="/img/loading.gif" alt="image-20200214111621080"></p><p>è¿™é‡ŒåŠ å¯†ç§˜é’¥å’Œè§£å¯†ç§˜é’¥æ˜¯2ä¸ªä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯åªæœ‰æˆ‘ä»¬å¸¸è¯´å…¬é’¥å’Œç§é’¥ï¼Œå…¬é’¥ç”¨äºåŠ å¯†ï¼Œç§é’¥ç”¨äºè§£å¯†ï¼Œä¸€ä¸²å…¬é’¥å¯¹åº”ä¸€ä¸²ç§é’¥åªæœ‰é€šè¿‡å…¬é’¥åŠ å¯†çš„ä¸œè¥¿æ‰èƒ½ä¸ä¹‹å¯¹åº”è§„å®šçš„ç§é’¥æ‰èƒ½è§£å¯†ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ï¼ˆæ¥æ”¶æ–¹ï¼‰ä¸€èˆ¬ä¿ç•™ç§é’¥ï¼Œå‘é€æ–¹ä¿ç•™å…¬é’¥ï¼Œæ‰€ä»¥å¯ä»¥çŸ¥é“éå¯¹ç§°åŠ å¯†æ˜¯2ä¸²ä¸åŒçš„ç§˜é’¥ï¼Œè¿™ä¸ªå°±æ˜¯å’Œå¯¹ç§°åŠ å¯†çš„åŒºåˆ«</p><hr><p>3ï¼‰ã€HTTPSåŠ å¯†åè®®åŸç†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200214112047266.png" srcset="/img/loading.gif" alt="image-20200214112047266"></p><p>HTTPSåŒæ—¶ç”¨åˆ°äº†åŠ å¯†å’Œå¯¹ç§°åŠ å¯†ã€éå¯¹ç§°åŠ å¯†ã€‚å½“ç”¨æˆ·ç«¯å‘èµ·SSLè¿æ¥çš„æ—¶å€™ï¼Œå®ƒè¿›è¡Œçš„æ˜¯éå¯¹ç§°åŠ å¯†ï¼Œéå¯¹ç§°åŠ å¯†å°†å…¬é’¥å‘é€ç»™å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯ç”¨å¯¹åº”çš„å…¬é’¥åŠ å¯†å®ƒæ¥ä¸‹æ¥è¦è¿›è¡Œå¯¹ç§°åŠ å¯†çš„å¯†ç ï¼Œç”¨éå¯¹ç§°åŠ å¯†çš„å…¬é’¥åŠ å¯†è¿™ä¸ªå¯†ç å¹¶å‘é€åˆ°æœåŠ¡ç«¯ï¼Œè¿™æ ·çš„è¯å®ƒä»¬å‰é¢è¿™ä¸ªéå¯¹ç§°åŠ å¯†çš„ä½œç”¨å°±æ˜¯ä¸ºäº†å¯¹ç§°åŠ å¯†åé¢ä¼ è¾“æ•°æ®è¿›è¡Œå‰æœŸçš„éªŒè¯ä»¥åŠåŠ å¯†çš„ä¼ è¾“ã€‚è¿™é‡Œå°±æœ‰ç–‘é—®äº†ï¼Œä¸ºä»€ä¹ˆHTTPSè¦é€‰æ‹©éå¯¹ç§°å’Œå¯¹ç§°åŒæ—¶ä½¿ç”¨ï¼Ÿ</p><p>â€”è¿™ä¸ªä¸»è¦æ˜¯å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†çš„ä¼˜ç¼ºç‚¹æœ‰å…³ç³»ï¼Œéå¯¹ç§°åŠ å¯†å¾€å¾€å¯¹äºè¿æ¥è¦æ±‚æ›´é«˜ï¼ŒæœåŠ¡ç«¯å‘é€ä¸€ä¸ªå…¬é’¥ç»™å®¢æˆ·ç«¯ï¼Œå¦‚æœå¤šæ¬¡è¿æ¥çš„æƒ…å†µä¸‹è¿™æ ·å¯¹æ€§èƒ½æ˜¯æœ‰æŸè€—çš„ï¼Œå¯¹ç§°åŠ å¯†å¯¹äºæ€§èƒ½æ¥è¯´æ›´å¤šç®€å•ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€æ¬¡è¿›è¡Œå®‰å…¨çš„éªŒè¯ä»¥åï¼Œå®Œå…¨å°±å¯ä»¥åˆ©ç”¨åˆ°å¯¹ç§°åŠ å¯†å°±å¯ä»¥äº†ã€‚</p><hr><p>4ï¼‰ã€ä¸­é—´äººä¼ªè£…å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200214114257164.png" srcset="/img/loading.gif" alt="image-20200214114257164"></p><p>HTTPSå¯¹äºä¸­é—´äººçš„åŠ«æŒå®ƒæ˜¯æ€ä¹ˆé˜²èŒƒçš„å‘¢ï¼Ÿ</p><p>æœ‰äº†å¯¹ç§°åŠ å¯†å’Œéå¯¹ç§°åŠ å¯†æŒ‰é“ç†ä¸­é—´äººæ˜¯ä¸ä¼šåŠ«æŒåˆ°çš„ï¼Œä½†æ˜¯ç°åœ¨ä¸­é—´äººçš„åŠ«æŒæ‰‹æ®µæ˜¯éå¸¸é«˜æ˜çš„ï¼Œå®ƒæ—¢å¯ä»¥ä¼ªè£…å®¢æˆ·ç«¯è¿›è¡ŒåŠ«æŒä¹Ÿèƒ½ä¼ªè£…æœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯çš„æ•°æ®è¿›è¡ŒåŠ«æŒï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå¯èƒ½åœ¨å‰è¾¹è¿›è¡Œæ¡æ‰‹çš„æ—¶å€™å®Œå…¨å¯¹å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘çš„æ•°æ®åŒ…è¿›è¡ŒåŠ«æŒä¼ªè£…ï¼Œå¹¶ä¸”åœ¨æœåŠ¡ç«¯å‘é€ç»™å®¢æˆ·ç«¯æ•°æ®çš„æ—¶å€™ä¹Ÿèƒ½ä¼ªè£…æœåŠ¡ç«¯è¿›è¡ŒåŠ«æŒï¼Œè¿™æ ·çš„è¯å°±èƒ½å®Œå…¨ä¼ªè£…ä¸­é—´äººå¯¹å¤šæ¬¡è¿æ¥è¿›è¡ŒåŠ«æŒï¼Œè¿™ä¸ªçš„è¯æ˜¯è§£å†³ä¸äº†è¿™ç§ä¸­é—´äººæŠ€æœ¯çš„åŠ«æŒçš„é—®é¢˜çš„ã€‚</p><p>æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™ä¸ªæ—¶å€™å°±ç”¨åˆ°äº†HTTPSçš„CAè¯ä¹¦</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200214114533277.png" srcset="/img/loading.gif" alt="image-20200214114533277"></p><p>æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯ä¹‹å‰æ˜¯å‘é€çš„å…¬è¯ï¼Œå¯¹äºå¯¹ç§°åŠ å¯†è€Œè¨€ï¼Œå¯¹äºHTTPSè¿™ä¸ªæ—¶å€™å‘ç»™å®¢æˆ·ç«¯çš„æ˜¯ä¸€ä¸ª<code>CAç­¾åè¯ä¹¦</code>ï¼Œæœ‰äº†è¿™ä¸ª<code>CAç­¾åè¯ä¹¦</code>ï¼Œä¸­é—´äººçš„åŠ«æŒä½œç”¨å°±æ²¡æœ‰äº†ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¼šå¦å¤–å¯¹è¿™ä¸ª<code>CAç­¾åè¯ä¹¦</code>è¿›è¡Œæ ¡éªŒï¼Œä¸­é—´äººæ˜¯æ— æ³•ç”Ÿæˆä¸€ä¸ªèƒ½å¤Ÿè¿›è¡ŒåŒ¹é…<code>CAç­¾åè¯ä¹¦</code>çš„æ ¡éªŒçš„ï¼Œå› ä¸ºå®¢æˆ·ç«¯ä¼š<code>CAç­¾åè¯ä¹¦</code>è¿›è¡Œæ ¡éªŒï¼Œå®ƒå°†å’Œç¬¬ä¸‰æ–¹ç­¾åæœºæ„è¿›è¡Œæ ¡éªŒï¼Œå¦‚æœæ ¡éªŒæˆåŠŸå°±ä¼šåˆ©ç”¨å¯¹åº”çš„å…¬é’¥åŠ å¯†ï¼Œå› ä¸º<code>CAç­¾åè¯ä¹¦</code>åŒ…å«äº†å¯¹åº”çš„å…¬é’¥ï¼Œå¦‚æœéªŒè¯å¤±è´¥å®¢æˆ·ç«¯å°†ç»ˆæ­¢è¿™ä¸€æ¬¡ä¼šè¯ï¼Œå¯¹äºä¸­é—´äººè¿™æ ·çš„æ–¹å¼å°±æ— æ³•å®ç°äº†ï¼Œå› ä¸ºè¿™ä¸ªç­¾åçš„è¯ä¹¦æ˜¯æ”¾åœ¨æœåŠ¡ç«¯ä¹‹å‰å°±å·²ç»å’Œç¬¬ä¸‰æ–¹æœºæ„è¿›è¡Œå¯¹åº”çš„ç­¾åå’Œå¯¹åº”çš„æˆæƒã€‚å®¢æˆ·ç«¯åœ¨çœŸæ­£çš„è¿›è¡Œè¿æ¥çš„æ—¶å€™è¿˜éœ€è¦è¿›è¡Œä¸€æ¬¡æ ¡éªŒï¼Œä¸­é—´äººçš„åŠ«æŒå°±æ— æ³•å®ç°ã€‚HTTPSå®ƒçš„å®‰å…¨æ€§å¯¹äºä¸­é—´äººåŠ«æŒè¿™ç§å¯èƒ½æ€§å°±èƒ½å®Œå…¨é¢„é˜²æ‰ï¼Œå…¶åŸç†å°±ç”¨åˆ°äº†<code>CAç­¾åè¯ä¹¦</code>ã€‚</p><h3 id="è¯ä¹¦ç­¾åç”ŸæˆCAè¯ä¹¦"><a href="#è¯ä¹¦ç­¾åç”ŸæˆCAè¯ä¹¦" class="headerlink" title="è¯ä¹¦ç­¾åç”ŸæˆCAè¯ä¹¦"></a>è¯ä¹¦ç­¾åç”ŸæˆCAè¯ä¹¦</h3><blockquote><p>è¿™é‡Œä»‹ç»çš„æ˜¯è‡ªç­¾è¯ä¹¦çš„ç±»å‹ï¼Œå¯¹äºè¯»è€…æƒ³å»é€šè¿‡è¯ä¹¦å»å¯»æ±‚è·Ÿç¬¬ä¸‰æ–¹å…¬å¸æˆ–è€…å…¬å¸è¿›è¡Œç­¾å‘çš„å¯¹åº”çš„è¯ä¹¦åœ¨åé¢çš„ç« èŠ‚ä¼šå»ä»‹ç»æµç¨‹çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ1ã€å› ä¸ºå®é™…çš„åœºæ™¯ä¸å¤ªç¬¦åˆï¼Œå› ä¸ºæˆ‘ä»¬å»æ‰¾å…¬å¸å»ç­¾å‘çš„è¯æ˜¯éœ€è¦å¯¹åº”çš„è¦å‡ºé’±ï¼Œæ¯ä¸ªå…¬å¸æäº¤çš„ä¿¡æ¯æ˜¯ä¸å¤ªä¸€æ ·çš„ï¼Œæ˜¯éœ€è¦ä¸€å®šæ—¶é—´çš„ï¼Œæ‰€ä»¥è¿™ä¸ªç« èŠ‚æ²¡æœ‰è®²åˆ°å…³äºå…¬å¸çš„ç­¾å‘ï¼›2ã€æˆ‘ä»¬éœ€è¦å…¬å¸çš„ç­¾å‘è¯ä¹¦çš„è¯ä¸æ˜¯ä¸€ä¸ªéå¸¸éš¾çš„äº‹æƒ…ï¼Œåªè¦æˆ‘ä»¬å­¦ä¼šäº†æ•´ä½“è¯ä¹¦çš„ç§˜é’¥çš„ç”Ÿæˆä»¥åŠè¯·æ±‚æ–‡ä»¶çš„ç”Ÿæˆä»¥è‡ªç­¾æ–‡ä»¶çš„è¿‡ç¨‹å’ŒHTTPSçš„åŸç†ï¼Œæˆ‘ä»¬æƒ³å»å¯»æ±‚ä»»æ„ä¸€å®¶å…¬å¸è¿›è¡Œå…¬å¸è¯ä¹¦çš„ç­¾åè¿™æ˜¯éå¸¸ç®€å•çš„äº‹æƒ…ã€‚</p></blockquote><p>1ï¼‰ã€ç”Ÿæˆç§˜é’¥å’ŒCAè¯ä¹¦</p><p>å‡†å¤‡å·¥ä½œï¼š</p><p>é¦–å…ˆç¡®è®¤ç³»ç»Ÿä¸­æ˜¯å¦æœ‰openssl</p><pre><code class="hljs bash">~&gt; openssl  versionOpenSSL 1.0.2k-fips  26 Jan 2017</code></pre><p>ç¡®è®¤Nginxæ˜¯å¦æœ‰http_ssl_module </p><pre><code class="hljs bash">~&gt; nginx -V--with-http_ssl_module</code></pre><p>æ­¥éª¤ï¼š</p><ul><li>ç”Ÿæˆkeyç§˜é’¥</li><li>ç”Ÿæˆè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ï¼ˆcsræ–‡ä»¶ï¼‰</li></ul><blockquote><p>æœ‰äº†csræ–‡ä»¶ä»¥åå°±å¯ä»¥å°†ç§˜é’¥å’Œcsræ–‡ä»¶ä¸€å¹¶æ‰“åŒ…å‘é€å¯¹åº”çš„ç­¾åæœºæ„ï¼Œå…³äºä½ çš„ç½‘ç«™åŸŸåä»¥åŠå¯¹åº”ç›¸å…³å…¬å¸çš„ä¿¡æ¯ï¼Œå»è¿›è¡ŒCAè¯ä¹¦çš„ç­¾åï¼Œè®©ç¬¬ä¸‰æ–¹çš„ç»“æ„æ¥ç»™ä½ è¿›è¡Œå¯¹åº”çš„ç­¾åï¼Œå®ƒå°†è¿”å›ç»™ä½ å¯¹åº”çš„CAè¯ä¹¦</p></blockquote><ul><li>å¯¹äºç›®å‰å­¦ä¹ é˜¶æ®µæ²¡æœ‰å¿…è¦å»å‘ç¬¬ä¸‰æ–¹ç»“æ„ç­¾åçš„æƒ…å†µï¼Œè¿™é‡Œå°±è‡ªå·±æ¥ç­¾åç”Ÿæˆè¿™ä¸ªç­¾åæ–‡ä»¶ï¼ˆCAæ–‡ä»¶ï¼‰</li></ul><h2 id="åœºæ™¯æ¼”ç¤º-1"><a href="#åœºæ™¯æ¼”ç¤º-1" class="headerlink" title="åœºæ™¯æ¼”ç¤º"></a>åœºæ™¯æ¼”ç¤º</h2><p>ç”ŸæˆHTTPSç­¾åè¯ä¹¦</p><pre><code class="hljs bash">/etc/nginx&gt; mkdir ssl_key<span class="hljs-comment">#mcr.key:keyæ–‡ä»¶å</span><span class="hljs-comment">#1024ï¼šä½æ•°è¶Šé«˜ç²¾åº¦å°±è¶Šé«˜</span>/etc/nginx/ssl_key&gt; openssl genrsa -idea -out mcr.key 1024Enter pass phrase <span class="hljs-keyword">for</span> mcr.key: 123456Verifying - Enter pass phrase <span class="hljs-keyword">for</span> mcr.key: 123456/etc/nginx/ssl_key&gt; lsmcr.key</code></pre><p>å­˜å‚¨HTTPSç­¾åè¯ä¹¦å¯†ç æ–‡ä»¶</p><pre><code class="hljs bash">/etc/nginx/ssl_key&gt; <span class="hljs-built_in">echo</span> 123456 &gt; mcr.pass</code></pre><p>ç”Ÿæˆcsrè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶</p><pre><code class="hljs bash">/etc/nginx/ssl_key&gt; openssl   req -new -key mcr.key  -out mcr.csrEnter pass phrase <span class="hljs-keyword">for</span> mcr.key: 123456<span class="hljs-comment">#è¿™é‡Œå¦‚æœæ˜¯ç»™ä¸‰æ–¹ç»“æ„åšç­¾åè¦æŒ‰ç…§è¦æ±‚æ¥å†™ï¼Œå› ä¸ºè¿™é‡Œæˆ‘ä»¬æ˜¯è‡ªç­¾åçš„ï¼Œæ‰€ä»¥æ¯”è¾ƒéšæ„</span>Country Name (2 letter code) [XX]: CNState or Province Name (full name) []:beijingLocality Name (eg, city) [Default City]:beijingOrganization Name (eg, company) [Default Company Ltd]:CNOrganizational Unit Name (eg, section) []:mcrCommon Name (eg, your name or your server<span class="hljs-string">'s hostname) []: dev001.com</span><span class="hljs-string">Email Address []:shui@163.com</span><span class="hljs-string"></span><span class="hljs-string">#csræ–‡ä»¶å¦‚æœè¦è¿›è¡Œæ›´æ”¹ï¼Œå¦å¤–çš„ä¸€ä¸ªå¯†ç ï¼Œå¦‚æœæ²¡ä¸¥æ ¼è¦æ±‚çš„è¯ï¼Œå¯ä»¥ä¸è¾“å…¥</span><span class="hljs-string">A challenge password []: </span><span class="hljs-string">An optional company name []:mcr</span><span class="hljs-string"></span><span class="hljs-string"></span><span class="hljs-string">/etc/nginx/ssl_key&gt;  ls</span><span class="hljs-string">mcr.csr  mcr.keymcr.pass</span></code></pre><p>å°†è¿™2ä¸ªæ–‡ä»¶2åŒ…å‘é€ç»™ç­¾åæœºæ„è¿›è¡Œå¯¹åº”çš„æƒå¨ç­¾åè¯·æ±‚ï¼Œå¯¹äºå…¬å¸è€Œè¨€å¤§éƒ¨åˆ†æ˜¯è¿™ä¹ˆåšçš„ï¼Œå¯¹äºä¸ªäººè€Œè¨€æ˜¯åŸºäºè¿™2ä¸ªæ–‡ä»¶æ¥å»ºç«‹è‡ªç­¾åè¯ä¹¦</p><pre><code class="hljs bash"><span class="hljs-comment">#-daysï¼šè¡¨ç¤ºç­¾åè¯ä¹¦è¿‡æœŸæ—¶é—´ï¼Œå¯¹äºè¿‡æœŸæ—¶é—´è€Œè¨€å¦‚æœé»˜è®¤æ²¡æœ‰å†™çš„è¯æ˜¯åœ¨ä¸€ä¸ªæœˆå·¦å³å°±ä¼šè¿‡æœŸï¼Œå½“ä½ çš„ç½‘ç«™ä¸Šçº¿ä»¥åå¾ˆå¤šå®¢æˆ·ç«¯ä¹Ÿæœ‰äº†å¯¹åº”çš„è¯ä¹¦çš„è¯·æ±‚ï¼Œé€šè¿‡ç›¸åº”çš„è¯ä¹¦æ–‡ä»¶ï¼Œä½ çš„CAè¯ä¹¦è¿‡æœŸäº†è¿™æ˜¯éå¸¸æœ‰é—®é¢˜çš„ï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ä½ çš„å°é—®é¢˜ä¸€ä¸ªå‚æ•°æ²¡åŠ å¯¼è‡´å› ä¸ºè¿‡æœŸäº†å°±éœ€è¦é‡æ–°å‘é€ç‰ˆæœ¬ï¼Œè¿™å¯¹äºä¼ä¸šæ¥è¯´æ˜¯éœ€è¦é¿å…çš„ï¼Œæ‰€ä»¥è¯»è€…åœ¨å®é™…çš„æƒ…å†µä¸‹é¢ä¸€å®šè¦åŠ å…¥å¥½è‡ªå·±çš„è¿‡æœŸæ—¶é—´</span>/etc/nginx/ssl_key&gt; openssl  x509 -req -days 3650 -<span class="hljs-keyword">in</span>  mcr.csr  -signkey mcr.key  -out mcr.crt  Enter pass phrase <span class="hljs-keyword">for</span> mcr.key: 123456/etc/nginx/ssl_key&gt;  lsmcr.crt  mcr.csr  mcr.keymcr.pass</code></pre><p>å°±ä¸‹æ¥å°±æ˜¯éœ€è¦Nginxè¿›è¡Œé…ç½®äº†ï¼Œè¿™é‡Œåˆ—å‡ºå®ƒç›¸å…³æ ¸å¿ƒçš„é…ç½®è¯­æ³•ï¼š</p><ul><li>å¼€å¯SSL</li></ul><p>| Syntax:  | <code>**ssl** on | off;</code> |<br>| :â€”â€”- | â€”â€”â€”â€”â€”â€”- |<br>| Default: | <code>ssl off;</code>          |<br>| Context: | <code>http</code>, <code>server</code>    |</p><ul><li>SSLè¯ä¹¦æ–‡ä»¶</li></ul><table><thead><tr><th align="left">Syntax:</th><th><code>**ssl_certificate** *file*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code></td></tr></tbody></table><ul><li>SSLè¯ä¹¦å¯†ç æ–‡ä»¶</li></ul><table><thead><tr><th align="left">Syntax:</th><th><code>**ssl_certificate_key** *file*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code></td></tr></tbody></table><ul><li>httpç­¾åè¯ä¹¦ çš„å¯†ç æ–‡ä»¶</li></ul><table><thead><tr><th align="left">Syntax:</th><th><code>**ssl_password_file** *file*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code></td></tr></tbody></table><p>test_https.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;    <span class="hljs-attribute">server_name</span> <span class="hljs-number">192.168.202.151</span> dev001.com    ssl <span class="hljs-literal">on</span>;    <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/ssl_key/mcr.crt;    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl_key/mcr.key;    <span class="hljs-attribute">ssl_password_file</span> /etc/nginx/ssl_key/mcr.pass;    <span class="hljs-attribute">index</span> index.html;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">root</span> /opt/app/code;    &#125;&#125;</code></pre><h2 id="é…ç½®è‹¹æœè¦æ±‚çš„opensslåå°HTTPSæœåŠ¡"><a href="#é…ç½®è‹¹æœè¦æ±‚çš„opensslåå°HTTPSæœåŠ¡" class="headerlink" title="é…ç½®è‹¹æœè¦æ±‚çš„opensslåå°HTTPSæœåŠ¡"></a>é…ç½®è‹¹æœè¦æ±‚çš„opensslåå°HTTPSæœåŠ¡</h2><p>é…ç½®è‹¹æœè¦æ±‚çš„è¯ä¹¦</p><ul><li>æœåŠ¡å™¨æ‰€æœ‰çš„è¿æ¥ä½¿ç”¨TLS1.2ä»¥ä¸Šç‰ˆæœ¬ï¼ˆopenssl 1.0.2ï¼‰</li><li>HTTPSè¯ä¹¦å¿…é¡»ä½¿ç”¨SHA256ä»¥ä¸Šçš„å“ˆå¸Œç®—æ³•ç­¾å</li><li>HTTPSè¯ä¹¦å¿…é¡»ä½¿ç”¨RSA 2048ä½æˆ–è€…ECC 256ä½ä»¥ä¸Šå…¬é’¥ç®—æ³•</li><li>ä½¿ç”¨å‰å‘åŠ å¯†æŠ€æœ¯</li></ul><p>æŸ¥çœ‹opensslç‰ˆæœ¬æ˜¯å¦æ»¡è¶³è¦æ±‚ï¼Œè¿™é‡Œå¦‚æœä¸æ»¡è¶³è‡ªè¡Œæœç´¢å¼•æ“å‡çº§ä¸‹</p><pre><code class="hljs bash">~&gt; oenssl versionOpenSSL 1.0.2k-fips  26 Jan 2017</code></pre><p>æŸ¥çœ‹å½“å‰è‡ªç­¾è¯ä¹¦åŠ å¯†ç®—æ³•ç±»å‹</p><pre><code class="hljs bash">~&gt; openssl x509 -noout -text -<span class="hljs-keyword">in</span> ./mcr.crtSignature Algorithm: sha256WithRSAEncryption Subject Public Key Info:            Public Key Algorithm: rsaEncryption                Public-Key: (1024 bit)</code></pre><blockquote><p>è¿™é‡Œä½¿ç”¨çš„æ˜¯<code>sha2</code>ç®—æ³•ç±»å‹æ‰€ä»¥æ²¡æœ‰æ»¡è¶³è‹¹æœçš„è¦æ±‚ï¼Œå¦å¤–ä½æ•°ä¹Ÿæ²¡æœ‰æ»¡è¶³è¿™é‡Œæ˜¯1024</p></blockquote><p>æ‰€ä»¥è¿™é‡Œéœ€è¦é‡æ–°ç”Ÿæˆä¸€ä¸ªè‡ªç­¾è¯ä¹¦ï¼Œè¿™é‡Œæœ‰å¦ä¸€ç§æ–¹å¼ç”Ÿæˆï¼Œä¸éœ€è¦ä¸€æ­¥ä¸€æ­¥çš„å»ç”Ÿæˆäº†ï¼Œè€Œä¸”è¿™ç§æ–¹å¼Nginxæ˜¯ä¸éœ€è¦é…ç½®<code>ssl_password_file</code>çš„</p><pre><code class="hljs bash">/etc/nginx/ssl_key&gt; openssl req -days 36500 -x509 -sha256  -nodes -newkey rsa:2048 -keyout mcr.key -out mcr_apple.crt</code></pre><p>test_https.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;    <span class="hljs-attribute">server_name</span> <span class="hljs-number">192.168.202.151</span> dev001.com    ssl <span class="hljs-literal">on</span>;    <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/ssl_key/mcr_apple.crt;    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl_key/mcr.key;    <span class="hljs-attribute">index</span> index.html;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">root</span> /opt/app/code;    &#125;&#125;</code></pre><p>ç°åœ¨å³ä½¿ä¸é…ç½®<code>ssl_password_file</code>åœ¨<code>nginx reload</code>çš„æ—¶å€™ä¹Ÿä¸éœ€è¦è¾“å…¥å¯†ç ï¼Œè¿™ä¸ªå¯†ç æ˜¯å¹²å˜›å‘¢ï¼Ÿè¿™é‡Œæ¥è¯´æ˜ä¸‹ï¼š</p><pre><code class="hljs bash">openssl req -days 36500 -x509 -sha256  -nodes -newkey rsa:2048 -keyout mcr.key -out mcr_apple.crt</code></pre><p>è¿™ä¸ªé…ç½®ä¸­åŠ äº†ä¸€ä¸ª<code>-keyout</code>é€‰é¡¹ï¼Œå®ƒä¼šåŒæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„<code>mcr.key</code></p><pre><code class="hljs bash">/etc/nginx/ssl_key&gt; ll-rw-r--r--. 1 root root 1387 2æœˆ  14 19:47 mcr_apple.crt-rw-r--r--. 1 root root 1704 2æœˆ  14 19:47 mcr.key...</code></pre><p>ä»ä¸Šé¢çš„shellç»ˆç«¯ä¸­å¯ä»¥çœ‹åˆ°å®ƒä»¬ç”Ÿæˆçš„æ—¶é—´æ˜¯ä¸€æ ·çš„ï¼Œé‡æ–°ç”Ÿæˆæ–°çš„æ–‡ä»¶ï¼Œå¯¹åº”äºä¸Šä¸€ç« èŠ‚ä¸€ä¸ªä¸ªç”Ÿæˆï¼Œå•ç‹¬ç”Ÿæˆkeyæ–‡ä»¶çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¦‚æœæƒ³ç›´æ¥ç”Ÿæˆä¸€ä¸ªæ²¡æœ‰ä¿æŠ¤ç çš„æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><pre><code class="hljs bash">/etc/nginx/ssl_key&gt; openssl  rsa -<span class="hljs-keyword">in</span> ./mcr.key -out ./mcr_new.key</code></pre><blockquote><p>è¿™é‡Œé€šè¿‡æ‹·è´çš„æ–¹å¼å»æ‰å¯†ç </p></blockquote><h2 id="HTTPSæœåŠ¡ä¼˜åŒ–"><a href="#HTTPSæœåŠ¡ä¼˜åŒ–" class="headerlink" title="HTTPSæœåŠ¡ä¼˜åŒ–"></a>HTTPSæœåŠ¡ä¼˜åŒ–</h2><p>å¯¹æ¯”HTTPï¼ŒHTTPSçš„åŠ£åŠ¿ï¼Œå‰é¢ç« èŠ‚æåˆ°HTTPSçš„å»ºç«‹åŸç†ï¼ŒHTTPSçš„å»ºç«‹æ˜¯éœ€è¦åœ¨HTTPä¹‹å‰å»ºç«‹SSLæ¡æ‰‹ï¼ŒSSLè®¤è¯å°±ä¼šå¤šä¸€æ¬¡è¿æ¥ï¼Œå¯¹äºæœåŠ¡ç«¯å°±ä¼šéœ€è¦å¯¹åº”çš„è®¤è¯ï¼Œè¿™ä¸ªæ˜¯æ¶ˆè€—æœåŠ¡ç«¯CPUèµ„æºå’ŒIOèµ„æºçš„ï¼Œæ‰€ä»¥æœåŠ¡ç«¯è€Œè¨€æˆ‘è½»é‡çº§æœåŠ¡è®ºæ€§èƒ½ä¸Šæ›´æ„¿æ„å»å¤„ç†HTTPè¯·æ±‚ï¼Œä¸ºä»€ä¹ˆå¤§å®¶è¿˜è¦å»æ¨èHTTPSå‘¢ï¼Ÿå› ä¸ºæˆ‘ä»¬åç«¯çš„æœåŠ¡æ–°å‹çš„æ¶æ„ä¸æ–­çš„äº§ç”Ÿï¼Œå¯¹äºNginxæˆ‘ä»¬å¯ä»¥è¿›è¡Œæ°´å¹³çš„æ‰©å®¹ä»¥åŠè´Ÿè½½å‡è¡¡çš„å‡ºç°ï¼ŒæœåŠ¡å™¨çš„ç¡¬ä»¶çš„æå‡ï¼Œå¯¼è‡´æˆ‘ä»¬å¯¹äºæ€§èƒ½çš„æŸè€—å¾€å¾€ä¸ä¼šç‰¹åˆ«å…³æ³¨ï¼Œè€Œæ˜¯æ›´å¤šçš„å»æƒè¡¡å®‰å…¨ï¼Œå®‰å…¨æ˜¯æ›´ä¸ºé‡è¦çš„ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒè¡¡å…³ç³»ä¸‹é¢ï¼ŒHTTPSå¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿéœ€è¦å»è€ƒè™‘æ€§èƒ½çš„ä¼˜åŒ–ï¼Œè®©å•ä¸ªæœåŠ¡å™¨æ‰¿è½½æ›´å¤šçš„å¹¶å‘ï¼Œå¤„ç†æ›´å¤šçš„è¯·æ±‚ã€‚</p><p>ä¼˜åŒ–æ–¹å¼ï¼š</p><ul><li>æ¿€æ´»keepaliveé•¿è¿æ¥ï¼šä¸€æ¬¡è¿æ¥èƒ½å¤Ÿå¤„ç†æ›´å¤šçš„è¯·æ±‚è¿™æ ·çš„è¯å»ºç«‹æ¡æ‰‹çš„æ¬¡æ•°å°±ä¼šå°‘ï¼Œè¿™å¯¹äºæœåŠ¡ç«¯çš„æ€§èƒ½å°±èƒ½æœ‰æ•ˆçš„ä¼˜åŒ–</li><li>è®¾ç½®ssl sessionç¼“å­˜ï¼šæŠŠéƒ¨åˆ†çš„ä¿¡æ¯å†…å®¹æ”¾åˆ°ç¼“å­˜é‡Œé¢å»ï¼Œè¿™æ ·çš„è¯è®©æœåŠ¡å™¨å¤„ç†èµ·æ¥CPUçš„èµ„æºæ›´å°‘å’Œå¤„ç†æ›´åŠ å¿«é€Ÿ</li></ul><p>test_https.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span> <span class="hljs-number">443</span> ssl;    <span class="hljs-attribute">server_name</span> <span class="hljs-number">192.168.202.151</span> dev001.com    ssl <span class="hljs-literal">on</span>;  <span class="hljs-comment">#å…±äº«ç¼“å­˜é…ç½®10å…†ï¼Œå¤§çº¦èƒ½å¤Ÿå­˜å‚¨8k-10kçš„sessionä¼šè¯</span>    <span class="hljs-attribute">ssl_session_cache</span> shared:SSL:<span class="hljs-number">10m</span>;  <span class="hljs-comment">#sessionä¼šè¯è¿‡æœŸæ—¶é—´ï¼š10åˆ†é’Ÿ</span>    <span class="hljs-attribute">ssl_session_timeout</span> <span class="hljs-number">10m</span>;        <span class="hljs-attribute">ssl_certificate</span> /etc/nginx/ssl_key/mcr_apple.crt;    <span class="hljs-attribute">ssl_certificate_key</span> /etc/nginx/ssl_key/mcr.key;    <span class="hljs-attribute">index</span> index.html;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">root</span> /opt/app/code;    &#125;&#125;</code></pre><h1 id="ä¸Luaçš„å¼€å‘"><a href="#ä¸Luaçš„å¼€å‘" class="headerlink" title="ä¸Luaçš„å¼€å‘"></a>ä¸Luaçš„å¼€å‘</h1><h2 id="ä»‹ç»-5"><a href="#ä»‹ç»-5" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="Lua"><a href="#Lua" class="headerlink" title="Lua"></a>Lua</h3><p>æ˜¯ä¸€ä¸ªç®€æ´ã€è½»é‡ã€å¯æ‰©å±•çš„è„šæœ¬è¯­è¨€ã€‚å®ƒçš„è§£é‡Šå™¨æ¯”shellè¿˜å°ï¼Œå®ƒä¾èµ–ä¸Cè¯­è¨€çš„æ‰©å±•æ€§ï¼Œæ‰€ä»¥åªè¦ç”¨Cè¯­è¨€å°è£…çš„å¯¹åº”æ¨¡å—éƒ½å¯ä»¥å®ç°å®ƒçš„å°è£…æ‰©å±•</p><h3 id="Nginx-Luaä¼˜åŠ¿"><a href="#Nginx-Luaä¼˜åŠ¿" class="headerlink" title="Nginx+Luaä¼˜åŠ¿"></a>Nginx+Luaä¼˜åŠ¿</h3><p>åœ¨å¤§éƒ¨åˆ†åŠŸèƒ½éœ€æ±‚ä¸Šé¢ï¼Œæˆ‘ä»¬ç”¨Nginxã€Javaã€PHPéƒ½èƒ½å®ç°å¯¹åº”çš„åŠŸèƒ½åœºæ™¯ï¼Œä½†æ˜¯ç»“åˆNginx+Luaæˆ‘è§‰å¾—æœ€ä¸»è¦çš„è¦æ±‚å°±æ˜¯æé«˜é«˜å¹¶å‘çš„åœºæ™¯ã€‚Nginxæ˜¯åˆ©ç”¨å†…æ ¸epoæ¨¡å‹ï¼Œå®ƒæ˜¯éé˜»å¡IOæ–¹å¼ï¼Œåˆ©ç”¨è¿™ç§æ–¹å¼èƒ½å¤Ÿå¿«é€Ÿå¢å¤§è¯·æ±‚å¹¶å‘ï¼ŒLuaæ˜¯ä¸€ä¸ªè½»é‡çº§è„šæœ¬è¯­è¨€å®ç°ï¼ŒåŠŸèƒ½å•ä¸€ï¼Œè€Œä¸”é«˜å¹¶å‘è¿™ç§æ¥å£æˆ‘ä»¬é€‰æ‹©Nginx+Luaå¼€å‘ååˆ†å¸¸è§ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å‰ç«¯éœ€è¦ç»Ÿè®¡ç”¨æˆ·IPåœ°å€ä¿¡æ¯ï¼Œéœ€è¦ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è®¿é—®æ¬¡æ•°ï¼Œéœ€è¦åšå¯¹åº”å®‰å…¨çš„åŠŸèƒ½ï¼Œéƒ½å¯ä»¥ç”¨Nginx+Luaæ¥å®ç°ã€‚ </p><h3 id="Luaçš„åŸºæœ¬è¯­æ³•"><a href="#Luaçš„åŸºæœ¬è¯­æ³•" class="headerlink" title="Luaçš„åŸºæœ¬è¯­æ³•"></a>Luaçš„åŸºæœ¬è¯­æ³•</h3><p>é¦–å…ˆéœ€è¦ç¡®ä¿ç³»ç»Ÿä¸Šé¢æœ‰luaçš„è§£é‡Šå™¨</p><pre><code class="hljs bash">~&gt; yum install lua</code></pre><p>å®ƒçš„æ³¨é‡Šåˆ†ä¸º2ç§</p><ul><li>è¡Œæ³¨é‡Šï¼šâ€“</li><li>å—æ³¨é‡Šï¼šâ€“[[  ä»£ç å—  ]]</li></ul><p>å¯¹äºå˜é‡çš„è¯å®ƒæ”¯æŒï¼š</p><ul><li>a=â€™alo\n123â€â€™</li><li>a=â€alo\n123&quot;â€œ</li><li>a=â€˜\97lo\10\04923â€â€™</li><li>a= [[alo123â€]]</li></ul><p>å¯¹äºå¸ƒå°”ç±»å‹åªæœ‰nilå’Œfalseæ˜¯falseï¼Œæ•°å­—0å•Šï¼Œâ€˜â€™ç©ºå­—ç¬¦ä¸²(â€˜\0â€™)éƒ½æ˜¯true</p><p>luaä¸­çš„å˜é‡å¦‚æœæ²¡æœ‰ç‰¹æ®Šè¯´æ˜ï¼Œå…¨æ˜¯å…¨å±€å˜é‡</p><p>è¯­å¥ä»‹ç»</p><p>while</p><pre><code class="hljs lua">sum = <span class="hljs-number">0</span>num = <span class="hljs-number">1</span><span class="hljs-keyword">while</span> num &lt;= <span class="hljs-number">100</span> <span class="hljs-keyword">do</span>    sum = sum + num    num = num + <span class="hljs-number">1</span><span class="hljs-keyword">end</span><span class="hljs-built_in">print</span>(<span class="hljs-string">"sum="</span>, sum)</code></pre><p>for</p><pre><code class="hljs lua">sum = <span class="hljs-number">0</span><span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, <span class="hljs-number">100</span> <span class="hljs-keyword">do</span>    sum = sum + i<span class="hljs-keyword">end</span><span class="hljs-built_in">print</span>(sum)</code></pre><p>if-else</p><pre><code class="hljs lua"><span class="hljs-keyword">if</span> age == <span class="hljs-number">40</span> <span class="hljs-keyword">and</span> sex == <span class="hljs-string">"Male"</span> <span class="hljs-keyword">then</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"å¤§äº40ç”·äºº"</span>)<span class="hljs-keyword">elseif</span> age &gt; <span class="hljs-number">60</span> <span class="hljs-keyword">and</span> sex ~= <span class="hljs-string">"Female"</span> <span class="hljs-keyword">then</span>    <span class="hljs-built_in">print</span>(<span class="hljs-string">"éå¥³å„¿è€Œå…¶å¤§äº60"</span>)<span class="hljs-keyword">else</span>    <span class="hljs-keyword">local</span> age = <span class="hljs-built_in">io</span>.<span class="hljs-built_in">read</span>()    <span class="hljs-built_in">print</span>(<span class="hljs-string">"ä½ çš„å¹´é¾„:"</span> .. age)<span class="hljs-keyword">end</span></code></pre><h2 id="Nginxä¸Luaçš„å¼€å‘ç¯å¢ƒ"><a href="#Nginxä¸Luaçš„å¼€å‘ç¯å¢ƒ" class="headerlink" title="Nginxä¸Luaçš„å¼€å‘ç¯å¢ƒ"></a>Nginxä¸Luaçš„å¼€å‘ç¯å¢ƒ</h2><p>å¯¹äºNginxè€Œè¨€ï¼ŒNginxé»˜è®¤æ˜¯ä¸çŸ¥é“Luaæ‰©å±•æ¨¡å—çš„</p><ul><li>LuaJITï¼šè·ŸLuaä¸€æ ·æ˜¯ä¸€ä¸ªè§£é‡Šå™¨ï¼Œåªæ˜¯å®ƒæ¯”Luaè·Ÿé«˜æ•ˆäº›</li><li>ngx_devel_kitå’Œlua-nginx-module</li><li>é‡æ–° ç¼–è¯‘Nginx</li></ul><p>æ‰©å±•æ¨¡å—æ­¥éª¤ï¼š</p><blockquote><p>è¿™é‡Œåšä¸»æ²¡æœ‰æ­å»ºæˆåŠŸï¼Œè¿™é‡Œåšä¸»ä¸å†ä½¿ç”¨å®˜ç½‘æä¾›çš„Nginxï¼Œè€Œæ˜¯å‚è€ƒ<a href="https://openresty.org/cn/" target="_blank" rel="noopener">å®˜ç½‘</a>æ­å»ºçš„ï¼Œå®ƒè¿™é‡Œçš„Nginxé»˜è®¤æ”¯æŒLua</p></blockquote><h2 id="Nginxè°ƒç”¨Luaçš„æŒ‡ä»¤åŠNginxçš„Luaaipæ¥å£"><a href="#Nginxè°ƒç”¨Luaçš„æŒ‡ä»¤åŠNginxçš„Luaaipæ¥å£" class="headerlink" title="Nginxè°ƒç”¨Luaçš„æŒ‡ä»¤åŠNginxçš„Luaaipæ¥å£"></a>Nginxè°ƒç”¨Luaçš„æŒ‡ä»¤åŠNginxçš„Luaaipæ¥å£</h2><p>å¯¹äºä¸€ä¸ªè¯·æ±‚è¿‡æ¥ï¼Œé¦–å…ˆæ˜¯é€šè¿‡NginxæœåŠ¡ï¼ŒNginxæœåŠ¡å†æ¥è°ƒç”¨å¯¹åº”çš„LuaæŒ‡ä»¤ï¼Œè¿™ä¸ªç« èŠ‚æ¥è¯´ä¸‹æœ‰å“ªäº›å¸¸è§å¾—è°ƒç”¨LuaæŒ‡ä»¤ã€‚</p><p>Nginxçš„å¯æ’æ‹”æ¨¡å—ååŠ è½½æ‰§è¡Œï¼Œå…±11ä¸ªå¤„ç†é˜¶æ®µï¼Œåœ¨æ¯ä¸ªé˜¶æ®µéƒ½å¯ä»¥è°ƒç”¨Luaçš„æŒ‡ä»¤ï¼Œå¯¹äºèƒ½è°ƒç”¨çš„æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æŒ‡ä»¤</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>set_by_lua<br />set_by_lua_file</td><td>è®¾ç½®Nginxå˜é‡ï¼Œå¯ä»¥å®ç°å¤æ‚çš„èµ‹å€¼é€»è¾‘</td></tr><tr><td>access_by_lua<br />access_by_lua_file</td><td>è¯·æ±‚è®¿é—®é˜¶æ®µå¤„ç†ï¼Œç”¨äºè®¿é—®æ§åˆ¶</td></tr><tr><td>content_by_lua<br />content_by_lua_file</td><td>å†…å®¹å¤„ç†å™¨ï¼Œæ¥å—è¯·æ±‚å¤„ç†å¹¶è¾“å‡ºå“åº”</td></tr></tbody></table><p>Luaåœ¨äº¤äº’è¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦å»è°ƒç”¨LuaæŒ‡ä»¤ï¼Œé€šè¿‡Nginxçš„Lua APIï¼š</p><table><thead><tr><th>api</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>ngx.var</td><td>nginxå˜é‡</td></tr><tr><td>ngx.req.get_hearders</td><td>è·å–è¯·æ±‚å¤´</td></tr><tr><td>ngx.req.get_uri_args</td><td>è·å–urlè¯·æ±‚å‚æ•°</td></tr><tr><td>ngx.redirect</td><td>é‡å®šå‘</td></tr><tr><td>ngx.print</td><td>è¾“å‡ºå“åº”å†…å®¹ä½“</td></tr><tr><td>ngx.say</td><td>é€šngx.printï¼Œä½†æ˜¯ä¼šæœ€åè¾“å‡ºä¸€ä¸ªæ¢è¡Œç¬¦</td></tr><tr><td>ngx.header</td><td>è¾“å‡ºå“åº”å¤´</td></tr><tr><td>â€¦</td><td></td></tr></tbody></table><h2 id="å®æˆ˜åœºæ™¯-ç°åº¦å‘å¸ƒ"><a href="#å®æˆ˜åœºæ™¯-ç°åº¦å‘å¸ƒ" class="headerlink" title="å®æˆ˜åœºæ™¯-ç°åº¦å‘å¸ƒ"></a>å®æˆ˜åœºæ™¯-ç°åº¦å‘å¸ƒ</h2><h3 id="ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ç°åº¦å‘å¸ƒï¼Ÿ</h3><p>æŒ‰ç…§ä¸€å®šçš„å…³ç³»åŒºåˆ«,åˆ†éƒ¨åˆ†çš„ä»£ç è¿›è¡Œä¸Šçº¿ï¼Œä½¿ä»£ç çš„å‘å¸ƒèƒ½å¹³æ»‘è¿‡æ¸¡ä¸Šçº¿ï¼Œæ‰€ä»¥ç°åº¦å‘å¸ƒå°±æ˜¯è®©éƒ¨åˆ†ã€å°‘é‡çš„ç”¨æˆ·èƒ½å¤Ÿå…ˆä½“éªŒåˆ°ï¼Œè¿™æ ·ä¸è‡³äºå½±å“æ•´ä½“ï¼Œæ‰€ä»¥æŒ‰ç…§ä»€ä¹ˆå…³ç³»æ¥è¿›è¡Œç°åº¦å‘å¸ƒæ˜¯å¾ˆé‡è¦çš„ã€‚</p><h3 id="ç°åº¦å‘å¸ƒæ–¹å¼"><a href="#ç°åº¦å‘å¸ƒæ–¹å¼" class="headerlink" title="ç°åº¦å‘å¸ƒæ–¹å¼"></a>ç°åº¦å‘å¸ƒæ–¹å¼</h3><p>1ï¼‰ã€ç”¨æˆ·çš„ä¿¡æ¯cookieç­‰ä¿¡æ¯åŒºåˆ«</p><p>æŒ‡å®šæŸä¸€ä¸ªç”¨æˆ·å¯ä»¥è®¿é—®ï¼Œå…¶ä»–çš„ç”¨æˆ·å°±è®¿é—®ä¸åŒçš„åœºæ™¯ï¼Œè¿™ä¸ªæ˜¯åŸºäºç”¨æˆ·ä¸åŒä¿¡æ¯è¿›è¡Œå¯¹åº”çš„åŒºåˆ†</p><p>2ï¼‰ã€æ ¹æ®ç”¨æˆ·çš„ipåœ°å€</p><p>è·å–åˆ°å¯¹åº”çš„ipåšåŒºåˆ†ï¼Œä½†æ˜¯ipåœ°å€é¢—ç²’åº¦ä¼šè·Ÿå¹¿ä¸€äº›ï¼Œå› ä¸ºæœ‰å¾ˆå¤šå±€åŸŸç½‘æ˜¯å…±ç”¨ä¸€ä¸ªip</p><p>â€¦</p><h3 id="å®ç°æ­¥éª¤"><a href="#å®ç°æ­¥éª¤" class="headerlink" title="å®ç°æ­¥éª¤"></a>å®ç°æ­¥éª¤</h3><p>è¿™é‡Œé€‰æ‹©ä½¿ç”¨ipçš„æ–¹å¼æ¥å®ç°ï¼Œè¿™é‡Œæˆ‘ä¼šå‡†å¤‡2ä¸ª<code>spring boot</code>æ‰“åŒ…çš„<code>jar</code>ï¼š</p><p>æœåŠ¡1ï¼š8080</p><p>æœåŠ¡2ï¼š9090</p><p>å®ƒä»¬ä¸¤åˆ†åˆ«æ”¾ä¸€éƒ¨åˆ†ä»£ç ï¼Œå¯¹äºæœåŠ¡1è€Œè¨€ï¼Œæ”¾çš„æ˜¯ç›¸å…³æµ‹è¯•çš„ä»£ç ï¼Œå°±æ˜¯æˆ‘ä»¬è¦å‡†å¤‡æ–°æ›´æ”¹çš„ä¸€éƒ¨åˆ†ä»£ç ï¼ŒæœåŠ¡å™¨2è€Œè¨€æ”¾çš„æ˜¯è€çš„ä»£ç ï¼Œæˆ‘ä»¬æ–°æ›´æ”¹ä»£ç åœ¨æœåŠ¡1åšçš„æ›´æ”¹ä»¥åæˆ‘ä»¬åªå…è®¸éƒ¨åˆ†çš„IPæ¥è¿›è¡Œå¯¹åº”çš„è®¿é—®ï¼Œå¦‚æœå®ƒæ˜¯åŒ¹é…çš„è¯ï¼Œå®ƒæ˜¯æŒ‰ç…§IPåœ°å€è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…è®©å®ƒè®¿é—®æœåŠ¡1çš„<code>spring boot jar</code>ã€‚</p><p>å¯¹äºä»¥ä¸Šè¿™ä¸ªé€»è¾‘æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå°±æ˜¯é€šè¿‡Nginx+Luaæ¥å®ç°çš„ï¼Œæ‰€ä»¥Nginxå’ŒLuaéœ€è¦å­˜å‚¨ç”¨æˆ·IPçš„å…³ç³»ï¼Œå®ƒéœ€è¦å»è°ƒç”¨ä¸€ä¸ªåˆ—è¡¨ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªIPå’Œç”¨æˆ·è¿‡æ¥çš„IPæ˜¯å¦åŒ¹é…ï¼Œå¦‚æœåŒ¹é…çš„è¯æ‰è®©å®ƒå»è®¿é—®å¯¹åº”æ–°åŠŸèƒ½çš„ä»£ç ï¼Œæ‰€ä»¥è¿™é‡Œè¦å­˜å‚¨å¯¹åº”çš„IPåˆ—è¡¨çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨<code>Memcache</code>ï¼Œè¿™é‡Œé€šè¿‡Luaå»è°ƒç”¨<code>Memcache</code>å»å–IPåˆ—è¡¨ï¼Œçœ‹ç”¨æˆ·çš„IPæ˜¯å¦æ˜¯<code>Memcache</code>æ‰€å­˜çš„åˆ—è¡¨é‡Œé¢ï¼Œå¦‚æœå·²å­˜åœ¨å°±è®©è¿™ä¸ªç”¨æˆ·å°±è®¿é—®æœåŠ¡å™¨1ï¼Œå¦‚æœä¸åŒ¹é…å°±è®©è¿™ä¸ªç”¨æˆ·å»è®¿é—®æœåŠ¡2ã€‚</p><h3 id="å®ç°å…·ä½“æ­¥éª¤"><a href="#å®ç°å…·ä½“æ­¥éª¤" class="headerlink" title="å®ç°å…·ä½“æ­¥éª¤"></a>å®ç°å…·ä½“æ­¥éª¤</h3><p>åœ¨å¼€å§‹ä¹‹å‰æ¥ä»‹ç»ä¸€ä¸‹æœåŠ¡1å’ŒæœåŠ¡2çš„åŒºåˆ«ï¼Œ</p><p>æœåŠ¡å™¨1ï¼š</p><pre><code class="hljs bash">~&gt; curl localhost:8080/demo1~&gt; curl localhost:8080/demo/v22~&gt; curl localhost:80808080</code></pre><p>æœåŠ¡2ï¼š</p><pre><code class="hljs bash">~&gt; curl localhost:9090/demo9~&gt; curl localhost:9090/demo/v2&#123;<span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"2020-02-16T12:42:53.563+0000"</span>,<span class="hljs-string">"status"</span>:404,<span class="hljs-string">"error"</span>:<span class="hljs-string">"Not Found"</span>,<span class="hljs-string">"message"</span>:<span class="hljs-string">"No message available"</span>,<span class="hljs-string">"path"</span>:<span class="hljs-string">"/demo/v2"</span>&#125;~&gt; curl localhost:90909090</code></pre><blockquote><p>æœåŠ¡å™¨æœ‰ä¸­èƒ½å¤Ÿæ­£å¸¸è®¿é—®<code>/demo/v2</code>ï¼Œå®ƒè¿™é‡Œçš„ä»£ç å±äºæœ€æ–°çš„ï¼Œè®¿é—®<code>/demo</code>å“åº”çš„æ˜¯1ï¼Œåœ¨è€çš„ä»£ç ä¸­ï¼Œä¹Ÿå°±æ˜¯9090è¿™ä¸ªç«¯å£æœåŠ¡2ï¼Œè®¿é—®å®ƒè¿™é‡Œçš„<code>/demo</code>å“åº”9ï¼Œå¹¶ä¸”åœ¨å®ƒè¿™é‡Œæ˜¯æ²¡æœ‰<code>/demo/v2</code>æ¥å£çš„ï¼Œè¿™ä¸ªæ¥å£æ˜¯æ–°åŠ ä¸Šå»çš„</p></blockquote><hr><p>è¿™é‡Œæˆ‘ä½¿ç”¨redisæ¥å­˜å‚¨IPåˆ—è¡¨ï¼Œå®‰è£…çš„æ–¹å¼å¯ä»¥åœ¨æˆ‘Redisç¬¬ä¸€ç« ä¸­æ‰¾åˆ°ï¼Œè¿™é‡Œä¸åšå¤ªå¤šçš„ä»‹ç»ã€‚</p><p>é¦–å…ˆå°†æœ¬åœ°IPå­˜å‚¨åˆ°Redisä¸­ï¼Œå€¼ç»™çš„æ˜¯1</p><pre><code class="hljs bash">~&gt; redis-cli <span class="hljs-built_in">set</span> 127.0.0.1 1</code></pre><p>è¿™é‡Œæ˜¯å…³äºNginxçš„é…ç½®ï¼Œdep.confï¼š</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">8081</span>;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">location</span> /hello &#123;        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;        <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'ngx.say("hello,lua")'</span>;    &#125;    <span class="hljs-attribute">location</span> /myip &#123;        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/plain'</span>;        <span class="hljs-attribute">content_by_lua</span> <span class="hljs-string">'</span><span class="hljs-string">        clientIP=ngx.req.get_headers()["Host"];</span><span class="hljs-string">        ngx.say("IP:",clientIP)'</span>;    &#125;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">default_type</span> <span class="hljs-string">'text/html'</span>;        <span class="hljs-attribute">content_by_lua_file</span> /opt/app/lua/dep.lua;        <span class="hljs-comment">#        add_after_body $http_x_forwarded_for;</span>    &#125;    <span class="hljs-attribute">location</span> <span class="hljs-variable">@server</span>&#123;        <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:9090;    &#125;    <span class="hljs-attribute">location</span> <span class="hljs-variable">@server_test</span>&#123;        <span class="hljs-attribute">proxy_pass</span> http://127.0.0.1:8080;    &#125;&#125;</code></pre><p>è¿™é‡Œçš„<code>/</code>ä¸­å¼•å…¥äº†ä¸€ä¸ª<code>dep.lua</code>æ–‡ä»¶ï¼Œå®ƒçš„å†…å®¹å¦‚ä¸‹ï¼š</p><pre><code class="hljs lua">clientIP = ngx.req.get_headers()[<span class="hljs-string">"X-Real-IP"</span>];<span class="hljs-keyword">if</span> clientIP == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>    clientIP = ngx.req.get_headers()[<span class="hljs-string">"http_x_forwarded_for"</span>]<span class="hljs-keyword">end</span><span class="hljs-keyword">if</span> clientIP == <span class="hljs-literal">nil</span> <span class="hljs-keyword">then</span>    clientIP = ngx.var.remote_addr<span class="hljs-keyword">end</span><span class="hljs-keyword">local</span> redis = <span class="hljs-built_in">require</span>(<span class="hljs-string">"resty.redis"</span>);<span class="hljs-comment">--local redis = require "redis"</span><span class="hljs-comment">-- åˆ›å»ºä¸€ä¸ªrediså¯¹è±¡å®ä¾‹ã€‚åœ¨å¤±è´¥ï¼Œè¿”å›nilå’Œæè¿°é”™è¯¯çš„å­—ç¬¦ä¸²çš„æƒ…å†µä¸‹</span><span class="hljs-keyword">local</span> redis_instance = redis:new();<span class="hljs-comment">--è®¾ç½®åç»­æ“ä½œçš„è¶…æ—¶ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ä¿æŠ¤ï¼ŒåŒ…æ‹¬connectæ–¹æ³•</span>redis_instance:set_timeout(<span class="hljs-number">1000</span>)<span class="hljs-comment">--å»ºç«‹è¿æ¥</span><span class="hljs-keyword">local</span> ip = <span class="hljs-string">'127.0.0.1'</span><span class="hljs-keyword">local</span> port = <span class="hljs-number">6379</span><span class="hljs-comment">--å°è¯•è¿æ¥åˆ°redisæœåŠ¡å™¨æ­£åœ¨ä¾¦å¬çš„è¿œç¨‹ä¸»æœºå’Œç«¯å£</span><span class="hljs-keyword">local</span> ok, err = redis_instance:connect(ip, port)<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ok <span class="hljs-keyword">then</span>    ngx.say(<span class="hljs-string">"connect redis error : "</span>, err)    <span class="hljs-keyword">return</span> close_redis(redis_instance);<span class="hljs-keyword">end</span><span class="hljs-comment">--Redisèº«ä»½éªŒè¯</span><span class="hljs-comment">--local auth,err = redis_instance:auth("");</span><span class="hljs-comment">--if not auth then</span><span class="hljs-comment">--    ngx.say("failed to authenticate : ",err)</span><span class="hljs-comment">--end</span><span class="hljs-keyword">local</span> res, <span class="hljs-built_in">error</span> = redis_instance:get(clientIP)<span class="hljs-keyword">if</span> res == <span class="hljs-string">"1"</span> <span class="hljs-keyword">then</span>    ngx.exec(<span class="hljs-string">"@server_test"</span>)    <span class="hljs-keyword">return</span><span class="hljs-keyword">end</span>ngx.exec(<span class="hljs-string">"@server"</span>)</code></pre><blockquote><p>ä¸Šé¢è¿™äº›ä»£ç çš„é€»è¾‘æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>è·å–å‘è¯·æ±‚çš„å®¢æˆ·ç«¯IP</li><li>é€šè¿‡è¿™ä¸ªIPåœ¨Redisä¸­è¿›è¡ŒæŸ¥è¯¢</li><li>å¦‚æœæŸ¥è¯¢åˆ°äº†ä¸º1å°±å»æ‰§è¡Œ<code>@server_test</code>,æ²¡æŸ¥è¯¢åˆ°åˆ™å»æ‰§è¡Œ<code>@server</code>ï¼Œè¿™é‡Œçš„<code>@server_testã€@server</code>ä¹Ÿå°±æ˜¯dep.confä¸­å®šä¹‰çš„locationï¼Œå®ƒä¼šè¢«æ‰§è¡Œï¼Œè¿™æ ·ä¸€æ¥å°±å®ç°äº†å‰é¢æ‰€ä»‹ç»çš„åœºæ™¯äº†</li></ol></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Linuxã€‘ Linuxä¸­çš„å¸¸è§é—®é¢˜</title>
    <link href="/linux-2.html"/>
    <url>/linux-2.html</url>
    
    <content type="html"><![CDATA[<h1 id="HTTPæœåŠ¡ç«¯å£æ²¡æœ‰æƒé™"><a href="#HTTPæœåŠ¡ç«¯å£æ²¡æœ‰æƒé™" class="headerlink" title="HTTPæœåŠ¡ç«¯å£æ²¡æœ‰æƒé™"></a>HTTPæœåŠ¡ç«¯å£æ²¡æœ‰æƒé™</h1><p> ç³»ç»Ÿå¯åŠ¨ Nginx åï¼ŒæŠ¥ [emerg] bind () to 0.0.0.0:XXXX failed (13: Permission denied) é”™è¯¯çš„å¤„ç†æ–¹å¼ï¼Œåˆ†ä¸ºä¸¤ç§ï¼š</p><p>ç¬¬ä¸€ç§ï¼šç«¯å£å°äº 1024 çš„æƒ…å†µï¼š</p><pre><code class="hljs bash">[emerg] <span class="hljs-built_in">bind</span>() to 0.0.0.0:80 failed (13: Permission denied)</code></pre><p>åŸå› æ˜¯ 1024 ä»¥ä¸‹ç«¯å£å¯åŠ¨æ—¶éœ€è¦ root æƒé™ï¼Œæ‰€ä»¥ sudo nginx å³å¯ã€‚</p><p>ç¬¬äºŒç§ï¼šç«¯å£å¤§äº 1024 çš„æƒ…å†µï¼š</p><pre><code class="hljs bash">[emerg] <span class="hljs-built_in">bind</span>() to 0.0.0.0:8380 failed (13: Permission denied)</code></pre><p>è¿™ç§æƒ…å†µï¼Œéœ€è¦å¦‚ä¸‹æ“ä½œï¼š</p><p>é¦–å…ˆï¼ŒæŸ¥çœ‹ http å…è®¸è®¿é—®çš„ç«¯å£ï¼š</p><pre><code class="hljs bash">semanage port -l | grep http_port_thttp_port_t                    tcp      80, 81, 443, 488, 8008, 8009, 8443, 9000</code></pre><p>å…¶æ¬¡ï¼Œå°†è¦å¯åŠ¨çš„ç«¯å£åŠ å…¥åˆ°å¦‚ä¸Šç«¯å£åˆ—è¡¨ä¸­</p><pre><code class="hljs bash">semanage port -a -t http_port_t  -p tcp 8090</code></pre><p>å¦‚æ­¤å³å¯è§£å†³å¦‚ä¸Šé—®é¢˜ã€‚</p><p>cenos7 å®‰è£… semanage å‘½ä»¤å‚è€ƒï¼š<a href="https://blog.csdn.net/RunSnail2018/article/details/81185653" target="_blank" rel="noopener">https://blog.csdn.net/RunSnail2018/article/details/81185653</a></p><h1 id="yumæ‰¾ä¸åˆ°"><a href="#yumæ‰¾ä¸åˆ°" class="headerlink" title="yumæ‰¾ä¸åˆ°"></a>yumæ‰¾ä¸åˆ°</h1><pre><code class="hljs bash">~&gt; sudo yum install epel-release~&gt; yum update</code></pre><h1 id="å¼€æœºè‡ªå¯shellè„šæœ¬"><a href="#å¼€æœºè‡ªå¯shellè„šæœ¬" class="headerlink" title="å¼€æœºè‡ªå¯shellè„šæœ¬"></a>å¼€æœºè‡ªå¯shellè„šæœ¬</h1><p>shellè„šæœ¬ä¸­ä¸€å®šè¦å‡å¦‚çš„å†…å®¹ï¼š</p><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><span class="hljs-comment">#chkconfig: 2345 80 90</span><span class="hljs-comment">#description:auto_run</span>....</code></pre><p>shellè„šæœ¬éœ€è¦å­˜æ”¾çš„ä½ç½®ï¼š<code>/etc/rc.d/init.d</code></p><pre><code class="hljs bash">chkconfig  -add nginx_start.shchkconfig  nginx_start.sh  on</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶ç¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Nginxã€‘ 3.åœºæ™¯å®è·µç¯‡</title>
    <link href="/nginx-3.html"/>
    <url>/nginx-3.html</url>
    
    <content type="html"><![CDATA[<h1 id="Nginxä½œä¸ºé™æ€èµ„æºwebæœåŠ¡"><a href="#Nginxä½œä¸ºé™æ€èµ„æºwebæœåŠ¡" class="headerlink" title="Nginxä½œä¸ºé™æ€èµ„æºwebæœåŠ¡"></a>Nginxä½œä¸ºé™æ€èµ„æºwebæœåŠ¡</h1><h2 id="é™æ€èµ„æºç±»å‹"><a href="#é™æ€èµ„æºç±»å‹" class="headerlink" title="é™æ€èµ„æºç±»å‹"></a>é™æ€èµ„æºç±»å‹</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200127224411585.png" srcset="/img/loading.gif" alt="image-20200127224411585"></p><p> nginxå¯ä»¥ä½œä¸ºé™æ€æœåŠ¡ï¼Œå®ƒèƒ½æ¥æ”¶å®¢æˆ·ç«¯é™æ€èµ„æºçš„è¯·æ±‚ï¼Œåƒhtmlã€flvã€jpgè¿™äº›éƒ½æ˜¯å¯ä»¥çš„ï¼Œå®ƒèƒ½è¿”å›ç»™å®¢æˆ·ç«¯ç›¸åº”å†…å®¹ã€‚è¿™ç§æ–¹å¼ç»å¸¸ä¼šç”¨åœ¨å¤„ç†è¯·æ±‚ã€åŠ¨é™åˆ†ç¦»çš„åœºæ™¯ï¼›</p><p><strong>é™æ€èµ„æºç±»å‹ï¼š</strong></p><table><thead><tr><th>ç±»å‹</th><th>ç§ç±»</th></tr></thead><tbody><tr><td>æµè§ˆå™¨ç«¯æ¸²æŸ“</td><td>HTMLã€CSSã€JS</td></tr><tr><td>å›¾ç‰‡</td><td>JPEGã€GIFã€PNG</td></tr><tr><td>è§†é¢‘</td><td>FLVã€MPEG</td></tr><tr><td>æ–‡ä»¶</td><td>TXTã€ç­‰ä»»æ„ä¸‹è½½æ–‡ä»¶</td></tr></tbody></table><h2 id="CDNåœºæ™¯"><a href="#CDNåœºæ™¯" class="headerlink" title="CDNåœºæ™¯"></a>CDNåœºæ™¯</h2><p>CDNï¼šå†…å®¹åˆ†å‘ç½‘ç»œï¼Œè¿™é‡Œçš„ç½‘ç»œæ˜¯å†…å®¹åˆ†å‘çš„é€»è¾‘æ€§ç½‘ç»œã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200127225519660.png" srcset="/img/loading.gif" alt="image-20200127225519660"></p><p><strong>ä»€ä¹ˆæ˜¯CDNï¼Ÿ</strong><br>åŒ—äº¬çš„ä¸€ä¸ªç”¨æˆ·æƒ³è¦è¯·æ±‚ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æ”¾åœ¨æ–°ç–†çš„æœºå™¨ä¸Šï¼Œæ–°ç–†ç¦»åŒ—äº¬çš„è·ç¦»æ˜¯éå¸¸è¿œçš„ï¼Œé‚£ä¹ˆæƒ³è·å–è¿™ä¸ªæ–‡ä»¶å°±éœ€è¦ä¸€å®šæ—¶é—´äº†ï¼›æ€ä¹ˆåŠï¼Ÿå‡è®¾è¿™ä¸ªå­˜å‚¨ä¸­å¿ƒåœ¨æ–°ç–†ï¼Œè¿™é‡Œå°±ç”¨åˆ°CDNåˆ†å‘ç½‘è·¯æŠ€æœ¯ï¼ŒæŠŠé‚£ä¸ªè¯·æ±‚çš„æ–‡ä»¶è¿›è¡Œåˆ†å‘ï¼Œå‘é€ç»™ä¸åŒçš„åœ°åŒºæœºå™¨ï¼Œæ¯ä¸ªä¸åŒåœ°åŒºæœºå™¨è£…ä¸€ä¸ªä»£ç†ï¼ŒåŒ—äº¬ç”¨æˆ·æ¥è¯´ï¼Œé€šè¿‡æ™ºèƒ½DNSæŠ€æœ¯æŠŠå®ƒçš„è¯·æ±‚åŠ¨æ€å®šä½åˆ°èƒŒæ™¯çš„ä»£ç†ä¸Šè¿›è¡Œè¯·æ±‚ï¼Œè¿™æ ·å°±ä¸ç”¨è¯·æ±‚ä¹‹å‰æ–°ç–†çš„èŠ‚ç‚¹äº†ï¼Œè¿™ä¸ªåœ°æ–¹å¯¹äºç”¨æˆ·æ¥è¯´å°±èŠ‚çœäº†å¾ˆå¤šçš„æ—¶é—´ï¼Œå¯¹äºCDNæŠ€æœ¯æ¥è¯´æˆ‘ä»¬è¦æ±‚çš„æ˜¯è¿™ä¸ªä¼ è¾“ å»¶æ—¶çš„æœ€å°åŒ–ã€‚é™æ€èµ„æºé€‚ç”¨äºè¿™ç§åœºæ™¯ï¼Œæ‰€ä»¥nginxä½œä¸ºæ¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œèµ„æºå­˜å‚¨ä¸­å¿ƒèŠ‚ç‚¹ä»¥åŠä»£ç†å‰ç«¯èŠ‚ç‚¹èµ·äº†ä¸€ä¸ªéå¸¸æ‰¿ä¸Šå¯ä¸‹çš„web serverä½œç”¨</p><h2 id="é…ç½®è¯­æ³•"><a href="#é…ç½®è¯­æ³•" class="headerlink" title="é…ç½®è¯­æ³•"></a>é…ç½®è¯­æ³•</h2><h3 id="æ–‡ä»¶è¯»å–"><a href="#æ–‡ä»¶è¯»å–" class="headerlink" title="æ–‡ä»¶è¯»å–"></a>æ–‡ä»¶è¯»å–</h3><p>Syntaxï¼šsendfile on | off;<br>Defaultï¼šsendfile off;<br>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œif in location</p><blockquote><p>å¼•è¯»ï¼šâ€”â€”with-file-aioå¼‚æ­¥æ–‡ä»¶è¯»å–</p></blockquote><h3 id="tcp-nopush"><a href="#tcp-nopush" class="headerlink" title="tcp_nopush"></a>tcp_nopush</h3><p>Syntaxï¼štcp_nopush on | off;<br>Defaultï¼štcp_nopush off;<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>ä½œç”¨: sendfileå¼€å¯çš„æƒ…å†µä¸‹,æé«˜ç½‘ç»œåŒ…çš„ä¼ è¾“æ•ˆç‡ã€‚nopushæ˜¯è¯´ä¸ç€æ€¥æŠŠåŒ…å“åº”ç»™å®¢æˆ·ç«¯ï¼Œä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬è¦å»å‘é€ä¸€ä¸ªåŒ…è£¹ï¼Œå¦‚æœæœ‰10ä¸ªåŒ…è£¹æˆ‘ä»¬ä¸€å¤©å‘ä¸€ä¸ªï¼Œè¿™æ ·çš„è¯å¯èƒ½è¦10æ¬¡å¿«é€’å‘˜æ¥è¿›è¡Œå‘é€ï¼Œè¿™é‡Œå¯ä»¥æ¢ä¸€ç§æ–¹å¼ï¼ŒæŠŠ10ä¸ªåŒ…è£¹æ•´ç†çš„æ”¾åˆ°ä¸€å¤©ï¼Œä¸€æ¬¡æ€§ç»™å®ƒå‘é€å‡ºå»ï¼Œå«ä¸€ä¸ªå¿«é€’å‘˜ä¸€æ¬¡æ€§æ¥æ¥ï¼Œè¿™æ ·çš„è¯å¯¹ç½‘ç»œä¼ è¾“æ¥è¯´å°±éå¸¸é«˜æ•ˆäº†ï¼Œæ‰€ä»¥è¿™ä¸ª<code>tcp_no_push</code>æŠŠå¤šä¸ªåŒ…è¿›è¡Œä¸€ä¸ªæ•´åˆä¸€æ¬¡æ€§å‘é€å‡ºå»ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå¯¹äºå¤§æ–‡ä»¶æ˜¯æ¨èçš„</p></blockquote><h3 id="tcp-nodelay"><a href="#tcp-nodelay" class="headerlink" title="tcp_nodelay"></a>tcp_nodelay</h3><p>Syntaxï¼štcp_nodelay on | off;<br>Defaultï¼štcp_nodelay on;<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>ä½œç”¨ï¼škeepaliveè¿æ¥ä¸‹ï¼Œæé«˜ç½‘ç»œåŒ…çš„ä¼ è¾“å®æ—¶æ€§ã€‚è¿™ä¸ªä¸ä¸Šé¢<code>tcp_nopush</code>ç›¸åï¼Œæ•°æ®åŒ…å°½é‡ä¸è¦ç­‰å¾…ç›´æ¥å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®ƒç”¨äºå®æ—¶æ€§è¦æ±‚é«˜çš„åœºæ™¯ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè¦æ±‚ï¼šä¼ è¾“çš„è¿æ¥å¿…é¡»åœ¨keepaliveé•¿è¿æ¥çš„æ¨¡å¼ä¸‹æ‰èƒ½å¤Ÿç”Ÿæ•ˆ</p></blockquote><h3 id="å‹ç¼©"><a href="#å‹ç¼©" class="headerlink" title="å‹ç¼©"></a>å‹ç¼©</h3><p><strong>å‹ç¼©æ–‡ä»¶</strong></p><p>Syntaxï¼šgzip on | off;<br>Defaultï¼šgzip  off;<br>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œif in location</p><blockquote><p>ä½œç”¨ï¼šå‹ç¼©ä¼ è¾“ã€‚å¯¹äºæ–‡ä»¶çš„å‹ç¼©æ˜¯éå¸¸é‡è¦çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¦å‡å°ä¼ è¾“çš„æ—¶é—´ï¼Œä¸€ä¸ªå¤§çš„åŒ…å¦‚æœè¦ç»è¿‡ä¼ è¾“æ¯”ä¾‹è¾¾åˆ°ç™¾åˆ†ä¹‹30ä»¥ä¸Šçš„å‹ç¼©æ¯”ä¾‹çš„è¯ï¼Œæˆ‘ä»¬çš„èµ„æºå¸¦å®½å’Œä¼ è¾“å®æ—¶æ€§æ˜¯éå¸¸å¥½çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å¯¹Nginxè¿›è¡Œè‡ªå¸¦èµ„æºé‡Œé¢æ¥ï¼Œè¿™ç§è¯·æ±‚å’Œå“åº”çš„æ—¶å€™ç»é‡è¦åˆ°å®ƒçš„å‹ç¼©çš„æ–¹å¼æ¥å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œèµ„æºæ¶ˆè€—</p></blockquote><p><strong>å‹ç¼©æ¯”</strong></p><p>Syntaxï¼šgzip_comp_level level;<br>Defaultï¼šgzip_comp_level 1;<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>å¯¹ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œå¦‚æœå‹ç¼©çš„è¶Šé«˜çš„è¯ï¼Œé‚£ä¹ˆå®ƒçš„æ–‡ä»¶å°±èƒ½å‹ç¼©çš„æ¯”ç‡æ›´å¤§ï¼Œæ‰€ä»¥æ–‡ä»¶ä¹Ÿå°±å‹ç¼©çš„æ›´å°é‚£ä¹ˆä¼ è¾“çš„æ–‡ä»¶ä¹Ÿå°±æ›´å°ï¼Œè¿™æ ·çš„è¯å¥½å¤„æ˜¯å‹ç¼©å‡å°‘çš„è¶Šå¤šä½†æ˜¯ä¹Ÿä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼šæˆ‘å‹ç¼©æœ¬èº«å°±è¦è€—æœåŠ¡ç«¯çš„æ€§èƒ½ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªåœ°æ–¹çš„é€‰æ‹©ä¸Šé¢æˆ‘ä»¬éœ€è¦æ ¹æ®è‡ªå·±å®é™…æƒ…å†µæ¥é€‰æ‹©å®ƒå‹ç¼©çš„çº§åˆ«</p></blockquote><p> <strong>æ§åˆ¶httpåè®®ç‰ˆæœ¬</strong></p><p>Syntaxï¼šgzip_http_version1.01.1;<br>Defaultï¼šgzip_http_version1.1;<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><p><strong>æ‰©å±•Nginxå‹ç¼©æ¨¡å—</strong></p><p>http_gzip_static_moduleï¼šé¢„è¯»gzipåŠŸèƒ½</p><blockquote><p>æ¯”æ–¹è¯´ï¼Œå®¢æˆ·ç«¯è®¿é—®<code>1.html</code>æ–‡ä»¶ï¼Œå®ƒä¼šåœ¨å®ƒçš„å®¶ç›®å½•é‡Œé¢å…ˆå»æ‰¾<code>1.html.gz</code>æ–‡ä»¶çœ‹æ˜¯å¦å­˜åœ¨ï¼Œå› ä¸º<code>1.html.gz</code>æ˜¯gzipçš„é¢„å‹ç¼©æ–‡ä»¶ï¼Œå¦‚æœæœ‰çš„è¯å…ˆæŠŠ<code>1.html.gz</code>æ–‡ä»¶è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥å®ƒå»ç£ç›˜ä¸­æ‰¾åŒåçš„gzæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œè¿™æ ·èƒ½èŠ‚çœå‹ç¼©æ—¶é—´ï¼Œä½†æ˜¯å®ƒå¯¹ç¡¬ç›˜æœ‰è¦æ±‚ï¼Œå› ä¸ºå®ƒè¦é¢„å…ˆå‹ç¼©å¥½</p></blockquote><p>http_gunzip_moduleï¼šåº”ç”¨æ”¯æŒgunzipçš„å‹ç¼©æ–¹å¼</p><blockquote><p>è¿™ä¸ªæ¨¡å—ç”¨å¾—å¾ˆå°‘ï¼Œå®ƒæ˜¯ä¸ºäº†è§£å†³å¾ˆå°‘ä¸€éƒ¨åˆ†æµè§ˆå™¨é‡Œé¢æ— æ³•æ”¯æŒgzipï¼Œå¦‚æœé‡è§éƒ¨åˆ†æµè§ˆå™¨æ— æ³•ç”¨åˆ°gzipå‹ç¼©çš„è¯å°±å¯ä»¥ä½¿ç”¨å®ƒæ¥è§£å†³</p></blockquote><h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><h3 id="1-å›¾ç‰‡å‹ç¼©"><a href="#1-å›¾ç‰‡å‹ç¼©" class="headerlink" title="(1)å›¾ç‰‡å‹ç¼©"></a>(1)å›¾ç‰‡å‹ç¼©</h3><p>åœ¨/opt/app/code/imagesç›®å½•ä¸­å‡†å¤‡äº†ä¸€å¼ å›¾ç‰‡</p><pre><code class="hljs bash">/opt/app/code/images&gt; lsbg.png</code></pre><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">sendfile</span> <span class="hljs-literal">on</span>;<span class="hljs-attribute">location</span> <span class="hljs-regexp">~ .*\.(jpg|gif|png)$</span> &#123;                <span class="hljs-comment">#gzip on;</span>                <span class="hljs-attribute">gzip_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;                <span class="hljs-attribute">gzip_comp_level</span> <span class="hljs-number">2</span>;                <span class="hljs-attribute">gzip_types</span> text/plain application/javascript applicaiton/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;                <span class="hljs-attribute">root</span> /opt/app/code/images;        &#125;</code></pre><p>æ²¡å¼€å¯gzipçš„å›¾ç‰‡çš„å“åº”å¤´</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200128135354132.png" srcset="/img/loading.gif" alt="image-20200128135354132"></p><p>å¼€å¯ä¹‹å</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200128135631040.png" srcset="/img/loading.gif" alt="image-20200128135631040"></p><h3 id="2-æ–‡ä»¶å‹ç¼©"><a href="#2-æ–‡ä»¶å‹ç¼©" class="headerlink" title="(2)æ–‡ä»¶å‹ç¼©"></a>(2)æ–‡ä»¶å‹ç¼©</h3><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ .*\.(txt|xml)$</span> &#123;                <span class="hljs-comment">#gzip on;                               </span>               <span class="hljs-attribute">gzip_http_version</span> <span class="hljs-number">1</span>.<span class="hljs-number">1</span>;                <span class="hljs-attribute">gzip_comp_level</span> <span class="hljs-number">1</span>;                <span class="hljs-attribute">gzip_types</span> text/plain application/javascript applicaiton/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;                <span class="hljs-attribute">root</span> /opt/app/code/doc;&#125;</code></pre><p>æœªä½¿ç”¨gzipçš„æ–‡ä»¶å¤§å°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200128140435370.png" srcset="/img/loading.gif" alt="image-20200128140435370"></p><p>ä½¿ç”¨gzipçš„æ–‡ä»¶å¤§å°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200128140501065.png" srcset="/img/loading.gif" alt="image-20200128140501065"></p><h3 id="3-é¢„å‹ç¼©"><a href="#3-é¢„å‹ç¼©" class="headerlink" title="(3)é¢„å‹ç¼©"></a>(3)é¢„å‹ç¼©</h3><pre><code class="hljs bash">/opt/app/code/download&gt; lsbg.png/opt/app/code/download&gt; gzip bg.png/opt/app/code/download&gt; lsbg.png.gz</code></pre><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/download</span>&#123;                <span class="hljs-comment">#gzip_static on;</span>                <span class="hljs-attribute">tcp_nopush</span> <span class="hljs-literal">on</span>;                <span class="hljs-attribute">root</span> /opt/app/code;&#125;</code></pre><ul><li>æ²¡æœ‰å¼€å¯gzip_staticï¼šè®¿é—®<code>/download/bg.png</code>ä¼šæŠ¥404é”™è¯¯</li><li>å¼€å¯gzip_staticï¼šèƒ½æ­£å¸¸è®¿é—®</li></ul><h2 id="è·¨ç«™è®¿é—®"><a href="#è·¨ç«™è®¿é—®" class="headerlink" title="è·¨ç«™è®¿é—®"></a>è·¨ç«™è®¿é—®</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>è·¨ç«™è®¿é—®æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>æµè§ˆå™¨ä¼šç¦æ­¢ç½‘ç«™è¿›è¡Œè·¨ç«™è®¿é—®ï¼Œä¾‹å¦‚ï¼š</p><p><a href="http://www.a.comè¿™ä¸ªç½‘ç«™é€šè¿‡åƒ`AJAX`æŠ€æœ¯è®¿é—®http://www.b.comï¼Œè¿™æ ·å°±æ˜¯æ‰€è°“çš„è·¨ç«™è®¿é—®ï¼Œå¯¹äºæµè§ˆå™¨æ¥è¯´æ˜¯ç¦æ­¢çš„ã€‚" target="_blank" rel="noopener">http://www.a.comè¿™ä¸ªç½‘ç«™é€šè¿‡åƒ`AJAX`æŠ€æœ¯è®¿é—®http://www.b.comï¼Œè¿™æ ·å°±æ˜¯æ‰€è°“çš„è·¨ç«™è®¿é—®ï¼Œå¯¹äºæµè§ˆå™¨æ¥è¯´æ˜¯ç¦æ­¢çš„ã€‚</a></p><hr><p><strong>ä¸ºä»€ä¹ˆæµè§ˆå™¨ç¦æ­¢è·¨åŸŸè®¿é—®ï¼Ÿ</strong></p><ul><li>(1)ä¸å®‰å…¨ï¼Œå®¹æ˜“å‡ºç°CSRFæ”»å‡»ï¼</li></ul><p>è·¨ç«™æ”»å‡»å½¢æˆåŸç†ï¼š</p><p>â€‹    ä¸€èˆ¬ä¸€ä¸ªç”¨æˆ·å»è®¿é—®ä¸€ä¸ªæ­£è§„çš„ç½‘ç«™Aï¼Œç½‘ç«™Aä¼šè¿”å›å¯¹åº”çš„cookieä¿¡æ¯ï¼Œcookieä¿¡æ¯å­˜æ”¾åœ¨å®¢æˆ·ç«¯ï¼Œå½“è¿™ä¸ªç”¨æˆ·ä¸å°å¿ƒç‚¹åˆ°äº†éæ³•ç½‘ç«™ï¼Œè¿™ä¸ªæ—¶å€™éæ³•ç½‘ç«™å°±å¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¸€äº›responseå¸¦æœ‰æ¶æ„è¯·æ±‚è®©ç”¨æˆ·å»è¯·æ±‚ç½‘ç«™Aï¼Œè¿™æ ·å°±å½¢æˆäº†è·¨ç«™è®¿é—®ï¼Œæ‰€ä»¥è¿™ç§è·¨ç«™è®¿é—®æµè§ˆå™¨è¿›è¡Œå°é—­ï¼Œä¸ºä»€ä¹ˆé˜»æ­¢äº†ä¸ºä»€ä¹ˆè¿™é‡Œè¿˜è¦ å­¦ Nginxè·¨ç«™è®¿é—®å‘¢ï¼Ÿ</p><p>â”€â”€å®‰å…¨å½’å®‰å…¨ï¼Œä¸€äº›ä¼ä¸šçš„æƒ…å†µã€ä¸€äº›å†å²åŸå› ã€å¼€å‘è®¾è®¡ã€ç½‘ç«™è®¾è®¡ã€ä¸šåŠ¡çš„å½¢æ€ï¼Œå¾€å¾€ä¼šéœ€è¦å¯¹ä¸€äº›èµ„æºæ‰“å¼€è·¨ç«™ï¼Œå› ä¸ºæœ‰çš„æ—¶å€™ä¸ä¸€å®šåªéœ€è¦ä¸€ä¸ªåŸŸåï¼Œæœ‰çš„æ—¶å€™éœ€è¦ç”¨åˆ°å¤šä¸ªåŸŸåï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨Nginxæ‰“å¼€è®¿é—®è®¾ç½®ã€‚</p><p><strong>æµè§ˆå™¨è®¾ç½®å’ŒNginxæœåŠ¡ç«¯æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿ</strong></p><p>æµè§ˆå™¨ç«¯æ˜¯æŒ‡å®ƒä¼šåˆ¤æ–­ä¸€ä¸ªå¤´ä¿¡æ¯ï¼šresponseçš„å¤´ä¸­æœ‰æ²¡æœ‰<code>Access-Control-Allow-Origin</code>ï¼Œå¦‚æœæœåŠ¡ç«¯å…è®¸è·¨ç«™è®¿é—®ï¼Œé‚£ä¹ˆæµè§ˆå™¨ç«¯å°±ä¸ä¼šå»é™åˆ¶ã€‚</p><p><strong>Nginxé…ç½®</strong></p><p>Syntaxï¼šadd_header name value [always];<br>Defaultï¼šâ€”â€”<br>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œif in location</p><blockquote><ul><li>nameï¼šå¤´çš„åå­—ã€‚æˆ‘ä»¬è¦æ‰“å¼€è·¨ç«™çš„è¯å°±æ˜¯<code>Access-Control-Allow-Origin</code></li><li>valueï¼šå¯¹åº”å“ªä¸€äº›ç«™ç‚¹å…è®¸å¯¹åº”çš„å€¼æ¥è¿›è¡Œè®¿é—®ï¼Œå…è®¸å…¨éƒ¨ç«™ç‚¹ï¼š*</li></ul></blockquote><h3 id="æ¼”ç¤º-1"><a href="#æ¼”ç¤º-1" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ .*\.(htm|html)$</span> &#123; <span class="hljs-attribute">add_header</span> Access-Control-Allow-Origin *; <span class="hljs-attribute">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE,OPTIONS; <span class="hljs-attribute">add_header</span> Access-Control-Allow-Headers <span class="hljs-string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization'</span>;  <span class="hljs-attribute">root</span> /opt/app/code/doc;&#125;</code></pre><h2 id="é˜²ç›—é“¾"><a href="#é˜²ç›—é“¾" class="headerlink" title="é˜²ç›—é“¾"></a>é˜²ç›—é“¾</h2><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>1ï¼‰ã€ç›®çš„</p><p>é˜²æ­¢èµ„æºè¢«ç›—ç”¨ï¼›</p><p>ä¾‹å¦‚ï¼š</p><ul><li>åœ¨ä¸€äº›æ­£å¸¸æœåŠ¡ä¸‹é¢æˆ‘ä»¬å¸Œæœ›æ˜¯ä¸€äº›åˆæ³•çš„ç”¨æˆ·æ¥è®¿é—®æˆ‘ä»¬ç½‘ç«™ï¼Œæˆ‘ä¸å¸Œæœ›ç«äº‰å¯¹æ‰‹æ¥çˆ¬å–ç½‘ç«™çš„èµ„æºï¼Œç„¶åæŠŠæˆ‘çš„èµ„æºéƒ½æ”¾åˆ°ç«äº‰å¯¹æ‰‹å»äº†</li><li>å¤§éƒ¨åˆ†æ²¡ç”¨çš„ç”¨æˆ·æ¥è¯·æ±‚æˆ‘çš„ç½‘ç«™ï¼Œæ˜¯å¿…å¯¹æˆ‘ç½‘ç«™çš„æ€§èƒ½å¯¹åº”è¯·æ±‚é€ æˆäº†é¢å¤–çš„æŸè€—</li></ul><p>é˜²ç›—é“¾å°±èƒ½è§£å†³ä»¥ä¸Šé—®é¢˜ã€‚é˜²ç›—é“¾çš„æœºåˆ¶æœ‰å¾ˆå¤šç§ï¼Œè¿™æ˜¯ä¸€é—¨éå¸¸é«˜çš„æŠ€æœ¯è¦æ±‚ï¼Œç®€å•çš„é˜²ç›—é“¾æŠ€æœ¯ï¼ŒNginxéƒ½æ”¯æŒï¼Œè¿™ä¸ªç« èŠ‚å°±ç®€å•çš„å®ç°</p><hr><p>2ï¼‰ã€é˜²ç›—é“¾è®¾ç½®æ€è·¯</p><p>é¦–è¦æ–¹å¼ï¼šåŒºåˆ«å“ªäº›è¯·æ±‚æ˜¯éå¸¸æ­£å¸¸çš„ç”¨æˆ·è¯·æ±‚ã€‚å¯¹äºé‚£äº›ä¸æ­£å¸¸çš„ç”¨æˆ·è¿›è¡Œé˜»æ­¢ä¸è®©å®ƒæ¥è®¿é—®ï¼Œå¯¹äºæ­£å¸¸çš„ç”¨æˆ·ä¿è¯ä¸€å®šèƒ½è¯·æ±‚åˆ°ä¸èƒ½ä½œä¸ºéæ­£å¸¸ç”¨æˆ·å¤„ç†</p><hr><p>3ï¼‰ã€åŸºäºhttp_referé˜²ç›—é“¾é…ç½®æ¨¡å—</p><p>Syntax:    valid_referers none | blocked | server_names | string â€¦;<br>Default:    â€”<br>Context:    server, location</p><hr><p>4ï¼‰ã€ä»€ä¹ˆæ˜¯http_referï¼Ÿ</p><p>åœ¨nginx.confä¸­å°±æœ‰ä½¿ç”¨è¿‡å®ƒ</p><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;    <span class="hljs-attribute">log_format</span>  main   <span class="hljs-string">'<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] "<span class="hljs-variable">$request</span>" '</span>                      <span class="hljs-string">'<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> "<span class="hljs-variable">$http_referer</span>" '</span>                      <span class="hljs-string">'"<span class="hljs-variable">$http_user_agent</span>" "<span class="hljs-variable">$http_x_forwarded_for</span>"'</span>;                       ....                     &#125;</code></pre><p>ä¸¾ä¸ªä¾‹å­</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://dev001.com/test.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"test"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>è¿™ä¸ªhtmlåŠ è½½äº†ä¸€ä¸ªå›¾ç‰‡ï¼Œè¿™ä¸ªå›¾ç‰‡åˆ™æ˜¯é€šè¿‡Nginxä»£ç†çš„ï¼Œé…ç½®å¦‚ä¸‹</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ \.(jpg|gif|png)$</span> &#123;                <span class="hljs-attribute">root</span> /opt/app/code/images;&#125;</code></pre><p>å°†è¿™ä¸ªé¡µé¢ä¹Ÿç”¨nginxä»£ç†</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> = /test.html&#123;              <span class="hljs-attribute">root</span> /opt/app/code;&#125;</code></pre><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—®/test.html,æ—¥å¿—è¾“å‡ºä¸ºï¼š</p><pre><code class="hljs bash">~&gt; tail -f  /var/<span class="hljs-built_in">log</span>/nginx/access.log192.168.202.1 - - [03/Feb/2020:18:20:21 +0800] <span class="hljs-string">"GET /test.html HTTP/1.1"</span> 200 181 <span class="hljs-string">"-"</span> <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36"</span> <span class="hljs-string">"-"</span>192.168.202.1 - - [03/Feb/2020:18:20:21 +0800] <span class="hljs-string">"GET /test.png HTTP/1.1"</span> 200 11164706 <span class="hljs-string">"http://dev001.com/test.html"</span> <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36"</span> <span class="hljs-string">"-"</span></code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€æ¬¡è¯·æ±‚çš„ï¼štest.html,å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„â€-â€œ æ˜¯ä¸€ä¸ªç©ºä¿¡æ¯ã€‚</p><p>ç¬¬äºŒä¸ªè¯·æ±‚çš„æ˜¯å›¾ç‰‡ï¼Œå®ƒè¿™é‡Œä¸æ˜¯â€-â€œ è€Œæ˜¯â€<a href="http://dev001.com/test.html&quot;ã€‚è¿™ä¸ªå°±æ˜¯å¯¹åº”å‰é¢è¯´çš„æ—¥å¿—è¾“å‡ºä¸­ç”¨åˆ°çš„`http_referer`ï¼Œå®ƒæ¥è®°å½•ä¸Šä¸€æ¬¡çš„è¯·æ±‚ã€‚" target="_blank" rel="noopener">http://dev001.com/test.html&quot;ã€‚è¿™ä¸ªå°±æ˜¯å¯¹åº”å‰é¢è¯´çš„æ—¥å¿—è¾“å‡ºä¸­ç”¨åˆ°çš„`http_referer`ï¼Œå®ƒæ¥è®°å½•ä¸Šä¸€æ¬¡çš„è¯·æ±‚ã€‚</a></p><hr><h3 id="ç®€å•å®ç°"><a href="#ç®€å•å®ç°" class="headerlink" title="ç®€å•å®ç°"></a>ç®€å•å®ç°</h3><p>é€šè¿‡ä»¥ä¸Šä»‹ç»çŸ¥é“äº†<code>http_referer</code>ä»¥åï¼Œæ¥è¯´ä¸‹ å¯¹äºåœºæ™¯é˜²ç›—é“¾çš„é™åˆ¶ï¼Œæˆ‘ä»¬é™åˆ¶é˜²ç›—é“¾æ˜¯ä¸ºäº†é˜²æ­¢æˆ‘ä»¬çš„ç½‘ç«™è¢«ä¸€äº›åŠ¨æ€èµ„æºæ¯”å¦‚å›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶èµ„æºï¼Œè¢«åˆ«çš„ç½‘ç«™ä½¿ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œå°±å¯ä»¥æ‹¿ä¸Šé¢è¯´çš„<code>http_referer</code>ä¿¡æ¯æ¥åˆ¤æ–­æ˜¯å¦æ˜¯æˆ‘ä»¬ç½‘ç«™ï¼Œä¸æ˜¯æˆ‘ä»¬ç½‘ç«™çš„è¯æˆ‘ä»¬å°±åº”è¯¥ç»™å®ƒé˜»æ­¢æ‰ã€‚</p><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ .*\.(jpg|gif|png)$</span> &#123;                <span class="hljs-attribute">valid_referers</span> <span class="hljs-literal">none</span> <span class="hljs-literal">blocked</span> <span class="hljs-number">192.168.202.151</span>;                <span class="hljs-attribute">if</span> (<span class="hljs-variable">$invalid_referer</span>)&#123;                        <span class="hljs-attribute">return</span> <span class="hljs-number">403</span>;                &#125;                <span class="hljs-attribute">root</span> /opt/app/code/images;&#125;</code></pre><blockquote><p>valid_referersï¼šå…è®¸ä¸€äº›refererä¿¡æ¯è®¿é—®</p><p>noneï¼šå…è®¸æ²¡æœ‰å¸¦referer</p><p>blockedï¼šrefererä¿¡æ¯ä¸æ˜¯æ ‡å‡†çš„httpè¿™ç§æ–¹å¼ï¼Œå…è®¸ä¸€äº›æ²¡æœ‰åè®®ä¿¡æ¯çš„è¿™ç§è¿‡æ¥çš„è¯·æ±‚</p><p>192.168.202.151ï¼šåªå…è®¸é€šè¿‡è¿™ä¸ªIPæ¥è®¿é—®</p></blockquote><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—®<a href="http://dev001.com/test.htmlçš„ç»“æœï¼š" target="_blank" rel="noopener">http://dev001.com/test.htmlçš„ç»“æœï¼š</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200205110046152.png" srcset="/img/loading.gif" alt="image-20200205110046152"></p><p>åœ¨æµè§ˆå™¨ä¸­è®¿é—®<a href="http://192.168.202.151/test.htmlçš„ç»“æœ" target="_blank" rel="noopener">http://192.168.202.151/test.htmlçš„ç»“æœ</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200205110124230.png" srcset="/img/loading.gif" alt="image-20200205110124230"></p><h1 id="Nginxä½œä¸ºä»£ç†æœåŠ¡"><a href="#Nginxä½œä¸ºä»£ç†æœåŠ¡" class="headerlink" title="Nginxä½œä¸ºä»£ç†æœåŠ¡"></a>Nginxä½œä¸ºä»£ç†æœåŠ¡</h1><h2 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>1ï¼‰ä»€ä¹ˆæ˜¯ä»£ç†ï¼Ÿ</p><p>åŠä¸€äº›äº‹æƒ…æ— æ³•ç›´æ¥å»å’Œå¯¹åº”çš„äººå‘˜å»è”ç³»ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ä»£ç†æœåŠ¡æˆ–è€…äººå‘˜æ¥å¸®æˆ‘ä»¬å®ç°ï¼Œä»£ç†åœ¨æˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»ä¸­å¿…ä¸å¯å°‘ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬æœ‰å¾ˆå¤šçš„é’±ï¼Œæˆ‘ä»¬éœ€è¦å»è°ˆé‡‘èè¿™ä¸€å—ï¼Œå¾€å¾€ä¼šæ‰¾ä¸€ä¸ªç¬¬ä¸‰æ–¹çš„ä»£ç†å…¬å¸æ¥ä»£ç†ç†è´¢ï¼›ä»£ç†æ”¶è´§ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬åœ¨æ·˜å®ä¸Šä¹°äº†å¾ˆå¤šä¸œè¥¿ï¼Œæˆ‘ä»¬ä¸åœ¨å®¶çš„æ—¶å€™ï¼Œå¿«é€’å‘˜ä¼šæŠŠç‰©å“æ”¾åˆ°é©¿ç«™ã€æ”¶è´§æŸœé‡Œé¢ï¼Œç­‰æˆ‘ä»¬å›æ¥å†å»å–ï¼Œè¿™æ ·å°±æ˜¯ä»£ç†æ”¶è´§ã€‚</p><hr><p>2ï¼‰ä»£ç†åº”ç”¨åœ¨äº’è”ç½‘</p><p>åœ¨äº’è”ç½‘çš„è¯·æ±‚é‡Œé¢ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œå®¢æˆ·ç«¯æ— æ³•å‘æœåŠ¡ç«¯ç›´æ¥å‘èµ·è¯·æ±‚çš„æ—¶å€™å®ƒå°±éœ€è¦ç”¨åˆ°ä»£ç†ï¼Œä»£ç†å°±å®ç°äº†å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´çš„ä¸€ä¸ªé€šä¿¡ï¼Œå®¢æˆ·ç«¯é¦–å…ˆä¼šè¯·æ±‚ä»£ç†ï¼Œ ä»£ç†ä¼šæŠŠè¯·æ±‚ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å†é€šè¿‡ä»£ç†è¿”å›ã€‚</p><hr><p>3ï¼‰Nginxå®ç°ä»£ç†æœåŠ¡</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200205130951441.png" srcset="/img/loading.gif" alt="image-20200205130951441"></p><p>Nginxæ¥å®ç°ä»£ç†æœåŠ¡å°±å¯ä»¥å®ç°å¾ˆå¤šåè®®çš„ä»£ç†ä¾‹å¦‚å›¾ä¸­çš„ï¼š</p><ul><li>HTTP</li><li>ICMP\POP\IMAPï¼šé‚®ä»¶æ”¶å‘ã€æ”¶å‘ä¿¡åè®®</li><li>HTTPSï¼šHTTPåŠ å¯†</li><li>PTMPï¼šæµåª’ä½“å¸¸ç”¨æ ¼å¼</li></ul><hr><p>4ï¼‰æ­£å‘ä»£ç†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200205132746368.png" srcset="/img/loading.gif" alt="image-20200205132746368"></p><p> å®¢æˆ·ç«¯è¯·æ±‚ä»£ç†æœåŠ¡ï¼Œä»£ç†æœåŠ¡è¯·æ±‚æœåŠ¡ç«¯ã€‚æ­£å‘ä»£ç†ä¼šç”¨åˆ°å“ªäº›åœºæ™¯ï¼Ÿæ¯”å¦‚ä¸€ä¸ªå…¬å¸æ‰€æœ‰ç”µè„‘æ²¡æ³•ä¸Šç½‘ï¼Œä½†æ˜¯åªæœ‰ä¸€å°æœºå™¨å¯ä»¥ä¸Šç½‘çš„æ—¶å€™æˆ‘ä»¬å¾€å¾€ä¼šåœ¨æµè§ˆå™¨é‡Œé¢éœ€è¦é…ç½®ä¸€ä¸ªä»£ç†çš„åœ°å€ï¼Œé€šè¿‡è¿™å°ä»£ç†çš„æœåŠ¡å™¨å»å‘å…¬ç½‘ï¼Œè¿™ä¸ªæ˜¯æ—©æœŸå…¬å¸é‡Œé¢ç»å¸¸ä¼šè¿™ä¹ˆå»åšï¼Œå¦å¤–ä¸€ä¸ªå¸¸è§çš„æ˜¯ç¿»å¢™äº†ï¼Œå»é€šè¿‡å›½å¤–çš„ä»£ç†å»æœç´¢æƒ³è¦çœ‹çš„ç½‘ç«™æˆ–è€…ä¿¡æ¯ç­‰ç­‰ã€‚Nginxå°±å¯ä»¥ä½œä¸ºæ­£å‘ä»£ç†æœåŠ¡ã€‚</p><hr><p>5ï¼‰åå‘ä»£ç†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200205132805413.png" srcset="/img/loading.gif" alt="image-20200205132805413"></p><p>å®¢æˆ·ç«¯å¾€å¾€å»è¯·æ±‚ç½‘ç«™çš„æ—¶å€™ï¼Œé‚£ä¹ˆä½ ä¸çŸ¥é“å®ƒåç«¯æœ‰å¤šå°‘ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆè¯·æ±‚çš„å¾€å¾€æ˜¯ä¸€ä¸ªä»£ç†ï¼Œè¿™ä¸ªä»£ç†ä¼šå‘ç»™å¯¹åº”çš„æœåŠ¡å™¨ï¼Œè¿™ä¸ªæœåŠ¡å™¨å†è¿”å›ç»™å®¢æˆ·ç«¯</p><hr><p>6ï¼‰ä»£ç†åŒºåˆ«</p><p>æ­£å‘ä»£ç†å’Œåå‘ä»£ç†çš„åŒºåˆ«ï¼š</p><ol><li>åŒºåˆ«åœ¨äºä»£ç†çš„å¯¹è±¡ä¸ä¸€æ ·ï¼›</li><li>æ­£æƒ³ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯å®¢æˆ·ç«¯ï¼šæ¯”å¦‚è¯´æˆ‘ä»¬æƒ³å»è¿”å›Googleï¼Œæˆ‘ä»¬è¦æŠŠä»£ç†æœåŠ¡å™¨è®¾åˆ°ä»£ç†æœåŠ¡å™¨åœ°å€ï¼Œä¹‹åå°±èƒ½è®¿é—®äº†ï¼Œè¯´ç™½æ­£å‘ä»£ç†æ˜¯ä¸ºå®¢æˆ·ç«¯æœåŠ¡çš„ï¼›</li><li>åå‘ä»£ç†ä»£ç†çš„å¯¹è±¡æ˜¯æœåŠ¡ç«¯ï¼šæ˜¯ä¸ºæœåŠ¡ç«¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒæœåŠ¡ç«¯æ˜¯å“ªä¸ªæœåŠ¡å™¨ï¼Œæˆ‘ä»¬è¦è¯·æ±‚çš„å…·ä½“æ˜¯å“ªä¸ªæœåŠ¡å™¨ï¼›åå‘ä»£ç†å°±æ”¾åœ¨æœåŠ¡ç«¯ï¼Œå®ƒä¼šå»å¸®æˆ‘ä»¬å»å¤„ç†è¯·æ±‚ã€‚</li></ol><h2 id="åå‘ä»£ç†"><a href="#åå‘ä»£ç†" class="headerlink" title="åå‘ä»£ç†"></a>åå‘ä»£ç†</h2><h3 id="é…ç½®è¯­æ³•-1"><a href="#é…ç½®è¯­æ³•-1" class="headerlink" title="é…ç½®è¯­æ³•"></a>é…ç½®è¯­æ³•</h3><p>Syntax:    proxy_pass URL;<br>Default:    â€”<br>Context:    location, if in location,limit_except</p><p><a href="http://www.nginx.cn/doc/standard/httpproxy.html" target="_blank" rel="noopener">æ–‡æ¡£åœ°å€</a></p><h3 id="æ¼”ç¤º-2"><a href="#æ¼”ç¤º-2" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h3><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;                <span class="hljs-attribute">proxy_pass</span> https://www.baidu.com;&#125;</code></pre><h2 id="æ­£å‘ä»£ç†"><a href="#æ­£å‘ä»£ç†" class="headerlink" title="æ­£å‘ä»£ç†"></a>æ­£å‘ä»£ç†</h2><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;      <span class="hljs-attribute">resolver</span> <span class="hljs-number">192.168.1.1</span>; <span class="hljs-comment">#æŒ‡å®šDNSæœåŠ¡å™¨IPåœ°å€  </span>    <span class="hljs-attribute">listen</span> <span class="hljs-number">8080</span>;      <span class="hljs-attribute">location</span> / &#123;          <span class="hljs-attribute">proxy_pass</span> http://<span class="hljs-variable">$http_host</span><span class="hljs-variable">$request_uri</span>; <span class="hljs-comment">#è®¾å®šä»£ç†æœåŠ¡å™¨çš„åè®®å’Œåœ°å€  </span>    &#125;  &#125;</code></pre><h2 id="é…ç½®è¯­æ³•è¡¥å……"><a href="#é…ç½®è¯­æ³•è¡¥å……" class="headerlink" title="é…ç½®è¯­æ³•è¡¥å……"></a>é…ç½®è¯­æ³•è¡¥å……</h2><p>ä»£ç†æ¨¡å—ä¸­æä¾›äº†å¾ˆå¤šçš„é…ç½®é¡¹ï¼Œè¯¦æƒ…è¯·å‚è€ƒ<a href="http://www.nginx.cn/doc/standard/httpproxy.html" target="_blank" rel="noopener">æ–‡æ¡£</a></p><h3 id="ç¼“å†²åŒº"><a href="#ç¼“å†²åŒº" class="headerlink" title="ç¼“å†²åŒº"></a>ç¼“å†²åŒº</h3><p>Syntax:    proxy_buffering on | off;<br>Default:<br>proxy_buffering on;<br>Context:    http, server, location</p><blockquote><p>NginxæœåŠ¡ä¸­å»è½¬å‘è¯·æ±‚çš„æ—¶å€™ï¼Œå¾€å¾€ä¼šæ¥å—åˆ°ä¸€éƒ¨åˆ†çš„æ˜¯å¤´ä¿¡æ¯ï¼ŒNginxå¦‚æœæŠŠä»¥ä¸Šé…ç½®é¡¹æ‰“å¼€ï¼Œé‚£ä¹ˆå®ƒå°†å°½å¯èƒ½çš„æŠŠæ‰€æœ‰è¯·æ±‚çš„ä¿¡æ¯æ”¶é›†å®Œï¼Œç„¶åå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªèµ·åˆ°äº†ä¸€ä¸ªç¼“å†²åŒºçš„æ¦‚å¿µï¼Œå®ƒå‡å°‘IOæŸè€—ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿæœ‰ä¸€äº›é—®é¢˜çš„ï¼Œä¾‹å¦‚ï¼šè¿™ä¸ªæ‰“å¼€çš„è¯é»˜è®¤æ˜¯å­˜åœ¨å†…å­˜é‡Œé¢çš„ï¼Œå½“å†…å­˜ä¸å¤Ÿçš„æƒ…å†µä¸‹å®ƒå¯èƒ½ä¼šå­˜åœ¨ç¡¬ç›˜çš„ä¸´æ—¶ç›®å½•ä¸­ï¼Œè¿™é‡Œ<code>proxy_buffer_sizeã€proxy_buffersã€proxy_busy_buffers_size</code>å‚æ•°æ˜¯ç”¨æ¥æ§åˆ¶çš„ã€‚</p></blockquote><h3 id="è·³è½¬é‡å®šå‘"><a href="#è·³è½¬é‡å®šå‘" class="headerlink" title="è·³è½¬é‡å®šå‘"></a>è·³è½¬é‡å®šå‘</h3><p>Syntax:    proxy_redirect default;<br>proxy_redirect off;<br>proxy_redirect redirect replacement;<br>Default:    proxy_redirect default;<br>Context:    http, server, location</p><blockquote><p>å½“æˆ‘ä»¬ç”¨Nginxä½œä¸ºä»£ç†æœåŠ¡å™¨å»ä»£ç†åç«¯æœåŠ¡è¿”å›æ˜¯ä¸€ä¸ª301çš„é‡å®šå‘åœ°å€çš„æ—¶å€™ï¼Œè¿™é‡Œçš„ http 301æ˜¯ä¸€ä¸ªé‡å®šå‘ï¼Œå®ƒä¼šæŠŠæˆ‘ä»¬è¯·æ±‚é‡å®šå‘åˆ°å¦å¤–çš„åœ°å€é‡Œé¢è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥å¦‚æœæ˜¯è¿™ç§åœºæ™¯ä¸‹é¢ç”¨ä¸€åˆ°è¿™ä¸ªé…ç½®é¡¹èµ·åˆ°ä¸€ä¸ªä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿå½“åç«¯è¿”å›è¿™ä¸ª301åœ°å€æ˜¯æˆ‘ä»¬å‰ç«¯æ‰€æ— æ³•è®¿é—®åˆ°çš„æˆ–è€…æ˜¯è¯´éœ€è¦ç”¨åˆ°Nginxæ¥æŠŠæœåŠ¡ç«¯è¿”å›ç»™å®¢æˆ·ç«¯301è¿™ä¸ªåœ°å€éœ€è¦åšé‡å†™çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ç”¨åˆ°äº†è¿™ä¸ªé…ç½®é¡¹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬åªè¦æŠŠå®ƒé…ç½®æˆé»˜è®¤çš„å°±å¯ä»¥ä¸ä¼šæœ‰å¤ªå¤§çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨ä¸€äº›ç‰¹æ®Šåœºæ™¯é‡Œé¢ä¹Ÿä¼šå»ä½¿ç”¨å®ƒã€‚</p></blockquote><h3 id="å¤´ä¿¡æ¯"><a href="#å¤´ä¿¡æ¯" class="headerlink" title="å¤´ä¿¡æ¯"></a>å¤´ä¿¡æ¯</h3><p>Syntax:    proxy_set_header field value;<br>Default:    proxy_set_header Host $proxy_host;<br>proxy_set_header Connection close;<br>Context:    http, server, location</p><blockquote><p>å¤´ä¿¡æ¯é…ç½®ç”¨çš„æ¯”è¾ƒå¤šï¼Œå¸¸è§æ˜¯åœ¨æŠŠNginxä½œä¸ºä»£ç†æœåŠ¡å™¨ä½†æ˜¯åç«¯æ˜¯éœ€è¦è¯»å–ä¸€äº›å¤´ä¿¡æ¯ï¼Œè¿™äº›å¤´ä¿¡æ¯æ˜¯ä¸å‡†ç¡®çš„ï¼Œåœ¨Nginxä½œä¸ºè®¿é—®æ§åˆ¶é‡Œé¢å®ƒçš„remote addressè¿™ä¸ªä¿¡æ¯å°±åœ¨åç«¯çš„æœåŠ¡å™¨é‡Œé¢å› ä¸ºèµ°äº†ä»£ç†ï¼Œæ‰€ä»¥åç«¯å°±æ²¡æ³•è¯»å–å¯¹åº”çš„æ¶ˆæ¯äº†ã€‚è¿™é‡Œå¯ä»¥ä½¿ç”¨<code>proxy_set_header</code>ï¼Œè¿™ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯è¯´å‘ç»™åç«¯æœåŠ¡å™¨é‡Œé¢ä¼šå¢åŠ ä¸€ä¸ªå¯¹åº”çš„å¤´ï¼ŒæŠŠå¯¹åº”çš„ä¿¡æ¯ç”¨æ–°çš„å¤´æºå¸¦åˆ°åç«¯è®©åç«¯èƒ½è¯»å–åˆ°ã€‚</p><p>æ‰©å±•ï¼š</p><ul><li>proxy_hide_headerï¼šéšè—å¤´ä¸ç»™åç«¯è®¿é—®åˆ°ï¼Œåº”ç”¨åœ¨ä¸€äº›éœ€è¦ä¿¡æ¯éšè—å®‰å…¨æ€§çš„è€ƒè™‘ï¼›</li><li>proxy_set_bodyï¼šåœ¨bodyä¸­å¡«åŠ å­—ç¬¦ä¸²</li></ul></blockquote><h3 id="è¶…æ—¶"><a href="#è¶…æ—¶" class="headerlink" title="è¶…æ—¶"></a>è¶…æ—¶</h3><p>Syntax:    proxy_cookie_domain off;<br>proxy_cookie_domain domain replacement;<br>Default:    proxy_cookie_domain off;<br>Context:    http, server, location</p><blockquote><p>TCPè¯·æ±‚çš„è¿æ¥è¶…æ—¶ã€‚å½“TCPè¯·æ±‚è¿æ¥è¶…æ—¶ï¼Œå½“å»ºç«‹å®Œè¿æ¥ä»¥åå°±æœ‰å¦å¤–çš„è¶…æ—¶ï¼š</p><ul><li>prxy_read_timeoutï¼šå·²ç»å»ºç«‹åè¿æ¥çš„æ—¶å€™ï¼Œåœ¨Nginxåœ¨ä¸ºä»£ç†å’Œåç«¯çš„æœåŠ¡è®©å®ƒä¼šç­‰å¾…å¤šé•¿æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´å°±è®¤ä¸ºæ˜¯è¶…æ—¶çš„</li><li>proxy_send_timeï¼šæœåŠ¡ç«¯è¯·æ±‚å®Œäº†å†å‘é€ç»™å®¢æˆ·ç«¯å‘é€ç»™å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´</li></ul></blockquote><h2 id="é…ç½®è§„èŒƒ"><a href="#é…ç½®è§„èŒƒ" class="headerlink" title="é…ç½®è§„èŒƒ"></a>é…ç½®è§„èŒƒ</h2><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;                <span class="hljs-attribute">proxy_pass</span>  http://mcr.free.idcfengye.com;                <span class="hljs-attribute">proxy_redirect</span> default;                <span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$http_host</span>;                <span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;                  <span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">30</span>;                <span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">60</span>;                <span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">60</span>;                <span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">32k</span>;                <span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">on</span>;                <span class="hljs-attribute">proxy_buffers</span> <span class="hljs-number">4</span> <span class="hljs-number">128k</span>;                <span class="hljs-attribute">proxy_busy_buffers_size</span> <span class="hljs-number">256k</span>;                <span class="hljs-attribute">proxy_max_temp_file_size</span> <span class="hljs-number">256k</span>;        &#125;</code></pre><ul><li>proxy_redirectï¼šé€šå¸¸ä½¿ç”¨é»˜è®¤çš„ã€‚åœ¨åç«¯è¿”å›301ä¿¡æ¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦åšå¯¹åº”çš„æ”¹å†™çš„æ—¶å€™éœ€è¦ç”¨åˆ°å®ƒæ¥å¯¹åç«¯è¿”å›çš„ä¿¡æ¯åšè°ƒè¯•ï¼›</li><li>proxy_set_headerï¼šæŠŠNginxä»£ç†å¾€åç«¯æœåŠ¡çš„å‘é€è¯·æ±‚çš„æ—¶å€™æ·»åŠ çš„å¤´ä¿¡æ¯ï¼Œä¸€èˆ¬ä¼šåŠ ä¸Š<code>Host</code>å’Œ<code>X-Real-IP</code>ï¼Œè¿™é‡Œæ·»åŠ X-Real-IPçš„æ„ä¹‰ï¼šåç«¯é€šè¿‡ä»£ç†çš„æ–¹å¼æ˜¯æ— æ³•è·å–çœŸå®çš„ç”¨æˆ·IPçš„ï¼Œå¾€å¾€åšç”¨æˆ·è®¿é—®é™åˆ¶ã€IPçš„ä¸€äº›åŠŸèƒ½å®šä½å°±éœ€è¦è·å–ç”¨æˆ·çš„IPä¿¡æ¯ï¼Œè¿™é‡Œå°±éœ€è¦ä½¿ç”¨å®ƒäº†ï¼›</li><li>proxy_connect_timeoutï¼šTCPè¶…æ—¶æ—¶é—´ï¼›</li><li>proxy_buffer_sizeï¼šNginxä½œä¸ºç¼“å†²åŒºçš„è¯»å–å¤´ä¿¡æ¯çš„å¤§å°ï¼Œä¸€èˆ¬ä¸ä¼šç‰¹åˆ«å¤§ï¼›</li><li>proxy_bufferingï¼šæ‰“å¼€ï¼Œè¿™ä¸ªæ—¶å€™Nginxä¼šå°½å¯èƒ½çš„å»ç¼“å†²åŒºé‡Œé¢ç­‰å¾…è¯»å–åç«¯å“åº”çš„ä¿¡æ¯å“åº”ç»™å‰ç«¯ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯èƒ½å‡å°‘æœåŠ¡å™¨çš„IOï¼›</li><li>proxy_buffersï¼šä¸Šé¢è¿™ä¸ªé…ç½®æ‰“å¼€äº†ï¼Œå°±è¦è®¾ç½®å¯¹åº”çš„å¤§å°ï¼Œå› ä¸ºbufferæ˜¯æ”¾åœ¨å†…å­˜é‡Œé¢çš„ï¼›</li><li>proxy_max_temp_file_sizeï¼š<code>proxy_buffers</code>å’Œ<code>proxy_max_temp_file_size</code>ç”¨å¾—å·®ä¸å¤šçš„æ—¶å€™ï¼Œå°±ä¼šå­˜åœ¨ä¸´æ—¶æ–‡ä»¶é‡Œé¢å»ï¼Œè¿™é‡Œæ˜¯ç»™ä¸´æ—¶æ–‡ä»¶é™åˆ¶çš„å¤§å°</li></ul><hr><p>ä»¥ä¸Šçš„é…ç½®é¡¹ç‰¹åˆ«çš„å¤šï¼Œåœ¨ä¼ä¸šä¸­ä¼šç»å¸¸ä½¿ç”¨å®ƒï¼Œè¿™é‡Œå¯ä»¥å°†å®ƒæ”¾åœ¨ä¸€ä¸ªé€šç”¨çš„æ–‡ä»¶é‡Œé¢</p><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;                <span class="hljs-attribute">proxy_pass</span>  http://mcr.free.idcfengye.com;  <span class="hljs-attribute">include</span>proxy_params;&#125;</code></pre><p>åœ¨/etc/nginxä¸­åˆ›å»ºä¸€ä¸ª<code>proxy_params</code>æ–‡ä»¶ï¼Œå†…å®¹ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">proxy_redirect</span> default;<span class="hljs-attribute">proxy_set_header</span> Host <span class="hljs-variable">$http_host</span>;<span class="hljs-attribute">proxy_set_header</span> X-Real-IP <span class="hljs-variable">$remote_addr</span>;<span class="hljs-attribute">proxy_connect_timeout</span> <span class="hljs-number">30</span>;<span class="hljs-attribute">proxy_send_timeout</span> <span class="hljs-number">60</span>;<span class="hljs-attribute">proxy_read_timeout</span> <span class="hljs-number">60</span>;<span class="hljs-attribute">proxy_buffer_size</span> <span class="hljs-number">32k</span>;<span class="hljs-attribute">proxy_buffering</span> <span class="hljs-literal">on</span>;<span class="hljs-attribute">proxy_buffers</span> <span class="hljs-number">4</span> <span class="hljs-number">128k</span>;<span class="hljs-attribute">proxy_busy_buffers_size</span> <span class="hljs-number">256k</span>;<span class="hljs-attribute">proxy_max_temp_file_size</span> <span class="hljs-number">256k</span>;</code></pre><h1 id="Nginxä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡"><a href="#Nginxä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡" class="headerlink" title="Nginxä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡"></a>Nginxä½œä¸ºè´Ÿè½½å‡è¡¡æœåŠ¡</h1><h2 id="ä»‹ç»-3"><a href="#ä»‹ç»-3" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>1ï¼‰ä¸ºä»€ä¹ˆéœ€è¦è´Ÿè½½å‡è¡¡æœåŠ¡</p><p>å†åŸå§‹çš„éƒ¨ç½²æ¨¡å‹å¾€å¾€é€‰æ‹©æœ€ç®€å•çš„éƒ¨ç½²æ¨¡å‹ï¼šç‚¹å¯¹ç‚¹æœåŠ¡ï¼Œéšç€ä¼ä¸šçš„ä¸šåŠ¡å¢é•¿ä»¥åŠå®¢æˆ·å¸¦æ¥çš„æµ·é‡è¯·æ±‚ï¼Œç»™æˆ‘ä»¬æœåŠ¡ç«¯é€ æˆäº†æµ·é‡çš„å¹¶å‘å¯¼è‡´æœåŠ¡å“åº”ä¸èƒ½åŠæ—¶ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦ä¸æ–­æ‰©å®¹æˆ‘ä»¬çš„åç«¯æœåŠ¡ï¼Œæ‰©å®¹åç«¯æœåŠ¡å¯¹äºæˆ‘ä»¬å‰ç«¯å°±éœ€è¦æœ‰ä¸€ä¸ªè´Ÿè½½å‡è¡¡æ¥å‡åˆ†è¯·æ±‚æ¥æå‡åç«¯ååé‡ï¼Œå¯¹äºè¯·æ±‚è€Œè¨€ï¼Œè´Ÿè½½å‡è¡¡å°±èƒ½å¾ˆå¥½çš„å‡æ‘Šè¯·æ±‚ã€‚</p><p>å¯¹äºä¸€ä¸ªç‚¹çš„æœåŠ¡ï¼Œå¦‚æœæœåŠ¡æŒ‚æ‰äº†é‚£ä¹ˆæ•´ä½“æœåŠ¡å°±æŒ‚æ‰äº†ï¼Œä½†æ˜¯æœ‰äº†è´Ÿè½½å‡è¡¡æœåŠ¡æˆ‘ä»¬å³ä½¿ä¸€ä¸ªç‚¹æŒ‚äº†å…¶ä»–çš„ç‚¹è¿˜å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œè¿™é‡ŒæŒ‚æ‰çš„ç‚¹æŠŠå®ƒå‰”é™¤å°±å¯ä»¥äº†ï¼Œè¿™æ ·çš„éƒ¨ç½²æ–¹å¼å¯ä»¥è®©åç«¯æœåŠ¡å¾ˆå¥½çš„å®ç°é«˜å¯ç”¨ã€‚</p><hr><p>2ï¼‰GSLB</p><p>è¯´åˆ°è´Ÿè½½å‡è¡¡è¿™é‡ŒæŒ‰ç…§èŒƒå›´åˆ†ä¸ºä¸€ä¸ªç±»ï¼šGSLBä¸SLB</p><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200209165634931.png" srcset="/img/loading.gif" alt="image-20200209165634931"></p><p>GSLBæ˜¯æŒ‰ç…§å½±å“èŒƒå›´æ¥å®šçš„ï¼ŒGSLBæ˜¯ä¸€ä¸ªå…¨å±€è´Ÿè½½å‡è¡¡ï¼Œå®ƒçš„èŠ‚ç‚¹æ¯”è¾ƒåºå¤§ï¼Œåœ°åŸŸèŒƒå›´éå¸¸å¹¿ï¼Œå¾€å¾€æŒ‰ç…§å›½å®¶ã€çœä¸ºå•ä½æ¥è¿›è¡Œå…¨å±€è´Ÿè½½å‡è¡¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚å¼ ä¸‰è¿™ä¸ªç”¨æˆ·åœ¨åŒ—äº¬ï¼Œå®ƒä¸å¯èƒ½éƒ½å»è¯·æ±‚<code>åº”ç”¨æœåŠ¡ä¸­å¿ƒèŠ‚ç‚¹</code>ï¼Œå®ƒå…ˆå»è¯·æ±‚è°ƒåº¦èŠ‚ç‚¹ï¼Œè°ƒåº¦èŠ‚ç‚¹è¿”å›ç»™å¼ ä¸‰å¯¹åº”çš„åœ°å€ï¼Œå¼ ä¸‰è¯·æ±‚å¯¹åº”çš„åº”ç”¨æœåŠ¡ï¼Œè¿™é‡Œçš„åº”ç”¨æœåŠ¡ä¹Ÿå°±é›†ä¸­åœ¨åŒ—äº¬ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªè¾¹ç¼˜çš„åº”ç”¨æœåŠ¡èŠ‚ç‚¹ï¼Œè€Œæ²¡æœ‰å»è¯·æ±‚è¿™ä¸ª<code>åº”ç”¨æœåŠ¡ä¸­å¿ƒèŠ‚ç‚¹</code>ï¼Œè¿™æ ·çš„è¯å¼ ä¸‰æ—¢æ»¡è¶³äº†è®¿é—®è¯·æ±‚ä¹Ÿæ²¡æœ‰ç»™æœåŠ¡ç«¯é€ æˆäº†å¾ˆå¤§çš„å‹åŠ›ã€‚</p><p>å¦å¤–ä¸€ä¸ªæ–°ç–†çš„ç”¨æˆ·ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå®ƒåªè®¿é—®å¯¹åº”çš„åº”ç”¨æœåŠ¡ï¼Œé€šè¿‡è°ƒåº¦çš„èŠ‚ç‚¹æ¥å®ç°æ•´ä½“çš„è´Ÿè½½å‡è¡¡ï¼Œè°ƒåº¦èŠ‚ç‚¹åˆä¼šæœ‰æ•´ä½“çš„è°ƒåº¦èŠ‚ç‚¹è¿›è¡Œæ§åˆ¶ï¼Œæ‰€ä»¥å…¨å±€çš„è´Ÿè½½å‡è¡¡æœ‰äº†è¿™2å¥—ä¸­å¿ƒçš„èŠ‚ç‚¹ï¼ŒåŠ ä¸Šè¾¹ç¼˜çš„è°ƒåº¦èŠ‚ç‚¹å’Œåº”ç”¨æœåŠ¡èŠ‚ç‚¹å°±èƒ½å®Œæˆä¸€ä¸ª<code>GSLBå…¨å±€è´Ÿè½½å‡è¡¡</code>çš„å®ç°</p><hr><p>3ï¼‰SLB</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200209171100105.png" srcset="/img/loading.gif" alt="image-20200209171100105"></p><p>å¾€å¾€æ¥è§¦æœ€å¤šçš„æ˜¯<code>SLB</code>ï¼ŒSLBåœ¨åœ°åŸŸé‡Œé¢åŒºåˆ†æˆ–è€…é€»è¾‘å•å…ƒåŒºåˆ†å®ƒæ˜¯éå¸¸å°çš„ï¼Œå¾€å¾€è¿™ä¸ªè°ƒåº¦èŠ‚ç‚¹å’Œå®ƒçš„æœåŠ¡èŠ‚ç‚¹åœ¨ä¸€ä¸ªé€»è¾‘å•å…ƒé‡Œé¢æˆ–è€…æ˜¯è¯´åœ¨ä¸€ä¸ªåœ°åŸŸé‡Œé¢ï¼Œé‚£ä¹ˆå®ƒçš„å°çš„é€»è¾‘åœ°åŸŸå†³å®šå®ƒå¯¹éƒ¨åˆ†æœåŠ¡çš„å®æ—¶æ€§ã€å“åº”æ€§æ˜¯éå¸¸å¥½çš„ï¼›åœ¨æµ·é‡ç”¨æˆ·çš„è¯·æ±‚è¿‡æ¥ä»¥åå®ƒåŒæ ·æ˜¯è¯·æ±‚è°ƒåº¦èŠ‚ç‚¹ï¼Œè°ƒåº¦èŠ‚ç‚¹æŠŠå®ƒçš„è¯·æ±‚è½¬å‘ç»™åç«¯å¯¹åº”çš„æœåŠ¡èŠ‚ç‚¹ï¼ŒæœåŠ¡èŠ‚ç‚¹å†è½¬å‘ç»™è°ƒåº¦èŠ‚ç‚¹ï¼Œè°ƒåº¦èŠ‚ç‚¹å†å“åº”ç»™å®¢æˆ·ï¼Œè¿™æ ·ä¹Ÿèƒ½å®ç°ä¸€ä¸ªå‡è¡¡çš„ä½œç”¨ï¼ŒNginxå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„<code>SLB</code></p><p>4ï¼‰åˆ†ä¸ºå››å±‚è´Ÿè½½å‡è¡¡å’Œä¸ƒå±‚è´Ÿè½½å‡è¡¡</p><p>å¾€å¾€ä¼ä¸šä¹Ÿä¸å¥½ç”¨åˆ°<code>GSLB</code>è€Œä¼šç”¨åˆ°ä¸€äº›äº‘æœåŠ¡æˆ–è€…ç¬¬ä¸‰æ–¹è®¾å¤‡ï¼Œä½†æ˜¯å¯¹äº<code>SLB</code> æ¥è¯´æˆ‘ä»¬ä¼šéœ€è¦ç”¨åˆ°ã€‚</p><p>å¯¹äºè´Ÿè½½å‡è¡¡é™¤äº†åœ°åŸŸåˆ’åˆ†ä»¥å¤–è¿˜å¯ä»¥æŒ‰ç…§ç½‘ç»œçš„æ¨¡å‹ä¹Ÿå°±æ˜¯<code>OSI</code>æ¨¡å‹å¯ä»¥åˆ†ä¸ºå¸¸ç”¨çš„2ä¸ªæ¦‚å¿µè´Ÿè½½å‡è¡¡ï¼Œä¸€ä¸ªæ˜¯æˆ‘ä»¬å¸¸è§çš„4å±‚è´Ÿè½½å‡è¡¡ï¼Œæ‰€è°“4å±‚è´Ÿè½½å‡è¡¡å°±æ˜¯åœ¨<code>OSI</code>æ¨¡å‹é‡Œé¢çš„ä¼ è¾“å±‚ï¼Œä¼ è¾“å±‚å·²ç»èƒ½æ”¯æŒåˆ°TCP IPåè®®çš„æ§åˆ¶çš„ï¼Œæ‰€ä»¥å®ƒåªéœ€è¦å¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚TCP IPåè®®çš„åŒ…è½¬å‘ï¼Œå°±å¯ä»¥å®ç°è´Ÿè½½å‡è¡¡ï¼Œå®ƒçš„å¥½å¤„æ˜¯æ€§èƒ½éå¸¸å¿«åªéœ€è¦æœ€é¡¶å±‚è¿›è¡Œè¿ç”¨å¤„ç†ï¼Œè€Œä¸éœ€è¦è¿›è¡Œä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œåªéœ€è¦è¿›è¡ŒåŒ…çš„è½¬å‘å°±å¯ä»¥äº†ã€‚</p><p>å¯¹åº”çš„å°±æ˜¯7å±‚è´Ÿè½½å‡è¡¡ï¼Œå®ƒæ˜¯åœ¨åº”ç”¨å±‚ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å®Œæˆåº”ç”¨æ–¹é¢çš„åè®®çš„è¯·æ±‚ï¼Œæ¯”å¦‚è¯´httpçš„è´Ÿè½½å‡è¡¡å®ƒå¯ä»¥å®ç°httpä¿¡æ¯çš„æ”¹å†™ã€å¤´ä¿¡æ¯çš„æ”¹å†™ã€å®‰å…¨åº”ç”¨è§„åˆ™çš„æ§åˆ¶ä»¥åŠè½¬å‘Layerç­‰è§„åˆ™ï¼Œ æ‰€ä»¥åœ¨åº”ç”¨å±‚çš„æœåŠ¡é‡Œé¢æˆ‘ä»¬å¯ä»¥åœ¨é‡Œé¢åšçš„å†…å®¹å°±æ›´å¤šã€‚Nginxå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„7å±‚è´Ÿè½½å‡è¡¡çš„SLB</p><hr><p>5ï¼‰Nginxè´Ÿè½½å‡è¡¡</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/asdfzxc-1581257182079.png" srcset="/img/loading.gif" alt="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/asdfzxc.png"></p><p>Nginxåœ¨å®ç°è´Ÿè½½å‡è¡¡åŸç†å°±æ˜¯ç”¨åˆ°äº†<code>proxy_pass</code>ï¼Œproxy_passå°±æ˜¯ä¸Šä¸€ç« è®²è¿‡çš„ä»£ç†æ¨¡å—çš„å’Œæ ¸å¿ƒé…ç½®ï¼Œå®ƒæŠŠæ‰€æœ‰è¯·æ±‚ä»£ç†è½¬å‘åˆ°å¯¹åº”åç«¯æœåŠ¡å™¨ä¸Šï¼Œåªè¿™é‡Œå®ç°è´Ÿè½½å‡è¡¡æ˜¯å®ƒä¸æ˜¯è½¬å‘åˆ°ä¸€å°è€Œæ˜¯ä¸€ç»„è™šæ‹Ÿçš„æœåŠ¡æ± ï¼Œå®ƒç§°ä¸º<code>upstream server</code>ï¼Œ<code>upstream server</code>å¯ä»¥å®šä¹‰å®ƒæ‰€æœ‰çš„æœåŠ¡å™¨çš„å•å…ƒï¼Œæ¯”å¦‚è¿™ä¸ª<code>upstream server</code>ç»„é‡Œé¢æœ‰æœåŠ¡1ã€2ã€3ï¼Œå®ƒä»¬3ä¸ªéƒ½å¯ä»¥æä¾›ç±»ä¼¼çš„æœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å®ƒä»¬æ”¾åˆ°ä¸€ä¸ªè™šæ‹Ÿçš„<code>upstream server</code>ç»„é‡Œé¢æ¥ï¼Œåœ¨è¿™ä¸ª<code>upstream server</code>ç»„é‡Œé¢å®ƒå®ç°äº†å¯¹äº3å°æœåŠ¡å™¨ä¸æ–­çš„è½®è¯¢ï¼Œè¿™æ ·æ‰€æœ‰ç”¨æˆ·è¿‡æ¥è¯·æ±‚çš„æ—¶å€™å°±ä¼šé€šè¿‡<code>upstream</code>æ¨¡å—åˆ†å‘åˆ°ä¸åŒçš„æœåŠ¡ä¸Šå®ç°è´Ÿè½½å‡è¡¡è¿™æ ·çš„ä¸€ä¸ªæ¦‚å¿µï¼Œæ‰€ä»¥åœ¨proxy_passå’Œupstreamæ˜¯2ä¸ªæ ¸å¿ƒçš„é…ç½®è¯­æ³•</p><hr><p>6ï¼‰é…ç½®è¯­æ³•</p><p>Syntax: upstream name {â€¦}<br>Default:â€”<br>Contextï¼šhttp</p><p><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener">å‚è€ƒæ–‡æ¡£</a></p><h2 id="æ¼”ç¤º-è´Ÿè½½å‡è¡¡"><a href="#æ¼”ç¤º-è´Ÿè½½å‡è¡¡" class="headerlink" title="æ¼”ç¤º-è´Ÿè½½å‡è¡¡"></a>æ¼”ç¤º-è´Ÿè½½å‡è¡¡</h2><p>é¦–å…ˆé€šè¿‡Nginxå‡†å¤‡3ä¸ªæœåŠ¡ï¼Œç«¯å£åˆ†åˆ«æ˜¯ï¼š<code>8001ã€8003ã€8004</code>ï¼Œåœ¨opt/appç›®å½•ä¸­å¯¹åº”äº†<code>code1ã€code2ã€code3</code>ç›®å½•ï¼Œæ¯ä¸ªç›®å½•éƒ½æœ‰ä¸€ä¸ª<code>index.html</code>ï¼Œå†…å®¹åˆ†åˆ«æ˜¯<code>code1ã€code2ã€code3</code>ï¼›åœ¨å®ƒä»¬çš„é…ç½®æ”¾åœ¨<code>/etc/nginx/conf.d</code>ç›®å½•ä¸­</p><pre><code class="hljs bash">/etc/nginx/conf.d &gt; lsserver1.conf  server2.conf  server3.conf</code></pre><p><strong>é…ç½®å†…å®¹ï¼š</strong></p><p>server1.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">8001</span>;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">root</span>        /opt/app/code1;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">index</span> index.html;    &#125;&#125;</code></pre><p>server2.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">8003</span>;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">root</span>        /opt/app/code2;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">index</span> index.html;    &#125;&#125;</code></pre><p>server3.conf</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">8004</span>;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">root</span>        /opt/app/code3;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">index</span> index.html;    &#125;&#125;</code></pre><p>upstream_test.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span>;&#125;<span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> ;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">access_log</span>  /var/log/nginx/test_proxy.access.log  main;    <span class="hljs-attribute">location</span> / &#123;    <span class="hljs-comment">#è¿™é‡Œçš„http://mcrçš„mcræ˜¯ä¸Šé¢çš„upstreamçš„key</span>        <span class="hljs-attribute">proxy_pass</span>  http://mcr;        <span class="hljs-attribute">include</span> proxy_params;    &#125;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode2~&gt; curl  http://localhostcode1~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode1</code></pre><h2 id="ä»‹ç»-serverå‚æ•°"><a href="#ä»‹ç»-serverå‚æ•°" class="headerlink" title="ä»‹ç»-serverå‚æ•°"></a>ä»‹ç»-serverå‚æ•°</h2><p>å‰é¢çš„è´Ÿè½½å‡è¡¡é€šåˆ°è¿‡<code>upstream</code>ï¼Œå®ƒè¿˜æœ‰ä¸€äº›é…ç½®é¡¹ï¼Œåœ¨è¿™ä¸ªç« èŠ‚ä¸­è¯´æ˜ã€‚</p><p>1ï¼‰ã€upstreamä¸¾ä¾‹</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">server</span> backend1.example.com weight=<span class="hljs-number">5</span>;    <span class="hljs-attribute">server</span> backend2.example.com:<span class="hljs-number">8080</span>;    <span class="hljs-attribute">server</span> unix:/temp/backend3;    <span class="hljs-attribute">server</span> backend1.example.com:<span class="hljs-number">8080</span> backup;    <span class="hljs-attribute">server</span> backend2.example.com:<span class="hljs-number">8080</span> backup;&#125;</code></pre><ul><li>weightï¼šæƒé‡ï¼Œå¯¹äºè½®è¯¢è€Œè¨€åŠ å…¥è¿™ä¸ªè¯çš„å€¼è¶Šå¤§é‚£ä¹ˆå½±å“å®ƒçš„æƒé‡å°±è¶Šå¤§ï¼Œåˆ†é…ä¸ªå®ƒçš„å‡ ç‡å°±è¶Šé«˜ï¼›</li><li>backupï¼šå¤‡ä»½æœåŠ¡</li></ul><hr><p>2ï¼‰ã€åç«¯æœåŠ¡å™¨åœ¨è´Ÿè½½å‡è¡¡è°ƒåº¦ä¸­çš„çŠ¶æ€</p><table><thead><tr><th>è¯</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>down</td><td>å½“å‰çš„serveræš‚æ—¶ä¸å‚ä¸è´Ÿè½½å‡è¡¡</td></tr><tr><td>backup</td><td>é¢„ç•™çš„å¤‡ä»½æœåŠ¡</td></tr><tr><td>max_fails</td><td>å…è®¸è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°</td></tr><tr><td>fail_timeout</td><td>ç»è¿‡max_failså¤±è´¥åï¼ŒæœåŠ¡æš‚åœçš„æ—¶é—´</td></tr><tr><td>max_conns</td><td>é™åˆ¶æœ€å¤§çš„æ¥æ”¶çš„è¿æ¥æ•°</td></tr></tbody></table><h2 id="æ¼”ç¤º-backupçŠ¶æ€"><a href="#æ¼”ç¤º-backupçŠ¶æ€" class="headerlink" title="æ¼”ç¤º-backupçŠ¶æ€"></a>æ¼”ç¤º-backupçŠ¶æ€</h2><p>è¿™é‡Œåœ¨ä¸Šä¸€æ¬¡æ¼”ç¤ºçš„<code>upstream_test.conf</code>æ–‡ä»¶ä¸­åŠ å…¥è¿™äº›å‚æ•°,è¿™é‡Œåˆ—å‡ºäº†ä¿®æ”¹éƒ¨åˆ†ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span> down; <span class="hljs-comment">#ä¸æä¾›æœåŠ¡</span>    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span> backup; <span class="hljs-comment">#å¤‡ä»½èŠ‚ç‚¹</span>    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span> max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">10s</span>; <span class="hljs-comment">#å¤±è´¥æ¬¡æ•°ï¼š1æ¬¡ï¼Œè¶…æ—¶æ—¶é—´ï¼š10ç§’</span>&#125;</code></pre><p>è¿™é‡Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œåªè¯·æ±‚å“åº”å…¨æ˜¯<code>code3</code></p><pre><code class="hljs nginx">~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3</code></pre><p>æ¥ä¸‹æ¥å°†è¿™ä¸ª8004ç«¯å£çš„æœåŠ¡é€šè¿‡é˜²ç«å¢™æ‹¦æˆªä¸å¯¹å¤–æä¾›æœåŠ¡</p><pre><code class="hljs bash">~&gt; iptables -I INPUT -p tcp --dport 8004 -j DROP</code></pre><p>è¿™é‡Œå› ä¸º8004ç«¯å£è¢«æ‹¦æˆªæ‰äº†ï¼Œæ‰€ä»¥å†10ç§’ç§æ˜¯è¯·æ±‚ä¸åˆ°çš„ï¼Œè¿™é‡Œå› ä¸ºå¤±è´¥æ¬¡æ•°ä¸º1ï¼Œé‚£ä¹ˆNginxå°±è®¤ä¸ºè¿™ä¸ªæœåŠ¡æŒ‚æ‰äº†ï¼Œå®ƒä¼šä½¿ç”¨8003è¿™ä¸ªç«¯å£çš„æœåŠ¡ï¼Œæ‰€æœ‰å“åº”å†…å®¹æ˜¯ï¼šcode2</p><pre><code class="hljs bash">~&gt; curl  http://localhostcode2~&gt; curl  http://localhostcode2~&gt; curl  http://localhostcode2~&gt; curl  http://localhostcode2</code></pre><h2 id="ä»‹ç»-è½®è¯¢ç­–ç•¥"><a href="#ä»‹ç»-è½®è¯¢ç­–ç•¥" class="headerlink" title="ä»‹ç»-è½®è¯¢ç­–ç•¥"></a>ä»‹ç»-è½®è¯¢ç­–ç•¥</h2><p>æˆ‘ä»¬éƒ½çŸ¥é“Nginxé»˜è®¤çš„è½®è¯¢æ˜¯åŸºäºè¯·æ±‚çš„å®ç°çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ç¬¬1ä¸ªè¯·æ±‚æ˜¯åœ¨code1ä¸Šï¼Œç¬¬2ä¸ªè¯·æ±‚æ˜¯åœ¨code2ä¸Šï¼Œç¬¬3ä¸ªè¯·æ±‚æ˜¯åœ¨code3ï¼Œæˆ‘ä»¬ä¸æ–­çš„è¯·æ±‚å®ƒå°±ä¸æ–­çš„è½®è¯¢ï¼Œè¿™ä¸ªå°çš„ç« èŠ‚é‡Œç»™å¤§å®¶ä»‹ç»Nginxè½®è¯¢ç­–ç•¥ï¼Œå› ä¸ºæˆ‘ä»¬å…‰çŸ¥é“Nginxé»˜è®¤çš„è½®è¯¢çš„è§„åˆ™æ˜¯å®Œå…¨æ— æ³•æ»¡è¶³å®é™…çš„é…ç½®éœ€æ±‚çš„ã€‚</p><p>1ï¼‰ã€è°ƒåº¦ç®—æ³•</p><table><thead><tr><th>è°ƒåº¦å</th><th>ä»‹ç»</th></tr></thead><tbody><tr><td>è½®è¯¢</td><td>æŒ‰æ—¶é—´é¡ºåºé€ä¸€åˆ†é…åˆ°ä¸åŒçš„åç«¯æœåŠ¡å™¨</td></tr><tr><td>åŠ æƒè½®è¯¢</td><td>weightå€¼è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„è®¿é—®å‡ ç‡è¶Šé«˜</td></tr><tr><td>ip_hash</td><td>æ¯ä¸ªè¯·æ±‚æŒ‰è®¿é—®IPçš„hashç»“æœåˆ†é…ï¼Œè¿™æ ·æ¥è‡ªåŒå“ªä¸ªä¸€ä¸ªIPçš„å›ºå®šè®¿é—®ä¸€ä¸ªåç«¯æœåŠ¡å™¨</td></tr><tr><td>url_hash</td><td>æŒ‰ç…§è®¿é—®çš„URLçš„hashç»“æœæ¥åˆ†é…è¯·æ±‚ï¼Œæ˜¯æ¯ä¸ªURLå®šå‘åˆ°ä¸€ä¸ªåç«¯æœåŠ¡å™¨</td></tr><tr><td>least_conn</td><td>æœ€å°‘é“¾æ¥æ•°ï¼Œå“ªä¸ªæœºå™¨è¿æ¥æ•°å°‘å°±åˆ†å‘</td></tr><tr><td>hashå…³é”®æ•°å€¼</td><td>hashè‡ªå®šä¹‰çš„key</td></tr></tbody></table><h2 id="æ¼”ç¤º-åŠ æƒè½®è¯¢"><a href="#æ¼”ç¤º-åŠ æƒè½®è¯¢" class="headerlink" title="æ¼”ç¤º-åŠ æƒè½®è¯¢"></a>æ¼”ç¤º-åŠ æƒè½®è¯¢</h2><p>æ¼”ç¤ºä¹‹å‰å°†å‰é¢çš„é˜²ç«å¢™æ‹¦æˆªçš„8004ç«¯å£æ”¾å¼€    </p><pre><code class="hljs bash">~&gt; iptables  -F</code></pre><p>upstream_test.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span> ;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span> weight=<span class="hljs-number">5</span>;&#125;</code></pre><p>ä¸‹é¢çš„æµ‹è¯•å¯ä»¥çœ‹çš„å“åº”å†…å®¹å¤§éƒ¨åˆ†éƒ½æ¥è‡ªäº8004ç«¯å£çš„æœåŠ¡</p><pre><code class="hljs bash">~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode1~&gt; curl  http://localhostcode2</code></pre><h2 id="æ¼”ç¤º-ip-bashæ–¹å¼"><a href="#æ¼”ç¤º-ip-bashæ–¹å¼" class="headerlink" title="æ¼”ç¤º-ip_bashæ–¹å¼"></a>æ¼”ç¤º-ip_bashæ–¹å¼</h2><p><code>åŠ æƒè½®è¯¢å’Œè½®è¯¢</code>çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡è¯·æ±‚æ¥è¿›è¡Œåˆ†é…çš„ï¼Œæˆ‘ä»¬å¦‚æœä¸æƒ³ä¾èµ–è¯·æ±‚æƒ³ä¿è¯å¯¹ä¸ä¸€äº›<code>Cookieã€Session</code>ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€æ¬¡ç”¨æˆ·è¯·æ±‚å¦‚æœåŸºäºè¯·æ±‚æ¥é‚£ä¹ˆå¯ä»¥å°±ä¼šæ‰“åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œå¯¼è‡´ç”¨æˆ·ç™»å½•çš„<code>Cookie</code>ä¿¡æ¯éªŒè¯å‡ºç°ä¸€äº›é—®é¢˜å®¹æ˜“å‡ºç°æ‰çº¿ï¼Œè¿™æ ·çš„è¯å°±éœ€è¦ç”¨å¦å¤–çš„æ–¹å¼ï¼Œä¸åŸºäºè¯·æ±‚æ¥åšè½®è¯¢è€Œæ˜¯åŸºäºip_hashçš„æ–¹å¼ï¼Œip_hashè¿™ç§æ–¹å¼å°±èƒ½å¤ŸåŸºäºç”¨æˆ·çš„IPæ¥è®¡ç®—å®ƒçš„hashå€¼ï¼Œç„¶åæŠŠæ¯ä¸€ä¸ªå›ºå®šçš„IPéƒ½æ‰“åˆ°åŒä¸€å°æœåŠ¡å™¨ä¸Šå»ï¼Œè¿™æ ·å°±è§£å†³äº†å¯¹äºä¸åŒçš„è¯·æ±‚ç„¶åæ‰“åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šçš„é—®é¢˜ã€‚</p><p>é…ç½®çš„å†…å®¹å†™åœ¨<code>upstream_test.conf</code>æ–‡ä»¶ä¸­</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    ip_hash;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span> ;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span>;&#125;</code></pre><p>ä¸‹é¢æµ‹è¯•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå®ƒçš„å“åº”å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„</p><pre><code class="hljs bash">~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3~&gt; curl  http://localhostcode3</code></pre><p><strong>é—®é¢˜</strong></p><blockquote><p>è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œä¸ç®¡ä½ æ˜¯æ€ä¹ˆè¯·æ±‚ï¼Œå®ƒéƒ½æ˜¯è½®è¯¢ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯å› ä¸ºip_hashçš„ç­–ç•¥å®ƒä¼šåŸºäºå®¢æˆ·çš„<code>remote address</code>æ¥åšhashï¼Œå¦‚æœæ˜¯åŒä¸€ä¸ª<code>remote address</code>è¿‡æ¥çš„è¯å®ƒå°±ä¼šå®šä½ä¸€å°æœåŠ¡å™¨ä¸Šå»ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼ä¹Ÿå­˜åœ¨ç¼ºé™·ï¼Œå¦‚æœ<code>remote address</code>æ˜¯èµ°ä»£ç†æ–¹å¼çš„è¯ç„¶åå‰ç«¯å†èµ°ä¸€å±‚ä»£ç†ï¼Œé‚£Nginxå–åˆ°çš„<code>remote address</code>ä¸æ˜¯ç”¨æˆ·çœŸå®çš„IPï¼Œè¿™æ ·çš„è¯å°±æ— æ³•åŸºäºç”¨æˆ·çœŸå®çš„IPæ¥åšå¯¹åº”çš„è½®è¯¢ï¼Œç”¨æˆ·è¿‡æ¥è¯·æ±‚å§‹ç»ˆä¼šå®šä½ä¸€å°æœºå™¨ä¸Šï¼Œæ‰€ä»¥åœ¨è¿™ä¸€å—çš„ç¼ºé™·æˆ‘ä»¬åœ¨åç»­çš„ç‰ˆæœ¬é‡Œé¢å°±å‡ºæ¥äº†æ–°çš„æ–¹å¼åŸºäºurlçš„hash</p></blockquote><h2 id="url-hashå’Œhashçš„æ–¹å¼"><a href="#url-hashå’Œhashçš„æ–¹å¼" class="headerlink" title="url_hashå’Œhashçš„æ–¹å¼"></a>url_hashå’Œhashçš„æ–¹å¼</h2><h3 id="ä»‹ç»-4"><a href="#ä»‹ç»-4" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>åœ¨å‰é¢ä»‹ç»çš„è½®è¯¢ä¸­æ— è®ºæ˜¯è½®è¯¢ã€åŠ æƒè½®è¯¢è¿˜æ˜¯ip_hashæ–¹å¼å®ƒä»¬éƒ½æ— æ³•è§£å†³ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´æˆ‘æƒ³è¦å›ºå®šçš„IPè¯·æ±‚å›ºå®šçš„å†…å®¹è®©å›ºå®šçš„IPæŒ‰ç…§IPæ¥åˆ†é…ã€‚</p><p>å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬åœ¨ç¼“å­˜çš„åœºæ™¯é‡Œé¢æœåŠ¡å™¨1ç¼“å­˜äº†ä¸€éƒ¨åˆ†èµ„æºï¼ŒæœåŠ¡å™¨2ç¼“å­˜äº†ä¸€éƒ¨åˆ†èµ„æºï¼Œå½“ä¸€ä¸ªç”¨æˆ·æ¥å…ˆè®¿é—®æœåŠ¡å™¨1ä»¥åå®ƒä¼šå…ˆç¼“å­˜ä½å®ƒç¼“å­˜çš„å†…å®¹ï¼Œå†ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å‡è®¾å®ƒè·³åˆ°äº†æœåŠ¡å™¨2ï¼Œè¿™æ ·çš„è¯å®ƒçœ‹åˆ°çš„æ˜¯å¦å¤–ä¸€éƒ¨åˆ†å†…å®¹ï¼Œé‚£ä¹ˆå®ƒçœ‹åˆ°çš„ç¬¬1éƒ¨åˆ†å†…å®¹å’Œç¬¬2éƒ¨åˆ†å†…å®¹æ˜¯ä¸ä¸€è‡´çš„ï¼Œæƒ³è¦å›ºå®šç”¨æˆ·æ¯ä¸€æ¬¡è¿‡æ¥è¯·æ±‚æˆ–è€…æ˜¯è¯´å®ƒè¯·æ±‚çš„å†…å®¹éƒ½èƒ½çœ‹åˆ°æ˜¯ä¸€è‡´çš„ï¼Œè¿™ä¸ªæ€ä¹ˆåŠå‘¢ï¼Ÿæ‰€ä»¥å®ƒéœ€è¦ç”¨åˆ°å¦å¤–ä¸€äº›hashçš„ç­–ç•¥ã€‚</p><p>åœ¨Nginxåç»­çš„ç‰ˆæœ¬é‡Œé¢å°±æ¨å‡ºæ¥äº†hashå…³é”®æ•°å€¼è‡ªå®šä¹‰hash keyçš„æ–¹å¼ã€‚</p><hr><h3 id="url-hashé…ç½®è¯­æ³•"><a href="#url-hashé…ç½®è¯­æ³•" class="headerlink" title="url_hashé…ç½®è¯­æ³•"></a>url_hashé…ç½®è¯­æ³•</h3><p>Syntaxï¼šhash key [consistent];<br>Defaultï¼šâ€”<br>Contextï¼šupstream </p><p>This directive appeared in versoin 1.7.2</p><hr><h3 id="æ¼”ç¤ºurl-hash"><a href="#æ¼”ç¤ºurl-hash" class="headerlink" title="æ¼”ç¤ºurl_hash"></a>æ¼”ç¤ºurl_hash</h3><p>å‡†å¤‡å·¥ä½œï¼šåœ¨<code>/opt/app/code{1-3}</code>ä¸­åˆ†åˆ«åˆ›å»º<code>url{1~3}.html</code></p><p>è¿™äº›<code>urlx.html</code>çš„å†…å®¹ä¸ºï¼š</p><pre><code class="hljs txt">Server:$&#123;è¿™é‡Œæ˜¯æœºå™¨çš„ç¼–å·&#125;  Url:$&#123;æ–‡ä»¶çš„1~3&#125;</code></pre><p>æ£€éªŒæ˜¯å¦èƒ½æ­£å¸¸è®¿é—®èƒ½å“åº”å†…å®¹å°±OKäº†</p><pre><code class="hljs bash">~&gt; curl http://dev001.com/url1.htmlServer:1  Url:1</code></pre><p>upstream_test.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">hash</span> <span class="hljs-variable">$request_uri</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span> ;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span>;&#125;</code></pre><p>æµ‹è¯•ä¸å¤ªæ˜æ˜¾ï¼Œè¿™é‡Œå°±ä¸æµ‹è¯•äº†</p><hr><h3 id="hashè¯´æ˜"><a href="#hashè¯´æ˜" class="headerlink" title="hashè¯´æ˜"></a>hashè¯´æ˜</h3><p>å‰é¢æ¼”ç¤ºäº†url_hashçš„æ–¹å¼ï¼Œä½†æ˜¯åœ¨å®é™…åœºæ™¯é‡Œé¢è¿™é‡Œçš„urlä¼šæœ‰å¾ˆå¤§ä¸€é•¿ä¸²ï¼Œä¸ç„¶è¯´è¿™ä¸ªåœ°å€ï¼š<a href="http://dev001.com/url1.html?testId=1&amp;userId=23" target="_blank" rel="noopener">http://dev001.com/url1.html?testId=1&amp;userId=23</a>,   è¿™é‡Œæˆ‘æƒ³é’ˆå¯¹URLä¸­çš„æŸä¸€ä¸ªå€¼ï¼Œä¾‹å¦‚è¿™ä¸ªé‡Œé¢çš„testIdçš„å€¼ï¼Œè¿™é‡Œå°±ç”¨åˆ°äº†hashçš„è½®è¯¢æ–¹å¼ï¼Œé¦–å…ˆè¯´ä¸‹å®ƒçš„ä¸€ä¸ªé…ç½®è¯­æ³•ï¼š</p><table><thead><tr><th align="left">Syntax:</th><th><code>**hash** *key* [consistent];</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>upstream</code></td></tr></tbody></table><p>æ³¨æ„ï¼šThis directive appeared in version 1.7.2.</p><p>æƒ³å®ç°è¿™ä¸ªåœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯åŠ ä¸€ä¸ªåˆ¤æ–­è¯­å¥æŠŠå¯¹åº”çš„å€¼ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–å‡ºæ¥ï¼Œç„¶åæŠŠè‡ªå®šä¹‰çš„è¿›è¡Œhashå°±å¯ä»¥äº†</p><h1 id="Nginxä½œä¸ºç¼“å­˜æœåŠ¡"><a href="#Nginxä½œä¸ºç¼“å­˜æœåŠ¡" class="headerlink" title="Nginxä½œä¸ºç¼“å­˜æœåŠ¡"></a>Nginxä½œä¸ºç¼“å­˜æœåŠ¡</h1><h2 id="ä»‹ç»-5"><a href="#ä»‹ç»-5" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ç¼“å­˜ç±»å‹"><a href="#ç¼“å­˜ç±»å‹" class="headerlink" title="ç¼“å­˜ç±»å‹"></a>ç¼“å­˜ç±»å‹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200211221403716.png" srcset="/img/loading.gif" alt="image-20200211221403716"></p><p>å¦‚æœç¼“å­˜æ”¾åœ¨æœåŠ¡ç«¯ç§°å‘¼å®ƒä¸º<code>æœåŠ¡ç«¯ç¼“å­˜</code> ï¼ŒæœåŠ¡ç«¯ç¼“å­˜æœ€å¸¸ç”¨çš„å°±æ˜¯<code>Redisã€Memcached</code>æ¥å­˜å‚¨<code>key-value</code>ç±»å‹æ•°æ®ã€‚</p><p>å½“ç¼“å­˜æ”¾åˆ°ä»£ç†ã€ä¸­é—´ä»¶ä¸Šé¢å°±ç§°å‘¼ä¸ºä»£ç†ç¼“å­˜ï¼Œå®ƒçš„å†…å®¹æ˜¯åŒæœåŠ¡ç«¯è·å–åˆ°çš„ï¼Œç„¶ååœ¨ç¼“å­˜åˆ°æœ¬åœ°ç›´æ¥ç»™å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œè¿™æ ·çš„è¯ç¼“å­˜æ˜¯æ”¾åœ¨Nginxè¿™ä¸€ç«¯ã€‚</p><p>å®¢æˆ·ç«¯ç¼“å­˜æ˜¯ç¼“å­˜å†æµè§ˆå™¨ä¸Šé¢ï¼Œæµè§ˆå™¨ä¸Šé¢çš„ç¼“å­˜æ˜¯ä»æœåŠ¡ç«¯è¿‡æ¥çš„ï¼Œåªæ˜¯è¯´ç»™å‰ç«¯ç¼“å­˜äº†ä¸€ä»½ï¼Œè®©ç”¨æˆ·è‡ªå·±å°±èƒ½è®¿é—®è‡ªå·±ï¼Œæ‰€ä»¥æˆ‘ä»¬ç§°å‘¼ä¸ºå®¢æˆ·ç«¯ç¼“å­˜ã€‚</p><hr><h3 id="ä»£ç†ç¼“å­˜"><a href="#ä»£ç†ç¼“å­˜" class="headerlink" title="ä»£ç†ç¼“å­˜"></a>ä»£ç†ç¼“å­˜</h3><p>Nginxä»£ç†ç¼“å­˜çš„æµç¨‹æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿè¯·çœ‹ä¸‹å›¾ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200211221904322.png" srcset="/img/loading.gif" alt="image-20200211221904322"></p><p>é¦–å…ˆå®¢æˆ·ç«¯å…ˆå»è¯·æ±‚Nginxï¼Œç¬¬ä¸€æ¬¡è¯·æ±‚çš„æ—¶å€™å¦‚æœNginxä¸­æ²¡æœ‰ç¼“å­˜ï¼Œé‚£ä¹ˆå®ƒä¼šå‘æœåŠ¡å™¨å‘èµ·è¯·æ±‚æœåŠ¡å™¨è¿”å›å¯¹åº”çš„æ•°æ®ï¼ŒNginxå¯¹æœåŠ¡å™¨è¿”å›çš„è¿™ä¸ªæ•°æ®è¿›è¡Œç¼“å­˜ï¼Œç„¶åå†è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ˜¯åœ¨æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œå½“ç”¨æˆ·å†ä¸€æ¬¡å‘èµ·åŒä¸€ä¸ªurlçš„è¯·æ±‚çš„æ—¶å€™ï¼Œé‚£ä¹ˆè¯·æ±‚è¿™ä¸ªæ•°æ®aï¼ŒNginxå·²ç»ç¼“å­˜è¿‡è¿™ä¸ªæ•°æ®äº†ï¼Œæ‰€ä»¥å®ƒå°±ç›´æ¥å¯ä»¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œä¸éœ€è¦å»æœåŠ¡ç«¯è¿›è¡Œè¯·æ±‚äº†ï¼Œè¿™ä¸ªå°±æ˜¯ä»£ç†ç¼“å­˜çš„æ¨¡å¼ã€‚</p><h3 id="é…ç½®è¯­æ³•-2"><a href="#é…ç½®è¯­æ³•-2" class="headerlink" title="é…ç½®è¯­æ³•"></a>é…ç½®è¯­æ³•</h3><h4 id="proxy-cache"><a href="#proxy-cache" class="headerlink" title="proxy_cache"></a>proxy_cache</h4><p>åœ¨å®šä¹‰<code>proxy_cache</code>ä¹‹å‰å…ˆè¦å®šä¹‰<code>proxy_cache_path</code></p><p>| Syntax:  | <code>**proxy_cache_path** *path* [levels=*levels*] [use_temp_path=on|off] keys_zone=*name*:*size* [inactive=*time*] [max_size=*size*] [manager_files=*number*] [manager_sleep=*time*] [manager_threshold=*time*] [loader_files=*number*] [loader_sleep=*time*] [loader_threshold=*time*] [purger=on|off] [purger_files=*number*] [purger_sleep=*time*] [purger_threshold=*time*];</code> |<br>| :â€”â€”- | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |<br>| Default: | â€”                                                            |<br>| Context: | <code>http</code>                                                       |</p><p>å®ƒç”¨æ¥è®¾ç½®ç›®å½•ç©ºé—´å¤§å°ä»¥åŠåå­—ï¼Œç”¨æ¥å­˜æ”¾å¯¹åº”çš„ç¼“å­˜æ–‡ä»¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆè¦å®šä¹‰å¥½å¯¹åº”çš„è·¯å¾„ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šçš„é…ç½®é¡¹ï¼Œåé¢ä»‹ç»ä¸€äº›å¸¸ç”¨çš„é…ç½®é¡¹ã€‚</p><p>| Syntax:  | <code>**proxy_cache** *zone* | off;</code> |<br>| :â€”â€”- | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”- |<br>| Default: | <code>proxy_cache off;</code>              |<br>| Context: | <code>http</code>, <code>server</code>, <code>location</code>    |</p><p>è¿™é‡Œçš„<code>zone</code>æ˜¯<code>proxy_cache_path</code>é‚£ä¸ªkeyï¼Œè¡¨ç¤ºå®ƒè°ƒç”¨å“ªä¸ªpath</p><h4 id="ç¼“å­˜è¿‡æœŸå‘¨æœŸ"><a href="#ç¼“å­˜è¿‡æœŸå‘¨æœŸ" class="headerlink" title="ç¼“å­˜è¿‡æœŸå‘¨æœŸ"></a>ç¼“å­˜è¿‡æœŸå‘¨æœŸ</h4><table><thead><tr><th align="left">Syntax:</th><th><code>**proxy_cache_valid** [*code* ...] *time*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><h4 id="ç¼“å­˜çš„ç»´åº¦"><a href="#ç¼“å­˜çš„ç»´åº¦" class="headerlink" title="### ç¼“å­˜çš„ç»´åº¦"></a>### ç¼“å­˜çš„ç»´åº¦</h4><table><thead><tr><th align="left">Syntax:</th><th><code>**proxy_cache_key** *string*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td><code>proxy_cache_key $scheme$proxy_host$request_uri;</code></td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><h2 id="åœºæ™¯é…ç½®æ¼”ç¤º"><a href="#åœºæ™¯é…ç½®æ¼”ç¤º" class="headerlink" title="åœºæ™¯é…ç½®æ¼”ç¤º"></a>åœºæ™¯é…ç½®æ¼”ç¤º</h2><p>å‡†å¤‡å·¥ä½œï¼š</p><p>è¿™é‡Œçš„é…ç½®è”å’Œä¸Šæ¬¡è´Ÿè½½å‡è¡¡çš„é…ç½®ä½¿ç”¨çš„<code>8001ã€8003ã€8004</code>ç«¯å£</p><pre><code class="hljs bash">~&gt; netstat  -anp | grep 800*tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      2179/nginx: master  tcp        0      0 0.0.0.0:8001            0.0.0.0:*               LISTEN      2179/nginx: master  tcp        0      0 0.0.0.0:8003            0.0.0.0:*               LISTEN      2179/nginx: master  tcp        0      0 0.0.0.0:8004            0.0.0.0:*               LISTEN      2179/nginx: master</code></pre><p> é…ç½®æ–‡ä»¶ï¼š</p><p>cache_test.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">upstream</span> mcr&#123;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8001</span>;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8003</span> ;    <span class="hljs-attribute">server</span> dev001.com:<span class="hljs-number">8004</span>;&#125;<span class="hljs-attribute">proxy_cache_path</span> /opt/app/cache levels=<span class="hljs-number">1</span>:<span class="hljs-number">2</span> keys_zone=mcr_cache:<span class="hljs-number">10m</span> max_size=<span class="hljs-number">10g</span> inactive=<span class="hljs-number">60m</span> use_temp_path=<span class="hljs-literal">off</span>;<span class="hljs-section">server</span> &#123;    <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> ;    <span class="hljs-attribute">server_name</span>  localhost;    <span class="hljs-attribute">access_log</span>  /var/log/nginx/test_proxy.access.log  main;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-attribute">proxy_cache</span> mcr_cache;        <span class="hljs-attribute">proxy_pass</span>  http://mcr;        <span class="hljs-attribute">proxy_cache_valid</span> <span class="hljs-number">200</span> <span class="hljs-number">304</span> <span class="hljs-number">12h</span>;        <span class="hljs-attribute">proxy_cache_valid</span> any <span class="hljs-number">10m</span>;        <span class="hljs-attribute">proxy_cache_key</span> <span class="hljs-variable">$host</span><span class="hljs-variable">$uri</span><span class="hljs-variable">$is_args</span><span class="hljs-variable">$args</span>;        <span class="hljs-attribute">add_header</span> Nginx-Cache <span class="hljs-variable">$upstream_cache_status</span>;        <span class="hljs-attribute">proxy_next_upstream</span> <span class="hljs-literal">error</span> timeout invalid_header http_500 http_502 http_503 http_504;        <span class="hljs-attribute">include</span> proxy_params;    &#125;&#125;</code></pre><p>proxy_cache_path</p><ul><li>levelsï¼šæˆ‘ä»¬çš„è¿™äº›ç¼“å­˜æ–‡ä»¶ä¸ä¼šæ€»æ”¾åœ¨ä¸€ä¸ªç›®å½•ï¼Œéœ€è¦åšåˆ†çº§ï¼Œè¿™é‡Œä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨<code>1ï¼š2</code>åšä¸€ä¸ª2çº§ç›®å½•çš„åˆ†çº§ï¼›</li><li>keys_zoneï¼šå®šä¹‰çš„zoneç©ºé—´çš„åå­—ï¼Œåœ¨<code>location</code>ä¸­çš„<code>proxy_cache</code>è°ƒç”¨çš„å°±æ˜¯è¿™ä¸ªåå­—ã€‚åé¢çš„<code>10m</code>è¡¨ç¤ºå¤§å°ï¼Œè¡¨ç¤ºå¼€è¾Ÿç©ºé—´çš„è¿™ä¸ªkeyçš„å¤§å°ï¼Œä¸€èˆ¬<code>1m</code>å¯ä»¥å­˜æ”¾8kä¸ªkeyï¼Œè¿™é‡Œ10m=80k</li><li>max_sizeï¼šè¿™ä¸ªç›®å½•æ§åˆ¶å®ƒæœ€å¤§æ˜¯å¤šå¤§ã€‚å½“ç›®å½•ç©ºé—´ç”¨æ»¡ä»¥åNginxä¼šè§¦å‘æ·˜æ±°è§„åˆ™æŠŠä¸€äº›ä¸å¸¸ç”¨çš„æ·˜æ±°æ‰</li><li>inactiveï¼šè¡¨ç¤ºä¸æ´»è·ƒçš„ï¼Œåé¢çš„<code>60m</code>ä¸æ˜¯å…†æ˜¯æ—¶é—´å•ä½å®ƒè¿™é‡Œè¡¨ç¤º60åˆ†é’Ÿï¼Œåœ¨60åˆ†é’Ÿä¹‹å†…å¦‚æœè¿™ä¸ªç¼“å­˜æ–‡ä»¶æ²¡æœ‰è¢«è®¿é—®è¿‡å°±ä¼šæŠŠå®ƒæ¸…ç†æ‰</li><li>use_temp_pathï¼šå­˜æ”¾ä¸´æ—¶æ–‡ä»¶ï¼Œä¸€èˆ¬å»ºè®®ç»™å®ƒå…³é—­ï¼Œå¦‚æœä½ æŠŠå®ƒæ‰“å¼€çš„è¯å®ƒä¼šå¦å¤–å»ºç«‹ä¸€ä¸ªç›®å½•å’Œcacheç›®å½•2ä¸ªç›®å½•åœ¨æ›´æ–°ç¼“å­˜çš„æ—¶å€™å®¹æ˜“å‡ºç°æ€§èƒ½ä¸Šçš„æŸè€—</li></ul><p>location</p><ul><li>proxy_cacheï¼šè°ƒç”¨ä¸Šé¢è¯´çš„è¿™ä¸ªzone</li><li>proxy_cache_valid 200 304 12hï¼šè¡¨ç¤ºå¯¹äº200è¿”å›çš„å¤´ä¿¡æ¯æˆ–è€…304å¤´ä¿¡æ¯å®ƒæ˜¯ä¼š12ä¸ªå°æ—¶è¿‡æœŸ</li><li>proxy_cache_valid any 10mï¼šé™¤äº†200ã€203ä»¥å¤–çš„10åˆ†é’Ÿè¿‡æœŸ</li><li><code>proxy_cache_key $host$uri$is_args$args</code>ï¼šé‡æ–°æŠŠ<code>proxy_cache_key</code>è¿›è¡Œäº†é‡æ–°å®šä¹‰ï¼ŒæŠŠé»˜è®¤æ”¹ä¸ºäº†ä»¥hostç»´åº¦+url+is_args+argså¯¹åº”çš„å‚æ•°ç»™å®ƒåŠ å…¥è¿›æ¥ä½œä¸ºç¼“å­˜çš„key</li><li>add_header Nginx-Cache $upstream_cache_statusï¼šå¢åŠ ä¸€ä¸ªå¤´ä¿¡æ¯ï¼Œä¸€ä¼šåœ¨æ¼”ç¤ºçš„æ—¶å€™èƒ½å¾ˆæ˜æ˜¾çš„çœ‹å‡ºæ¥ï¼Œè¿”å›å®¢æˆ·ç«¯çš„responseé‡Œé¢ä¼šå‘Šè¯‰å®¢æˆ·ç«¯æ˜¯å¦å‘½ä¸­ï¼Œé€šè¿‡è¿™ä¸ªå¤´ä¿¡æ¯å°±èƒ½æ¸…æ¥šçš„çœ‹å‡ºæ¥</li><li>proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504ï¼šå¦‚æœå½“æˆ‘ä»¬çš„åç«¯å…¶ä¸­çš„ä¸€å°æœåŠ¡å™¨å‡ºç°500ã€502ã€503ã€504ã€ä¸æ­£å¸¸çš„å¤´è¿”å›ã€è¶…æ—¶ã€æœ‰é”™è¯¯çš„æ—¶å€™æˆ‘ä»¬å°±è®©å®ƒè·³è¿‡è¿™ä¸€å°å»è®¿é—®ä¸‹ä¸€å°ï¼Œé¿å…æˆ‘ä»¬å› ä¸ºå•å°æœåŠ¡å™¨å¦‚æœæ˜¯æœ‰è¿™ä¸ªé—®é¢˜å¯¹äºå‰ç«¯çš„äº§ç”Ÿå½±å“ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°æˆ‘ä»¬åœ¨ç¼“å­˜é‡Œé¢ç»™å¤§å®¶ä¸€èµ·é…ä¸Šè¿™ä¸ªå‚æ•°</li></ul><hr><p>æµ‹è¯•ï¼š</p><pre><code class="hljs bash">~&gt; curl http://localhostcode1~&gt; curl http://localhostcode1~&gt; curl http://localhostcode1</code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°å®ƒçš„å“åº”å†…å®¹ä¸€ç›´éƒ½æ˜¯code1ï¼Œçœ‹ä¸Šå»å¥½åƒæ²¡æœ‰è´Ÿè½½å‡è¡¡å•Šï¼Œå…¶å®è¿™é‡Œå› ä¸ºå®ƒæŠŠè¿™äº›å“åº”å†…å®¹ç¼“å­˜èµ·æ¥äº†ï¼Œå½“ä¸‹ä¸€æ¬¡è®¿é—®çš„æ—¶å€™å°±æ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­å»å–</p><pre><code class="hljs bash">/opt/app/cache&gt; rm -rf *~&gt; curl http://localhostcode2</code></pre><p>è¿™é‡Œå°†ç¼“å­˜æ–‡ä»¶åˆ é™¤æ‰ï¼Œå“åº”å†…å®¹å˜æˆä¸ºäº†code2ï¼Œå› ä¸ºæ²¡æœ‰ç¼“å­˜ï¼Œæ‰€ä»¥æ˜¯ä»æœåŠ¡å™¨å»å–çš„ã€‚</p><p>è¿™é‡Œå°†<code>location</code>ä¸­çš„<code>proxy_cache</code>çš„å€¼æ”¹ä¸º<code>off</code>ï¼Œå†å»è¯·æ±‚æ¥çœ‹ä¸‹æ²¡æœ‰ç¼“å­˜çš„æƒ…å†µä¸‹ï¼š</p><pre><code class="hljs bash">~&gt; curl http://localhostcode1~&gt; curl http://localhostcode2~&gt; curl http://localhostcode3</code></pre><h2 id="åœºæ™¯é…ç½®è¡¥å……è¯´æ˜"><a href="#åœºæ™¯é…ç½®è¡¥å……è¯´æ˜" class="headerlink" title="åœºæ™¯é…ç½®è¡¥å……è¯´æ˜"></a>åœºæ™¯é…ç½®è¡¥å……è¯´æ˜</h2><h3 id="å¦‚ä½•æ¸…é™¤æŒ‡å®šç¼“å­˜ï¼Ÿ"><a href="#å¦‚ä½•æ¸…é™¤æŒ‡å®šç¼“å­˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•æ¸…é™¤æŒ‡å®šç¼“å­˜ï¼Ÿ"></a>å¦‚ä½•æ¸…é™¤æŒ‡å®šç¼“å­˜ï¼Ÿ</h3><ul><li>rm -rm ç¼“å­˜ç›®å½•å†…å®¹</li><li>ç¬¬ä¸‰æ–¹æ‰©å±•æ¨¡å—<code>ngx_cache_purge</code></li></ul><h3 id="å¦‚ä½•è®©éƒ¨åˆ†é¡µé¢ä¸ç¼“å­˜ï¼Ÿ"><a href="#å¦‚ä½•è®©éƒ¨åˆ†é¡µé¢ä¸ç¼“å­˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®©éƒ¨åˆ†é¡µé¢ä¸ç¼“å­˜ï¼Ÿ"></a>å¦‚ä½•è®©éƒ¨åˆ†é¡µé¢ä¸ç¼“å­˜ï¼Ÿ</h3><blockquote><p>åœ¨ä¸€äº›åœºæ™¯ä¸­æ¯”å¦‚ç™»å½•é¡µé¢ï¼Œæˆ–è€…æ˜¯ç”¨æˆ·ä¸èƒ½ç¼“å­˜çš„é¡µé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯ä¸æ˜¯éœ€è¦è®©éƒ¨åˆ†é¡µé¢ä¸ç¼“å­˜å‘¢ï¼Ÿä»¥ä¸‹é…ç½®å°±èƒ½å¤Ÿå®ç°</p></blockquote><table><thead><tr><th align="left">Syntax:</th><th><code>**proxy_no_cache** *string* ...;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td>â€”</td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><p>è¿™ä¸ªé…ç½®èƒ½è®©å“ªä¸€äº›urlæ˜¯ä¸ä¼šå»ç¼“å­˜çš„ã€‚</p><p>è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œè¿™é‡Œæ ¹æ®å‰é¢çš„é…ç½®æ–‡ä»¶<code>cache_test.conf</code>åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š</p><pre><code class="hljs nginx"><span class="hljs-section">server</span> &#123;    <span class="hljs-comment">#...</span>    <span class="hljs-attribute">if</span> (<span class="hljs-variable">$request_uri</span> <span class="hljs-regexp">~ ^/(url3|login|register|password\/reset))</span>&#123;        <span class="hljs-attribute">set</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-number">1</span>;    &#125;    <span class="hljs-attribute">location</span> / &#123;        <span class="hljs-comment">#...</span>        <span class="hljs-attribute">proxy_no_cache</span> <span class="hljs-variable">$cookie_nocache</span> <span class="hljs-variable">$arg_nocache</span> <span class="hljs-variable">$arg_comment</span>;        <span class="hljs-attribute">proxy_no_cache</span> <span class="hljs-variable">$http_pragma</span> <span class="hljs-variable">$http_authorization</span>;    &#125;&#125;</code></pre><p>è¿™é‡Œçš„serveréƒ¨åˆ†ä¸­çš„ifï¼Œå¦‚æœè¯·æ±‚æ˜¯url3ï¼Œé‚£ä¹ˆè¿™é‡Œçš„cookie_nocacheå˜é‡çš„å€¼è®¾ä¸º1ï¼Œåœ¨<code>location</code>ä¸­çš„ç¬¬1ä¸ªproxy_no_cacheå°±èƒ½å¤Ÿç”Ÿæ•ˆå°±ä¸å»ç¼“å­˜å½“å‰è¿™ä¸ªurl3çš„è¯·æ±‚äº†</p><pre><code class="hljs bash"><span class="hljs-comment">#è¢«ç¼“å­˜çš„æƒ…å†µ</span>~&gt; curl localhostcode1~&gt; curl localhostcode1~&gt; curl localhost<span class="hljs-comment">#ä¸è¢«ç¼“å­˜çš„æƒ…å†µ</span>~&gt; curl localhost/url3.htmlServer:2  Url:3~&gt; curl localhost/url3.htmlServer:3  Url:3~&gt; curl localhost/url3.htmlServer:2  Url:3~&gt; curl localhost/url3.htmlServer:2  Url:3~&gt; curl localhost/url3.htmlServer:1  Url:3</code></pre><h2 id="åˆ†ç‰‡è¯·æ±‚"><a href="#åˆ†ç‰‡è¯·æ±‚" class="headerlink" title="åˆ†ç‰‡è¯·æ±‚"></a>åˆ†ç‰‡è¯·æ±‚</h2><p>æ—©æœŸç‰ˆæœ¬çš„Nginxå¯¹äºç¼“å­˜åŠŸèƒ½ä¸æ˜¯ç‰¹åˆ«å…¨ï¼Œå¯¹äºç¨å¤§çš„æ–‡ä»¶åˆ†ç‰‡è¯·æ±‚æ˜¯ä¸èƒ½æ”¯æŒçš„ï¼Œåœ¨<code>1.9ç‰ˆæœ¬</code>ä»¥åæä¾›çš„<code>sliceæ¨¡å—</code>å°±å®ç°äº†å¤§æ–‡ä»¶çš„åˆ†ç‰‡è¯·æ±‚ï¼Œå®ƒçš„é…ç½®è¯­æ³•å¦‚ä¸‹ï¼š</p><table><thead><tr><th align="left">Syntax:</th><th><code>**slice** *size*;</code></th></tr></thead><tbody><tr><td align="left">Default:</td><td><code>slice 0;</code></td></tr><tr><td align="left">Context:</td><td><code>http</code>, <code>server</code>, <code>location</code></td></tr></tbody></table><p>slice sizeï¼šè¡¨ç¤ºæˆ‘å¯¹ä¸€ä¸ªå¤§æ–‡ä»¶è¯·æ±‚çš„æ—¶å€™æˆ‘è¦åˆ‡å‰²æˆå¤šå¤§å°çš„ç¢ç‰‡å»å‡åŒ€çš„è¯·æ±‚åç«¯ã€‚</p><p>è¯·æ±‚å›¾ç¤ºå¦‚ä¸‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200212125648461.png" srcset="/img/loading.gif" alt="image-20200212125648461"></p><p>å‰ç«¯è¯·æ±‚è¿‡æ¥ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªæ–‡ä»¶ç¬¬ä¸€æ¬¡è¯·æ±‚åç«¯å»è·å–åˆ°è¿™ä¸ªæ–‡ä»¶çš„å¤§å°ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå¤§å°ä»¥åŠæˆ‘ä»¬å®šä¹‰<code>size</code>å¤§å°ç„¶åè¿›è¡Œåˆ‡ç‰‡ä»¥åˆ†å‰²æˆä¸åŒå°çš„è¯·æ±‚åŒæ—¶å»è¯·æ±‚åç«¯ï¼Œè¿™æ ·çš„è¯å°±å½¢æˆäº†ä¸€ä¸ªä¸€ä¸ªå°çš„è¯·æ±‚å½¢æˆåˆ°å‰ç«¯çš„è¯å°±æ˜¯ä¸€ä¸ªä¸ªç‹¬ç«‹çš„ç¼“å­˜æ–‡ä»¶ã€‚</p><p>ä¼˜åŠ¿ï¼š</p><p>æ¯ä¸ªå­è¯·æ±‚æ”¶åˆ°çš„æ•°æ®éƒ½ä¼šå½¢æˆä¸€ä¸ªç‹¬ç«‹æ–‡ä»¶ï¼Œä¸€ä¸ªè¯·æ±‚æ–­äº†ï¼Œå…¶å®ƒè¯·æ±‚ä¸å—å½±å“</p><p>ç¼ºç‚¹ï¼š</p><p>å½“æ–‡ä»¶å¾ˆå¤§æˆ–è€…<code>slice</code>å¾ˆå°çš„æ—¶å€™å°±ä¼šå½¢æˆå¾ˆå¤šä¸ªå°çš„è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ä¸€æ¬¡è¯·æ±‚å°±ä¼šé€ æˆæ“ä½œç³»ç»Ÿçš„ä¸€ä¸ªæ–‡ä»¶è·ç¦»å’Œå»ºç«‹ä¸€æ¬¡è¿æ¥è€Œå¯¼è‡´æ“ä½œç³»ç»Ÿå»ºç«‹å¾ˆå¤šä¸ªæ–‡ä»¶è·ç¦»å’Œå¤šä¸ªè¿æ¥ï¼Œå¯èƒ½å‡ºç°æŸè€—è¿‡å¤šçš„æƒ…å†µ</p>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Nginxã€‘ 2.åŸºç¡€ç¯‡</title>
    <link href="/nginx-2.html"/>
    <url>/nginx-2.html</url>
    
    <content type="html"><![CDATA[<h1 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h1><pre><code class="hljs bash">~&gt; yum install  -y nginx~&gt; nginx -v~&gt; nginx version: nginx/1.16.1</code></pre><h1 id="åŸºæœ¬å‘½ä»¤"><a href="#åŸºæœ¬å‘½ä»¤" class="headerlink" title="åŸºæœ¬å‘½ä»¤"></a>åŸºæœ¬å‘½ä»¤</h1><pre><code class="hljs bash">nginx -tc /etc/nginx/nginx.conf<span class="hljs-comment">#æ£€æŸ¥é…ç½®æ˜¯å¦æ­£å¸¸</span>nginx -s reload -c /etc/nginx/nginx.conf <span class="hljs-comment">#é‡æ–°åŠ è½½å¹¶åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶</span></code></pre><h1 id="ç›®å½•å’Œé…ç½®è¯­æ³•"><a href="#ç›®å½•å’Œé…ç½®è¯­æ³•" class="headerlink" title="ç›®å½•å’Œé…ç½®è¯­æ³•"></a>ç›®å½•å’Œé…ç½®è¯­æ³•</h1><p><strong>å®‰è£…ç›®å½•ä»‹ç»</strong></p><pre><code class="hljs bash">~&gt; rpm -ql nginx/etc/logrotate.d/nginx/etc/nginx/fastcgi.conf/etc/nginx/fastcgi.conf.default/etc/nginx/fastcgi_params/etc/nginx/fastcgi_params.default/etc/nginx/koi-utf...</code></pre><blockquote><p>é€šè¿‡ä¸Šé¢çš„å‘½ä»¤æ¥æŸ¥çœ‹å®ƒå®‰è£…ä¹‹åæ”¾çš„ä½ç½®,ä¸‹é¢ä»‹ç»ä¸€ä¸‹ä¸€äº›é‡è¦çš„æ–‡ä»¶</p></blockquote><p>/etc/logrotate.d/nginx</p><blockquote><p>æ—¥å¿—è½®è½¬ï¼Œç”¨äºlogroteæœåŠ¡çš„æ—¥å¿—åˆ‡å‰²</p></blockquote><p>/etc/nginx/nginx.conf</p><blockquote><p>ä¸»è¦é…ç½®ï¼Œå¯åŠ¨çš„æ—¶å€™ï¼Œä¸»è¦è¯»å®ƒ</p></blockquote><p>/etc/nginx/conf.d/default.conf</p><blockquote><p>é»˜è®¤åŠ è½½çš„é…ç½®</p></blockquote><p>/etc/nginx/fastcgi_params</p><blockquote><p>å†ç”¨PHPè¿™ç§fastcgiæ¨¡å¼çš„æ—¶å€™ï¼Œå°±éœ€è¦åŠ è½½fastcgiè¿™ä¸ªæ–‡ä»¶</p></blockquote><p>/etc/nginx/fastcgi_params</p><p>/etc/nginx/uwsgi_params</p><p>/etc/nginx/uwsgi_params</p><blockquote><p>cigé…ç½®ç›¸å…³ã€fastcgié…ç½®</p></blockquote><p>/etc/nginx/koi-utf</p><p>/etc/nginx/koi-win</p><p>/etc/nginx/win-utf</p><blockquote><p>ç¼–ç è½¬æ¢æ˜ å°„æ–‡ä»¶</p></blockquote><p>/etc/nginx/mime.types</p><blockquote><p>é…ç½®httpåè®®çš„Content-Typeä¸æ‰©å±•å¯¹åº”å…³ç³»ã€‚åœ¨HttpResponseä¸­ä¼šæœ‰ä¸€ä¸ªContent-Typeï¼Œå®ƒæè¿°æ•°æ®çš„ç±»å‹ï¼Œæ¯”å¦‚æ˜¯å›¾ç‰‡çš„è¯Content-Typeä¼šæ˜¯ä¸€ä¸ªJPGã€GIFã€‚Nginxè¦æŠŠContent-Typeå’Œå®ƒå¯¹åº”çš„æ‰©å±•åå»ºç«‹ä¸€ä¸ªå¯¹åº”å…³ç³»å°±åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå½“Nginxè¦å¤„ç†ä¸€äº›å®ƒä¸èƒ½è¯†åˆ«çš„ç±»å‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œå»æ·»åŠ </p></blockquote><p>/usr/lib/systemd/system/nginx-debug.service</p><p>/usr/lib/systemd/system/nginx.service.d</p><p>/etc/sysconfig/nginx</p><p>/etc/sysconfig/nginx-debug</p><blockquote><p>ç”¨äºé…ç½®å‡ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ç®¡ç†å™¨ç®¡ç†æ–¹å¼</p></blockquote><p>/usr/lib64/nginx/modules</p><p>/etc/nginx/modules</p><blockquote><p>Nginxæ¨¡å—ç›®å½•</p></blockquote><p>/usr/sbin/nginx</p><p>/usr/sbin/nginx-debug</p><blockquote><p>NginxæœåŠ¡çš„å¯åŠ¨ç®¡ç†çš„ç»ˆç«¯å‘½ä»¤</p></blockquote><p>/usr/share/doc/nginx-1.16.1</p><p>/usr/share/doc/nginx-1.16.1/README</p><p>/usr/share/man/man8/nginx.8.gz</p><blockquote><p>Nginxçš„æ‰‹å†Œå’Œå¸®åŠ©æ–‡ä»¶</p></blockquote><p>/var/cache/nginx</p><blockquote><p>Nginxçš„ç¼“å­˜ç›®å½•</p></blockquote><p>/var/log/nginx</p><blockquote><p>Nginxçš„æ—¥å¿—ç›®å½•    </p></blockquote><h1 id="ç¼–è¯‘é…ç½®å‚æ•°"><a href="#ç¼–è¯‘é…ç½®å‚æ•°" class="headerlink" title="ç¼–è¯‘é…ç½®å‚æ•°"></a>ç¼–è¯‘é…ç½®å‚æ•°</h1><p><strong>å®‰è£…ç¼–è¯‘å‚æ•°</strong></p><p>prefix=/etc/nginx            ä¸»ç›®å½•<br>â€“sbin-path =/usr/sbin/nginx        æ‰§è¡Œå‘½ä»¤<br>-modules-path =/usr/lib64/nginx/modules        æ¨¡å—<br>-conf-path =/etc/nginx/nginx.conf        é…ç½®æ–‡ä»¶<br>â€“error-log-path=/var/log/nginx/error.log        é”™è¯¯æ—¥å¿—ç›®å½•<br>http-log-path=/var/log/nginx/access.log        è®¿é—®æ—¥å¿—<br>â€“pid -path =/var/run/nginx.pid        pidæ–‡ä»¶<br>-lock-path=/var/run/nginx.lock        é”</p><p>â€“http-client-body-temp-path=/var/cache/nginx/client_temp        </p><p>http-proxy-temp-path=/var/cache/nginx/proxy_temp        </p><p>http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp</p><p>http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp</p><p>http-scgi-temp-path=/var/cache/nginx/scgi_temp</p><hr><p>â€“user=nginxã€â€“group=nginx        è®¾å®šNginxè¿›ç¨‹å¯åŠ¨çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„</p><p>â€“with-cc-opt=parameters        è®¾ç½®é¢å¤–çš„å‚æ•°å°†è¢«æ·»åŠ åˆ°CFLAGSå˜é‡</p><p> â€“with-ld-opt=parameters        è®¾ç½®é™„åŠ çš„å‚æ•°ï¼Œé“¾æ¥ç³»ç»Ÿåº“</p><h1 id="é»˜è®¤é…ç½®è¯­æ³•"><a href="#é»˜è®¤é…ç½®è¯­æ³•" class="headerlink" title="é»˜è®¤é…ç½®è¯­æ³•"></a>é»˜è®¤é…ç½®è¯­æ³•</h1><h2 id="å…¨å±€"><a href="#å…¨å±€" class="headerlink" title="å…¨å±€"></a>å…¨å±€</h2><table>  <tr>    <td>user</td>    <td>è®¾ç½®nginxæœåŠ¡çš„ç³»ç»Ÿä½¿ç”¨ç”¨æˆ·</td>  </tr>  <tr>    <td>worker_processes</td>    <td>å·¥ä½œè¿›ç¨‹æ•°ï¼Œä¸€èˆ¬ä¸CPUä¿æŒä¸€è‡´</td>  </tr>  <tr>    <td>error_log</td>    <td>nginxçš„é”™è¯¯æ—¥å¿—</td>  </tr>  <tr>    <td>pid</td>    <td>nginxæœåŠ¡å¯åŠ¨æ—¶å€™pid</td>  </tr></table><p><strong>events</strong></p><table>  <tr>    <td>worker_connections</td>    <td>æ¯ä¸ªè¿›ç¨‹å…è®¸æœ€å¤§è¿æ¥æ•°</td>  </tr>  <tr>    <td>use</td>    <td>å·¥ä½œè¿›ç¨‹æ•°</td>  </tr></table><h2 id="http"><a href="#http" class="headerlink" title="http"></a>http</h2><pre><code class="hljs nginx">http&#123;    <span class="hljs-attribute">include</span>             /etc/nginx/mime.types;    <span class="hljs-comment">#æ—¥å¿—ç±»å‹</span>  <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">'<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] "<span class="hljs-variable">$request</span>" '</span>                      <span class="hljs-string">'<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> "<span class="hljs-variable">$http_referer</span>" '</span>                      <span class="hljs-string">'"<span class="hljs-variable">$http_user_agent</span>" "<span class="hljs-variable">$http_x_forwarded_for</span>"'</span>;  <span class="hljs-comment">#æ—¥å¿—è·¯å¾„</span>  <span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;  <span class="hljs-attribute">sendfile</span>            <span class="hljs-literal">on</span>;  <span class="hljs-comment">#å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¶…æ—¶æ—¶é—´</span>  <span class="hljs-attribute">keepalive_timeout</span>   <span class="hljs-number">65</span>;  <span class="hljs-attribute">include</span> /etc/nginx/conf.d/ <span class="hljs-regexp">*.conf</span>;  <span class="hljs-section">server</span> &#123;        <span class="hljs-attribute">listen</span>       <span class="hljs-number">80</span> default_server;        <span class="hljs-attribute">listen</span>       [::]:<span class="hljs-number">80</span> default_server;        <span class="hljs-comment">#IPåœ°å€ã€åŸŸå</span>        <span class="hljs-attribute">server_name</span>  _;        <span class="hljs-attribute">root</span>         /usr/share/nginx/html;        <span class="hljs-comment">#åŠ è½½é»˜è®¤æœåŠ¡å™¨å—çš„é…ç½®æ–‡ä»¶ã€‚</span>        <span class="hljs-attribute">include</span> /etc/nginx/default.d/ <span class="hljs-regexp">*.conf</span>;    <span class="hljs-comment">#locationå¯ä»¥æœ‰å¤šä¸ªï¼Œè¿™é‡Œè¯´å¦‚æœè®¿é—®çš„æ˜¯'/'ï¼Œå°±ä¼šå®šå‘åˆ°'/usr/share/nginx/html/index.html'</span>        <span class="hljs-attribute">location</span> / &#123;      <span class="hljs-comment">#root/usr/share/nginx/html;</span>      <span class="hljs-comment">#å¦‚æœæ²¡æœ‰æ‰¾åˆ°index.htmlï¼Œå°±ä¼šä½¿ç”¨index.htm</span>      <span class="hljs-comment">#indexindex.htmlindex.htm;</span>        &#125;            <span class="hljs-attribute">error_page</span> <span class="hljs-number">404</span> /<span class="hljs-number">404</span>.html;    <span class="hljs-attribute">location</span> = /40x.html &#123;        &#125;         <span class="hljs-attribute">error_page</span> <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span> /50x.html;    <span class="hljs-attribute">location</span> = /50x.html &#123;      <span class="hljs-comment">#root/usr/share/nginx/html;</span>        &#125;    &#125;&#125;</code></pre><h1 id="æ—¥å¿—log-format"><a href="#æ—¥å¿—log-format" class="headerlink" title="æ—¥å¿—log_format"></a>æ—¥å¿—log_format</h1><h2 id="æ—¥å¿—ç±»å‹"><a href="#æ—¥å¿—ç±»å‹" class="headerlink" title="æ—¥å¿—ç±»å‹"></a>æ—¥å¿—ç±»å‹</h2><ul><li>error.logï¼šè®°å½•å¤„ç†è¯·æ±‚é”™è¯¯çš„çŠ¶æ€å’ŒNginxæœ¬èº«æœåŠ¡çš„é”™è¯¯çŠ¶æ€</li><li>access_logï¼šè®°å½•httpè¯·æ±‚çš„è®¿é—®çŠ¶æ€ï¼Œä¸»è¦ç”¨äºåˆ†ææ¯ä¸€æ¬¡è¯·æ±‚å’Œå®¢æˆ·çš„äº¤äº’å’Œå¯¹è¡Œä¸ºçš„åˆ†æ</li></ul><p>Nginxæ˜¯å¦‚ä½•å®ç°è¿™äº›æ—¥å¿—çš„å‘¢ï¼Ÿ</p><p>ä¸»è¦ä¾èµ–äºlog_formaté…ç½®ï¼Œnginxçš„logä¸­è®°å½•äº†å¾ˆçš„ä¿¡æ¯ï¼Œæ¯ä¸€ä¸ªä¿¡æ¯å¯ä»¥ç†è§£æˆéƒ½æ˜¯Nginxé‡Œé¢çš„å¯¹åº”çš„å˜é‡ï¼Œlog_formatå°±æ˜¯æŠŠè¿™äº›å˜é‡ç»„ç»‡åˆ°ä¸€èµ· ï¼Œè®°å½•åˆ°access_logä¸­å»</p><p>log_formatçš„é…ç½®è¯­æ³•</p><ul><li>Syntax: log_format name [escape=default l json] string    â€¦â€¦;</li><li>Default: log_format combined    â€œâ€¦â€;</li><li>Context:http</li></ul><h2 id="nginx-confä¸­é…ç½®"><a href="#nginx-confä¸­é…ç½®" class="headerlink" title="nginx.confä¸­é…ç½®"></a>nginx.confä¸­é…ç½®</h2><pre><code class="hljs nginx"><span class="hljs-attribute">error_log</span> /var/log/nginx/error.log [level];http&#123;    <span class="hljs-attribute">access_log</span>  /var/log/nginx/access.log  main;  &#125;</code></pre><h2 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h2><p>å¯¹äºlog_formatæ¥è¯´ï¼Œå®ƒæœ‰å¾ˆå¤šçš„å˜é‡ï¼Œä¾‹å¦‚ï¼š</p><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">'<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] "<span class="hljs-variable">$request</span>" '</span>                      <span class="hljs-string">'<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> "<span class="hljs-variable">$http_referer</span>" '</span>                      <span class="hljs-string">'"<span class="hljs-variable">$http_user_agent</span>" "<span class="hljs-variable">$http_x_forwarded_for</span>"'</span>;&#125;</code></pre><p>è¿™é‡Œåšäº†ä¸€ä¸ªåˆ†ç±»</p><ul><li>HTTPè¯·æ±‚å˜é‡ ï¼šarg_PARAMETERã€http_HEADERã€sent_http_HEADER<ul><li>http_HEADERï¼šrequestçš„Headerè¾“å‡º</li><li>sent_http_HEADERï¼šresponseçš„Headerå¤„ç†</li></ul></li><li>å†…ç½®å˜é‡ï¼šNginxå†…ç½®çš„ï¼Œè¿™é‡Œç”±äºå˜é‡å¾ˆå¤šï¼Œéœ€è¦äº†è§£å¯ä»¥å»çœ‹<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_status" target="_blank" rel="noopener">æ–‡æ¡£</a></li><li>è‡ªå®šä¹‰å˜é‡ï¼šè‡ªå·±å®šä¹‰</li></ul><hr><p>è¿™é‡Œä»¥<code>http_HEADER</code>åšä¸ªä¾‹å­ï¼šåœ¨æ—¥å¿—ä¸­æ‰“å°ç”¨æˆ·ä»£ç†ï¼Œåœ¨Requestä¸­ä¼šæœ‰ä¸€ä¸ªUser-Agentï¼Œå®ƒå°±æ˜¯ç”¨æˆ·ä»£ç†çš„ä¿¡æ¯ï¼Œæˆ‘å¸Œæœ›èƒ½åœ¨æ—¥å¿—ä¸­è¾“å‡ºå®ƒï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p><pre><code class="hljs nginx"><span class="hljs-section">http</span> &#123;    <span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">'<span class="hljs-variable">$http_user_agent</span>'</span> ...&#125;</code></pre><p>æ•ˆæœï¼š</p><pre><code class="hljs bash"><span class="hljs-comment">#ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä¹‹åéœ€è¦é‡è½½</span>~&gt; nginx -s reload -c /etc/nginx/nginx.conf ~&gt; curl localhost~&gt; tail -f /var/<span class="hljs-built_in">log</span>/nginx/access.logcurl/7.29.0curl/7.29.0::1 ...</code></pre><p>å…³äºNginxå˜é‡æœ‰å¾ˆå¤šç§ç±»å‹ï¼Œè¿™é‡Œç»™å®ƒè¿›è¡Œåˆ†ç±»ï¼š</p><ul><li>HTTPè¯·æ±‚å˜é‡ï¼šarg_PAPARMTERã€http_HEADERã€set_http_HEADER</li><li>å†…ç½®å˜é‡ï¼šNginxå†…ç½®å˜é‡<a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#var_status" target="_blank" rel="noopener">æ–‡æ¡£</a></li><li>è‡ªå®šä¹‰å˜é‡ï¼šè‡ªå·±å®šä¹‰ã€‚è¿™ä¸ªä¼šåœ¨luaç« èŠ‚ä¸­æåˆ°</li></ul><p>è¿™é‡Œæ¥ä»‹ç»ä¸€ä¸‹nginx.confä¸­é»˜è®¤ä½¿ç”¨çš„ä¸€äº›å˜é‡</p><pre><code class="hljs nginx"><span class="hljs-attribute">log_format</span>  main  <span class="hljs-string">'<span class="hljs-variable">$http_user_agent</span>'</span> <span class="hljs-string">'<span class="hljs-variable">$http_user_agent</span>'</span> <span class="hljs-string">'<span class="hljs-variable">$remote_addr</span> - <span class="hljs-variable">$remote_user</span> [<span class="hljs-variable">$time_local</span>] "<span class="hljs-variable">$request</span>" '</span>                      <span class="hljs-string">'<span class="hljs-variable">$status</span> <span class="hljs-variable">$body_bytes_sent</span> "<span class="hljs-variable">$http_referer</span>" '</span>                      <span class="hljs-string">'"<span class="hljs-variable">$http_user_agent</span>" "<span class="hljs-variable">$http_x_forwarded_for</span>"'</span>;</code></pre><ul><li>remote_addrï¼šå®¢æˆ·ç«¯åœ°å€</li><li>remote_userï¼šhttpå®¢æˆ·ç«¯è¯·æ±‚è®¤è¯çš„ç”¨æˆ·åï¼Œé»˜è®¤æ²¡æœ‰å¼€å¯è®¤è¯æ¨¡å—çš„è¯æ˜¯ä¸ä¼šæœ‰æ•ˆçš„</li><li>time_localï¼šæ—¶é—´</li><li>requestï¼šrequestå¤´çš„è¯·æ±‚è¡Œã€‚æ¯”å¦‚è¯·æ±‚æ–¹å¼ï¼šgetã€postï¼Œhttpçš„åè®®ç‰ˆæœ¬</li><li>statusï¼šresponseè¿”å›çš„çŠ¶æ€</li><li>body_bytes_sentï¼šä»æœåŠ¡ç«¯å“åº”ç»™å®¢æˆ·ç«¯bodyçš„å¤§å°</li><li>http_refererï¼šæ ‡å‡†httpå¤´ä¿¡æ¯ã€‚é‡è¦çš„è®°å½•ä¿¡æ¯ï¼Œåœ¨é˜²ç›—é“¾é‡Œé¢å¯¹ç”¨æˆ·è¿›è¡Œè¡Œä¸ºåˆ†æçš„æ—¶å€™è¿™ä¸ªä¼šç»å¸¸ä½¿ç”¨ã€‚å®ƒè¡¨ç¤ºä¸Šä¸€çº§é¡µé¢æ˜¯å“ªä¸€ä¸ªï¼Œæˆ‘ä»¬è®¿é—®å½“å‰è¿™çº§é¡µé¢é‚£ä¹ˆå®ƒçš„ä¸Šä¸€çº§é¡µé¢è¿™ä¸ªURLåœ°å€å°±ä¼šåšä¸ºhttp_refereråšè®°å½•</li><li>http_user_agentï¼šæ ‡å‡†httpå¤´ä¿¡æ¯ã€‚è¡¨ç¤ºå®¢æˆ·ç«¯çš„å†…å®¹ï¼Œæˆ‘ä»¬ç”¨çš„IEé‚£ä¹ˆå®ƒå°±æ‰“å°å¯¹åº”çš„IEçš„agentï¼Œå¦‚æœæ˜¯chromeå°±ä¼šæ˜¯chromeçš„agent</li><li>http_x_forwarded_forï¼šæ ‡å‡†httpå¤´ä¿¡æ¯ã€‚å®ƒä¼šè®°å½•æ¯ä¸€çº§ç”¨æˆ·é€šè¿‡httpè¯·æ±‚é‡Œé¢å¯¹åº”çš„æ‰€æºå¸¦çš„httpä¿¡æ¯</li></ul><h1 id="æ¨¡å—"><a href="#æ¨¡å—" class="headerlink" title="æ¨¡å—"></a>æ¨¡å—</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><strong>æ¨¡å—åˆ†ç±»</strong></p><ul><li>Nginxå®˜æ–¹æ¨¡å—ï¼šä¸‹è½½æºç åŒ…ä¸­æ‰€é»˜è®¤æºå¸¦çš„æ¨¡å—ï¼Œä»¥åŠåœ¨å®˜æ–¹é‡Œé¢æ˜å†™æ‰€æ”¯æŒçš„æ¨¡å—</li><li>ç¬¬ä¸‰æ–¹æ¨¡å—ï¼šæ²¡æœ‰å¾—åˆ°å®˜æ–¹é»˜è®¤æ”¯æŒçš„æ¨¡å—å±äºç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä¾‹å¦‚å…¶å®ƒå…¬å¸å¯¹Nginxåšçš„ä¸€äº›æ¨¡å—å¼€å‘å¼€æºå‡ºæ¥å¯ä»¥ä½¿ç”¨æˆ–è€…è‡ªå·±å¼€å‘çš„æ¨¡å—ã€‚è¿™ä¸ªä¼šåœ¨luaç« èŠ‚ä¸­æåˆ°</li></ul><hr><p>é€šè¿‡<code>nginx -V</code>å‘½ä»¤å°±èƒ½æŸ¥çœ‹åˆ°Nginxç¼–è¯‘çš„æ¨¡å—ï¼Œå®ƒä¼šä»¥<code>â€“with</code>å¼€å¤´</p><pre><code class="hljs bash">~&gt; nginx -V--with-file-aio --with-ipv6 --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-stream_ssl_preread_module --with-http_addition_module --with-http_xslt_module=dynamic --with-http_image_filter_module=dynamic --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_slice_module --with-http_stub_status_module --with-http_perl_module=dynamic --with-http_auth_request_module --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-google_perftools_module --with-debug --with-cc-opt=<span class="hljs-string">'-O2</span></code></pre><p>è¿™ç« ä¸ä¼šä»‹ç»å…¨éƒ¨ï¼Œåªä»‹ç»ä¸€äº›å¤§éƒ¨åˆ†æ‰€ç”¨åˆ°çš„æ¨¡å—ä»¥åŠå®ƒå¯¹åº”çš„é…ç½®</p><h2 id="stub-status"><a href="#stub-status" class="headerlink" title="stub_status"></a>stub_status</h2><p>è¿™ä¸ªæ¨¡å—ä¸»è¦ç”¨äºå±•ç¤ºNginxå½“å‰å¤„ç†è¿æ¥çš„çŠ¶æ€ï¼Œç”¨äºæˆ‘ä»¬ç›‘æ§Nginxå½“å‰çš„è¿æ¥ä¿¡æ¯ï¼Œé…ç½®è¯­æ³•å¦‚ä¸‹ï¼š</p><ul><li>Syntax: stub statusï¼›</li><li>Defaultï¼šâ€”â€”</li><li>Contextï¼šserverï¼Œlocation</li></ul><hr><p>nginx.confåŠ å…¥å†…å®¹</p><pre><code class="hljs nginx"><span class="hljs-comment">#å†…å®¹</span>server&#123;<span class="hljs-attribute">location</span> /mystatus &#123;                stub_status;        &#125;&#125;</code></pre><p> ç„¶åé‡è½½</p><pre><code class="hljs bash">~&gt; nginx -tc /etc/nginx/nginx.conf &amp;&amp; nginx -s reload -c /etc/nginx/nginx.confnginx: the configuration file /etc/nginx/nginx.conf syntax is oknginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in">test</span> is successful</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; curl localhost/mystatusActive connections: 3<span class="hljs-comment">#è¿æ¥çŠ¶æ€æ•° </span>server accepts handled requests<span class="hljs-comment">#å±•ç¤ºäº†3ä¸ªæ•°ï¼Œ1ï¼šNginxæ¡æ‰‹çš„æ€»æ¬¡æ•°ï¼Œ2ï¼šNginxè¿æ¥æ•°ï¼Œ3ï¼šæ€»è¯·æ±‚æ•°ã€‚åœ¨æ­£å¸¸æƒ…å†µè¿æ¥æ•°å’Œæ¡æ‰‹æ•°æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·è¡¨ç¤ºå®ƒæ²¡æœ‰ä¸¢å¤±</span> 6 6 3 Reading: 0 Writing: 1 Waiting: 2 <span class="hljs-comment">#è¡¨ç¤ºå½“å‰çŠ¶æ€ï¼ŒReadingï¼šè¯»çš„ä¸ªæ•°ï¼ŒWritingï¼šå†™çš„ä¸ªæ•°ï¼ŒWaitingï¼šåœ¨Nginxå¼€å¯äº†keepliveé•¿è¿æ¥çš„æƒ…å†µä¸‹ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ­£åœ¨ç©ºé—²çš„ç­‰å¾…ï¼Œæ—¢æ²¡æœ‰è¯»ä¹Ÿæ²¡æœ‰å†™ï¼Œä¸€ä¸ªå»ºç«‹è¿æ¥çš„æ•°é‡</span></code></pre><h2 id="random-index"><a href="#random-index" class="headerlink" title="random_index"></a>random_index</h2><p><strong>ç¼–è¯‘é€‰é¡¹</strong></p><p>â€“with-http_random_index_moduleï¼šç›®å½•ä¸­é€‰æ‹©ä¸€ä¸ªéšæœºä¸»é¡µ    </p><p><strong>é…ç½®è¯­æ³•random_index_module</strong></p><p>Syntaxï¼šrandom_index on | off;<br>Defaultï¼šrandom index off;<br>Contextï¼šlocation</p><hr><p><strong>æ¼”ç¤º</strong></p><p><code>/opt/app/code</code>ä¸‹é¢æœ‰3ä¸ªhtml</p><pre><code class="hljs bash">/opt/app/code&gt; <span class="hljs-built_in">echo</span> 1 &gt; 1.html/opt/app/code&gt; <span class="hljs-built_in">echo</span> 2 &gt; 2.html/opt/app/code&gt; <span class="hljs-built_in">echo</span> 3 &gt; 3.html</code></pre><p>nginx.conf</p><pre><code class="hljs lua">server&#123;location / &#123;    root /opt/app/code;    random_index on;  &#125;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; nginx -tc /etc/nginx/nginx.conf &amp;&amp; nginx -s reload -c /etc/nginx/nginx.confnginx: the configuration file /etc/nginx/nginx.conf syntax is oknginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in">test</span> is successful~&gt; curl localhost1~&gt; curl localhost2~&gt; curl localhost1~&gt; curl localhost2~&gt; curl localhost2</code></pre><blockquote><p>è¿™é‡Œæ³¨æ„ï¼šNginxä¸ä¼šéšæœºéšè—æ–‡ä»¶ï¼Œåªè¦æ–‡ä»¶å¼€å¤´æ˜¯ä»¥.xxxå°±ä¸ä¼šè¢«éšæœº</p></blockquote><h2 id="sub-module"><a href="#sub-module" class="headerlink" title="sub_module"></a>sub_module</h2><p><strong>ç¼–è¯‘é€‰é¡¹</strong></p><p>â€“with-http_sub_moduleï¼šç”¨äºNginxæœåŠ¡ç«¯åœ¨ç»™å®¢æˆ·ç«¯response httpçš„å†…å®¹æ—¶å€™ï¼Œç»™httpçš„å†…å®¹è¿›è¡Œæ›¿æ¢</p><p><strong>è¯­æ³•</strong></p><p>Syntax:ï¼šsub_filter string replacement;<br>Defaultï¼šâ€”â€”<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><p>Syntaxï¼šsub_filter_last_modified on | offï¼›<br>Defaultï¼šsub_filter_last modified offï¼›<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>ä½œç”¨ï¼šhttpå¤´ä¿¡æ¯çš„last-modifiedç”¨äºNginxæœåŠ¡ç«¯æ¥å®Œæˆå’Œå®¢æˆ·ç«¯è¿›è¡Œæ¯ä¸€æ¬¡è¯·æ±‚æ ¡éªŒæœåŠ¡ç«¯çš„å†…å®¹æ˜¯å¦æœ‰å‘ç”Ÿè¿‡å˜æ›´ï¼Œå…¶ç›®çš„æ˜¯å¦æœ‰æ›´æ–°ï¼Œå¦‚æœå‘ç”Ÿæ›´æ–°è¿”å›ç»™ç”¨æˆ·æœ€æ–°çš„å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰æ›´æ–°å°±ä¸éœ€è¦å†ä¸€æ¬¡è¿”å›htmlå†…å®¹ä»£ç æ¥å‡å°‘ä¸å¿…è¦çš„æ¶ˆè€—ï¼Œè¿™ä¸ªä¸»è¦ç”¨äºç¼“å­˜çš„åœºæ™¯é‡Œé¢ï¼Œè¿™ä¸ªä¼šåœ¨ç¼“å­˜ç« èŠ‚ä¸­è¿›è¡Œè¯´æ˜</p></blockquote><p>Syntaxï¼šsub_filter_once on off;<br>Defaultï¼šsub_filter_once on;<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>ä½œç”¨ï¼šåŒ¹é…æ‰€æœ‰htmlä»£ç çš„ç¬¬ä¸€ä¸ªè¿˜æ˜¯åŒ¹é…æ‰€æœ‰æŒ‡å®šçš„å­—ç¬¦ä¸²ï¼Œå¦‚æœæ˜¯onçš„è¯å°±åªåŒ¹é…ç¬¬ä¸€ä¸ªï¼Œå¦‚æœæ˜¯offçš„è¯ä¼šæŠŠæ‰€æœ‰htmlé‡Œé¢æŒ‡å®šçš„å†…å®¹éƒ½è¿›è¡Œä¸€æ¬¡åŒ¹é…</p></blockquote><p><strong>æ¼”ç¤º</strong></p><p>åˆ›å»ºä¸€ä¸ª<code>submodule.html</code></p><pre><code class="hljs bash">/opt/app/code&gt; cat submodule.html&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;at&lt;/a&gt;&lt;a&gt;mcr&lt;/a&gt;&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;mcr&lt;/a&gt;</code></pre><p>nginx.confä¿®æ”¹</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;<span class="hljs-attribute">root</span> /opt/app/code;  <span class="hljs-attribute">index</span> submodule.html;  <span class="hljs-attribute">sub_filter</span> <span class="hljs-string">'&lt;a&gt;mcr&lt;/a&gt;'</span> <span class="hljs-string">'&lt;h1&gt;MCR&lt;/h1&gt;'</span>;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; nginx -tc /etc/nginx/nginx.conf &amp;&amp; nginx -s reload -c /etc/nginx/nginx.confnginx: the configuration file /etc/nginx/nginx.conf syntax is oknginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in">test</span> is successful~&gt;  curl localhost&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;at&lt;/a&gt;&lt;a&gt;MCR&lt;/a&gt;&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;mcr&lt;/a&gt;</code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ä¸€ä¸ªmcråšäº†æ›¿æ¢ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿè¿™é‡Œéœ€è¦å°†sub_filter_onceå…³é—­</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;            <span class="hljs-attribute">root</span> /opt/app/code;            <span class="hljs-attribute">index</span> submodule.html;            <span class="hljs-attribute">sub_filter</span> <span class="hljs-string">'&lt;a&gt;mcr'</span> <span class="hljs-string">'&lt;a&gt;MCR'</span>;            <span class="hljs-attribute">sub_filter_once</span> <span class="hljs-literal">off</span>;        &#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; nginx -tc /etc/nginx/nginx.conf &amp;&amp; nginx -s reload -c /etc/nginx/nginx.confnginx: the configuration file /etc/nginx/nginx.conf syntax is oknginx: configuration file /etc/nginx/nginx.conf <span class="hljs-built_in">test</span> is successful~&gt; curl localhost&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;at&lt;/a&gt;&lt;a&gt;MCR&lt;/a&gt;&lt;a&gt;jeson&lt;/a&gt;&lt;a&gt;MCR&lt;/a&gt;</code></pre><h1 id="è¯·æ±‚é™åˆ¶"><a href="#è¯·æ±‚é™åˆ¶" class="headerlink" title="è¯·æ±‚é™åˆ¶"></a>è¯·æ±‚é™åˆ¶</h1><h2 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><ul><li>è¿æ¥é¢‘ç‡é™åˆ¶ï¼šlimit_conn_module</li><li>è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼šlimit_req_module</li></ul><p>ä»¥ä¸Š2ä¸ªmoduleéƒ½æ˜¯å¯ä»¥å®ç°Nginxçš„è¯·æ±‚é™åˆ¶ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°åŸæ¥æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿æ¥å’Œè¯·æ±‚æ˜¯æœ‰åŒºåˆ«çš„ï¼Œå…³äºè¿æ¥å’Œè¯·æ±‚çš„åŒºåˆ«ä»‹ç»ï¼š</p><p>httpè¯·æ±‚å»ºç«‹åœ¨tcpåè®®ä¸Šï¼Œè¦å®Œæˆä¸€æ¬¡httpè¯·æ±‚å…ˆè¦è¿›è¡Œtcpçš„3æ¬¡æ¡æ‰‹ï¼Œä¸‹é¢è¿™å¼ å›¾æè¿°äº†tcp3æ¬¡æ¡æ‰‹ï¼š</p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20200123111840894.png" srcset="/img/loading.gif" alt="image-20200123111840894" style="zoom:50%;" /><p>åœ¨å½“ä»Šçš„httpåè®®çš„æ—¶ä»£ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªè¿æ¥çš„åŸºç¡€ä¸Šå»ºç«‹å¤šæ¬¡è¯·æ±‚ï¼Œå¦‚ä¸Šé¢è¿™ä¸ªå›¾ï¼Œå…ˆè¿›è¡Œå®Œtcpè¿æ¥ä¹‹åç„¶åè¿›è¡Œhttpçš„è¯·æ±‚-å“åº”ï¼Œæœ€åç”¨å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ä¸æ–­çš„å‘é€FINã€ACKåŒ…æ¥ä¿æŒè¿æ¥çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„é•¿è¿æ¥ã€‚é€šè¿‡è¿™ä¸ªå›¾å¯ä»¥çŸ¥é“è¿æ¥æ˜¯ç”¨åœ¨httpè¯·æ±‚çš„åŸºç¡€ä¹‹ä¸Šã€‚</p><hr><p>åœ¨httpä¸åŒç‰ˆæœ¬çš„æ—¶å€™è¿æ¥å’Œ è¯·æ±‚å®ƒæœ‰å¯¹åº”çš„é™åˆ¶</p><ul><li>http1.0ï¼šTCPä¸èƒ½å¦ç”¨ã€‚å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€è¯·æ±‚ä»¥åï¼ŒæœåŠ¡ç«¯åœ¨å¯¹åº”çš„æ—¶é—´åæ–­å¼€ï¼Œä¸€æ¬¡è¿æ¥å¯¹åº”ä¸€æ¬¡è¯·æ±‚</li><li>http1.1ï¼šé¡ºåºæ€§TCPå¤ç”¨ã€‚ä¸€ä¸ªè¿æ¥å¯ä»¥é¡ºåºæ€§è¢«å¤ç”¨è€Œå‘é€å¤šæ¬¡httpè¯·æ±‚</li><li>http2.0ï¼šå¤šè·¯å¤ç”¨TCPå¤ç”¨ã€‚</li></ul><p>é€šè¿‡ä»¥ä¸Šå¾—å‡ºç»“è®ºï¼š</p><ul><li>httpè¯·æ±‚å»ºç«‹åœ¨ä¸€æ¬¡TCPè¿æ¥åŸºç¡€ä¸Š</li><li>ä¸€æ¬¡TCPè¯·æ±‚è‡³å°‘äº§ç”Ÿä¸€æ¬¡HTTPè¯·æ±‚ï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿå¤šæ¬¡HTTPè¯·æ±‚</li></ul><hr><p><strong>è¿æ¥é™åˆ¶</strong></p><p><strong>è¯­æ³•</strong></p><p>ï¼ˆ1ï¼‰</p><p>Syntaxï¼šlimit_conn_zone key zone=name:sizeï¼›<br>Defaultï¼šâ€”<br>Contextï¼šhttp</p><blockquote><p>è¿™é‡Œçš„é…ç½®è¯­æ³•è¿™ä¹ˆç†è§£ï¼šæ—¢ç„¶è¦å¯¹è¿æ¥è¿›è¡Œé™åˆ¶é‚£ä¹ˆå°±éœ€è¦å­˜å‚¨è¿æ¥çš„çŠ¶æ€ï¼Œé€šè¿‡IPä¸ºç©ºé—´è¿›è¡Œå­˜å‚¨ï¼Œè¿™é‡Œçš„limit_conn_zoneå°±æ˜¯å®ƒçš„ç©ºé—´ï¼Œè¿™é‡Œé€šè¿‡æ¯ä¸ªä½œä¸ºkeyï¼Œæ¯”å¦‚è¯´ï¼šæˆ‘æƒ³å¯¹å®¢æˆ·ç«¯çš„IPä½œä¸ºkeyï¼Œæˆ‘é™åˆ¶çš„å°±æ˜¯å®¢æˆ·ç«¯çš„ipï¼Œé‚£ä¹ˆæˆ‘å°±ä¼šæŠŠnginxå¯¹åº”remote_addrå†…ç½®å˜é‡ä½œä¸ºkeyï¼Œå¦‚æœæˆ‘ä»¬æƒ³ä»¥åˆ«çš„å†…ç½®å˜é‡æ¥ä½œä¸ºé™åˆ¶çš„æ—¶å€™åŒæ ·å¯ä»¥å†™åˆ°keyä¸‹é¢ã€‚</p><p>è¿™é‡Œçš„zoneåŠ äº†ä¸€ä¸ªåå­—ï¼Œè¿™ä¸ªæ˜¯ç”³è¯·ä¸€å—ç©ºé—´çš„zoneçš„åå­—ï¼Œè¿™ä¸ªåå­—æ˜¯ä¸ºäº†çœŸæ­£å®ç°é™åˆ¶çš„æ—¶å€™æ¥è°ƒç”¨è¿™ä¸ªç©ºé—´ï¼›sizeè¡¨ç¤ºç”³è¯·ç©ºé—´çš„å¤§å°</p></blockquote><p>ï¼ˆ2ï¼‰</p><p>Syntaxï¼šlimit_conn_zone number;<br>Defaultï¼šâ€”<br>Contextï¼šhttpï¼Œserverï¼Œlocation</p><blockquote><p>è¿™é‡Œçš„è¯­æ³•éœ€è¦ç»“åˆä¸Šé¢çš„ï¼Œå…ˆå®šä¹‰å¥½zoneæ‰èƒ½ä½¿ç”¨è¿™é‡Œçš„é…ç½®ï¼Œè¿™é‡Œåé¢ç›´æ¥åŠ çš„zoneï¼Œè¿™ä¸ªzoneå°±æ˜¯ä¸Šé¢çš„zoneçš„nameï¼Œnumberè¡¨ç¤ºé™åˆ¶å¹¶å‘æ•°ï¼Œæ¯”å¦‚æ˜¯1ï¼Œå°±å…è®¸æœŸé—´æœ‰1ä¸ª</p></blockquote><p><strong>è¯·æ±‚é™åˆ¶</strong></p><p><strong>è¯­æ³•</strong></p><p>(1)</p><p>Syntax: limit_reg_zone key zone =name:size rate=rate;<br>Defaultï¼šâ€”â€”<br>Contextï¼šhttp</p><blockquote><p>è¿™é‡Œå’Œè¿æ¥é™åˆ¶çš„è¯­æ³•æ„æ€æ˜¯ä¸€æ ·çš„ï¼Œrateæ˜¯å”¯ä¸€çš„åŒºåˆ«ï¼Œè¿™ä¸ªåœ°æ–¹æ˜¯å…ˆå®šä¹‰å¥½çš„ï¼Œæˆ‘å¯¹äºè¿™ä¸ªè¯·æ±‚æˆ‘çš„é™åˆ¶æ˜¯å¤šå¤§ï¼Œé€šå¸¸æ˜¯ä»¥ç§’ä¸ºå•ä½ï¼Œç„¶åè¯·æ±‚é™åˆ¶æ˜¯å¤šå°‘ä¸ªï¼Œè¿™é‡Œçš„æ„æ€æ˜¯å•ä½</p></blockquote><p>(2)</p><p>Syntax: limit_req zone=name [burst=number] [nodelay];<br>Defaultï¼šâ€”â€”</p><p>Contextï¼šhttpï¼Œserverï¼Œlocation</p><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><h3 id="è¯·æ±‚é™åˆ¶-1"><a href="#è¯·æ±‚é™åˆ¶-1" class="headerlink" title="è¯·æ±‚é™åˆ¶"></a>è¯·æ±‚é™åˆ¶</h3><p>nginx.conf#http</p><pre><code class="hljs nginx"><span class="hljs-attribute">limit_conn_zone</span> <span class="hljs-variable">$binary_remote_addr</span> zone=conn_zone:<span class="hljs-number">1m</span>;<span class="hljs-comment">#è¿™é‡Œçš„binary_remote_addrå’Œremote_addræ˜¯ä¸€ä¸ªæ„æ€ï¼Œä½†æ˜¯æˆ‘ä»¬åœ¨è¿™ä¸ªåœ°æ–¹æ˜¯éœ€è¦å®šä¹‰å®ƒçš„zoneé‡Œé¢ï¼Œæˆ‘ä»¬çŸ¥é“è¿™ä¸ªzoneå¤§å°è®¾ç½®çš„æ˜¯1MB,å¯¹äº1MBç©ºé—´è¦å­˜å‚¨remote_addrä¼šæ¯”binary_remote_addrä¼šè¦å¤š10ä¸ªå­—èŠ‚</span><span class="hljs-comment">#é™åˆ¶åŒä¸€ä¸ªIPåœ°å€ï¼Œæ‰€æœ‰çš„è¯·æ±‚é™åˆ¶åœ¨1ç§’çš„æ—¶å€™å†…å‘èµ·ä¸€ä¸ª</span><span class="hljs-attribute">limit_req_zone</span>  <span class="hljs-variable">$binary_remote_addr</span> zone=req_zone:<span class="hljs-number">1m</span> rate=1r/s;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash"><span class="hljs-comment">#-n xx :æ€»å…±å‘èµ·è¯·æ±‚æ•°ï¼Œ-c xxï¼šå¹¶å‘æ•°</span>~&gt; ab -n 40 -c 20 http://localhost/index.htmlå¹¶å‘çº§åˆ«:20æ£€æµ‹æ—¶é—´:0.002ç§’å®Œæˆè¦æ±‚:40å¤±è´¥çš„è¯·æ±‚:0å†™é”™è¯¯:0ä¼ è¾“æ€»é‡:202720å­—èŠ‚ä¼ è¾“çš„HTML: 193320å­—èŠ‚æ¯ç§’è¯·æ±‚æ•°:16508.46[<span class="hljs-comment">#/ç§’](å¹³å‡)</span>æ¯æ¬¡è¯·æ±‚æ‰€éœ€æ—¶é—´:1.211 [ms](å¹³å‡å€¼)æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´:0.061 [ms](æ‰€æœ‰å¹¶å‘è¯·æ±‚çš„å¹³å‡æ—¶é—´)ä¼ è¾“é€Ÿç‡:81703.98 [Kbytes/sec]æ¥æ”¶</code></pre><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;<span class="hljs-attribute">limit_req</span> zone=req_zone;&#125;</code></pre><pre><code class="hljs bash">~&gt; ab -n 40 -c 20 http://localhost/index.htmlå¹¶å‘çº§åˆ«:20æ£€æµ‹æ—¶é—´:0.002ç§’å®Œæˆè¦æ±‚:40å¤±è´¥çš„è¯·æ±‚:39(Connect: 0, Receive: 0, Length: 39, Exceptions: 0)å†™é”™è¯¯:0Non-2xxååº”:39ä¼ è¾“æ€»é‡:156700å­—èŠ‚HTMLä¼ è¾“:148860å­—èŠ‚æ¯ç§’è¯·æ±‚æ•°:18674.14[<span class="hljs-comment">#/ç§’](å¹³å‡)</span>æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´:1.071 [ms](å¹³å‡å€¼)æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´:0.054 [ms](æ‰€æœ‰å¹¶å‘è¯·æ±‚çš„å¹³å‡æ—¶é—´)ä¼ è¾“é€Ÿç‡:71441.34 [Kbytes/sec]æ¥æ”¶<span class="hljs-comment">#è¯·æ±‚å¤±è´¥çš„éƒ½ä¼šå¯ä»¥åœ¨æ—¥å¿—ä¸­æŸ¥åˆ°</span>~&gt; tail -f /var/<span class="hljs-built_in">log</span>/nginx/error.log 020/01/23 16:02:32 [notice] 2651<span class="hljs-comment">#0: signal process started</span>2020/01/23 16:02:51 [error] 2654<span class="hljs-comment">#0: *648 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:02:51 [error] 2652<span class="hljs-comment">#0: *653 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>...</code></pre><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> / &#123;  <span class="hljs-comment">#limit_conn conn_zone;</span>  <span class="hljs-comment">#burst=3ï¼šå®¢æˆ·ç«¯åœ¨è¶…è¿‡æŒ‡å®šçš„æ•°æ®ä»¥åï¼Œé—ç•™çš„3ä¸ªä¼šæ”¾åˆ°ä¸‹ä¸€ç§’æ‰§è¡Œï¼Œä¿è¯è¿™3ä¸ªåœ¨åä¸€ç§’æ‰§è¡Œï¼Œå¯¹å®¢æˆ·ç«¯èµ·åˆ°è®¿é—®é™é€Ÿçš„ä½œç”¨ä¹Ÿå°±æ˜¯å»¶è¿Ÿå“åº”ï¼Œåœ¨è¶…è¿‡3ä¸ªæ—¶å€™ä¼šnodelayï¼Œç›´æ¥è¿”å›503</span>  <span class="hljs-attribute">limit_req</span> zone=req_zone burst=<span class="hljs-number">3</span> nodelay;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; ab -n 40 -c 20 http://localhost/index.htmlå¹¶å‘çº§åˆ«:20æ£€æµ‹æ—¶é—´:0.003ç§’å®Œæˆè¦æ±‚:40å¤±è´¥çš„è¯·æ±‚:36(Connect: 0, Receive: 0, Length: 36, Exceptions: 0)å†™é”™è¯¯:0Non-2xxååº”:36ä¼ è¾“æ€»é‡:160240å­—èŠ‚ä¼ è¾“çš„HTML: 152280å­—èŠ‚æ¯ç§’è¯·æ±‚æ•°:12418.50[<span class="hljs-comment">#/ç§’](å¹³å‡)</span>æ¯æ¬¡è¯·æ±‚æ‰€éœ€æ—¶é—´:1.611 [ms](å¹³å‡å€¼)æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´:0.081 [ms](æ‰€æœ‰å¹¶å‘è¯·æ±‚çš„å¹³å‡æ—¶é—´)ä¼ è¾“é€Ÿç‡:48582.54 [Kbytes/sec]æ¥æ”¶</code></pre><h3 id="è¿æ¥é™åˆ¶"><a href="#è¿æ¥é™åˆ¶" class="headerlink" title="è¿æ¥é™åˆ¶"></a>è¿æ¥é™åˆ¶</h3><p>nginx.conf#server</p><pre><code class="hljs bash">location / &#123;<span class="hljs-comment">#limit_req zone=req_zone;</span>limit_conn conn_zone 1;&#125;</code></pre><blockquote><p>è¿æ¥çš„é™åˆ¶æ˜¯æŒ‡æœåŠ¡ç«¯åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€ä¸ªIPçš„è¿æ¥è¿‡æ¥</p></blockquote><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; ab -n 20 -c 20 http://localhost/index.htmlå¹¶å‘çº§åˆ«:20æ£€æµ‹æ—¶é—´:0.002ç§’å®Œæˆè¦æ±‚:20å¤±è´¥çš„è¯·æ±‚:6(Connect: 0, Receive: 0, Length: 6, Exceptions: 0)å†™é”™è¯¯:0Non-2xxååº”:6ä¼ è¾“æ€»é‡:94280å­—èŠ‚HTMLä¼ è¾“:89820å­—èŠ‚æ¯ç§’è¯·æ±‚æ•°:9237.88[<span class="hljs-comment">#/ç§’](å¹³å‡)</span>æ¯æ¬¡è¯·æ±‚æ‰€éœ€æ—¶é—´:2.165 [ms](å¹³å‡å€¼)æ¯ä¸ªè¯·æ±‚çš„æ—¶é—´:0.108 [ms](æ‰€æœ‰å¹¶å‘è¯·æ±‚çš„å¹³å‡æ—¶é—´)ä¼ è¾“é€Ÿç‡:42526.70 [Kbytes/sec]æ¥æ”¶<span class="hljs-comment">#è¿™é‡Œå¯ä»¥çœ‹ä¸‹æ—¥å¿—ï¼Œä¸Šé¢è¯´åŒºåŸŸé™åˆ¶è¿æ¥â€œconn_zoneâ€ï¼Œå°±è¡¨ç¤ºå‰é¢çš„é…ç½®ç”Ÿæ•ˆäº†</span>2020/01/23 16:24:35 [error] 2732<span class="hljs-comment">#0: *831 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:24:35 [error] 2732<span class="hljs-comment">#0: *838 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:24:35 [error] 2733<span class="hljs-comment">#0: *830 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:24:35 [error] 2733<span class="hljs-comment">#0: *832 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:24:35 [error] 2733<span class="hljs-comment">#0: *833 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span>2020/01/23 16:24:35 [error] 2734<span class="hljs-comment">#0: *843 limiting connections by zone "conn_zone", client: ::1, server: _, request: "GET /index.html HTTP/1.0", host: "localhost"</span></code></pre><h1 id="è®¿é—®æ§åˆ¶"><a href="#è®¿é—®æ§åˆ¶" class="headerlink" title="è®¿é—®æ§åˆ¶"></a>è®¿é—®æ§åˆ¶</h1><h2 id="ä»‹ç»-2"><a href="#ä»‹ç»-2" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å…³äºhttpè®¿é—®æ§åˆ¶ï¼Œåœ¨Nginxä¸­æä¾›äº†ä»¥ä¸‹æ¨¡å—ï¼š</p><ul><li>åŸºäºIPçš„è®¿é—®æ§åˆ¶ï¼šhttp_access_module</li><li>åŸºäºç”¨æˆ·çš„ä¿¡ä»»ç™»å½•ï¼šhttp_auth_basic_module</li></ul><h2 id="access-module"><a href="#access-module" class="headerlink" title="access_module"></a>access_module</h2><p><strong>è¯­æ³•</strong></p><p>(1)</p><p>Syntaxï¼šallow address | CIDR | unix: | allï¼›</p><p>Defaultï¼šâ€”â€”</p><p>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œlimit_except</p><ul><li>allow addressï¼šå…è®¸æŸä¸ªåœ°å€</li><li>CIDR ï¼šç½‘æ®µæ–¹å¼è¿›è¡Œé…ç½®ã€‚ä¾‹å¦‚ï¼š192.168.1.0/24ï¼Œå…è®¸è¿™ä¸€ä¸ªç½‘æ®µè¿›è¡Œè®¿é—®</li><li>unixï¼šåœ¨Nginxçš„limitä¸Šsocketæ–¹å¼è®¿é—®</li><li>allï¼šå…è®¸æ‰€æœ‰çš„</li></ul><p>(2)</p><p>Syntaxï¼š deny address | CIDR | unix: | allï¼›</p><p>Defaultï¼šâ€”â€”</p><p>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œlimit_except</p><ul><li>deny address ï¼šä¸å…è®¸å“ªäº›IPè®¿é—®  </li></ul><p><strong>æ¼”ç¤º</strong></p><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/admin.html</span>&#123;                <span class="hljs-attribute">root</span> /opt/app/code;                <span class="hljs-attribute">deny</span> all;&#125;</code></pre><p>æµ‹è¯•</p><pre><code class="hljs bash">~&gt; curl localhost/admin.html&lt;html&gt;&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;&lt;hr&gt;&lt;center&gt;nginx/1.16.1&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><p><strong>å±€é™æ€§</strong></p><blockquote><p>æš‚æ— </p></blockquote><h2 id="http-auth-basic-module"><a href="#http-auth-basic-module" class="headerlink" title="http_auth_basic_module"></a>http_auth_basic_module</h2><p><strong>è¯­æ³•</strong></p><p>(1)</p><p>Syntaxï¼šauth_basic string | off;<br>Defaultï¼šauth_basic off;<br>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œlimit_except</p><blockquote><p>stringï¼šç™»å½•æç¤ºï¼›</p><p>è¿™ä¸ªé…ç½®é»˜è®¤æ˜¯å…³é—­çš„â€œoffâ€ï¼Œå¦‚æœéœ€è¦ å¼€å¯å®ƒï¼Œå°†offæ”¹ä¸ºå­—ç¬¦ä¸²å³å¯</p></blockquote><p>(2)</p><p>Syntaxï¼šauth_basic_user_file file;<br>Defaultï¼šâ€”â€”<br>Contextï¼šhttpï¼Œserverï¼Œlocationï¼Œlimit_except</p><blockquote><p>fileï¼šæ–‡ä»¶é…ç½®è·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„çš„æ–‡ä»¶è¦æ¥å­˜å‚¨ç”¨æˆ·åå’Œå¯†ç ä¿¡æ¯</p></blockquote><p>è¯¦ç»†çš„ä»‹ç»ï¼š<a href="https://nginx.org/en/docs/http/ngx_http_auth_basic_module.html" target="_blank" rel="noopener">æ–‡æ¡£</a></p><p><strong>æ¼”ç¤º</strong></p><p>å®˜æ–¹è¦æ±‚æ–‡ä»¶çš„å¯†ç éœ€è¦é€šè¿‡<code>crypt</code>å‡½æ•°åŠ å¯†ï¼Œè¿™é‡Œå¯ä»¥åœ¨ä½ çš„æœåŠ¡å™¨ä¸­ä½¿ç”¨<code>htpasswd</code> ï¼Œè¿™é‡Œå…ˆä¸‹è½½ä¸€ä¸‹</p><pre><code class="hljs bash">~&gt; yum install  -y httpd-tools -y</code></pre><p>é€šè¿‡<code>htpasswd</code> æ¥ç”Ÿæˆæ–‡ä»¶</p><pre><code class="hljs bash">/etc/nginx&gt; htpasswd  -c ./auth_conf shuiNew password: 123456 Re-type new password: 123456 Adding password <span class="hljs-keyword">for</span> user shui</code></pre><p>nginx.conf#server</p><pre><code class="hljs nginx"><span class="hljs-attribute">location</span> <span class="hljs-regexp">~ ^/admin.html</span>&#123;                <span class="hljs-attribute">root</span> /opt/app/code;                <span class="hljs-attribute">auth_basic</span> <span class="hljs-string">"Please enter your account password!"</span>;                <span class="hljs-attribute">auth_basic_user_file</span> /etc/nginx/auth_conf;&#125;</code></pre><p><strong>å±€é™æ€§</strong></p><blockquote><p>æš‚æ— </p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Nginxã€‘ 1.ç¯å¢ƒå‡†å¤‡</title>
    <link href="/nginx-1.html"/>
    <url>/nginx-1.html</url>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒè°ƒè¯•ç¡®è®¤"><a href="#ç¯å¢ƒè°ƒè¯•ç¡®è®¤" class="headerlink" title="ç¯å¢ƒè°ƒè¯•ç¡®è®¤"></a>ç¯å¢ƒè°ƒè¯•ç¡®è®¤</h1><p><strong>ä¸¤é¡¹å®‰è£…</strong></p><pre><code class="hljs bash">~&gt; yum -y install  gcc gcc-c++ autoconf pcre pcre-devel make automake~&gt; yum -y install wget httpd-tools vim</code></pre><p><strong>ä¸€æ¬¡åˆå§‹åŒ–</strong></p><pre><code class="hljs bash">~&gt; <span class="hljs-built_in">cd</span> /opt &amp;&amp; mkdir app download logs work backup</code></pre><p><strong>ç›®å½•ä»‹ç»</strong></p><pre><code class="hljs lua">optâ”œâ”€â”€ app<span class="hljs-comment">-- å­˜æ”¾ä»£ç </span>â”œâ”€â”€ download<span class="hljs-comment">-- å­˜æ”¾æºç åŒ… </span>â”œâ”€â”€ logs<span class="hljs-comment">--å­˜æ”¾è‡ªå®šä¹‰æ—¥å¿—</span>â”œâ”€â”€ work<span class="hljs-comment">--å­˜æ”¾shellè„šæœ¬</span>â””â”€â”€ backup<span class="hljs-comment">--å­˜æ”¾é»˜è®¤é…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ä¸€äº›æ–‡ä»¶éœ€è¦è¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œå­˜æ”¾å®ƒçš„ä¸€ä¸ªé»˜è®¤é…ç½®</span></code></pre><p><strong>å…¶å®ƒ</strong></p><pre><code class="hljs bash"><span class="hljs-comment">#å…³é—­ã€ç¦ç”¨é˜²ç«å¢™</span>~&gt; systemctl  <span class="hljs-built_in">disable</span> firewalld.service &amp;&amp; systemctl  stop  firewalld.service<span class="hljs-comment">#æŸ¥çœ‹SLinuxæ˜¯å¦å¼€å¯</span>~&gt; getenforceEnforcing<span class="hljs-comment">#å…³é—­SLinux</span>~&gt; setenforce 0</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Nginx</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€Linuxã€‘ Linuxåˆå§‹åŒ–å¿…åšçš„ä¸€äº›äº‹æƒ…</title>
    <link href="/linux-1.html"/>
    <url>/linux-1.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ›¿æ¢yumæº"><a href="#æ›¿æ¢yumæº" class="headerlink" title="æ›¿æ¢yumæº"></a>æ›¿æ¢yumæº</h1><p><a href="https://idc.wanyunshuju.com/yum/851.html" target="_blank" rel="noopener">é“¾æ¥</a></p><h1 id="è®¾ç½®é™æ€IP"><a href="#è®¾ç½®é™æ€IP" class="headerlink" title="è®¾ç½®é™æ€IP"></a>è®¾ç½®é™æ€IP</h1><pre><code class="hljs bash">vim /etc/sysconfig/network-scripts/ifcfg-ens33<span class="hljs-comment">#å†…å®¹ï¼š</span>BOOTPROTO=<span class="hljs-string">"static"</span> <span class="hljs-comment">#dhcpæ”¹ä¸ºstatic </span>ONBOOT=<span class="hljs-string">"yes"</span> <span class="hljs-comment">#å¼€æœºå¯ç”¨æœ¬é…ç½®</span>IPADDR=192.168.202.106 <span class="hljs-comment">#é™æ€IP</span>GATEWAY=192.168.7.1 <span class="hljs-comment">#é»˜è®¤ç½‘å…³</span>NETMASK=255.255.255.0 <span class="hljs-comment">#å­ç½‘æ©ç </span>DNS1=192.168.202.1 <span class="hljs-comment">#DNS é…ç½®</span></code></pre><h1 id="è‡ªåŠ¨è¡¥å…¨"><a href="#è‡ªåŠ¨è¡¥å…¨" class="headerlink" title="è‡ªåŠ¨è¡¥å…¨"></a>è‡ªåŠ¨è¡¥å…¨</h1><pre><code class="hljs bash">yum -y install bash-completion</code></pre><h1 id="ä¿®æ”¹ä¸»æœºåï¼ˆHostNameï¼‰"><a href="#ä¿®æ”¹ä¸»æœºåï¼ˆHostNameï¼‰" class="headerlink" title="ä¿®æ”¹ä¸»æœºåï¼ˆHostNameï¼‰"></a>ä¿®æ”¹ä¸»æœºåï¼ˆHostNameï¼‰</h1><pre><code class="hljs bash">hostnamectl <span class="hljs-built_in">set</span>-hostname <span class="hljs-variable">$&#123;name&#125;</span> ...</code></pre><h1 id="å®‰è£…ä¾èµ–åŒ…"><a href="#å®‰è£…ä¾èµ–åŒ…" class="headerlink" title="å®‰è£…ä¾èµ–åŒ…"></a>å®‰è£…ä¾èµ–åŒ…</h1><pre><code class="hljs bash">yum install -y conntrack ntpdate ntp ipvsadm ipset jq  curl sysstat libseccomp wget vim net-tools git</code></pre><h1 id="å…³é—­-SELINUX"><a href="#å…³é—­-SELINUX" class="headerlink" title="å…³é—­ SELINUX"></a>å…³é—­ SELINUX</h1><pre><code class="hljs bash">swapoff -a &amp;&amp; sed -i <span class="hljs-string">'/ swap / s/^\(.*\)$/#\1/g'</span> /etc/fstabsetenforce 0 &amp;&amp; sed -i <span class="hljs-string">'s/^SELINUX=.*/SELINUX=disabled/'</span> /etc/selinux/config</code></pre><h1 id="è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº-K8S"><a href="#è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº-K8S" class="headerlink" title="è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº K8S"></a>è°ƒæ•´å†…æ ¸å‚æ•°ï¼Œå¯¹äº K8S</h1><pre><code class="hljs bash">cat &gt; kubernetes.conf &lt;&lt;EOFnet.bridge.bridge-nf-call-iptables=1net.bridge.bridge-nf-call-ip6tables=1net.ipv4.ip_forward=1net.ipv4.tcp_tw_recycle=0vm.swappiness=0 <span class="hljs-comment"># ç¦æ­¢ä½¿ç”¨ swap ç©ºé—´ï¼Œåªæœ‰å½“ç³»ç»Ÿ OOM æ—¶æ‰å…è®¸ä½¿ç”¨å®ƒ</span>vm.overcommit_memory=1 <span class="hljs-comment"># ä¸æ£€æŸ¥ç‰©ç†å†…å­˜æ˜¯å¦å¤Ÿç”¨</span>vm.panic_on_oom=0 <span class="hljs-comment"># å¼€å¯ OOM</span>fs.inotify.max_user_instances=8192fs.inotify.max_user_watches=1048576fs.file-max=52706963fs.nr_open=52706963net.ipv6.conf.all.disable_ipv6=1net.netfilter.nf_conntrack_max=2310720EOFcp kubernetes.conf /etc/sysctl.d/kubernetes.confsysctl -p /etc/sysctl.d/kubernetes.conf</code></pre><h1 id="è°ƒæ•´ç³»ç»Ÿæ—¶åŒº"><a href="#è°ƒæ•´ç³»ç»Ÿæ—¶åŒº" class="headerlink" title="è°ƒæ•´ç³»ç»Ÿæ—¶åŒº"></a>è°ƒæ•´ç³»ç»Ÿæ—¶åŒº</h1><pre><code class="hljs dsconfig"><span class="hljs-comment"># è®¾ç½®ç³»ç»Ÿæ—¶åŒºä¸º ä¸­å›½/ä¸Šæµ·</span><span class="hljs-string">timedatectl </span><span class="hljs-built_in">set-timezone</span> <span class="hljs-string">Asia/</span><span class="hljs-string">Shanghai</span><span class="hljs-string">#</span> å°†å½“å‰çš„ <span class="hljs-string">UTC </span>æ—¶é—´å†™å…¥ç¡¬ä»¶æ—¶é’Ÿ<span class="hljs-string">timedatectl </span><span class="hljs-built_in">set-local-rtc</span> 0<span class="hljs-comment"># é‡å¯ä¾èµ–äºç³»ç»Ÿæ—¶é—´çš„æœåŠ¡</span><span class="hljs-string">systemctl </span><span class="hljs-string">restart </span><span class="hljs-string">rsyslog</span><span class="hljs-string">systemctl </span><span class="hljs-string">restart </span><span class="hljs-string">crond</span></code></pre><h1 id="å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡"><a href="#å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡" class="headerlink" title="å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡"></a>å…³é—­ç³»ç»Ÿä¸éœ€è¦æœåŠ¡</h1><pre><code class="hljs bash">systemctl stop postfix &amp;&amp; systemctl <span class="hljs-built_in">disable</span> postfix</code></pre><h1 id="è®¾ç½®-rsyslogd-å’Œ-systemd-journald"><a href="#è®¾ç½®-rsyslogd-å’Œ-systemd-journald" class="headerlink" title="è®¾ç½® rsyslogd å’Œ systemd journald"></a>è®¾ç½® rsyslogd å’Œ systemd journald</h1><pre><code class="hljs bash">mkdir /var/<span class="hljs-built_in">log</span>/journal <span class="hljs-comment"># æŒä¹…åŒ–ä¿å­˜æ—¥å¿—çš„ç›®å½•</span>mkdir /etc/systemd/journald.conf.dcat &gt; /etc/systemd/journald.conf.d/99-prophet.conf &lt;&lt;EOF[Journal]<span class="hljs-comment"># æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜</span>Storage=persistent<span class="hljs-comment"># å‹ç¼©å†å²æ—¥å¿—</span>Compress=yesSyncIntervalSec=5mRateLimitInterval=30sRateLimitBurst=1000<span class="hljs-comment"># æœ€å¤§å ç”¨ç©ºé—´ 10G</span>SystemMaxUse=10G<span class="hljs-comment"># å•æ—¥å¿—æ–‡ä»¶æœ€å¤§ 200M</span>SystemMaxFileSize=200M<span class="hljs-comment"># æ—¥å¿—ä¿å­˜æ—¶é—´ 2 å‘¨</span>MaxRetentionSec=2week<span class="hljs-comment"># ä¸å°†æ—¥å¿—è½¬å‘åˆ° syslog</span>ForwardToSyslog=noEOFsystemctl restart systemd-journald</code></pre><h1 id="å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º-4-44"><a href="#å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º-4-44" class="headerlink" title="å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º 4.44"></a>å‡çº§ç³»ç»Ÿå†…æ ¸ä¸º 4.44</h1><pre><code class="hljs bash">uname -r <span class="hljs-comment">#æŸ¥çœ‹å†…æ ¸</span><span class="hljs-comment"># å®‰è£…å®Œæˆåæ£€æŸ¥ /boot/grub2/grub.cfg ä¸­å¯¹åº”å†…æ ¸ menuentry ä¸­æ˜¯å¦åŒ…å« initrd16 é…ç½®ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå†å®‰è£…ä¸€æ¬¡ï¼</span>rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpmyum --enablerepo=elrepo-kernel install -y kernel<span class="hljs-_">-lt</span><span class="hljs-comment"># è®¾ç½®å¼€æœºä»æ–°å†…æ ¸å¯åŠ¨</span>grub2-set-default <span class="hljs-string">'CentOS Linux (4.4.189-1.el7.elrepo.x86_64) 7 (Core)'</span></code></pre><h1 id="kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶"><a href="#kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶" class="headerlink" title="kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶"></a>kube-proxyå¼€å¯ipvsçš„å‰ç½®æ¡ä»¶</h1><pre><code class="hljs bash">modprobe br_netfiltercat &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;EOF<span class="hljs-meta">#!/bin/bash</span>modprobe -- ip_vsmodprobe -- ip_vs_rrmodprobe -- ip_vs_wrrmodprobe -- ip_vs_shmodprobe -- nf_conntrack_ipv4EOFchmod 755 /etc/sysconfig/modules/ipvs.modules &amp;&amp; bash /etc/sysconfig/modules/ipvs.modules &amp;&amp; lsmod | grep -e ip_vs -e nf_conntrack_ipv4</code></pre><h1 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h1><pre><code class="hljs bash">yum install -y yum-utils device-mapper-persistent-data lvm2yum-config-manager \--add-repo \http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<span class="hljs-comment">#2é€‰1ï¼Œè¿™ä¸ªä¿è¯æœ€æ–°</span>yum-config-manager \    --add-repo \    https://download.docker.com/linux/centos/docker-ce.repoyum update -y &amp;&amp; yum install -y docker-ce<span class="hljs-comment">## åˆ›å»º /etc/docker ç›®å½•</span>mkdir /etc/docker<span class="hljs-comment"># é…ç½® daemon.</span>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF&#123;<span class="hljs-string">"exec-opts"</span>: [<span class="hljs-string">"native.cgroupdriver=systemd"</span>],<span class="hljs-string">"log-driver"</span>: <span class="hljs-string">"json-file"</span>,<span class="hljs-string">"log-opts"</span>: &#123;<span class="hljs-string">"max-size"</span>: <span class="hljs-string">"100m"</span>&#125;,<span class="hljs-string">"registry-mirrors"</span>: [<span class="hljs-string">"https://c0dhqpb1.mirror.aliyuncs.com"</span>]&#125;EOFmkdir -p /etc/systemd/system/docker.service.d<span class="hljs-comment"># é‡å¯dockeræœåŠ¡</span>systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl <span class="hljs-built_in">enable</span> docker</code></pre><h1 id="å®‰è£…DockerComponent"><a href="#å®‰è£…DockerComponent" class="headerlink" title="å®‰è£…DockerComponent"></a>å®‰è£…DockerComponent</h1><p> é€šè¿‡ä»¥ä¸‹å‘½ä»¤è‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…é€‚åº”ç³»ç»Ÿç‰ˆæœ¬çš„ Compose</p><pre><code class="hljs bash">sudo curl -L https://github.com/docker/compose/releases/download/1.16.1/docker-compose-`uname -s`-`uname -m` -o /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><p>ä¸ºå®‰è£…è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™</p><pre><code class="hljs bash">chmod +x /usr/<span class="hljs-built_in">local</span>/bin/docker-compose</code></pre><p>è¿™æ ·ï¼ŒCompose å°±å®‰è£…å®Œæˆäº†ã€‚å¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•å®‰è£…ç»“æœã€‚</p><pre><code class="hljs bash">~&gt; docker-compose --versiondocker-compose version 1.16.1, build 1719ceb</code></pre><p>å®‰è£… Compose å‘½ä»¤è¡¥å…¨å·¥å…·</p><pre><code class="hljs bash">sudo curl -L https://raw.githubusercontent.com/docker/compose/$(docker-compose version --short)/contrib/completion/bash/docker-compose -o /etc/bash_completion.d/docker-compose</code></pre><h1 id="kubectlè‡ªåŠ¨è¡¥å…¨"><a href="#kubectlè‡ªåŠ¨è¡¥å…¨" class="headerlink" title="kubectlè‡ªåŠ¨è¡¥å…¨"></a>kubectlè‡ªåŠ¨è¡¥å…¨</h1><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"source &lt;(kubectl completion bash)"</span>&gt;&gt; /root/.bashrc<span class="hljs-built_in">source</span> /root/.bashrc<span class="hljs-built_in">echo</span> <span class="hljs-string">"source /usr/share/bash-completion/bash_completion"</span>&gt;&gt;/root/.bashrc<span class="hljs-built_in">source</span> /root/.bashrc</code></pre><h1 id="è®©ä½ æå‡å‘½ä»¤è¡Œæ•ˆç‡çš„-Bash-å¿«æ·é”®-å®Œæ•´ç‰ˆ"><a href="#è®©ä½ æå‡å‘½ä»¤è¡Œæ•ˆç‡çš„-Bash-å¿«æ·é”®-å®Œæ•´ç‰ˆ" class="headerlink" title="è®©ä½ æå‡å‘½ä»¤è¡Œæ•ˆç‡çš„ Bash å¿«æ·é”® [å®Œæ•´ç‰ˆ]"></a>è®©ä½ æå‡å‘½ä»¤è¡Œæ•ˆç‡çš„ Bash å¿«æ·é”® [å®Œæ•´ç‰ˆ]</h1><h2 id="å¸¸ç”¨çš„å‘½ä»¤è¡Œå‡»é”®æ“ä½œ"><a href="#å¸¸ç”¨çš„å‘½ä»¤è¡Œå‡»é”®æ“ä½œ" class="headerlink" title="å¸¸ç”¨çš„å‘½ä»¤è¡Œå‡»é”®æ“ä½œ"></a>å¸¸ç”¨çš„å‘½ä»¤è¡Œå‡»é”®æ“ä½œ</h2><p>ctrl + insertã€€ xshell ä¸­å¤åˆ¶ï¼Œå¯ä»¥è®¾ç½®é€‰ä¸­å†…å®¹è‡ªåŠ¨å¤åˆ¶<br>ctrl shift + cã€€ crt ä¸­å¤åˆ¶<br>shift + insertã€€xshell ä¸­ç²˜è´´<br>ctrl shift + vã€€ crt ä¸­ç²˜è´´<br>ctrl+tab ã€€ xshell ä¸­å¿«é€Ÿåˆ‡æ¢è¿æ¥é€‰é¡¹å¡<br>alt + N ã€€ N ä¸ºæ•°å­—ï¼ŒCRT ä¸­å¿«é€Ÿåˆ‡æ¢è¿æ¥é€‰é¡¹å¡<br>alt + d åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®çš„åå•è¯ï¼Œè¦è®¾ç½® alt é”®ä¸º meta é”®<br>ctrl + w åˆ é™¤å…‰æ ‡å‰ä¸€ä¸ªå•è¯ç›¸å½“äº VIM é‡Œ db<br>ctrl + k åˆ é™¤å…‰æ ‡åé¢æ‰€æœ‰å­—ç¬¦ç›¸å½“äº VIM é‡Œ d shift+$<br>ctrl + u åˆ é™¤å…‰æ ‡å‰é¢æ‰€æœ‰å­—ç¬¦ç›¸å½“äº VIM é‡Œ d shift+^<br>ctrl + y æ¢å¤ ctrl+u ä¸Šæ¬¡æ‰§è¡Œæ—¶åˆ é™¤çš„å­—ç¬¦<br>ctrl + é”®ç›˜å·¦å³é”® å¿«é€Ÿç§»åŠ¨ä¸€ä¸ªè¯ï¼ˆXshellï¼‰<br>ctrl + a å°†å…‰æ ‡ç§»åŠ¨åˆ°å‘½ä»¤è¡Œå¼€å¤´ç›¸å½“äº VIM é‡Œ shift+^ æˆ–è€… home é”®<br>ctrl + e å°†å…‰æ ‡ç§»åŠ¨åˆ°å‘½ä»¤è¡Œç»“å°¾å¤„ç›¸å½“äº VIM é‡Œ shift+$ æˆ–è€… end é”®<br>ctrl + p è¿”å›ä¸Šä¸€æ¬¡è¾“å…¥å‘½ä»¤å­—ç¬¦<br>ctrl + r è¾“å…¥å•è¯æœç´¢å†å²å‘½ä»¤<br>Ctrl + g ä»å†å²æœç´¢æ¨¡å¼é€€å‡ºï¼ŒCtrl+r åç”¨ä½œé€€å‡ºä½¿ç”¨<br>alt + p è¾“å…¥å­—ç¬¦æŸ¥æ‰¾ä¸å­—ç¬¦ç›¸æ¥è¿‘çš„å†å²å‘½ä»¤<br>ESC + . æ‰“å°ä¹‹å‰æ‰§è¡Œè¿‡çš„å‘½ä»¤çš„æœ€åä¸€éƒ¨åˆ†ï¼ˆå‚æ•°ï¼‰ä»¥ç©ºæ ¼ä¸ºåˆ†éš”ç¬¦ï¼Œä¹Ÿå¯ä»¥ç”¨ alt+.<br>Ctrl + l æ¸…å±<br>Ctrl + o æ‰§è¡Œå½“å‰å‘½ä»¤ï¼Œå¹¶é€‰æ‹©ä¸Šä¸€æ¡å‘½ä»¤<br>Ctrl + z æŒ‚èµ·å‘½ä»¤<br>Ctrl + d é€€å‡ºç™»å½•<br>tab é”® è‡ªåŠ¨è¡¥å…¨<br>ctrl + i ç±»ä¼¼ TAB å¥è¡¥å…¨åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨ tab ä¸ç”¨å®ƒ<br>Ctrl + Shift + r é‡æ–°ç™»å½•å‰ä¸€ä¸ªç”¨æˆ·<br>ctrl + c ç»ˆæ­¢å½“å‰æ“ä½œ<br>ctrl + s é”ä½ç»ˆç«¯<br>ctrl + q è§£é”ç»ˆç«¯<br>ctrl + o é‡å¤æ‰§è¡Œå‘½ä»¤<br>alt + æ•°å­—é”® æ“ä½œçš„æ¬¡æ•°ï¼ˆXshellï¼‰</p><h2 id="å‘½ä»¤è¡Œå‡»é”®æ“ä½œæ•´ç†-å¤åˆ¶ç²˜è´´å’Œçª—å£åˆ‡æ¢"><a href="#å‘½ä»¤è¡Œå‡»é”®æ“ä½œæ•´ç†-å¤åˆ¶ç²˜è´´å’Œçª—å£åˆ‡æ¢" class="headerlink" title="å‘½ä»¤è¡Œå‡»é”®æ“ä½œæ•´ç†,å¤åˆ¶ç²˜è´´å’Œçª—å£åˆ‡æ¢"></a>å‘½ä»¤è¡Œå‡»é”®æ“ä½œæ•´ç†,å¤åˆ¶ç²˜è´´å’Œçª—å£åˆ‡æ¢</h2><p>ctrl + insertã€€ xshell ä¸­å¤åˆ¶ï¼Œå¯ä»¥è®¾ç½®é€‰ä¸­å†…å®¹è‡ªåŠ¨å¤åˆ¶<br>ctrl shift + cã€€ crt ä¸­å¤åˆ¶<br>shift + insertã€€xshell ä¸­ç²˜è´´<br>ctrl shift + vã€€ crt ä¸­ç²˜è´´<br>ctrl+tab ã€€ xshell ä¸­å¿«é€Ÿåˆ‡æ¢è¿æ¥é€‰é¡¹å¡<br>alt + N ã€€ N ä¸ºæ•°å­—ï¼ŒCRT ä¸­å¿«é€Ÿåˆ‡æ¢è¿æ¥é€‰é¡¹å¡<br>alt + d åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®çš„åå•è¯ï¼Œè¦è®¾ç½® alt é”®ä¸º meta é”®</p><h2 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><p>ctrl + d åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®ä¸Šçš„å­—ç¬¦ç›¸å½“äº VIM é‡Œ x æˆ–è€… dl<br>ctrl + h åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®å‰çš„å­—ç¬¦ç›¸å½“äº VIM é‡Œ hx æˆ–è€… dh<br>ctrl + k åˆ é™¤å…‰æ ‡åé¢æ‰€æœ‰å­—ç¬¦ç›¸å½“äº VIM é‡Œ d shift+$<br>ctrl + u åˆ é™¤å…‰æ ‡å‰é¢æ‰€æœ‰å­—ç¬¦ç›¸å½“äº VIM é‡Œ d shift+^<br>ctrl + w åˆ é™¤å…‰æ ‡å‰ä¸€ä¸ªå•è¯ç›¸å½“äº VIM é‡Œ db<br>ctrl + y æ¢å¤ ctrl+u ä¸Šæ¬¡æ‰§è¡Œæ—¶åˆ é™¤çš„å­—ç¬¦<br>ctrl + ? æ’¤æ¶ˆå‰ä¸€æ¬¡è¾“å…¥<br>alt + r æ’¤æ¶ˆå‰ä¸€æ¬¡åŠ¨ä½œ<br>alt + d åˆ é™¤å…‰æ ‡æ‰€åœ¨ä½ç½®çš„åå•è¯</p><h2 id="ç§»åŠ¨"><a href="#ç§»åŠ¨" class="headerlink" title="ç§»åŠ¨"></a>ç§»åŠ¨</h2><p>ctrl + a å°†å…‰æ ‡ç§»åŠ¨åˆ°å‘½ä»¤è¡Œå¼€å¤´ç›¸å½“äº VIM é‡Œ shift+^ æˆ–è€… home é”®<br>ctrl + e å°†å…‰æ ‡ç§»åŠ¨åˆ°å‘½ä»¤è¡Œç»“å°¾å¤„ç›¸å½“äº VIM é‡Œ shift+$ æˆ–è€… end é”®<br>ctrl + f å…‰æ ‡å‘åç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ç›¸å½“äº VIM é‡Œ l<br>ctrl + b å…‰æ ‡å‘å‰ç§»åŠ¨ä¸€ä¸ªå­—ç¬¦ç›¸å½“äº VIM é‡Œ h<br>ctrl + æ–¹å‘é”®å·¦é”® å…‰æ ‡ç§»åŠ¨åˆ°å‰ä¸€ä¸ªå•è¯å¼€å¤´<br>ctrl + æ–¹å‘é”®å³é”® å…‰æ ‡ç§»åŠ¨åˆ°åä¸€ä¸ªå•è¯ç»“å°¾<br>ctrl + x åœ¨ä¸Šæ¬¡å…‰æ ‡æ‰€åœ¨å­—ç¬¦å’Œå½“å‰å…‰æ ‡æ‰€åœ¨å­—ç¬¦ä¹‹é—´è·³è½¬<br>alt + f è·³åˆ°å…‰æ ‡æ‰€åœ¨ä½ç½®å•è¯å°¾éƒ¨</p><h2 id="æ›¿æ¢"><a href="#æ›¿æ¢" class="headerlink" title="æ›¿æ¢"></a>æ›¿æ¢</h2><p>ctrl + t å°†å…‰æ ‡å½“å‰å­—ç¬¦ä¸å‰é¢ä¸€ä¸ªå­—ç¬¦æ›¿æ¢<br>alt + t äº¤æ¢ä¸¤ä¸ªå…‰æ ‡å½“å‰æ‰€å¤„ä½ç½®å•è¯å’Œå…‰æ ‡å‰ä¸€ä¸ªå•è¯<br>alt + u æŠŠå…‰æ ‡å½“å‰ä½ç½®å•è¯å˜ä¸ºå¤§å†™<br>alt + l æŠŠå…‰æ ‡å½“å‰ä½ç½®å•è¯å˜ä¸ºå°å†™<br>alt + c æŠŠå…‰æ ‡å½“å‰ä½ç½®å•è¯å¤´ä¸€ä¸ªå­—æ¯å˜ä¸ºå¤§å†™<br>^oldstr^newstr æ›¿æ¢å‰ä¸€æ¬¡å‘½ä»¤ä¸­å­—ç¬¦ä¸²</p><h2 id="å†å²å‘½ä»¤ç¼–è¾‘"><a href="#å†å²å‘½ä»¤ç¼–è¾‘" class="headerlink" title="å†å²å‘½ä»¤ç¼–è¾‘"></a>å†å²å‘½ä»¤ç¼–è¾‘</h2><p>ctrl + p è¿”å›ä¸Šä¸€æ¬¡è¾“å…¥å‘½ä»¤å­—ç¬¦</p><p>ctrl + r è¾“å…¥å•è¯æœç´¢å†å²å‘½ä»¤</p><p>alt + p è¾“å…¥å­—ç¬¦æŸ¥æ‰¾ä¸å­—ç¬¦ç›¸æ¥è¿‘çš„å†å²å‘½ä»¤</p><p>alt + &gt; è¿”å›ä¸Šä¸€æ¬¡æ‰§è¡Œå‘½ä»¤</p><p>Ctrl + g ä»å†å²æœç´¢æ¨¡å¼é€€å‡º</p><p>Ctrl + n å†å²ä¸­çš„ä¸‹ä¸€æ¡å‘½ä»¤</p><p>Alt + . æ‰“å°ä¹‹å‰æ‰§è¡Œè¿‡çš„å‘½ä»¤çš„æœ€åä¸€éƒ¨åˆ†ï¼ˆå‚æ•°ï¼‰ä»¥ç©ºæ ¼ä¸ºåˆ†éš”ç¬¦</p><p>ESC + . æ‰“å°ä¹‹å‰æ‰§è¡Œè¿‡çš„å‘½ä»¤çš„æœ€åä¸€éƒ¨åˆ†ï¼ˆå‚æ•°ï¼‰ä»¥ç©ºæ ¼ä¸ºåˆ†éš”ç¬¦</p><h2 id="æ§åˆ¶å‘½ä»¤"><a href="#æ§åˆ¶å‘½ä»¤" class="headerlink" title="æ§åˆ¶å‘½ä»¤"></a>æ§åˆ¶å‘½ä»¤</h2><p>Ctrl + l æ¸…å±</p><p>Ctrl + o æ‰§è¡Œå½“å‰å‘½ä»¤ï¼Œå¹¶é€‰æ‹©ä¸Šä¸€æ¡å‘½ä»¤</p><p>Ctrl + z æŒ‚èµ·å‘½ä»¤</p><p>Ctrl + d é€€å‡ºç™»å½•</p><p>tab é”® è‡ªåŠ¨è¡¥å…¨</p><p>clear æ¸…å±</p><p>logout é€€å‡ºå½“å‰ç”¨æˆ·</p><p>Ctrl + Shift + r é‡æ–°ç™»å½•å‰ä¸€ä¸ªç”¨æˆ·</p><p>ctrl + c ç»ˆæ­¢å½“å‰æ“ä½œ</p><p>ctrl + s é”ä½ç»ˆç«¯</p><p>ctrl + q è§£é”ç»ˆç«¯</p><p>ctrl + i ç±»ä¼¼ TAB å¥è¡¥å…¨åŠŸèƒ½ï¼Œä¸€èˆ¬ç”¨ tab ä¸ç”¨å®ƒ</p><p>ctrl + o é‡å¤æ‰§è¡Œå‘½ä»¤</p><p>alt + æ•°å­—é”® æ“ä½œçš„æ¬¡æ•°ï¼ˆxshell ä¸­ï¼‰</p><h1 id="é€šè¿‡lrzsz-ä»£æ›¿FTP"><a href="#é€šè¿‡lrzsz-ä»£æ›¿FTP" class="headerlink" title="é€šè¿‡lrzsz ä»£æ›¿FTP"></a>é€šè¿‡lrzsz ä»£æ›¿FTP</h1><p><a href="https://www.jianshu.com/p/d4dcbd088a05" target="_blank" rel="noopener">é“¾æ¥</a></p><pre><code class="hljs bash">~&gt; yum -y install lrzsz</code></pre><h1 id="å®‰è£…Jdk8"><a href="#å®‰è£…Jdk8" class="headerlink" title="å®‰è£…Jdk8"></a>å®‰è£…Jdk8</h1><p><a href="https://blog.csdn.net/xingbaozhen1210/article/details/84062364" target="_blank" rel="noopener">é“¾æ¥</a></p><pre><code class="hljs bash">~&gt; yum -y install java-1.8.0-openjdk*</code></pre><h1 id="Xshell-ç™»å½•-Linux-å¤ªæ…¢æ€ä¹ˆåŠ"><a href="#Xshell-ç™»å½•-Linux-å¤ªæ…¢æ€ä¹ˆåŠ" class="headerlink" title="Xshell ç™»å½• Linux å¤ªæ…¢æ€ä¹ˆåŠ"></a>Xshell ç™»å½• Linux å¤ªæ…¢æ€ä¹ˆåŠ</h1><pre><code class="hljs bash">~&gt; vim /etc/ssh/sshd_config<span class="hljs-comment">#åŠ å…¥å†…å®¹ï¼š</span>UseDNS no</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Linux</category>
      
    </categories>
    
    
    <tags>
      
      <tag>é›¶ç¢</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 15.å¼€å‘è¿ç»´å¸¸è§å‘</title>
    <link href="/redis-15.html"/>
    <url>/redis-15.html</url>
    
    <content type="html"><![CDATA[<h1 id="Linuxå†…æ ¸ä¼˜åŒ–"><a href="#Linuxå†…æ ¸ä¼˜åŒ–" class="headerlink" title="Linuxå†…æ ¸ä¼˜åŒ–"></a>Linuxå†…æ ¸ä¼˜åŒ–</h1><h2 id="vm-overcommit-memory"><a href="#vm-overcommit-memory" class="headerlink" title="vm.overcommit_memory"></a>vm.overcommit_memory</h2><blockquote><p>é’ˆå¯¹Redisç”³è¯·å†…å­˜ï¼Œå®ƒé’ˆå¯¹æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜çš„ä¸€äº›è®¾ç½®ï¼Œè¿™é‡Œä¸»è¦å…³å¿ƒRedisç›¸å…³çš„ç”³è¯·å†…å­˜çš„è®¾ç½®</p></blockquote><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191110211518864-1573391851722.png" srcset="/img/loading.gif" alt="image-20191110211518864"></p><p>å¦‚æœè¯´ä½ ç»™<code>overcommit_memory</code>è®¾ç½®ä¸º0ï¼Œå½“ä½ å¯åŠ¨æ—¶ï¼Œæ—¥å¿—ä¸­å®ƒä¼šè­¦å‘Š</p><p>æç¤ºä½ è¿™ä¸ªå‚æ•°ä¸º0ï¼Œä½†æ˜¯å¦‚æœä½ çš„å†…å­˜åœ¨ä¸€ä¸ªæ¯”è¾ƒç´§å¼ çš„æƒ…å†µä¸‹ï¼Œé‚£å¯èƒ½bgsaveã€bgrewriteaofå¯èƒ½ä¼šå¤±è´¥ï¼Œé‚£ä¿®å¤è¿™ç§é—®é¢˜å‘¢å®ƒå»ºè®®å»å°†è¿™ä¸ª<code>overcommit_memory</code>è®¾ç½®ä¸º1å¹¶ä¸”å†™å…¥åˆ°<code>/etc/sysctl.conf</code>è¿™ä¸ªæ–‡ä»¶ä¸Šï¼Œè¿™æ ·çš„è¯å³ä½¿åœ¨é‡å¯çš„æƒ…å†µä¸‹ä½ è¿™ä¸ª<code>overcommit_memory</code>ä¹Ÿä¼šç”Ÿæ•ˆï¼Œä¹Ÿå°±æ˜¯è¯´è®¾ç½®ä¸º1ï¼Œ</p><h3 id="overcommitå«ä¹‰"><a href="#overcommitå«ä¹‰" class="headerlink" title="overcommitå«ä¹‰"></a>overcommitå«ä¹‰</h3><p>å®ƒæœ‰3ä¸ªå€¼ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191110212118191.png" srcset="/img/loading.gif" alt="image-20191110212118191"></p><p>å‰é¢ä¸ºä»€ä¹ˆè¦å°†è¿™é‡Œè®¾ç½®ä¸º1å‘¢é¦–å…ˆ0è¡¨ç¤ºå¦‚æœå†…å­˜è¶³å¤Ÿï¼Œå®ƒå°±ç»™ä½ ï¼Œ1å°±æ˜¯è¯´æˆ‘å¯èƒ½ä¼šè¶…é‡çš„ç»™ä½ ï¼Œè¿™é‡Œæœ‰ä¸ªå«ä¹‰ï¼šè¿›ç¨‹åœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™ï¼Œå®ƒç”³è¯·äº†4GBï¼Œä½†æ˜¯å®ƒæœ‰æ—¶å€™å¹¶æ²¡æœ‰ç”³è¯·4GBå°±å»ç”¨4GBï¼Œè¿™é‡Œ0è¡¨ç¤ºä¸€ç§ä¿å®ˆçš„ç­–ç•¥ï¼Œ1å°±ä¸ä¿å®ˆï¼Œå¯èƒ½æœ‰å¼•èµ·ä¸€äº›é—®é¢˜ä¸€äº›æƒ…å†µï¼Œæˆ‘ç°åœ¨æ²¡æœ‰4GBï¼Œä½†æ˜¯è¿˜æ˜¯ç»™ä½ åˆ†é…ï¼Œé‚£å¯èƒ½å› ä¸ºå…¶ä»–çš„äººå®ƒç”³è¯·äº†ä½†æ²¡æœ‰å»ç”¨ï¼Œ1å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼›</p><p>å‰é¢ä»‹ç»éƒ¨åˆ†çš„é‚£å¼ å›¾ï¼Œåœ¨ä½ å¯åŠ¨çš„æ—¶å€™å»ºè®®ä½ å°†å®ƒè®¾ç½®ä¸º1ï¼Œå®ƒç›®çš„æ˜¯ä¸ºäº†ä¿è¯bgsaveã€bgrewriteaofçš„æˆåŠŸï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†é˜²æ­¢bgsaveã€bgrewriteaofå¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé˜»å¡ï¼Œè¯´äº†åŠå¤©å°±æ˜¯ä¸€ä¸ªforkçš„å¤±è´¥ï¼Œforkå¤±è´¥å°±æ„å‘³ç€ä¸»çº¿ç¨‹å¯èƒ½ä¼šè¢«é˜»å¡</p><h3 id="overcommitå®è·µ"><a href="#overcommitå®è·µ" class="headerlink" title="overcommitå®è·µ"></a>overcommitå®è·µ</h3><h4 id="è·å–å’Œè®¾ç½®"><a href="#è·å–å’Œè®¾ç½®" class="headerlink" title="è·å–å’Œè®¾ç½®"></a>è·å–å’Œè®¾ç½®</h4><pre><code class="hljs bash">è·å–ï¼š[root@mcr2 ~] cat /proc/sys/vm/overcommit_memory 0è®¾ç½®ï¼š[root@mcr2 ~] <span class="hljs-built_in">echo</span> <span class="hljs-string">"vm.overcommit_memory=1"</span> &gt;&gt; /etc/sysctl.conf[root@mcr2 ~] sysctl vm.overcommit_memory=1</code></pre><h4 id="æœ€ä½³å®ç°"><a href="#æœ€ä½³å®ç°" class="headerlink" title="æœ€ä½³å®ç°"></a>æœ€ä½³å®ç°</h4><ol><li>å‰é¢è¯´äº†å†…å­˜è¶…é‡çš„ä½¿ç”¨ï¼Œå¯¹äºæˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬åº”è¯¥æ€ä¹ˆå»åšå‘¢ï¼Ÿè®¾è®¡ä¸Šæˆ‘ä»¬å¯¹Redisè®¾ç½®åˆç†çš„maxmemoryï¼Œè¿™æ ·å’Œä¹‹å‰å°†çš„å†…å­˜ç®¡ç†çš„æ—¶å€™ï¼Œç»™æ¯ä¸ªRedisè®¾ç½®maxmemoryä¹‹å’Œç„¶åæŠŠå½“å‰çš„æœºå™¨ä¿ç•™20%~30%çš„é—²ç½®å†…å­˜ï¼Œè¿™æ ·ä¿è¯äº†è¶³å¤Ÿçš„é—²ç½®å†…å­˜ç„¶åå°±å¯ä»¥å®Œæˆç±»ä¼¼forkç›¸å…³å¯èƒ½å‡ºç°å†…å­˜æº¢å‡ºçš„æƒ…å†µï¼›</li><li>é›†ä¸­åŒ–ç®¡ç†AOFé‡å†™å’ŒRDBçš„bgsaveï¼Œé‡å†™æˆ‘ä»¬çŸ¥é“è¿™ä¸ªå¦‚æœä½ å¼€äº†aofå®ƒé‡å†™æ˜¯å¿…ç„¶ä¼šäº§ç”Ÿçš„ï¼Œä¸ºäº†é˜²æ­¢aofæ–‡ä»¶è¿‡å¤§ï¼Œç„¶åå®ƒå°±ä¼šæ‰§è¡Œé‡å†™è¿™æ ·çš„å·¥ä½œï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆé˜²æ­¢é‡å†™é›†ä¸­åŒ–çš„çˆ†å‘å‘¢ï¼Ÿå…¶å®æˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªé›†ä¸­åŒ–çš„ç®¡ç†ï¼Œæ¯”å¦‚è¯´å¯¹å½“å‰æœºå™¨æˆ‘ä»¬å»å†™ä¸€ä¸ªç¨‹åºæˆ–è€…åšä¸€ä¸ªå·¥å…·è®©å®ƒå»éå†å½“å‰æœºå™¨ä¸‹æ‰€æœ‰çš„Redisï¼Œè®©å®ƒå»çœ‹å½“å‰çš„aofæ˜¯å¦è¾¾åˆ°é‡å†™çš„æ¡ä»¶ï¼Œè®©aofé‡å†™æ”¾åˆ°æˆ‘ä»¬æ‰‹ä¸­é˜²æ­¢é›†ä¸­çˆ†å‘ï¼›<br>RDBçš„bgsaveæœ‰ä¸¤ç‚¹ï¼š<ul><li>å¤åˆ¶äº§ç”Ÿï¼›</li><li>åœ¨å¤œé—´åšä¸€ä¸ªé›†ä¸­çš„å¤‡ä»½ï¼Œåœ¨é›†ä¸­å¤‡ä»½çš„æ—¶å€™æˆ‘ä»¬ä¸€å®šè¦åšä¸€ä¸ªåˆ›å»ºå¤‡ä»½ï¼Œä¸è®©å½“å‰æœºå™¨ä¸‹æ‰€æœ‰çš„Rediséƒ½åšbgsaveï¼Œ<br>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘å½“å‰è¿™ä¸ªæœºå™¨masteræ¯”è¾ƒå¤šï¼Œ</li><li>å¦‚æœmasterå’Œslaveä¹‹é—´é•¿æ—¶é—´çš„æ–­å¼€ï¼Œä¹Ÿæœ‰å¯èƒ½å‡ºç°å½“å‰æœºå™¨æ‰€æœ‰çš„ä¸»éƒ½ä¼šbgsaveï¼Œè¿™ä¹Ÿæ˜¯æ¯”è¾ƒå±é™©çš„ï¼Œè¿™ä¸ªå°±æ¶‰åŠåˆ°æˆ‘ä»¬åœ¨åˆ†é…å†…å­˜çš„æ—¶å€™è·Ÿåˆ†é…ä¸»ä»å…³ç³»çš„æ—¶å€™çš„ä¸€ä¸ªåˆ†é…ç®—æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸è¦è®©è¿‡å¤šçš„ä¸»èŠ‚ç‚¹æ”¾åœ¨ä¸€ä¸ªæœºå™¨ä¸­ï¼Œå¯èƒ½å¦‚æœä¸»ä»ä¹‹é—´æœºå™¨å‘ç”Ÿæ–­å¼€çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°é›†ä¸­å¤§é‡çš„bgsave</li></ul></li><li>æˆ‘ä»¬æŒ‰ç…§Redisçš„å»ºè®®æŠŠè¿™ä¸ªå€¼è®¾ç½®ä¸º1ï¼Œè¿™æ ·å…¶å®æ˜¯ä¸ºäº†é˜²æ­¢æç«¯æƒ…å†µä¸‹ä¼šé€ æˆforkå¤±è´¥ï¼Œè¿™ä¸ªç›¸ä¿¡äº†è§£å‚æ•°å«ä¹‰çš„è¯»è€…åº”è¯¥æ˜ç™½è¿™ä¸ªé“ç†ï¼Œç¬”è€…åé¢ä¼šå¯¹è¿™ä¸ªovercommit_memoryè¿™ä¸ªå‚æ•°è¿›è¡Œæ¼”ç¤ºå¸¦ç€å¤§å®¶çœ‹ä¸€ä¸‹æ“ä½œç³»ç»Ÿçš„ç›¸å…³è®¾ç½®ï¼Œä»¥åŠä¹‹å‰çš„æ—¥å¿—å†…å®¹</li></ol><pre><code class="hljs bash">[root@mcr2 config] <span class="hljs-built_in">pwd</span>/usr/src/redis/config[root@mcr2 config] vim 6379.conf å†…å®¹port 6379daemonize yesdir /usr/src/redis/datadbfilename 6379.rdblogfile 6379.logå¯åŠ¨ï¼š[root@mcr2 config]<span class="hljs-comment"># redis-server ./6379.conf </span>æŸ¥çœ‹6379èŠ‚ç‚¹çš„æ—¥å¿—2669:M 11 Nov 06:13:31.937 <span class="hljs-comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>è¿™æ®µå†…å®¹å°±æ˜¯ä¸Šé¢çš„é‚£æ®µæç¤ºäº†ï¼Œè¿™é‡Œè¯´å»ºè®®å°†overcommit_memoryè®¾ç½®ä¸º1å¹¶ä¸”å°†å®ƒå¹¶ä¸”å°†å®ƒé‡å®šå‘åˆ°é…ç½®æ–‡ä»¶ä¸­æŸ¥çœ‹overcommit_memoryå†…å®¹[root@mcr2 config] cat /proc/sys/vm/overcommit_memory 0è®¾ç½®ä¸º1[root@mcr2 config] <span class="hljs-built_in">echo</span> <span class="hljs-string">"vm.overcommit_memory=1"</span> &gt;&gt; /etc/sysctl.conf[root@mcr2 config] sysctl vm.overcommit_memory=1</code></pre><h2 id="swappiness"><a href="#swappiness" class="headerlink" title="swappiness"></a>swappiness</h2><blockquote><p>é’ˆå¯¹swappinessçš„ä¸€äº›è®¾ç½®</p></blockquote><h3 id="swappinesså«ä¹‰"><a href="#swappinesså«ä¹‰" class="headerlink" title="swappinesså«ä¹‰"></a>swappinesså«ä¹‰</h3><p>swappinessæ˜¯æ“ä½œç³»ç»Ÿåœ¨ä½¿ç”¨swappinessè¿™ä¸ªäº‹æƒ…ä¸Šçš„ä¸€ä¸ªæ¦‚ç‡ or å€¾å‘ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯60ï¼Œå®ƒçš„æœ€å¤§å€¼æ˜¯100ï¼Œå½“å®ƒè¾¾åˆ°100çš„æ—¶å€™å°±ä»£è¡¨å®ƒä¼šä¸»åŠ¨çš„ä½¿ç”¨swappinessï¼Œå½“å®ƒæ˜¯60çš„æ—¶å€™å®ƒå¯èƒ½ä¼šä½ å¯ä»¥è®¤ä¸ºç™¾åˆ†ä¹‹çš„æ¦‚ç‡ä¹Ÿå°±æ˜¯60çš„å€¼ä¼šä½¿ç”¨swappinessï¼Œå½“å®ƒæ˜¯0çš„æ—¶å€™ä½¿ç”¨æ¦‚ç‡ä¼šæ›´å°ï¼Œä½†æ˜¯Linuxåœ¨ä¸åŒçš„å†…æ ¸ç‰ˆæœ¬ä¸­å®ƒæœ‰ä¸€äº›ä¸åŒçš„è§„å®šï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191111192035694.png" srcset="/img/loading.gif" alt="image-20191111192035694"></p><p>å¯¹äºLinux3.5ä»¥ä¸Šç‰ˆæœ¬çš„æ—¶å€™å®ƒä¼šå®æ„¿ç”¨OOM killerä¹Ÿä¸ç”¨swapï¼Œåœ¨ä½ç‰ˆæœ¬ä¸‹å®ƒå®æ„¿ç”¨ä¸€ä¸‹swapä¹Ÿä¸å¸Œæœ›è¢«OOM killerè¿›è¡Œæ€æ‰ï¼Œæˆ‘ä»¬åœ¨å¯¹Redisè¿™ä¸ªä¸œè¥¿ï¼Œåœ¨Linuxç¯å¢ƒä¸‹ä¼šæ€ä¹ˆå»è®¾ç½®å‘¢ï¼Ÿæˆ‘ä»¬å½“ç„¶ç»™å®ƒè®¾ç½®ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä¸å¸Œæœ›Linuxå»ä½¿ç”¨swapï¼Œå› ä¸ºswapæ˜¯éå¸¸æ…¢çš„ï¼Œæˆ‘ä»¬Redisä¹‹æ‰€æœ‰éå¸¸å¿«æ˜¯å› ä¸ºå®ƒçš„æ‰€æœ‰æ•°æ®æ”¾åœ¨äº†å†…å­˜å½“ä¸­ï¼Œå½“ç„¶ä¹Ÿè·Ÿå®ƒçš„çº¿ç¨‹æ¨¡å‹ã€æ•°æ®ç»“æ„ä¼˜åŒ–æœ‰å…³ï¼Œä½†å®é™…ä¸Šå®ƒæœ¬è´¨å¿«çš„åŸå› å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå…¨å†…å­˜çš„ä¸€ä¸ªæ•°æ®åº“ã€ç¼“å­˜ï¼Œè¿™é‡Œå½“ç„¶ä¸ä½¿ç”¨swap</p><h3 id="swappinesså®è·µ"><a href="#swappinesså®è·µ" class="headerlink" title="swappinesså®è·µ"></a>swappinesså®è·µ</h3><h4 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h4><ol><li>ç«‹å³ç”Ÿæ•ˆï¼šecho {bestvalue} &gt; /proc/sys/vm/swappinessï¼›</li><li>æ°¸ä¹…ç”Ÿæ•ˆï¼šecho vm.swappiness={bestvalue} &gt;&gt; /etc/sysctl.confã€‚</li></ol><h4 id="æœ€ä½³å®è·µ"><a href="#æœ€ä½³å®è·µ" class="headerlink" title="æœ€ä½³å®è·µ"></a>æœ€ä½³å®è·µ</h4><p>å¦‚æœLinuxå†…æ ¸å¤§äº3.5ï¼Œæ¨èè®¾ç½®ï¼švm.swappiness=1ï¼Œå¦åˆ™vm.swappiness=0ï¼Œä»è€Œå®ç°å¦‚ä¸‹ä¸¤ä¸ªç›®æ ‡ï¼š</p><ul><li>ç‰©ç†å†…å­˜å……è¶³æ—¶å€™ï¼Œä½¿Redisè¶³å¤Ÿå¿«ï¼Œä¸è®©Linuxå»ç”¨swappinessï¼›</li><li>ç‰©ç†å†…å­˜ä¸è¶³æ—¶å€™ï¼Œé¿å…Redisæ­»æ‰ï¼Œè¿™ä¸ªä¹Ÿä¸æ˜¯ç»å¯¹çš„ï¼Œå¦‚æœå½“å‰Redisä¸ºé«˜å¯ç”¨ï¼Œæ­»æ‰æ¯”é˜»å¡æ›´å¥½ï¼Œå› ä¸ºæ­»æ‰ä¹‹åè¿˜æœ‰æ–°çš„ç»„ä»è¿›è¡Œåˆ‡æ¢è¿™ä¸ªæ—¶å€™å°±ä¸ä¼šå‡ºç°Redisåƒµæ­»çš„æƒ…å†µ</li></ul><h2 id="THP-Transparent-huge-page"><a href="#THP-Transparent-huge-page" class="headerlink" title="THP(Transparent huge page)"></a>THP(Transparent huge page)</h2><blockquote><p>é’ˆå¯¹forkï¼Œåœ¨å­è¿›ç¨‹çš„æ—¶å€™å¯èƒ½ä¼šç”¨åˆ°è¿™ä¸ªå‚æ•°</p></blockquote><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191111193516660.png" srcset="/img/loading.gif" alt="image-20191111193516660"></p><p>å®ƒå’Œovercommitéå¸¸ç±»ä¼¼ï¼Œå‡å¦‚å®ƒè®¤ä¸ºä½ çš„THPçš„å€¼è®¾ç½®çš„å€¼ä¸æ˜¯å®ƒè®¤ä¸ºå¾ˆç†æƒ³çš„å€¼ï¼Œå®ƒä¼šç»™ä½ æ‰“ä¸€ä¸²æ—¥å¿—ï¼Œä¸Šé¢è¿™å¼ å›¾å°±æ˜¯æ—¥å¿—ä¸Šçš„è­¦å‘Šå†…å®¹ï¼Œå®ƒè­¦å‘Šä½ å½“å‰çš„THPæ˜¯åœ¨ä½ Linuxå†…æ ¸ä¸‹å¼€å¯çš„ï¼Œé¦–å…ˆæ¥ä»‹ç»ä¸€ä¸‹ä»€ä¹ˆæ˜¯THPï¼Ÿâ€”â€”THPæ˜¯ä¸ºäº†åŠ é€Ÿforkï¼Œå°±æ˜¯åœ¨åšbgsaveã€bgwriteaofçš„æ—¶å€™éƒ½ä¼šæœ‰ä¸€ä¸ªforkï¼Œå®ƒä¼šåŠ é€Ÿforkï¼ŒåŸæ¥å®ƒçš„å†…å­˜é¡µæ˜¯4kbï¼Œåœ¨THPç‰¹æ€§å¼€å¯æ—¶å€™å®ƒä¼šè¾¾åˆ°2mbï¼Œå°±æ˜¯è¯´å®ƒæ‰©å¤§äº†512å€ï¼Œå®ƒä¼šå¤§å¤§åŠ é€ŸRedisçš„forké€Ÿåº¦ï¼Œæˆ‘ä»¬çŸ¥é“forkæ˜¯åœ¨Redisä¸‹ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼ŒåŠ å¿«é€Ÿåº¦å°±æ„å‘³ç€ä½ çš„ä¸»çº¿ç¨‹çš„é˜»å¡æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œå®ƒæ˜¯ä¸€ä¸ªéå¸¸å¥½çš„ä¸œè¥¿ï¼Œä½†æ˜¯å®ƒè¿˜æœ‰å¾ˆå¤šé—®é¢˜ï¼Œæˆ‘ä»¬æ¥çœ‹å›¾ä¸­çš„ç¬¬äºŒå¥è¯ï¼Œå®ƒè¯´ï¼šä½ å¼€å¯äº†è¿™ä¸ªç‰¹æ€§å¯èƒ½ä¼šé€ æˆä¸€äº›å»¶è¿Ÿç”šè‡³å†…å­˜ä½¿ç”¨çš„é—®é¢˜ï¼Œè¿™é‡Œçš„å»¶è¿Ÿä¸»è¦æ˜¯æŒ‡å› ä¸ºä½ å†…å­˜é¡µæ‰©å¤§äº†ï¼Œé‚£å¯èƒ½åœ¨å†…å­˜é¡µæ‰©å¤§å‘ç”Ÿè¿™æœŸé—´å¦‚æœä½ åšä¸€äº›æ“ä½œå¯èƒ½ä¼šå¯¹å½“å‰ä¿¡æ¯çš„é˜»å¡ï¼Œæˆ‘ä»¬åœ¨çº¿ä¸Šé‡åˆ°è¿‡ä¸€ä¸ªæƒ…å†µï¼Œå¼€å¯äº†THPå±æ€§ï¼Œä½†å†™å…¥é‡æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œç”šè‡³ä¸€ä¸ª<code>incr</code>æ“ä½œï¼Œä¸€ä¸ªä¸å¯èƒ½å‡ºç°åœ¨æ…¢æŸ¥è¯¢åˆ—è¡¨çš„æ“ä½œå®ƒå‡ºç°åœ¨æ…¢æŸ¥è¯¢åˆ—è¡¨å½“ä¸­äº†ï¼Œå®ƒå°±ä¼šé€ æˆæ…¢æŸ¥è¯¢ï¼Œå½“ç„¶è¿˜æœ‰ä¸€ä¸ªæ˜¯å†…å­˜ä½¿ç”¨çš„é—®é¢˜ï¼šè¿™ä¸ªä½“ç°åœ¨å› ä¸ºè¿™ä¸ªforkä½¿ç”¨çš„æ˜¯<code>copy on write</code>å°±æ˜¯å†™æ—¶å¤åˆ¶ï¼Œå‡å¦‚ä½ çš„å†™å…¥é‡éå¸¸å¤§ï¼Œé‚£ä½ åŸæ¥çš„ä¸€ä¸ª4kbçš„å†…å­˜é¡µç°åœ¨è¦å˜æˆ2mbï¼Œä½ çš„å†™å…¥é‡éå¸¸å¤§ï¼Œæ„å‘³ç€å®ƒçš„<code>copy on write</code>é‡å¤§ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æš´å¢ï¼Œå‡å¦‚ä½ æ˜¯1GBçš„Redisï¼Œç”±äºå†…å­˜é¡µéå¸¸å¤§ä½†æ˜¯å¹¶ä¸æ˜¯è¯´Rediså†…å­˜å…¨éƒ½æ˜¯è¿ç»­çš„ï¼Œå†…å­˜é¡µå¤§é‡çš„å¤åˆ¶<code>copy on write</code>å¯èƒ½ä¼šé€ æˆå†…å­˜å¤§é‡çš„äº§ç”Ÿï¼Œå®ƒä¼šæç¤ºä½ ä¿®å¤è¿™ä¸ªé—®é¢˜å»ºè®®ä½ æŠŠè¿™ä¸ªç‰¹æ€§å…³é—­ï¼šecho neveræ‰“å°åˆ°æŒ‡å®šçš„è·¯å¾„ä¸‹ï¼Œå®ƒè¿˜ä¼šå»ºè®®ä½ æŠŠå®ƒæ·»åŠ åˆ°<code>/etc/rc.local</code>ä¸­ï¼ŒåŠæ—¶åœ¨é‡å¯äº†THPçš„ç‰¹æ•ˆä¾ç„¶ä¼šè¢«å…³é—­æ‰</p><h3 id="THPä½œç”¨"><a href="#THPä½œç”¨" class="headerlink" title="THPä½œç”¨"></a>THPä½œç”¨</h3><ol><li>ä½œç”¨ï¼šåŠ é€Ÿforkï¼›</li><li>å»ºè®®ï¼šç¦ç”¨ï¼Œå¯èƒ½äº§ç”Ÿæ›´å¤§çš„å†…å­˜å¼€é”€ï¼›</li><li>è®¾ç½®æ–¹æ³•ï¼š echo never&gt;/sys/kernel/mm/transparent_hugepage/enabled</li><li>å‘ï¼šæºç æ˜¯ç»å¯¹è·¯å¾„ï¼Œæ³¨æ„ä¸åŒå‘è¡Œç‰ˆæœ¬çš„åŒºåˆ«<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191111195140272.png" srcset="/img/loading.gif" alt="image-20191111195140272"><br>å®ƒä¼šfopenï¼Œè¿™ä¸ªè·¯å¾„ä¸‹å»æ‰¾åˆ°è¿™ä¸ªTHPæœ‰æ²¡æœ‰å¼€å¯ï¼Œå…¶å®è¿™æ ·å†™æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å®ƒæ²¡æœ‰é¢„æ–™åˆ°åœ¨ä¸åŒçš„Linuxå‘è¡Œç‰ˆæœ¬åƒcentoså¯èƒ½THPè¿™ä¸ªå±æ€§å¯¹åº”çš„è·¯å¾„æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚ç”¨å¾—çº¢å¸½ï¼Œå®ƒçš„è·¯å¾„ä¸Šæ²¡æœ‰THPè¿™ä¸ªå±æ€§ï¼Œå®ƒæ˜¯ç±»ä¼¼äºè‡ªå·±åŠ äº†ä¸€ä¸ªè·¯å¾„è®¾ç½®äº†THPï¼Œå¯¹äºRediså¯åŠ¨çš„æ—¶å€™å®ƒåªä¼šæ£€æµ‹ç»å¯¹è·¯å¾„ä¸ä¼šæ£€æµ‹ç›¸å¯¹è·¯å¾„ï¼Œå°±ä¼šå‡ºç°å®ƒæ²¡æœ‰ä»»ä½•æé†’ä½†æ˜¯ä½ å½“å‰æ˜¯åœ¨ä½¿ç”¨THPçš„æƒ…å†µï¼Œè¿™é‡Œåœ¨ä½ ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ä½ çš„Linuxçš„å‘è¡Œç‰ˆæœ¬</li></ol><h2 id="OOM-killer"><a href="#OOM-killer" class="headerlink" title="OOM killer"></a>OOM killer</h2><blockquote><p>Redisçš„æ˜¯å†…å­˜ï¼Œå¦‚æœå†…å­˜ä½¿ç”¨ä¸å½“ã€å†…å­˜æš´å¢ã€å†…å­˜è¶…è¿‡Linuxæœ¬èº«å†…å­˜çš„æƒ…å†µä¸‹å¯èƒ½æœ‰ä¼šæœ‰ä¸€ä¸ª<code>OOM Killer</code>ï¼ŒLinuxä¼šé€‰ä¸¾ä¸€äº›ä¸é‡è¦çš„ä¸€äº›è¿›ç¨‹è¿›è¡Œåˆ é™¤</p></blockquote><ol><li>ä½œç”¨ï¼šå½“å‰è¿™ä¸ªæœºå™¨å†…å­˜è¶…é‡å»ä½¿ç”¨äº†ï¼Œæ“ä½œç³»ç»Ÿä¼šæŒ‰ç…§æŸäº›è§„åˆ™æŠŠä¸€äº›ä¸é‡è¦çš„è¿›ç¨‹killæ‰</li><li>é…ç½®æ–¹æ³•ï¼š/proc/{progress_id}/oom_adjï¼Œoom_adjè¶Šå°æ€æ‰è¿›ç¨‹çš„æ¦‚ç‡è¶Šå°ã€‚å‰é¢æåˆ°å†…å­˜å·²ç»ä½¿ç”¨è¶…å‡ºäº†ï¼Œå‡å¦‚è¯´å½“å‰æœ‰10ä¸ªè¿›ç¨‹ï¼Œå®ƒä¼šä»oom_adjä¸­é€‰æ‹©æ¯”è¾ƒå¤§çš„è¿›ç¨‹è¿›è¡Œæ€é™¤ï¼Œè¿™é‡Œçš„æ€é™¤ç­–ç•¥æ˜¯éå¸¸å¤æ‚çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸ä¼šè¿›è¡Œè¯¦ç»†çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“éœ€è¦çŸ¥é“oom_adjè¿™ä¸ªå‚æ•°æ˜¯æ§åˆ¶å®ƒè¢«æ€çš„æ¦‚ç‡</li><li>è¿ç»´ç»éªŒï¼šå¯¹äºRedisæ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ¯ä¸€ä¸ªRedisçš„è¿›ç¨‹çš„oom_adjè®¾ç½®æ¯”è¾ƒå°ï¼Œåœ¨å‘ç”Ÿoom killerçš„æ—¶å€™ä¸ä¼šè¢«å¹²æ‰ï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­æˆ‘ä»¬ä¸ä¼šç”¨è¿™æ ·çš„è§„åˆ™ï¼Œé¦–å…ˆä¸€ç‚¹æˆ‘ä»¬å½“å‰æœºå™¨ä¸‹è‚¯å®šæ˜¯å•æœºå¤šéƒ¨ç½²ï¼Œè€Œä¸”æ˜¯éƒ¨ç½²ä¸€å †Redisï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸äºå…¶ä»–åº”ç”¨æ··éƒ¨å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆä¸ä¸“ä¸šçš„è¡Œä¸ºï¼Œè€Œä¸”ä¸€ä¸ªå°±æ˜¯è¯´ä¸è¦è¿‡åº¦ä¾èµ–äºæ­¤ç‰¹æ€§ï¼Œåº”è¯¥åˆç†ç®¡ç†å†…å­˜ã€‚<ul><li>æœ‰å…³OOM killerçš„è¯¦ç»†ç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒLinuxæºç ï¼šmm/oom_kill.cä¸­oom_badnesså‡½æ•°ï¼›</li><li>ç¬”è€…è®¤ä¸ºoom_adjå‚æ•°åªèƒ½èµ·åˆ°è¾…åŠ©ä½œç”¨ï¼Œåˆç†åœ°è§„åˆ’å†…å­˜æ›´ä¸ºé‡è¦ï¼›</li><li>é€šå¸¸åœ¨é«˜å¯ç”¨æƒ…å†µä¸‹ï¼Œè¢«æ€æ‰æ¯”åƒµæ­»æ›´å¥½ï¼Œå› æ­¤ä¸è¦è¿‡å¤šä¾èµ–oom_adjé…ç½®ã€‚</li></ul></li></ol><h2 id="NTPï¼ˆNet-Time-Protocolï¼‰"><a href="#NTPï¼ˆNet-Time-Protocolï¼‰" class="headerlink" title="NTPï¼ˆNet Time Protocolï¼‰"></a>NTPï¼ˆNet Time Protocolï¼‰</h2><blockquote><p>å®ƒæ˜¯ä¸€ä¸ªæ—¶é—´æœåŠ¡ï¼Œå¯ä»¥å®ç°ä¸€ä¸ªå…¬å…±çš„æ—¶é—´æœåŠ¡ï¼Œç›¸å½“äºä½ å¯ä»¥çœ‹åˆ°å®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†çš„æ—¶é—´ï¼Œç„¶åå…¶ä»–çš„ä¸€äº›æœºå™¨ã€ä¸€äº›æœåŠ¡å»å®ƒé‚£è¾¹å»æ‹¿ä¸€ä¸ªæ—¶é—´ï¼Œè®©å¤§å®¶è¾¾åˆ°ä¸€ä¸ªæ—¶é—´çš„ä¸€è‡´æ€§</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112190022980.png" srcset="/img/loading.gif" alt="image-20191112190022980">å®ƒå°±æ˜¯å¯¹æ—¶æœåŠ¡ï¼Œä½ å¯ä»¥ç†è§£ä¸ºå®ƒå°±æ˜¯ä¸€ä¸ªé’Ÿè¡¨ï¼Œæ¯”å¦‚åŒ—äº¬ä½¿ç”¨ã€æŸä¸ªåŒºåŸŸçš„ä¸€ä¸ªè¡¨ï¼Œå¯¹äºå®ƒä¸‹é¢çš„å¾ˆå¤šæœºå™¨ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å½“å‰æœ‰å¾ˆå¤šæœºå™¨ï¼Œé‚£æˆ‘å®Œå…¨å¯ä»¥å¯¹æ¯ä¸ªæœºå™¨æ‰§è¡Œä¸€ä¸ªå®šæ—¶è®¤ä¸ºï¼Œæ¯”å¦‚è¯´è®©å®ƒæ¯å°æ—¶å»è·ŸNTPåšä¸€æ¬¡åŒæ­¥ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬æœºå™¨ä¹‹é—´çš„æ—¶é—´æ˜¯ä¸€è‡´çš„ï¼Œå½“æ—¶é—´ä¸€è‡´çš„æ—¶å€™æˆ‘ä»¬å°±åœ¨åšä¸€äº›åˆ†å¸ƒå¼çš„æ—¶å€™å°±æ¯”è¾ƒå¥½æœ‰å¥½å¤„äº†ï¼Œæ¯”å¦‚å¯¹äºæ—¶é—´çš„ä¸€äº›åˆ¤æ–­æ˜¯ä¸€è‡´çš„ï¼Œè¿™æ ·å¯¹äºä¸€äº›è¡Œä¸ºçš„è§„å®šä¸€äº›å¤„ç†è¿™æ ·çš„è¯è¾¾åˆ°ä¸€è‡´çš„æ•ˆæœï¼Œå¯¹äºæˆ‘ä»¬Redisæ¥è¯´ï¼Œæˆ‘ä»¬å½“å‰çš„æ— è®ºæ˜¯RedisSentinelã€RedisClusterï¼Œå®ƒåšçš„é€‰ä¸¾æ˜¯ä¾èµ–ä¸æœ¬åœ°æœºå™¨çš„æ—¶é—´ï¼Œä¹Ÿå°±æ˜¯è¯´åŠæ—¶æ—¶é—´ä¸ä¸€è‡´ä¹Ÿä¸ä¼šå¯¹å½“å‰é›†ç¾¤çš„é€‰ä¸¾äº§ç”Ÿé—®é¢˜å› ä¸ºå®ƒä¾èµ–çš„æ˜¯æœ¬åœ°æ—¶é—´ï¼Œ ä½†æ˜¯ä»»ç„¶å¸Œæœ›ä½ æŠŠå®ƒåšä¸€ä¸ªè¿™æ ·çš„NTPæœåŠ¡å‘¢ï¼Ÿä¸ç„¶è¯´æˆ‘ä»¬å½“å‰æœ‰Nå°æœºå™¨ï¼Œç„¶åé›†ç¾¤ä¹‹é—´å½¢æˆäº†ä¸€ä¸ªé›†ç¾¤ï¼Œç„¶åæˆ‘ä»¬åœ¨æ’æŸ¥ä¸€äº›é—®é¢˜çš„æ—¶å€™ï¼Œå¦‚æœå‘ç°ä½ çš„æ—¶é—´ç‚¹éƒ½æ˜¯ä¸ä¸€è‡´çš„å¯¹äºä½ æ’æŸ¥é—®é¢˜çš„æ—¶å€™ä¹Ÿä¸æ˜¯éå¸¸çš„æ–¹ä¾¿ï¼Œæ‰€ä»¥è¿™é‡Œä»»ç„¶ä¼šå»ºè®®ä½ å»è·Ÿè¿™ä¸ªNTPæœåŠ¡åšä¸€ä¸ªå®æ—¶çš„å®šæ—¶ä»»åŠ¡</p><h2 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h2><blockquote><p>å¯¹äºè¿æ¥çš„é™åˆ¶</p></blockquote><h3 id="ulimitä¸Redis"><a href="#ulimitä¸Redis" class="headerlink" title="ulimitä¸Redis"></a>ulimitä¸Redis</h3><p>è¿™ä¸ªä¸»è¦æ˜¯å¯¹Linuxæ–‡ä»¶å¥æŸ„çš„é™åˆ¶è¿›è¡Œä¸€ä¸ªè®¾ç½®ï¼Œå®ƒäºRedisçš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿ</p><p>åœ¨ä½ å¯åŠ¨Redisçš„æ—¶å€™ï¼Œæ—¥å¿—ä¸­å¯ä»¥ä¼šå‡ºç°ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112191441944-1573557295700.png" srcset="/img/loading.gif" alt="image-20191112191441944"></p><p>å®ƒä¼šå‘Šè¯‰ä½ å½“å‰Redisçš„maxclientsè®¾ç½®çš„æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°æ˜¯1Wï¼Œä½ è‡³å°‘éœ€è¦10032æ–‡ä»¶å¥æŸ„ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå°±æ˜¯è¯´Redisé»˜è®¤çš„ maxclientsæ˜¯1Wï¼Œå®ƒä¸ºä»€ä¹ˆéœ€è¦1Wå’Œ10032ä¸ªæ–‡ä»¶å¥æŸ„ï¼Ÿæ˜¯å› ä¸ºé™¤äº†ä½ çš„å®¢æˆ·ç«¯è¿æ¥ä»¥å¤–Redisè‡ªèº«ä¹Ÿéœ€è¦å¾ˆå¤šæ–‡ä»¶å¥æŸ„ï¼Œå®ƒä¼šå‘Šè¯‰ä½ å½“å‰Redisæ˜¯ä¸èƒ½æŠŠæ–‡ä»¶å¥æŸ„è®¾ç½®æˆ10032ä¸ªï¼Œæ˜¯å› ä¸ºå½“å‰æ²¡æœ‰æƒé™ï¼Œå› ä¸ºå¯èƒ½ä½ åœ¨å¯åŠ¨Redisçš„æ—¶å€™æ²¡æœ‰ä½¿ç”¨rootç”¨æˆ·ï¼ˆå½“ç„¶è¿™é‡Œä¸å»ºè®®ä½ å»ä½¿ç”¨rootç”¨æˆ·ï¼‰ï¼Œå®ƒå‘Šè¯‰ä½ å½“å‰æœ€å¤§çš„æ–‡ä»¶å¥æŸ„æ˜¯4096ä¸ªï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒå»ºè®®ä½ æŠŠmaxclientsè®¾ç½®æˆ4064ä¸ªï¼Œå®é™…ä¸Šå°±æ˜¯4096å»å‡å»32ï¼Œé‚£å¦‚æœä½ æƒ³å»è®¾ç½®æ›´é«˜çš„å€¼ï¼Œé‚£ä½ å°±æŠŠå®ƒæ‰§è¡Œä¸€ä¸ª<code>ulimit -n</code>ï¼Œè¿™æ ·ä¸€ä¸ªè®¾ç½®ï¼ŒæŠŠä½ å½“å‰çš„è¿›ç¨‹çš„æ–‡ä»¶å¥æŸ„è®¾ç½®çš„æ›´å¤§ä¸€äº›è¿™æ ·å¯ä»¥æ»¡è¶³Redisçš„ä¸€ä¸ªéœ€æ±‚ã€‚å…¶å®è¯´äº†è¿™ä¹ˆå¤šå°±æ˜¯Rediså¯åŠ¨çš„æ—¶å€™æ˜¯éœ€è¦10032ä¸ªå¥æŸ„ï¼Œä½ å½“å‰å¥æŸ„æ•°æ¯”è¾ƒå°ï¼Œåªæœ‰4096é‚£å»ºè®®ä½ å»è¿›è¡Œä¸€ä¸ªè®¾ç½®ï¼Œä½ åœ¨å¯åŠ¨ä¸€å®šè¦ç»™è¿›ç¨‹è¿›è¡Œä¸€ä¸ªè®¾ç½®ã€‚</p><h2 id="TCP-backlog"><a href="#TCP-backlog" class="headerlink" title="TCP backlog"></a>TCP backlog</h2><blockquote><p>é’ˆå¯¹TCPç½‘ç»œçš„è¿æ¥æ—¶ï¼ŒTCP3æ¬¡æ¡æ‰‹ä¼šæœ‰ä¸€ä¸ªasyncå¯¹åˆ—ï¼Œé’ˆå¯¹é‚£ä¸ªä¸œè¥¿è¿›è¡Œä¸€äº›è®¾ç½®</p></blockquote><h1 id="å®‰å…¨çš„Redis"><a href="#å®‰å…¨çš„Redis" class="headerlink" title="å®‰å…¨çš„Redis"></a><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112192420855.png" srcset="/img/loading.gif" alt="image-20191112192420855">å®‰å…¨çš„Redis</h1><h2 id="å…¨å±€crackitæ”»å‡»"><a href="#å…¨å±€crackitæ”»å‡»" class="headerlink" title="å…¨å±€crackitæ”»å‡»"></a>å…¨å±€crackitæ”»å‡»</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112193358968.png" srcset="/img/loading.gif" alt="image-20191112193358968"></p><h3 id="è¢«æ”»å‡»çš„Redisç‰¹å¾"><a href="#è¢«æ”»å‡»çš„Redisç‰¹å¾" class="headerlink" title="è¢«æ”»å‡»çš„Redisç‰¹å¾"></a>è¢«æ”»å‡»çš„Redisç‰¹å¾</h3><ol><li>Redisæ‰€åœ¨çš„æœºå™¨æœ‰å¤–ç½‘IPï¼›</li><li>Redisä»¥é»˜è®¤ç«¯å£6379ä¸ºå¯åŠ¨ç«¯å£ï¼Œå¹¶ä¸”æ˜¯å¯¹å¤–ç½‘å¼€æ”¾çš„ï¼›</li><li>Redisæ˜¯ä»¥rootç”¨æˆ·å¯åŠ¨çš„ï¼›</li><li>Redisæ²¡æœ‰è®¾ç½®å¯†ç ï¼›</li><li>Redisçš„bindè®¾ç½®ä¸º0.0.0.0æˆ–è€…â€œâ€ã€‚</li></ol><h3 id="æ”»å‡»æ–¹å¼"><a href="#æ”»å‡»æ–¹å¼" class="headerlink" title="æ”»å‡»æ–¹å¼"></a>æ”»å‡»æ–¹å¼</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112193722132.png" srcset="/img/loading.gif" alt="image-20191112193722132"></p><p>å·¦è¾¹éƒ¨åˆ†ä»£è¡¨æ”»å‡»çš„æœºå™¨ï¼Œå³è¾¹æ˜¯è¢«æ”»å‡»çš„æœºå™¨ï¼Œå®ƒå½“å‰æ˜¯ä¸€ä¸ªå…¬ç½‘å¯åŠ¨äº†ä¸€ä¸ªRedisï¼Œè¿™ä¸ªRedisæ˜¯ä»¥rootå¯ç”¨çš„ï¼Œè€Œä¸”ç»‘å®šç½‘å¡æ˜¯0.0.0ï¼Œä¹Ÿå°±æ˜¯å®ƒæ²¡æœ‰ç»‘å®šï¼Œç„¶åå®ƒç«¯å£ä¹Ÿæ²¡æœ‰åšé™åˆ¶ï¼Œå®ƒå…è®¸å…¬ç½‘çš„ä»»ä½•ç«¯å£å¯¹å¤–æš´éœ²ï¼Œä»¥6379å¯åŠ¨ï¼›</p><p>ç°åœ¨æ¥çœ‹ä¸€ä¸‹æ”»å‡»æ­¥éª¤ï¼Œå¾ˆæ˜¾ç„¶ssh rootè¿™å°æœºå™¨ï¼Œè¿™æ ·æ˜¯å¯ä»¥è¿é€šçš„ï¼Œå› ä¸ºä½ æ²¡æœ‰å¯†ç ï¼Œè€Œä¸”ä½ æ²¡æœ‰æˆæƒï¼Œè¿™ä¸ªæ—¶å€™æ˜¯è¿æ¥ä¸ä¸Šçš„ï¼Œè¿™é‡Œæˆ‘å¯ä»¥å…ˆè¿æ¥Redisï¼Œå› ä¸ºRedisæ²¡æœ‰è®¾ç½®å¯†ç ï¼Œæ²¡æœ‰åšé™åˆ¶ï¼Œè¿æ¥ä¹‹åæˆ‘å¯ä»¥æ‰§è¡Œä¸€ä¸ª <code>flushall</code>ï¼Œå½“å‰å°±æŠŠä½ çš„Redisæ¸…é™¤äº†ï¼Œè¿™å…¶å®ä¸å¤Ÿåï¼Œè¿™æ ·åªå½±å“äº†Redisæ²¡æœ‰å½±å“æœºå™¨æœ¬èº«ï¼Œé‚£æˆ‘å¯ä»¥ç»§ç»­ç”¨Redisçš„ç‰¹ç‚¹ æ¥å®Œæˆä¸‹é¢çš„äº‹æƒ…ï¼Œé¦–å…ˆè®¾ç½®ä¸€ä¸ªkeyå«åšcrackitzè¿™ä¸ªkeyï¼Œç„¶åæˆ‘æŠŠå®ƒè®¾ç½®å€¼æ˜¯æˆ‘å½“å‰çš„å…¬é’¥çš„ä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åæˆ‘å¯¹å½“å‰è¿™ä¸ªRediså»æ‰§è¡Œ<code>config set dirï¼Œ</code>æˆ‘ç»™å®ƒè®¾ç½®ä¸€ä¸ªæ–°çš„dirï¼Œæˆ‘æŠŠå®ƒè®¾ç½®æˆsshç›®å½•ä¸‹ï¼Œç„¶åæˆ‘ä¼šæ‰§è¡Œ``config set dbfilename`ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘è®¾ç½®ä¸€ä¸ªè‡ªå·±çš„ä¸€ä¸ªdbfilenameï¼Œå°±æ¯”å¦‚è¯´æ˜¯ä¸€ä¸ªæˆæƒæ–‡ä»¶ï¼Œç„¶åæ‰§è¡Œsaveï¼Œé‚£å®ƒå°±ç›¸å½“äºåœ¨.sshé‡Œé¢æˆæƒæ–‡ä»¶é‡Œé¢å»æ·»åŠ äº†è¿™å°æ”»å‡»æœºå™¨Açš„å…¬é’¥ï¼Œè¿™æ ·çš„è¯æˆ‘ä¸‹é¢å°±å¯ä»¥å…å¯†ç å»è®¿é—®è¿™å°æœºå™¨å¹²å¾ˆå¤šçš„åäº‹</p><h2 id="Rediså®‰å…¨ä¸ƒæ³•"><a href="#Rediså®‰å…¨ä¸ƒæ³•" class="headerlink" title="Rediså®‰å…¨ä¸ƒæ³•"></a>Rediså®‰å…¨ä¸ƒæ³•</h2><h3 id="è®¾ç½®å¯†ç "><a href="#è®¾ç½®å¯†ç " class="headerlink" title="è®¾ç½®å¯†ç "></a>è®¾ç½®å¯†ç </h3><ol><li>æœåŠ¡ç«¯è®¾ç½®ï¼šè®¾ç½®å¯†ç å°±æ˜¯requirepassè¿™ä¸ªå‚æ•°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æˆ‘ä»¬è¦ä¸ºä»èŠ‚ç‚¹è®¾ç½®masterauthï¼Œè¿™æ ·çš„è¯ä»èŠ‚ç‚¹å°±èƒ½åŒæ­¥ä¸»èŠ‚ç‚¹å‘½ä»¤ï¼Œä¸ºäº†é˜²æ­¢ä¸»ä»ä¹‹é—´çš„åˆ‡æ¢ï¼Œæˆ‘ä»¬å»ºè®®ä½ æŠŠrequirepasså’Œmasterauthåœ¨ä¸»ä»èŠ‚ç‚¹éƒ½è¿›è¡Œä¸€ä¸ªè®¾ç½®ï¼Œè¿™æ ·çš„è¯å³ä½¿å‘ç”Ÿäº†ä¸»ä»åˆ‡æ¢ï¼Œå®ƒä»»ç„¶å¯ä»¥å®Œæˆå„è‡ªçš„èŒè´£ï¼›</li><li>å®¢æˆ·ç«¯è¿æ¥ï¼šauthå‘½ä»¤å’Œ-aå‚æ•°</li><li>ç›¸å…³å»ºè®®ï¼š<ul><li>å¯†ç è¶³å¤Ÿå¤æ‚ï¼Œé˜²æ­¢æš´åŠ›ç ´è§£ï¼›</li><li>masterauthä¸è¦å¿˜è®°ï¼›</li><li>authè¿˜æ˜¯é€šè¿‡æ˜æ–‡ä¼ è¾“ï¼Œæ„å‘³ç€é€šè¿‡ç½‘ç»œçš„ä¸€äº›ç›‘å¬ï¼Œæ¯”å¦‚è¯´å¯¹ç½‘ç»œè¿›è¡ŒæŠ“åŒ…ï¼Œå¯ä»¥æ‹¿åˆ°ä¸­é—´å¯èƒ½äº§ç”Ÿçš„ä¸€ç³»åˆ—å¯†ç ï¼Œè¿™æ ·çš„è¯æŠ“è¿‡æ¥ä¹‹åå¯ä»¥è¿›è¡Œä¸€ä¸ªè§£æåšå¾ˆå¤šçš„åäº‹ï¼Œè¿™ä¸ªæš‚æ—¶æ²¡æœ‰å¤ªå¥½çš„æ–¹æ³•ï¼Œä¸€äº›äº‘æœåŠ¡æä¾›ç±»ä¼¼äºSSLå®‰å…¨çš„ä¸€äº›æ–¹å¼è¿›è¡Œæ–‡æœ¬åè®®çš„ä¼ è¾“æ¥å‡å°‘è¿™æ ·çš„é—®é¢˜ï¼Œä½†æ•´ä½“æ¥è¯´Redisæ˜¯è¿è¡Œåœ¨å†…ç½‘ä¸­çš„ï¼Œåªè¦ä½ ä¿è¯å®ƒæœ‰å¯†ç ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸ä¼šè¢«æŒ–å–åˆ°</li></ul></li></ol><h3 id="ä¼ªè£…å±é™©å‘½ä»¤"><a href="#ä¼ªè£…å±é™©å‘½ä»¤" class="headerlink" title="ä¼ªè£…å±é™©å‘½ä»¤"></a>ä¼ªè£…å±é™©å‘½ä»¤</h3><ol><li>æœåŠ¡ç«¯é…ç½®ï¼šrename-commandï¼Œå®ƒå¯ä»¥å°†å½“å‰å‘½ä»¤ä¼ªè£…æˆå…¶ä»–å­—ç¬¦æˆ–è€…ä¸€ä¸ªç©ºï¼Œå®ƒæœ‰ä»€ä¹ˆå«ä¹‰å‘¢ï¼Ÿå‡å¦‚æˆ‘ä¸å¸Œæœ›å®¢æˆ·ç«¯å»ä½¿ç”¨<code>flushall</code>è¿™æ ·çš„å‘½ä»¤ï¼Œæˆ‘å¯ä»¥å°†<code>flushall</code>ä¼ªè£…æˆä¹Ÿç»™ç©ºçš„å­—ç¬¦ä¸²ï¼ŒæŠŠè¿™ä¸ªå‘½ä»¤å¹²è„†ç¦æ‰æˆ–è€…ä¼ªè£…æˆéšæœºå­—ç¬¦ä¸²</li><li>å®¢æˆ·ç«¯è¿æ¥ï¼šä¸å¯ç”¨æˆ–è€…ä½¿ç”¨æŒ‡å®šéšæœºå­—ç¬¦ï¼›</li><li>ç›¸å…³å»ºè®®ï¼š<ul><li>ä¸æ”¯æŒconfig setåŠ¨æ€è®¾ç½®ï¼›</li><li>RDBå’ŒAOFå¦‚ä½•åŒ…å«rename-commandä¹‹å‰çš„å‘½ä»¤ï¼Œå°†æ— æ³•ä½¿ç”¨</li><li>configå‘½ä»¤æœ¬èº«æ˜¯åœ¨Rediså†…æ ¸ä¼šä½¿ç”¨åˆ°ï¼Œä¸å»ºè®®è®¾ç½®</li></ul></li></ol><h3 id="bind"><a href="#bind" class="headerlink" title="bind"></a>bind</h3><ol><li>æœåŠ¡ç«¯é…ç½®ï¼šbindå¯ä»¥é™åˆ¶ç½‘å¡çš„è¾“å…¥æµé‡ï¼Œå‡å¦‚è¯´ä½ æœ‰4ä¸ªç½‘å¡æˆ–è€…4ä¸ªipåœ°å€ï¼Œå®ƒå¯èƒ½é™åˆ¶å½“å‰çš„Redisæµé‡æ˜¯ä»å“ªä¸ªç½‘å¡å»æ‰“å…¥çš„ï¼Œæ³¨æ„è¿™é‡Œå®ƒä¸æ˜¯é™åˆ¶å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå¾ˆå®¹æ˜“è®©åˆšåˆšæ¥è§¦å®ƒçš„äººå»è¿·æƒ‘çš„è¿™ä¸ªå‘½ä»¤æ˜¯é™åˆ¶æŸäº›ç½‘å…³çš„IPå®¢æˆ·ç«¯èƒ½è®¿é—®ï¼Œå®ƒæ— æ³•é™åˆ¶IPï¼Œå®ƒåªèƒ½é™åˆ¶ç½‘å¡çš„æµé‡ï¼›</li><li>ç›¸å…³å»ºè®®ï¼š<ul><li>bindä¸æ”¯æŒconfig setï¼›</li><li>bind 127.0.0.1éœ€è¦è°¨æ…ï¼Œå¦‚æœä½ è®¾ç½®127.0.0.1åªèƒ½ä»æœ¬æœºå»è®¿é—®ï¼Œè¿™ä¸ªä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºå‡å¦‚ä½ RedisçœŸæ˜¯å’Œä½ çš„åº”ç”¨æ”¾åœ¨ä¸€ä¸ªæœºä¸Šï¼Œä½ å¯ä»¥è¿™æ ·è®¾ç½®ï¼Œä½†å®é™…ä¸­è‚¯å®šæœ‰å¾ˆå¤šå…¶å®ƒçš„æµé‡å»è®¿é—®åˆ°Redisï¼Œè€Œä¸”å¾ˆå¤šRedisæ˜¯åšåˆ†å¸ƒå¼çš„ï¼Œå®ƒéœ€è¦èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡ï¼Œå¦‚æœä½ è®¾ç½®è¿™æ ·ä¸€ä¸ªé€‰é¡¹çš„è¯ä¼šå¯¹åˆ†å¸ƒå¼çš„ä½¿ç”¨æœ‰å½±å“æˆ–è€…è¯´å¹²è„†å°±ä½¿ç”¨ä¸äº†ï¼›</li><li>å¦‚æœå­˜åœ¨å¤–ç½‘ç½‘å¡ï¼Œç»é‡å»è®¾ç½®è¿™æ ·çš„é…ç½®ï¼Œå®ƒèƒ½ä¿è¯ä½ çš„æµé‡ä¸ä¼šä»å¤–ç½‘å»æ‰“å…¥è¿›æ¥ï¼›</li></ul></li></ol><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ol><li>é˜²ç«å¢™ï¼šæ€æ‰‹é”ï¼Œä½ è®¾ç½®ä»»ä½•å¯†ç ä¹Ÿä¸å¦‚ä½ è®¾ç½®ä¸€ä¸ªé˜²ç«å¢™æœ‰ç”¨ï¼Œä½†æ˜¯é˜²ç«å¢™çš„è®¾ç½®ä¸€å®šè¦æ³¨æ„ï¼Œæ¯”å¦‚è¯´åƒRedisClusterèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡æˆ–è€…ä½ åœ¨åšåˆ†å¸ƒå¼çš„æ—¶å€™æˆ–è€…ä½ å¯¹å¤–ç½‘çš„ä¸€ä¸ªè®¿é—®ï¼Œå°±æ˜¯å¤–ç½‘IPå†…ç½‘IPçš„ä¸€ä¸ªè®¿é—®çš„æ—¶å€™ä¸€å®šè¦è®¾ç½®æ¸…æ¥šï¼Œå¦åˆ™å‡ºç°ç½‘ç»œä¸é€šçš„æƒ…å†µä¸‹å¯èƒ½å¯¹ä½ Redisä½¿ç”¨ä¼šæœ‰ä¸€å®šå½±å“ï¼›</li><li>å®šæœŸå¤‡ä»½ï¼Œè¿™ä¸ªæ˜¯æ ¹æ®å‰é¢è®²çš„å®‰å…¨äº‹ä»¶æ€»ç»“å‡ºæ¥çš„ï¼Œä¸‡ä¸€ä½ çš„æ•°æ®è¢«åˆ äº†ï¼Œæˆ–è€…è¯´ä¸»æœºè¢«æ”»é™·äº†ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªå®šæœŸå¤‡ä»½çš„æ•°æ®ï¼Œä¹Ÿä¸è‡³äºè®©Redisæ•°æ®ä¸¢å¤±ï¼›</li><li>ä¸å¤ªç®¡ç”¨çš„æ–¹æ³•ï¼Œåœ¨ä¸ªåˆ«æƒ…å†µä¸‹ç®¡ç”¨ï¼Œä¸ä½¿ç”¨é»˜è®¤ç«¯å£ï¼Œé˜²æ­¢è¢«å¼±æ”»å‡»æ€æ‰ï¼›</li><li>å¼ºåˆ¶ï¼šä½¿ç”¨érootç”¨æˆ·å¯åŠ¨ï¼Œå‡å¦‚è¯´æ”»å‡»è€…æ‹¿åˆ°rootç”¨æˆ·æƒé™ï¼Œé‚£å±å®³æ˜¯éå¸¸å¤§çš„</li></ol><h1 id="çƒ­ç‚¹Keyå‘ç°"><a href="#çƒ­ç‚¹Keyå‘ç°" class="headerlink" title="çƒ­ç‚¹Keyå‘ç°"></a>çƒ­ç‚¹Keyå‘ç°</h1><h2 id="çƒ­ç‚¹keyçš„å¯»æ‰¾æ–¹æ³•"><a href="#çƒ­ç‚¹keyçš„å¯»æ‰¾æ–¹æ³•" class="headerlink" title="çƒ­ç‚¹keyçš„å¯»æ‰¾æ–¹æ³•"></a>çƒ­ç‚¹keyçš„å¯»æ‰¾æ–¹æ³•</h2><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><blockquote><p>å› ä¸ºå®¢æˆ·ç«¯æ˜¯è®¿é—®Redisçš„æ•°æ®æ¥æºï¼Œæˆ‘ä»¬çŸ¥é“æ‰€æœ‰çš„è¯·æ±‚æ˜¯åœ¨å“ªé‡Œ</p></blockquote><p>è¿™é‡Œå®¢æˆ·ç«¯æ¥è§£å†³ä¸æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„æ–¹æ³•ï¼Œä¾‹å¦‚æˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªè¿™æ ·çš„ä¸œè¥¿ï¼Œæˆ‘ä»¬å¯ä»¥è®°å½•æ¯åˆ†é’Ÿæ¯ä¸ªkeyçš„è°ƒç”¨æ¬¡æ•°ï¼Œç„¶åæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯å»è®°å½•è¿™æ ·çš„ä¸œè¥¿ï¼Œç„¶åå®šæœŸçš„å»æ¸…ç†è¿™ä¸ªmapä¸­çš„è®¿é—®æ¬¡æ•°ï¼Œè¿™æ ·é˜²æ­¢ä½ çš„mapè¿‡å¤§ï¼Œä½†æ˜¯è¿™é‡Œä»»ç„¶æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå³ä½¿ä½ åªè®°å½•ä¸€åˆ†é’Ÿçš„å¯èƒ½ä½ çš„mapä¹Ÿéå¸¸å¤§ï¼Œè€Œä¸”å®¢æˆ·ç«¯å»è®°å½•è¿™æ ·çš„ä¸œè¥¿æœ¬èº«ä¹Ÿä¼šå¢åŠ ä½ å®¢æˆ·ç«¯çš„ä¸šåŠ¡é€»è¾‘ï¼Œä¸å»ºè®®å»ä½¿ç”¨ï¼Œå‡å¦‚ä½ çš„keyå¾ˆå°‘æˆ–è€…è¯´ä½ å½“å‰çš„æƒ…å†µä¸‹æ˜¯å…è®¸è¿™æ ·åšï¼Œå»ºè®®ä½ å»è®¾ç½®ï¼Œå¯ä»¥é‡‡ç”¨è¿™æ ·çš„æ€è·¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112212752956.png" srcset="/img/loading.gif" alt="image-20191112212752956"></p><h3 id="ä»£ç†ç«¯"><a href="#ä»£ç†ç«¯" class="headerlink" title="ä»£ç†ç«¯"></a>ä»£ç†ç«¯</h3><blockquote><p>ä½¿ç”¨codisè¿™æ ·çš„å·¥å…·ä»ä»£ç†ç«¯è·å–æ•°æ®</p></blockquote><p>åƒä½¿ç”¨codisï¼Œå®ƒæ˜¯æ‰€æœ‰æµé‡éƒ½æ‰“åˆ°ä»£ç†ä¸Šçš„ï¼Œç„¶åä»£ç†å¯ä»¥æœ‰ä¸€ä¸ªæƒé‡é‡çš„ä¸€ä¸ªç»Ÿè®¡ï¼Œå¯ä»¥åšç±»æ˜¯çš„äº‹æƒ… ï¼Œä½†æ˜¯ä»ç„¶æœ‰é‚£æ ·çš„é—®é¢˜ï¼šä¸€ä¸ªæ˜¯ä»£ç†è¦å¢åŠ ä»£ç†çš„é€»è¾‘ï¼Œå®ç°å¤æ‚åº¦çš„é€»è¾‘ï¼Œè¿˜æœ‰å°±æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ä»£ç†å¯ä»¥æ˜¯å¤šä¸ªï¼Œå› ä¸ºä»£ç†çš„è´Ÿè½½ä¼šå¾ˆé«˜ï¼Œå®ƒéœ€è¦æ»¡è¶³åº•ä¸‹å¾ˆå¤šRedisçš„è§„æ¨¡ç„¶è¿›è¡Œå®¢æˆ·ç«¯çš„è¦æ±‚ï¼Œæ‰€ä»¥ä»£ç†ä¼šéå¸¸å¤šï¼Œåšè¿™ä¸ªä¹Ÿä¼šå¾ˆå¤æ‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112213120406.png" srcset="/img/loading.gif" alt="image-20191112213120406"></p><h3 id="æœåŠ¡ç«¯"><a href="#æœåŠ¡ç«¯" class="headerlink" title="æœåŠ¡ç«¯"></a>æœåŠ¡ç«¯</h3><blockquote><p>é€šè¿‡Redisç»Ÿè®¡çƒ­ç‚¹keyåœ¨å“ªé‡Œ</p></blockquote><p>ä½¿ç”¨monitorè¿™æ ·çš„å‘½ä»¤è§£æRedisæ‰§è¡Œäº†å“ªäº›ä¸œè¥¿ï¼Œé€šè¿‡monitorçŸ­æš‚çš„è§£æè¿™ä¸ªä¸œè¥¿ ï¼Œæ¯”å¦‚ä½¿ç”¨å®ƒå»åˆ†æè¿‘10Wæ¡Redisçš„å‘½ä»¤å¹¶æ‰¾å‡ºæ¯”å¦‚è¯´å“ªäº›å‘½ä»¤å‘½ä»¤æ‰§è¡Œçš„æ¯”è¾ƒå¤šï¼Œæ˜¯get-setè¿˜æ˜¯hget-hsetæ¯”è¾ƒå¤šï¼Œç„¶åæˆ‘ä»¬å¯ä»¥æ€»ç»“è¿™10Wæ¡å‘½ä»¤ä¸­å“ªäº›keyçš„å‰ç¼€å‡ºç°çš„æ¯”è¾ƒå¤šï¼Œè¿™æ ·å°±æœ‰å¯èƒ½å»æ‰¾åˆ°å¯¹åº”çš„çƒ­ç‚¹keyï¼Œä½†æ˜¯å‰é¢å·²ç»ä»‹ç»äº†monitorçš„å„ç§é—®é¢˜ï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨è¿™ç§monitorçš„æ–¹å¼æ—¶å€™è¦å°½é‡å°å¿ƒä¸€ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112213522769.png" srcset="/img/loading.gif" alt="image-20191112213522769"></p><h3 id="æœºå™¨æ”¶é›†"><a href="#æœºå™¨æ”¶é›†" class="headerlink" title="æœºå™¨æ”¶é›†"></a>æœºå™¨æ”¶é›†</h3><blockquote><p>ä½¿ç”¨æœºå™¨çš„æŠ“åŒ…ã€å¯¹äºæ•°æ®åè®®çš„åˆ†ææ¥æ‰¾åˆ°å¯¹åº”çš„çƒ­ç‚¹</p></blockquote><p>å‡è®¾ç°åœ¨æœ‰å¾ˆå¤šRediséƒ¨ç½²åœ¨å¤šä¸ªæœºå™¨æˆ–è€…ä¸€ä¸ªæœºå™¨ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹è¿™å¤ªæœºå™¨ç½‘ç»œåŒ…çš„åˆ†æï¼Œæˆ‘ä»¬å¯ä»¥æŠ“å–è¿™äº›ä¿¡æ¯çš„Redisçš„ä¸€ä¸ªTCPæ•°æ®æ¥å¯¹è¿™ä¸ªå½“å‰çš„æœºå™¨ä¸Šæ‰€æœ‰çš„æµé‡è¿›è¡Œåˆ†æï¼Œè¿™æ ·çš„è¯ä¹Ÿå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„çƒ­ç‚¹keyã€‚ä¸Šè¿°éƒ½æä¾›äº†RedisæŠ“å–çƒ­ç‚¹keyã€å¯»æ‰¾çƒ­ç‚¹keyçš„æ€è·¯ï¼Œåœ¨å®é™…ç”Ÿäº§è¿‡ç¨‹ä¸­ä½ è¦æ ¹æ®å¯¹åº”çš„ä¸€ä¸ªä½¿ç”¨åœºæ™¯æˆ–è€…Redisçš„è§„æ¨¡ã€å…·ä½“æƒ…å†µæ¥è¿›è¡Œåˆ†æ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112213914768.png" srcset="/img/loading.gif" alt="image-20191112213914768"></p><h2 id="å››ç§æ–¹å¼æ€»ç»“"><a href="#å››ç§æ–¹å¼æ€»ç»“" class="headerlink" title="å››ç§æ–¹å¼æ€»ç»“"></a>å››ç§æ–¹å¼æ€»ç»“</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191112213927833.png" srcset="/img/loading.gif" alt="image-20191112213927833"></p>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 14.å†…å­˜ç®¡ç†</title>
    <link href="/redis-14.html"/>
    <url>/redis-14.html</url>
    
    <content type="html"><![CDATA[<h1 id="Rediså†…å­˜ä¼˜åŒ–ä»‹ç»"><a href="#Rediså†…å­˜ä¼˜åŒ–ä»‹ç»" class="headerlink" title="Rediså†…å­˜ä¼˜åŒ–ä»‹ç»"></a>Rediså†…å­˜ä¼˜åŒ–ä»‹ç»</h1><p>Redisæ˜¯ä¸€ä¸ªå­˜å†…å­˜çš„ç¼“å­˜/å­˜å‚¨ï¼Œè¿™ä¹Ÿæ˜¯å®ƒéå¸¸å¿«çš„åŸå› ï¼Œä½†æ˜¯æˆ‘ä»¬åŒæ—¶çŸ¥é“å…¶å®å†…å­˜ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒæ˜‚è´µçš„ï¼Œå½“ç„¶å®ƒæ¯”CPUè¦ä¾¿å®œå¾ˆå¤šï¼Œå½“æ—¶ç›¸å¯¹äºå…¶ä»–ç¡¬ä»¶æ¥è¯´å®ƒçš„æ€»ä½“ä»·æ ¼è¦é«˜å¾ˆå¤šï¼Œè™½ç„¶è¯´ä½¿ç”¨Rediséå¸¸å¿«ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å»ä½¿ç”¨Redisçš„é‡éå¸¸å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›èƒ½èŠ‚çœæ›´å¤šçš„å†…å­˜ï¼Œå½“ç„¶èŠ‚çœå†…å­˜ä¹Ÿæ˜¯è¦æœ‰é™åº¦çš„ï¼Œä¸èƒ½å› ä¸ºèŠ‚çœå†…å­˜è€Œè®©æˆ‘ä»¬Redisçš„ä½¿ç”¨æ•ˆç›Šä¸‹é™ï¼Œè¿™ç« æ¥ä»‹ç»Rediså†…å­˜ä¼˜åŒ–çš„ä¸€äº›æŠ€å·§</p><h1 id="å†…å­˜æ¶ˆè€—"><a href="#å†…å­˜æ¶ˆè€—" class="headerlink" title="å†…å­˜æ¶ˆè€—"></a>å†…å­˜æ¶ˆè€—</h1><h2 id="å†…å­˜ä½¿ç”¨ç»Ÿè®¡"><a href="#å†…å­˜ä½¿ç”¨ç»Ÿè®¡" class="headerlink" title="å†…å­˜ä½¿ç”¨ç»Ÿè®¡"></a>å†…å­˜ä½¿ç”¨ç»Ÿè®¡</h2><blockquote><p>Redisä½œä¸ºéå¸¸å¥½çš„kvç¼“å­˜ã€å­˜å‚¨å®ƒç»™æˆ‘ä»¬æä¾›è¿™æ ·çš„ä¿¡æ¯ï¼Œé€šè¿‡<code>info memory</code>æ¥æŸ¥çœ‹Redisä½¿ç”¨çŠ¶å†µ</p></blockquote><p>å†…å­˜ä½¿ç”¨ç»Ÿè®¡ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106193830684.png" srcset="/img/loading.gif" alt="image-20191106193830684"></p><p>å‡å¦‚ç°åœ¨<code>redis-cli</code>æ‰§è¡Œäº†ä¸€ä¸ª<code>info memory</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106194219160.png" srcset="/img/loading.gif" alt="image-20191106194219160"></p><h2 id="å†…å­˜æ¶ˆè€—åˆ’åˆ†"><a href="#å†…å­˜æ¶ˆè€—åˆ’åˆ†" class="headerlink" title="å†…å­˜æ¶ˆè€—åˆ’åˆ†"></a>å†…å­˜æ¶ˆè€—åˆ’åˆ†</h2><blockquote><p>å¯¹Redisåšä¸€ä¸ªæ›´åŠ ç»†åˆ†çš„ä¸€ä¸ªåˆ†æï¼Œä¸Šé¢è¿™ç§æ–¹å¼åªæ˜¯èƒ½è·å–å…¨å±€çš„å†…å­˜ä½¿ç”¨ï¼Œä½†æ˜¯å¯¹äºæ¯ä¸€ä¸ªç»†èŠ‚çš„åœ°æ–¹å®ƒåšçš„è¿˜ä¸å¤Ÿç»†ï¼Œåœ¨æ–°çš„Redis 4.0ç‰ˆæœ¬é‡Œå·²ç»æä¾›äº†è¿™æ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™é‡Œä¸»è¦è¿˜æ˜¯è®²çº¿ä¸Šã€å…¬å¸ç”¨çš„æ¯”è¾ƒå¤šçš„ç‰ˆæœ¬ï¼š3.2ç‰ˆæœ¬ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆä¸è®²æœ€æ–°çš„ï¼Ÿå…¶å®æ˜¯è¿™æ ·ï¼Œå¯¹äºRedisè¿™ç§å­˜å‚¨æ¥è¯´ï¼Œå‡å¦‚æˆ‘ä»¬å…¬å¸æœ‰å‡ ä¸‡ä¸ªèŠ‚ç‚¹ï¼Œé‚£æˆ‘èƒ½ä¸èƒ½ä¸€ä¸‹ä»Redis3å‡çº§æˆRedis4å‘¢ï¼Ÿå…¶å®è¿™æ˜¯éå¸¸éš¾çš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºæˆ‘ä»¬åšçš„æ˜¯æ•°æ®ï¼Œè¿™é‡Œé¢çš„æ•°æ®ä¼šæ¶‰åŠåˆ°è¿ç§»ï¼Œè¿ç§»çš„è¯å¯ä»¥ä¼šå½±å“å…¶ä»–çš„ä¸šåŠ¡ç”šè‡³åœ¨è¿ç§»çš„æ—¶å€™ä¼šå‘ç”Ÿå¾ˆå¤šé—®é¢˜ï¼Œæ‰€æœ‰åœ¨ä½ å½“å‰è¿™ä¸ªç‰ˆæœ¬èƒ½å¤Ÿæ»¡è¶³ä½ å¤§éƒ¨åˆ†åŠŸèƒ½çš„å‰æä¸‹ä½ åšä¸åšå‡çº§å…¶å®ä¸æ˜¯å¾ˆé‡è¦ï¼Œæ¯”å¦‚è¯´å¯èƒ½æ–°çš„ç‰ˆæœ¬çš„ç‰¹æ€§èƒ½è§£å†³ä¸€ä¸ªç—›ç‚¹æˆ–è€…èƒ½æå¤§æå‡æ•ˆç‡è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘åšå‡çº§ï¼Œå½“ç„¶æ–°çš„ç‰ˆæœ¬è‚¯å®šæ˜¯æœ€å¥½çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¸»è¦è¿˜æ˜¯ä»‹ç»ç”¨çš„æ¯”è¾ƒå¤šçš„ä¸»æµç‰ˆæœ¬ï¼šRedis3</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106194241995-1573041430182.png" srcset="/img/loading.gif" alt="image-20191106194241995"></p><p>å¯¹äºused_memoryæ¥è¯´å®ƒåˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼Œè‡ªèº«ä¸€ä¸ªå†…å­˜ï¼šä½ å¯åŠ¨ä»¥ä¸€ä¸ªRediså®ƒè‚¯å®šä¼šæœ‰ä¸€äº›è‡ªèº«çš„å†…å­˜çš„å¼€é”€ï¼Œå› ä¸ºå®ƒæœ¬æ¥æœ‰ä¸€äº›å…±äº«å˜é‡è¿™æ ·çš„ä¸€äº›ä¸œè¥¿ï¼Œå½“ç„¶è¿™äº›å ç”¨å†…å­˜éå¸¸ä½ï¼Œä¸€èˆ¬ä¹Ÿå°±å‡ ç™¾KBæ ¹æ®ä¸åŒç‰ˆæœ¬å¯èƒ½ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œçš„éƒ¨åˆ†å†…å­˜åŸºæœ¬ä¸ç”¨ä½ å»æ‹…å¿ƒï¼›</p><p>è¿™é‡Œçš„é‡å¤´æˆå°±æ˜¯2ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><p>å¯¹è±¡å†…å­˜ï¼š æˆ‘ä»¬å­˜çš„key-valueæ¯”å¦‚hashã€seté‚£äº›ä¸œè¥¿ï¼›</p></li><li><p>ç¼“å†²å†…å­˜ï¼šç¼“å­˜å†…å­˜ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼ŒåŒ…æ‹¬å¯¹å¤–ç¼“å†²åŒºã€å¤åˆ¶ç¼“å†²åŒºã€å®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œå½“ç„¶è¿™äº›ä¸œè¥¿å¦‚æœä½ ä½¿ç”¨ä¸æ˜¯å¾ˆå¥½çš„è¯ä¹Ÿå¯èƒ½ä¼šå‡ºç°ä¸€äº›å¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼›</p></li><li><p>Luaå†…å­˜ï¼šå½“ä½ ä½¿ç”¨luaçš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šæœ‰ä¸€ä¸ªluaçš„å†…å­˜ï¼›</p></li><li><p>å†…å­˜ç¢ç‰‡ï¼šç³»ç»Ÿåˆ†é…ç»™ä½ çš„å†…å­˜å’Œä½ ç”¨çš„å†…å­˜çš„ä¸€ä¸ªå·®å€¼ï¼Œè¿™ä¸ªå·®å€¼å°±æ˜¯ä¸€ä¸ªç¢ç‰‡ï¼Œå‡å¦‚æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ª <code>set hello word</code>ï¼Œæ¯”å¦‚è¯´helloå’Œwordå°±æ˜¯5ä¸ªå­—èŠ‚ï¼Œé‚£å°±åˆ†é…ç»™ä½ 5ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å½“ä½ åœ¨<code>set hello</code>æ˜¯ä¸€ä¸ªé•¿çš„æƒ…å†µä¸‹å®ƒå°±ä¸ºäº†ä¿è¯Redis SDSçš„æ•°æ®ç»“æ„ï¼Œå®ƒè®¤ä¸ºä½ å¯èƒ½è¿˜ä¼šç”¨åˆ°æ›´å¤šå†…å­˜çš„æƒ…å†µä¸‹ï¼Œå®ƒä¼šç»™ä½ é¢„ç•™ä¸€éƒ¨åˆ†ï¼Œå½“ä½ å†<code>set hello word</code>å›æ¥ä¹‹åå®ƒå¹¶ä¸ä¼šæŠŠå†…å­˜åšä¸€ä¸ªå›æ”¶ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šäº§ç”Ÿç¢ç‰‡çš„æƒ…å†µï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹ä¸‹Redisæºç ä¸­SDSçš„éƒ¨åˆ†ï¼Œè¿™é‡Œåªéœ€è¦çŸ¥é“æˆ‘ä»¬ç”¨äº†å¾ˆå¤šå†…å­˜ï¼Œè¿™ä¸ªéƒ¨åˆ†æ˜¯ç”¨çš„ï¼Œä½†æ˜¯ä½ ç”³è¯·çš„å¯èƒ½ä¼šæ¯”ç”¨çš„å¤šä¸€äº›è¿™ä¸ªæ—¶å€™å°±ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡</p></li></ul><hr><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106200207592-1573041728497.png" srcset="/img/loading.gif" alt="image-20191106200207592"></p><p>è¿™é‡Œæ¥çœ‹ä¸€ä¸ªæ›´åŠ è¯¦ç»†çš„å†…å­˜æ¶ˆè€—ï¼Œç¬¬ä¸€éƒ¨åˆ†è‡ªèº«å†…å­˜ï¼Œå‰é¢æåˆ°è¿‡äº†ï¼Œä¹Ÿå°±å‡ ç™¾Kæˆ–è€…æ›´å¤šä¸€ç‚¹æ ¹æ®ä¸åŒç‰ˆæœ¬ï¼Œè¿™é‡Œç›¸å¯¹æ¥è¯´æ˜¯å›ºå®šçš„ï¼Œè¿™é‡Œæ¯”è¾ƒä¸»è¦çš„å°±æ˜¯ç¼“å†²å†…å­˜å®ƒæ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œå®ƒåŒ…æ‹¬3ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>å®¢æˆ·ç«¯ç¼“å†²åŒºï¼šRediså®¢æˆ·ç«¯æ‰§è¡Œgetã€setä¸€äº›å‘½ä»¤çš„æ—¶å€™ç”šè‡³åƒmemoryè¿™æ ·çš„å‘½ä»¤çš„æ—¶å€™å®ƒéƒ½ä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºï¼ŒRedisæ— è®ºæ˜¯å®¢æˆ·ç«¯å‘é€å‘½ä»¤è¿˜æ˜¯è¿”å›ç»“æœå®ƒéƒ½ä¼šæœ‰ä¸€ä¸ªç¼“å†²åŒºæ¥ç¼“å†²è¿™éƒ¨åˆ†å†…å­˜ï¼›</li><li>å¤åˆ¶ç¼“å†²åŒºï¼šå‰é¢ä»‹ç»çš„å¤åˆ¶ï¼Œä¼šæœ‰å¤åˆ¶ç¼“å†²åŒºï¼Œä¸ºäº†é˜²æ­¢å…¨é‡å¤åˆ¶è¿™æ ·çš„é—®é¢˜ï¼›</li><li>AOFç¼“å†²åŒºï¼šå®ƒæœ‰2ä¸ªéƒ¨åˆ†ï¼ŒAOFå†™å…¥çš„ç¼“å†²åŒºã€AOFé‡å†™æœŸé—´çš„ç¼“å†²åŒºï¼Œåé¢ä¼šå¯¹å®ƒè¿›è¡Œè¯¦ç»†è¯´æ˜ã€‚</li></ul><p>è¿™é‡Œé‡å¤´æˆå°±æ˜¯å¯¹è±¡å†…å­˜ï¼Œå°±æ˜¯ä½ å­˜çš„é‚£äº›keyå’Œvalueï¼Œå½“ç„¶ä¸ä»…ä»…valueå¾ˆé‡è¦ï¼Œä½ çš„keyä¹Ÿå¾ˆé‡è¦ï¼Œå‡å¦‚è¯´ä½ çš„keyéå¸¸å¤§æˆ–è€…å¾ˆé•¿è¿™å¯¹æ•´ä½“å†…å­˜ä½¿ç”¨é‡ä¹Ÿä¼šæœ‰ä¸€å®šå½±å“ï¼Œè¿™å’Œå…·ä½“çš„è§„æ¨¡æœ‰å…³ç³»</p><hr><p>ç°åœ¨è¿›å…¥Redisæ¥æ‰§è¡Œä¸€ä¸ªinfoå‘½ä»¤</p><pre><code class="hljs bash">127.0.0.1:6379&gt; info <span class="hljs-comment"># Server</span>redis_version:3.0.7redis_git_sha1:00000000redis_git_dirty:0redis_build_id:fee2042acc931bb1redis_mode:standaloneos:Linux 3.10.0-1062.1.2.el7.x86_64 x86_64arch_bits:64multiplexing_api:epollgcc_version:4.8.5process_id:2061run_id:82774a23e6d19c005a1c79a396e953e309efc3f1tcp_port:6379uptime_in_seconds:25uptime_in_days:0hz:10lru_clock:12790371config_file:/usr/src/redis/config/redis-6379.conf<span class="hljs-comment"># Clients å®¢æˆ·ç«¯</span>connected_clients:1client_longest_output_list:0client_biggest_input_buf:0<span class="hljs-comment">#å®¢æˆ·ç«¯ç¼“å†²åŒº</span>blocked_clients:0<span class="hljs-comment"># Memoryå†…å­˜ç›¸å…³</span>used_memory:816544used_memory_human:797.41Kused_memory_rss:7647232used_memory_peak:816544used_memory_peak_human:797.41Kused_memory_lua:36864mem_fragmentation_ratio:9.37mem_allocator:jemalloc-3.6.0<span class="hljs-comment">#...</span></code></pre><p>è¿™é‡Œä¼šå‘ç°å®ƒæœ‰å¾ˆå¤šé€‰é¡¹ï¼Œå‡å¦‚ä½ æƒ³çœ‹å†…å­˜çš„ä½¿ç”¨é‡ä½ å¯ä»¥æ‰§è¡Œ<code>info memory</code>ï¼Œç”¨å‰é¢ä»‹ç»çš„å‡ ç‚¹è¿›è¡Œåˆ†æ</p><pre><code class="hljs bash">127.0.0.1:6379&gt; info memory<span class="hljs-comment"># Memory</span>used_memory:815704<span class="hljs-comment">#Rediså†…å­˜ä½¿ç”¨é‡</span>used_memory_human:796.59Kused_memory_rss:7647232<span class="hljs-comment">#æ“ä½œç³»ç»Ÿä½¿ç”¨é‡ï¼Œå®ƒç”³è¯·çš„å†…å­˜</span>used_memory_peak:816544used_memory_peak_human:797.41Kused_memory_lua:36864mem_fragmentation_ratio:9.38<span class="hljs-comment">#æ¯”å€¼ç¢ç‰‡ç‡</span>mem_allocator:jemalloc-3.6.0</code></pre><h1 id="å®¢æˆ·ç«¯ç¼“å†²åŒº"><a href="#å®¢æˆ·ç«¯ç¼“å†²åŒº" class="headerlink" title="å®¢æˆ·ç«¯ç¼“å†²åŒº"></a>å®¢æˆ·ç«¯ç¼“å†²åŒº</h1><h2 id="å®¢æˆ·ç«¯ç¼“å†²åŒºåˆ†ä¸º3ç±»"><a href="#å®¢æˆ·ç«¯ç¼“å†²åŒºåˆ†ä¸º3ç±»" class="headerlink" title="å®¢æˆ·ç«¯ç¼“å†²åŒºåˆ†ä¸º3ç±»"></a>å®¢æˆ·ç«¯ç¼“å†²åŒºåˆ†ä¸º3ç±»</h2><p>æ™®é€šå®¢æˆ·ç«¯ï¼šä½ å¯ä»¥è®¤ä¸ºå®ƒå°±æ˜¯æ­£å¸¸çš„æˆ‘ä»¬æ‰§è¡Œå‘½ä»¤æ¯”å¦‚getã€setä¸€äº›æ­£å¸¸çš„å‘½ä»¤ï¼Œä½ æ— è®ºä½¿ç”¨ä»€ä¹ˆå®¢æˆ·ç«¯å»è¿æ¥éƒ½æ˜¯æ™®é€šå®¢æˆ·ç«¯ç¼“å†²ï¼›</p><p>slaveå®¢æˆ·ç«¯ï¼šæˆ‘ä»¬ç°åœ¨æœ‰ä¸€å¯¹ä¸»ä»ï¼Œä¸»å’Œä»ä¹‹é—´è¦åŒæ­¥æ•°æ®ï¼Œè¿™é‡Œçš„å®¢æˆ·ç«¯æ˜¯ä¸€ä¸ªä»ï¼Œå®ƒæœ‰ä¸€ä¸ªä¼ªè£…çš„å®¢æˆ·ç«¯å»æ¥å—è¿™ä¸ªmasteråŒæ­¥è¿‡æ¥å‘½ä»¤ï¼›</p><p>pubsubå®¢æˆ·ç«¯ï¼špubsubå‘å¸ƒè®¢é˜…æ¨¡å¼æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„ç¼“å†²åŒº</p><h2 id="è¾“å…¥ç¼“å†²åŒº"><a href="#è¾“å…¥ç¼“å†²åŒº" class="headerlink" title="è¾“å…¥ç¼“å†²åŒº"></a>è¾“å…¥ç¼“å†²åŒº</h2><p>åœ¨ä»‹ç»ä¸Šé¢3ç§ç¼“å†²åŒºä¹‹å‰ï¼Œæ¥çœ‹ä¸€ä¸‹è¾“å…¥ç¼“å†²åŒºã€‚</p><p>åˆšæ‰è¯´çš„é‚£3ç§éƒ½æ˜¯è¾“å‡ºç¼“å†²åŒºï¼Œé‚£ä¹ˆè¾“å…¥ç¼“å†²åŒºæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå°±æ˜¯æˆ‘ç°åœ¨æœ‰å¾ˆå¤šå®¢æˆ·ç«¯å»å‘é€ç»™Rediså‘½ä»¤ï¼Œæ— è®ºæ˜¯getã€setè¿™äº›ä¸œè¥¿ï¼Œä»å›¾ä¸­çœ‹åˆ°æœ‰3ä¸ªå®¢æˆ·ç«¯åˆ†åˆ«æ‰§è¡Œäº†å¾ˆå¤šå‘½ä»¤ï¼Œè¿™äº›å‘½ä»¤å‘é€ç»™Redisä¹‹å‰å®ƒä¼šæ”¾åˆ°å„è‡ªå®¢æˆ·ç«¯çš„ç¼“å†²åŒºå½“ä¸­ï¼Œå¯ä»¥ç®€å•çš„è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªå¯¹åˆ—çš„ä¸œè¥¿å»å‘é€åˆ°Redisä¸­ç¬é—´å»æ‰§è¡Œï¼Œè¿™ä¸ªæ˜¯éå¸¸å¿«çš„ï¼Œä½ æ”¾åˆ°ç¼“å†²åŒºä¸­å¯èƒ½å°±ä¼šç«‹åˆ»è¢«Redisæ‰§è¡Œï¼Œä½†æœ‰ä¸€ä¸ªé—®é¢˜å¦‚æœRediséå¸¸å¿™ï¼Œè¿™ä¸ªæ—¶å€™ä½ å‘é€çš„å­—èŠ‚æ•°éå¸¸éå¸¸å¤§ï¼Œæ¯”å¦‚setä¸€ä¸ªhelloå®ƒçš„valueæœ‰å‡ ç™¾å…†ï¼Œæˆ‘ä»¬çŸ¥é“Redisé¢„æœŸæ˜¯512å…†ï¼Œä½ è®¾ç½®éå¸¸å¤§å¯èƒ½å®ƒçš„ç¼“å†²åŒºå°±ä¼šè¢«æš‚æ—¶é˜»å¡æ‰ï¼Œæ‰€ä»¥å¤§éƒ¨åˆ†æƒ…å†µä¸‹ä½ çœ‹åˆ°çš„è¾“å…¥ç¼“å†²åŒºå¯èƒ½éƒ½æ˜¯0ï¼Œä½†æ˜¯å¯èƒ½ä½ è®¾ç½®éå¸¸å¤§çš„å€¼çš„æ—¶å€™å¯èƒ½ä¼šè¢«å¡ä¸»æˆ–è€…Rediså¿™çš„æ—¶å€™å¯èƒ½å‘ç”Ÿå˜åŠ¨ï¼Œä½†ä¸€èˆ¬è¯´è¿˜å¥½ï¼Œå…¶å®Rediså…è®¸çš„ä¸€ä¸ªæœ€å¤§çš„å®¢æˆ·ç«¯ç¼“å†²åŒºæ˜¯1Gï¼Œå¦‚æœä½ è¶…è¿‡1Gçš„æƒ…å†µä¸‹ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿä½ çš„å®¢æˆ·ç«¯ä¼šç›´æ¥è¢«æœåŠ¡ç«¯å¹²æ‰ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´è¿™ä¸ªè¿æ¥å°±å·²ç»æ–­äº†ï¼Œæ‰€ä»¥è¿™ä¸ªä¹Ÿæ˜¯ä¸€ä¸ªé—®é¢˜ï¼Œé€šå¸¸æ¥è¯´è¾“å…¥ç¼“å†²åŒºä¹Ÿæ²¡æœ‰å¤ªå¤šé—®é¢˜ï¼Œå½“ç„¶ä½ å‡ºç°ç±»ä¼¼è¿™ç§é—®é¢˜çš„æ—¶å€™ä½ å¯ä»¥ç”¨åˆšæ‰æˆ‘ä»¬infoå‘½ä»¤ä¸­çš„ç»Ÿè®¡å¯ä»¥çœ‹åˆ°è¿™äº›ä¿¡æ¯ï¼Œç¨åä¼šç»™è¯»è€…ä»¬å»çœ‹ä¸€ä¸‹ã€‚</p><hr><p>æˆ‘ä»¬é‡ç‚¹å»çœ‹è¾“å‡ºç¼“å†²åŒºï¼Œè¾“å‡ºç¼“å†²åŒºä¸»è¦æ˜¯é’ˆå¯¹å‘½ä»¤è¿”å›ï¼Œåˆšæ‰æ˜¯æŠŠå‘½ä»¤å‘é€äº†ï¼Œç°åœ¨æ˜¯æŠŠå‘½ä»¤è¿”å›ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“æœ‰3ç±»ï¼šæ™®é€šå®¢æˆ·ç«¯ã€ä»èŠ‚ç‚¹çš„slaveå®¢æˆ·ç«¯ã€pubsubå®¢æˆ·ç«¯ï¼Œå®ƒé’ˆå¯¹è¿™3ç§ç±»å‹å¯ä»¥çµæ´»çš„é…ç½®ï¼Œå®ƒå’Œä¸Šä¸€ç±»è¾“å…¥ç¼“å†²åŒºä¸ä¸€æ ·ä¸€ç‚¹å°±æ˜¯å®ƒå¯ä»¥è¿›è¡Œé…ç½®ï¼Œä¸Šä¸€ä¸ªå¿…é¡»è¦æ±‚ä½ ä¸èƒ½è¶…è¿‡ä¸ª1Gï¼Œè¿™é‡Œå°±å¯ä»¥è¿›è¡Œé…ç½®</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106205416410.png" srcset="/img/loading.gif" alt="image-20191106205416410"></p><p>è¿™é‡Œçš„<code>hard limit</code>å¯ä»¥è®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºæ— è®ºå¤šå¤§éƒ½ä¸ä¼šå…³é—­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å®¢æˆ·ç«¯ä¸ä¼šè¢«å…³é—­ï¼Œä½†æ˜¯å¯èƒ½ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼šå®ƒä¼šå é¢å¤–å†…å­˜ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“used_memoryé‡Œé¢å®ƒæ˜¯æœ‰ä¸€é¡¹å®¢æˆ·ç«¯ç¼“å†²åŒºçš„ï¼Œ<code>soft limit</code>å’Œ<code>soft seconds</code>æ˜¯ä¸€ä¸ªç»„åˆé€‰é¡¹ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå®ƒä¼šå‘ç°ä½ çš„å®¢æˆ·ç«¯åœ¨è¿™ä¸ª<code>soft limit</code>å€¼ä¸­ï¼Œæ¯”å¦‚æˆ‘ä»¬è®¾ç½®äº†64Mï¼Œæˆ‘ä»¬è¶…è¿‡64Mè¾¾åˆ°äº†60ç§’ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯èƒ½å°±ä¼šå°†å®¢æˆ·ç«¯è¿›è¡Œå…³é—­ï¼Œå®ƒæ˜¯å’Œ<code>hard limit</code>ç›¸å¯¹åº”çš„ä¸œè¥¿ï¼Œ2æ–¹é¢è¿›è¡Œé™åˆ¶ï¼Œä¸€ä¸ªæ˜¯è½¯é™åˆ¶å¦ä¸€ä¸ªæ˜¯ç¡¬é™åˆ¶ã€‚</p><h2 id="æ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒº"><a href="#æ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒº" class="headerlink" title="æ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒº"></a>æ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒº</h2><p>è¿™é‡Œæ˜¯æ ¹æ®è¾“å‡ºç¼“å†²åŒºè¿›è¡Œçš„è®¾ç½®ï¼š</p><ol><li><p>é»˜è®¤ï¼š<code>client-output-buffer-limit normal 0 0 0</code></p></li><li><p>ä¸Šé¢çš„é…ç½®æ„æ€æ˜¯é»˜è®¤æ²¡æœ‰å¯¹å®¢æˆ·ç«¯è¾“å‡ºç¼“å†²åŒºè¿›è¡Œé™åˆ¶</p></li><li><p>è¿™é‡Œæœ‰2ä¸ªé—®é¢˜å…¶å®å‰é¢å·²ç»æåˆ°äº†ï¼Œè¿™æ ·è®¾ç½®çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿå…¶å®å°±æ˜¯Redisä¸ºäº†ä¿è¯å®¢æˆ·ç«¯è¿æ¥ä¸ä¼šè¢«å¹²æ‰ï¼Œä½†æ˜¯è¿™æ ·åšæœ‰ä¸€ä¸ªåå¤„ï¼šå½“æ‰§è¡Œéå¸¸å¤§çš„å‘½ä»¤ï¼Œæ¯”å¦‚ä¸€æ¬¡<code>hgetall</code>ï¼Œç„¶ååœ¨ä¸€ä¸ªå‡ ç™¾ä¸‡çš„å“ˆå¸Œè¿™æ ·çš„key-valueå»æ‰§è¡Œè¿™æ ·çš„å‘½ä»¤æˆ–è€…æ‰§è¡Œå¾ˆé¢‘ç¹çš„æ—¶å€™æˆ‘ä»¬å¿…ç„¶ä¼šå‘ç°æˆ‘ä»¬æ™®é€šå®¢æˆ·ç«¯çš„è¾“å…¥ç¼“å†²åŒºä¼šè¢«é˜»å¡ï¼Œå› ä¸ºå®ƒçš„æ¯æ¬¡è¿”å›ç»“æœéå¸¸å¤§ï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µåƒmonitorè¿™æ ·çš„å‘½ä»¤ï¼Œæ‰€æœ‰å®¢æˆ·ç«¯æ‰§è¡Œçš„å‘½ä»¤åœ¨monitorç«¯éƒ½å¯ä»¥ç›‘æ§åˆ°ï¼Œå®ƒæ˜¯æœ‰ä¸€ä¸ªéå¸¸å¥½çš„åœ°æ–¹å®ƒå¯ä»¥ç›‘æ§Rediså½“å‰åˆ°åº•æ‰§è¡Œäº†ä»€ä¹ˆå‘½ä»¤ç„¶åæ˜¯å“ªäº›å®¢æˆ·ç«¯æ‰§è¡Œçš„ï¼Ÿå®ƒçš„åå¤„ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œå½“ä½ çš„Rediså®¢æˆ·ç«¯éå¸¸å¤šè€Œä¸”æ¯ä¸ªå®¢æˆ·ç«¯å®ƒæ‰§è¡Œçš„å¹¶å‘é‡éå¸¸å¤§ï¼Œå°±æ˜¯è¯´æ‰€æœ‰çš„å‘½ä»¤éƒ½ä¼šæ‰“åˆ°monitorå®¢æˆ·ç«¯ä¸Šï¼Œç„¶åå°±ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼šmonitorçš„è¾“å…¥ç¼“å†²åŒºä¼šå¾ˆå¤§ï¼Œå› ä¸ºå®ƒæ— æ³•åŠæ—¶æ¶ˆè´¹æ‰€æœ‰çš„å‘½ä»¤çš„ç»“æ„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106210724039.png" srcset="/img/loading.gif" alt="image-20191106210724039"><br>ï¼Œå®ƒæ˜¯ä¸€ä¸ªéå¸¸æœ‰å¸®åŠ©çš„å‘½ä»¤ï¼Œä½†æ˜¯å¦‚æœä½ ä½¿ç”¨ä¸å½“ï¼Œæ¯”å¦‚ä½ ä¸æ˜¯åœ¨å½“å‰Redisä¸Šä½¿ç”¨çš„è€Œæ˜¯åœ¨å…¶ä»–æœºå™¨è¿œç¨‹è¿æ¥ï¼Œè¿™æ ·ä¼šé™ä½æ¶ˆè´¹é€Ÿåº¦ï¼Œåœ¨ä½¿ç”¨è¿™æ ·çš„å‘½ä»¤ä¼šæ¯”è¾ƒå±é™©ï¼Œå®ƒä¼šè®©ä½ è¾“å…¥ç¼“å†²åŒºç¬é—´å¯èƒ½å‡ºç°æš´å¢çš„æƒ…å†µï¼Œæˆ‘ä»¬åé¢ä¼šåšä¸€ä¸ªä¾‹å­æ¥æ¨¡æ‹Ÿè¿™æ ·çš„é—®é¢˜ï¼Œè¿™é‡Œè¿˜å…³äºmonitorè®¾ç½®çš„é—®é¢˜ï¼Œåé¢ä¹Ÿä¼šè¿›è¡Œè¯´æ˜</p></li></ol><h2 id="slaveå®¢æˆ·ç«¯ç¼“å†²åŒº"><a href="#slaveå®¢æˆ·ç«¯ç¼“å†²åŒº" class="headerlink" title="slaveå®¢æˆ·ç«¯ç¼“å†²åŒº"></a>slaveå®¢æˆ·ç«¯ç¼“å†²åŒº</h2><p>slaveç¼“å†²åŒºå°±æ˜¯åŒæ­¥ä¸»èŠ‚ç‚¹çš„å†™å‘½ä»¤æ¥å®ç°ä¸€ä¸ªä¸»ä»åŒæ­¥</p><ol><li>é»˜è®¤ï¼š<code>client-output-buffer-limit slave 256mb 64mb 60</code>ï¼Œ</li><li>è¿™é‡Œå»ºè®®è¿™éƒ¨åˆ†å€¼è°ƒå¤§ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºä»€ä¹ˆï¼Ÿæ¯”å¦‚è¯´ä¸»ä»å»¶è¿Ÿæ¯”è¾ƒé«˜æˆ–è€…ä»èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå‡ºç°å®¢æˆ·ç«¯ç¼“å†²åŒºä¼šè¢«è†¨èƒ€ï¼Œè¶…è¿‡ä½ è¿™ä¸ªlimité™åˆ¶ï¼Œåœ¨å‡ºç°è¿™ç§æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°å…¨é‡å¤åˆ¶çš„æƒ…å†µï¼Œä½†æ˜¯ä½ çš„ä¸»èŠ‚ç‚¹åˆ†ç‰‡æ¯”è¾ƒå¤§ï¼Œè¿™ä¸ªæ—¶å€™ä¹Ÿä¼šå‡ºç°ä½ çš„å®¢æˆ·ç«¯ç¼“å†²åŒºè¢«æ‰“æ»¡ï¼Œå½“ç„¶è¿™å’Œå†™å…¥é‡ä¹Ÿæœ‰å…³ç³»ï¼Œä¹Ÿä¼šé€ æˆå®¢æˆ·ç«¯ç¼“å†²åŒºè¢«æ‰“æ»¡çš„æƒ…å†µ</li><li>å»ºè®®ä»èŠ‚ç‚¹ä¸è¦è¿‡å¤šï¼Œä½ çš„åˆ†ç‰‡ä¸è¦è¿‡å¤§ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦æŠŠè¿™äº›å€¼è°ƒå¤§ä¸€äº›å‘¢ï¼Ÿè¿™éƒ¨åˆ†å®¢æˆ·ç«¯æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œå®ƒå°±åªæœ‰1ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒè°ƒå¤§ä¸€äº›ï¼Œæ¥ç‰ºç‰²ä¸€ç‚¹å†…å­˜è€Œé˜²æ­¢å®¢æˆ·ç«¯ç›´æ¥è¢«å¹²æ‰slaveå®¢æˆ·ç«¯äº§ç”Ÿæ–°çš„å…¨é‡å¤åˆ¶çš„é—®é¢˜ï¼Œæ‰€ä»¥ä¸€å®šè¦æ³¨æ„è¦é€‚å½“è°ƒå¤§ä¸€äº›ï¼Œæ¯”å¦‚512mbï¼Œè¿™æ ·çš„è¯èƒ½é˜²æ­¢slaveå®¢æˆ·ç«¯ç¼“å†²åŒºè¢«å¹²æ‰çš„æƒ…å†µã€‚</li></ol><h2 id="pubsubå®¢æˆ·ç«¯ç¼“å†²åŒº"><a href="#pubsubå®¢æˆ·ç«¯ç¼“å†²åŒº" class="headerlink" title="pubsubå®¢æˆ·ç«¯ç¼“å†²åŒº"></a>pubsubå®¢æˆ·ç«¯ç¼“å†²åŒº</h2><p>pubsubå®¢æˆ·ç«¯ç¼“å†²åŒºæ˜¯é’ˆå¯¹å‘å¸ƒè®¢é˜…å‘½ä»¤æ¥å•ç‹¬è®¾ç½®çš„å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒº</p><ol><li>é»˜è®¤ï¼š<code>client-output-buffer-limit pubsub 32mb 8mb 60</code>ï¼Œpubsubä¸æ˜¯ä¸€ä¸ªå¾ˆä¸»æµçš„æ–¹æ³•ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯å¹¶ä¸æ˜¯å¾ˆå¤šï¼Œå› ä¸ºå®ƒä¸æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å‘å¸ƒè®¢é˜…ã€æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼Œå¦‚æœä½ è¦ä½¿ç”¨çš„è¯æ¥æ ¹æ®è‡ªå·±çš„ä½¿ç”¨é‡æ¥è¿›è¡Œä¸€ä¸ªåˆç†çš„è°ƒæ•´ï¼Œå¦‚æœä½ å‘ç°ä½ çš„pubsubç¼“å†²åŒºå‡ºç°äº†æ¯”è¾ƒå¤§çš„æƒ…å†µï¼Œæ¯”å¦‚ä½ å‘ç°ä½ ä»£ç ä¸­ä½ çš„å®¢æˆ·ç«¯è¢«æ–­å¼€äº†ï¼Œæ˜¯å› ä¸ºpubsubç¼“å†²åŒºè¿‡å¤§é€ æˆçš„ï¼›</li><li>å®ƒçš„é˜»å¡åŸå› ï¼šç”Ÿäº§é€Ÿåº¦å¤§äºæ¶ˆè´¹é€Ÿåº¦ï¼Œå®ƒçš„ä¸€ä¸ªæŸ¥è¯¢æ–¹æ³•ä¹Ÿæ˜¯éœ€è¦åœ¨infoè¿›è¡ŒæŸ¥è¯¢æˆ–è€…ä½¿ç”¨client listè¿™æ ·çš„å‘½ä»¤è¿›è¡ŒæŸ¥è¯¢ï¼Œç¨åä¼šç»“åˆä¹‹å‰ä»‹ç»çš„å†…å­˜è¿›è¡Œç»Ÿä¸€çš„æ¼”ç¤ºï¼›</li><li>æ³¨æ„ï¼šæ ¹æ®è‡ªå·±çš„ä½¿ç”¨åœºæ™¯æ¥è¿›è¡Œè°ƒè¯•ï¼Œä½ çš„å¹¶å‘é‡ã€ä½ çš„ç”Ÿäº§å’Œæ¶ˆè´¹é€Ÿåº¦æ¯” ç±»ä¼¼è¿™æ ·çš„ä¸œè¥¿è¿›è¡Œè°ƒè¯•</li></ol><h2 id="å®¢æˆ·ç«¯ç¼“å†²åŒºæ¼”ç¤º"><a href="#å®¢æˆ·ç«¯ç¼“å†²åŒºæ¼”ç¤º" class="headerlink" title="å®¢æˆ·ç«¯ç¼“å†²åŒºæ¼”ç¤º"></a>å®¢æˆ·ç«¯ç¼“å†²åŒºæ¼”ç¤º</h2><pre><code class="hljs bash">127.0.0.1:6379&gt; info clients <span class="hljs-comment"># Clients</span><span class="hljs-comment">#å®¢æˆ·ç«¯è¿æ¥æ•°</span>connected_clients:1<span class="hljs-comment">#ä½ æ‰€ä»¥çš„ç¼“å†²åŒºæ˜¯ä¸€ä¸ªlistï¼Œå®ƒç”±2éƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªæ˜¯bufferåŠ ä¸Šlistï¼Œè¿™ä¸ªbufferæ¯”è¾ƒå°ä¹Ÿå°±æ˜¯å‰©ä¸‹çš„ç¼“å†²åŒºå¯¹è±¡æ˜¯é€šè¿‡è¿™æ ·ä¸€ä¸ªlistè¿›è¡Œå­˜å‚¨çš„ï¼Œè¿™é¡¹ç»Ÿè®¡ä¸­ç»Ÿè®¡çš„æ˜¯æ‰€æœ‰å®¢æˆ·ç«¯ä¸­è¿™ä¸ªlistæœ€å¤§çš„ï¼Œå½“å‰æ˜¯0ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç¯å¢ƒï¼Œä½†æ˜¯å¦‚æœä½ å‘ç°è¿™ä¸ªæ˜¯éå¸¸å¤§çš„ï¼Œæ¯”å¦‚å®ƒè¶…è¿‡äº†1K,é‚£è¿™ä¸ªæ—¶å€™å¯èƒ½å°±ä¼šæœ‰äº›ç¼“å†²åŒºé˜»å¡ï¼Œè¿™ä¸ªæ—¶å€™å®ƒè¦æœ‰å¤šå¤§ä½ ä¹Ÿçœ‹ä¸åˆ°ï¼Œåé¢ä¼šä»‹ç»å‘½ä»¤è¿›è¡ŒæŸ¥è¯¢</span>client_longest_output_list:0<span class="hljs-comment">#å®¢æˆ·ç«¯è¾“å…¥ç¼“å†²åŒºæœ€å¤§çš„bufferï¼Œä¸Šé¢çš„æ˜¯ä¸ªæ•°ï¼Œè¿™ä¸ªæ˜¯å­—èŠ‚</span>client_biggest_input_buf:0blocked_clients:0</code></pre><p>é‚£æˆ‘ä»¬æƒ³äº†è§£æ‰€æœ‰å®¢æˆ·ç«¯çš„ä¸€ä¸ªå‘¢ï¼Ÿ</p><pre><code class="hljs bash">127.0.0.1:6379&gt; client listid=2 addr=127.0.0.1:54212 fd=6 name= age=5937 idle=0 flags=N db=0 sub=0 psub=0 multi=-1 qbuf=0 qbuf-free=32768 obl=0 oll=0 omem=0 events=r cmd=client</code></pre><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰å®¢æˆ·ç«¯çš„åŸºæœ¬ä¿¡æ¯ï¼Œageæ˜¯è¯´è¿™ä¸ªè¿æ¥è¿æ¥äº†å¤šä¹…ï¼Ÿidleæ˜¯é—²ç½®æ—¶é—´ç­‰ç­‰ä¸€äº›ä¸œè¥¿ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„å’Œè¾“å‡ºç¼“å†²åŒºç›¸å…³çš„ï¼š</p><ul><li><p>qbufï¼šç¼“å†²åŒºæœ‰å¤šå¤§</p></li><li><p>qbuf-freeï¼šç¼“å†²åŒºæœ‰å¤šå°‘ç©ºä½™çš„</p></li><li><p>oblã€ollï¼šç¼“å†²åŒºçš„listæœ‰å¤šå¤§</p></li><li><p>omemï¼šç¼“å†²åŒºæ˜¯ä¸æ˜¯å¾ˆå¤§ï¼Œå°†ä¸Šé¢2ä¸ªè¿›è¡Œè®¡ç®—ç„¶åç®—ä¸€äº›å®ƒçš„å†…å­˜æœ‰å¤šå¤§ï¼Œå¦‚æœå‘ç°è¿™ä¸ªæ¯”è¾ƒå¤§çš„æ—¶å€™å¯èƒ½å°±æ˜¯ä¸€ä¸ªæœ‰é—®é¢˜çš„è¿æ¥ï¼Œè¿™ä¸ªå¯ä»¥æ ¹æ®å®é™…åº”ç”¨åœºæ™¯è¿›è¡ŒæŸ¥è¯¢ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -a abcdef client list | grep -v <span class="hljs-string">"omem=0"</span>1</code></pre><p>omemä¸º0çš„è¿‡æ»¤æ‰è¿›è¡ŒæŸ¥è¯¢ï¼Œå¯èƒ½å°±èƒ½æŸ¥è¯¢åˆ°å‡ºç°æœ‰é—®é¢˜çš„ï¼Œç„¶åè¿›è¡Œé—®é¢˜çš„æŸ¥è¯¢</p></li></ul><h1 id="ç¼“å†²å†…å­˜"><a href="#ç¼“å†²å†…å­˜" class="headerlink" title="ç¼“å†²å†…å­˜"></a>ç¼“å†²å†…å­˜</h1><h2 id="å¤åˆ¶ç¼“å†²åŒº"><a href="#å¤åˆ¶ç¼“å†²åŒº" class="headerlink" title="å¤åˆ¶ç¼“å†²åŒº"></a>å¤åˆ¶ç¼“å†²åŒº</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107202202656.png" srcset="/img/loading.gif" alt="image-20191107202202656"></p><p>åœ¨å­¦ä¹ ä¹‹å‰çš„ç« èŠ‚ï¼Œä¼šè®²åˆ°ä¸€éƒ¨åˆ†å…³äºå¤åˆ¶çš„å†…å®¹ï¼Œå…¶å®å¤åˆ¶ç¼“å†²åŒºå°±æ˜¯<code>repl_back_buffer</code>è¿™ä¸ªé…ç½®ï¼Œè¿™ä¸ªé…ç½®ä¸»è¦æ˜¯ç”¨æ¥è®¾ç½®å¤åˆ¶ç¼“å†²åŒºçš„å¤§å°ï¼Œå®ƒä¸»è¦æ˜¯å°†è¿™ä¸ªç¼“å†²åŒºmasterèŠ‚ç‚¹çš„ä¸€äº›å‘½ä»¤å†™å…¥åˆ°ç¼“å†²åŒºå†…ï¼Œä¸ºäº†é˜²æ­¢slaveèŠ‚ç‚¹å’ŒmasterèŠ‚ç‚¹å‡ºç°ä¸´æ—¶çš„ç½‘ç»œæŠ–åŠ¨è€Œé€ æˆä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ï¼Œä¸»è¦æ˜¯åšè¿™éƒ¨åˆ†å†…å®¹çš„ï¼›è¿™é‡Œä¸ä¼šå¤šè¯´å®ƒçš„è¯¦ç»†é…ç½®å› ä¸ºåœ¨ä¹‹å‰è¯¾ç¨‹ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå†æ¬¡å¼ºè°ƒä¸€ç‚¹ï¼Œå®ƒçš„é»˜è®¤å€¼æ˜¯<code>1MB</code>ï¼Œä¸‹é¢æˆ‘ä»¬åº”è¯¥ç»™å®ƒè®¾ç½®æ¯”è¾ƒå¤§çš„å€¼ï¼Œæ¯”å¦‚è®¾ç½®ä¸º<code>100MB</code>ï¼Œæ³¨æ„ä¸€ä¸‹è¿™éƒ¨åˆ†å†…å­˜å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ï¼Œå°±ç›¸å½“äºä¸€ä¸ªmasterèŠ‚ç‚¹æœ‰bufferè¿™ä¸ªä¸œè¥¿ï¼Œç„¶åæˆ‘ä»¬å¯ä»¥é€‚å½“ç»™å®ƒè°ƒå¤§ç„¶åç‰ºç‰²ä¸€éƒ¨åˆ†å†…å­˜æ¥å‡å°‘ä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ï¼›ä¸Šé¢è¿™å¼ å›¾æ˜¯å…¨é‡å¤åˆ¶çš„æ¼”ç¤ºå›¾ï¼›</p><h2 id="AOFç¼“å†²åŒº"><a href="#AOFç¼“å†²åŒº" class="headerlink" title="AOFç¼“å†²åŒº"></a>AOFç¼“å†²åŒº</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107202434669.png" srcset="/img/loading.gif" alt="image-20191107202434669"></p><p>å¦‚æœä½ å¼€å¯äº†AOF,AOFè¿™ç§æŒä¹…åŒ–æ–¹å¼æ— è®ºä½ æ˜¯ä½¿ç”¨å“ªç§åˆ·ç›˜ç­–ç•¥ï¼Œå®ƒéƒ½æ˜¯å°†å‘½ä»¤å†™åˆ°ä¸€ä¸ªbufferå½“ä¸­ï¼Œç„¶åå†åšä¸€ä¸ªåˆ·ç›˜çš„åŠ¨ä½œï¼Œæ‰€ä»¥è¿™ä¸ªbufferå°±æ˜¯AOFçš„ç¼“å†²åŒºï¼›æˆ‘ä»¬åœ¨åšAOFé‡å†™çš„æ—¶å€™å¦‚æœä½ å¯¹ä¸Šé¢è¿™å¼ å›¾è¿˜æœ‰å°è±¡çš„è¯ï¼Œå®ƒå°±æ˜¯åšé‡å†™çš„å†…å®¹ï¼ŒAOFåœ¨çš„é‡å†™çš„æ—¶å€™è¿™æœŸé—´äº§ç”Ÿçš„<code>aof buffer</code> æ˜¯ä¸æ˜¯è¦åšä¸€ä¸ªå•ç‹¬çš„è®°å½•ï¼Œå¦‚æœè¿›è¡Œä¸€ä¸ªå•ç‹¬çš„è®°å½•çš„è¯å°±ä¼šæœ‰ä¸€ä¸ªé¢å¤–çš„aofé‡å†™çš„bufferï¼Œå®ƒä¹Ÿæ˜¯aofçš„bufferï¼Œè¿™ä¸ªä¹Ÿæ˜¯éœ€è¦æ³¨æ„çš„ï¼Œè¿™ä¸ªå€¼æ˜¯æ²¡æœ‰å›ºå®šçš„é™åˆ¶çš„ï¼Œå®ƒä¹Ÿæ²¡æœ‰å®¹é‡çš„é™åˆ¶ï¼Œåœ¨è¿™ä¸€å—çš„è¯éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´è¿™å—ä¹Ÿä¸ä¼šæœ‰å¤ªå¤§é—®é¢˜ï¼Œåªéœ€è¦çŸ¥é“è¿™ä¸ªå†…å­˜ä¹Ÿä¼šç”±è¿™éƒ¨åˆ†æ¥ç»„æˆå°±å¥½äº†ï¼Œä¸å¿…é¡»è¿‡æ¸¡å»å…³ç³»ï¼Œé™¤éå†™é‡éå¸¸å¤§ï¼Œåˆ·ç›˜åˆ·çš„æœ‰é—®é¢˜è¿™ä¸ªæ—¶å€™å°±ä¼šæ”¾åˆ°bufferé‡Œã€‚</p><h1 id="å†…å­˜æ¶ˆè€—-1"><a href="#å†…å­˜æ¶ˆè€—-1" class="headerlink" title="å†…å­˜æ¶ˆè€—"></a>å†…å­˜æ¶ˆè€—</h1><h2 id="å¯¹è±¡å†…å­˜"><a href="#å¯¹è±¡å†…å­˜" class="headerlink" title="å¯¹è±¡å†…å­˜"></a>å¯¹è±¡å†…å­˜</h2><p>å¯¹è±¡å†…å­˜æ˜¯ç”±2éƒ¨åˆ†ç»„æˆï¼š</p><ol><li>keyï¼šä¸è¦è¿‡é•¿ï¼Œé‡å¤§ä¸å®¹å¿½è§†ï¼ˆredis3ï¼šembstr 39å­—èŠ‚ï¼‰</li><li>valueï¼šziplistã€intsetç­‰ä¼˜åŒ–æ–¹å¼</li></ol><h2 id="å†…å­˜ç¢ç‰‡"><a href="#å†…å­˜ç¢ç‰‡" class="headerlink" title="å†…å­˜ç¢ç‰‡"></a>å†…å­˜ç¢ç‰‡</h2><p>å†…å­˜ç¢ç‰‡æ˜¯å¿…ç„¶äº§ç”Ÿçš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„Redisä½¿ç”¨çš„æ˜¯jemallocï¼Œjemallocå®ƒçš„åˆ†é…ç­–ç•¥æ˜¯æŒ‰å—ï¼Œä¹Ÿä¸èƒ½è¯´æ˜¯æŒ‰ç…§å—æ˜¯æŒ‰ç…§æ®µï¼Œæ¯”å¦‚è¿™ä¹ˆä¸ªæ„æ€ï¼šä»¥4kã€8kã€16kè¿™æ ·ä¸€ä¸ªå†…å­˜åˆ†é…æ¥ä¸ºå•ä½å½“ç„¶è¿˜æœ‰æ›´å¤§çš„ä¸€ä¸ªé€’å¢å†…å­˜å—ï¼Œå…¶å®ä¸€ä¸ªå†…å­˜å—ä¸èƒ½è®¤ä¸ºæ˜¯ä¸€ä¸ªå†…å­˜å•ä½ï¼Œå…¶å®æ˜¯è¿™æ ·çš„ï¼Œå®ƒæ¯”å¦‚ä¼šäº§ç”Ÿä¸€ä¸ªå†…å­˜ç¢ç‰‡å°±æ˜¯è¯´æˆ‘çš„ä¸€ä¸ªå¯¹è±¡å¯èƒ½ä¼šæœ‰ä¸¾ä¸ªä¾‹å­å¯èƒ½åªæœ‰15kï¼Œä½†å®ƒåªæœ‰8kã€12kã€16kï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šåˆ†é…16kï¼Œè¿™ä¸ªæ—¶å€™å°±æ¢äº§ç”Ÿå†…å­˜ç¢ç‰‡ï¼Œå½“ç„¶å‰é¢è¿™ä¸ªå…·ä½“æ˜¯8kã€12kè¿˜æ˜¯16kæˆ‘æ²¡æœ‰ç»†ç ”ç©¶è¿‡ï¼Œè€Œæ˜¯æˆ‘ä¸¾äº†ä¸€ä¸ªä¾‹å­ï¼Œä½ å¤§æ¦‚èƒ½æ‡‚è¿™ä¸ªæ„æ€å°±å¥½äº†ï¼Œæ¯”å¦‚è¯´å®ƒæ˜¯8kå’Œ16kã€12kä¸¤ç§ï¼Œé‚£ç°åœ¨æ¥ä¸ª 15kå®ƒå¿…ç„¶æ˜¯æœ‰ä¸€ä¸ªå†…å­˜ç¢ç‰‡çš„ï¼Œè¿™ä¸ªéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼Œå…¶å®å†…å­˜ç¢ç‰‡ä¸»è¦æ˜¯å› ä¸ºé¢‘ç¹çš„æ¯”å¦‚è¯´åšappendã€setrangeã€è¿‡æœŸè¿™ç§æƒ…å†µäº§ç”Ÿçš„æ¯”è¾ƒå¤šï¼Œå…¶å®å†…å­˜ç¢ç‰‡æ²¡æœ‰å¤ªå¥½çš„è§£å†³åŠæ³•ï¼ŒRediså®˜æ–¹çš„ä¸€ä¸ªè¯´æ˜è¯´å¦‚æœä½ çš„å†…å­˜ç¢ç‰‡å¤§äº1.4å€ï¼Œè¿™ä¸ªæ—¶å€™ä½ å¯ä»¥è€ƒè™‘åšä¸€äº›å†…å­˜ç¢ç‰‡çš„å¤„ç†ï¼Œæ¯”å¦‚è¯´æœ€æ˜æ˜¾çš„æ–¹æ³•å°±æ˜¯é‡å¯ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸å…è®¸é‡å¯çš„ï¼Œä½†æ˜¯åœ¨<code>redis sentinel</code>ã€<code>redis cluster</code>è¿™æ ·çš„æ¶æ„æ˜¯å…è®¸æŠŠslaveèŠ‚ç‚¹é‡å¯ï¼Œé‡å¯ä¹‹åç„¶åå®ƒä¼šåšä¸€ä¸ªé‡æ–°çš„å†…å­˜åˆ†é…ï¼Œè¿™æ ·çš„è¯å¯ä»¥å°†ç¢ç‰‡è¿›è¡Œä¸€ä¸ªæ¸…ç†ï¼Œå¯¹äºä¸»èŠ‚ç‚¹æ¥è¯´ä¹Ÿå¯ä»¥ï¼Œå¦‚æœä½ çœŸçš„æƒ³åšé‚£æ ·çš„äº‹æƒ…çš„è¯å¯ä»¥åšä¸€ä¸ªä¸»ä»åˆ‡æ¢ï¼Œç„¶åå†æŠŠå®ƒå½“åšä»èŠ‚ç‚¹å†è¿›è¡Œé‡å¯ï¼Œè¿™æ ·å°±å¯ä»¥å®Œæˆç¢ç‰‡çš„æ•´ç†ï¼›ç›®å‰Redis3æ¥è¯´æ²¡æœ‰å¤ªå¥½çš„è§£å†³åŠæ³•ï¼Œå¯¹äºRedis4ã€Redis5è¿™äº›ç‰ˆæœ¬è¿™ç§æƒ…å†µæœ‰ä¸€ä¸ªå†…å­˜ç¢ç‰‡ç®¡ç†çš„é€‰é¡¹çš„ï¼Œä½†æ˜¯è¿™ä¸ªä¸œè¥¿æ²¡æœ‰åœ¨çº¿ä¸Šæˆ–è€…äº‘æœåŠ¡ã€ä¸€äº›å…¬å¸å¤§è§„æ¨¡å»ä½¿ç”¨ï¼Œæ‰€ä»¥æš‚æ—¶è¿˜ä¸å»ºè®®å»ç”¨ï¼Œä½ å¯ä»¥å»äº†è§£ä¸€ä¸‹ç›¸å…³çš„å†…å®¹</p><h2 id="å­è¿›ç¨‹å†…å­˜å†…å­˜æ¶ˆè€—"><a href="#å­è¿›ç¨‹å†…å­˜å†…å­˜æ¶ˆè€—" class="headerlink" title="å­è¿›ç¨‹å†…å­˜å†…å­˜æ¶ˆè€—"></a>å­è¿›ç¨‹å†…å­˜å†…å­˜æ¶ˆè€—</h2><p>ä½ å¯¹aofã€rdbæ¯”è¾ƒäº†è§£çš„æƒ…å†µä¸‹ä½ åº”è¯¥çŸ¥é“Redisæ˜¯ä½¿ç”¨forkæ¥å®ç°bgsaveå’Œbgrewriteaofï¼›å®ƒæ˜¯ä¸€ä¸ªå¿…é¡»å­˜åœ¨çš„ï¼Œå‡å¦‚æˆ‘ä»¬æ‰§è¡Œäº†forkï¼Œå¿…ç„¶ä¼šäº§ç”Ÿä¸€ä¸ªå­è¿›ç¨‹ï¼Œé‚£è‚¯å®šä¼šæœ‰é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œè¿™é‡Œè¯´çš„å¿…ç„¶å­˜åœ¨æ˜¯å› ä¸ºå³ä½¿ä½ å…³äº†aofå½“ç„¶å®ƒæ˜¯æ²¡æœ‰aofé‡å†™äº†ï¼Œä½ å…³äº†è‡ªåŠ¨saveè¿˜æ˜¯æ— æ³•é¿å…å…¨é‡å¤åˆ¶ï¼Œå®ƒä¹Ÿæ˜¯ç”¨rgsaveç”Ÿæˆä¸€ä¸ªrdbå…¨é‡çš„æ–‡ä»¶ï¼Œå®ƒå¿…ç„¶ä¼šäº§ç”Ÿforkï¼Œforkæ˜¯æ— æ³•é¿å…çš„ï¼›</p><p>å®ƒçš„ä¼˜åŒ–æ–¹å¼æœ‰å‡ ç§ï¼š</p><ul><li>å»æ‰THPç‰¹æ€§ï¼šå®ƒæ˜¯åœ¨Linuxå†…æ ¸çš„2.6.38å¢åŠ çš„ï¼Œå®ƒå¯ä»¥åŠ å¿«forkçš„é€Ÿåº¦ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒåœ¨å†™æ—¶å¤åˆ¶çš„æ—¶å€™å®ƒçš„å†…å­˜é¡µä¼šæ¯”åŸæ¥æ‰©å¤§512å€ï¼ŒåŸç†çš„4KBç°åœ¨å˜æˆ2MBï¼Œå¦‚æœå†™é‡éå¸¸å¤§çš„æ—¶å€™å®ƒä¼šäº§ç”Ÿä¸å¿…è¦çš„é˜»å¡ã€å†…å­˜çš„æš´å¢ï¼Œè¿™é‡Œçš„å†…æ ¸ä¼˜åŒ–ä¼šåœ¨åé¢è¿›è¡Œè¯´æ˜ï¼›</li><li>è§‚å¯Ÿå†™å…¥é‡ï¼šcopy-on-writeçš„å†™å…¥é‡ï¼›</li><li>overcommit_memory=1ï¼Œè¿™ä¸ªåœ¨åä»‹ç»Linuxå†…æ ¸çš„æ—¶å€™ä¼šè¯´ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯ä»¥ç”¨forké¡ºåˆ©çš„å®Œæˆ</li></ul><h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>å†…å­˜ç®¡ç†æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ƒå¾ˆé‡è¦ï¼Œå®ƒçš„ç®€å•æ˜¯å› ä¸ºå®ƒå°±2ä¸ªå‚æ•°ï¼š</p><ul><li>ä½ è¦ç»™Redisè®¾ç½®ä¸€ä¸ªå†…å­˜ä¸Šé™ï¼Œè¿™ä¸ªå¯¹äºå†…å­˜ç®¡ç†æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼›</li><li>åŠ¨æ€è°ƒæ•´å†…å­˜ä¸Šé™ï¼Œè¿™ä¸ªå†…å®¹å’Œä¸Šé¢æ˜¯ç›¸å…³çš„ï¼›</li><li>å†…å­˜å›æ”¶ç­–ç•¥ï¼Œè¿™ä¸ªå’Œæœ€å¤§å†…å­˜ä¹Ÿæ˜¯ç›¸å…³çš„ï¼Œå½“ä½ çš„Redisè®¾ç½®äº†4GBå†…å­˜ï¼Œä½†æ˜¯ä½ å·²ç»ä½¿ç”¨æˆ–è€…è¶…è¿‡4GBå†…å­˜çš„æ—¶å€™ï¼Œä¹‹åä½ å†™å…¥çš„æ—¶å€™è¦é‡‡ç”¨ä»€ä¹ˆç­–ç•¥ï¼Œæ˜¯æŠŠåŸæ¥çš„æ•°æ®è¸¢æ‰ï¼Œè¿˜æ˜¯æ˜¯å•çº¯çš„å†™è¿›å»è¿˜æ˜¯ä½¿ç”¨å…¶ä»–çš„ä»€ä¹ˆç­–ç•¥ï¼Œè‡³äºè¸¢æ‰å“ªäº›æ•°æ®ä¹Ÿæœ‰ç›¸å…³ä¸åŒçš„ç­–ç•¥</li></ul><h2 id="è®¾ç½®å†…å­˜ä¸Šé™"><a href="#è®¾ç½®å†…å­˜ä¸Šé™" class="headerlink" title="è®¾ç½®å†…å­˜ä¸Šé™"></a>è®¾ç½®å†…å­˜ä¸Šé™</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107211253752.png" srcset="/img/loading.gif" alt="image-20191107211253752"></p><p>ç°åœ¨ä¸Šé¢è¿™å¼ å›¾ä¸­æ˜¯ä¸€ä¸ªLinuxï¼Œæˆ‘ä»¬æœ‰24GBï¼Œå®ƒæœ‰4ä¸ªRedisè¿›ç¨‹ï¼ŒRedis1-4ï¼Œæ¯ä¸ªæ˜¯4GBï¼Œæˆ‘ä»¬è¦ç»™è¿™ä¸ªæœºå™¨ç©ºé—²ä¸€äº›å†…å­˜å»åšAOFé‡å†™ã€BGSAVEè¿™æ ·äº§ç”Ÿçš„forkå†…å­˜ï¼Œå½“ç„¶å¯¹äºLinuxè‡ªèº«ä¹Ÿè¦é¢„ç•™ä¸€éƒ¨åˆ†å†…å­˜ï¼Œå¯¹äºé…ç½®æ¥è¯´å°±æ˜¯ä¸€ä¸ª<code>max-memory</code>ä¸€ä¸ªé€‰é¡¹æ¥ç»™Redisè®¾ç½®ä¸€ä¸ªæœ€å¤§å†…å­˜ï¼Œè¿™æ ·çš„å¥½å¤„åœ¨äºæˆ‘ä»¬å¯ä»¥å¯¹æ¯ä¸ªRedisä½¿ç”¨å†…å­˜è¿›è¡Œé™åˆ¶ï¼Œå½“é™åˆ¶ä¹‹åæˆ‘ä»¬å¯ä»¥å¯¹æœºå™¨å†…å­˜çš„ä½¿ç”¨è¿›è¡Œåˆç†çš„ç®¡ç†ï¼Œå‡å¦‚æˆ‘ä»¬ç°åœ¨å¯åŠ¨äº†å¾ˆå¤šRedisï¼Œä½†æ˜¯æ²¡æœ‰å¯¹å®ƒä»¬è®¾ç½®æœ€å¤§å†…å­˜ï¼Œå¦‚æœæ— æ³•æ§åˆ¶Rediså†…å­˜çš„ä½¿ç”¨é‡å¯èƒ½ä¼šè¶…è¿‡å•æœºå°±ä¼šå½±å“å…¶ä»–çš„å®ä¾‹ï¼Œè¿™ä¸œè¥¿å¯¹äºRedisç®¡ç†æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆè‡´å‘½çš„é—®é¢˜ï¼Œè¿™é‡Œè¿˜è¦æåˆ°ä¸€ç‚¹ï¼šæˆ‘ä»¬è¦é¢„ç•™ç™¾åˆ†30ï¼Œè¿™ä¸ªæ˜¯éœ€è¦æ ¹æ®ä½ å…¬å¸çš„å®é™…æƒ…å†µæ¥å†³å®šï¼Œå¯èƒ½ä½ ä»¬æœºå™¨æ¯”è¾ƒå¤šï¼Œè€Œä¸”ä½¿ç”¨ä¸Šæ¯”è¾ƒå®½é•¿ä¸€äº›ï¼Œå¯èƒ½ä¼šé¢„ç•™å¤šä¸€äº›ï¼Œå½“ç„¶é¢„ç•™çš„è¶Šå¤šä½ äº§ç”Ÿçš„å±é™©å°±è¶Šå°ï¼Œå› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå®ƒå¯èƒ½ä¼šäº§ç”Ÿä¸€äº›é¢å¤–çš„å¼€é”€ï¼Œæ¯”å¦‚åƒå®¢æˆ·ç«¯ç¼“å†²åŒºçš„æš´å¢ï¼Œå®¢æˆ·ç«¯ç¼“å†²åŒºæ˜¯æ— æ³•é€šè¿‡<code>max-memory</code>é™åˆ¶çš„ï¼Œ<code>max-memory</code>æ˜¯è¯´å½“ä½ çš„<code>used-memory</code>è¶…è¿‡<code>max-memory</code>æ˜¯å¯¹äº<code>key-value</code>çš„ç®¡ç†ï¼Œå¯¹äºè¿™ç§å®¢æˆ·ç«¯ç¼“å†²åŒºçš„æš´å¢å®ƒæ˜¯æ— æ³•é™åˆ¶çš„ï¼Œé’ˆå¯¹äºè¿™ç±»é—®é¢˜ç”šè‡³ä¸€äº›forkäº§ç”Ÿçš„å†…å­˜è¿™äº›é¢å¤–å†…å­˜ä»¥å¤–çš„é—®é¢˜ä½ é¢„ç•™çš„å†…å­˜è¶Šå¤šå¯èƒ½è¿™ç§äº§ç”Ÿå†…å­˜æº¢å‡ºçš„å¯èƒ½å°±ä¼šè¶Šå°ï¼Œå¦‚æœä½ ä»¬å…¬å¸å½“å‰æœºå™¨æ¯”è¾ƒç´§å¼ ä¸€äº›å¯èƒ½é¢„ç•™çš„ä¼šå°‘ä¸€äº›ï¼Œå¦‚æœä½ æŠŠå†…å­˜ç›‘æ§åšçš„è¶³å¤Ÿå¥½ï¼Œå¯èƒ½äº§ç”Ÿå†…å­˜æº¢å‡ºçš„å¯èƒ½æ€§å°±è¶Šå°ï¼›</p><h2 id="è®¾ç½®å†…å­˜ä¸Šé™-1"><a href="#è®¾ç½®å†…å­˜ä¸Šé™-1" class="headerlink" title="è®¾ç½®å†…å­˜ä¸Šé™"></a>è®¾ç½®å†…å­˜ä¸Šé™</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107211801815.png" srcset="/img/loading.gif" alt="image-20191107211801815"></p><pre><code class="hljs bash">redis&gt; config <span class="hljs-built_in">set</span> maxmemory 6GBredis&gt; config <span class="hljs-built_in">set</span> maxmemory 2GBredis&gt; config rewrite</code></pre><p>ä¾‹å¦‚åˆšæ‰å“ªä¸ªRedis1åˆ°Redis4ï¼Œæ¯ä¸ª4GBçš„ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘Redis2å…¶å®ç”¨ä¸äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬ä¸Šé™ä¹‹åå‘ç°å®ƒç”¨ä¸äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å¯èƒ½å°±ä¼šç»™å®ƒè¿›è¡Œä¸€ä¸ªç¼©å®¹ï¼Œå°†åŸæ¥çš„4GBå˜æˆäº†2GBï¼Œä½†æ˜¯æ³¨æ„ä½ çš„åŸæ¥çš„4GBä½¿ç”¨æœ€å¥½ä¸è¦è¶…è¿‡2GBï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¶…è¿‡2GBå°±å¯èƒ½äº§ç”Ÿä¸€ä¸ªæ•°æ®çš„å›æ”¶é—®é¢˜ï¼Œå¯¹äºRedis1æ¥è¯´åŸæ¥4GBï¼Œç°åœ¨å˜æˆäº†6GBï¼Œé‚£ä¹ˆå°±åº”è¯¥åœ¨Redis1ä¸­å»æ‰§è¡Œ<code>config set maxmemory 6GB</code>ï¼Œåœ¨Redis2ä¸­æ‰§è¡Œ<code>config set maxmemory 2GB</code> ï¼Œå¯¹äºè¿™2ä¸ªæ“ä½œæˆ‘ä»¬éƒ½è¦è¿›è¡Œ <code>config rewrite</code>ï¼Œè¿›è¡Œä¸€ä¸ªé…ç½®é‡å¯ï¼Œç»™å®ƒå›åˆ°ç£ç›˜å½“ä¸­</p><h2 id="å†…å­˜å›æ”¶ç­–ç•¥"><a href="#å†…å­˜å›æ”¶ç­–ç•¥" class="headerlink" title="å†…å­˜å›æ”¶ç­–ç•¥"></a>å†…å­˜å›æ”¶ç­–ç•¥</h2><p>ä¸Šä¸€éƒ¨åˆ†å†…å®¹éå¸¸ç®€å•å°±æ˜¯ä¸€ä¸ªå†…å­˜ç®¡ç†ï¼Œä½†æ˜¯å»ºè®®åœ¨ä½ çš„Redisä½¿ç”¨è¿‡ç¨‹ä¸­éƒ½è¦è¿›è¡Œä¸€ä¸ªè®¾ç½®ï¼Œä¸€ä¸ªé—®é¢˜ï¼šå½“ä½ çš„ key-valueæˆ–è€…è¯´å†…å­˜å·²ç»è¶…è¿‡äº† <code>maxmemory</code>è®¾ç½®çš„æ—¶å€™é‚£å®ƒæ¯”å¦‚ä¼šæœ‰ä¸€äº›äº‹æƒ…å‘ç”Ÿï¼Œæˆ‘ä»¬è¿™ä¸ªæ—¶å€™å†™æ•°æ®ä¼šå°†è¿‡æœŸé”®åˆ é™¤ï¼›</p><h2 id="å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥"><a href="#å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥" class="headerlink" title="å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥"></a>å†…å­˜æº¢å‡ºæ§åˆ¶ç­–ç•¥</h2><p>Rediså†…å­˜è¶…è¿‡äº†<code>maxmemory</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™è‚¯å®šè¦åšå¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚æ˜¯ä¸æ˜¯è¦å°†åŸç†çš„æ•°æ®å‰”é™¤ï¼Ÿè¿˜æ˜¯è¯´ç°åœ¨æ ¹æœ¬å°±å†™ä¸è¿›å»å•Šï¼Ÿç±»ä¼¼äºè¿™æ ·çš„äº‹æƒ…ï¼›</p><h3 id="åˆ é™¤è¿‡æœŸä»¶"><a href="#åˆ é™¤è¿‡æœŸä»¶" class="headerlink" title="åˆ é™¤è¿‡æœŸä»¶"></a>åˆ é™¤è¿‡æœŸä»¶</h3><p>è¿‡æœŸä»¶åˆ é™¤æœ‰2ç§ç­–ç•¥ï¼š</p><ol><li><p>æƒ°æ€§åˆ é™¤ï¼šåœ¨è¯´æƒ°æ€§åˆ é™¤ä¹‹å‰å¯ä»¥è¯´ä¸€äº›Rediså†…æ ¸æºç å®ƒå¯¹äºkey-valueçš„ä¸€ä¸ªç®¡ç†å®ƒæ˜¯è¿™æ ·çš„ï¼šå¯¹äºå¤šä¸ªkey-valueå®ƒä¼šå•ç‹¬ç”¨ä¸€ä¸ªhashtableè¿›è¡Œä¸€ä¸ªå­˜å‚¨ï¼Œè¿‡æœŸçš„keyå®ƒä¹Ÿä¼šä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„hashtableè¿›è¡Œå­˜å‚¨ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬getä¸€ä¸ªhelloçš„æ—¶å€™å®ƒé¦–å…ˆä¼šå»è¿‡æœŸhashtableæˆ–è€…å­—å…¸é‡Œé¢å»æŸ¥ä¸€ä¸‹çœ‹è¿™ä¸ªkeyæœ‰æ²¡æœ‰è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†å®ƒä¼šå°†è¿™ä¸ªkeyåˆ é™¤ï¼Œè€Œä¸”å®ƒè¿˜ä¼šåšä¸€ä»¶äº‹æƒ…ï¼šæŠŠè¿™ä¸ªkeyè¿”å›ä¸€ä¸ªç©ºï¼›å¦‚æœåœ¨è¿‡æœŸè¡¨é‡Œæ²¡æœ‰ï¼Œå®ƒä¼šä»åŸç”Ÿçš„hashtableé‡Œé¢å»è·å–ï¼›</p></li><li><p>å®šæ—¶åˆ é™¤ï¼šä¸ºä»€ä¹ˆè¦åšå®šæ—¶åˆ é™¤ï¼Ÿæœ‰ç§å¯èƒ½æˆ‘çš„keyè¿‡æœŸäº†ï¼Œä½†æ˜¯æˆ‘ä¸‹æ¬¡æ²¡æœ‰å»è®¿é—®å®ƒï¼Œå®ƒä¼šé€ æˆè¿™ä¸ªè¿‡æœŸè¿™ä¸ªè¡¨ä¼šä¸æ–­çš„æ‰©å¤§ï¼Œæˆ‘ä»¬å¯ä»¥æƒ³åˆ°çš„ç­–ç•¥å°±æ˜¯æˆ‘å®šæœŸå¯¹è¿™ä¸ªè¿‡æœŸhashtableè¿›è¡Œä¸€ä¸ªæ‰«æï¼Œå¯¹äºRedisæ¥è¯´å®ƒæœ‰ä¸€ä¸ªå®šæ—¶åˆ é™¤çš„ç­–ç•¥ï¼Œå®ƒæ¯ç§’è¿è¡Œ10æ¬¡æ¥è¿›è¡Œé‡‡æ ·åˆ é™¤ï¼Œå®ƒçš„åˆ é™¤ç­–ç•¥æ˜¯è¿™æ ·ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107212905506.png" srcset="/img/loading.gif" alt="image-20191107212905506"></p><p>å¯¹æ¯ä¸ªæ•°æ®åº“éšæœºé€‰ä¸¾20ä¸ªé”®ï¼Œå®ƒå‘ç°å¦‚æœè¶…è¿‡äº†ç™¾åˆ†25éƒ½æ˜¯è¦è¿‡æœŸçš„ï¼Œå®ƒå°±ä¼šè¿›è¡Œæ–°çš„å¾ªç¯ï¼Œè¿›å…¥æ›´å¿«çš„ç­–ç•¥ï¼Œè¿›è¡Œä¸€ä¸ªåˆ é™¤ï¼Œå°±æ˜¯è¯´å®ƒä¸ä¼šé€€å‡ºå½“å‰å¾ªç¯ï¼Œè€Œæ˜¯è¿›å…¥äºŒæ¬¡çš„é‡‡æ ·åˆ é™¤ï¼›å¦‚æœå®ƒå‘ç°è¿‡æœŸçš„æ¯”è¾ƒå°‘ï¼Œé‚£å®ƒå°±ç›´æ¥é€€å‡ºè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯</p></li></ol><h2 id="ç­–ç•¥ä»‹ç»"><a href="#ç­–ç•¥ä»‹ç»" class="headerlink" title="ç­–ç•¥ä»‹ç»"></a>ç­–ç•¥ä»‹ç»</h2><p>å¯¹äºRediså†…å­˜çš„ä¸€ä¸ªå›æ”¶è¿˜æœ‰ç¬¬äºŒç§ï¼šå½“ä½ çš„ä½¿ç”¨å†…å­˜è¶…è¿‡äº†maxmemoryï¼Œæœ‰ä¸€ä¸ªé…ç½®æ¥è¿›è¡Œä¸€ä¸ªå®šä¹‰å°±æ˜¯maxmemory-policyè¿™æ ·çš„å†…å­˜ç­–ç•¥ï¼Œå®ƒçš„ç­–ç•¥éå¸¸å¤šï¼Œå¤§æ¦‚æœ‰5ç§ï¼Œä½†æ˜¯æœ‰å¾ˆå¤šæ˜¯ç›¸ä¼¼çš„ï¼š</p><ul><li>Noevication:å®ƒä¸ä¼šè¿›è¡Œæ•°æ®åˆ é™¤ï¼Œæ¯”å¦‚è¯´ä½ ç°åœ¨æœ‰4GBï¼Œç°åœ¨<code>used memory</code>è¶…è¿‡äº†4GBï¼Œè¿™ä¸ªæ—¶å€™æˆ‘åœ¨è¿›è¡Œæ•°æ®å†™å…¥çš„æ—¶å€™æˆ‘ä¼šè¿”å›ç»™ä½ ä¸€ä¸ªé”™è¯¯ï¼šâ€œ(error) OOM command not allowed when used memoryâ€ï¼Œå‘Šè¯‰ä½ ç°åœ¨å†…å­˜å·²ç»æ»¡äº†ï¼Œä¸è¦å»å†™å…¥æ•°æ®äº†ï¼›</li><li>Volatile-lruï¼šæ ¹æ®LRUç®—æ³•æ ¹æ®ä½ æœ€è¿‘ä½¿ç”¨æ¯”è¾ƒå°‘çš„ä¸€äº›keyè¿›è¡Œåˆ é™¤ï¼Œè¿™äº›keyæ˜¯ç›¸å¯¹æ¥è¯´ä¸é‡è¦çš„ï¼Œæœªæ¥ä¿è¯æ–°çš„å‘½ä»¤å†™å…¥æ˜¯æˆåŠŸçš„å®ƒé‡‡å–è¿™æ ·çš„ç­–ç•¥ï¼Œè¿™é‡Œå®ƒè®¤ä¸ºä¸é‡è¦çš„æ•°æ®æ˜¯è¿‡æœŸè¡¨ä¸­çš„æ•°æ®ï¼Œå“ªäº›æ•°æ®ä¸é‡è¦å‘¢?å°±æ˜¯LRUç®—æ³•ï¼Œæœ€è¿‘ä½¿ç”¨æ¯”è¾ƒå°‘çš„è€Œä¸”å®ƒæ˜¯å³å°†è¿‡æœŸçš„ï¼Œè¿™æ ·çš„è¯è¿›è¡Œä¸€ä¸ªæ•°æ®åˆ é™¤ä¼šæ¯”è¾ƒç¨³å¦¥ï¼Œå½“ç„¶è¿™æ ·ä¹Ÿå¯èƒ½åˆ é™¤ä¸€ä¸ªé‡è¦çš„æ•°æ®ï¼›</li><li>Allkeys-lruï¼šåœ¨æ‰€æœ‰é”®ä¸­ä½¿ç”¨LRUç®—æ³•è¿›è¡Œåˆ é™¤ï¼›</li><li>Allkkeys-randomï¼šéšæœºåˆ é™¤æ‰€æœ‰é”®ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ï¼›</li><li>volatile-randomï¼šéšæœºåˆ é™¤è¿‡æœŸé”®ï¼Œç›´åˆ°è…¾å‡ºè¶³å¤Ÿç©ºé—´ä¸ºæ­¢ï¼›</li><li>volatile-ttlï¼šæ ¹æ®é”®å€¼å¯¹è±¡çš„ttlå±æ€§ï¼Œåˆ é™¤æœ€è¿‘å°†è¦è¿‡æœŸçš„æ•°æ®ã€‚å¦‚æœæ²¡æœ‰ï¼Œå›é€€åˆ°noevictionç­–ç•¥ã€‚</li></ul><blockquote><p>åœ¨å®é™…ä½¿ç”¨ä¸­è¦æ ¹æ®ä½¿ç”¨åœºæ™¯è¿›è¡Œå†³å®šï¼Œå‡å¦‚æˆ‘ä»¬çœŸçš„ä¸åœ¨ä¹æ‰€æœ‰æ•°æ®æ˜¯å¦ä¸¢å¤±ï¼Œé‚£æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Allkeys-lruè¿™æ ·çš„ç­–ç•¥ï¼Œå‡å¦‚å¸Œæœ›åªåœ¨è¿‡æœŸçš„æ•°æ®é›†è¿›è¡Œæ•°æ®çš„åˆ é™¤å¯ä»¥ä½¿ç”¨volatileç›¸å…³çš„ç­–ç•¥ï¼Œè¿™é‡Œä¸å¤ªæ¨èä½¿ç”¨é»˜è®¤çš„ç­–ç•¥ã€‚å½“ç„¶é»˜è®¤çš„ç­–ç•¥æ˜¯å¯ä»¥çš„ï¼Œå®ƒå¯ä»¥ä¿è¯æˆ‘çš„è€æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæ–°æ•°æ®å†™å…¥å¤±è´¥ï¼Œå¯¹äºå¤§çš„äº’è”ç½‘æ¥è¯´è¿™ä¸ªä¸æ˜¯ä¸€ä¸ªå¾ˆé€šç”¨çš„äº‹</p></blockquote><h1 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h1><h2 id="å†…å­˜åˆ†å¸ƒ"><a href="#å†…å­˜åˆ†å¸ƒ" class="headerlink" title="å†…å­˜åˆ†å¸ƒ"></a>å†…å­˜åˆ†å¸ƒ</h2><blockquote><p>ä¸ºä»€ä¹ˆè¦ä»‹ç»å†…å­˜åˆ†å¸ƒï¼Ÿå› ä¸ºæˆ‘ä»¬è¦åšå†…å­˜ä¼˜åŒ–è¦ä¼˜åŒ–å“ªäº›éƒ¨åˆ†</p></blockquote><h3 id="å†…å­˜æ¶ˆè€—-2"><a href="#å†…å­˜æ¶ˆè€—-2" class="headerlink" title="å†…å­˜æ¶ˆè€—"></a>å†…å­˜æ¶ˆè€—</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191106200207592-1573041728497-1573135246853.png" srcset="/img/loading.gif" alt="image-20191106200207592"></p><p>å›é¡¾ä¸€ä¸‹å†…å­˜æ¶ˆè€—ï¼Œused_memoryæ¥è¯´å®ƒæœ‰</p><ul><li>è‡ªèº«å†…å­˜æ¶ˆè€—ï¼Œå¤§æ¦‚æ˜¯800kbï¼Œ</li><li>ç¼“å†²åŒºå†…å­˜åŒ…æ‹¬å®¢æˆ·ç«¯ç¼“å†²åŒºåŒ…æ‹¬å®¢æˆ·ç«¯è¾“å…¥è¾“å‡ºç¼“å†²åŒºæœ‰ä¸‰ç§ç±»å‹ï¼šæ™®é€šå®¢æˆ·ç«¯ã€slaveã€pubsubï¼Œè¾“å‡ºç¼“å†²åŒºã€è¾“å…¥ç¼“å†²åŒºç›¸å¯¹ç‹¬ç«‹çš„ï¼›</li><li>å¯¹è±¡å†…å­˜ï¼šRedisä¸­å­˜äº†å¾ˆå¤škey-valueï¼Œè¿™ä¸ªä¹Ÿæ˜¯èŠ‚çœå†…å­˜æˆ–è€…è¯´å†…å­˜ä¼˜åŒ–çš„é‡å¤´æˆ</li></ul><h2 id="åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„"><a href="#åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„" class="headerlink" title="åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„"></a>åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„</h2><p>å‰é¢æåˆ°äº†å¾ˆå¤šåƒå®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œåƒaofç¼“å†²åŒºæˆ–è€…è¯´å¤åˆ¶ç¼“å†²åŒºä¼˜åŒ–çš„ä½™åœ°ä¸æ˜¯ç‰¹åˆ«å¤šï¼Œå®ƒå…¶å®ä¸»è¦ä½“ç°åœ¨æ™®é€šå®¢æˆ·ç«¯ï¼Œä½ çš„å‘½ä»¤çš„ä½¿ç”¨ã€åˆç†çš„APIä½¿ç”¨ï¼Œå‡å¦‚ä½ ä½¿ç”¨ä¸åˆç†ï¼Œå‡å¦‚è¯´hgetallã€monitorå¯¼è‡´è¾“å‡ºç¼“å†²åŒºæ¯”è¾ƒå¤§ï¼Œè¿™å’Œä½ çš„QPSæœ‰å…³ï¼›</p><p>å¯¹äºkey-valueçš„ä¸œè¥¿ï¼Œæˆ‘ä»¬æœ€é‡è¦çš„æ˜¯ä¼˜åŒ–å®ƒçš„å€¼å¯¹è±¡ï¼Œä¼˜åŒ–å€¼å¯¹è±¡å°±æ˜¯è¯´æˆ‘ä»¬é€‰æ‹©ä¸€ä¸ªåˆç†çš„æ•°æ®ç»“æ„ï¼Œç°åœ¨æœ‰ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ï¼šè¦è®¡ç®—æ¯å¤©çš„ç‹¬ç«‹ç”¨æˆ·æ•°ï¼Œå®é™…ä¸Šæœ‰å¾ˆå¤šæ–¹å¼ï¼Œæ­£ç¡®çš„æ–¹å¼æ¯”å¦‚è¯´ä½¿ç”¨hadoopçš„ä¸€å¥—ä¸œè¥¿è®¾ç½®æ—¥å¿—ï¼Œç„¶ååšæ¯å¤©çš„è®¡ç®—ï¼Œç°åœ¨å‡å¦‚è¯´æˆ‘å½“å‰è¿™ä¸ªéœ€æ±‚ä¸æ˜¯è¿™ä¹ˆå¤§è§„æ¨¡çš„ï¼Œè€Œæ˜¯è®©ä½ ç”¨Rediså®ç°æ¥è¾¾åˆ°æ¯”è¾ƒå¿«çš„ç›®çš„ï¼Œé‚£ä½ æ€ä¹ˆå»åšå‘¢ï¼Ÿè¿™é‡Œå°±æœ‰å¾ˆå¤šæ–¹å¼äº†ï¼š<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107221431230.png" srcset="/img/loading.gif" alt="image-20191107221431230"></p><ul><li>é›†åˆï¼šè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œç°åœ¨è¦è®°å½•æ¯å¤©ç‹¬ç«‹ç”¨æˆ·æ•°ï¼Œé‚£æˆ‘ä»¬å°±ç”¨ä¸€ä¸ªé›†åˆç„¶ååœ¨åŠ ä¸Šä¸€ä¸ªæ—¶é—´æ ‡ç­¾æŠŠæˆ‘ä»¬æ‰€ä»¥çš„IDæ”¾åˆ°è¿™ä¸ªé›†åˆå½“ä¸­ï¼Œæœ€ç»ˆæ±‚å‡ºé›†åˆçš„æ€»æ•°ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬è¿‡æ»¤æ‰æœ‰å¯èƒ½äº§ç”Ÿçš„ç‹¬ç«‹ç”¨æˆ·æ•°ï¼›</li><li>BitMapsï¼šä½å›¾çš„è¯å¯ä»¥å°†æ¯ä¸ªç”¨æˆ·å»å¯¹åº”åˆ°ä½å›¾ä¸­çš„ä½ï¼Œå¦‚æœè¿™ä¸ªä½æ˜¯1ï¼Œå°±è¯æ˜å®ƒå‡ºç°è¿‡ï¼Œç„¶åå®ƒæ²¡æœ‰å‡ºç°å°±æ˜¯0ï¼Œæœ€åç»Ÿè®¡ä¸€ä¸‹æ‰€æœ‰ä¸º1çš„ä¸ªæ•°å°±å¯ä»¥ç®—å‡ºå®ƒçš„ç”¨æˆ·æ•°ï¼›</li><li>HyperLogLogï¼šé€šè¿‡è¿™ä¸ªæ¥å®ç°è®¡æ•°çš„æ–¹å¼ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå®ƒçš„æœ€ç»ˆç»“æœå¯èƒ½ä¸æ˜¯å‡†çš„ã€‚</li></ul><p>è¿™é‡Œè¦æ ¹æ®ç”¨æˆ·åœºæ™¯æ¥è¿›è¡Œé€‰æ‹©ï¼Œè¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬å½“å‰ç”¨æˆ·é‡éå¸¸å¤§ï¼Œæ¯å¤©æœ‰å‡ ä¸ªäº¿ï¼Œä½†æ˜¯æˆ‘ä»¬ç»Ÿè®¡å¤§æ¦‚æœ‰å¤šå°‘å°±å¯ä»¥äº†ï¼Œè€Œä¸”æˆ‘ä»¬è¦æ±‚å†…å­˜ä½¿ç”¨éå¸¸ä½ï¼Œé‚£è¿™ä¸ªæ—¶å€™HyperLogLogæ˜¯å¯ä»¥æ»¡è¶³çš„ï¼Œå‡å¦‚æˆ‘ä»¬æ¯å¤©çš„ç”¨æˆ·æ•°éå¸¸å°‘ï¼Œè€Œä¸”æˆ‘å¸Œæœ›ä¿å­˜ä¸‹æ¥æ‰€æœ‰çš„userIdï¼Œè¿™ä¸ªæ—¶å€™HyperLogLogæ˜¯ä¸åˆç†çš„å®ƒæ²¡æ³•ä¿å­˜IDï¼Œè¿™é‡Œå®Œå…¨å¯ä»¥ä½¿ç”¨é›†åˆæˆ–è€…BitMapsï¼ŒBitMapsä¼šèŠ‚çœå¾ˆå¤šå†…å­˜ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯ä½ BitMapsè¦è·Ÿä½ çš„userIdåšä¸€ä¸ªå¯¹åº”ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šå¢åŠ å¤æ‚åº¦ï¼Œç”šè‡³æ˜¯è¯´ä½ BitMapsæ¯”è¾ƒæ¾æ•£ï¼ŒBitMapså¯èƒ½æ¯”è¾ƒé•¿ï¼Œåœ¨ä½ çš„userIdæ¯”è¾ƒæ¾æ•£çš„æ—¶å€™è¿™ä¸ªæ—¶å€™å¯èƒ½æ¥è¯´é›†åˆä¼šç”¨çš„å°ä¸€äº›å†…å­˜ï¼Œè¿™ä¸ªä¹Ÿè¦åšä¸€ä¸ªæƒè¡¡ï¼Œè¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå‡å¦‚ä½ è¿™ä¸ªç½‘ç«™æœ‰10äº¿ç”¨æˆ·ï¼Œæ¯å¤©å°±æœ‰10ä¸‡äººè®¿é—®çš„è¯ï¼Œæ˜¾ç„¶ç”¨é›†åˆæ¯”BitMapsè¦å¥½ï¼Œå› ä¸ºä½ è¦ç»™10äº¿äººå»åšä¸€ä¸ªä½å›¾å…¶å®ä¹Ÿæ˜¯éå¸¸åºŸå†…å­˜çš„ï¼›</p><h2 id="åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„-å†…éƒ¨ç¼–ç "><a href="#åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„-å†…éƒ¨ç¼–ç " class="headerlink" title="åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„-å†…éƒ¨ç¼–ç "></a>åˆç†é€‰æ‹©ä¼˜åŒ–æ•°æ®ç»“æ„-å†…éƒ¨ç¼–ç </h2><h3 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107222103645.png" srcset="/img/loading.gif" alt="image-20191107222103645"></p><p>é€‰æ‹©åˆç†æ•°æ®ç»“æ„çš„å¦ä¸€ç§æ–¹å¼å°±æ˜¯è¦åšä¸€ä¸ªå†…éƒ¨ç¼–ç ï¼Œè¿™æ ·æˆ‘ä»¬é€‰æ‹©çš„æ˜¯ä¸€ä¸ªåˆç†çš„æ•°æ®ç»“æ„ï¼Œä¸‹ä¸€ä¸ªå…¶å®è¦é€‰æ‹©ç¼–ç ï¼Œä»¥å“ˆå¸Œä¸ºä¾‹å­ï¼Œå®ƒæœ‰hashtableã€ziplistä¸¤ç§æ¨¡å¼ï¼Œziplistæ˜¯å‹ç¼©åˆ—è¡¨å®ƒå°±æ˜¯ç”¨ä¸€ä¸ªè¿ç»­å­˜å‚¨çš„åˆ—è¡¨æ¥æ¨¡æ‹Ÿhashtableçš„ä½¿ç”¨æ–¹å¼ï¼Œå½“ç„¶å…¶å®æˆ‘ä»¬å¯ä»¥æƒ³è±¡å‡ºæ¥ç”¨ä¸€ä¸ªåˆ—è¡¨å»æ¨¡æ‹Ÿhashçš„æ–¹å¼å®ƒè‚¯å®šä¼šåœ¨å­˜å‚¨é€Ÿåº¦ä¸Šä¼šæ¯”è¾ƒæ…¢ï¼Œæ¯”å¦‚æˆ‘ä»¬å»åšä¸€ä¸ªéšæœºçš„è·å–æˆ–è€…æ’å…¥ï¼Œè¿™ç§ä½¿ç”¨ziplistå®ƒå¿…ç„¶éœ€è¦åšä¸€ä¸ªå†…å­˜é‡å†™åˆ†é…ã€æŒ‡é’ˆä½ç§»ç±»ä¼¼è¿™äº›ä¸œè¥¿ï¼Œä½†æ˜¯å®ƒè¦ä½¿ç”¨è¿ç»­å­˜å‚¨è€Œä¸”ä»–è¦è‡ªèº«è¦åšå¾ˆå¤šä¼˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½å®ƒçš„å†…å­˜å¼€é”€ä¸Šä¼šæœ‰ä¸€äº›ä¼˜åŠ¿</p><hr><h3 id="ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ"><a href="#ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ" class="headerlink" title="ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ"></a>ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ</h3><p>éœ€æ±‚ï¼šç°åœ¨æœ‰å¾ˆå¤šå›¾ç‰‡idå’Œç”¨æˆ·idï¼Œå¤§æ¦‚æœ‰10äº¿ä¸ªï¼Œæˆ‘å¸Œæœ›é€šè¿‡picIdå¯ä»¥å¾—åˆ°userId</p><p>æ–¹æ¡ˆï¼š</p><ul><li>å…¨éƒ¨stringï¼šset picId userIdï¼›</li><li>ä¸€ä¸ªhahsï¼šhset allPics picId userIdï¼šæŠŠ10äº¿ä¸ªæ•°æ®å­˜å‚¨åœ¨ä¸€ä¸ªhahsé‡Œé¢ï¼Œè¿™æ ·åšæ˜¯æœ‰é—®é¢˜çš„ï¼Œå¯èƒ½è¿™æ˜¯ä¸€ä¸ªbigkeyçš„é—®é¢˜ï¼Œå¯¹äºè¿ç»´æ¥è¯´è¿™ä¸ªä¸œè¥¿æ˜¯ä¸€ä¸ªå¾ˆè®©äººå¤´ç–¼çš„çš„ä¸œè¥¿ï¼›</li><li>è‹¥å¹²ä¸ªå°hashï¼šhset picId/100 picId%100 userIdï¼šå¯¹ä¸Šé¢è¿™ç§å¤§çš„hahsè¿›è¡Œæ‹†åˆ†ï¼Œç»™å®ƒæ‹†åˆ†æˆè‹¥å¹²ä¸ªå°çš„çš„hashï¼Œæ¯ä¸€ä¸ªå°çš„hashé‡Œå­˜100ä¸ªfieldå’Œvalueï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬å°±å¯ä»¥å®ç°è‹¥å¹²çš„å°çš„hashï¼Œåé¢è¿™ç§å°çš„hahsæˆ‘ä»¬ä¼šä»‹ç»ï¼Œå¯¹äºè¿™ç§å°çš„hahsï¼Œå®ƒå°±ä¼šä½¿ç”¨ziplistè¿™ç§å­˜å‚¨æ–¹å¼ï¼Œç„¶åå¯ä»¥å¤§é‡çš„èŠ‚çœå†…å­˜</li></ul><p>ç°åœ¨çœ‹ä¸€ä¸‹ä¾‹å­ï¼šå‡å¦‚ç°åœ¨åªæœ‰100Wå¼ å›¾ç‰‡</p><h3 id="æ–¹æ¡ˆ1ï¼š"><a href="#æ–¹æ¡ˆ1ï¼š" class="headerlink" title="æ–¹æ¡ˆ1ï¼š"></a>æ–¹æ¡ˆ1ï¼š</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107223019036.png" srcset="/img/loading.gif" alt="image-20191107223019036"></p><p>picIdå’ŒuserIdä¸€ä¸€å¯¹åº”ï¼Œå®ƒçš„ä½¿ç”¨å†…å­˜ä¸º115.59M</p><h3 id="æ–¹æ¡ˆ2ï¼š"><a href="#æ–¹æ¡ˆ2ï¼š" class="headerlink" title="æ–¹æ¡ˆ2ï¼š"></a>æ–¹æ¡ˆ2ï¼š</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107223117730.png" srcset="/img/loading.gif" alt="image-20191107223117730"></p><p>å†…å­˜å¼€é”€129M</p><h3 id="æ–¹æ¡ˆ3ï¼š"><a href="#æ–¹æ¡ˆ3ï¼š" class="headerlink" title="æ–¹æ¡ˆ3ï¼š"></a>æ–¹æ¡ˆ3ï¼š</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107223141889.png" srcset="/img/loading.gif" alt="image-20191107223141889"></p><p>å†…å­˜å¼€é”€ï¼š26M</p><h3 id="3ç§æ–¹æ¡ˆå¯¹æ¯”"><a href="#3ç§æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="3ç§æ–¹æ¡ˆå¯¹æ¯”"></a>3ç§æ–¹æ¡ˆå¯¹æ¯”</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107223241833.png" srcset="/img/loading.gif" alt="image-20191107223241833"></p><h3 id="æ¶ˆè€—å†…å­˜åˆ†æ"><a href="#æ¶ˆè€—å†…å­˜åˆ†æ" class="headerlink" title="æ¶ˆè€—å†…å­˜åˆ†æ"></a>æ¶ˆè€—å†…å­˜åˆ†æ</h3><p>å°†æ‰€æœ‰å…ƒç´ å­˜åœ¨åœ¨ä¸€ä¸ªè¿ç»­çš„å­˜å‚¨å•å…ƒï¼Œå‡å°‘äº†æŒ‡é’ˆçš„ä½¿ç”¨ï¼Œåšäº†ä¸€äº›å‹ç¼©çš„å¤„ç†ï¼Œè¿™é‡Œä¸è¯¦ç»†ä»‹ç»ziplistçš„è¯¦ç»†å¤„ç†ï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹ziplistçš„æºç </p><p>ï¼ˆ1ï¼‰é…ç½®ï¼š</p><ul><li>hash-max-ziplist-entries 512</li><li>hash-max-ziplist-value 64</li></ul><blockquote><p>å½“hashæ•°æ®ç»“æ„å°äº512å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„hlenå°äº512ï¼Œè€Œä¸”è¿™ä¸ªå…ƒç´ ä¸­æ²¡æœ‰è¶…è¿‡64å­—èŠ‚çš„filedå’Œvalueè¿™ä¸ªä½¿ç”¨å°±ä¼šä½¿ç”¨å‹ç¼©åˆ—è¡¨ziplistæ¥å­˜å‚¨è¿™ä¸ªhash</p></blockquote><p>ï¼ˆ2ï¼‰ziplistï¼ˆå°å’Œé•¿åº¦æœ‰é™å¯¹è±¡ï¼‰</p><ul><li>è¿ç»­å†…å­˜</li><li>è¯»å†™æœ‰æŒ‡é’ˆåç§»ï¼Œæœ€å0(nçš„2æ¬¡æ–¹)</li><li>æ–°å¢åˆ é™¤æœ‰å†…å­˜é‡åˆ†é…</li></ul><p>ä½¿ç”¨è¿ç»­å­˜å‚¨ï¼Œå®ƒåœ¨ç®¡ç†hashè¿™æ ·çš„æ–¹å¼å¿…ç„¶ä¼šæ¯”è¾ƒæ…¢ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒè¦é™åˆ¶ä¸ªæ•°çš„åŸå› äº†ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢ziplistè¿‡å¤§ç„¶åå¯¹æ€§èƒ½äº§ç”Ÿå½±å“ï¼Œä¹Ÿå°±è¯´æœ€ç»ˆæ˜¯åœ¨æ€§èƒ½å’Œå†…å­˜èŠ‚çœä¸Šåšäº†ä¸€ä¸ªæƒè¡¡ï¼Œè¿™ç§è¿˜æ˜¯æ¯”è¾ƒå¥½çš„ä¸€ç§æ–¹å¼ï¼Œè¿™é‡Œçš„é…ç½®å»ºè®®ä¸è¦è®¾ç½®è¿‡å¤§ï¼Œå¦‚æœä¸ºäº†ä½¿ç”¨ziplistè®¾ç½®è¿‡å¤§é‚£å¯èƒ½ä½ ä½¿ç”¨Redisé€Ÿåº¦å¿«çš„ç›®çš„å°±æ— æ³•è¾¾åˆ°äº†</p><h3 id="ä¸‰ç§æ–¹æ¡ˆä¼˜ç‚¹å¯¹æ¯”"><a href="#ä¸‰ç§æ–¹æ¡ˆä¼˜ç‚¹å¯¹æ¯”" class="headerlink" title="ä¸‰ç§æ–¹æ¡ˆä¼˜ç‚¹å¯¹æ¯”"></a>ä¸‰ç§æ–¹æ¡ˆä¼˜ç‚¹å¯¹æ¯”</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107224230584.png" srcset="/img/loading.gif" alt="image-20191107224230584"></p><h2 id="å®¢æˆ·ç«¯å†…å­˜ä¼˜åŒ–"><a href="#å®¢æˆ·ç«¯å†…å­˜ä¼˜åŒ–" class="headerlink" title="å®¢æˆ·ç«¯å†…å­˜ä¼˜åŒ–"></a>å®¢æˆ·ç«¯å†…å­˜ä¼˜åŒ–</h2><h3 id="ç»“æ„"><a href="#ç»“æ„" class="headerlink" title="ç»“æ„"></a>ç»“æ„</h3><p>æ¥çœ‹ä¸€ä¸‹å®¢æˆ·ç«¯ç¼“å†²åŒºçš„ä¼˜åŒ–ï¼Œå‰é¢å·²ç»è¯¦ç»†ä»‹ç»äº†å®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œæˆ‘ä»¬å·²ç»æ¸…æ¥šäº†å®ƒçš„ç»“æ„ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦ä»‹ç»ä¸€ä¸ªä¾‹å­ï¼Œä»‹ç»ä¸€ä¸‹å®¢æˆ·ç«¯ç¼“å†²åŒºåœ¨ä½¿ç”¨ä¸­å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼›</p><p>è¿™é‡Œåœ¨æ¥å›é¡¾ä¸€ä¸‹å®¢æˆ·ç«¯ç¼“å†²åŒºï¼š</p><ul><li>è¾“å…¥ç¼“å†²åŒºï¼šå½“è¾“å…¥ç¼“å†²åŒºè¶…è¿‡1GBçš„æ—¶å€™å®ƒä¼šæŠŠä½ çš„è¿æ¥ç›´æ¥å¹²æ‰ï¼›</li><li>è¾“å‡ºç¼“å†²åŒºæœ‰å¾ˆå¤šç§ç±»å‹ï¼š<ul><li>æ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œå®ƒå¯ä»¥åšä¸€äº›é™åˆ¶</li><li>å‘å¸ƒè®¢é˜…ç¼“å†²åŒºå®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œå®ƒå¯ä»¥åšä¸€äº›é™åˆ¶ï¼›</li><li>å¤åˆ¶ç¼“å†²åŒºï¼Œå®ƒå¯ä»¥åšä¸€äº›é™åˆ¶ï¼›</li></ul></li></ul><h3 id="ä¸€æ¬¡å†…å­˜æš´å¢"><a href="#ä¸€æ¬¡å†…å­˜æš´å¢" class="headerlink" title="ä¸€æ¬¡å†…å­˜æš´å¢"></a>ä¸€æ¬¡å†…å­˜æš´å¢</h3><blockquote><p>è¿™æ˜¯ä»¥å‰é‡è§çš„é—®é¢˜</p></blockquote><p>æˆ‘ä»¬å½“æ—¶ç”¨çš„æ˜¯Redis Sentinelçš„æ¶æ„ï¼Œä¸€ä¸»ä¸€ä»ï¼Œç„¶åæœ‰å‡ ä¸ªSentinelèŠ‚ç‚¹ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è¿‡ç¨‹åšåšäº†å¾ˆå¤šç›‘æ§ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨æŸä¸€ä¸ªèŠ‚ç‚¹å‘ç°è¿™ä¸€å¯¹ä¸»ä»å‡ºç°ä¸€ä¸ªå¾ˆå¥‡æ€ªçš„é—®é¢˜ï¼šä¸»èŠ‚ç‚¹å®ƒçš„ä½¿ç”¨å†…å­˜ä½¿ç”¨äº†4GBï¼Œå·²ç»è¶…è¿‡äº†maxmemoryï¼Œå½“æ—¶ç»™maxmemoryè®¾ç½®çš„æ˜¯4GBï¼Œç„¶åæˆ‘ä»¬ä»èŠ‚ç‚¹æ˜¯æ­£å¸¸çš„ï¼Œä»èŠ‚ç‚¹æ˜¯2GBï¼Œè¿™ç§æƒ…å†µæ˜¯æ€ä¹ˆé€ æˆçš„ï¼Ÿæˆ‘ä»¬é‡åˆ°è¿™ç§é—®é¢˜çš„æ—¶å€™ä¸è¦å»ç€æ€¥ï¼Œè€Œæ˜¯å»æƒ³ä¸€ä¸‹å½“å‰å†…å­˜çš„ç»„æˆï¼Œå°±æ˜¯Redisçš„å†…å­˜ç»„æˆæ˜¯ä»€ä¹ˆï¼Ÿä½ å¯ä»¥è„‘å­é‡Œå»æƒ³ï¼ŒRediså†…å­˜æœ‰ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è‡ªèº«æ¶ˆè€—ï¼šè¿™ä¸ªå¾ˆå°æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€ç¼“å†²æ¶ˆè€—ã€æ•°æ®æ¶ˆè€—ï¼Œè¿™ä¸ªæ—¶å€™ä¼šæƒ³ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯´æ˜¯ä¸æ˜¯å› ä¸ºæˆ‘ç°åœ¨masterçš„æ•°æ®æ²¡æœ‰å¤åˆ¶åˆ°ä»èŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºè¿™æ ·çš„æƒ…å†µå¯èƒ½ä¼šå‡ºç°ä¸»èŠ‚ç‚¹çš„å†…å­˜å†™è¿›å»äº†ï¼Œä½†æ˜¯ä»èŠ‚ç‚¹æ²¡æœ‰æ”¶åˆ°é€ æˆä¸»ä»ä¸ä¸€è‡´ï¼Œ</p><p>è¿™ä¸ªæ—¶å€™è¦è€ƒè™‘åˆ°ï¼›è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ç¼“å†²ï¼šç¬¬ä¸€ä¸ªç¼“å†²â€œå¤åˆ¶ç¼“å†²åŒºâ€ï¼Œè¿™ä¸ªæˆ‘ä»¬æ˜¯åº”è¯¥è¿›è¡Œè®¾ç½®çš„ï¼Œæ¯”å¦‚è¯´100MBï¼Œè¿™ä¸ªå®ƒä¸ä¼šè¶…è¿‡100MBï¼Œæ¯”å¦‚AOFç¼“å†²åŒºé‚£æˆ‘ä»¬å¯ä»¥æ£€æµ‹ç¡¬ç›˜æ˜¯ä¸æ˜¯æ­£å¸¸çš„ï¼Œæ­£å¸¸çš„æƒ…å†µä¸‹AOFä¸ä¼šè¢«å†™æ»¡ï¼Œå½“ç„¶è¿™é‡Œå°±å¯èƒ½æ¶‰åŠåˆ°å®¢æˆ·ç«¯çš„ç¼“å†²åŒºï¼Œå¯èƒ½ä¼šæ¶‰åŠåˆ°å®¢æˆ·ç«¯çš„è¾“å…¥ï¼Œå½“ç„¶è¿™é‡Œæ²¡æœ‰è¾“å…¥çš„é—®é¢˜ï¼Œå› ä¸ºæˆ‘ä»¬çŸ¥é“å¦‚æœè¶…è¿‡1GBçš„æ—¶å€™å®ƒä¼šå°†ä½ å¹²æ‰ï¼Œå½“ç„¶ä¹Ÿä¸å­˜åœ¨è¿™ç§å¯èƒ½ï¼Œ</p><p>è¿˜æœ‰ä¸€ä¸ªå°±æ˜¯è¾“å‡ºç¼“å†²åŒºï¼šæˆ‘ä»¬è¯»ä¸»èŠ‚ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¾“å‡ºç¼“å†²åŒºå‘ç”Ÿäº†é˜»å¡ï¼Œ</p><p>è¿™äº›æƒ…å†µè€ƒè™‘äº†ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ç›¸å…³çš„æ•°æ®</p><ol><li>æ‰¹é‡å†™å…¥ï¼šçœ‹çœ‹æ˜¯ä¸æ˜¯æœ‰å¤§æ‰¹é‡çš„å†™å…¥ï¼Œå½“ç„¶æˆ‘ä»¬çœ‹çš„æ—¶å€™æ²¡æœ‰çœ‹åˆ°æœ‰å¤§æ‰¹é‡çš„å†™å…¥ï¼Œæ‰€ä»¥å¯ä»¥æ’é™¤æ•°æ®çš„ä¸ä¸€è‡´é€ æˆå†…å­˜çš„æš´å¢<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107230034782.png" srcset="/img/loading.gif" alt="image-20191107230034782"></li><li>ä¸»ä»ä¸ä¸€è‡´ï¼Ÿåœ¨ä¸»ä»èŠ‚ç‚¹ä¸Šéƒ½æ‰§è¡ŒDBSIZEï¼Œ2ä¸ªéƒ½æ˜¯ä¸€æ ·çš„<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107230112099.png" srcset="/img/loading.gif" alt="image-20191107230112099"></li><li>å¤§éƒ¨åˆ†æƒ…å†µéƒ½æ˜¯å®¢æˆ·ç«¯çš„æº¢å‡ºï¼Œæˆ‘ä»¬ç³»ç»Ÿæ¯”è¾ƒå¥½çš„æ˜¯å¯¹æ‰€æœ‰Redisæ ¸å¿ƒå‚æ•°è¿›è¡Œäº†ç›‘æ§ï¼Œæ¯”å¦‚æˆ‘ä»¬å‰é¢æåˆ°çš„<code>client_longst_output_list</code>ï¼Œå®ƒçš„æœ€å¤§è¾“å‡ºç¼“å†²åŒºçš„å¯¹åˆ—ï¼Œæˆ‘ä»¬ç»™å®ƒè®¾ç½®çš„é˜ˆå€¼æ˜¯1000ï¼Œè¿™ä¸ªæ—¶å€™å‘ç°ï¼ŒæŸæŸèŠ‚ç‚¹å·²ç»é“åˆ°äº†23W<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107230447499.png" srcset="/img/loading.gif" alt="image-20191107230447499">ï¼Œå¾ˆæ˜æ˜¾å®¢æˆ·ç«¯çš„è¾“å‡ºç¼“å†²åŒºè¿‡å¤§ï¼Œè¿™ä¸ªå€¼ç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªä¾æ®ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¹‹å‰æˆ‘ä»¬ä»‹ç»çš„<code>redis-cli list | grep -v â€œomem=0â€</code>å‘½ä»¤ï¼Œ<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107230455740.png" srcset="/img/loading.gif" alt="image-20191107230455740"><br>æœ‰è¿™ä¹ˆä¸€ä¸ªå®¢æˆ·ç«¯å®ƒçš„ollæ˜¯20Wï¼Œå½“ç„¶å®ƒå’Œ23Wä¸ä¸€æ ·æ˜¯å› ä¸ºè¿™æ˜¯ä¸€ä¸ªå®æ—¶çš„çŠ¶æ€ï¼Œå‘ç°å®ƒå†…å­˜çš„ä½¿ç”¨é‡æ˜¯éå¸¸å¤§çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒå½“æ—¶æ‰§è¡Œçš„å‘½ä»¤æ˜¯â€œmonitorâ€ï¼Œå¾ˆæ˜æ˜¾å®ƒå°±æ˜¯æœ‰ä¸€ä¸ªäººæˆ–è€…ä¸€ä¸ªç¨‹åºå»æ‰§è¡Œäº†monitorå»æ‹‰æ‰€æœ‰Redisæ‰§è¡Œçš„å‘½ä»¤ï¼Œç„¶åå®ƒæœ¬èº«åˆæ¶ˆè´¹ä¸äº†ï¼Œè€Œä¸”å½“æ—¶çœ‹åˆ°å®ƒå½“æ—¶åœ¨æœ¬æœºæ‰§è¡Œçš„ï¼Œä»»ç„¶æ˜¯æ¶ˆè´¹ä¸äº†ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å¯¹è¿™ä¸ªmonitorå‘½ä»¤æ‰§è¡Œåˆ é™¤ï¼Œè®©å†…å­˜è¿›è¡Œä¸€ä¸ªå›æ”¶ï¼Œå½“ç„¶å…¶å®è¿™é‡Œæœ‰ ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯´ä½ ç°åœ¨ä¸»èŠ‚ç‚¹å·²ç»è¶…è¿‡äº†æœ€å¤§å†…å­˜ï¼Œå¯èƒ½ä¼šäº§ç”Ÿ<code>maxmemory-policy</code>å†…å­˜æº¢å‡ºçš„æƒ…å†µ</li></ol><p>æˆ‘ä»¬æ¥å›é¡¾ä¸€ä¸‹Monitoræ¨¡å‹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191107231052717.png" srcset="/img/loading.gif" alt="image-20191107231052717"></p><p>ç°åœ¨å¯¹Redisè¿›è¡Œå†™å…¥æˆ–è€…æŸ¥æ‰¾å¾ˆå¤šä¸€äº›å‘½ä»¤ï¼Œå®ƒä¼šå°†é‚£äº›å‘½ä»¤å…¨éƒ¨å’Œåˆ°monitorçš„å®¢æˆ·ç«¯ï¼Œç„¶åå°±å°±é€ æˆmonitorè¿™ä¸ªå®¢æˆ·ç«¯å¦‚æœæ¶ˆè´¹ä¸äº†å°±ä¼šé€ æˆmonitorå®¢æˆ·ç«¯ç¼“å†²åŒºéå¸¸å¤§ï¼Œå¯¹äºRedisæ€»ä½“å†…å­˜é€ æˆå¾ˆçš„å¹²æ‰°ï¼›</p><h3 id="é¢„é˜²ç­–ç•¥"><a href="#é¢„é˜²ç­–ç•¥" class="headerlink" title="é¢„é˜²ç­–ç•¥"></a>é¢„é˜²ç­–ç•¥</h3><ol><li>æ‰¾åˆ°å¯¹åº”çš„ä¸šåŠ¡æ”¾ç›´æ¥å¹²æ‰ï¼›</li><li>é¢„é˜²ï¼š<ul><li>è¿ç»´å±‚é¢ï¼šçº¿ä¸ŠRedisç¦ç”¨monitorï¼ˆrename-commandï¼‰ï¼›</li><li>è¿ç»´å±‚é¢ï¼šé€‚åº¦é™åˆ¶ç¼“å†²åŒºå¤§å°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ™®é€šå®¢æˆ·ç«¯ç¼“å†²åŒºï¼Œé»˜è®¤æ˜¯0 0 0 ï¼Œæˆ‘ä»¬å¦‚æœå¸Œæœ›èƒ½ä¸å‡ºç°è¿™æ ·çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥ç»™å®ƒè®¾ç½®æ¯”å¦‚æœ€å¤§10Mã€100Mè¿™æ ·çš„çš„ä¸œè¥¿</li><li>å¼€å‘å±‚é¢ï¼šç†è§£monitorçš„åŸç†ï¼Œä¹Ÿå¯ä»¥çŸ­æš‚å¯»æ‰¾çƒ­ç‚¹keyï¼ˆæœ¬åœ°æ‰§è¡Œï¼‰</li><li>å¼€å‘å±‚é¢ï¼šä½¿ç”¨CacheCloudå¯ä»¥ç›´æ¥ç›‘æ§åˆ°ã€‚</li></ul></li></ol><h3 id="å…¶ä»–æ–¹æ³•"><a href="#å…¶ä»–æ–¹æ³•" class="headerlink" title="å…¶ä»–æ–¹æ³•"></a>å…¶ä»–æ–¹æ³•</h3><ol><li>ä¸è¦å¿½è§†keyé•¿åº¦ï¼š1äº¿ä¸ªé”®ï¼Œ1ä¸ªå­—èŠ‚ä¹Ÿæ˜¯èŠ‚çœï¼ˆé”®åï¼šç®€çŸ­æ˜äº†ï¼‰<pre><code>userï¼šfriendsï¼šnotifyï¼š{id}     â€”â€”&gt; uï¼šfï¼šnï¼š{id}</code></pre></li><li>åºåˆ—åŒ–å’Œå‹ç¼©æ–¹æ³•ï¼šè§£å†³javaåŸç”Ÿï¼Œé‡‡ç”¨protobufã€kryoã€snappyç­‰ã€‚</li></ol><h3 id="éœ€ä¸éœ€è¦Redisï¼Ÿ"><a href="#éœ€ä¸éœ€è¦Redisï¼Ÿ" class="headerlink" title="éœ€ä¸éœ€è¦Redisï¼Ÿ"></a>éœ€ä¸éœ€è¦Redisï¼Ÿ</h3><ol><li>æ•°æ®ï¼šå¤§æ•°æ®ã€å†·æ•°æ®ï¼šè¿™ç±»æ•°æ®ä¸é€‚åˆæ”¾Redisä¸­ï¼›</li><li>åŠŸèƒ½æ€§ï¼šå…³ç³»å‹æŸ¥è¯¢ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼šä¸å»ºè®®ç”¨Redisè¿›è¡Œå¤„ç†ï¼Œå› ä¸ºRedisæœ¬èº«ä¸æ˜¯å…³ç³»å‹æ•°æ®åº“</li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li>å†…å­˜æ˜¯å®è´µèµ„æºï¼›</li><li>ç»“åˆåœºæ™¯é€‰æ‹©å’Œä¼˜åŒ–æ•°æ®ç»“æ„ï¼›</li><li>åºåˆ—åŒ–æ˜¯æœ‰æˆæœ¬çš„ï¼›</li><li>ä¸è¦å¿½è§†é”®é•¿åº¦ã€‚</li></ol>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 13.Rediså¼€å‘èŒƒå¼</title>
    <link href="/redis-13.html"/>
    <url>/redis-13.html</url>
    
    <content type="html"><![CDATA[<h1 id="é”®å€¼è®¾è®¡"><a href="#é”®å€¼è®¾è®¡" class="headerlink" title="é”®å€¼è®¾è®¡"></a>é”®å€¼è®¾è®¡</h1><p>ä¸€ä¸ªè‰¯å¥½çš„é”®å€¼è®¾è®¡æ˜¯ä½¿ç”¨Redisçš„ä¿éšœï¼Œè¿™é‡Œæ¶‰åŠåˆ°2ä¸ªéƒ¨åˆ†</p><ul><li>Keyåè®¾è®¡ï¼šéµå®ˆä¸€äº›è§„èŒƒï¼Œåœ¨é”®å€¼å¯ç®¡ç†æ€§ã€å¯è¯»æ€§ã€é”®å€¼é•¿çŸ­çš„ç®¡ç†æ€§ä¸Šä¼šæœ‰ä¸€å®šè¦æ±‚ï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°å¾ˆå¥½çš„æ•ˆæœï¼Œæ¯”å¦‚å†…å­˜ä½¿ç”¨é‡æ¯”è¾ƒå°ï¼Œæˆ–è€…é”®å€¼çš„å¯è¯»æ€§å¯ç®¡ç†æ€§æ¯”è¾ƒé«˜ï¼›</li><li>Valueè®¾è®¡ï¼šåœ¨ä½¿ç”¨KVç¼“å­˜æˆ–è€…å¤šå­˜å‚¨çš„æ—¶å€™ï¼Œæœ€é‡è¦çš„æ˜¯valueé‡Œé¢ä¼šæœ‰å¤šç§ç±»å‹ï¼Œå®ƒå¯èƒ½ä¼šå½±å“åˆ°Redisçš„ä½¿ç”¨é‡æˆ–è€…è¯´æ˜¯ç½‘ç»œçš„ä½¿ç”¨æƒ…å†µï¼Œæˆ–è€…åƒRedisæ˜¯å¦å‘ç”Ÿé˜»å¡çš„æƒ…å†µï¼Œéƒ½ä¼šå½±å“</li></ul><h2 id="Keyåè®¾è®¡"><a href="#Keyåè®¾è®¡" class="headerlink" title="Keyåè®¾è®¡"></a>Keyåè®¾è®¡</h2><h3 id="ä¸‰å¤§å»ºè®®"><a href="#ä¸‰å¤§å»ºè®®" class="headerlink" title="ä¸‰å¤§å»ºè®®"></a>ä¸‰å¤§å»ºè®®</h3><ul><li>å¯è¯»æ€§å’Œå¯ç®¡ç†æ€§ï¼šå¯è¯»æ€§ï¼Œé€šè¿‡ä¸€ä¸ªkeyçš„åå­—èƒ½äº†è§£å®ƒæ˜¯ä»€ä¹ˆæ„æ€ï¼›å¯ç®¡ç†æ€§ï¼šåˆ é™¤æŸäº›å‘½åå¼€å¤´æ‰€æœ‰çš„key,æŒ‰ç…§è¿™ç§è§„åˆ™ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸Œæœ›ä»¥Aå¼€å¤´çš„è¿™ç§keyåšä»€ä¹ˆäº‹æƒ…ï¼Œå¯ä»¥è¾¾åˆ°ä¸€ä¸ªå¯ç®¡ç†çš„æ°´å¹³ï¼›ä»¥ä¸šåŠ¡åï¼ˆæˆ–æ•°æ®åº“åï¼‰ä¸ºå‰ç¼€ï¼ˆé˜²æ­¢keyï¼‰å†²çªï¼Œç”¨å†’å·åˆ†å‰²ï¼Œæ¯”å¦‚ä¸šåŠ¡å:è¡¨å:idï¼Œå¦‚:<code>ugcï¼švideoï¼š1</code>ï¼›</li><li>ç®€æ´æ€§ï¼šä¿è¯è¯­ä¹‰çš„å‰æä¸‹ï¼Œæ§åˆ¶keyçš„é•¿åº¦ï¼Œå½“keyè¾ƒå¤šæ—¶ï¼Œå†…å­˜å ç”¨ä¹Ÿä¸å®¹å¿½è§†ï¼ˆredis3ï¼š39å­—èŠ‚<code>embstr</code>ï¼‰ï¼Œå¦‚ï¼š<code>userï¼š{uid}:friendsï¼šmessagesï¼š{mid}</code>ç®€åŒ–ä¸º<code>uï¼š{uid}:frï¼šmï¼š{mid}</code>ï¼Œè¿™é‡Œè¯´çš„redis3ï¼Œ39å­—èŠ‚æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿåœ¨Redis3è¿™ä¸ªç‰ˆæœ¬é‡Œæœ‰3ç§è¡¨è¾¾å­—ç¬¦ä¸²çš„å†…éƒ¨ç¼–ç ï¼Œä¸€ç§æ˜¯åŸç”Ÿçš„ã€intçš„ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯<code>embstr</code>ï¼Œåœ¨ä½¿ç”¨<code>embstr</code>è¿™ç§æƒ…å†µä¸‹å®ƒä¼šå¯¹å†…å­˜é€ æˆå¾ˆå¤§çš„èŠ‚çœï¼›</li><li>ä¸è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼šåä¾‹ï¼šåŒ…å«ç©ºæ ¼ã€æ¢è¡Œã€å•åŒå¼•å·ä»¥åŠå…¶ä»–è½¬ä¹‰å­—ç¬¦ã€‚</li></ul><h3 id="embstr"><a href="#embstr" class="headerlink" title="embstr"></a>embstr</h3><p>ç¡®å®šè‡ªå·±çš„Redisç‰ˆæœ¬æ˜¯3</p><pre><code class="hljs bash">127.0.0.1:6379&gt; info server<span class="hljs-comment"># Server</span>redis_version:3.0.7</code></pre><p>æŸ¥çœ‹å†…éƒ¨ç¼–ç </p><pre><code class="hljs bash">127.0.0.1:6379&gt;  <span class="hljs-built_in">set</span> k1 v1 OK127.0.0.1:6379&gt; object encoding k1<span class="hljs-string">"embstr"</span>127.0.0.1:6379&gt; incr counter (<span class="hljs-built_in">integer</span>) 1127.0.0.1:6379&gt; object encoding counter<span class="hljs-string">"int"</span>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> a sadlfasdhfasdklfhsadfOK127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> a sadlfasdhfasdklfhsadfasdfasdfasdfasfdasfdasdfOK127.0.0.1:6379&gt; object encoding a<span class="hljs-string">"raw"</span></code></pre><p>å¯¹äºRedisæ¥è¯´å®ƒçš„å®ƒå¯¹å¤–æœ‰5ç§æ•°æ®ç»“æ„ä½†æ˜¯æ¯ä¸€ç§æ•°æ®ç»“æ„åˆæœ‰è‡ªå·±çš„å†…éƒ¨ç¼–ç ï¼Œå¯¹äºå¤–éƒ¨çš„è¯ï¼Œå®ƒå®é™…ä¸Šæ˜¯ä¸€ä¸ªstring</p><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> k1string127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> astring127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> counterstring</code></pre><blockquote><p>é‚£ä¹ˆå®ƒå†…éƒ¨çš„è§„åˆ™æ˜¯ä»€ä¹ˆï¼Ÿä¸ç„¶åƒcounterè¿™ç§è‡ªå¢çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ•´æ•°çš„è¯å®ƒä¼šç”¨intè¿›è¡Œå­˜å‚¨ï¼Œä¸€äº›çŸ­å­—ç¬¦ä¸²åƒk1å®ƒä½äº39ä¸ªå­—èŠ‚çš„å­—ç¬¦ä¸²å®ƒä¼šä½¿ç”¨embstrï¼Œå¤§äº39å­—èŠ‚çš„ä½¿ç”¨rowï¼Œembstrçš„ä¼˜åŒ–ï¼šRedisåœ¨åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œé™¤äº†ç»™Redisçš„å¯¹è±¡åšä¸€ä¸ªåˆ†é…è¿ç®—ï¼Œè¿˜è¦ç»™å…·ä½“çš„ä¸€ä¸ªå†…å®¹åšä¸€ä¸ªåˆ†é…ï¼Œå¯¹äºembstrçš„è¯å®ƒæ˜¯å°†Redis Objectä»¥åŠå­—ç¬¦ä¸²çš„ç±»å®¹æ˜¯æ”¾åˆ°ä¸€æ¬¡åˆ†é…å½“ä¸­ï¼Œè€Œä¸”æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜ï¼Œè¿™æ ·çš„è¯å¯ä»¥èŠ‚çœåˆ†é…å†…å­˜çš„æ¬¡æ•°ï¼Œè€Œä¸”å¯ä»¥èŠ‚çœä¸€å®šçš„ç©ºé—´ï¼Œå¯¹äºå°äº39å­—èŠ‚çš„è¯ï¼Œå®ƒä¼šç”¨embstrè¿›è¡Œå­˜å‚¨ï¼Œè¿™æ ·å¯ä»¥å‡å°‘ä¸€å®šçš„å†…å­˜å¼€é”€</p></blockquote><p>ç°åœ¨åšä¸€ä¸ªä¾‹å­</p><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> hello  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa<span class="hljs-comment">#39å­—èŠ‚</span>OK127.0.0.1:6379&gt; object encoding hello<span class="hljs-string">"embstr"</span>127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> hello1  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa <span class="hljs-comment">#40å­—èŠ‚</span>OK127.0.0.1:6379&gt; object encoding hello1<span class="hljs-string">"raw"</span></code></pre><p>ä»è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœåœ¨è®¾è®¡keyçš„æ—¶å€™ï¼ŒæŠŠkeyæ§åˆ¶åœ¨ä¸€å®šé•¿åº¦çš„å†…ï¼Œè¿™æ ·å¯ä»¥è¾¾åˆ°å†…å­˜èŠ‚çœçš„ä¸€å®šæ•ˆæœï¼Œåœ¨Redis4ä¸­å®ƒåšäº†ä¸€äº›æ”¹å˜ï¼Œå› ä¸ºå®ƒä¼šJediså†…éƒ¨çš„ä¸€ä¸ªå­—ç¬¦ä¸²å®ç°åšäº†ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™å®ƒåªè¦å°äº44ä¸ªå­—èŠ‚å°±å¥½äº†ï¼Œä½†æ˜¯åœ¨Redis3ä¸­æ˜¯è¦å°äº39ä¸ªå­—èŠ‚çš„</p><p>Redis3 embstræµ‹è¯•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104200407985.png" srcset="/img/loading.gif" alt="image-20191104200407985"></p><h2 id="Valueè®¾è®¡"><a href="#Valueè®¾è®¡" class="headerlink" title="Valueè®¾è®¡"></a>Valueè®¾è®¡</h2><h3 id="æ‹’ç»bigkey"><a href="#æ‹’ç»bigkey" class="headerlink" title="æ‹’ç»bigkey"></a>æ‹’ç»bigkey</h3><p>å®šä¹‰</p><ul><li>stringç±»å‹æ§åˆ¶åœ¨10KBä»¥å†…ï¼Œè¶…è¿‡äº†å°±ç®—æ˜¯bigkeyï¼›</li><li>hashã€listã€setã€zsetå…ƒç´ ä¸ªæ•°ä¸è¦è¶…è¿‡5000ï¼Œå¦‚æœè¶…è¿‡äº†è®¤ä¸ºæ˜¯bigkeyï¼Œbigkeyæ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„keyçš„valueæ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ³¨æ„è¿™é‡Œæˆ‘ä»¬çš„å®šä¹‰å¹¶ä¸æ˜¯è¯´æœ‰ä¸€ä¸ªå›½é™…æ ‡å‡†ã€å®˜æ–¹è®¤è¯ï¼Œè€Œæ˜¯æˆ‘ä»¬å¸Œæœ›ä½ çš„Redisä¸­çš„valueè¦å°½é‡å°ï¼Œvalueå°çš„è¯ä¼šæœ‰ä¸€å®šå¥½å¤„ï¼Œå¦‚æœä½ çš„valueè¿‡å¤§ä¼šæœ‰å¾ˆå¤šå¾ˆå¤šé—®é¢˜ï¼Œè¿™äº›é—®é¢˜ç•™ç€åé¢å†å°†ï¼Œè¿™äº›æ ‡å‡†æ˜¯é˜¿é‡Œäº‘å‘å¸ƒçš„æ ‡æ³¨ï¼Œå¯¹äºè¿ç»´äººå‘˜æ¥è¯´å…¶å®è¿™æ ·ä¸€ä¸ªæ ‡å‡†å¯ä»¥ä¿è¯æˆ‘ä»¬Redisçš„ä¸€ä¸ªè¿ç»´æ˜¯å¯ä»¥è¶³å¤Ÿé¡ºç•…çš„ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸€ä¸ªRediså®ä¾‹éå¸¸å¤šï¼Œå¯èƒ½éƒ½æ˜¯å•æœºæ··éƒ¨çš„æƒ…å†µå¯¹äºè¿ç»´äººå‘˜æ¥è¯´ä½ æœ‰ä¸€ä¸ªè¿™æ ·çš„æ ‡å‡†å¯¹äºè¿ç»´æ¥è¯´å¯ä»¥æœ‰å¾ˆå¤§çš„å¸®åŠ©ï¼Œå¯¹äºå¼€å‘äººå‘˜æ¥è¯´ä½ è¦ä¸¥æ ¼è¦æ±‚è‡ªå·±ä¸å»è¶Šè¿‡è¿™ä¸ªçº¢çº¿ï¼Œå…¶å®å¯¹äºkeyå®šä¹‰æ¯ä¸ªå…¬å¸éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯”å¦‚å¯ä»¥å®šä¹‰1KBä¸€ä¸‹çš„ç”šè‡³100KBä»¥ä¸‹çš„éƒ½å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆç†çš„æ ‡å‡†ï¼Œè¿™ä¸ªæ˜¯æŒ‰ç…§ä¸åŒå…¬å¸è¦æ±‚æ¥çœ‹çš„ï¼›<ul><li>åä¾‹ï¼šä¸€ä¸ªåŒ…å«å‡ ç™¾ä¸‡å…ƒç´ çš„listã€hashç­‰ï¼Œä¸€ä¸ªå·¨å¤§çš„josnå­—ç¬¦ä¸²ï¼›</li></ul></li></ul><h3 id="bigkeyçš„å±å®³"><a href="#bigkeyçš„å±å®³" class="headerlink" title="bigkeyçš„å±å®³"></a>bigkeyçš„å±å®³</h3><h4 id="ç½‘ç»œé˜»å¡"><a href="#ç½‘ç»œé˜»å¡" class="headerlink" title="ç½‘ç»œé˜»å¡"></a>ç½‘ç»œé˜»å¡</h4><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104202723564.png" srcset="/img/loading.gif" alt="image-20191104202723564"></p><p>æˆ‘çš„ä¸€ä¸ªæœºå™¨å¯èƒ½ç°åœ¨éƒ¨äº†å¾ˆå¤šRedisï¼Œå› ä¸ºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæ— è®ºæ˜¯ä¸€äº›äº‘å‚å•†æˆ–è€…ä¸€äº›å…¬å¸å®é™…ä¸Šéƒ½æ˜¯åœ¨å•æœºéƒ¨ç½²å¤šä¸ªRediså®ä¾‹ï¼Œç”±äºä½¿ç”¨Redisï¼Œå¯èƒ½ä¼šæœ‰ä¸€äº›åƒå…†ç½‘å¡ï¼Œè¯´æ˜¯åƒå…†ç½‘å¡ï¼Œå®é™…ä¸Šå®ƒè¦é™¤ä»¥8ï¼Œå¯¹åº”çš„128MBå­—èŠ‚ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœæˆ‘ä»¬Rediså­˜åœ¨äº†bigkeyï¼Œæ¯”å¦‚æˆ‘çš„Redisé‡Œæœ‰ä¸€ä¸ªkeyæ˜¯5MBï¼Œæ„å‘³ç€æˆ‘è¿™ä¸ªkeyçš„QPSè¾¾åˆ°äº†30ï¼Œå®ƒå°±ä¼šç¬é—´è¶…è¿‡æœ€å¤§çš„å¸¦å®½ï¼Œé‚£ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿå®ƒä¼šå°†å½“å‰Redisé˜»å¡æ‰ï¼Œå› ä¸ºæˆ‘ä»¬å»å…±äº«ä¸€ä»½æœºå™¨æ€»å…±çš„å¸¦å®½çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå•æœºå¤šéƒ¨ç½²çš„è¯é‚£ä½ ä¼šå½±å“å…¶ä»–Rediså¸¦å®½ï¼Œè¿™ä¹ˆå°çš„ä¸€ä¸ªQPSç”±äºä½ è¿™ä¹ˆä¸€ä¸ªbigkeyæˆ–è€…å¤§å¯¹è±¡çš„å­˜åœ¨ï¼Œå®ƒä¼šå°†Redisé˜»å¡è€Œå½±å“å…¶ä»–Redisï¼Œé‚£å°±æ„å‘³ç€å½±å“å¾ˆå¤šä¸šåŠ¡ï¼Œå°±è¿™ä¹ˆå°çš„ä¸œè¥¿å¯èƒ½ä¼šæœ‰è‡´å‘½çš„ç¾éš¾ï¼Œå‡å¦‚æˆ‘ä»¬ä¸€ä¸ªkeyæ˜¯10KBï¼Œå¯¹äºä¸€äº›çƒ­ç‚¹keyï¼Œåƒæ–°æµªå¾®åšå‘å¸ƒçš„ä¸€äº›é‡è¦æ¶ˆæ¯ã€ä¸€äº›æ˜æ˜Ÿå‘å¸ƒçš„é‡è¦æ¶ˆæ¯ï¼Œå‡å¦‚ä½ çš„keyåªæœ‰1KB,é‚£æ¯”å¦‚è¯´QPSéå¸¸é«˜ï¼Œè¾¾åˆ°äº†1åƒã€1ä¸‡ã€10ä¸‡ã€100ä¸‡è¿™æ ·çš„çº§åˆ«å¯èƒ½å±å®³å°±æ›´å¤§äº†ï¼Œä¸€ç¬é—´å°†ä½ æœºå™¨å¸¦å®½åƒæ»¡ï¼Œå½±å“å…¶ä»–ä¸šåŠ¡ï¼Œå½±å“è‡ªå·±ï¼Œè¿™ä¸ªå±å®³æ˜¯éå¸¸å¤§çš„ï¼›</p><h4 id="æ…¢æŸ¥è¯¢"><a href="#æ…¢æŸ¥è¯¢" class="headerlink" title="æ…¢æŸ¥è¯¢"></a>æ…¢æŸ¥è¯¢</h4><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104202708182.png" srcset="/img/loading.gif" alt="image-20191104202708182"></p><p>hgetallã€lrangeã€zrangeï¼ˆä¾‹å¦‚å‡ åä¸‡ï¼‰ï¼šå®ƒåœ¨åšä¸€äº›å…¨é‡æ“ä½œçš„æ—¶å€™å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œå®ƒé™¤äº†è¯´è¿™ä¸ªç½‘ç»œæµé‡æ¯”è¾ƒå¤§ï¼Œå®ƒè¿˜æœ‰å°±æ˜¯æ¯”è¾ƒæ…¢ï¼ŒRedisæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„è®¾è®¡æ¨¡å¼ï¼Œä½ è¿™ä¸€ä¸ªbigkeyçš„å‘½ä»¤å¯èƒ½ä¼šé˜»å¡å…¶ä»–å‘½ä»¤ï¼Œå› ä¸ºä½ çš„hgetallå‡ ç™¾ä¸‡ä¸ªå…ƒç´ ä¸Šå»æ‰§è¡Œï¼Œå®ƒçš„é€Ÿåº¦æ˜¯éå¸¸æ…¢çš„ï¼Œæˆ‘ä»¬è¿™é‡Œä¸è€ƒè™‘å®ƒçš„ä¸€ä¸ªç½‘ç»œé˜»å¡çš„é—®é¢˜ï¼Œåªå•çº¯å»çœ‹å‘½ä»¤çš„é—®é¢˜å®ƒä¹Ÿæ˜¯éå¸¸æ…¢çš„ï¼Œæ„å¤–ç€å¦‚æœæˆ‘ä»¬QPSéå¸¸é«˜ï¼Œæ¯”å¦‚QPSæ˜¯3ä¸‡ï¼Œç„¶åæˆ‘è¿™ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œäº†2ç§’ï¼Œé‚£å°±æ„å‘³ç€ä½ è¿™1ç§’çš„3ä¸‡ä¸ªå‘½ä»¤å…¨éƒ½ä¼šè¢«é˜»å¡æ‰ï¼›</p><h4 id="èŠ‚ç‚¹æ•°æ®ä¸å‡è¡¡"><a href="#èŠ‚ç‚¹æ•°æ®ä¸å‡è¡¡" class="headerlink" title="èŠ‚ç‚¹æ•°æ®ä¸å‡è¡¡"></a>èŠ‚ç‚¹æ•°æ®ä¸å‡è¡¡</h4><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104202818862.png" srcset="/img/loading.gif" alt="image-20191104202818862"></p><p>å¯¹äºä¸€äº›ä½¿ç”¨RedisClusteré›†ç¾¤è¿™ç§åˆ†å¸ƒå¼çš„å½¢å¼ï¼Œå¦‚æœä½ çš„æ•°æ®ç›¸å½“äºåˆ†é…åˆ°å¤šä¸ªRedisèŠ‚ç‚¹ä¸Šï¼Œå› ä¸ºæˆ‘ä»¬çš„keyåªèƒ½è½åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œé‚£å¦‚æœå­˜åœ¨bigkeyçš„æƒ…å†µä¸‹ï¼Œé‚£å¯èƒ½ä¼šå‡ºç°åƒå›¾ä¸­è¿™ç§ï¼Œå„å„èŠ‚ç‚¹çš„å¯¹è±¡æ•°å·®ä¸å¤šï¼Œä½†æ˜¯å®ƒçš„å†…å­˜ä½¿ç”¨é‡æ˜¯ä¸ä¸€æ ·çš„ï¼Œæœ‰ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å­˜å®ƒçš„ä½¿ç”¨é‡æ˜æ˜¾ä¼šå¤§äºå…¶ä»–èŠ‚ç‚¹ï¼Œå¯¹äºæˆ‘ä»¬ç®¡ç†Redisé›†ç¾¤æ¥è¯´æ˜¯éå¸¸ä¸æ–¹ä¾¿çš„ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ç®¡ç†çš„æ—¶å€™å¸Œæœ›ç”¨ä¸€ä¸ªé€šç”¨çš„æ¨¡å¼ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬éœ€è¦64GBçš„å†…å­˜ï¼Œå¯èƒ½å°±æ˜¯8x8çš„èŠ‚ç‚¹ï¼Œç”šè‡³16x4èŠ‚ç‚¹çš„åˆ†é…ï¼Œè¿™æ ·ä¼šå¯¹æˆ‘ä»¬çš„ç®¡ç†é€ æˆå½±å“</p><h4 id="ååºåˆ—åŒ–æ¶ˆè€—"><a href="#ååºåˆ—åŒ–æ¶ˆè€—" class="headerlink" title="ååºåˆ—åŒ–æ¶ˆè€—"></a>ååºåˆ—åŒ–æ¶ˆè€—</h4><p>è¿™æ˜¯ä¸€ä¸ªä¸æ˜¯å¾ˆå¸¸è§çš„é—®é¢˜</p><ol><li>Rediså®¢æˆ·ç«¯æœ¬èº«ä¸è´Ÿè´£åºåˆ—åŒ–ï¼›</li><li>åº”ç”¨é¢‘ç¹åºåˆ—åŒ–å’Œååºåˆ—bigkeyï¼šæœ¬åœ°ç¼“å­˜æˆ–Redisç¼“å­˜ã€‚</li></ol><p>Rediså®¢æˆ·ç«¯ä¸åšåºåˆ—åŒ–å’Œååºåˆ—å·¥ä½œçš„ï¼ŒJediså°±æ²¡æœ‰æä¾›è¿™æ ·çš„åŠŸèƒ½ï¼Œå®ƒåœ¨ä½ å¼€å‘çš„æ—¶å€™éœ€è¦ä¼ å…¥çš„æ˜¯å­—èŠ‚æ•°ç»„ï¼Œå¦‚æœæˆ‘ä»¬è¦åšåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ¯”å¦‚åšä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„åºåˆ—åŒ–ã€ååºåˆ—åŒ–çš„å¯¹è±¡ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦æ“ä½œå»æ“ä½œè¿™ä¸ªbigkeyï¼Œå‡å¦‚è¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„å¯¹è±¡å°±æ„å‘³ç€è¦æ¶ˆè€—å¾ˆå¤šCPUï¼Œå‡å¦‚ä½ çš„QPSéå¸¸é«˜ï¼Œåœ¨æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šéå¸¸é«˜æ¶ˆè€—å¾ˆå¤šCPUï¼Œä¸‹é¢è¿™å¼ å›¾å°±æ˜¯æˆ‘ä»¬ä¹‹å‰çº¿ä¸Šä¸šåŠ¡å‘ç°çš„bigkeyï¼Œå®ƒé¢‘ç¹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œä¼šé€ æˆJavaè¿™æ ·çš„åº”ç”¨çš„è¿›ç¨‹CPUéå¸¸éå¸¸é«˜ï¼Œæœ€ç»ˆé€šè¿‡ä¸€äº›æ‰‹æ®µå»å¯¹ä½è¿™æ ·çš„é—®é¢˜ï¼ŒRedis bigkeyæœ‰å¾ˆå¤šå¾ˆå¤šé—®é¢˜ï¼Œå¦‚æœä½ è®¾è®¡çš„ä¸å¥½ï¼Œå¯èƒ½ä¼šé€ æˆè‹¥å¹²ä¸ªè¿™æ ·çš„æƒ…å†µï¼›</p><h1 id="bigkeyå‘ç°"><a href="#bigkeyå‘ç°" class="headerlink" title="bigkeyå‘ç°"></a>bigkeyå‘ç°</h1><ul><li><p>åº”ç”¨å¼‚å¸¸ï¼šä¸€äº›è¶…æ—¶ï¼Œè¿™ä¸ªä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œä½†å®ƒä¹Ÿæ˜¯ç¬¬ä¸€ä¸ªæœ‰å…³çš„åŸå› ï¼›</p></li><li><p>redis-cli â€“bigkeysï¼šRediså®˜æ–¹æä¾›çš„å·¥å…·ï¼›</p></li><li><p>scan+debug objectï¼š å¦‚æœä¸Šé¢å·¥å…·æ²¡æœ‰è¾¾åˆ°è¦æ±‚ï¼Œæ¯”å¦‚ä¸€äº›å®šåˆ¶åŒ–çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å»å®ç°ï¼Œæ¯”å¦‚ä½¿ç”¨scan+debug object</p></li><li><p>ä¸»åŠ¨æŠ¥è­¦ï¼šç½‘ç»œæµé‡ç›‘æ§ã€å®¢æˆ·ç«¯ç›‘æ§<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104204606546.png" srcset="/img/loading.gif" alt="image-20191104204606546"></p></li><li><p>å†…æ ¸çƒ­ç‚¹Keyé—®é¢˜ä¼˜åŒ–<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104204833399.png" srcset="/img/loading.gif" alt="image-20191104204833399"></p></li></ul><h2 id="åº”ç”¨æ–¹å‘ç°"><a href="#åº”ç”¨æ–¹å‘ç°" class="headerlink" title="åº”ç”¨æ–¹å‘ç°"></a>åº”ç”¨æ–¹å‘ç°</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104204144087-1572871319822-1572871749637.png" srcset="/img/loading.gif" alt="image-20191104204144087"></p><h2 id="redis-cli-â€“bigkeys"><a href="#redis-cli-â€“bigkeys" class="headerlink" title="redis-cli â€“bigkeys"></a>redis-cli â€“bigkeys</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104204214452-1572871773909.png" srcset="/img/loading.gif" alt="image-20191104204214452"></p><blockquote><p>ä½†æ˜¯å®ƒè¿™é‡Œä¸èƒ½è®¾å®šå¤šå¤§æ˜¯bigkeyï¼Œè¿™è¡Œè¿™ä¸ªå‘½ä»¤çš„æ—¶å€™å»ºè®®åœ¨slaveèŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œå› ä¸ºå®ƒæœ¬èº«æ˜¯å»åšä¸€äº›æ‰«æå’Œä¸€äº›è®¡ç®—çš„ï¼Œæœ€å¥½æ˜¯åœ¨æœ¬åœ°æ‰§è¡Œï¼Œè¿™æ ·æ‰§è¡Œé€Ÿåº¦ä¼šå¾ˆå¿«ï¼Œç”¨ç½‘ç»œä¸€å°æœºå™¨æ‰«æå¦ä¸€å°æœºå™¨çš„è¯ä»ç„¶æ˜¯éœ€è¦æ¶ˆè€—å¾ˆå¤šæ—¶é—´çš„</p></blockquote><h2 id="scan-debug-object"><a href="#scan-debug-object" class="headerlink" title="scan + debug object"></a>scan + debug object</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104204541652-1572872169550.png" srcset="/img/loading.gif" alt="image-20191104204541652"></p><p>å¯¹äºä¸Šé¢å›¾ä¸­çš„æ¼”ç¤ºï¼Œæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯´æˆ‘ä»¬æ— æ³•å®šä¹‰æ¯”å¦‚1KBä»¥ä¸Šçš„æ˜¯bigkeyè¿˜æ˜¯10KBä»¥ä¸Šbigkeyï¼Œè¿˜æœ‰å®ƒçš„å…ƒç´ ä¸ªæ•°å¤šå¤§çš„bigkeyï¼Œå®ƒæ˜¯æ²¡æ³•å®šä¹‰çš„ï¼Œè¿™é‡Œå°±å¯ä»¥ä½¿ç”¨ä¸€äº›Rediså‘½ä»¤æ¥å®ç°</p><h2 id="ä¸»åŠ¨æŠ¥è­¦"><a href="#ä¸»åŠ¨æŠ¥è­¦" class="headerlink" title="ä¸»åŠ¨æŠ¥è­¦"></a>ä¸»åŠ¨æŠ¥è­¦</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104205633736.png" srcset="/img/loading.gif" alt="image-20191104205633736"></p><p>å¯¹Redisæ‰€æœ‰çš„infoä¿¡æ¯åšä¸€ä¸ªæ”¶é›†ï¼Œæ¯”å¦‚ä¸€åˆ†é’Ÿæ”¶é›†ä¸€æ¬¡ã€ç§’çº§ç›‘æ§ç„¶åå­˜åœ¨åˆ°æˆ‘ä»¬å¯¹åº”çš„ä½ç½®ï¼Œæˆ–è€…ç›´æ¥å®æ—¶åšä¸€ä¸ªç›‘æ§ï¼Œå½“å®ƒè¶…å‡ºæˆ‘ä»¬çš„é¢„æœŸï¼Œæ¯”å¦‚è¯´åƒè¾“å‡ºæµé‡è¶…å‡ºæˆ‘ä»¬çš„é¢„æœŸäº†ï¼Œå°±ä¼šå¯èƒ½å‡ºç°ç±»ä¼¼bigkeyæµé‡çš„é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥å»é‡ç‚¹å…³æ³¨ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬æ‰‹é‡Œçš„è¯æ®è¶Šå¤šï¼Œé‚£æˆ‘ä»¬å‘ç°é—®é¢˜å°±æ›´å¿«ï¼Œå› ä¸ºæˆ‘ä»¬å‘ç°æœ‰äº›äººè§£å†³é—®é¢˜æ¯”è¾ƒå¿«ï¼Œå½“ç„¶å®ƒçš„ç†è®ºçŸ¥è¯†å¾ˆå¼ºï¼Œä¹Ÿå¯èƒ½æ˜¯å› ä¸ºä»–æ‰‹é‡Œæœ‰æ›´å¤šçš„è¯æ®æˆ–è€…å®ƒæœ‰æ›´å¥½çš„å·¥å…·</p><h2 id="å†…æ ¸ç»Ÿè®¡"><a href="#å†…æ ¸ç»Ÿè®¡" class="headerlink" title="å†…æ ¸ç»Ÿè®¡"></a>å†…æ ¸ç»Ÿè®¡</h2><p>è¿™ä¸ªå¯èƒ½ä¼šæ¶‰åŠæ›´åŠ æ·±ä¸€ç‚¹ï¼Œå…¶å®åŸç†å¾ˆç®€å•ï¼Œåœ¨Rediså†…éƒ¨å»è®¾ç½®ä¸€ä¸ªç±»ä¼¼äºå †çš„æ¦‚å¿µï¼Œé€šè¿‡å®ƒå»å®Œæˆtop keyçš„é—®é¢˜ï¼Œæœ€å¤§çš„10å¤š20ä¸ªï¼Œæˆ‘ä»¬å¯ä»¥è®¾ç½®è¿™æ ·çš„å‚æ•°ï¼Œæ¯æ¬¡å½“æœ‰keyå˜æ›´çš„æ—¶å€™æˆ‘ä»¬å»ç»´æŠ¤è¿™ä¸ªå †ï¼Œè¿™æ ·æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰¾åˆ°é‚£äº›bigkeyï¼Œå®ƒæœ‰ä¸€ä¸ªä¼˜åŠ¿ï¼šæˆ‘ä»¬å‰é¢é€šè¿‡æ‰«æå®ƒçš„è¿‡ç¨‹æ¯”è¾ƒæ…¢ï¼Œå› ä¸ºæˆ‘ä»¬æ¯æ¬¡éƒ½è¦å»æ‰«æï¼Œç„¶åæ‹¿ä¸€ä¸ªç»“æœï¼Œéå¸¸éå¸¸æ…¢ï¼Œå¦‚æœæœ‰å‡ äº¿ä¸ªkeyå°±ä¸ç”¨è¯´å¿«äº†ï¼Œå®ƒè¾¾ä¸åˆ°ä¸€ä¸ªæ•ˆæœå°±æ˜¯è¯´æˆ‘ä»¬åœ¨å¯¹æ‰€æœ‰Redisè¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œæ¯”å¦‚ç°åœ¨æœ‰ä¸€ä¸‡ä¸ªRedisèŠ‚ç‚¹ï¼Œæˆ‘å¸Œæœ›æ¯å°æ—¶å»æ‹¿åˆ°bigkeyçš„ä¿¡æ¯ï¼ŒåŸºæœ¬ä¸Šå¯¹äºè¿™ç§æƒ…å†µæ˜¯æ— æ³•å®Œæˆçš„ï¼Œå› ä¸ºæ¯æ¬¡ä»»åŠ¡å°±éå¸¸é•¿è€Œä¸”Rediså®ä¾‹éå¸¸å¤šï¼Œè¿™ä¸ªä½ åšä¸€ä¸ªè°ƒåº¦ç³»ç»Ÿä¹Ÿå¾ˆéš¾å»å®Œæˆè¿™æ ·çš„ä»»åŠ¡ï¼Œé‚£å‡å¦‚è¯´æˆ‘Rediså†…éƒ¨å°±å¯ä»¥åå‡ºè¿™æ ·çš„ä¿¡æ¯ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½åšå¾ˆå¤æ‚çš„è®¡ç®—ï¼Œè¿™æ ·ä¼šæœ‰å¾ˆå¥½çš„ä¼˜åŠ¿ï¼Œå½“ç„¶è¿™å¯¹Redisæœ¬èº«çš„ç»´æŠ¤æˆæœ¬ä¼šé«˜ä¸€äº›ï¼Œå› ä¸ºä½ éœ€è¦å¯¹Redisæºç è¿›è¡Œä¿®æ”¹ï¼Œè¿™é‡Œä¼šæ¶‰åŠåˆ°å¾ˆå¤šé—®é¢˜ï¼Œä¸€ä¸ªæ˜¯ä½ ä¿®æ”¹çš„é ä¸é è°±ï¼Œå¦ä¸€ä¸ªå°±æ˜¯è¯´ä½ æ›´å®˜æ–¹çš„æ¯•ç«Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™æ ·åœ¨åæœŸç»´æŠ¤ä¸Šä¼šæœ‰ä¸€äº›é—®é¢˜ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬ç®¡ç†çš„Redisæ¯”è¾ƒå¤šå¦‚æœä½ åªç®¡ä¸€ä¸ªRedisé‚£ä½ å¯ä»¥è¿›è¡Œä¿®æ”¹ï¼Œå¯èƒ½ç®¡ç†ä¸€ä¸‡ä¸ªã€1åƒä¸ªå¯èƒ½ä½ ä¸€ä¸ªå°çš„æ”¹åŠ¨ã€ä¸€ä¸ªå°çš„é”™è¯¯ä¼šå½±å“å¤§éƒ¨åˆ†çš„ä¸šåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™ä½ è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼Œè¦ä¸è¦åšé‚£æ ·çš„äº‹æƒ… </p><h1 id="bigkeyåˆ é™¤"><a href="#bigkeyåˆ é™¤" class="headerlink" title="bigkeyåˆ é™¤"></a>bigkeyåˆ é™¤</h1><h2 id="é˜»å¡"><a href="#é˜»å¡" class="headerlink" title="é˜»å¡"></a>é˜»å¡</h2><blockquote><p>æ³¨æ„éšæ€§åˆ é™¤ï¼ˆè¿‡æœŸã€renameç­‰ï¼‰</p></blockquote><p>å‰é¢äº†è§£äº†bigkeyçš„å±å®³ä»¥åŠå¦‚ä½•å»å‘ç°å®ƒï¼Œå½“æˆ‘ä»¬ç¡®å®šè¦å¯¹bigkeyè¿›è¡Œåˆ é™¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦åšå¾ˆå¤šçš„æ“ä½œï¼Œæœ‰äººè¯´ç›´æ¥å°†å®ƒdelæ‰å°±å¯ä»¥äº†ï¼Œå› ä¸ºRedisä¸­æ‰€æœ‰çš„kvåˆ é™¤å‘½ä»¤éƒ½æ˜¯delæ“ä½œï¼Œä½†å…¶å®è¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå½“ä½ çš„bigkeyéå¸¸å¤§çš„æ—¶å€™å®ƒçš„åˆ é™¤é€Ÿåº¦ä¼šéå¸¸æ…¢ï¼Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104220646084.png" srcset="/img/loading.gif" alt="image-20191104220646084"></p><p>ä¸Šé¢è¿™å¼ è¡¨æ˜¯é€šè¿‡æµ‹è¯•å¾—å‡ºæ¥çš„ç»“è®ºï¼Œè¿™é‡Œä»¥ä¸€ä¸ªä¾‹å­æ¥è¯´ï¼Œå‡å¦‚è¦åˆ é™¤çš„ç±»å‹æ˜¯hahsï¼Œç°åœ¨æœ‰100ä¸‡ä¸ªfieldå’Œvalueï¼Œæ¯ä¸€ä¸ªfieldå’Œvalueæ˜¯128å­—èŠ‚è¿™å…¶å®å¯¹åº”å›¾ä¸­ï¼Œå°±æ˜¯è¯´åˆ é™¤è¿™ä¸€ä¸ªhashï¼Œå¯èƒ½éœ€è¦2000æ¯«ç§’ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢å‘¢ï¼Ÿå› ä¸ºå®ƒçš„åˆ é™¤è¦å°†fieldå’Œvalueä¸€ä¸ªä¸ªè¿›è¡Œåˆ é™¤çš„ï¼Œå…¶å®Redisä¸­hashå¯ä»¥æ˜¯hashtableã€ziplistï¼Œä½†æ˜¯å®ƒå…ƒç´ éå¸¸å¤šçš„æ—¶å€™è‚¯å®šæ˜¯hashtableï¼Œå®é™…ä¸Šå’Œæˆ‘ä»¬åˆ é™¤Redisæ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºRedisæœ¬èº«å°±æ˜¯ä¸€ä¸ªhashtableï¼Œå®ƒåˆ é™¤é€Ÿåº¦éå¸¸æ…¢ï¼Œé‚£å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼šRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œä½ åˆ é™¤è¿™ä¹ˆä¸€ä¸ªé”®å°±ä¼šé˜»å¡æ‰å¾ˆå¤šRedisè®¿é—®ï¼›è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šä¸€äº›éšæ€§åˆ é™¤ï¼ˆè¿‡æœŸã€renameç­‰ï¼‰ï¼Œéšå½¢åˆ é™¤æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿè¿™æ˜¯ä»¥å‰ç¢°åˆ°çš„ä¾‹å­ï¼Œå‡å¦‚è¯´æˆ‘æ²¡æœ‰æ‰‹åŠ¨å»åˆ é™¤è¿™ä¸ªè¿‡æœŸä»¶ï¼Œè€Œæ˜¯é€šè¿‡Redisè‡ªåŠ¨æ¥å®Œæˆçš„ï¼Œæ¯”å¦‚è¯´åƒè¿‡æœŸï¼Œå‡å¦‚æˆ‘ä»¬ç»™Redisçš„ä¸€ä¸ªhahsè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªhashçš„fieldæœ‰100ä¸‡ã€200ä¸‡ï¼Œæ¯”å¦‚è®©å®ƒæ¯å¤©æ™šä¸Šå»è¿‡æœŸï¼Œå…¶å®è¿‡æœŸæ˜¯ä¸€æ ·çš„ï¼Œæ— è®ºæ˜¯ä½ é€šè¿‡Redisçš„ä¸»åŠ¨è¿‡æœŸè¿˜æ˜¯è¢«åŠ¨è¿‡æœŸå»å°†å®ƒåˆ é™¤æ‰éƒ½æ˜¯è¦è¿›è¡Œä¸€ä¸ªåˆ é™¤æ“ä½œçš„ï¼Œå®ƒèƒŒåä¹Ÿå¯¹åº”çš„æ˜¯ä¸€ä¸ªdelæ“ä½œï¼Œå®ƒä¼šåœ¨é‚£ä¸ªæ—¶é—´ç‚¹ä¼šé˜»å¡æ‰ä½ çš„Redisï¼›è€Œä¸”è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ›´ä¸¥é‡çš„é—®é¢˜ï¼šè¿‡æœŸåˆ é™¤è¿™ä¸ªå‘½ä»¤æœ¬æœ¬èº«å®ƒä¸ä¼šè®°å½•åœ¨Redisæ…¢æŸ¥è¯¢å½“ä¸­ï¼Œå› ä¸ºRedisæ…¢æŸ¥è¯¢æ˜¯è®°å½•å®¢æˆ·ç«¯äº§ç”Ÿçš„è¡Œä¸ºï¼Œè€Œè¿™ä¸ªåªæ˜¯è®°å½•åœ¨Redisçš„å»¶è¿Ÿäº‹ä»¶ç±»å‹ä¸­ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯å®ƒä¼šå°†åˆ é™¤çš„å‘½ä»¤åŒæ­¥ç»™ä»èŠ‚ç‚¹ï¼Œå› ä¸ºä»èŠ‚ç‚¹å¯¹åº”Rediså®ƒæ˜¯ä¸€ä¸ªä¼ªè£…çš„å®¢æˆ·ç«¯ï¼Œä½ è¿™ä¸ªæ—¶å€™é€šè¿‡ä»èŠ‚ç‚¹çš„æ…¢æŸ¥è¯¢æ‰¾åˆ°è¿™æ ·çš„æ•°æ®ç„¶åå»å®šä½è¿™æ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä½ è¦åšçš„å°±æ˜¯ä¸»ä»èŠ‚ç‚¹è®¡é‡çš„è¦æ”¶é›†å®ƒçš„æ…¢æŸ¥è¯¢ï¼›</p><h2 id="Redis-4-0ï¼šlazy-delete-ï¼ˆunlinkå‘½ä»¤ï¼‰"><a href="#Redis-4-0ï¼šlazy-delete-ï¼ˆunlinkå‘½ä»¤ï¼‰" class="headerlink" title="Redis 4.0ï¼šlazy delete ï¼ˆunlinkå‘½ä»¤ï¼‰"></a>Redis 4.0ï¼šlazy delete ï¼ˆunlinkå‘½ä»¤ï¼‰</h2><p>å®ƒå¯ä»¥å°†æ‰€æœ‰çš„åˆ é™¤å‘½ä»¤åšä¸€ä¸ªåå°åˆ é™¤ï¼Œç›¸å½“äºåˆ é™¤ä¸€bigkeyçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥æ‰§è¡Œä¸€ä¸ªåå°åˆ é™¤ï¼Œåå°ä¼šå•ç‹¬æœ‰ä¸€ä¸ªçº¿ç¨‹å»å¸®æˆ‘ä»¬åšè¿™æ ·çš„äº‹æƒ…ï¼Œå®ƒå°±ä¸ä¼šé˜»å¡æ‰Redisä¸»çº¿ç¨‹ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨è¿™æ ·çš„åŠŸèƒ½ï¼Œå¯ä»¥æŠŠRedisæ›´æ–°åˆ°4.0ç‰ˆæœ¬</p><h2 id="bigkeyåˆ é™¤æ–¹æ³•"><a href="#bigkeyåˆ é™¤æ–¹æ³•" class="headerlink" title="bigkeyåˆ é™¤æ–¹æ³•"></a>bigkeyåˆ é™¤æ–¹æ³•</h2><p>å¯¹äºRedis4.0ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œæˆ‘ä»¬æ€ä¹ˆå»åšå‘¢ï¼Ÿè¿™é‡Œå¯ä»¥é€šè¿‡scanæ¥å®Œæˆ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104222834988.png" srcset="/img/loading.gif" alt="image-20191104222834988"></p><p>æ— è®ºæ˜¯hashçš„hscanæˆ–è€…æ˜¯setçš„scanæˆ‘ä»¬éƒ½å¯ä»¥æ‰«æè¿™æ ·çš„bigkeyï¼Œç„¶åå¯¹å®ƒåšä¸€ä¸ªå­åˆ é™¤ï¼Œæ¯”å¦‚è¯´åƒhashçš„hdelï¼ŒåŒ…æ‹¬åƒsetçš„sremoveè¿™æ ·çš„æ“ä½œï¼Œæœ€åæˆ‘ä»¬å¾ªç¯éå†è¿™æ ·çš„bigkeyï¼Œæœ€ç»ˆå½“å®ƒçš„æ¸¸æ ‡è®¾ç½®ä¸º0çš„æ—¶å€™å°±å°†å®ƒè¿”å›ï¼Œä½†æ˜¯è¿™é‡Œè¦æ³¨æ„ï¼šæœ€ç»ˆè¦åˆ é™¤è¿™ä¸ªbigkey</p><h2 id="bigkeyé¢„é˜²"><a href="#bigkeyé¢„é˜²" class="headerlink" title="bigkeyé¢„é˜²"></a>bigkeyé¢„é˜²</h2><h3 id="ä¼˜åŒ–æ•°æ®ç»“æ„"><a href="#ä¼˜åŒ–æ•°æ®ç»“æ„" class="headerlink" title="ä¼˜åŒ–æ•°æ®ç»“æ„"></a>ä¼˜åŒ–æ•°æ®ç»“æ„</h3><p>å‡å¦‚è¯´æˆ‘ä»¬çœŸçš„è¦åœ¨Redisä¸­æœ‰è¿™æ ·çš„bigkeyï¼Œå¦‚æœä½ çœŸçš„åˆ é™¤ä¸äº†ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†å®ƒåšä¸€ä¸ªæ‹†åˆ†ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥æŒ‰è®©æ—¥æœŸæ‹†åˆ†ï¼Œå‡å¦‚æœ‰çš„äººå­˜äº†ä¸€ä¸ªå¤§çš„listï¼Œå®é™…ä¸Šå®ƒæ˜¯æŒ‰å¤©æ¥å­˜çš„ï¼Œå®ƒæœ‰ä¸ªæ—¶é—´æˆ³çš„å±æ€§ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å®Œå…¨å¯ä»¥ç»™å®ƒåšä¸€ä¸ªäºŒçº§æ‹†åˆ†æ¯”å¦‚è¯´æŒ‰å¤©ã€æŒ‰å°æ—¶è¿™æ ·å°±ä¸ä¼šæœ‰bigkeyçš„é—®é¢˜ï¼Œç”šè‡³åƒhashè¿™æ ·çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€äº›äºŒçº§hashçš„å¤„ç†ï¼Œåé¢è®²Redisä½¿ç”¨åˆç†æ•°æ®ç»“æ„çš„æ—¶å€™ä¼šä»‹ç»ä¸€ä¸ªç±»ä¼¼çš„ä¾‹å­ï¼›</p><h3 id="ç‰©ç†éš”ç¦»æˆ–è€…ä¸‡å…†ç½‘å¡ï¼šä¸æ˜¯æ²»æ ‡æ–¹æ¡ˆ"><a href="#ç‰©ç†éš”ç¦»æˆ–è€…ä¸‡å…†ç½‘å¡ï¼šä¸æ˜¯æ²»æ ‡æ–¹æ¡ˆ" class="headerlink" title="ç‰©ç†éš”ç¦»æˆ–è€…ä¸‡å…†ç½‘å¡ï¼šä¸æ˜¯æ²»æ ‡æ–¹æ¡ˆ"></a>ç‰©ç†éš”ç¦»æˆ–è€…ä¸‡å…†ç½‘å¡ï¼šä¸æ˜¯æ²»æ ‡æ–¹æ¡ˆ</h3><p>è¿˜æœ‰ä¸€äº›æ–¹æ³•çš„è¯ï¼Œå®ƒä¸æ˜¯è§£å†³æ ¹æœ¬é—®é¢˜çš„æ–¹æ³•ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å¯ä»¥å¯¹æœ‰bigkeyçš„Redisåšä¸€äº›ç‰©ç†éš”ç¦»ï¼Œç”šè‡³è®©å®ƒä½¿ç”¨ä¸‡å…†ç½‘å¡ï¼Œè¿™æ ·çš„è¯å¯ä»¥å‡è½»åƒç½‘ç»œé˜»å¡çš„é—®é¢˜ï¼Œä½†æ˜¯ä»»ç„¶è¿™é‡Œä¸æ˜¯è§£å†³é—®é¢˜çš„æ ¹æœ¬æ–¹æ³•</p><h3 id="å‘½ä»¤ä¼˜åŒ–"><a href="#å‘½ä»¤ä¼˜åŒ–" class="headerlink" title="å‘½ä»¤ä¼˜åŒ–"></a>å‘½ä»¤ä¼˜åŒ–</h3><p>æˆ‘ä»¬æœ‰bigkeyï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€äº›è½»çš„å‘½ä»¤ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬åœ¨ä½¿ç”¨hashçš„æ—¶å€™ï¼Œæˆ‘ä»¬çœŸçš„éœ€è¦ä½¿ç”¨hgetallå—ï¼Ÿèƒ½ä¸èƒ½é€šè¿‡hmgetã€hscanæŒ‡å®šè·å–éœ€è¦çš„å±æ€§ï¼›</p><h3 id="æŠ¥è­¦å’Œå®šæœŸä¼˜åŒ–"><a href="#æŠ¥è­¦å’Œå®šæœŸä¼˜åŒ–" class="headerlink" title="æŠ¥è­¦å’Œå®šæœŸä¼˜åŒ–"></a>æŠ¥è­¦å’Œå®šæœŸä¼˜åŒ–</h3><p> è¿ç»´äººå‘˜å°†Redisçš„bigkeyå®šæœŸåšä¸€ä¸ªæ”¶é›†ï¼Œç„¶åå‘é€åˆ°å„å„ä¸šåŠ¡ç«¯ï¼Œå„å„ä¸šåŠ¡ç«¯å®šæœŸå‘ç°è¿™ä¸ªé—®é¢˜ä¹‹åä¼šåšå„è‡ªçš„ä¿®å¤ï¼Œè¿™æ ·åœ¨æ€»ä½“çš„ç®¡ç†Redisä¸Šä¼šæœ‰å¾ˆå¥½çš„å¸®åŠ©ï¼›</p><h3 id="bigkeyæ€»ç»“"><a href="#bigkeyæ€»ç»“" class="headerlink" title="bigkeyæ€»ç»“"></a>bigkeyæ€»ç»“</h3><ul><li>ç‰¢è®°Rediså•çº¿ç¨‹ç‰¹æ€§ï¼›</li><li>é€‰æ‹©åˆç†çš„æ•°æ®ç»“æ„å’Œå‘½ä»¤ï¼›</li><li>æ¸…æ¥šè‡ªèº«çš„OPSå’ŒQPSé˜²æ­¢å‡ºç°ç½‘ç»œé˜»å¡ã€é˜»å¡é—®é¢˜ï¼›</li><li>äº†è§£bigkeyçš„å±å®³ã€‚</li></ul><h1 id="åˆé€‚çš„æ•°æ®ç»“æ„"><a href="#åˆé€‚çš„æ•°æ®ç»“æ„" class="headerlink" title="åˆé€‚çš„æ•°æ®ç»“æ„"></a>åˆé€‚çš„æ•°æ®ç»“æ„</h1><h2 id="é€‰æ‹©"><a href="#é€‰æ‹©" class="headerlink" title="é€‰æ‹©"></a>é€‰æ‹©</h2><p>ä¾‹å¦‚æˆ‘ä»¬åœ¨è®¾è®¡kvçš„æ—¶å€™ï¼Œè¦é€‰æ‹©ä¸€ä¸ªåˆç†çš„æ•°æ®ç»“æ„ï¼Œæ¯”å¦‚æˆ‘ä»¬ä½¿ç”¨hahsã€å­—ç¬¦ä¸²ã€setã€zsetï¼Œå®é™…ä¸Šæ¯ç§æ•°æ®ç»“æ„éƒ½æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼Œæˆ‘ä»¬åœ¨é€‰æ‹©çš„æ—¶å€™éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li>é€‰æ‹©åˆç†çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬æ˜¯ä½¿ç”¨å“ªç§æ•°æ®ç»“æ„ï¼Ÿ</li><li>é€‰æ‹©æ•°æ®åº“çš„ç¼–ç ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½è¾¾åˆ°æŸç§ç±»å‹çš„ä¸€ä¸ªå†…å­˜ï¼Œæ¯”å¦‚å†…å­˜å’Œæ€§èƒ½çš„æœ€å¤§åŒ–</li></ul><p>é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªç”¨ä¸€ä¸ªä¾‹å­è¯´æ˜ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104224658186.png" srcset="/img/loading.gif" alt="image-20191104224658186"></p><p>å‡å¦‚ç°åœ¨æˆ‘çš„æ•°æ®è¡¨æ˜¯è¿™æ ·çš„ï¼Œä¸€ä¸ªç”¨æˆ·æ•°æ®è¡¨æœ‰4ä¸ªå±æ€§ï¼Œåˆ†åˆ«æ˜¯å®ƒçš„é‚®ä»¶ã€åå­—ã€å¯†ç ã€åºå·ï¼Œå®ƒå¯¹åº”æˆ‘ä»¬ä¸€ä¸ªé€‰æ‹©æ•°æ®ç»“æ„çš„æ—¶å€™å¯èƒ½ä¼šæœ‰2ç§è®¾è®¡ï¼Œ</p><p>ç¬¬ä¸€ç§ï¼š<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104224545458.png" srcset="/img/loading.gif" alt="image-20191104224545458"></p><p>æˆ‘ä»¬ç»™æ¯ä¸ªå±æ€§ä¹Ÿå°±æ˜¯userï¼š1ç„¶åå®ƒçš„nameè®¾ç½®ä¸€ä¸ªåå­—ï¼Œç„¶åuserï¼š1çš„ageè®¾ç½®ä¸€ä¸ªå±æ€§ç±»ä¼¼äºè¿™æ ·ï¼›</p><p>ç¬¬äºŒç§ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104224648877.png" srcset="/img/loading.gif" alt="image-20191104224648877"></p><p> ä½¿ç”¨hashï¼Œå°†å…³ç³»å‹æ•°æ®åº“è¿›è¡Œå€’è£…ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬å°†å®ƒçš„æ¯ä¸€åˆ—ä½œä¸ºfieldï¼Œå®ƒçš„æ¯ä¸€ä¸ªå€¼ä½œä¸ºæˆ‘ä»¬çš„valueï¼Œç„¶åå®ƒçš„æ•°æ®åº“åæˆ–è€…è¡¨åä½œä¸ºå®ƒçš„keyï¼Œç„¶åå®ƒçš„idä½œä¸ºå®ƒçš„keytçš„åç¼€ï¼Œç›¸å½“äºæˆ‘å‰ç¼€å¯¹åº”æ•°æ®åº“å+è¡¨åç„¶åä¸€ä¸ªå†’å·ç„¶åå†åŠ ä¸Šå®ƒçš„idï¼Œåœ¨è®¾è®¡è¿™ç§æ•°æ®ç»“æ„çš„æ—¶å€™æˆ‘ä»¬é€šå¸¸ä¼šä½¿ç”¨ç¬¬äºŒç§ï¼Œä½¿ç”¨hashä¼šæœ‰å‡ ä¸ªå¥½å¤„ï¼š</p><ul><li>ä¿è¯keyä¸æ˜¯ä¸€ä¸ªæ¾æ•£çš„ï¼Œuserï¼š1æ˜¯ä¸€ä¸ªå®Œå…¨çš„æ•´ä½“ï¼Œå¦‚æœä½¿ç”¨ä¸Šé¢è¿™ç§æƒ…å†µä¸‹å®ƒä¸æ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œè€Œä¸”æˆ‘ä»¬åœ¨ä½¿ç”¨åƒhashçš„æ—¶å€™å¦‚æœä½¿ç”¨äº†åƒziplist,æ»¡è¶³ziplistçš„æ¡ä»¶è¿˜å¯ä»¥è¾¾åˆ°èŠ‚çœå†…å­˜çš„æ•ˆæœ</li></ul><h2 id="ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ"><a href="#ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ" class="headerlink" title="ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ"></a>ä¸€ä¸ªä¾‹å­ã€ä¸‰ç§æ–¹æ¡ˆ</h2><h3 id="éœ€æ±‚"><a href="#éœ€æ±‚" class="headerlink" title="éœ€æ±‚"></a>éœ€æ±‚</h3><p>picId=&gt;userIdï¼ˆ100ä¸‡ï¼‰ï¼Œè¿™é‡Œéœ€è¦é€šè¿‡å›¾ç‰‡idå»æ‰¾åˆ°ç”¨æˆ·idè¿™æ ·ä¸€ä¸ªæ˜ å°„ï¼Œæ¯”å¦‚ç”¨æˆ·å‘äº†å¾ˆå¤šå›¾ç‰‡ï¼Œç„¶åå°±æœ‰ä¸€ä¸ªpicIdå’ŒuserIdçš„æ˜ å°„</p><h3 id="æ–¹æ¡ˆ"><a href="#æ–¹æ¡ˆ" class="headerlink" title="æ–¹æ¡ˆ"></a>æ–¹æ¡ˆ</h3><ul><li>å…¨éƒ¨stringï¼šset picId userId</li><li>è®¾ç½®ä¸€ä¸ªå¤§çš„hashï¼Œhset allPics picId</li><li>è‹¥å¹²ä¸ªå°çš„hashï¼Œæˆ‘ä»¬å¯¹åº”ä¸€ä¸ªkeyçš„è¯å°±æ˜¯ hset picId/100 picId%100 userId</li></ul><p>æ¥çœ‹ä¸‹è¿™3ç§æ–¹æ¡ˆçš„å†…å­˜ä½¿ç”¨</p><p>æ–¹æ¡ˆ1ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104225828520.png" srcset="/img/loading.gif" alt="image-20191104225828520"></p><p>ç¬¬ä¸€ç§å¾ˆæ˜æ˜¾ï¼Œå¼ å›¾å›¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œå°±æ˜¯keyå’Œvalueçš„å­—ç¬¦ä¸²ç±»å‹ï¼Œå½“æˆ‘ä»¬è®¾ç½®100ä¸‡ä¸ªçš„æ—¶å€™ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104225834735.png" srcset="/img/loading.gif" alt="image-20191104225834735"></p><p>æ–¹æ¡ˆ2ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104225852146.png" srcset="/img/loading.gif" alt="image-20191104225852146"></p><p>è¿™ç§æ–¹å¼å¾ˆæ˜æ˜¾å°±æ˜¯ä¸€ä¸ªbigkeyï¼Œä¸€ä¸ª100ä¸‡ä¸ªå…ƒç´ çš„hashï¼Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104225927443.png" srcset="/img/loading.gif" alt="image-20191104225927443"></p><p>è¿™æ ·éå¸¸å ç”¨å†…å­˜ï¼Œå®ƒçš„è®¾è®¡æ–¹æ¡ˆä¹Ÿå¾ˆæœ‰é—®é¢˜ã€‚</p><p>æ–¹æ¡ˆ3ï¼š</p><p>æ‹†åˆ†æˆè¿™æ ·ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104230054990.png" srcset="/img/loading.gif" alt="image-20191104230054990"></p><p>æ¯ä¸€ä¸ªhash keyæœ‰100ä¸ªfieldå’Œå’Œvalueï¼Œè¿™æ ·æˆ‘å¯ä»¥å°†ä¸€ç™¾ä¸‡ä¸ªpicIdå’ŒuserIdæ‹†æˆä¸€ä¸‡ä¸ªå°çš„hashå°±æ˜¯è¿™æ ·çš„è®¾è®¡æ¨¡å¼ï¼Œkeyå°±æ˜¯100ä¸‡ä¸ªpicIdæ¯ä¸ªpicIdé™¤ä»¥100ï¼Œfieldå°±æ˜¯picIdå»å–ä¸€ç™¾çš„ä½™ï¼Œè¿™æ ·å°±å¯ä»¥å°†è¿™ä¸ªå¤§çš„picIdå’ŒuserIdæ‹†æˆè‹¥å¹²ä¸ªå°çš„hashï¼Œå†…å­˜ä½¿ç”¨é‡ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104230328603.png" srcset="/img/loading.gif" alt="image-20191104230328603"></p><h3 id="3ç§æ–¹æ¡ˆå†…å­˜å¯¹æ¯”"><a href="#3ç§æ–¹æ¡ˆå†…å­˜å¯¹æ¯”" class="headerlink" title="3ç§æ–¹æ¡ˆå†…å­˜å¯¹æ¯”"></a>3ç§æ–¹æ¡ˆå†…å­˜å¯¹æ¯”</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104230411636.png" srcset="/img/loading.gif" alt="image-20191104230411636"></p><p>ç¬¬1ç§å’Œç¬¬2ç§æ˜¯ç±»ä¼¼çš„ï¼Œç¬¬3ç§å®ƒå¯ä»¥è¾¾åˆ°å¾ˆæƒŠäººçš„å†…å­˜ä½¿ç”¨æ•ˆæœï¼Œç”šè‡³å¯ä»¥è¾¾åˆ°ç¼©å°4-5å€çš„æ•ˆæœ</p><h3 id="3ç§æ–¹æ¡ˆå†…å­˜åˆ†æ"><a href="#3ç§æ–¹æ¡ˆå†…å­˜åˆ†æ" class="headerlink" title="3ç§æ–¹æ¡ˆå†…å­˜åˆ†æ"></a>3ç§æ–¹æ¡ˆå†…å­˜åˆ†æ</h3><p>ä¸ºä»€ä¹ˆç¬¬3ç§æ–¹æ¡ˆå ç”¨å†…å­˜æ¯”è¾ƒå°ï¼Ÿ</p><p>å¯¹äºRedisæ¥è¯´å®ƒæ”¯æŒå¾ˆå¤šå†…å­˜ä¼˜åŒ–æ–¹æ¡ˆï¼Œå¯¹äºhashç±»å‹çš„è¯ï¼Œå®ƒå¯¹å¤–æ˜¯hashç±»ä¼¼ï¼Œå®ƒå†…éƒ¨æœ‰å¾ˆå¤šç¼–ç ï¼Œæ¯”å¦‚hashtableã€ziplist</p><p>é…ç½®ï¼ˆæ”¯æŒåŠ¨æ€ä¿®æ”¹ï¼‰</p><ul><li>hash-max-ziplist-entries 512</li><li>hash-max-ziplist-value 64</li></ul><p>ziplist</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104230718916.png" srcset="/img/loading.gif" alt="image-20191104230718916"></p><p>è¿ç»­å†…å­˜å­˜å‚¨ï¼Œå‡å°‘äº†å¾ˆå¤šæŒ‡é’ˆä»¥åŠè¿ç»­å†…å­˜äº§ç”Ÿçš„ç¢ç‰‡çš„é—®é¢˜ï¼Œè€Œä¸”å®ƒæ˜¯ä¸€ä¸ªè¿ç»­å­˜å‚¨ä¹‹åï¼Œå®ƒé¦–å…ˆä¼šèŠ‚çœå¾ˆå¤šå†…å­˜ï¼Œä½†æ˜¯å®ƒä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®ƒçš„æ“ä½œå¤æ‚åº¦ä¼šæ¯”è¾ƒé«˜ï¼Œå®ƒçš„è¯»å†™æŒ‡é’ˆçš„ä½ç§»å¹¶ä¸”ä½ æ–°å¢æ·»åŠ åˆ é™¤çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªå†…å­˜çš„é‡åˆ†é…ï¼Œè¿˜æœ‰ä½ å¯»æ‰¾ä¼šæ¯”è¾ƒæ…¢ï¼Œè¿™ç§æ•°æ®ç»“æ„çš„è¯æ˜¯æœ‰ä¸€ä¸ªæƒè¡¡ï¼Œåœ¨ä½¿ç”¨è¿™ç§æ•°æ®ç»“æ„çš„æ—¶å€™è¦è€ƒè™‘å…ƒç´ ä¸ªæ•°ï¼Œå¦‚æœå…ƒç´ ä¸ªæ•°å°‘ï¼Œæˆ–è€…ä¸€ä¸ªå¤§çš„ä¸€ä¸ªvalueçš„æ—¶å€™ï¼Œé‚£å®ƒçš„ä¸€ä¸ªå†…å­˜å’Œæ€§èƒ½åšä¸€ä¸ªå¹³è¡¡ï¼Œæˆ‘ä»¬å®å¯ç”¨æ›´å°‘çš„å†…å­˜ç¨å¾®å¤šä¸€ç‚¹æ€§èƒ½æ¥æ¢å–å†…å­˜çš„æœ€å¤§åŒ–ï¼Œå…¶å®å¯¹åº”ä¸Šé¢2ä¸ªé…ç½®ï¼Œä¹Ÿå°±æ˜¯å½“æˆ‘ä»¬å…ƒç´ å°‘äº512å¹¶ä¸”filed valueæ²¡æœ‰å¤§äº64å­—èŠ‚çš„å…ƒç´ çš„æ—¶å€™ï¼Œé‚£æˆ‘ä»¬Redisä¼šé»˜è®¤é€‰æ‹©ä½¿ç”¨ziplistæ¥å­˜å‚¨è¿™æ ·çš„hashç»“æ„ï¼Œä¹Ÿå°±è¯´æˆ‘ä»¬ä¼šç”¨æ›´å°‘çš„å†…å­˜æ¥å­˜å‚¨hashç»“æ„ï¼Œå¯¹äºåˆšæ‰ä¾‹å­ä¸­çœ‹åˆ°äº†æ¯ä¸€ä¸ªfield-valueæ˜¯100ä¸ªå®ƒæ˜¯æ»¡è¶³512ä¸ªçš„ï¼Œç„¶å64ä¸ªå­—èŠ‚ä¹Ÿä¸€æ ·ï¼Œæˆ‘çš„æ¯ä¸ªfiled-valueå­—èŠ‚æ•°æ¯”è¾ƒå°‘çš„ï¼Œå½“ç„¶è¿™ä¸ªä½ æ˜¯å¯ä»¥åŠ¨æ€è°ƒæ•´çš„ï¼Œæ¯”å¦‚config setæ¥è¿›è¡Œè°ƒæ•´ï¼Œä½†æ˜¯ä¸€å®šè¦æ³¨æ„ï¼šæˆ‘ä»¬åœ¨æ€§èƒ½å’Œå†…å­˜ä¸Šä¸€å®šè¦åšä¸€ä¸ªå‡è¡¡ï¼Œä¸èƒ½è¯´æˆ‘ç»™å®ƒè®¾ç½®æˆ5120ï¼Œè¿™æ ·çš„è¯æˆ‘ä»¬æ˜¯ä½¿ç”¨äº†ziplistï¼Œä½†æ˜¯å®ƒçš„æ€§èƒ½ä¼šä¸‹é™ï¼Œä¼šå¯¼è‡´QPSä¸æ˜¯å¾ˆé«˜è€Œä¸”CPUä½¿ç”¨éå¸¸é«˜çš„æƒ…å†µ</p><h3 id="3ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹å¯¹æ¯”"><a href="#3ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹å¯¹æ¯”" class="headerlink" title="3ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹å¯¹æ¯”"></a>3ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹å¯¹æ¯”</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191104231550306.png" srcset="/img/loading.gif" alt="image-20191104231550306"></p><h1 id="é”®å€¼ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†"><a href="#é”®å€¼ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†" class="headerlink" title="é”®å€¼ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†"></a>é”®å€¼ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†</h1><h2 id="Redisä¸æ˜¯åƒåœ¾æ¡¶"><a href="#Redisä¸æ˜¯åƒåœ¾æ¡¶" class="headerlink" title="Redisä¸æ˜¯åƒåœ¾æ¡¶"></a>Redisä¸æ˜¯åƒåœ¾æ¡¶</h2><p>Rediså¯¹äºå¼€å‘äººå‘˜æ˜¯éå¸¸å¥½ç”¨çš„ï¼Œå®ƒå¯ä»¥å°†hashã€setã€zsetã€listè¿™æ ·çš„æ•°æ®ç»“æ„å’Œå¼€å‘è¯­è¨€ä¸­çš„æ•°æ®ç»“æ„åšä¸€ä¸ªå®Œç¾çš„æ˜ å°„ï¼Œå®ƒéå¸¸æ–¹ä¾¿ï¼Œé€ æˆå¾ˆå¤šå¼€å‘äººå‘˜ä½¿ç”¨Redisçš„æ—¶å€™ä¼šèƒ¡ä¹±ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼šä»€ä¹ˆä¸œè¥¿éƒ½å¾€Redisæ”¾ï¼Œè€Œä¸”ä»–è¿˜ä¸ä¼šæ§åˆ¶Redisç”Ÿå‘½å‘¨æœŸç»™keyè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚Redisç¼“å­˜ä¸€ä¸ªkeyåº”è¯¥æ˜¯è¦åœ¨ä¸€å®šæ—¶é—´è¿›è¡Œåˆ é™¤çš„ï¼Œæˆ–è€…åœ¨ä¸€å®šæ—¶é—´éƒ½æ²¡æœ‰ç”¨äº†ä½†æ˜¯å®ƒå› ä¸ºæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´è¿™æ ·é€ æˆRedisä¸€ç›´ä¿ç•™é‚£äº›æ•°æ®ï¼Œä¸ä»…åŒ…æ‹¬è¯´Rediså»è¦ä¸æ–­çš„å»æ‰©å®¹ï¼Œè¿™æ ·çš„è¯å®ƒçš„é‡éå¸¸å¤§ï¼Œè¿˜æœ‰å®ƒä½¿ç”¨çš„æ—¶å€™ä¼šæ¯”è¾ƒæ··ä¹±ã€‚</p><hr><p>å¯¹äºç”Ÿå‘½å‘¨æœŸçš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å‘¨æœŸæ•°æ®åšä¸€ä¸ªç¼“å­˜æˆ–è€…è¿‡æœŸæ—¶é—´çš„è®¾ç½®ï¼ŒRedisæ”¯æŒexpireè¿™æ ·çš„å‘½ä»¤ï¼Œä½†å¦‚æœæˆ‘ä»¬å¯¹ä¸€ä¸ªç°æœ‰çš„Redisï¼Œå¸Œæœ›æ‰¾åˆ°å¤šå°‘å¹´å¤šå°‘æœˆå¤šå°‘å‘¨æœŸä½¿ç”¨çš„æ•°æ®ï¼Œè¿™æ ·çš„æ•°æ®æˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>object idle time</code>å‘½ä»¤æ‰¾åˆ°key-valueçš„é—²ç½®æ—¶é—´ï¼Œæ¯”å¦‚æœ‰ä¸€ä¸ªæ•°æ®30å¤©æ²¡ä½¿ç”¨äº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæŠ¥å‘Šå‘é€ç»™å¼€å‘äººå‘˜æˆ–è€…å¼€å‘äººå‘˜è‡ªèº«å»æ‰«æscanè¿™æ ·çš„keyï¼Œè‡ªèº«å»è¿›è¡Œä¼˜åŒ–ï¼Œè¿™å¯¹äºç®¡ç†Redisæ˜¯éå¸¸æœ‰å¸®åŠ©çš„</p><hr><p>åœ¨è®¾ç½®è¿‡æœŸæ—¶é—´çš„æ—¶å€™ï¼Œæ¯”å¦‚éƒ½è®¾ç½®åœ¨3å°æ—¶åè¿‡æœŸæˆ–è€…æ¯3å°æ—¶è¿‡æœŸä¸€æ¬¡ï¼Œç„¶åè¿‡æœŸä¹‹åé€šè¿‡æ•°æ®åº“è¿›è¡Œé‡å»ºï¼Œè¿™æ ·å¾ˆå¯èƒ½äº§ç”Ÿç¼“å­˜ç©¿é€å’Œé›ªå´©é—®é¢˜ï¼Œè¿‡æœŸåœ¨é›†ä¸­äº§ç”Ÿçš„æ—¶å€™å¯èƒ½ä¼šé›†ä¸­å»è®¿é—®æ•°æ®åº“æˆ–è€…åº•å±‚æ•°æ®æºï¼Œè¿™æ ·ä¼šé€ æˆç¼“å­˜é›†ä¸­å»ç©¿é€ï¼Œé€ æˆåº•å±‚æ•°æ®æºæ— æ³•æ‰¿å—è¿™ä¹ˆå¤§çš„å¹¶å‘é‡é€ æˆé›ªå´©</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191105193911373.png" srcset="/img/loading.gif" alt="image-20191105193911373"></p><p>ä¸Šé¢è¿™å¼ å›¾æ˜¾ç¤ºçš„æ˜¯ä¸€ä¸ªæ•°æ®åº“ï¼Œå®ƒæœ‰åœ¨å‘¨æœŸçš„æ—¶é—´å†…ä¼šå‘ç°è´Ÿè½½éå¸¸é«˜ï¼Œè¿™é‡Œå°±å¯èƒ½æ˜¯å› ä¸ºè¿‡æœŸæ—¶é—´è®¾ç½®æ¯”è¾ƒé›†ä¸­é€ æˆçš„</p><h1 id="å‘½ä»¤ä¼˜åŒ–æŠ€å·§"><a href="#å‘½ä»¤ä¼˜åŒ–æŠ€å·§" class="headerlink" title="å‘½ä»¤ä¼˜åŒ–æŠ€å·§"></a>å‘½ä»¤ä¼˜åŒ–æŠ€å·§</h1><h2 id="ã€æ¨èã€‘0-N-ä»¥ä¸Šå‘½ä»¤å…³æ³¨Nçš„æ•°é‡"><a href="#ã€æ¨èã€‘0-N-ä»¥ä¸Šå‘½ä»¤å…³æ³¨Nçš„æ•°é‡" class="headerlink" title="ã€æ¨èã€‘0(N)ä»¥ä¸Šå‘½ä»¤å…³æ³¨Nçš„æ•°é‡"></a>ã€æ¨èã€‘0(N)ä»¥ä¸Šå‘½ä»¤å…³æ³¨Nçš„æ•°é‡</h2><ul><li>ä¾‹å¦‚ï¼šhgetallã€lrangeã€smembersã€zrangeã€sinterç­‰å¹¶éä¸èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦æ˜ç¡®Nçš„å€¼ï¼Œå‡å¦‚ä½ çš„Næ˜¯å‡ ç™¾æˆ–è€…ä¸€åƒä»¥ä¸‹å®é™…ä¸Šä¹Ÿæ²¡æœ‰å¤ªå¤§çš„å½±å“ï¼Œå…¶å®å¦‚æœä½ çš„é”®å€¼æˆ–è€…filedå’Œvalueéå¸¸å¤§çš„æ—¶å€™ä½ è¦è€ƒè™‘ä¸€ä¸ªé—®é¢˜ï¼šèƒ½ä¸èƒ½ä½¿ç”¨ä¸€äº›å‘½ä»¤æ¥è¿›è¡Œéå†ï¼Œæ¯”å¦‚ä½¿ç”¨hscanã€sscanã€zscanè¿›è¡Œä»£æ›¿ï¼Œè¿™é‡Œæ„æ€æ˜¯è¯´ä½¿ç”¨å¤§çš„å‘½ä»¤æ—¶ä½ è¦å…³æ³¨ä½ ä½¿ç”¨çš„å‘½ä»¤æ˜¯ä¸æ˜¯ä¸€ä¸ªçœŸçš„å¤§å‘½ä»¤ï¼›</li></ul><h2 id="ã€æ¨èã€‘ç¦ç”¨å‘½ä»¤"><a href="#ã€æ¨èã€‘ç¦ç”¨å‘½ä»¤" class="headerlink" title="ã€æ¨èã€‘ç¦ç”¨å‘½ä»¤"></a>ã€æ¨èã€‘ç¦ç”¨å‘½ä»¤</h2><p>ç¦æ­¢çº¿ä¸Šä½¿ç”¨keysã€flushallã€flushdbç­‰ï¼Œé€šè¿‡redisçš„renameæœºåˆ¶ç¦æ‰å‘½ä»¤ï¼Œæˆ–è€…ä½¿ç”¨scançš„æ–¹å¼æ¸è¿›å¼å¤„ç†ã€‚</p><h2 id="ã€æ¨èã€‘åˆç†ä½¿ç”¨select"><a href="#ã€æ¨èã€‘åˆç†ä½¿ç”¨select" class="headerlink" title="ã€æ¨èã€‘åˆç†ä½¿ç”¨select"></a>ã€æ¨èã€‘åˆç†ä½¿ç”¨select</h2><p>redisæœ‰å¾ˆå¤šæ•°æ®åº“ï¼Œå®ƒé»˜è®¤ç»™ä½ 16ä¸ªæ•°æ®åº“ï¼Œä½ å¯ä»¥ä½¿ç”¨select 0ã€select 1è¿›è¡Œæ•°æ®åº“åˆ‡æ¢ï¼Œæ•°æ®åº“ä¹‹é—´é€»è¾‘ä¸Šæ˜¯å¯ä»¥è¿›è¡ŒåŒºåˆ†çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘å¯ä»¥åœ¨æ•°æ®åº“0ä¸­è®¾ç½®keyä¸ºhelloï¼Œvalueä¸ºworldï¼Œåœ¨ç¬¬2ä¸ªåº“é‡Œè®¾ç½®helloæ˜¯abcï¼Œè¿™ä¸¤ä¸ªåº“ä¹‹é—´æ˜¯æ²¡æœ‰å¹²æ‰°ï¼Œè¿™æ ·å¯ä»¥åšä¸€äº›ä¸šåŠ¡é€»è¾‘çš„éš”ç¦»ï¼Œè€Œä¸”è¿˜å¯ä»¥é˜²æ­¢å¹²æ‰°ï¼Œæ¯”å¦‚è¯´å¯ä»¥åœ¨ä¸€äº›æµ‹è¯•ç¯å¢ƒä¸Šç”¨ä¸€ä¸ªå•ç‹¬çš„æ•°æ®åº“ï¼Œä½†æ˜¯Rediså¯¹æ•°æ®åº“æ¯”è¾ƒå¼±ï¼Œå› ä¸ºå®ƒç”¨æ•°å­—è¿›è¡ŒåŒºåˆ†ï¼›</p><hr><p>å¾ˆå¤šå®¢æˆ·ç«¯å¯¹selectæ”¯æŒå·®ï¼Œåƒselect 0ã€select 1è¿™äº›ï¼Œå¾ˆå®¹æ˜“é€ æˆä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ä½ åˆ‡æ¢åˆ‡æ¢è‡ªå·±éƒ½ä¸çŸ¥é“åˆ‡æ¢åˆ°å“ªé‡Œå»äº†</p><hr><p>å®ƒçš„éš”ç¦»åªæ˜¯é€»è¾‘ä¸Šçš„éš”ç¦»å¹¶ä¸æ²¡æœ‰åšæˆè¿›ç¨‹ä¹‹é—´çš„éš”ç¦»ï¼Œå®ƒåªæœ‰ä¸€ä¸ªè¿›ç¨‹è€Œä¸”ä»»ç„¶æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„å¤„ç†ï¼Œæ¯”å¦‚è¯´ä½ åœ¨0å·æ•°æ®åº“æ­£å¸¸ä¸šåŠ¡å»æ‰§è¡Œé‚£ä½ åœ¨1å·æ•°æ®åº“å»æ‰§è¡Œå¾ˆå¤§çš„å‘½ä»¤å®ƒä¾ç„¶ä¼šé˜»å¡0å·æ•°æ®åº“ï¼Œæ‰€æœ‰åœ¨ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„è€Œä¸”ä½ åœ¨å¤§çš„ä¸šåŠ¡ä¸Šå»ä½¿ç”¨selectçš„æ—¶å€™é¢‘ç¹çš„åˆ‡æ¢å¯¹äºRedisä¹Ÿä¼šæœ‰ä¸€å®šæ€§èƒ½çš„æ¶ˆè€—ï¼Œå®ƒæ¯”è¾ƒå QPS</p><h2 id="ã€æ¨èã€‘Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨"><a href="#ã€æ¨èã€‘Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨" class="headerlink" title="ã€æ¨èã€‘Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨"></a>ã€æ¨èã€‘Redisäº‹åŠ¡åŠŸèƒ½è¾ƒå¼±ï¼Œä¸å»ºè®®è¿‡å¤šä½¿ç”¨</h2><p>Redisæ˜¯æ”¯æŒç®€å•äº‹åŠ¡çš„ï¼Œä½†æ˜¯å®ƒçš„äº‹åŠ¡åŠŸèƒ½éå¸¸å¼±å®ƒä¸æ”¯æŒå›æ»šï¼Œè¿™ä¸ªå°±ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„äº‹åŠ¡ï¼Œæ‰€ä»¥ä½ åœ¨ä½¿ç”¨Redisçš„æ—¶å€™ï¼Œå¦‚æœæœ‰äº‹åŠ¡çš„éœ€æ±‚ï¼Œå»ºè®®ä¸è¦ä½¿ç”¨Redisè‡ªå¸¦çš„äº‹åŠ¡ï¼Œè€Œæ˜¯ä½¿ç”¨åƒä¸€äº›å¼€å‘è¯­è¨€åƒSpringè‡ªå¸¦çš„ä¸€äº›äº‹åŠ¡æ¥è¿›è¡Œå®Œæˆï¼Œæˆ–è€…å€ŸåŠ©ä¸€äº›å¤–éƒ¨æ¥å®ç°ï¼›</p><hr><p>åœ¨é›†ç¾¤ä¸­æœ‰ä¸€ä¸ªè¦æ±‚ï¼šåœ¨æ‰€æœ‰äº‹åŠ¡ä¸­ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤å¿…é¡»æ˜¯è¦åœ¨ä¸€ä¸ªslotä¸Šï¼Œæ¯”å¦‚åœ¨ä½¿ç”¨RedisClusterè¦æ±‚åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ“ä½œçš„æ‰€æœ‰keyå¿…é¡»æ˜¯ä¸€ä¸ªåœ¨ä¸€ä¸ªslotä¸Šï¼Œè¿™é‡Œæ— æ³•æ§åˆ¶slotå’Œkeyçš„å¯¹åº”å…³ç³»ï¼Œå› ä¸ºå¯¹äºkeyè½åœ¨å“ªä¸ªslotä¸Šæˆ‘ä»¬æ˜¯æ— æ³•æ§åˆ¶çš„ï¼Œå¦‚æœçœŸçš„è¦ä½¿ç”¨è¿™æ ·çš„åŠŸèƒ½å»ºè®®å»ä½¿ç”¨<code>hashtag</code>ï¼Œå®ƒèƒ½ä¿è¯æ‰€æœ‰çš„keyæ˜¯è½åœ¨ä¸€ä¸ªslotä¸Šï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šæœ‰ä¸€äº›é—®é¢˜æ¯”å¦‚è¯´é€ æˆkeyä¸å‡åŒ€</p><h2 id="ã€æ¨èã€‘Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚"><a href="#ã€æ¨èã€‘Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚" class="headerlink" title="ã€æ¨èã€‘Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚"></a>ã€æ¨èã€‘Redisé›†ç¾¤ç‰ˆæœ¬åœ¨ä½¿ç”¨Luaä¸Šæœ‰ç‰¹æ®Šè¦æ±‚</h2><p>Redisæ”¯æŒLuaï¼ŒLuaå¯ä»¥è‡ªç ”å¾ˆå¤šå‘½ä»¤ï¼Œæ¯”å¦‚å°†å¾ˆå¤šå‘½ä»¤è¿›è¡Œä¸€ä¸ªç»„åˆæ¥å®ç°ä¸€ä¸ªåŸå­æ€§çš„æ“ä½œï¼Œå®ƒå¯ä»¥å®Œæˆå¾ˆå¤šç‰¹æ®Šçš„éœ€æ±‚ï¼Œå®ƒæ˜¯å¾ˆæœ‰å¸®åŠ©çš„ä¸œè¥¿ï¼Œä½†æ˜¯Luaæœ‰ä¸€ä¸ªä¸¥æ ¼çš„è¦æ±‚ï¼Œæ¯”å¦‚è¯´ä½ åœ¨Redisä¸Šä½¿ç”¨çš„ä¸åˆç†ï¼Œä¸€äº›å†™è¶…æ—¶ä¼šé€ æˆéœ€è¦é‡å¯Redisè¿™æ ·ä¸€äº›é—®é¢˜ï¼Œä¸ªäººè®¤ä¸ºLuaåœ¨Redisä¸Šä½¿ç”¨æ˜¯ä¸€ä¸ªé¸¡è‚‹ï¼Œä½œä¸ºè¿ç»´äººå‘˜æ¥æˆ–è€…å¼€å‘äººå‘˜åœ¨ä½¿ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„å¾ˆå¤šé—®é¢˜ï¼š</p><ul><li>æ‰€æœ‰keyï¼Œå¿…é¡»åœ¨1ä¸ªslotä¸Šï¼Œå¦åˆ™ç›´æ¥è¿”å›errorï¼›</li><li>â€œ- ERR eval/evalsha command keys must in same slot\r\nâ€ï¼›</li></ul><p>å»ºè®®ä¸è¦è¿‡åˆ†å»ä½¿ç”¨Luaï¼Œå¦‚æœä½ çœŸçš„éœ€è¦å»è¿‡åˆ†ä½¿ç”¨å»ºè®®å•ç‹¬å»å¼€ä¸€ä¸ªRedisæ¥åšè¿™æ ·çš„äº‹æƒ…ï¼Œè€Œä¸”ä¸è¦ä½¿ç”¨é›†ç¾¤æ¥é™ä½Luaå¯¹Redisé€ æˆçš„å±å®³</p><h2 id="ã€å»ºè®®ã€‘å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨"><a href="#ã€å»ºè®®ã€‘å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨" class="headerlink" title="ã€å»ºè®®ã€‘å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨"></a>ã€å»ºè®®ã€‘å¿…è¦æƒ…å†µä¸‹ä½¿ç”¨monitorå‘½ä»¤æ—¶ï¼Œè¦æ³¨æ„ä¸è¦é•¿æ—¶é—´ä½¿ç”¨</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191105201307817.png" srcset="/img/loading.gif" alt="image-20191105201307817"></p><p>monitorå¯ä»¥å°†Redisçš„å‘½ä»¤å®æ—¶ç›‘æ§ï¼Œæ¯”å¦‚åƒRedisæ‰§è¡Œäº†å“ªäº›å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨monitorå‘½ä»¤è¿›è¡Œç›‘æ§ï¼Œè¿™æ ·çš„è¯å¯ä»¥ç›‘æ§æ˜¯å“ªä¸ªIPæ‰§è¡Œçš„ã€æ‰§è¡Œå“ªäº›å‘½ä»¤åœ¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œçš„ï¼Œä½†æ˜¯è¦æ³¨æ„ä¸€ä¸ªé—®é¢˜ï¼Œä¸Šé¢è¿™å¼ å›¾å°±æ˜¯Redis monitorçš„ä¸€ä¸ªæ¨¡å‹ï¼Œä»»ä½•å®¢æˆ·ç«¯åœ¨Redisæ‰§è¡Œå‘½ä»¤éƒ½ä¼šåŒæ­¥ç»™monitorå®¢æˆ·ç«¯ï¼Œå¦‚æœæˆ‘ä»¬å¹¶å‘é‡éå¸¸é«˜ï¼Œæ‰€æœ‰çš„å‘½ä»¤éƒ½æ‰“åˆ°monitorå®¢æˆ·ç«¯ä¸Šå°±ä¼šé€ æˆé—®é¢˜ï¼Œmonitorå‘½ä»¤å®ƒæ— æ³•å®æ—¶å»æ¶ˆè´¹æ‰€æœ‰å‘½ä»¤ï¼Œå°±ä¼šé€ æˆmonitorå®¢æˆ·ç«¯å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæ™®é€šçš„Rediså®¢æˆ·ç«¯çš„ä¸€ä¸ªè¾“å‡ºç¼“å†²åŒºï¼Œå®ƒçš„è¾“å‡ºç¼“å†²åŒºä¼šæš´å¢ï¼Œè¿™ä¸ªè¾“å…¥ç¼“å†²åŒºä¼šå ç”¨Redisçš„å†…å­˜ï¼Œä¹Ÿæ˜¯è¯´å®ƒå¯èƒ½ä¼šå°†Rediså†…å­˜æ’‘çˆ†ï¼Œæ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨è¿™æ ·çš„ä¸œè¥¿ï¼Œå¦‚æœä½ çœŸçš„è¦å»ä½¿ç”¨å®ƒï¼Œé‚£å»ºè®®å»çŸ­æ—¶é—´å»ä½¿ç”¨ï¼Œæ¯”å¦‚ä½ ä½¿ç”¨å‡ ç§’ã€ä¸€åˆ†é’Ÿï¼Œæœ€é‡è¦çš„æ˜¯ä½ è¦åœ¨æœ¬åœ°å»æ‰§è¡Œï¼Œè¿™æ ·å¯ä»¥æé«˜æˆ‘ä»¬å®¢æˆ·ç«¯æ¶ˆè´¹é€Ÿåº¦ä¸è‡³äºå‡ºç°å†…å­˜æš´å¢çš„æƒ…å†µã€‚</p><h1 id="å®¢æˆ·ç«¯ä¼˜åŒ–"><a href="#å®¢æˆ·ç«¯ä¼˜åŒ–" class="headerlink" title="å®¢æˆ·ç«¯ä¼˜åŒ–"></a>å®¢æˆ·ç«¯ä¼˜åŒ–</h1><blockquote><p>è¿™é‡Œä½¿ç”¨Javaå®¢æˆ·ç«¯æ¥è¿›è¡Œè¯´æ˜</p></blockquote><h2 id="æ¨è"><a href="#æ¨è" class="headerlink" title="æ¨è"></a>æ¨è</h2><p>é¿å…å¤šä¸ªåº”ç”¨ä½¿ç”¨ä¸€ä¸ªRediså®ä¾‹</p><p>å‡å¦‚ç°åœ¨æˆ‘ä¸šåŠ¡Aå’Œä¸šåŠ¡Bï¼Œç„¶åç°åœ¨æœ‰ä¸€ä¸ªRedisï¼Œä¸šåŠ¡Aä½¿ç”¨Redisï¼Œä¸šåŠ¡ä¹Ÿç”¨Redisï¼Œç°åœ¨ä»–ä»¬ç”¨åŒä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ ·æœ‰å‡ ä¸ªé—®é¢˜ï¼š</p><ol><li>å¯èƒ½ä¼šé€ æˆkeyå†²çªï¼›</li><li>Redisæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ï¼Œä¸šåŠ¡Aä¸­æ…¢çš„æ“ä½œä¼šå½±å“åˆ°ä¸šåŠ¡B</li></ol><p>æ­£ä¾‹ï¼šä¸ç›¸å¹²çš„ä¸šåŠ¡æ‹†åˆ†ï¼Œåƒåˆšæ‰é‚£2ä¸ªä¸šåŠ¡Aå’ŒBå…¶å®2ä¸ªä¸šåŠ¡æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œé‚£æˆ‘å…¶å®å°±ä¸éœ€è¦ç”¨åŒä¸€ä¸ªRedisï¼Œè¿˜æœ‰ä¸€ç§å¯èƒ½ï¼šä¸å»ç”¨å¤šä¸ªæ•°æ®åº“ï¼Œè€Œæ˜¯ç”¨å¤šä¸ªå®ä¾‹ï¼Œæ¯”å¦‚å¯ä»¥å¼€æ›´å¤šçš„Redisï¼Œå› ä¸ºRedisæ˜¯å•çº¿ç¨‹çš„ï¼Œæˆ‘ä»¬ä¼šåœ¨ä¸€ä¸ªæœºå™¨ä¸Šå»å¼€å¤šä¸ªRediså®ä¾‹ï¼Œè®©Rediså»å……åˆ†åˆ©ç”¨å¥½å¤šä¸ªæœåŠ¡å™¨ä¸Šçš„å¤šæ ¸ï¼Œè¿™æ ·å°±ä¼šæœ‰æ›´å¥½çš„ä¼˜åŠ¿ä¸šåŠ¡ä¸ä¸šåŠ¡ä¹‹é—´ä¸ä¼šå—åˆ°å¹²æ‰°ï¼Œå½“ç„¶è¿™é‡Œè¿˜æœ‰å°±æ˜¯å…¬å…±çš„æ•°æ®è¦åšæœåŠ¡åŒ–ï¼Œå‡å¦‚ç°åœ¨æœ‰10ä¸ªä¸šåŠ¡å…¨éƒ½ç”¨åˆ°å…¬å…±ä¿¡æ¯ï¼Œè¿™é‡Œä»¥ä¸€ä¸ªè§†é¢‘ç½‘ç«™ï¼Œæ¯”å¦‚è¯´ä¼˜é…·ã€çˆ±å¥‡è‰ºéƒ½æœ‰ä¸€äº›è§†é¢‘ä¿¡æ¯ï¼Œè§†é¢‘ä¿¡æ¯å°±æ˜¯è¿™äº›ç½‘ç«™çš„å…¬å…±æ•°æ®ï¼ŒåŸºæœ¬æ˜¯ä½ åšä»»ä½•ä¸šåŠ¡éƒ½ç¦»ä¸å¼€è¿™æ ·çš„å…¬å…±æ•°æ®ï¼Œè¿™æ ·çš„å…¬å…±æ•°æ®æˆ‘ä»¬ä¸å¯èƒ½å°†å®ƒå»å­˜åœ¨ä¸€ä¸ªRediså®ä¾‹æˆ–è€…MySQLå®ä¾‹ä¸­ï¼Œæœ‰å¯èƒ½ä¼šå­˜ï¼Œä½†å¯¹äºè¿™ç§æ–¹å¼æˆ‘ä»¬ä¸å¯èƒ½è®©æ¯ä¸€ä¸ªä¸šåŠ¡éƒ½å»è°ƒMySQLã€Rediså®ä¾‹ï¼Œè€Œæ˜¯è¯´æˆ‘ä»¬åšæ›´å¥½çš„æ˜¯åšä¸€ä¸ªå…¬å…±çš„æœåŠ¡ï¼Œåƒç°åœ¨è¯´çš„å¾®æœåŠ¡ã€æœåŠ¡è¯çš„åè¯ï¼Œè¿™é‡Œè‡³äºæœåŠ¡çš„åº•å±‚ç”¨çš„æ˜¯Redisè¿˜æ˜¯MySQLå­˜å‚¨çš„è¿™ä¸ªæ˜¯ä½ è‡ªå·±çš„äº‹æƒ…ï¼Œå¯¹äºå¤šä¸ªä¸šåŠ¡ä½¿ç”¨åŒä¸€ä¸ªæ•°æ®çš„æ—¶å€™æ˜¯é€šè¿‡åƒä¸€äº›httpæ¥å£ã€å…¶ä»–åè®®çš„æ¥å£æ¥å¯¹å¤–æä¾›æœåŠ¡ï¼Œè¿™æ ·çš„è¯ä¸ä¼šRediså®ä¾‹è¿›è¡Œå¹²æ‰°ï¼Œå› ä¸ºè¿™ä»½å…¬å…±æ•°æ®å…¨éƒ¨ä¼šåœ¨ä¸€ä¸ªæ¯”è¾ƒæƒå¨çš„é¡¹ç›®æˆ–è€…ç»„å†…ï¼Œç„¶åå®ƒå¯¹å¤–æä¾›çš„æ˜¯ä¸€ä¸ªå…¬å…±çš„æ•°æ®æœåŠ¡</p><hr><p>åœ¨ä½¿ç”¨Javaå®¢æˆ·ç«¯æˆ–è€…å…¶ä»–å®¢æˆ·ç«¯çš„æ—¶å€™å»ºè®®å»ä½¿ç”¨è¿æ¥æ± ï¼Œå…¶å®è¿æ¥æ—¶æœ‰ä¸€ä¸ªæ ‡å‡†çš„ä½¿ç”¨æ–¹å¼ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191105203315653.png" srcset="/img/loading.gif" alt="image-20191105203315653"></p><p>åœ¨try-catch-finallyå¤–é¢å»å®šä¹‰Jediså¯¹è±¡ï¼ŒJediså¯¹è±¡å»é€šè¿‡JedisPoolè¿™ä¸ªè¿æ¥æ± å»è·å–è¿æ¥ï¼Œç„¶åå»æ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ï¼Œåœ¨catché‡Œé¢å»æ•è·å¼‚å¸¸ï¼Œæ•è·å¼‚å¸¸è¦æ³¨æ„ä¸€ä¸ªç‚¹ï¼šå‡å¦‚ä½ ç°åœ¨æ“ä½œä¸€ä¸ªå‘½ä»¤ï¼Œæ‰§è¡Œè¿™ä¸ªå‘½ä»¤ä¼šæœ‰keyï¼Œè¿™é‡Œåœ¨å¼‚å¸¸ä¸­æ‰“å°å‡ºæ¥ï¼Œç„¶åå†åŠ ä¸Šå¼‚å¸¸å¼‚å¸¸ï¼Œåœ¨finallyä¸­å»å…³é—­Jedisè¿æ¥ï¼Œè¿™é‡Œçš„å…³é—­ä¸æ˜¯è¯´å…³é—­è¿æ¥ï¼Œå¦‚æœå…³é—­è¿æ¥å…¶å®ä½¿ç”¨è¿æ¥æ± å°±æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºä½¿ç”¨è¿æ¥æ± å°±æ˜¯ä¸ºäº†ä½¿ç”¨é•¿è¿æ¥ï¼Œè¿™æ ·çš„è¯ä¼šå‡å°‘æ¯æ¬¡tcpä¸‰æ¬¡æ¡æ‰‹ï¼Œå®ƒå¹¶ä¸ä¼šçœŸçš„è¿›è¡Œå…³é—­ï¼Œå®ƒä¼šåœ¨JedisPoolæ¨¡å¼ï¼Œæ¯”å¦‚è¯´ä½ ç°åœ¨ä½¿ç”¨JedisPoolä¸­è·å–çš„è¿æ¥ï¼Œå®ƒä¼šæŠŠJedisçš„è¿æ¥å½’è¿˜ç»™è¿æ¥æ± ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¼šåˆ¤æ–­ä½ çš„è¿æ¥æ˜¯ä»è¿æ¥æ± å–å‡ºæ¥çš„è¿˜æ˜¯æ™®é€šå®ä¾‹åŒ–å‡ºæ¥çš„è¿æ¥ï¼Œå¦‚æœå®ä¾‹åŒ–çš„è¿æ¥å®ƒä¼šå¯¹å®ƒè¿›è¡Œå…³é—­å¤„ç†ï¼›</p><p>é‚£ä¹ˆè¯´äº†è¿™ä¹ˆå¤šï¼Œè¿™ä¹ˆåšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</p><ul><li>å¯¹äºæ•è·å¼‚å¸¸æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨Jedisè·å–è¿æ¥ã€æ‰§è¡Œå‘½ä»¤çš„æ—¶å€™éƒ½å¯ä»¥æ•è·åˆ°å®ƒçš„å¼‚å¸¸ï¼›</li><li>å¼‚å¸¸çš„æ—¶å€™èƒ½æ‰“å°å‡ºå®ƒçš„keyï¼Œå¯ä»¥åˆ¤æ–­å‡ºè¿™ä¸ªkeyå¯¹åº”çš„èŠ‚ç‚¹ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯RedisClusterï¼Œå¦‚æœä¸æ‰“å°å‡ºæ¥å®ƒè¿æ¥çš„åœ°å€å‰æä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥æ‰“å°keyï¼Œé€šè¿‡keyæ¥çŸ¥é“å¯¹åº”çš„IPå’Œç«¯å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡redis-cliè·å–åˆ°å®ƒçš„hostï¼›</li><li>é€šè¿‡å¼‚å¸¸çš„æ•è·è¿˜å¯ä»¥åšå…¶ä»–çš„äº‹æƒ…ï¼Œæ¯”å¦‚åƒlog4jè¿™æ ·çš„ä¸œè¥¿ï¼Œç„¶åå»å†™ä¸€äº›appendï¼Œè¿™ä¸ªappendåªæ”¶é›†æƒ³Redisçš„é—®é¢˜ï¼Œè¿™æ ·å°±å¯ä»¥é’ˆå¯¹Jedisæ¥åšå¾ˆå¤šç‹¬ç«‹çš„ç»Ÿè®¡ï¼Œæ¯”å¦‚ç»Ÿè®¡ä¸€åˆ†é’Ÿå†…å‘ç”Ÿå¤šå°‘å¼‚å¸¸ï¼Œæ¯ç§å¼‚å¸¸çš„ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿ</li></ul><h2 id="è¿æ¥æ± å‚æ•°è¯´æ˜"><a href="#è¿æ¥æ± å‚æ•°è¯´æ˜" class="headerlink" title="è¿æ¥æ± å‚æ•°è¯´æ˜"></a>è¿æ¥æ± å‚æ•°è¯´æ˜</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191105204618121.png" srcset="/img/loading.gif" alt="image-20191105204618121"></p><h2 id="å¦‚ä½•é¢„ä¼°æœ€å¤§è¿æ¥æ± "><a href="#å¦‚ä½•é¢„ä¼°æœ€å¤§è¿æ¥æ± " class="headerlink" title="å¦‚ä½•é¢„ä¼°æœ€å¤§è¿æ¥æ± "></a>å¦‚ä½•é¢„ä¼°æœ€å¤§è¿æ¥æ± </h2><p>å¯¹äºè¿æ¥æ± ï¼Œæœ€é‡è¦çš„å‚æ•°æ˜¯maxTotalï¼Œå®ƒå€¼çš„æ˜¯æœ€å¤§è¿æ¥æ•°æ˜¯å¤šå°‘ï¼Œè¿™ä¸ªæ˜¯éå¸¸æœ‰è®²ç©¶çš„ï¼Œæˆ‘ä»çº¿ä¸Šæ¥çœ‹ï¼Œä¹‹å‰ç»´æŠ¤çš„ä¸šåŠ¡åŒ…æ‹¬æˆ‘äº†è§£çš„ä¸šåŠ¡ä¹Ÿæ¯”è¾ƒå¤šï¼Œå‘ç°è¿™ä¸ªé…ç½®åƒå¥‡ç™¾æ€ªï¼Œæ¯ä¸ªäººçš„é…ç½®éƒ½æœ‰ä¸åŒçš„ç†è§£ï¼Œç”šè‡³å¾ˆå¤šå…¶ä»–é…ç½®ï¼Œæœ‰äººé…ç½®å‡ åƒç”šè‡³ä¸Šä¸‡éƒ½è§è¿‡ï¼Œä½†æ˜¯åœ¨ä½ ä¸æ‡‚å®ƒçš„å«ä¹‰çš„ä¹‹å‰æˆ–è€…è¯´ä¸ä½ ä¸ç†è§£å»é¢„ä¼°å‚æ•°ä¹‹å‰ï¼Œè¿™äº›è®¾ç½®éƒ½æ˜¯æ²¡æœ‰ä»»ä½•é“ç†çš„ï¼Œé‚£ä¹ˆmaxTotalæ€ä¹ˆå»è®¾ç½®å‘¢ï¼Ÿè¿™é‡Œå»ºè®®ä½ å°†maxIdleå’ŒmaxTotalæ¥è¿‘ï¼Œæˆ‘ä»¬çš„æœ€å¤§ç©ºé—²æ•°å’Œæœ€å¤§è¿æ¥æ•°æ˜¯ä¸€æ ·çš„ï¼Œè¿™æ ·æ˜¯ä»€ä¹ˆç›®çš„å‘¢ï¼Ÿå…¶å®ä¸»è¦ä¸ºäº†é˜²æ­¢maxIdleåˆ°MaxTotalå®ƒä»¬ç›¸å·®çš„æœŸé—´ï¼Œåˆ›å»ºæ–°çš„è¿æ¥ï¼Œå½“åˆ›å»ºæ–°çš„è¿æ¥å°±æ˜¯ç±»ä¼¼ç­‰å¾…çš„æ•ˆæœï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸ä¸å¥½çš„æ‰‹æ®µï¼›</p><p>æ¥çœ‹ä¸‹maxTotalè€ƒè™‘çš„å› ç´ ï¼š</p><ul><li>ä¸šåŠ¡å¸Œæœ›Rediså¹¶å‘é‡ï¼šè¿™ä¸ªæ˜¯æŒ‡çš„æ˜¯ä¸šåŠ¡ç«¯ï¼Œä¸šåŠ¡ç«¯å¸Œæœ›Rediså¹¶å‘é‡æ˜¯å¤šå°‘ï¼Œæ¯”å¦‚æˆ‘å¹¶å‘é‡æ˜¯1Wã€10Wï¼Œä½ å¯ä»¥ç”¨æœ€ç®€å•æœ€ç›´ç™½çš„æƒ³æ³•å»æƒ³ï¼Œé‚£å…¶å®æˆ‘çš„maxTotalæ˜¯å’Œå¹¶å‘é‡æœ‰å…³ï¼Œå¹¶å‘é‡è¶Šä½åœ¨ä¸€ç¬é—´å»éœ€è¦çš„è¿æ¥æ•°æ—¶è¶Šå°çš„ï¼Œä½ çš„å¹¶å‘é‡è¶Šå°ï¼Œé‚£éœ€è¦maxTotalè¶Šå°ï¼Œå¹¶å‘é‡è¶Šå¤§éœ€è¦çš„å°±è¶Šå¤§ï¼›</li><li>å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ—¶é—´ï¼šç°åœ¨maxTotalä¸º8ï¼Œé‚£ç°åœ¨æˆ‘çš„å®¢æˆ·ç«¯å¹³å‡æ—¶é—´éƒ½åœ¨2ç§’ï¼Œå°±æ˜¯è¯´æ¯ä¸ªå‘½ä»¤éƒ½è¦æ‰§è¡Œ2ç§’ï¼Œæˆ‘è¿™ä¸€ç¬é—´8ä¸ªè¿æ¥éƒ½ä¼šè¢«å ç”¨ï¼Œä¸‹ä¸€æ¬¡æœ‰ä¸ªè®¿é—®éƒ½è¦ç­‰2ç§’ä»¥åæ‰èƒ½è·å–åˆ°ï¼Œè¿™è¿™è¦çœ‹ä½ çš„éœ€æ±‚äº†ï¼Œä½ çš„å‘½ä»¤çš„æ—¶é—´è¶Šå°é‚£å¯èƒ½éœ€è¦çš„maxTotalå°±è¶Šå°ï¼›</li><li>Redisèµ„æºï¼šä¾‹å¦‚nodeï¼ˆåº”ç”¨ä¸ªæ•°ï¼‰ * maxTotalä¸èƒ½è¶…è¿‡Redisæœ€å¤§è¿æ¥æ•°ï¼šä½ çš„åº”ç”¨æ€»æ•°å’Œä½ çš„maxTotalè¶…è¿‡Redisæœ€å¤§è¿æ¥æ•°äº†ï¼ŒRediså¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå‡å¦‚æœ‰1Wä¸ªè¿æ¥ï¼Œå¯èƒ½ä½ åº”ç”¨ä¸ªæ•°æœ‰100ä¸ªï¼Œä½ çš„maxTotalæ˜¯ä¸æ˜¯è¶…è¿‡100çš„ï¼Œå¦åˆ™ä½ è¾¾åˆ°RedisæœåŠ¡ç«¯çš„æœ€å¤§è¿æ¥æ•°ï¼›</li><li>èµ„æºå¼€é”€ï¼šä¾‹å¦‚è™½ç„¶å¸Œæœ›æ§åˆ¶ç©ºé—²è¿æ¥ï¼Œä½†æ˜¯ä¸å¸Œæœ›å› ä¸ºè¿æ¥æ± çš„é¢‘ç¹é‡Šæ”¾åˆ›å»ºè¿æ¥é€ æˆä¸å¿…è¦çš„å¼€é”€ã€‚</li></ul><p>ä¸€ä¸ªä¾‹å­ï¼š</p><blockquote><p>è¿™é‡Œé€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¿›è¡Œäº†è§£</p></blockquote><p>æˆ‘ç°åœ¨è¿™ä¸ªä¸šåŠ¡é‡Œæ¯ä¸€æ¬¡çš„å‘½ä»¤å°±æ˜¯åƒborrow ã€returnã€resourceä»æ± å­å»ï¼Œä»æ± å­é‡Œè¿˜æ¥å»æ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œå‘½ä»¤è¿˜åŒ…æ‹¬ç½‘ç»œæ—¶é—´ï¼Œå‘½ä»¤æ˜¯é€šè¿‡ç½‘ç»œå‘é€ç»™Redisçš„ï¼Œå‡è®¾æˆ‘ä»¬å½“å‰çš„å¹³å‡è€—æ—¶ä¸º1æ¯«ç§’ï¼Œé‚£å°±è¯´æˆ‘è¿™ä¸€ä¸ªè¿æ¥çš„QPSå¯ä»¥åˆ°1000ï¼Œé‚£æˆ‘ç°åœ¨æœ‰ä¸šåŠ¡å¸Œæœ›QPSæ˜¯5Wï¼Œè¿™é‡Œå¾ˆç®€å•çš„ç®—æ³•ï¼š<code>maxTotal = 5W / 1000 = 50ä¸ª</code>ï¼Œ50ä¸ªå°±å¯ä»¥è¾¾åˆ°é¢„æœŸ5Wçš„æ•ˆæœï¼Œè™½ç„¶è¿™åªæ˜¯ä¸€ä¸ªç†æƒ³çš„å€¼ï¼Œä½†æ˜¯è¿™ä¸ªå€¼æ˜¯æœ‰å‚è€ƒæ„ä¹‰çš„ï¼Œè¿™æ ·çš„è¯ä½ å¯ä»¥åœ¨å®é™…ä½¿ç”¨ä¸­é€‚å½“çš„å»æ”¾å¤§å’Œç¼©å°ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨75ä¸ªã€100ä¸ªè™½ç„¶å»è®¾ç½®ä¸€ä¸ªå€¼æ ¹æ®ä½ çš„æƒ³æ³•æ¥è®¾ç½®ï¼Œä½†æ˜¯è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒéš¾çš„åœ°æ–¹ï¼Œä½ è¦æ¸…æ¥šä¸¤ç‚¹ï¼š</p><ul><li>æ¸…æ¥šå‘½ä»¤çš„å¹³å‡è€—æ—¶ï¼Œè¿™ä¸ªæ˜¯è¦åšå¾ˆå¤šæ—¶é—´çš„ï¼Œæ¯”å¦‚è¯´ä½ è¦é€šè¿‡å„ç§æ‰‹æ®µçŸ¥é“å‘½ä»¤çš„å¹³å‡è€—æ—¶æ˜¯å¤šå°‘ï¼Œæ³¨æ„è¿™é‡Œçš„è€—æ—¶æ˜¯å®¢æˆ·ç«¯çš„è€—æ—¶æ—¶é—´ï¼Œå¹¶ä¸æ˜¯RedisæœåŠ¡ç«¯ç»Ÿè®¡å‡ºæ¥çš„æ—¶é—´ï¼›</li><li>ä½ éœ€è¦çŸ¥é“ä¸šåŠ¡å¹¶å‘é‡æ˜¯å¤šå°‘ï¼Œå°±æ˜¯Rediså¹¶å‘é‡æ˜¯å¤šå°‘</li></ul><p>è¿™é‡Œä»‹ç»çš„ä¾ç„¶æ˜¯ä¸€ä¸ªç†è®ºçŸ¥è¯†ï¼Œç†è®ºçŸ¥è¯†æ€ä¹ˆå»ç”¨å‘¢ï¼Ÿå®é™…ä¸­å°±æŒ‰è¿™ä¸ªæ¥è®¾ç½®å°±å¥½äº†ï¼Œä½†æ˜¯åœ¨è¿™é‡Œéœ€è¦ç›‘æ§å¾ˆå¤šä¸œè¥¿ï¼Œæ¯”å¦‚ç›‘æ§å‰é¢æåˆ°çš„å½“å‰è¿æ¥æ•°ã€æ¯æ¬¡getResourceéœ€è¦çš„æ—¶é—´ã€è¿˜ç»™æ± å­çš„æ—¶é—´ã€å½“å‰çš„æ€»æ•°ï¼Œè¿™äº›éƒ½æ˜¯è¦å»è¿›è¡Œç›‘æ§çš„ï¼Œæœ‰ä¸€ä¸ªå›¾æˆ–è€…ä¸€ä¸ªé¢„è­¦ï¼Œè¿™äº›ä¸œè¥¿éœ€è¦åšä¸€ä¸ªé•¿æœŸçš„å‡çº§ï¼Œç„¶åå°±èƒ½çŸ¥é“å½“å‰çš„å¹³å‡è€—æ—¶æ˜¯å¤šå°‘ï¼Œæˆ‘ä»¬ä»çº¿ä¸Šå¯ä»¥çœ‹åˆ°æˆ‘ä»¬å¹¶ä¸æ˜¯è¯´ç†è®ºè¿™æ ·è®¾ç½®50ä¸ªçº¿ä¸Šå°±å»è®¾ç½®50ä¸ªï¼Œè€Œæ˜¯é€šè¿‡é¢„æœŸçš„è®¾ç½®å»è§‚å¯Ÿçº¿ä¸Šæ˜¯å¦æœ‰å‡ºç°è¿æ¥æ± è€—æ»¡çš„é—®é¢˜ï¼Œæˆ‘ä»¬è¦æœ‰è¿™æ ·çš„åŸºç¡€ï¼Œä½†æ˜¯å®é™…ç”Ÿäº§ä¸­æˆ‘ä»¬è¦é€šè¿‡å¯¹çº¿ä¸Šçš„è§‚å¯Ÿæ¥è·å–ï¼Œè§‚å¯Ÿä¸æ˜¯è¯´ç”¨è‚‰çœ¼å»çœ‹ï¼Œè€Œæ˜¯é€šè¿‡å„æ–¹é¢çš„æ•°æ®æ”¶é›†æ¥æ”¯æ’‘ã€‚</p>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 12.å¸ƒéš†è¿‡æ»¤å™¨.md</title>
    <link href="/redis-12.html"/>
    <url>/redis-12.html</url>
    
    <content type="html"><![CDATA[<h1 id="å¼•å‡ºå¸ƒéš†è¿‡æ»¤å™¨"><a href="#å¼•å‡ºå¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="å¼•å‡ºå¸ƒéš†è¿‡æ»¤å™¨"></a>å¼•å‡ºå¸ƒéš†è¿‡æ»¤å™¨</h1><p>ç°æœ‰50äº¿ä¹™ä¸ªç”µè¯å·ç ,ç°æœ‰10ä¸‡ä¸ªç”µè¯å·ç ,è¦==å¿«é€Ÿå‡†ç¡®==åˆ¤æ–­è¿™äº›ç”µè¯å·<br>ç æ˜¯å¦å·²ç»å­˜åœ¨?å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬åŸç†ï¼Œçœ‹çœ‹è¿™äº›è§£å†³æ–¹æ¡ˆï¼š</p><ol><li>é€šè¿‡æ•°æ®åº“æŸ¥è¯¢ï¼šå®ç°å¿«é€Ÿæœ‰ç‚¹éš¾ï¼›</li><li>æ•°æ®é¢„æ”¾åœ¨é›†åˆä¸­ï¼š50äº¿*8å­—èŠ‚â‰ˆ40GBï¼ˆå†…å­˜æµªè´¹æˆ–ä¸å¤Ÿï¼‰ï¼›</li><li>hyperloglogï¼šå‡†ç¡®æœ‰ç‚¹éš¾ã€‚</li></ol><p>ä»¥ä¸Šçš„æ–¹å¼éƒ½æ˜¯æ— æ³•å®ç°éœ€æ±‚çš„ï¼Œä¸Šè¿°çš„åº”ç”¨åœºæ™¯åœ¨å¾ˆå¤šåœ°æ–¹éƒ½æœ‰é‡åˆ°ï¼š</p><ul><li>åƒåœ¾é‚®ä»¶è¿‡æ»¤ï¼šç°åœ¨æœ‰å‡ äº¿å°åƒåœ¾é‚®ä»¶ï¼Œåœ¨è¿™ç§æƒ…å†µæˆ‘è®¤ä¸ºå®ƒæ˜¯åƒåœ¾é‚®ä»¶ï¼Œç°åœ¨æˆ‘æ¥äº†ä¸€å°æ–°çš„æˆ‘æ€ä¹ˆå»åˆ¤æ–­å‘¢ï¼Ÿç°åœ¨å°±ä¸å»è€ƒè™‘ä¸€ä¸ªæ”¶ä»¶äººä¸€ä¸ªç‰¹å¾æ¥åˆ¤æ–­å®ƒæ˜¯å¦åœ¨åƒåœ¾é‚®ä»¶è¿™ä¸ªå¤§çš„é›†åˆå½“ä¸­å‘¢ï¼Ÿ</li><li>æ–‡å­—å¤„ç†ï¼ˆä¾‹å¦‚wordï¼‰é”™è¯¯å•è¯æ£€æµ‹ï¼›</li><li>ç½‘ç»œçˆ¬è™«é‡å¤URLæ£€æµ‹ï¼šåœ¨æŠ“çš„æ—¶å€™æœ‰äº›URLæ˜¯é‡å¤çš„ï¼Œä¸ºäº†é˜²æ­¢é‡å¤çš„æŠ“å–ï¼Œå®ƒè¦åšä¸€ä¸ªæ˜¯å¦åœ¨è¿™ä¸ªå·²æŠ“çš„è¿™ä¸ªURLé›†åˆä¸­ï¼Ÿå®ƒä¹Ÿè¦åšä¸€ä¸ªåˆ¤æ–­ï¼Œè¿™é‡Œå°±éœ€è¦ç”¨å¸ƒéš†è¿‡æ»¤å™¨è§£å†³è¿™ä¸ªé—®é¢˜ï¼›</li><li>Hbaseè¡Œè¿‡æ»¤ï¼šä¹Ÿéœ€è¦ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨æ¥è§£å†³ã€‚</li></ul><h1 id="å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬åŸç†"><a href="#å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬åŸç†" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬åŸç†"></a>å¸ƒéš†è¿‡æ»¤å™¨åŸºæœ¬åŸç†</h1><ul><li>1970å¹´ä¼¯é¡¿.å¸ƒéš†æå‡ºï¼Œç”¨å¾ˆå°çš„ç©ºé—´ï¼Œè§£å†³ä¸Šè¿°ç±»ä¼¼é—®é¢˜ï¼›</li><li>å®ç°åŸç†ï¼šä¸€ä¸ªå¾ˆé•¿çš„äºŒè¿›åˆ¶å‘é‡å’Œè‹¥å¹²ä¸ªå“ˆå¸Œå‡½æ•°ã€‚<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191103210029972.png" srcset="/img/loading.gif" alt="image-20191103210029972"></li><li>å‚æ•°ï¼šmä¸ªäºŒè¿›åˆ¶å‘é‡ï¼ˆä¸Šé¢çš„0 1 æ•°ç»„ï¼‰ï¼Œnä¸ªé¢„å¤‡æ•°æ®ï¼ˆ50äº¿ä¸ªç”µè¯å·ç ï¼‰ï¼Œkä¸ªhashå‡½æ•°ï¼ˆä¸Šé¢çš„f1-f8 ä½ éœ€è¦å¤šå°‘ä¸ªï¼Œè¿™ä¸ªå¯ä»¥è®¾ç½®ï¼‰ï¼›</li><li>æ„å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼šnä¸ªé¢„å¤‡æ•°æ®èµ°ä¸€éä¸Šé¢è¿‡ç¨‹ï¼šæ¯ä¸€ä¸ªæ•°æ®èµ°ä¸€éf1-f8æŠŠå¯¹åº”çš„å‘é‡çš„å€¼è®¾ç½®ä¸º1ï¼›</li><li>åˆ¤æ–­å…ƒç´ å­˜åœ¨ï¼šèµ°ä¸€éä¸Šé¢è¿‡ç¨‹ï¼šåˆ¤æ–­è¿‡ç¨‹æ˜¯ä¸æ˜¯1ï¼Œå¦‚æœéƒ½æ˜¯1ï¼Œåˆ™åœ¨è¡¨æ˜å­˜åœ¨ï¼Œåä¹‹ä¸å­˜åœ¨ã€‚</li></ul><h1 id="å¸ƒéš†è¿‡æ»¤å™¨è¯¯å·®ç‡"><a href="#å¸ƒéš†è¿‡æ»¤å™¨è¯¯å·®ç‡" class="headerlink" title="å¸ƒéš†è¿‡æ»¤å™¨è¯¯å·®ç‡"></a>å¸ƒéš†è¿‡æ»¤å™¨è¯¯å·®ç‡</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191103211924442.png" srcset="/img/loading.gif" alt="image-20191103211924442"></p><h1 id="æœ¬åœ°å¸ƒéš†è¿‡æ»¤"><a href="#æœ¬åœ°å¸ƒéš†è¿‡æ»¤" class="headerlink" title="æœ¬åœ°å¸ƒéš†è¿‡æ»¤"></a>æœ¬åœ°å¸ƒéš†è¿‡æ»¤</h1><ul><li><p>ç°æœ‰åº“ï¼šguavaï¼›</p></li><li><p>æœ¬åœ°å¸ƒéš†è¿‡æ»¤å™¨çš„é—®é¢˜ï¼š</p><ul><li><p>å®¹é‡å—é™åˆ¶ï¼šå—é™äºå®¹å™¨ï¼Œå‡å¦‚å®¹å™¨æ˜¯ä¸€ä¸ªJVMæˆ–è€…ä½ ä½¿ç”¨çš„æ˜¯Tomcatè¿™æ ·çš„Webå®¹å™¨å®ƒå®é™…ä¸Šä¹Ÿæ˜¯JVM,é‚£ä¹ˆå°±ä¼šå—åˆ°JVMçš„é™åˆ¶ï¼Œå°±åŒ…æ‹¬ä¹‹å‰æåˆ°çš„ä½ ä½¿ç”¨é›†åˆçš„è¯ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨è¿˜æ˜¯éœ€è¦å¾ˆå¤šå†…å­˜çš„ï¼Œå‡å¦‚næ¯”è¾ƒå¤§ï¼Œè€Œä¸”ä½ å¸Œæœ›çš„è¯¯å·®ç‡æ¯”è¾ƒä½ï¼Œå¯¹äºMè¦æ±‚å°±æ¯”è¾ƒå¤§ï¼ŒåŒæ—¶è¿˜ä¼šæ¶‰åŠåˆ°å•æœº</p></li><li><p>å¤šä¸ªåº”ç”¨å­˜åœ¨å¤šä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œæ„å»ºåŒæ­¥å¤æ‚ã€‚<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/image-20191103214303958.png" srcset="/img/loading.gif" alt="image-20191103214303958"></p><p>å‡å¦‚è¿™é‡Œcontainer1éœ€è¦å‘å¸ƒéš†è¿‡æ»¤å™¨æ’å…¥ä¸€äº›ä¸œè¥¿ï¼Œç”±äºä¸šåŠ¡é€»è¾‘ï¼Œç„¶åcontainer2å»å¾€å¸ƒéš†è¿‡æ»¤å™¨æ’ä¸€äº›ä¸œè¥¿ï¼Œä½†container1ä¸­çš„å’Œcontainer2ä¸­çš„è¿™æ ·çš„å¸ƒéš†è¿‡æ»¤å™¨æ˜¯æ²¡æ³•å®ç°åŒæ­¥çš„ï¼Œä¹‹åå¯èƒ½æ¶‰åŠåˆ°ä¸€äº›ä¸šåŠ¡é€»è¾‘çš„æ—¶å€™ï¼Œå°¤å…¶ä¸€äº›å‰ç«¯ä¸šåŠ¡é€»è¾‘ï¼Œå‰ç«¯è®¿é—®çš„æ—¶å€™ï¼Œå®ƒå¯èƒ½åšäº†ä¸€äº›è´Ÿè½½å‡è¡¡ï¼Œå®ƒä¸ä¿è¯å…¨éƒ¨éƒ½åœ¨container1ï¼Œå®ƒå¯èƒ½è¿˜ä¼šå»container2ï¼Œåœ¨å¸ƒéš†è¿‡æ»¤å™¨æ²¡æœ‰è¿™æ ·çš„æ¦‚å¿µã€‚</p></li></ul></li></ul><h1 id="Rediså•æœºå¸ƒéš†è¿‡æ»¤å™¨"><a href="#Rediså•æœºå¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="Rediså•æœºå¸ƒéš†è¿‡æ»¤å™¨"></a>Rediså•æœºå¸ƒéš†è¿‡æ»¤å™¨</h1><blockquote><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p></blockquote><h1 id="Redisåˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨"><a href="#Redisåˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨" class="headerlink" title="Redisåˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨"></a>Redisåˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨</h1><blockquote><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 11.Redisäº‘å¹³å°CacheCloud.md</title>
    <link href="/redis-11.html"/>
    <url>/redis-11.html</url>
    
    <content type="html"><![CDATA[<h1 id="Redisè§„æ¨¡åŒ–è¿ç»´å›°æ‰°"><a href="#Redisè§„æ¨¡åŒ–è¿ç»´å›°æ‰°" class="headerlink" title="Redisè§„æ¨¡åŒ–è¿ç»´å›°æ‰°"></a>Redisè§„æ¨¡åŒ–è¿ç»´å›°æ‰°</h1><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><p>å½“é›†ç¾¤æ•°é‡å¤šçš„æ—¶å€™å°±ä¼šé‡åˆ°å¾ˆå¤šé—®é¢˜</p><ul><li>å‘å¸ƒæ„å»ºç¹çï¼Œç§æ­ä¹±ç›–ï¼šä½ å¯èƒ½ä¼šæ‰¾å‡ å°æœºå™¨è¿›è¡Œé›†ç¾¤çš„å®‰è£…æˆ–è€…å•æœºå®‰è£…ã€Sentinelå®‰è£…ï¼Œç„¶åéšä¾¿è®°å½•ä¸€ä¸‹æ–‡æ¡£å®¢æˆ·ç«¯å°±å¯ä»¥è°ƒç”¨äº†ï¼Œè¿™ä¸ªå±äºä¸€ä¸ªç§æ­ä¹±ç›–çš„æƒ…å†µï¼Œå½“æœ‰å‡ ç™¾å°æœºå™¨ã€ä¸Šåƒä¸Šä¸‡å°çš„æ—¶å€™ï¼Œä½ æ€ä¹ˆå¯èƒ½è®°å¾—åœ¨æŸå°æœºå™¨å®‰è£…äº†ä¸€ä¸ªé›†ç¾¤å‘¢ï¼Ÿä½•å†µé›†ç¾¤ä¹‹é—´æœ¬èº«å°±å‘ç”Ÿé«˜å¯ç”¨çš„åˆ‡æ¢ï¼Œæœ¬èº«å¯¹äºè¿™ç§åœºæ™¯å»ç®¡ç†å»ä½¿ç”¨éå¸¸çš„æ··ä¹±ã€‚å½“åˆ°äº†ä¸€å®šé‡çš„æ—¶å€™å¿…ç„¶ä¼šå‡ºç°é—®é¢˜ï¼›</li><li>èŠ‚ç‚¹å’Œæœºå™¨ç­‰è¿ç»´æˆæœ¬ï¼šæ— æ³•å¯¹æœºå™¨å’ŒèŠ‚ç‚¹çš„å…³ç³»åˆç†çš„ç®¡ç†ï¼Œå¿…ç„¶ä¼šé€ æˆæµªè´¹çš„æƒ…å†µï¼Œä¸€äº›æœºå™¨å¯èƒ½ä¼šé—²ç½®ï¼›</li><li>ç›‘æ§æŠ¥è­¦åˆçº§ï¼šç”¨ä¸€äº›å·¥å…·å¯ä»¥å®ç°å¯¹RedisèŠ‚ç‚¹çš„ä½¿ç”¨çŠ¶å†µè¿›è¡Œç›‘æ§ï¼ŒRedisè™½ç„¶æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„æ•°æ®åº“ï¼Œä½†å®ƒä¹Ÿæ˜¯ä¸€ä¸ªè„†å¼±çš„æœåŠ¡å™¨ï¼Œå› ä¸ºå‰é¢æåˆ°å®ƒå•çº¿ç¨‹çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ä½ ä½¿ç”¨ä¸å½“å°±ä¼šå¯¹å®ƒé€ æˆä¸€ä¸ªè‡´å‘½çš„å½±å“ï¼Œæ‰€ä»¥æˆ‘ä»¬å¸Œæœ›çŸ¥é“å®ƒåˆ°åº•åœ¨æ‰§è¡Œä»€ä¹ˆï¼Œä»¥åŠæ¯ä¸ªåœ°æ–¹ä»€ä¹ˆæ—¶é—´å‡ºç°å“ªäº›é—®é¢˜ï¼Œå¯¹äºé—®é¢˜æ’æŸ¥æ˜¯æœ‰å¸®åŠ©çš„ã€‚</li></ul><p>è¿™é‡Œä¼šå¯¹ä¸Šè¿°é—®é¢˜é€šè¿‡CacheCloudè§£å†³ï¼Œå®ƒæœ‰ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</p><ol><li>ä¸€é”®å¼€å¯Redisï¼ˆStandaloneã€Sentinelã€Clusterï¼‰ï¼›</li><li>æœºå™¨ã€åº”ç”¨ã€å®ä¾‹ç›‘æ§å’ŒæŠ¥è­¦ï¼›</li><li>å®¢æˆ·ç«¯ï¼šé€æ˜ä½¿ç”¨ã€æ€§èƒ½ä¸ŠæŠ¥ï¼›</li><li>å¯è§†åŒ–è¿ç»´ï¼šé…ç½®ã€æ‰©å®¹ã€Failoverã€æœºå™¨/åº”ç”¨/å®ä¾‹ä¸Šä¸‹çº¿ï¼›</li><li>å·²å­˜åœ¨Redisç›´æ¥æ¥å…¥å’Œæ•°æ®è¿ç§»ï¼›</li><li><a href="https://github.com/sohutv/cachecloud" target="_blank" rel="noopener">https://github.com/sohutv/cachecloud</a> </li></ol><p>ä½¿ç”¨åœºæ™¯</p><ol><li><p>å…¨é‡è§†é¢‘ç¼“å­˜ï¼ˆè§†é¢‘æ’­æ”¾APIï¼‰ï¼šè·¨æœºæˆ¿é«˜å¯ç”¨ï¼›</p></li><li><p>æ¶ˆæ¯é˜Ÿåˆ—åŒæ­¥ï¼ˆRedisMQä¸­é—´ä»¶ï¼‰ï¼›</p></li><li><p>åˆ†å¸ƒå¼å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆç™¾ä¸‡QPSï¼‰ï¼›</p><p>è®¡æ•°ç³»ç»Ÿï¼šè®¡æ•°ï¼ˆæ’­æ”¾æ•°ï¼‰ï¼›</p><p>å…¶ä»–ï¼šæ’è¡Œç‰ˆã€ç¤¾äº¤ï¼ˆç›´æ’­ï¼‰ã€å®æ—¶è®¡ç®—ï¼ˆåä½œå¼Šï¼‰ç­‰ã€‚</p></li></ol><h1 id="å¿«é€Ÿæ„å»º"><a href="#å¿«é€Ÿæ„å»º" class="headerlink" title="å¿«é€Ÿæ„å»º"></a>å¿«é€Ÿæ„å»º</h1><blockquote><p>è¯·æ ¹æ®å®˜æ–¹æ–‡æ¡£è¿›è¡Œæ­å»º</p></blockquote><h1 id="æœºå™¨éƒ¨ç½²"><a href="#æœºå™¨éƒ¨ç½²" class="headerlink" title="æœºå™¨éƒ¨ç½²"></a>æœºå™¨éƒ¨ç½²</h1><h1 id="åº”ç”¨æ¥å…¥"><a href="#åº”ç”¨æ¥å…¥" class="headerlink" title="åº”ç”¨æ¥å…¥"></a>åº”ç”¨æ¥å…¥</h1><h1 id="ç”¨æˆ·åŠŸèƒ½"><a href="#ç”¨æˆ·åŠŸèƒ½" class="headerlink" title="ç”¨æˆ·åŠŸèƒ½"></a>ç”¨æˆ·åŠŸèƒ½</h1><h1 id="è¿ç»´åŠŸèƒ½"><a href="#è¿ç»´åŠŸèƒ½" class="headerlink" title="è¿ç»´åŠŸèƒ½"></a>è¿ç»´åŠŸèƒ½</h1>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 10.ç¼“å­˜è®¾è®¡ä¸ä¼˜åŒ–</title>
    <link href="/redis-10.html"/>
    <url>/redis-10.html</url>
    
    <content type="html"><![CDATA[<h1 id="ç¼“å­˜çš„æ”¶ç›Šä¸æˆæœ¬"><a href="#ç¼“å­˜çš„æ”¶ç›Šä¸æˆæœ¬" class="headerlink" title="ç¼“å­˜çš„æ”¶ç›Šä¸æˆæœ¬"></a>ç¼“å­˜çš„æ”¶ç›Šä¸æˆæœ¬</h1><blockquote><p>ä½¿ç”¨ç¼“å­˜èƒ½å¸¦æ¥å“ªäº›æ”¶ç›Šåˆä¼šä»˜å‡ºä»€ä¹ˆæˆæœ¬ï¼Ÿ</p></blockquote><h2 id="æ”¶ç›Š"><a href="#æ”¶ç›Š" class="headerlink" title="æ”¶ç›Š"></a>æ”¶ç›Š</h2><ol><li>åŠ é€Ÿè¯»å†™<ul><li>é€šè¿‡ç¼“å­˜åŠ é€Ÿè¯»å†™ï¼šCPU  L1/L2/L3 Cacheã€Linux page CacheåŠ é€Ÿç¡¬ç›˜è¯»å†™ã€æµè§ˆå™¨ç¼“å­˜ã€Ehcacheç¼“å­˜æ•°æ®åº“ç»“æœï¼›</li></ul></li><li>é™ä½åç«¯è´Ÿè½½<ul><li>åç«¯æœåŠ¡å™¨é€šè¿‡å‰ç«¯ç¼“å­˜é™ä½è´Ÿè½½ï¼šä¸šåŠ¡ç«¯ä½¿ç”¨Redisé™ä½åç«¯MySQLè´Ÿè½½ç­‰ã€‚</li></ul></li></ol><h2 id="æˆæœ¬"><a href="#æˆæœ¬" class="headerlink" title="æˆæœ¬"></a>æˆæœ¬</h2><ol><li>æ•°æ®ä¸ä¸€è‡´ï¼šç¼“å­˜å±‚å’Œæ•°æ®å±‚æœ‰æ—¶é—´çª—å£ä¸ä¸€è‡´ï¼Œå’Œæ›´æ–°ç­–ç•¥æœ‰å…³ï¼šä½ éœ€è¦å°†åº•å±‚çš„æ•°æ®åº“çš„æ•°æ®æ”¾åˆ°ç¼“å­˜æ§½è¿›è¡Œç¼“å­˜ï¼Œå®ƒä¸¤ä¼šæœ‰ä¸€ä¸ªä¸ä¸€è‡´ï¼Œä¾‹å¦‚æ•°æ®åº“æ›´æ–°äº†ï¼Œç„¶åç¼“å­˜æ€ä¹ˆå»æ›´æ–°å‘¢ï¼Ÿè¿™é‡Œå°±æœ‰å¾ˆå¤šæ›´æ–°ç­–ç•¥ï¼Œå®ƒä¸ä¼šç«‹åˆ»æ›´æ–°ï¼Œè€Œæ˜¯è¿‡ä¸€ä¼šæ›´æ–°ï¼›</li><li>ä»£ç ç»´æŠ¤æˆæœ¬ï¼šå¤šäº†ä¸€å±‚ç¼“å­˜é€»è¾‘ï¼›</li><li>è¿ç»´æˆæœ¬ï¼šä¾‹å¦‚Redis Clusterï¼Œè¿™äº›ä¼šå¢åŠ è¿ç»´æˆæœ¬ï¼Œå½“ç„¶è¿™äº›æˆæœ¬ä¸ä¸€å®šæ˜¯å®‰è£…ï¼Œå‡å¦‚ä½ å¯ä»¥ä½¿ç”¨ä¸€äº›å¤–é¢çš„äº‘ï¼Œä½†æ˜¯ä¼šæ¶‰åŠåˆ°ç»æµæˆæœ¬ã€‚</li></ol><h2 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h2><ol><li>é™ä½åç«¯è´Ÿè½½ï¼š<ul><li>å¯¹é«˜æ¶ˆè€—çš„SQLï¼šjoinç»“æœé›†/åˆ†ç»„ç»Ÿè®¡ç»“æœç¼“å­˜ï¼›</li></ul></li><li>åŠ é€Ÿè¯·æ±‚å“åº”ï¼š<ul><li>åˆ©ç”¨<code>Redis</code>/<code>Memcache</code>ä¼˜åŒ–IOå“åº”æ—¶é—´</li></ul></li><li>å¤§é‡å†™åˆå¹¶ä¸ºæ‰¹é‡å†™ï¼š<ul><li>å¦‚è®¡æ•°å™¨ï¼Œå‡å¦‚è¯´æˆ‘å¦‚æœåªä½¿ç”¨DBçš„è¯ï¼Œæˆ‘ä¸å¯èƒ½æ¯æ¬¡éƒ½<code>update</code>ä¸€ä¸ªå€¼ç­‰äºä¸€ä¸ªå€¼åŠ ä¸€è¿™æ ·åšï¼Œå¯¹äºæ•°æ®åº“æ¥è¯´è¿™ç§æ“ä½œç›¸å½“äºæ’å…¥æ¥è¯´å®ƒæœ¬èº«å°±æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œç„¶åå¦‚æœä½ è¿˜è¦åšå¤§é‡çš„è¿™ç§æ“ä½œé‚£å®ƒçš„è´Ÿè½½ä¼šå¾ˆé«˜é€Ÿåº¦ä¼šå¾ˆæ…¢ï¼Œè€Œä¸”å®ƒæœ¬èº«ä¸é€‚åˆè¿™ç§åœºæ™¯ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™çœŸçš„è¦å°†è¿™ä¸ªæ•°æ®ä¿å­˜åœ¨DBï¼Œè¿™é‡Œå¯ä»¥å…ˆå†™ä¸€ä¸ªè®¡æ•°å™¨ï¼Œä¾‹å¦‚ä½¿ç”¨<code>Redis</code>çš„<code>INCR</code> ï¼Œåœ¨<code>INCR</code>ä¸­åšç´¯åŠ ï¼Œå› ä¸ºå®ƒ<code>INCR</code>æ˜¯éå¸¸å¿«ï¼Œå¦‚æœçœŸçš„éœ€è¦åŒæ­¥ç»™æ•°æ®åº“ï¼Œå¯ä»¥å®šæœŸæ‰¹é‡çš„åšè¿™æ ·çš„äº‹æƒ…ï¼Œä»è€Œæé«˜æ•ˆç‡</li></ul></li></ol><h1 id="ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>ç¼“å­˜æ›´æ–°ç­–ç•¥</h1><p>ç¼“å­˜çš„æ•°æ®éƒ½æ˜¯æœ‰å£°æ˜å‘¨æœŸçš„ï¼Œéœ€è¦åšå®šæœŸæ›´æ–°æˆ–è€…åˆ é™¤ä»è€Œä¿è¯ç©ºé—´åœ¨ä¸€ä¸ªå¯æ§çš„èŒƒå›´å†…ï¼Œè€Œä¸”ä¿è¯æ•°æ®å®šæœŸæ›´æ–°ï¼›ä½†æ˜¯ç¼“å­˜ä¸­æ•°æ®ç”±äºæŸäº›åŸå› å¯èƒ½å’ŒçœŸå®çš„æ•°æ®æœ‰ä¸€äº›ä¸ä¸€è‡´ï¼Œéœ€è¦åœ¨åˆç†çš„ç­–ç•¥ã€åˆç†çš„æ—¶é—´è¿›è¡Œæ›´æ–°ï¼Œè¿™é‡Œå¯¹è¿™ä¸ªé—®é¢˜è¯´æ˜ï¼Œè¿™é‡Œä»‹ç»3ç§æ›´æ–°ç­–ç•¥</p><ol><li>LRU/LFU/FIFOç®—æ³•å‰”é™¤ï¼šå¯¹äºRedisæ¥è¯´å°±æ˜¯<code>maxmemory-policy</code>æœ€å¤§å†…å­˜å¯¹åº”çš„ç­–ç•¥ï¼Œæ¯”å¦‚è¯´æœ€å¤§å†…å­˜å‡ºç°äº†æ—¶å€™è¦æ€ä¹ˆå»åšï¼Ÿåƒæœ‰ä¸€äº›ç­–ç•¥æ˜¯è¯´åœ¨å¯¹åº”å‡ºç°<code>maxmemory-policy</code>è¾¾åˆ°æœ€å¤§å€¼çš„æ—¶å€™å®ƒé¦–å…ˆå…³æ³¨è¿‡æœŸå»ºè®®ï¼Œå› ä¸ºè¿‡æœŸå»ºè®®æœªæ¥å¯èƒ½ä¼šåˆ é™¤çš„ä¸€äº›é”®ï¼Œç„¶åæ‰§è¡Œ<code>LRU</code>ï¼Œå°†ä¸€äº›æœ€è¿‘æ²¡ä½¿ç”¨çš„ä¸€äº›keyå»æ‰§è¡Œæ¥ä¿è¯<code>maxmemory-policy</code>çš„æ•´ä½“çš„å€¼ä¸ä¼šè¶…è¿‡ï¼Œè¾¾åˆ°ä¿æŠ¤å†…å­˜çš„æ•ˆæœï¼Œè€Œä¸”ä¿è¯å°½å¯èƒ½çš„æ•°æ®å®‰å…¨ï¼Œè™½ç„¶è¿™æ ·å·²ç»å‰”é™¤äº†ä¸€äº›æ•°æ®ï¼Œä½†æ˜¯å®ƒå¯èƒ½ä¿è¯ä¸€å®šçš„å®‰å…¨ ï¼Œè¿˜æœ‰åƒOKEYCORUå°±æ˜¯åœ¨æ‰€æœ‰é”®é‡Œé¢å»æ‰§è¡ŒLRUï¼Œè¿™æ ·ä¸€ä¸ªç­–ç•¥ï¼Œå½“ç„¶å®ƒæœ‰ä¸€ä¸ªä¼˜åŠ¿æ˜¯è¯´æˆ‘ä»¬åœ¨è®¾ç½®è¿™æ ·åŠŸèƒ½çš„æ—¶å€™æ˜¯éå¸¸ç®€å•ï¼Œåªéœ€è¦å¯¹ç¼“å­˜é…ç½®ä¸€ä¸ªå¯¹åº”çš„ç­–ç•¥ï¼Œä¾‹å¦‚ä»¥ä¸Šè¯´çš„ç­–ç•¥ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒå…·ä½“æ¯ä¸€ä¸ªkeyåˆ°åº•æ˜¯æ€ä¹ˆåˆ çš„ã€åˆ°åº•æ˜¯æ—¶å€™ä»€ä¹ˆç­–ç•¥éƒ½ä¸ç”¨å»å…³å¿ƒï¼Œå®ƒçš„é€‚ç”¨åœºæ™¯æ˜¯æˆ‘ä»¬åœ¨æ§åˆ¶æœ€å¤§å†…å­˜ï¼Œä¾‹å¦‚åƒåˆšæ‰è¯´çš„æˆ‘è¦å¯¹åº”ç¼“å­˜æˆ–è€…è¯´ä¸€ä¸ªå­˜å‚¨è®¾ç½®æœ€å¤§å†…å­˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å»å¸®æˆ‘åˆ é™¤æ•°æ®ï¼Œè€Œä¸æ˜¯è¯´æˆ‘çš„æ²¡æœ‰å‡ æ¡æ•°æ®ç„¶åä½ å°±æŒ‰è¿™ä¸ªç­–ç•¥å¸®æˆ‘åˆ ï¼›</li><li>è¶…æ—¶å‰”é™¤ï¼šå¯¹äºRedisæ¥è¯´å°±æ˜¯è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚ç”¨æˆ·ä¿¡æ¯å°†å®ƒç¼“å­˜èµ·æ¥äº†ï¼Œç„¶åç»™å®ƒè®¾ç½®ä¸€ä¸ªåŠå°æ—¶çš„è¿‡æœŸæ—¶é—´ï¼Œåœ¨è¿™åŠä¸ªå°æ—¶ä¹‹å†…ï¼Œç”¨æˆ·è¯·æ±‚éƒ½æ˜¯ä¼šå»ç¼“å­˜ä¸­å»æ‹¿å¯¹åº”çš„ç»“æœï¼Œç„¶åæ¥ä¿è¯æ€§èƒ½æ¥é™ä½åç«¯çš„è´Ÿè½½ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼šåœ¨è¿™ç¼“å­˜æœŸé—´å¦‚æœç”¨æˆ·æ›´æ–°äº†æ€ä¹ˆåŠï¼Ÿè¿™ä¸ªç”¨æˆ·ä¿¡æ¯å¾ˆé‡è¦ï¼Œå¯¹äºè¿™ç§æƒ…å†µexpireå°±ä¸æ˜¯å¾ˆå¥½ï¼Œå¯èƒ½ä¸€äº›ä¸é‡è¦çš„ä¿¡æ¯ï¼Œåƒè§†é¢‘å¯¹åº”çš„è¯´æ˜å¾ˆé•¿çš„å‡ ç™¾ä¸ªå­—ï¼Œç„¶åå®ƒæ”¹äº†ä¸€ä¸ªé€—å·ï¼Œå¯¹äºç”¨æˆ·æ¥è¯´è¿™ä¸€æ®µæ—¶é—´çš„ä¸ä¸€è‡´æ˜¯å¯ä»¥å®¹å¿çš„ï¼Œåƒä¸€äº›é‡è¦ä¿¡æ¯ï¼Œæ¶‰åŠåˆ°é’±æ–¹é¢çš„é‡‘èçš„ä¿¡æ¯è‚¯å®šä¸èƒ½ç”¨è¿™æ ·çš„ç­–ç•¥ï¼›</li><li>ä¸»åŠ¨æ›´æ–°ï¼šæ§åˆ¶keyæ›´æ–°å‘¨æœŸï¼Œä¾‹å¦‚åˆšæ‰è¯´çš„è¿˜æ˜¯ä»¥åˆšæ‰çš„ç”¨æˆ·ä¿¡æ¯ä¸ºä¾‹å­ï¼Œç”¨æˆ·ä¿¡æ¯åœ¨å­˜å‚¨å±‚å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœå¯¹åº”çš„ç¼“å­˜å±‚èƒ½çŸ¥é“ï¼Œæˆ‘é€šè¿‡ä½ çš„ä¸šåŠ¡ä»£ç æˆ–è€…é€šè¿‡å¼€å‘ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚å»è®¢é˜…è¿™ä¸ªæŒä¹…å±‚æ¶ˆæ¯çš„å˜åŒ–ï¼Œå®ƒåšäº†æ›´æ–°å®ƒä¼šå‘ä¸€æ¡æ¶ˆæ¯ï¼Œç„¶åæˆ‘è¿™é‡Œåšä¸€ä¸ªä¸»åŠ¨çš„æ›´æ–°æŠŠå¯¹åº”çš„keyåˆ æ‰æˆ–è€…åšä¸€æ¬¡é‡å»ºï¼Œä»æ•°æ®å±‚å»è¯»å–ä¸€éï¼Œç„¶åå›å†™åˆ°æŒä¹…å±‚ï¼Œæ¥å®ç°æ•°æ®ä¸€è‡´æ€§ï¼Œå½“ç„¶è¿™ç§ä¸€è‡´æ€§ä»»ç„¶ä¸æ˜¯ä¸€ä¸ªå®Œå…¨ä¸€è‡´çš„å¼ºä¸€è‡´æ€§ï¼Œè€Œæ˜¯ä¸€ä¸ªéœ€è¦æ—¶é—´çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œæœ€ç»ˆä¸€è‡´æ€§éœ€è¦çš„æ—¶é—´æ˜¯æ¯”è¾ƒçŸ­çš„ï¼Œå› ä¸ºå®ƒæ˜¯æœ‰è¿™æ ·æœºåˆ¶æ¥ä¿è¯ï¼›</li></ol><p>ç­–ç•¥å¯¹æ¯”</p><table><thead><tr><th>ç­–ç•¥</th><th>ä¸€è‡´æ€§</th><th>ç»´æŠ¤æˆæœ¬</th></tr></thead><tbody><tr><td>LRU/LIRSç®—æ³•å‰”é™¤</td><td>æœ€å·®</td><td>ä½</td></tr><tr><td>è¶…æ—¶å‰”é™¤</td><td>è¾ƒå·®</td><td>ç¬¬</td></tr><tr><td>ä¸»åŠ¨æ›´æ–°</td><td>å¼º</td><td>é«˜</td></tr></tbody></table><p>å»ºè®®</p><blockquote><p>åœ¨å®é™…å¼€å‘ä¸­è¦ä½¿ç”¨å“ªç§ç­–ç•¥å‘¢ï¼Ÿ</p></blockquote><ol><li>ä½ä¸€è‡´æ€§ï¼šæœ€å¤§å†…å­˜å’Œæ·˜æ±°ç­–ç•¥ï¼šéå¸¸ä¸å…³å¿ƒç¼“å­˜ä¸€è‡´æ€§æˆ–è€…ç¼“å­˜å’ŒæŒä¹…å±‚æ•°æ®ä¸ä¸€æ ·éƒ½æ— æ‰€è°“çš„ï¼Œé‚£å°±ä½¿ç”¨è¿™ç§ç­–ç•¥ï¼Œå¯ä»¥ä½¿åŠ²å¾€é‡Œé¢æ‰”ï¼Œç„¶åå½“å‡ºç°æœ€å¤§å†…å­˜çš„æ—¶å€™ï¼Œç„¶åå°±å»æŠŠå¯¹åº”çš„æ•°æ®æ·˜æ±°ï¼Œè€Œä¸”æ·˜æ±°ä»€ä¹ˆæˆ‘ä¹Ÿæ— æ‰€è°“ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å°±ä¸€ä¸‹æ¬¡ä»æŒä¹…å±‚è½é”®ï¼›</li><li>é«˜ä¸€è‡´æ€§ï¼šè¶…æ—¶å‰”é™¤å’Œä¸»åŠ¨æ›´æ–°ç»“åˆï¼Œæœ€å¤§å†…å­˜å’Œæ·˜æ±°ç­–ç•¥å…œåº•ï¼šä¸ºä»€ä¹ˆè¿™é‡Œè¦ç»“åˆå‘¢ï¼Ÿä¸æ˜¯æ˜¯è¯´ä¸»åŠ¨æ›´æ–°æ›´ä¼˜ç§€å—ï¼Ÿä½†å®é™…ä¸Šè¶…æ—¶å‰”é™¤æ˜¯ç»™ä¸»åŠ¨æ›´æ–°åšä¸€ä¸ªå…œåº•ï¼Œå‡å¦‚è¯´ä¸»åŠ¨æ›´æ–°çš„ä¸šåŠ¡é€»è¾‘æˆ–è€…ä¸šåŠ¡å›¾æˆ–è€…å¯¹åº”çš„ä»£ç å‡ºç°äº†é—®é¢˜ï¼Œå®ƒæ²¡æœ‰å°†çœŸæ­£çš„æ•°æ®åˆ é™¤æ‰ï¼Œé‚£æˆ‘ä»¬å¯èƒ½åæœŸå°±æ²¡æ³•å‘ç°è¿™ä¸ªé—®é¢˜ï¼Œå‡å¦‚è¯´æˆ‘ç»™å®ƒè®¾ç½®æ¯”è¾ƒé•¿çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœé‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œå®ƒä¼šå°†æ•°æ®è¿›è¡Œåˆ é™¤ï¼Œå½“ç„¶æ‰€æœ‰æ•°æ®æ˜¯æŒ‡æœ‰ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå®ƒç¡®å®æ˜¯è¦åœ¨ä¸€å®šæ—¶é—´è¿‡æœŸçš„ï¼Œå‡å¦‚è¯´æˆ‘æœ‰ä¸€äº›æ•°æ®ä¸ä¼šè¿‡æœŸæˆ–è€…éœ€è¦è‡ªå·±å»æ‰‹åŠ¨åˆ é™¤çš„æ•°æ®ï¼Œä¸ä¼šç»™å®ƒè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå½“ç„¶è¿™é‡Œè¿˜ä¼šä½¿ç”¨æœ€å¤§å†…å­˜å’Œè¶…æ—¶ç­–ç•¥åšä¸€ä¸ªå…œåº•ï¼Œå› ä¸ºå¤©æœ‰ä¸æµ‹é£äº‘ï¼Œä½ æ— æ³•ä¿è¯æ¯å¤©å†…å­˜çªç„¶å¢ä¸Šå»äº†ï¼Œè€Œä¸”ä½ å¯¹å†…å­˜åšçš„ä¸åˆ°ä½ï¼Œè¿™ä¸ªæ—¶é—´æˆ‘éœ€è¦æœ€å¤§å†…å­˜æ·˜æ±°ç­–ç•¥è¿›è¡Œå…œåº•æ¥ä¿è¯é¡¹ç›®å‡ºç°é—®é¢˜åç¼“å­˜å°±ä¸å¯ç”¨äº†è¿™æ ·çš„é—®é¢˜ï¼›</li></ol><h1 id="ç¼“å­˜ç²’åº¦æ§åˆ¶"><a href="#ç¼“å­˜ç²’åº¦æ§åˆ¶" class="headerlink" title="ç¼“å­˜ç²’åº¦æ§åˆ¶"></a>ç¼“å­˜ç²’åº¦æ§åˆ¶</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572526081631.png" srcset="/img/loading.gif" alt="1572526081631"></p><p>ä¸Šé¢è¿™å¼ å›¾æ˜¯å¾ˆå¤šåº”ç”¨çš„æŠ½è±¡ï¼Œä½¿ç”¨Redisã€Memcaheç­‰åšä¸ºç¼“å­˜åº•å±‚ä½¿ç”¨MySQLåšä¸ºå­˜å‚¨æºï¼Œå¯¹äºå¤§éƒ¨åˆ†æµé‡æ¥è¯´ï¼Œéƒ½å»å…‰é¡¾åˆ°Redisï¼Œå°æµé‡åˆ°MySQLè¿™æ ·çš„åœºæ™¯ï¼›</p><hr><p>ç¼“å­˜ç²’åº¦æ§åˆ¶-ä¸‰ä¸ªè§’åº¦</p><ol><li>é€šç”¨æ€§ï¼šå…¨é‡å±æ€§æ›´å¥½ï¼›</li><li>å ç”¨ç©ºé—´ï¼šéƒ¨åˆ†å±æ€§æ›´å¥½ï¼›</li><li>ä»£ç ç»´æŠ¤ï¼šè¡¨é¢ä¸Šå…¨é‡å±æ€§æ›´å¥½ã€‚</li></ol><h1 id="ç¼“å­˜ç©¿é€ä¼˜åŒ–"><a href="#ç¼“å­˜ç©¿é€ä¼˜åŒ–" class="headerlink" title="ç¼“å­˜ç©¿é€ä¼˜åŒ–"></a>ç¼“å­˜ç©¿é€ä¼˜åŒ–</h1><h2 id="å¤§é‡è¯·æ±‚ä¸å‘½ä¸­"><a href="#å¤§é‡è¯·æ±‚ä¸å‘½ä¸­" class="headerlink" title="å¤§é‡è¯·æ±‚ä¸å‘½ä¸­"></a>å¤§é‡è¯·æ±‚ä¸å‘½ä¸­</h2><p>å¯¹äºæ­£å¸¸çš„è®¿é—®æ¥è¯´ï¼Œè®¿é—®åˆ°cacheå®ƒä¼šæŠŠç»“æœè¿”å›ç»™requestï¼Œå¦‚æœå®ƒæ²¡æœ‰å‘½ä¸­çš„è¯ï¼Œå®ƒå°±ä¼šæŠŠæµé‡æ”¾ä¸‹å»ï¼Œä¹Ÿå°±æ˜¯å­˜å‚¨å±‚ï¼Œå¦‚æœå­˜å‚¨å±‚æ­£å¸¸çš„è¯å®ƒä¼šè¿”å›æ‹¿åˆ°å¯¹åº”çš„ç»“æœï¼Œç„¶åå›å†™cacheè¿”å›ç»™requestï¼Œå½“ä¸‹æ¬¡requestå†è®¿é—®çš„æ—¶å€™ï¼Œcacheå°±å·²ç»å‘½ä¸­äº†ï¼Œå°±ä¸éœ€è¦è®¿é—®åˆ°å­˜å‚¨å±‚äº†ï¼Œä½†æ˜¯æœ‰ä¸€ç§é—®é¢˜å°±æ˜¯å­˜å‚¨å±‚ä¹Ÿä¸å­˜åœ¨ï¼Œé‚£ä¼šæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿæˆ‘è¿”å›ç»™requestæ˜¯ä¸€ä¸ªç©ºçš„ç»“æœï¼Œè€Œä¸”å½“ä¸‹æ¬¡å†è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä»»ç„¶ä¼šè¿”å›cacheå±‚ï¼Œcacheå±‚è¿˜æ˜¯æ²¡æœ‰ï¼Œç„¶åç»§ç»­æŠŠæµé‡å¯¼åˆ°å­˜å‚¨å±‚ï¼Œæ‰€æœ‰çš„æµé‡éƒ½ä¼šè¾¾åˆ°å­˜å‚¨å±‚ï¼Œå› ä¸ºcacheä¸­æ²¡æœ‰è¿™æ ·çš„æ•°æ®ï¼Œå¦‚æœæ ¹æœ¬ä¸å­˜åœ¨çš„æ•°æ®ä½ å»è®¿é—®å®ƒï¼Œæ¯”å¦‚è¯´å®ƒæ˜¯ä¸€ä¸ªkeyæˆ–è€…ä¸€ä¸ªidå®ƒæ ¹æœ¬å°±ä¸å­˜åœ¨ï¼Œä½ è¿™é‡Œçš„ç¼“å­˜å­˜ã€å­˜å‚¨å±‚éƒ½ä¸å­˜åœ¨ï¼Œå®ƒå°±ä¼šæŠŠæµé‡æ‰“åˆ°å­˜å‚¨å±‚ï¼Œè¿™å°±æ˜¯ç¼“å­˜ç©¿é€çš„åŸºæœ¬è¿‡ç¨‹ï¼Œè¿™æ ·å·²ç»å¤±å»äº†ç¼“å­˜çš„æ„ä¹‰ï¼Œå› ä¸ºç¼“å­˜çš„æ„ä¹‰å°±æ˜¯ä¿æŠ¤æŒä¹…å±‚ï¼Œç„¶åè¿™æ ·ä¼šç»™æŒä¹…å±‚ä¸€ä¸ªè´Ÿè½½å¸¦æ¥å¾ˆå¤§ä¿æŠ¤ï¼Œä½†æ˜¯ç°åœ¨å·²ç»å¤±å»äº†è¿™æ ·çš„ä½œç”¨ï¼Œé‚£å°±ä¼šå¯¹æŒä¹…å±‚é€ æˆå¾ˆå¤§éšæ‚£</p><h2 id="åŸå› "><a href="#åŸå› " class="headerlink" title="åŸå› "></a>åŸå› </h2><p>ä»¥ä¸Šæè¿°çš„æƒ…å†µåˆ°åº•æ˜¯ç”±äºä»€ä¹ˆé€ æˆçš„ï¼Ÿ</p><ol><li>ä¸šåŠ¡ä»£ç è‡ªèº«é—®é¢˜ï¼šå†™çš„é€»è¾‘æœ‰é—®é¢˜ï¼Œæ¯”å¦‚ä½ å»å†™ä¸€ä¸ªå›å†™ï¼Œæˆ–è€…ä½ çœŸçš„æ‹¿ä¸åˆ°é‚£æ ·çš„æ•°æ®ï¼Œåˆæˆ–è€…ä½ çš„æŒä¹…å±‚æ˜¯åˆ«äººçš„æ¥å£ï¼Œåˆ«äººçš„æ¥å£å‡ºç°é—®é¢˜äº†ï¼Œé‚£æ€ä¹ˆåŠï¼Ÿé‚£å¯èƒ½æ‹¿åˆ°å°±æ˜¯ä¸€ä¸ªå¼‚å¸¸æˆ–è€…ä¸€ä¸ªç©ºï¼Œä½ æ²¡æ³•åšç¼“å­˜çš„å›å†™ï¼Œæˆ–è€…ä½ è‡ªèº«ä»£ç æœ‰é—®é¢˜ï¼›</li><li>æ¶æ„æ”»å‡»ã€çˆ¬è™«ç­‰ç­‰ï¼šå¯¹äºè§†é¢‘ç½‘ç«™ï¼Œè™½ç„¶è¯´å®ƒçš„URLåšäº†å¾ˆå¤šåŠ å¯†ï¼Œå®é™…ä¸Šè¿™ä¸ªåŠ å¯†æ˜¯é˜²æ­¢ç”¨æˆ·æ¶æ„çš„äººå‘˜å»çŒœåˆ°è¿™ä¸ªè§†é¢‘idçš„è§„åˆ™ï¼Œè¿™æ ·çš„è¯å®ƒåœ¨æŠ“å–è¿™ä¸ªè§†é¢‘ç½‘é¡µçš„æ•°æ®çš„æ—¶å€™ï¼Œå› ä¸ºç½‘é¡µä¸Šæœ‰å¾ˆå¤šçš„ä¿¡æ¯ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªè§†é¢‘ç½‘ç«™ï¼Œå®ƒæœ‰æ˜æ˜Ÿçš„ä¿¡æ¯ï¼Œè¿˜æœ‰æ¨èä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯å¯èƒ½å¯¹å¤„äºæŸäº›ç›®çš„çš„äººï¼Œå®ƒå¯èƒ½æƒ³å»æ‹¿åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œé‚£å®ƒé€šè¿‡ä¸€äº›æ¸ é“çŸ¥é“äº†ä½ è¿™ä¸ªURLè§„åˆ™ï¼Œæˆ–è€…å®ƒæ ¹æœ¬å°±ä¸çŸ¥é“ï¼Œä½†æ˜¯å®ƒå¼ºåˆ¶è®¿é—®ï¼Œå®ƒè®¿é—®çš„æ—¶å€™å¯èƒ½ä¼šè§¦å‘ä½ è¿™è¾¹å¯¹åº”çš„æ¥å£ï¼Œä½ æ¥å£å°±è§¦å‘åˆ°ç¼“å­˜ï¼Œè¿™ç§æ•°æ®æ¯”å¦‚å®ƒä¼ ç»™ä½ çš„idæ ¹æœ¬å°±ä¸åœ¨å­˜å‚¨çš„èŒƒå›´å†…ï¼Œæ‰€ä»¥è¯´å¿…ç„¶ä¼šå‡ºç°ç©¿é€é—®é¢˜ï¼Œå¯èƒ½å°±ä¼šé€ æˆä¸Šé¢ç±»ä¼¼çš„å±å®³ï¼›</li></ol><h2 id="ä»»ä½•å‘ç°"><a href="#ä»»ä½•å‘ç°" class="headerlink" title="ä»»ä½•å‘ç°"></a>ä»»ä½•å‘ç°</h2><p>ä»¥ä¸Šæè¿°çš„é—®é¢˜è¦å¦‚ä½•å»å‘ç°ï¼Ÿ</p><ol><li>ä¸šåŠ¡çš„å“åº”æ—¶é—´ï¼šå¯èƒ½æœ‰ä¸€äº›æˆ–è€…ä»€ä¹ˆè¯­è¨€ï¼Œå®ƒå¯èƒ½éƒ½ä¼šæœ‰ç›¸åº”çš„ç›‘æ§ç³»ç»Ÿï¼Œå¹³å¸¸ç¼“å­˜æŠ—äº†å¾ˆå¤§çš„é‡ï¼Œæœ¬èº«ç¼“å­˜æŠ—é‡äº†ï¼Œè€Œä¸”å®ƒçš„å“åº”é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œæ‰€ä»¥è¯´ä¸€èˆ¬æ—¶é—´æ˜¯åœ¨ä¸€ä¸ªç¨³å®šçš„æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯é¢„æœŸçš„ ï¼Œä½†å¦‚æœå‡ºç°äº†ç±»ä¼¼çš„ç©¿é€ç°è±¡ï¼Œå®ƒå¯èƒ½æŠŠæ‰€æœ‰æµé‡å…¨æ‰“åˆ°å­˜å‚¨å±‚ï¼Œå®ƒå¿…ç„¶ä¼šåœ¨æ—¶é—´ä¸Šå‘ç”Ÿé—®é¢˜ï¼›</li><li>ä¸šåŠ¡æœ¬èº«é—®é¢˜ï¼›</li><li>ç›¸å…³æŒ‡æ ‡ï¼šæ€»è°ƒç”¨æ•°ã€ç¼“å­˜å±‚å‘½ä¸­æ•°ã€å­˜å‚¨å±‚å‘½ä¸­æ•°ï¼šè¿™äº›ç›¸å…³çš„å‚æ•°ä½ éƒ½æ˜¯å¯ä»¥é‡‡é›†åˆ°ï¼Œæ¯”å¦‚è¯´ä½ é‡‡é›†æ¯åˆ†é’Ÿçš„å˜åŒ–ï¼Œç„¶åä½ å°±å¯ä»¥çŸ¥é“åˆ°åº•æœ‰æ²¡æœ‰è¿™æ ·çš„é—®é¢˜ï¼›</li></ol><h2 id="è§£å†³æ–¹æ³•1"><a href="#è§£å†³æ–¹æ³•1" class="headerlink" title="è§£å†³æ–¹æ³•1"></a>è§£å†³æ–¹æ³•1</h2><h3 id="ç¼“å­˜ç©ºå¯¹è±¡"><a href="#ç¼“å­˜ç©ºå¯¹è±¡" class="headerlink" title="ç¼“å­˜ç©ºå¯¹è±¡"></a>ç¼“å­˜ç©ºå¯¹è±¡</h3><blockquote><p>è¿™æ˜¯ä¸€ä¸ªç®€å•ç²—æš´çš„æ–¹æ³•</p></blockquote><p>ä¸€ä¸ªè¯·æ±‚åœ¨cacheå±‚ã€storageå±‚ä¹Ÿmissçš„æƒ…å†µï¼Œä¹‹å‰åšæ³•æ˜¯ç›´æ¥è¿”å›ç»™requestä¸€ä¸ªç©ºï¼Œæˆ‘ä»¬æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å¦‚æœè¿™æ ·åšçš„è¯ä»»ç„¶ä¼šå°†æµé‡æ‰“åˆ°storageï¼Œå®é™…ä¸Šè¿™å°±æ˜¯ç¼“å­˜ç©¿é€é—®é¢˜ï¼Œé‚£å¦‚æœæˆ‘ä»¬çœŸçš„è®¤ä¸ºå®ƒç¡®å®ä¸å­˜åœ¨ï¼Œå°±æ˜¯è®¿é—®requestæˆ‘è®¤ä¸ºä½ ç¡®å®ä¸å­˜åœ¨ï¼Œé‚£æˆ‘å°±æŠŠå®ƒå½“åšä¸€ä¸ªç»“æœç„¶åç¼“å­˜åˆ°cacheä¸­ï¼Œè¿™é‡Œæœ‰å¾ˆå¤šåŸå› ï¼Œå¯èƒ½æ˜¯çœŸçš„ä¸å­˜åœ¨ã€å¯èƒ½æ˜¯ç”±äºæŸäº›åŸå› ï¼Œæ¯”å¦‚è¯´storageæš‚æ—¶ä¸å¯ç”¨æˆ–è€…storageå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé‚£ä¸ªæ¥å£ä¸å¯ç”¨ç­‰ç­‰æ„¿æ„â€¦ï¼Œé‚£è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªcacheè®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæ¯”å¦‚5åˆ†é’Ÿã€åŠåˆ†é’Ÿè¿™æ ·çš„ä¸€äº›æŒ‡æ ‡ï¼Œè¿™ä¸ªæ ¹æ®ä½ çš„åœºæ™¯å†³å®šï¼Œé‚£å¯¹äºä¸‹æ¬¡è®¿é—®æ¥è¯´ï¼Œåœ¨cacheä¸­å·²ç»æœ‰äº†é‚£ä¸ªkeyï¼Œä½†æ˜¯è¿™ä¸ªkeyçš„å€¼æ˜¯ç©ºçš„ï¼Œä½†æ˜¯å®ƒå¯èƒ½å¸®åŠ©æˆ‘ä»¬å‡å°‘storageå±‚çš„å‹åŠ›ï¼Œä»è€Œè§£å†³ç¼“å­˜ç©¿é€é—®é¢˜å¸¦æ¥çš„ä¸€äº›å±å®³ï¼Œä½†æ˜¯å®ƒå­˜åœ¨2ä¸ªé—®é¢˜ï¼š</p><ol><li>éœ€è¦æ›´å¤šçš„é”®ï¼šå‰é¢æåˆ°åƒæ¶æ„æ”»å‡»æˆ–è€…çˆ¬è™«ï¼Œå®ƒä¼šæœ‰å¾ˆå¤šå„ç§ä¹±ä¸ƒå…«ç³Ÿçš„é”®ï¼Œä½ éƒ½æ— æ³•é¢„æµ‹ï¼Œä½¿ç”¨ç¼“å­˜ç©ºå¯¹è±¡çš„æ—¶å€™ï¼Œä¼šæŠŠé‚£äº›ä¼ è¿‡æ¥çš„é”®éƒ½è¿›è¡Œä¸€ä¸ªç¼“å­˜ï¼Œè™½ç„¶åªå­˜é”®å’Œå®ƒçš„ç©ºå€¼ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªé‡å¾ˆå¤§çš„æ—¶å€™ï¼Œä»ä¸šåŠ¡ä¸Šæˆ–è€…ä»ç¼“å­˜çš„ä½¿ç”¨é‡æ¥è¯´ä¹Ÿä¼šæœ‰ä¸€å®šå½±å“ï¼Œæ‰€ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´æ¥é™ä½è¿™æ ·çš„é£é™©ï¼›</li><li>ç¼“å­˜å±‚å’Œå­˜å‚¨å±‚æ•°æ®â€œçŸ­æœŸâ€ä¸ä¸€è‡´ï¼šå› ä¸ºå­˜å‚¨å±‚åœ¨ä¸€äº›æƒ…å†µå‡ºç°äº†é—®é¢˜ï¼Œæ¯”å¦‚ç±»ä¼¼ä¸€ä¸ªæ¥å£ï¼Œå®ƒå½“æ—¶è°ƒç”¨çš„æ—¶å€™å‡ºç°æ¯”å¦‚ç½‘ç»œæ»šåŠ¨ã€å¯¹æ–¹å‡ºç°å¼‚å¸¸æˆ‘æ‹¿ä¸åˆ°å¯¹åº”çš„ç»“æœæ˜¯ä¸€ä¸ªç©ºï¼Œæˆ‘æŠŠè¿™ä¸ªç©ºç¼“å­˜äº†ç„¶åç¼“å­˜äº†5åˆ†é’Ÿè¿‡æœŸæ—¶é—´ï¼Œåœ¨è¿™ä¹‹åå®ƒçš„ä¸šåŠ¡æ¢å¤æ­£å¸¸äº†ï¼Œä½†æ˜¯æˆ‘ç¼“å­˜æ˜¯ä¸€ä¸ªç©ºçš„çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™å®ƒä»¬2è€…æ˜¯ä¸ä¸€è‡´çš„ï¼Œå®é™…ä¸Šè¿™ä¸ªæ•°æ®æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯ç¼“å­˜æ˜¯ä¸€ä¸ªç©ºçš„ï¼Œå½“ç„¶è¿™æ ·çš„é—®é¢˜å¯ä»¥ä¾èµ–ä¸€äº›æ–¹å¼æ¥è§£å†³ï¼Œæ¯”å¦‚è¯´ä½ å¯ä»¥å»è®¢é˜…å®ƒçš„æ¶ˆæ¯ï¼Œæ¯”å¦‚å®ƒçš„æœåŠ¡å‘å‡ºæ­£å¸¸çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä¼šæŠŠç¼“å­˜é‡æ–°ä¸Šçº¿ä¸€éï¼Œå°†è¿™ä¸ªkeyé‡æ–°å‘é€ä¸€éï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›æ¶ˆæ¯é˜Ÿåˆ—å•ç‹¬è®¢é˜…åˆ°æŸä¸€ä¸ªkeyï¼Œæˆ–è€…æŸä¸€ä¸ªä¸šåŠ¡ï¼Œè¿™äº›éƒ½å¯ä»¥è§£å†³ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒç»å¯¹ä¸æ˜¯ä¸€ä¸ªå¼ºä¸€è‡´ï¼Œå› ä¸ºå®ƒä¸¤ä¹‹é—´æ°¸è¿œä¼šå­˜åœ¨çŸ­æœŸçš„ä¸ä¸€è‡´ï¼Œè¿™ä¸ªçœ‹ä½ çš„ä½¿ç”¨åœºæ™¯æ¥å†³å®š</li></ol><h2 id="ç¤ºä¾‹ä»£ç "><a href="#ç¤ºä¾‹ä»£ç " class="headerlink" title="ç¤ºä¾‹ä»£ç "></a>ç¤ºä¾‹ä»£ç </h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572528561308.png" srcset="/img/loading.gif" alt="1572528561308"></p><h2 id="è§£å†³æ–¹æ³•2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª"><a href="#è§£å†³æ–¹æ³•2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª" class="headerlink" title="è§£å†³æ–¹æ³•2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª"></a>è§£å†³æ–¹æ³•2-å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆª</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572529784092.png" srcset="/img/loading.gif" alt="1572529784092"></p><p>é€šè¿‡å¾ˆå°çš„å†…å­˜æ¥å®ç°å¯¹æ•°æ®çš„è¿‡æ»¤ï¼Œæ¯”å¦‚è¯´å·¨å¤§çš„ä¸€ä¸ªç”µè¯æœ¬ï¼Œä¾‹å¦‚è¯´æœ‰10äº¿è¡Œï¼Œæˆ‘è¦åˆ¤æ–­ä¸€ä¸ªç”µè¯æ˜¯å¦åœ¨è¿™ä¸ªç”µè¯æœ¬é‡Œè¦æ€ä¹ˆå»åšï¼Ÿä¸€èˆ¬ä¸å¯èƒ½æŠŠç”µè¯æœ¬å…¨éƒ¨æ”¾åˆ°å†…å­˜é‡Œï¼Œè¿™æ ·ä¼šä½¿å†…å­˜éå¸¸å¤§ï¼Œå¸ƒéš†è¿‡æ»¤å™¨æ˜¯è§£å†³ç±»ä¼¼çš„é—®é¢˜çš„ï¼Œå®ƒå¯ä»¥é€šè¿‡ä¸€äº›ç®—æ³•å°†ç”µè¯æœ¬å¤§æ•°æ®æ”¾åˆ°å¸ƒéš†è¿‡æ»¤å™¨çƒ­ä¸€éï¼Œå½“ä½ ä¸‹æ¬¡è®¿é—®éœ€è¦åˆ¤æ–­æŸä¸ªç”µè¯æ˜¯å¦åœ¨è¿™ä¸ªç”µè¯æœ¬é‡Œçš„æ—¶å€™ï¼Œå®ƒå¯ä»¥ç”¨å¾ˆå°çš„å†…å­˜è§£å†³åˆšæ‰ç±»ä¼¼çš„é—®é¢˜ã€‚å¸ƒéš†è¿‡æ»¤å™¨æ‹¦æˆªå®é™…ä¸Šä½ å¯ä»¥è®¤ä¸ºå®ƒæ‰€æœ‰çš„keyæˆ–è€…ä¸€ä»½å¤§çš„ç¦»çº¿æ•°æ®æ”¾åˆ°å¸ƒéš†è¿‡æ»¤å™¨é‡Œï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªå¸ƒéš†è¿‡æ»¤å™¨åœ¨å¼€å§‹å±‚å†å»åšä¸€å±‚æ‹¦æˆªï¼Œå¦‚æœåœ¨å¸ƒéš†è¿‡æ»¤å™¨é‡Œå·²ç»è¢«è¿‡æ»¤äº†é‚£å°±ä¸è®¤ä¸ºä½ è¿™ä¸ªè¯·æ±‚æ˜¯æœ‰æ•ˆçš„ï¼Œå¦‚æœä½ æ²¡æœ‰è¢«è¿‡æ»¤ï¼Œé‚£å°±ä»å¼€å§‹å±‚å»æ‹¿ï¼Œå½“ç„¶è¿™æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¸ƒéš†è¿‡æ»¤å™¨æ€ä¹ˆå»ç”Ÿæˆï¼Ÿæ˜¯ç¦»çº¿ç”Ÿæˆè¿˜æ˜¯è¯´æ€ä¹ˆå»åšï¼Ÿè¿™ä¸ªéƒ½æ˜¯æœ‰å¾ˆå¤šé—®é¢˜çš„ï¼Œå¸ƒéš†è¿‡æ»¤å™¨å®ƒçš„ä½¿ç”¨åœºæ™¯å¯¹äºè¿™ç§æ¯”è¾ƒå›ºå®šçš„æ•°æ®æ˜¯æ¯”è¾ƒå¥½çš„ï¼Œå¦‚æœæ˜¯é¢‘ç¹æ›´æ–°çš„æ•°æ®ï¼Œæˆ‘æ€ä¹ˆå»æ„å»ºå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¿™é‡Œå°±æœ‰å¾ˆå¤šé—®é¢˜ï¼Œä¸¾ä¸ªä¾‹å­ï¼šæ¯”å¦‚æˆ‘ä¹‹å‰åšçš„æ¨èæœåŠ¡ï¼Œå¾ˆæ—©çš„æ¨èæœåŠ¡ï¼Œä¸æƒ³ç°åœ¨å®æ—¶æ¨èï¼Œè€Œæ˜¯è¯´æ ¹æ®ç”¨æˆ·å‰ä¸€å¤©æ‰§è¡Œçš„æ—¥å¿—ç»™å‡ºç¬¬äºŒå¤©çš„ç»“æœï¼Œè¿™ä¸ªç»“æœä¸€èˆ¬éƒ½æ˜¯åœ¨å¤œé—´å»ç®—çš„ï¼Œç„¶åç®—å®Œä¹‹åå®ƒä¼šå­˜å‚¨åˆ°æ¯”å¦‚hbaseä¸Šï¼Œç„¶åç¬¬äºŒå¤©å°±è¿™äº›å¯¹åº”ç»“æœç»™ç”¨æˆ·ï¼Œè¿™ä»½æ•°æ®å®é™…ä¸Šæ˜¯ä¸€ä»½æ¯”è¾ƒå›ºå®šçš„æ•°æ®ï¼Œå®ƒæœ‰æ¯ä¸ªç”¨æˆ·çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ¯ä¸ªç”¨æˆ·çš„keyåšæˆä¸€ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè¿™ä¸ªå¸ƒéš†è¿‡æ»¤å™¨ç›¸å¯¹æ˜¯ä¸€ä¸ªå¯ä¿¡çš„ï¼Œå®ƒå°±æ˜¯è¿™æ ·ä¸€ä¸ªè¿‡ç¨‹ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯æ˜¯æœ‰å±€é™çš„ï¼Œè¦ä¹ˆä½ å¯¹å¸ƒéš†è¿‡æ»¤å™¨å®ç°å®æ—¶æ›´æ–°ï¼Œè¦ä¹ˆä½¿ç”¨ä¸€ä¸ªæ¯”è¾ƒå›ºå®šçš„æ•°æ®ä½“ï¼Œå’Œåˆšæ‰è¯´çš„ç¼“å­˜ç©ºå¯¹è±¡æ¥è¯´ï¼Œå®ƒä»¬2è€…çš„ä½¿ç”¨åœºæ™¯ä¸å¤ªç›¸åŒï¼Œè€Œä¸”ä½¿ç”¨çš„ç»´æŠ¤æˆæœ¬ä¹Ÿä¸å¤ªç›¸åŒï¼Œä¾‹å¦‚ä¼šåƒè¿™æ ·æ¥è¯´ï¼šè¿™ä¸ªä»£ç æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ƒå¯èƒ½ä¼šéœ€è¦ä¸€äº›é¢å¤–çš„ç©ºé—´æ¥ä¿å­˜ç©ºçš„keyï¼Œè€Œä¸”å®ƒå¯èƒ½æœ‰ä¸€äº›æ•°æ®ä¸ä¸€è‡´ï¼Œè€Œå¯¹äºå¸ƒéš†è¿‡æ»¤å™¨çš„é—®é¢˜å°±æ›´å¤šäº†ï¼Œå®ƒéœ€è¦ç‰¹æ®Šçš„ä½¿ç”¨åœºæ™¯ï¼Œè¿™ä¸ªå¸ƒéš†è¿‡æ»¤å™¨è¦å•ç‹¬å†™ä¸€äº›ä»£ç ï¼Œè€Œä¸”å®ƒæœ¬èº«è™½ç„¶å¯ä»¥å ç”¨å¾ˆå°å†…å­˜æ¥å®ç°æ•´ä¸ªæ•°æ®çš„è¿‡æ»¤éƒ½æ˜¯éœ€è¦é¢å¤–çš„ç©ºé—´æ¥å®Œæˆçš„ï¼Œè™½ç„¶åœ¨é€‰å–å¯¹åº”çš„æ–¹æ¡ˆçš„æ—¶å€™ï¼Œæˆ–è€…ä½ å‘ç°äº†ä¸€ç§æ€è·¯ä½ éƒ½è¦å»æ ¹æ®å…·ä½“çš„åœºæ™¯æ¥å†³å®šä½¿ç”¨å“ªäº›æ–¹æ³•</p><h1 id="æ— åº•æ´é—®é¢˜ä¼˜åŒ–"><a href="#æ— åº•æ´é—®é¢˜ä¼˜åŒ–" class="headerlink" title="æ— åº•æ´é—®é¢˜ä¼˜åŒ–"></a>æ— åº•æ´é—®é¢˜ä¼˜åŒ–</h1><p>åœ¨ä»‹ç»RedisClusterçš„æ—¶å€™è¯´è¿‡RedisClusteræ˜¯å¦‚ä½•å®ç°æ‰¹é‡ä¼˜åŒ–çš„æ—¶å€™ï¼Œæåˆ°è¿‡é‚£æ ·çš„é—®é¢˜æ˜¯æ— åº•æ´é—®é¢˜ï¼Œä¸‹é¢æ¥çœ‹çœ‹è¿™ä¸ªé—®é¢˜çš„æè¿°ï¼š</p><ul><li>2010å¹´ï¼ŒFacebookæœ‰äº†3000ä¸ªMemcacheèŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒä»¬ä¸šåŠ¡çš„é‡è¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”å®ƒä»¬å½“æ—¶ç”¨äº†å¾ˆå¤šMemcacheï¼ŒMemcacheä¹Ÿæ˜¯ç¼“å­˜çš„äº§å“</li><li>å‘ç°é—®é¢˜ï¼šâ€œåŠ â€æœºå™¨æ€§èƒ½æ²¡èƒ½æå‡ï¼Œåè€Œä¸‹é™ï¼Œè¿™ä¸ªå°±æ˜¯æ— åº•æ´é—®é¢˜ï¼Œä½ åŠ äº†ä¸ªæ›´å¤šçš„æŠ•å…¥ï¼Œä½†æ˜¯ä½ æ²¡æœ‰å¾—åˆ°å¯¹åº”çš„æ”¶ç›Šï¼Œåè€Œå»ä¸‹é™äº†ï¼ŒæŠ•å…¥è¶Šå¤šä¸‹é™è¶Šæ˜æ˜¾ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯ä¸€ä¸ªæ— åº•æ´</li></ul><p>æ— åº•æ´é—®é¢˜å…³é”®ç‚¹ï¼š</p><p>ä¸€ä¸ªæ‰¹é‡æ“ä½œå˜åŒ–ï¼Œå‡å¦‚åŸæ¥æˆ‘ä»¬ä¸€ä¸ªcacheä¸€ä¸ªèŠ‚ç‚¹åªæœ‰è¿™ä¹ˆä¸€ä¸ªï¼Œå®ç°ä¸€ä¸ªmgetæ“ä½œåªè¿›è¡Œä¸€æ¬¡IO,å½“èŠ‚ç‚¹å˜æˆ3ä¸ªçš„æ—¶å€™ï¼Œä¹‹å‰ä»‹ç»è¿‡ï¼Œå°†å®¢æˆ·ç«¯å°†keyè¿›è¡Œç»„è£…ï¼Œç„¶åæŒ‰ç…§å®ƒå¯¹åº”çš„èŠ‚ç‚¹ipå’Œç«¯å£ï¼Œç„¶åå°±ä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä¸€æ¬¡mgetæ“ä½œä¼šéšç€æœºå™¨æˆ–è€…èŠ‚ç‚¹çš„ä¸ªæ•°è¶Šæ¥è¶Šå¤šï¼Œé‚£ä¹ˆç½‘è·¯çš„æ¬¡æ•°ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œä¼šå¯¹æˆ‘çš„å®¢æˆ·ç«¯ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œæ•ˆç‡å¸¦æ¥å¾ˆå¤§ä¸‹é™ï¼Œå®é™…ä¸Šæˆ‘çš„ä¸€ä¸ªIOç”±äºæ‰©å®¹ï¼Œç”±åŸæ¥çš„Oï¼š1å˜æˆäº†O:nodeï¼Œæˆ‘çš„nodeèŠ‚ç‚¹è¶Šå¤šmgetç†è®ºä¸Šæ¥è¯´å®ƒçš„ä¸€æ¬¡æ‰¹é‡æ“ä½œæ—¶é—´ä¼šè¶Šé•¿ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°æ›´å¤šçš„èŠ‚ç‚¹ï¼Œè€Œä¸”è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼šä½ åœ¨ä¸€æ¬¡mgetå¯èƒ½è¦ç­‰æœ€æ…¢çš„èŠ‚ç‚¹å®Œæˆç„¶åæ‰èƒ½å°†è¿™ä¸ªæ“ä½œå®Œæˆï¼Œè¿™è¿˜æ˜¯åœ¨å¹¶è¡Œçš„æƒ…å†µä¸‹ï¼Œå‡å¦‚è¯´æ˜¯åœ¨ä¸€ä¸ªä¸²è¡Œçš„è¯å®ƒä¼šæ›´æ™šï¼Œå½“ç„¶è¿™é‡ŒæŒ‡çš„æ˜¯èŠ‚ç‚¹éå¸¸å¤šï¼Œå‰é¢æåˆ°è¿‡äº†ï¼šFacebooké‚£ä¸ªæ—¶å€™å·²ç»è¾¾åˆ°äº†3000ä¸ªèŠ‚ç‚¹ï¼Œå¯¹äºä¸€èˆ¬åº”ç”¨æ¥è¯´ä»ä¸€ä¸ªæ‰©å±•æˆ3ä¸ªï¼Œä¸€æ¬¡mgetä¸€ä¸ªæŸå¤±ä¸ä¼šç‰¹åˆ«æ˜æ˜¾ï¼Œæ‰€ä»¥è¯´å¤§å®¶ä¹Ÿä¸ç”¨å»è¿‡åˆ†æ‹…å¿ƒè¿™ä¸ªé—®é¢˜ï¼›</p><ul><li>æ›´å¤šçš„æœºå™¨ï¼=æ›´é«˜çš„æ€§èƒ½ï¼›</li><li>æ‰¹é‡æ¥å£éœ€æ±‚ï¼ˆmgetã€msetç­‰ï¼‰ï¼›</li><li>æ•°æ®å¢é•¿ä¸æ°´å¹³æ‰©å±•éœ€æ±‚ï¼šéšç€ä¸šåŠ¡é‡è¶Šæ¥è¶Šå¤§ï¼Œè‚¯å®šéœ€è¦å°†æˆ‘ä»¬çš„ç¼“å­˜è¿›è¡Œæ°´å¹³åº“å®¹ï¼Œæ°´å¹³æ‰©å®¹æ— éå°±æ˜¯åŠ èŠ‚ç‚¹åŠ æœºå™¨ï¼Œæ‰€ä»¥è¿™2è€…å®é™…ä¸Šæ˜¯ä¸€ä¸ªçŸ›ç›¾ï¼Œæˆ‘å®¢æˆ·ç«¯éœ€è¦æ›´é«˜çš„æ€§èƒ½ï¼Œä½†æ˜¯æˆ‘æœåŠ¡ç«¯åˆéœ€è¦æ›´å¤šçš„æ•°æ®ï¼Œæˆ–è€…è¯´æœåŠ¡ç«¯æ€§èƒ½ä½ çš„æ‰©å®¹</li></ul><p>å¯¹äºä¸Šçš„IOé—®é¢˜ï¼Œè¿™é‡Œæä¾›äº†å‡ ç§ä¼˜åŒ–æ–¹æ³•</p><ol><li>å‘½ä»¤æœ¬èº«ä¼˜åŒ–ï¼šä¾‹å¦‚æ…¢æŸ¥è¯¢keysã€hgetall bigkeyï¼›</li><li>å‡å°‘ç½‘ç»œé€šä¿¡æ¬¡æ•°ï¼šmgetç”±åŸæ¥çš„ä¸€æ¬¡çš„næ¬¡ç½‘ç»œå˜æˆäº†èŠ‚ç‚¹æ¬¡ç½‘ç»œï¼Œæˆ–è€…è¯´æ˜¯åˆ°ä¸€æ¬¡ç½‘ç»œï¼Œæ€ä¹ˆå»åšè¿™ä»¶äº‹ï¼Œå½“ç„¶è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ä½ ä¼˜åŒ–çš„åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå‡å¦‚è¯´ä¼˜åŒ–çš„Redisè¿™ç§å‘½ä»¤æ‰§è¡Œæœ¬èº«ï¼Œé‚£æˆ‘å¯èƒ½ä¼šè€ƒè™‘ç½‘ç»œä¼˜åŒ–æ›´å¤šä¸€ç‚¹ï¼Œå‡å¦‚è¯´åƒMySQLï¼Œå¯èƒ½MySQLæœ¬èº«æ‰§è¡Œå°±éå¸¸æ…¢ï¼Œç½‘ç»œå¯èƒ½ä¼šç¨å¾®å¿½ç•¥ä¸€äº›ï¼Œè€Œä¸”MySQLå¯¹æ€§èƒ½è¦æ±‚ä¸ä¼šå¤ªé«˜ï¼ŒåƒRedisï¼Œæˆ‘å¯èƒ½ä¼šè€ƒè™‘ä¼˜åŒ–å¾ˆå¤šsqlï¼Œåšä¸åŒçš„æ•°æ®åº“ä¼˜åŒ–ï¼Œå®ƒçš„æ€è·¯ä¹Ÿä¸å¤ªä¸€æ ·ï¼›</li><li>é™ä½æ¥å…¥æˆæœ¬ï¼šæˆ‘ä»¬åœ¨ä½¿ç”¨å®¢æˆ·ç«¯çš„ä½¿ç”¨ï¼Œå¯èƒ½ä¼šè€ƒè™‘æ›´å¤šä½¿ç”¨é•¿è¿æ¥æˆ–è€…è¿æ¥æ± ã€NIOä¸€äº›æŠ€æœ¯æ¥é™ä½æˆæœ¬æé«˜IOä¼˜åŒ–æ•ˆç‡ï¼Œæœ¬æ¬¡è¿™ä¸ªæ— åº•æ´é—®é¢˜ä¸»è¦ä¼˜åŒ–çš„æ˜¯è¯»å†™ï¼Œä¸ä¼šè€ƒè™‘å‘½ä»¤æœ¬èº«IOæˆæœ¬ï¼Œå› ä¸ºå®ƒå·²ç»è¶³å¤Ÿä¼˜ç§€äº†ï¼Œæˆ‘ä»¬è§£å†³ä¸»è¦é—®é¢˜é™ä½é€šä¿¡æ¬¡æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æœºå™¨åŠ çš„è¶Šå¤šé€šä¿¡æ¬¡æ•°è¶Šå¤š</li></ol><h1 id="é›ªå´©é—®é¢˜"><a href="#é›ªå´©é—®é¢˜" class="headerlink" title="é›ªå´©é—®é¢˜"></a>é›ªå´©é—®é¢˜</h1><blockquote><p>æ­£åœ¨è¡¥å……~</p></blockquote><h1 id="çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–"><a href="#çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–" class="headerlink" title="çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–"></a>çƒ­ç‚¹keyé‡å»ºä¼˜åŒ–</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572533261311.png" srcset="/img/loading.gif" alt="1572533261311"></p><p>ä½¿ç”¨ç¼“å­˜é¦–å…ˆæ˜¯ä»ç¼“å­˜è·å–ï¼Œå¦‚æœè·å–ä¸åˆ°ä¼šä»æ•°æ®æºè·å–ï¼Œå¦‚æœè·å–åˆ°äº†ä¼šè¿›è¡Œä¸€ä¸ªå›å†™ï¼Œä¹Ÿå°±æ˜¯ç¼“å­˜çš„é‡å»ºè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šå‡ºç°ä¸€ä¸ªé—®é¢˜</p><p>çƒ­ç‚¹key+è¾ƒé•¿çš„é‡å»ºæ—¶é—´ï¼šå¦‚æœé‡å»ºçš„è¿™ä¸ªkeyæ˜¯ä¸€ä¸ªçƒ­ç‚¹keyï¼Œå®ƒçš„è®¿é—®é‡éå¸¸å¤§ï¼Œä»¥å¾®åšä¸ºä¾‹å­ï¼šæŸä¸€ä¸ªå¤§vå‘äº†ä¸€ä¸ªé‡è¦çš„æ¶ˆæ¯ï¼Œç„¶åè¿™ä¸ªkeyè®¿é—®é‡éå¸¸å¤§ï¼Œé‡å»ºçš„è¿‡ç¨‹æ˜¯æ¯”è¾ƒæ…¢çš„ï¼Œä¾‹å¦‚å®ƒæ‰§è¡Œäº†ä¸€ä¸ªå¾ˆå¤æ‚çš„sqlæˆ–è€…è°ƒäº†ä¸€ä¸ªå¾ˆæ…¢çš„APIï¼Œé‚£å®ƒå°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šå†è¿™ä¸ªé‡å»ºè¿‡ç¨‹ä¸­æœ‰å¾ˆå¤šçº¿ç¨‹éƒ½ä¼šå‚ä¸é‡å»ºï¼Œä¼šå°è¯•ä¸€ä¸ªé—®é¢˜ï¼šé¦–å…ˆè·å–è¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½è¦æ‰§è¡Œä¸€éé‡å†™è¿‡ç¨‹ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯è¿™ä¸ªé‡å»ºè¿‡ç¨‹å¯èƒ½æ˜¯åº•å±‚çš„ä¸€ä¸ªæ¥å£æˆ–è€…æ˜¯æ•°æ®åº“ï¼Œç”±äºç°åœ¨æ˜¯çƒ­ç‚¹keyï¼Œç„¶åä¼šé€ æˆå¯¹æ•°æ®åº“ç”±å¾ˆå¤§å‹åŠ›ï¼Œä¸Šé¢è¿™å¼ å›¾ä¸­æ¥æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ï¼šç°åœ¨å·²ç»åˆ°äº†ç¼“å­˜é‡å»ºçš„æ—¶é—´ï¼Œç°åœ¨è·å–ç¼“å­˜å®ƒæ²¡æœ‰è·å–åˆ°æ•°æ®ï¼Œé‚£å°±ä¼šå»æŸ¥è¯¢æ•°æ®æºï¼Œç„¶åè¿›è¡Œä¸€ä¸ªç¼“å­˜çš„é‡å»ºï¼Œåœ¨è¿™ä¸ªæ—¶é—´è¿‡äº†ä¹‹åè¿›è¡Œè¾“å‡ºï¼Œä¸æ­¤åŒæ—¶å› ä¸ºå®ƒæ˜¯ä¸€ä¸ªé«˜å¹¶å‘çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œæœ‰å¾ˆå¤šçš„çº¿ç¨‹æˆ–è€…å¾ˆå¤šçš„è®¿é—®éƒ½åœ¨æ‰§è¡Œè·å–ç¼“å­˜ï¼Œé‚£å®ƒå‘ç°ç¼“å­˜ä¸­æ•°æ®ä¸ºç©ºçš„æ—¶å€™é‚£å®ƒä¹Ÿä¼šæŸ¥è¯¢æ•°æ®æºå†èµ°ä¸€éè¿™ä¸ªæµç¨‹ï¼Œå½“å®ƒå‘ç°ç¼“å­˜é‡å»ºå¥½äº†ï¼Œå®ƒåœ¨å»åšç¼“å­˜çš„æ­£å¸¸è¾“å‡ºï¼Œè¿™ä¸ªç°è±¡çš„é—®é¢˜å°±æ˜¯è¯´æœ‰å¤§é‡çº¿ç¨‹éƒ½ä¼šåšç¼“å­˜é‡å»ºï¼ŒæŸ¥è¯¢æ•°æ®æºè¿™æ ·çš„å·¥ä½œï¼Œä¸€ä¸ªæ˜¯å¯¹æ•°æ®åº“æœ‰å¾ˆå¤§çš„å‹åŠ›ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯å®ƒçš„å“åº”æ—¶é—´ä¼šå¾ˆæ…¢ï¼›</p><p>ä»¥ä¸Šé—®é¢˜è¦æ€ä¹ˆè§£å†³å‘¢ï¼Ÿè¿™é‡Œæ¶‰åŠåˆ°3ä¸ªç›®æ ‡å’Œ2ä¸ªè§£å†³æ–¹æ³•</p><ol><li>ä¸‰ä¸ªç›®æ ‡ï¼š<ul><li>å‡å°‘é‡ç¼“å­˜çš„æ¬¡æ•°ï¼Œä¸è¦åƒä¸Šé¢é‚£æ ·é‚£ä¹ˆå¤šé‡å»ºç¼“å­˜ï¼›</li><li>æ•°æ®å°½å¯èƒ½ä¸€è‡´ï¼šé‡å»ºç¼“å­˜è™½ç„¶åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œä½†æ˜¯æˆ‘ä»¬è¦è§£å†³çš„æ—¶å€™è¦è€ƒè™‘åˆ°æ•°æ®è¦å°½å¯èƒ½ä¸€è‡´ï¼›</li><li>å‡å°‘æ½œåœ¨çš„å±é™©ï¼šä¾‹å¦‚å¯èƒ½ä¼šå‡ºç°æ­»é”æˆ–è€…çº¿ç¨‹æ± å¤§é‡è¢«hangä½ï¼›</li></ul></li><li>ä¸¤ä¸ªè§£å†³ï¼š<ul><li>äº’æ–¥é”ï¼ˆmutex keyï¼‰ï¼›</li><li>æ°¸è¿œä¸è¿‡æœŸ</li></ul></li></ol><h2 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h2><p>äº’æ–¥é”æ˜¯æ¯”è¾ƒç›´è§‚çš„è§£å†³æ€è·¯ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572533989439.png" srcset="/img/loading.gif" alt="1572533989439"></p><p>é¦–å…ˆæ˜¯è·å–ç¼“å­˜çš„æ—¶é—´ç‚¹ï¼Œä½†æ˜¯æˆ‘ç¬¬ä¸€ä¸ªè·å–ç¼“å­˜å®ƒéœ€è¦åšé‡å»ºçš„çº¿ç¨‹å¦‚æœå‘ç°äº†å®ƒå·²ç»åˆ°äº†éœ€è¦é‡å»ºçš„æ—¶å€™ï¼Œé‚£æˆ‘å°±ä¼šæŠŠé‡å»ºåŠ ä¸ŠæŸ¥è¯¢æ•°æ®åº“è¿™ä¸ªè¿‡ç¨‹åŠ ä¸Šä¸€æŠŠé”ï¼Œç„¶åå½“æˆ‘åœ¨è¿™ä¸ªæ—¶é—´æ®µå®Œæˆè¿™ä¸ªå·¥ä½œçš„æ—¶å€™å†æŠŠé”è§£å¼€ï¼Œå†å»åšä¸€ä¸ªè¾“å‡ºï¼Œåœ¨è¿™ä¸ªæœŸé—´å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹æˆ–è€…å…¶ä»–è®¿é—®åœ¨åšè·å–ç¼“å­˜çš„æ—¶å€™å®ƒçš„è¿‡ç¨‹ä¼šå˜æˆï¼šè·å–ç¼“å­˜ï¼Œå‘ç°è¿™ä¸ªé‡å»ºè¿‡ç¨‹è¢«é”ä½äº†ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åšè¿™æ ·çš„äº‹ï¼Œé‚£æˆ‘åªæœ‰å»ç­‰å¾…ï¼Œç­‰å¾…å®Œä¹‹åå†è¾“å‡ºï¼Œåªæœ‰åˆ°æœ€åä¸€ä¸ªå‘ç°é”è§£å¼€äº†çš„æ—¶å€™æˆ‘å°±å¯ä»¥ç›´æ¥è·å–åˆ°è¾“å‡ºçš„ç»“æœï¼Œè¿™ä¸ªå°±æ˜¯åˆ©ç”¨äº’æ–¥é”æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªæ€è·¯ç®€å•é‚£å®ƒå¯èƒ½ä¼šæœ‰ä¸€äº›é—®é¢˜çš„ï¼Œå®ƒè§£å†³äº†ä¸€äº›é—®é¢˜ï¼Œå®ƒä¸éœ€è¦å¤§é‡é‡å»ºè¿‡ç¨‹ï¼Œä½†æ˜¯å®ƒè¿˜ä¼šæœ‰ç­‰å¾…çš„è¿‡ç¨‹ï¼Œä¼šå­˜åœ¨å¤§é‡çº¿ç¨‹ã€è¯·æ±‚è¢«hangä¸»çš„é—®é¢˜ã€‚</p><p>å®ä¾‹ä»£ç ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572533975254.png" srcset="/img/loading.gif" alt="1572533975254"></p><h2 id="æ°¸ä¸è¿‡æœŸ"><a href="#æ°¸ä¸è¿‡æœŸ" class="headerlink" title="æ°¸ä¸è¿‡æœŸ"></a>æ°¸ä¸è¿‡æœŸ</h2><ol><li><p>ç¼“å­˜å±‚é¢ï¼šæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆæ²¡æœ‰ç”¨expireï¼‰ï¼›</p></li><li><p>åŠŸèƒ½å±‚é¢ï¼šä¸ºæ¯ä¸ªvalueæ·»åŠ é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œä¾‹å¦‚set hello worldç°åœ¨è¿™ä¸ªworldé‡Œé¢è¦æ·»åŠ ä¸€ä¸ªå±æ€§ï¼šä¾‹å¦‚logicTimeOutï¼ˆé€»è¾‘è¿‡æœŸæ—¶é—´ï¼‰ï¼Œåœ¨æ¯æ¬¡è·å–çš„æ—¶å€™ï¼Œå»getå‡ºæ¥å®ƒçš„é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œæˆ‘ä»¬å¦‚æœå‘ç°å®ƒé€»è¾‘ä¸Šå·²ç»è¿‡æœŸäº†ï¼Œé‚£æˆ‘ä»¬å°±ä½¿ç”¨å•ç‹¬çš„ä¸€ä¸ªçº¿ç¨‹å®Œæˆç¼“å­˜çš„é‡å»ºï¼Œè¿™æ ·å°±ä¼šæœ‰ä¸€ä¸ªå¥½å¤„ï¼Œç›¸æ¯”ä¹‹å‰çš„äº’æ–¥é”çš„æ–¹æ¡ˆå®ƒä¸ä¼šæœ‰ä¸€ä¸ªç­‰å¾…çš„è¿‡ç¨‹ï¼Œè€Œä¸”å®ƒä¹Ÿå¯ä»¥ä¿è¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆç¼“å­˜çš„é‡å»ºå’Œæ•°æ®åº“çš„æŸ¥è¯¢ï¼Œä½†æ˜¯å®ƒæœ‰é—®é¢˜ï¼šå®ƒä¼šå­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› ä¸ºå®ƒæ²¡æœ‰ç­‰åˆ°çœŸæ­£ç¼“å­˜é‡å»ºå®Œç„¶å®Œï¼Œå¯èƒ½ä¼šæ‹¿åˆ°è€çš„ç»“æœï¼Œä¸‹é¢æ¥ä¸¾ä¸ªä¾‹å­ï¼š</p></li></ol><p>   é¦–å…ˆåœ¨T1æ—¶é—´ç‚¹è·å–ç¼“å­˜ï¼Œå®ƒå‘ç°æ— éœ€ç­‰å¾…ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¼“å­˜æ°¸è¿œä¸ä¼šè¿‡æœŸï¼Œä¸ä¼šå­˜åœ¨é€šè¿‡ç¼“å­˜è·å–ä¸åˆ°æ¥å®Œæˆç¼“å­˜é‡å»ºçš„è¿‡ç¨‹ï¼Œç„¶åç›´æ¥å°±èƒ½è¾“å‡ºç»“æœï¼Œå½“T2æ—¶é—´ç‚¹çš„æ—¶å€™ï¼Œå®ƒå‘ç°é€»è¾‘è¿‡æœŸæ—¶é—´åˆ°äº†ï¼Œä¾‹å¦‚å®ƒçš„valueåŒ…æ‹¬é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦å®Œæˆé‡å»ºç¼“å­˜ï¼Œä½†æ˜¯å®ƒè¦ç­‰T4æ‰èƒ½å®Œæˆï¼Œå®ƒéœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¿™ä¸ªæ—¶å€™T3å»è®¿é—®çš„æ—¶å€™ä¾ç„¶ä¼šè¾“å‡ºè€çš„å€¼ï¼Œç”±äºç°åœ¨æ²¡æœ‰ç¼“å­˜è¿‡æœŸçš„æƒ…å†µï¼Œè™½ç„¶ç°åœ¨å·²ç»è¿‡äº†é€»è¾‘è¿‡æœŸæ—¶é—´ï¼Œä½†æ˜¯æœ¬èº«ç¼“å­˜æ²¡æœ‰è¿‡æœŸï¼Œé‚£ä¹ˆå®ƒå°±å¯ä»¥è¾“å‡ºè€çš„å€¼ï¼Œå½“T4å®Œæˆçš„æ—¶å€™ï¼Œæˆ‘å†è·å–ç¼“å­˜å®ƒå°±ä¼šè¾“å‡ºæ–°çš„å€¼ï¼Œè¿™æ ·å°±ä¿è¯äº†åˆšæ‰è¯´çš„2ä¸ªé—®é¢˜çš„è§£å†³ï¼Œä¸€ä¸ªæ˜¯çº¿ç¨‹æ— éœ€ç­‰å¾…ï¼Œå¦ä¸€ä¸ªæ˜¯æ•´ä¸ªç¼“å­˜çš„æ„å»ºã€é‡å»ºåªéœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆï¼›</p><p>   ä¼ªä»£ç ï¼š</p><p>   <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572535701123.png" srcset="/img/loading.gif" alt="1572535701123"></p><h2 id="ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”"><a href="#ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”"></a>ä¸¤ç§æ–¹æ¡ˆå¯¹æ¯”</h2><p>   <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572535719544.png" srcset="/img/loading.gif" alt="1572535719544"></p><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul><li>ç¼“å­˜æ”¶ç›Šï¼šåŠ é€Ÿè¯»å†™ã€é™ä½åç«¯å­˜å‚¨è´Ÿè½½ï¼›</li><li>ç¼“å­˜æˆæœ¬ï¼šç¼“å­˜å’Œå­˜å‚¨æ•°æ®ä¸ä¸€è‡´ã€ä»£ç ç»´æŠ¤æˆæœ¬ã€è¿ç»´æˆæœ¬ï¼›</li><li>æ¨èé›†åˆå‰”é™¤ã€è¶…æ—¶ã€ä¸»åŠ¨æ›´æ–°ä¸‰ç§æ–¹æ¡ˆå…±åŒå®Œæˆï¼›</li><li>ç©¿é€é—®é¢˜ï¼šä½¿ç”¨ç¼“å­˜ç©ºå¯¹è±¡å’Œå¸ƒéš†è¿‡æ»¤å™¨æ¥è§£å†³ï¼Œæ³¨æ„å®ƒä»¬å„è‡ªçš„ä½¿ç”¨åœºæ™¯å’Œå±€é™æ€§ï¼›</li><li>æ— åº•æ´é—®é¢˜ï¼šåˆ†å¸ƒå¼ç¼“å­˜ä¸­ï¼Œæœ‰æ›´å¤šçš„æœºå™¨ä¸ä¿è¯æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚æœ‰å››ç§æ‰¹é‡æ“ä½œæ–¹å¼ï¼šä¸²è¡Œå‘½ä»¤ã€ä¸²è¡ŒIOã€å¹¶è¡ŒIOã€hash_tagï¼›</li><li>é›ªå´©é—®é¢˜ï¼šç¼“å­˜å±‚é«˜å¯ç”¨ã€å®¢æˆ·ç«¯é™çº§ã€æå‰æ¼”ç»ƒæ˜¯è§£å†³é›ªå´©é—®é¢˜çš„é‡è¦æ–¹æ³•ï¼›</li><li>çƒ­ç‚¹keyé—®é¢˜ï¼šäº’æ–¥é”ã€â€œæ°¸è¿œä¸è¿‡æœŸâ€èƒ½å¤Ÿåœ¨ä¸€å®šç¨‹åº¦ä¸Šè§£å†³çƒ­ç‚¹keyé—®é¢˜ï¼Œå¼€å‘äººå‘˜åœ¨ä½¿ç”¨æ—¶è¦äº†è§£å®ƒä»¬å„è‡ªçš„ä½¿ç”¨æˆæœ¬ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 9.æ·±å…¥Redis Cluster</title>
    <link href="/redis-9.html"/>
    <url>/redis-9.html</url>
    
    <content type="html"><![CDATA[<h1 id="é›†ç¾¤ç¼©å®¹"><a href="#é›†ç¾¤ç¼©å®¹" class="headerlink" title="é›†ç¾¤ç¼©å®¹"></a>é›†ç¾¤ç¼©å®¹</h1><h2 id="ä¼¸ç¼©åŸç†"><a href="#ä¼¸ç¼©åŸç†" class="headerlink" title="ä¼¸ç¼©åŸç†"></a>ä¼¸ç¼©åŸç†</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572147297362.png" srcset="/img/loading.gif" alt="1572147297362"></p><p>ä¼¸å°±æ˜¯åŠ èŠ‚ç‚¹ï¼Œç¼©å°±æ˜¯æŸäº›èŠ‚ç‚¹ä¸éœ€è¦äº†ï¼Œéœ€è¦å°†ä»–ä»¬è¿›è¡Œä¸‹çº¿</p><h2 id="æ‰©å®¹é›†ç¾¤"><a href="#æ‰©å®¹é›†ç¾¤" class="headerlink" title="æ‰©å®¹é›†ç¾¤"></a>æ‰©å®¹é›†ç¾¤</h2><h3 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><ul><li>å‡†å¤‡æ–°èŠ‚ç‚¹ï¼›</li><li>åŠ å…¥é›†ç¾¤ï¼ˆmeetï¼‰ï¼›</li><li>è¿ç§»æ§½å’Œæ•°æ®ï¼ŒæŠŠå…¶ä»–èŠ‚ç‚¹çš„æ§½æ•°æ®å‡åŒ€çš„ç§»åˆ°è¿™ä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰æ•°æ®æ˜¯æ²¡æœ‰ ä»»ä½•æ„ä¹‰çš„,è¿™ä¸ªèŠ‚ç‚¹å°±å¯ä»¥å·¥ä½œäº†ï¼Œå®ç°æ€§èƒ½çš„æ‰©å±•ã€‚å½“ç„¶å¦‚æœæ˜¯ä»èŠ‚ç‚¹ï¼Œç»™å®ƒmeetå°±å¥½äº†ï¼Œä¸ç”¨åšæ§½çš„è¿ç§»ã€‚</li></ul><h3 id="å‡†å¤‡æ–°èŠ‚ç‚¹"><a href="#å‡†å¤‡æ–°èŠ‚ç‚¹" class="headerlink" title="å‡†å¤‡æ–°èŠ‚ç‚¹"></a>å‡†å¤‡æ–°èŠ‚ç‚¹</h3><ul><li><p>é›†ç¾¤æ¨¡å¼ï¼›</p></li><li><p>é…ç½®å’Œå…¶ä»–èŠ‚ç‚¹ç»Ÿä¸€ï¼›</p></li><li><p>å¯åŠ¨åæ˜¯å­¤å„¿èŠ‚ç‚¹ï¼›</p><pre><code class="hljs bash">redis-server conf/redis-6385.confredis-server conf/redis-6386.conf</code></pre><p>å¯åŠ¨ä¹‹åçš„æ•ˆæœ</p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572147740859.png" srcset="/img/loading.gif" alt="1572147740859" style="zoom:50%;" /></li></ul><h3 id="åŠ å…¥é›†ç¾¤"><a href="#åŠ å…¥é›†ç¾¤" class="headerlink" title="åŠ å…¥é›†ç¾¤"></a>åŠ å…¥é›†ç¾¤</h3><pre><code class="hljs bash">127.0.0.1:6379&gt; cluster meet 127.0.0.1 6385127.0.0.1:6379&gt; cluster meet 127.0.0.1 6386</code></pre><p>åŠ å…¥ä¹‹åçš„æ•ˆæœï¼š<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572147701603.png" srcset="/img/loading.gif" alt="1572147701603" style="zoom: 50%;" /></p><p>ä½œç”¨ï¼š</p><ul><li>ä¸ºå®ƒè¿ç§»æ§½å’Œæ•°æ®å®ç°æ‰©å®¹ï¼›</li><li>ä½œä¸ºä»èŠ‚ç‚¹è´Ÿè´£æ•…éšœè½¬ç§»ï¼›</li></ul><p>ä½¿ç”¨redis-trib.rbï¼š</p><blockquote><p>åœ¨redisä¸­æä¾›äº†åŠ å…¥èŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæä¾›çš„å·¥å…·ç®€å•çš„åŠ å…¥</p></blockquote><ul><li>redis-trib.rb add-node new_host: new_port existing _host:existing_port â€“slave master-id <arg></li><li>redis-trib.rb add-node 127.0.0.1:6385 127.0.0.1:6379</li><li>å»ºè®®ä½¿ç”¨redis-trib:rbèƒ½å¤Ÿé¿å…æ–°èŠ‚ç‚¹å·²ç»åŠ å…¥äº†å…¶ä»–é›†ç¾¤,é€ æˆæ•…éšœã€‚</li></ul><h2 id="è¿ç§»æ§½å’Œæ•°æ®"><a href="#è¿ç§»æ§½å’Œæ•°æ®" class="headerlink" title="è¿ç§»æ§½å’Œæ•°æ®"></a>è¿ç§»æ§½å’Œæ•°æ®</h2><h3 id="æ­¥éª¤-1"><a href="#æ­¥éª¤-1" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h3><ul><li>è¿ç§»è®¡åˆ’</li><li>è¿ç§»æ•°æ®</li><li>æ·»åŠ ä»èŠ‚ç‚¹</li></ul><h3 id="è¿ç§»è®¡åˆ’"><a href="#è¿ç§»è®¡åˆ’" class="headerlink" title="è¿ç§»è®¡åˆ’"></a>è¿ç§»è®¡åˆ’</h3><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572148492017.png" srcset="/img/loading.gif" alt="1572148492017"  /><h3 id="è¿ç§»æ•°æ®"><a href="#è¿ç§»æ•°æ®" class="headerlink" title="è¿ç§»æ•°æ®"></a>è¿ç§»æ•°æ®</h3><p>æ­¥éª¤</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572149049846.png" srcset="/img/loading.gif" alt="1572149049846"></p><p>æµç¨‹å›¾</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572149126364.png" srcset="/img/loading.gif" alt="1572149126364"></p><p>ä¼ªä»£ç </p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572149146990.png" srcset="/img/loading.gif" alt="1572149146990"></p><h2 id="é›†ç¾¤æ‰©å®¹æ¼”ç¤º"><a href="#é›†ç¾¤æ‰©å®¹æ¼”ç¤º" class="headerlink" title="é›†ç¾¤æ‰©å®¹æ¼”ç¤º"></a>é›†ç¾¤æ‰©å®¹æ¼”ç¤º</h2><p>åŠ å…¥2ä¸ªèŠ‚ç‚¹ï¼š7006ã€7007ï¼Œ7007æ˜¯7006çš„ä»</p><p>é¦–å…ˆæ·»åŠ 2ä¸ªé…ç½®ï¼Œå¹¶å¯åŠ¨</p><pre><code class="hljs bash">[root@mcr2 config] sed <span class="hljs-string">'s/7000/7006/g'</span> redis-7000.conf  &gt; redis-7006.conf[root@mcr2 config] sed <span class="hljs-string">'s/7000/7007/g'</span> redis-7000.conf  &gt; redis-7007.conf[root@mcr2 config] redis-server redis-7006.conf[root@mcr2 config] redis-server redis-7007.conf</code></pre><p>å°†å®ƒä»¬åŠ å…¥åˆ°é›†ç¾¤</p><pre><code class="hljs bash"><span class="hljs-comment">#å°†7006åŠ å…¥é›†ç¾¤</span>[root@mcr2 config] redis-cli  -p 7000 cluster meet 127.0.0.1 7006OK<span class="hljs-comment">#å°†7007åŠ å…¥é›†ç¾¤</span>[root@mcr2 config] redis-cli -p 7000  cluster meet 127.0.0.1 7007OK<span class="hljs-comment">#æŸ¥çœ‹é›†ç¾¤èŠ‚ç‚¹ä¿¡æ¯</span>[root@mcr2 config] redis-cli -p 7000 cluster nodesde08a3a948a73cc2fb8793e122817af1720ed87a 127.0.0.1:7006 master - 0 1572184022492 0 connected....<span class="hljs-comment">#7007å¤åˆ¶7006</span>[root@mcr2 config] redis-cli -p 7007 cluster replicate de08a3a948a73cc2fb8793e122817af1720ed87aOK[root@mcr2 config] redis-trib.rb reshard  127.0.0.1:7000&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)<span class="hljs-comment">#...</span>S: 8e1ac37cc5ec9c66cbfc1eab81b52cef25e9d255 127.0.0.1:7007   slots: (0 slots) slave   replicates de08a3a948a73cc2fb8793e122817af1720ed87aM: de08a3a948a73cc2fb8793e122817af1720ed87a 127.0.0.1:7006   slots: (0 slots) master   1 additional replica(s)<span class="hljs-comment">#...</span>[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check <span class="hljs-keyword">for</span> open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.<span class="hljs-comment">#ä½ å¸Œæœ›è¿ç§»å¤šå°‘ä¸ªæ§½</span>How many slots <span class="hljs-keyword">do</span> you want to move (from 1 to 16384)? 4096<span class="hljs-comment">#å¸Œæœ›å“ªä¸ªidæ¥æ”¶è¿™äº›æ§½</span>What is the receiving node ID? de08a3a948a73cc2fb8793e122817af1720ed87aPlease enter all the <span class="hljs-built_in">source</span> node IDs.<span class="hljs-comment">#æ‰€æœ‰çš„å…¶ä»–èŠ‚ç‚¹ä½œä¸ºä½œä¸ºresource id</span>  Type <span class="hljs-string">'all'</span> to use all the nodes as <span class="hljs-built_in">source</span> nodes <span class="hljs-keyword">for</span> the <span class="hljs-built_in">hash</span> slots.  Type <span class="hljs-string">'done'</span> once you entered all the <span class="hljs-built_in">source</span> nodes IDs.Source node 1: all...    Moving slot 12287 from 325733e9d4ded75d31c68f978c75357334163428<span class="hljs-comment">#æ˜¯å¦æƒ³ç»§ç»­ï¼Ÿ    </span>Do you want to proceed with the proposed reshard plan (yes/no)? yes<span class="hljs-comment">#ä»¥ä¸Šæ­¥éª¤å®Œæˆè¿ç§»ï¼Œæ¥æ£€éªŒä¸€ä¸‹</span>[root@mcr2 config] redis-cli -p 7000 cluster slots<span class="hljs-comment">#...</span>2) 1) (<span class="hljs-built_in">integer</span>) 0   2) (<span class="hljs-built_in">integer</span>) 1364   3) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7006   4) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7007<span class="hljs-comment">#...</span></code></pre><h2 id="ç¼©å®¹é›†ç¾¤"><a href="#ç¼©å®¹é›†ç¾¤" class="headerlink" title="ç¼©å®¹é›†ç¾¤"></a>ç¼©å®¹é›†ç¾¤</h2><h3 id="è¯´æ˜"><a href="#è¯´æ˜" class="headerlink" title="è¯´æ˜"></a>è¯´æ˜</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572157852975.png" srcset="/img/loading.gif" alt="1572157852975"></p><p>é›†ç¾¤ç¼©å®¹å’Œæ‰©å®¹æœ‰å¾ˆå¤šç›¸ä¼¼çš„åœ°æ–¹ï¼Œä¾‹å¦‚éœ€è¦å°†æ§½çš„æ•°æ®è¿›è¡Œè¿ç§»ï¼Œå°±æ˜¯ä¸Šé¢è¿™å¼ å›¾ã€‚</p><p>ç¼©å®¹è¦å¯¹èŠ‚ç‚¹è¿›è¡Œä¸‹çº¿ï¼Œç„¶åå†è¿›è¡Œ3ä¸ªæ­¥éª¤ï¼š</p><ol><li><p>ä¸‹çº¿è¿ç§»æ§½ï¼šå‰ææ˜¯å½“å‰ä¸‹çº¿èŠ‚ç‚¹æ˜¯å¦æœ‰æ§½ï¼Œå¦‚æœæ²¡æœ‰å°±ä¸ç”¨ï¼Œ                                                    <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572157887160.png" srcset="/img/loading.gif" alt="1572157887160" style="zoom:33%;" />ä¸‹çº¿è¿ç§»æ§½å’Œå‰é¢è¯´çš„æ‰©å®¹æ˜¯ä¸€æ ·çš„ï¼Œæ‰©å®¹ï¼šå…¶ä»–èŠ‚ç‚¹å¾€è¿ç§»slotï¼Œä¸‹çº¿æ§½ï¼šå°†ä¸‹çº¿èŠ‚ç‚¹çš„æ‰€æœ‰æ§½å‡åŒ€è¿ç§»ç»™å…¶ä»–èŠ‚ç‚¹ï¼›</p></li><li><p>å¿˜è®°èŠ‚ç‚¹ï¼šRedis Clusteré›†ç¾¤è¿™äº›èŠ‚ç‚¹éœ€è¦å¿˜è®°å®ƒï¼Œå› ä¸ºé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´                                                          æ˜¯å…±äº«æ¶ˆæ¯çš„ï¼Œä½ è¦å‘Šè¯‰æ¯ä¸ªèŠ‚ç‚¹å»å¿˜è®°å®ƒï¼Œ<br>å‘½ä»¤ï¼š<code>redis&gt;cli cluster forget {downNodeId}</code><br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572158164591.png" srcset="/img/loading.gif" alt="1572158164591"></p><p>è¿™é‡Œçš„æœ‰æ•ˆæ—¶é—´æ˜¯60ç§’ï¼Œåœ¨60ç§’ä¹‹å†…æœ‰ä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰å¿˜è®°å®ƒï¼Œä»ç„¶ä¼šæœ‰æ¶ˆæ¯ï¼Œæ‰€ä»¥è¯´ä½ è¦æƒ³è®©ä¸€ä¸ªèŠ‚ç‚¹çœŸæ­£çš„ä¸‹çº¿ä½ éœ€è¦å¯¹æ‰€æœ‰èŠ‚ç‚¹å»å¿˜è®°ï¼›</p></li><li><p>å…³é—­èŠ‚ç‚¹ï¼šå½“æ‰€æœ‰èŠ‚ç‚¹éƒ½å¿˜è®°å®ƒä¹‹åå†å¯¹èŠ‚ç‚¹è¿›è¡Œå…³é—­ã€‚</p></li></ol><h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><p> å°†7006å’Œ7007è¿›è¡Œä¸‹çº¿ï¼Œé¦–å…ˆå…ˆå°†7006çš„æ§½è¿ç§»åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Š</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster nodes709ce3bd4d8fba5f62f57d7ec3b64569a070f22d 127.0.0.1:7000 myself,master - 0 0 1 co                                                                nnected 1365-54608e1ac37cc5ec9c66cbfc1eab81b52cef25e9d255 127.0.0.1:7007 slave de08a3a948a73cc2fb                                                                8793e122817af1720ed87a 0 1572187198417 8 connectedde08a3a948a73cc2fb8793e122817af1720ed87a 127.0.0.1:7006 master - 0 1572187201437                                                                 8 connected 0-1364 5461-6826 10923-12287<span class="hljs-comment">#...çœç•¥å…¶ä»–èŠ‚ç‚¹ä¿¡æ¯</span>[root@mcr2 config] redis-trib.rb reshard  \--from <span class="hljs-variable">$&#123;7007çš„node-id&#125;</span>  \--to  <span class="hljs-variable">$&#123;7000çš„node-id&#125;</span> \--slots 1366 127.0.0.1:7006 <span class="hljs-comment">#åœ¨å“ªé‡Œè¿è¡Œ</span><span class="hljs-comment">#æ˜¯å¦åŒæ„</span>Do you want to proceed with the proposed reshard plan (yes/no)? yes<span class="hljs-comment">#ç„¶åå‰©ä½™çš„æ§½ä¹Ÿåˆ†ç»™å…¶ä»–èŠ‚ç‚¹</span>[root@mcr2 config] redis-trib.rb reshard \--from <span class="hljs-variable">$&#123;7007çš„node-id&#125;</span>  \--to  <span class="hljs-variable">$&#123;7001çš„node-id&#125;</span> \--slots 1366 127.0.0.1:7006[root@mcr2 config] redis-trib.rb reshard \--from <span class="hljs-variable">$&#123;7007çš„node-id&#125;</span>  \--to  <span class="hljs-variable">$&#123;7002çš„node-id&#125;</span> \--slots 1365 127.0.0.1:7006<span class="hljs-comment">#æŸ¥çœ‹7006èŠ‚ç‚¹ï¼Œç°åœ¨å®ƒçš„æ§½æ˜¾ç¤º0ä¸ª</span>[root@mcr2 config] redis-cli -p 7000 cluster nodesde08a3a948a73cc2fb8793e122817af1720ed87a 127.0.0.1:7006 master - 0 1572187933544 8 connected</code></pre><p>å¿˜è®°èŠ‚ç‚¹</p><pre><code class="hljs bash">[root@mcr2 config] redis-trib.rb del-node   \127.0.0.1:7000   \ <span class="hljs-comment">#ä»»æ„èŠ‚ç‚¹</span><span class="hljs-variable">$&#123;7007:node-id&#125;</span><span class="hljs-comment">#è¿”å›ç»“æœ</span>&gt;&gt;&gt; Removing node de08a3a948a73cc2fb8793e122817af1720ed87a from cluster 127.0.0.1:7000&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node.<span class="hljs-comment">#æŸ¥çœ‹7007æ˜¯å¦å­˜åœ¨</span>[root@mcr2 config] redis-cli -p 7007Could not connect to Redis at 127.0.0.1:7006: Connection refusednot connected&gt; <span class="hljs-built_in">exit</span><span class="hljs-comment">#ä¸‹çº¿7006</span>[root@mcr2 config] redis-trib.rb del-node   \127.0.0.1:7000   \ <span class="hljs-comment">#ä»»æ„èŠ‚ç‚¹</span><span class="hljs-variable">$&#123;7006:node-id&#125;</span></code></pre><blockquote><p>è¿™é‡Œè¦è¯´ä¸€ä¸‹ï¼Œä¸‹çº¿çš„æ—¶å€™è¦å…ˆä¸‹ä»èŠ‚ç‚¹ï¼Œç„¶åå†ä¸‹ä¸»èŠ‚ç‚¹</p></blockquote><h1 id="å®¢æˆ·ç«¯è·¯ç”±"><a href="#å®¢æˆ·ç«¯è·¯ç”±" class="headerlink" title="å®¢æˆ·ç«¯è·¯ç”±"></a>å®¢æˆ·ç«¯è·¯ç”±</h1><h2 id="movedé‡å®šå‘"><a href="#movedé‡å®šå‘" class="headerlink" title="movedé‡å®šå‘"></a>movedé‡å®šå‘</h2><ol><li>å®¢æˆ·ç«¯å‘é€å‘ä»»æ„èŠ‚ç‚¹å‘é€å‘½ä»¤</li><li>æœåŠ¡ç«¯è®¡ç®—keyçš„ARC16å“ˆå¸Œå€¼ï¼Œæ›´16383å»å–ä½™ï¼Œç®—å‡ºå®ƒçš„æ§½ï¼Œ<ul><li>å¦‚æœè¿™ä¸ªæ•°æ®çš„å“ˆå¸Œç®—å‡ºæ¥çš„æ§½æ˜¯è‡ªèº«çš„ï¼Œç›´æ¥ä¼šè¿”å›æ‰§è¡Œç»“æœï¼›<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572163727292.png" srcset="/img/loading.gif" alt="1572163727292"></li><li>å¦‚æœä¸æ˜¯ï¼Œè¿”å›movedå¼‚å¸¸å¹¶å‘Šè¯‰å®¢æˆ·ç«¯è¿™ä¸ªkeyå±äºå“ªä¸ªèŠ‚ç‚¹çš„ï¼Œå®¢æˆ·ç«¯æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸ï¼Œæ ¹æ®å¼‚å¸¸å»é‡å®šå‘å‘é€ç»™å¯¹åº”çš„èŠ‚ç‚¹å»æ‰§è¡Œ<br><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572163776375.png" srcset="/img/loading.gif" alt="1572163776375"></li></ul></li></ol><p>redis-cli</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -c -p 7000<span class="hljs-comment"># -cï¼šä½¿ç”¨é›†ç¾¤æ¨¡å¼ï¼Œå®ƒä¼šå¸®åŠ©ä½ è‡ªåŠ¨å®Œæˆè·³è½¬</span>127.0.0.1:7000&gt; CLUSTER KEYSLOT hello(<span class="hljs-built_in">integer</span>) 866127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> hello worldOK127.0.0.1:7000&gt; CLUSTER KEYSLOT php(<span class="hljs-built_in">integer</span>) 9244127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> php best<span class="hljs-comment"># è‡ªåŠ¨é‡å®šå‘åˆ°7001èŠ‚ç‚¹</span>-&gt; Redirected to slot [9244] located at 127.0.0.1:7001OK<span class="hljs-comment">#è‡ªåŠ¨æ”¹å˜è¿æ¥èŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œç¼–ç¨‹äº†7001</span>127.0.0.1:7001&gt;<span class="hljs-comment">#ä¸ä½¿ç”¨é›†ç¾¤æ¨¡å¼çš„æƒ…å†µï¼š</span>[root@mcr2 config] redis-cli  -p 7000127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> php best(error) MOVED 9244 127.0.0.1:7001</code></pre><h2 id="aské‡å®šå‘"><a href="#aské‡å®šå‘" class="headerlink" title="aské‡å®šå‘"></a>aské‡å®šå‘</h2><p>å‰é¢ä»‹ç»äº†é›†ç¾¤çš„ä¼¸ç¼©ï¼Œåœ¨é›†ç¾¤ä¼¸ç¼©çš„è¿‡ç¨‹ä¸­å°±æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¯¹æ§½è¿ç§»ï¼Œè¿™ä¸ªå¯¹äºå®¢æˆ·ç«¯æ¥è¯´æ˜¯ä¸€ä¸ªæŒ‘æˆ˜ï¼Œå› ä¸ºåœ¨å®¢æˆ·ç«¯ä¸­è®°å½•çš„æ˜¯åŸèŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹å‘Šè¯‰å®¢æˆ·ç«¯æ•°æ®çš„ä½ç½®åœ¨åŸèŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨è®¿é—®çš„æ—¶å€™å‘ç°keyè¿ç§»åˆ°äº†ç›®æ ‡èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è€ƒè™‘è®¾è®¡ä¸€ç§æ–¹æ¡ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒRedis Clusterå°±è€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢çœ‹ä¸‹å®ƒçš„å®ç°æ¼”ç¤º</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572168669668.png" srcset="/img/loading.gif" alt="1572168669668"></p><ol><li>å‡å¦‚è¯´sourceèŠ‚ç‚¹å’ŒtargetèŠ‚ç‚¹æ­£åœ¨è¿ç§»ä¸€ä¸ªæ§½ï¼›</li><li>è¿™ä¸ªæ—¶å€™å®¢æˆ·ç«¯å‘é€ä¸€æ¡å‘½ä»¤ï¼›</li><li>æœåŠ¡ç«¯ä¼šå›å¤å®¢æˆ·ç«¯è¿™ä¸ªé”®æ˜¯åœ¨åŸèŠ‚ç‚¹ï¼Œä½†æ˜¯è¿™ä¸ªæ§½å·²ç»è¿ç§»åˆ°äº†targetèŠ‚ç‚¹ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªaskè½¬å‘å¼‚å¸¸ï¼›</li><li>å®¢æˆ·ç«¯æ”¶åˆ°askå¼‚å¸¸çš„æ—¶å€™é¦–å…ˆä¼šæ‰§è¡ŒAskingå‘½ä»¤ï¼Œç„¶åç»™ç›®æ ‡èŠ‚ç‚¹åŒæ—¶å»å‘é€ä¹‹å‰çš„å‘½ä»¤ï¼›</li><li>ç„¶åå°±ä¼šè¿”å›å¯¹åº”çš„ç»“æœã€‚</li></ol><h2 id="movedå’Œaskçš„åŒºåˆ«"><a href="#movedå’Œaskçš„åŒºåˆ«" class="headerlink" title="movedå’Œaskçš„åŒºåˆ«"></a>movedå’Œaskçš„åŒºåˆ«</h2><ul><li>ä¸¤ç§éƒ½æ˜¯å®¢æˆ·ç«¯é‡å®šå‘ï¼›</li><li>movedï¼šæ§½å·²ç»ç¡®å®šè¿ç§»ï¼›</li><li>askï¼šæ§½åœ¨è¿ç§»è¿‡ç¨‹ä¸­ã€‚</li></ul><h2 id="smartå®¢æˆ·ç«¯"><a href="#smartå®¢æˆ·ç«¯" class="headerlink" title="smartå®¢æˆ·ç«¯"></a>smartå®¢æˆ·ç«¯</h2><h3 id="smartå®¢æˆ·ç«¯åŸç†"><a href="#smartå®¢æˆ·ç«¯åŸç†" class="headerlink" title="smartå®¢æˆ·ç«¯åŸç†"></a>smartå®¢æˆ·ç«¯åŸç†</h3><ol><li>ä»é›†ç¾¤ä¸­é€‰æ‹©æ¶ä¸€ä¸ªå¯è¿è¡Œçš„èŠ‚ç‚¹ï¼Œä½¿ç”¨ cluster slotsåˆå§‹åŒ–æ§½å’ŒèŠ‚ç‚¹æ˜ å°„ï¼›</li><li>å°†cluster slotsçš„ç»“æœæ˜ å°„åˆ°æœ¬åœ°ï¼Œä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºJedisPoolï¼›</li><li>å‡†å¤‡æ‰§è¡Œå‘½ä»¤ã€‚</li></ol><h3 id="æ‰§è¡Œå‘½ä»¤åŸºæœ¬æ­¥éª¤"><a href="#æ‰§è¡Œå‘½ä»¤åŸºæœ¬æ­¥éª¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤åŸºæœ¬æ­¥éª¤"></a>æ‰§è¡Œå‘½ä»¤åŸºæœ¬æ­¥éª¤</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572179020424.png" srcset="/img/loading.gif" alt="1572179020424"></p><p>JedisClusterå†…éƒ¨ç¼“å­˜äº†slotå’ŒèŠ‚ç‚¹çš„å…³ç³»ï¼Œè€Œä¸”å¯¹äºkeyå’Œslotçš„å…³ç³»å®ƒæ˜¯å¯ä»¥çŸ¥é“çš„ï¼Œå› ä¸ºè¿™ä¸ªå…³ç³»æ˜¯å…¬å¼€çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ªCRC16å»å¯¹keyåšä¸€ä¸ªå“ˆå¸Œç®—å‡ºä¸€ä¸ª16383çš„æ¨¡ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„æ§½å°±èƒ½æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼Œå¦‚æœåœ¨å‘é€å‘½ä»¤çš„æ—¶å€™è¿æ¥å‡ºé”™ï¼Œå®¢æˆ·ç«¯ä¼šå°†å®ƒç†è§£ä¸ºé”™è¯¯çš„èŠ‚ç‚¹ï¼Œè¿™é‡Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¯¹è¿™ä¸ªèŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œç„¶åè¿”å›movedå¼‚å¸¸ï¼Œè¿™ä¸ªå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯movedï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä¸€ä¸ªå¾ˆå¤§çš„é›†ç¾¤æ‰§è¡ŒéšæœºèŠ‚ç‚¹å»æ‰§è¡Œkeyè‚¯å®šä¼šè¿”å›movedï¼Œç„¶åä¼šé‡æ–°åˆå§‹åŒ–slotå’Œnodeçš„å…³ç³»å†å»ç›®æ ‡èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œç„¶åçŸ¥é“å“åº”ç»“æœï¼Œå¦‚æœè¿™æ ·çš„è¿‡ç¨‹è¶…è¿‡5æ¬¡å®ƒå°±ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ï¼š<code>Too many cluster redirectionï¼</code>ï¼Œ</p><h3 id="JedisClusteræ‰§è¡Œæºç åˆ†æ"><a href="#JedisClusteræ‰§è¡Œæºç åˆ†æ" class="headerlink" title="JedisClusteræ‰§è¡Œæºç åˆ†æ"></a>JedisClusteræ‰§è¡Œæºç åˆ†æ</h3><p>JedisCluster</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">set</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String key, <span class="hljs-keyword">final</span> String value)</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JedisClusterCommand&lt;String&gt;(connectionHandler, maxAttempts) &#123;      <span class="hljs-meta">@Override</span>      <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">execute</span><span class="hljs-params">(Jedis connection)</span> </span>&#123;        <span class="hljs-keyword">return</span> connection.set(key, value);      &#125;    &#125;.run(key);  &#125;<span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String key)</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JedisClusterCommand&lt;String&gt;(connectionHandler, maxAttempts) &#123;      <span class="hljs-meta">@Override</span>      <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">execute</span><span class="hljs-params">(Jedis connection)</span> </span>&#123;        <span class="hljs-keyword">return</span> connection.get(key);      &#125;    &#125;.run(key);  &#125;</code></pre><p>ä»ä¸Šé¢çœ‹å‡ºæ¥ï¼Œå®ƒçš„æ¯ä¸ªå‘½ä»¤éƒ½æ˜¯é€šè¿‡äº‹å…ˆJedisClusterCommandç±»çš„executeæ–¹æ³•ï¼Œç„¶åè°ƒç”¨runæ–¹æ³•ï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªç±»</p><hr><p>JedisClusterCommand#run</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">run</span><span class="hljs-params">(String key)</span> </span>&#123;    <span class="hljs-keyword">if</span> (key == <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JedisClusterException(<span class="hljs-string">"No way to dispatch this command to Redis Cluster."</span>);    &#125;    <span class="hljs-keyword">return</span> runWithRetries(SafeEncoder.encode(key), <span class="hljs-keyword">this</span>.maxAttempts, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);  &#125;</code></pre><p>è¿™é‡Œé¦–å…ˆåˆ¤æ–­keyæ˜¯ä¸æ˜¯ç©ºçš„ï¼Œè¿™é‡Œæˆ‘ä»¬å…³æ³¨çš„æ˜¯å®ƒçš„runWithRetriesæ–¹æ³•</p><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">private</span> T <span class="hljs-title">runWithRetries</span><span class="hljs-params">(<span class="hljs-keyword">byte</span>[] key, <span class="hljs-keyword">int</span> attempts, <span class="hljs-keyword">boolean</span> tryRandomNode, <span class="hljs-keyword">boolean</span> asking)</span> </span>&#123;      <span class="hljs-comment">//attemptsï¼šå°è¯•ï¼Œè¿™é‡Œåˆå§‹åŒ–ä¸º5æ¬¡</span>    <span class="hljs-keyword">if</span> (attempts &lt;= <span class="hljs-number">0</span>) &#123;     <span class="hljs-comment">//å¦‚æœattemptså°äº0ï¼Œå°±ä¼šè¿”å›ä»¥ä¸‹å¼‚å¸¸</span>     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JedisClusterMaxRedirectionsException(<span class="hljs-string">"Too many Cluster redirections?"</span>);   &#125;      Jedis connection = <span class="hljs-keyword">null</span>;   <span class="hljs-keyword">try</span> &#123;<span class="hljs-comment">//æ˜¯ä¸æ˜¯askingçŠ¶æ€ï¼Œä¸‹é¢ä»£ç å°±æ˜¯è¿›è¡Œaskingçš„ä¸€äº›å¤„ç†ä»£ç </span>     <span class="hljs-keyword">if</span> (asking) &#123;              <span class="hljs-comment">//è·å–æ–°è¿æ¥</span>       connection = askConnection.get();       <span class="hljs-comment">//æ‰§è¡Œaskingï¼ŒæŠŠåˆšæ‰çš„å‘½ä»¤é‡æ–°æ‰§è¡Œä¸€é</span>       connection.asking();       <span class="hljs-comment">// if asking success, reset asking flag</span>       asking = <span class="hljs-keyword">false</span>;     &#125; <span class="hljs-keyword">else</span> &#123;       <span class="hljs-comment">//æˆ‘ä»¬å…ˆçœ‹è¿™é‡Œï¼Œè¿™é‡Œçš„tryRandomNodeï¼šæ˜¯å¦æ˜¯éšæœºèŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¯falseï¼Œå†å‰é¢çš„runæ–¹æ³•ä¼ é€’çš„æ˜¯false   </span>       <span class="hljs-keyword">if</span> (tryRandomNode) &#123;         connection = connectionHandler.getConnection();       &#125; <span class="hljs-keyword">else</span> &#123;         <span class="hljs-comment">//connectionHandlerï¼šè¿™ä¸ªå°±æ˜¯å‰é¢ä»‹ç»çš„ï¼Œåœ¨Jedisåˆå§‹åŒ–çš„æ—¶å€™ï¼Œä¼šåˆå§‹åŒ–æ‰€æœ‰çš„æ§½å’ŒèŠ‚ç‚¹çš„å¯¹åº”å…³ç³»</span>         <span class="hljs-comment">//è¿™é‡Œè°ƒç”¨äº†connectionHandlerçš„getConnectionFromSlotæ–¹æ³•ï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯ä¸€ä¸ªæ–¹æ³• JedisClusterCRC16.getSlot(key)ï¼Œå®ƒä¼šæ ¹æ®keyä¸ºæˆ‘ä»¬è®¡ç®—å‡ºå¯¹åº”çš„æ§½æ˜¯å“ªä¸ªï¼Œè¿™é‡Œä½œä¸ºä¸€ä¸ªè¿™æ ·çš„å‚æ•°ä¼ é€’ç»™getConnectionFromSlotæ–¹æ³•ï¼Œæœ€ç»ˆè·å¾—äº†ä¸€ä¸ªè¿æ¥</span>                  connection = connectionHandler.getConnectionFromSlot(JedisClusterCRC16.getSlot(key));       &#125;     &#125;<span class="hljs-comment">//æ‰§è¡Œå‘½ä»¤</span>     <span class="hljs-keyword">return</span> execute(connection);               <span class="hljs-comment">//å¦‚æœæ²¡æœ‰èŠ‚ç‚¹å¯æ‹¿</span>   &#125; <span class="hljs-keyword">catch</span> (JedisNoReachableClusterNodeException jnrcne) &#123;     <span class="hljs-keyword">throw</span> jnrcne;     <span class="hljs-comment">//è¿æ¥å¼‚å¸¸ï¼Œè¿™é‡Œä¸ä¸€å®šæ˜¯ä¼¸ç¼©å¯¼è‡´çš„å¼‚å¸¸ï¼Œå¯èƒ½æ˜¯ç½‘ç»œåŸå› </span>   &#125; <span class="hljs-keyword">catch</span> (JedisConnectionException jce) &#123;     <span class="hljs-comment">// åœ¨é€’å½’ä¹‹å‰é‡Šæ”¾å½“å‰è¿æ¥</span>     releaseConnection(connection);     connection = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//åˆ¤æ–­attemptsæ˜¯å¦å°äºç­‰äº1</span>     <span class="hljs-keyword">if</span> (attempts &lt;= <span class="hljs-number">1</span>) &#123;     <span class="hljs-comment">//æˆ‘ä»¬éœ€è¦è¿™ä¸ªï¼Œå› ä¸ºå¦‚æœèŠ‚ç‚¹æ˜¯ä¸å¯è¾¾çš„-æˆ‘ä»¬éœ€è¦æœ€ç»ˆå¯åŠ¨æ’æ§½æ›´æ–°ï¼Œ</span>     <span class="hljs-comment">//æˆ–è€…æˆ‘ä»¬å¯ä»¥åœ¨æ²¡æœ‰èŠ‚ç‚¹çš„æƒ…å†µä¸‹ä¿æŒé›†ç¾¤çŠ¶æ€ã€‚</span>     <span class="hljs-comment">//ä½†æ˜¯ç°åœ¨å¦‚æœmax= 1æˆ–2ï¼Œæˆ‘ä»¬å°±ä¼šç»å¸¸è¿™æ ·åšã€‚å¯¹äºæ¯ä¸ªè¶…æ—¶è¯·æ±‚ã€‚</span>     <span class="hljs-comment">//TODOè·Ÿè¸ªèŠ‚ç‚¹æˆåŠŸæˆ–ä¸æˆåŠŸçš„æ“ä½œ- doåªæ›´æ–°</span>     <span class="hljs-comment">//å¦‚æœè¿™ä¸ªèŠ‚ç‚¹åœ¨æœ€åå‡ ç§’å†…æ²¡æœ‰æˆåŠŸçš„å“åº”</span>              <span class="hljs-comment">//åˆ·æ–°æœ¬åœ°ç¼“å­˜</span>       <span class="hljs-keyword">this</span>.connectionHandler.renewSlotCache();       <span class="hljs-comment">//no more redirections left, throw original exception, not JedisClusterMaxRedirectionsException, because it's not MOVED situation</span>       <span class="hljs-keyword">throw</span> jce;     &#125;     <span class="hljs-keyword">return</span> runWithRetries(key, attempts - <span class="hljs-number">1</span>, tryRandomNode, asking);          <span class="hljs-comment">//ä¹‹å‰ä»‹ç»çš„movedå’Œask</span>   &#125; <span class="hljs-keyword">catch</span> (JedisRedirectionException jre) &#123;     <span class="hljs-comment">//å¦‚æœå‘ç°æ˜¯moved ç¡®å®šæ§½ä¸åœ¨å½“å‰èŠ‚ç‚¹ï¼Œ</span>     <span class="hljs-keyword">if</span> (jre <span class="hljs-keyword">instanceof</span> JedisMovedDataException) &#123;       <span class="hljs-comment">// it rebuilds cluster's slot cache</span>       <span class="hljs-comment">// recommended by Redis cluster specification</span>        <span class="hljs-comment">//åˆ·æ–°æœ¬åœ°ç¼“å­˜</span>       <span class="hljs-keyword">this</span>.connectionHandler.renewSlotCache(connection);     &#125;     <span class="hljs-comment">// release current connection before recursion or renewing</span>     releaseConnection(connection);     connection = <span class="hljs-keyword">null</span>;<span class="hljs-comment">// askå¼‚å¸¸ </span>     <span class="hljs-keyword">if</span> (jre <span class="hljs-keyword">instanceof</span> JedisAskDataException) &#123;       asking = <span class="hljs-keyword">true</span>;<span class="hljs-comment">//å¯¹è¿æ¥é‡å®šå‘       </span>       askConnection.set(<span class="hljs-keyword">this</span>.connectionHandler.getConnectionFromNode(jre.getTargetNode()));     &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (jre <span class="hljs-keyword">instanceof</span> JedisMovedDataException) &#123;     &#125; <span class="hljs-keyword">else</span> &#123;       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> JedisClusterException(jre);     &#125;<span class="hljs-comment">//åšé‡è¯•ï¼Œè¿™é‡Œçš„askingä¹‹å‰æ˜¯falseï¼Œç°åœ¨è®¾ç½®ä¸ºäº†trueï¼Œå›åˆ°è¿™ä¸ªä»£ç çš„å‰é¢</span>     <span class="hljs-keyword">return</span> runWithRetries(key, attempts - <span class="hljs-number">1</span>, <span class="hljs-keyword">false</span>, asking);   &#125; <span class="hljs-keyword">finally</span> &#123;     releaseConnection(connection);   &#125; &#125;</code></pre><h1 id="JedisCluster"><a href="#JedisCluster" class="headerlink" title="JedisCluster"></a>JedisCluster</h1><h2 id="JedisClusteråŸºæœ¬ä½¿ç”¨"><a href="#JedisClusteråŸºæœ¬ä½¿ç”¨" class="headerlink" title="JedisClusteråŸºæœ¬ä½¿ç”¨"></a>JedisClusteråŸºæœ¬ä½¿ç”¨</h2><pre><code class="hljs java"><span class="hljs-comment">//å®šä¹‰ä¸€ä¸ªé›†åˆï¼Œç”¨æ¥å­˜å‚¨redis clusterçš„èŠ‚ç‚¹</span>Set&lt;HostAndPort&gt; nodeList= <span class="hljs-keyword">new</span> HashSet&lt;HostAndPort&gt;<span class="hljs-number">0</span>:nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST1, PORT1))nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST2, PORT2)nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST3, PORT3);nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST4, PORT4))nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST5, PORT5))nodeList.add(<span class="hljs-keyword">new</span> HostAndPort(HOST6, PORT6));<span class="hljs-comment">//Clusteræœ‰3ä¸ªå‚æ•°ï¼Œé›†åˆã€è¶…æ—¶æ—¶é—´ã€é…ç½®</span><span class="hljs-function">JedisCluster redisCluster new <span class="hljs-title">JedisCluster</span><span class="hljs-params">(nodeList, timeout, poolConfig)</span></span><span class="hljs-function">rediscluster.command...</span></code></pre><blockquote><p>è¿™é‡Œä¸éœ€è¦å…³å¿ƒè¿æ¥æ± çš„å½’è¿˜ï¼Œåœ¨å®ƒå†…éƒ¨å¸®æˆ‘ä»¬å°è£…å¥½äº†</p></blockquote><p>ä½¿ç”¨æŠ€å·§</p><ol><li>å•ä¾‹ï¼šå†…ç½®äº†æ‰€æœ‰èŠ‚ç‚¹çš„è¿æ¥æ± ï¼›</li><li>æ— éœ€æ‰‹åŠ¨å€Ÿè¿˜è¿æ¥æ± ï¼›</li><li>åˆç†è®¾ç½®commons-poolï¼›</li></ol><h2 id="æ•´åˆSpring"><a href="#æ•´åˆSpring" class="headerlink" title="æ•´åˆSpring"></a>æ•´åˆSpring</h2><blockquote><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p></blockquote><h2 id="å¤šèŠ‚ç‚¹å‘½ä»¤"><a href="#å¤šèŠ‚ç‚¹å‘½ä»¤" class="headerlink" title="å¤šèŠ‚ç‚¹å‘½ä»¤"></a>å¤šèŠ‚ç‚¹å‘½ä»¤</h2><p>å‡å¦‚æˆ‘ä»¬è¦æ‰§è¡Œä¸€ä¸ªscanæ“ä½œæ‰«æèŠ‚ç‚¹æ‰€æœ‰çš„é”®å€¼ï¼Œå¯¹äºRedisClusteræ¥è¯´å®ƒä¸èƒ½æ”¯æŒä¸€ä¸ªscanå‘½ä»¤å»æ‰«ææ‰€æœ‰èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ç§è¦æ±‚å°±æ˜¯åœ¨æ‰€æœ‰èŠ‚ç‚¹å»æ‰§è¡Œè¿™æ ·çš„å‘½ä»¤è¦æ€ä¹ˆåšå‘¢ï¼Ÿ</p><pre><code class="hljs java">âˆ¥è·å–æ‰€æœ‰èŠ‚ç‚¹çš„JedisPoolMap&lt;String, JedisPool&gt; jedisPoolMap=jedisCLuster.getClusterNodes();<span class="hljs-keyword">for</span>(Entry&lt;String, Jedis Pool&gt; entry: <span class="hljs-function">jedisPoolMap <span class="hljs-title">entrySet</span><span class="hljs-params">()</span>)</span><span class="hljs-function"><span class="hljs-comment">//è·å–æ¯ä¸ªèŠ‚ç‚¹çš„Jedisè¿æ¥</span></span><span class="hljs-function">Jedis jedis</span>=entry.getValue().getResource();<span class="hljs-keyword">if</span>(!isMaster(jedis))&#123;    <span class="hljs-keyword">continue</span>;  &#125;<span class="hljs-comment">//finally close</span>&#125;</code></pre><h2 id="æ‰¹é‡å‘½ä»¤å®ç°"><a href="#æ‰¹é‡å‘½ä»¤å®ç°" class="headerlink" title="æ‰¹é‡å‘½ä»¤å®ç°"></a>æ‰¹é‡å‘½ä»¤å®ç°</h2><blockquote><p>åœ¨RedisClusterä¸­æ‰§è¡Œæ‰¹é‡æ“ä½œæœ‰ä¸€ä¸ªé—®é¢˜ï¼šmgetã€msetå¿…é¡»åœ¨ä¸€ä¸ªæ§½ï¼Œä¸‹é¢ä»‹ç»4ç§æ–¹æ³•å¯¹è¿™ç§é—®é¢˜è¿›è¡Œä¼˜åŒ–</p></blockquote><h3 id="ä¸²è¡Œmget"><a href="#ä¸²è¡Œmget" class="headerlink" title="ä¸²è¡Œmget"></a>ä¸²è¡Œmget</h3><p>æ‰§è¡Œ<code>megt</code>æ—¶ï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªforå¾ªç¯æ¥æ‰§è¡Œï¼Œé€šè¿‡RedisClusteræ‰§è¡Œæ¯ä¸ªkeyï¼Œä¾‹å¦‚ä¸‹é¢è¿™å¼ å›¾ï¼šå·¦è¾¹çš„æ˜¯è¦æ‰§è¡Œçš„æ‰¹é‡æ“ä½œï¼Œå³è¾¹æ˜¯3ä¸ªredisèŠ‚ç‚¹ï¼Œè¿™ç§æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå½“æ•ˆç‡æ˜¯éå¸¸å·®çš„ï¼Œå®ƒéœ€è¦næ¬¡ç½‘ç»œæ—¶é—´</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572188972006-1572188977000.png" srcset="/img/loading.gif" alt="1572188972006"></p><h3 id="ä¸²è¡ŒIO"><a href="#ä¸²è¡ŒIO" class="headerlink" title="ä¸²è¡ŒIO"></a>ä¸²è¡ŒIO</h3><p>å®ƒå¯¹ä¸Šé¢çš„<code>ä¸²è¡Œmget</code>æ–¹æ¡ˆè¿›è¡Œäº†ä¼˜åŒ–</p><p> å·¦è¾¹ä»ç„¶æ˜¯<code>meget</code>æ“ä½œï¼Œå³è¾¹ä»ç„¶æ˜¯å¯¹åº”çš„3ä¸ªèŠ‚ç‚¹ï¼Œå®ƒæœ‰ä¸€ä¸ªä¸åŒæ˜¯åœ¨å®¢æˆ·ç«¯æœ¬åœ°åšä¸€ä¸ªå†…èšï¼Œæˆ‘ç°åœ¨çŸ¥é“æ‰€æœ‰çš„keyï¼Œé€šè¿‡æœ¬åœ°çš„<code>CRC16</code>ç„¶åå¯¹<code>16383</code>å»å–ä½™ï¼Œç®—å‡ºå®ƒçš„æ§½ï¼ŒçŸ¥é“æœ¬åœ°çš„æ§½å’ŒèŠ‚ç‚¹çš„å¯¹åº”å…³ç³»å°±å¯ä»¥å°†è¿™äº›keyè¿›è¡Œåˆ†ç»„ï¼Œè¿™ä¸ªåˆ†ç»„å°±æ˜¯æŒ‰ç…§èŠ‚ç‚¹è¿›è¡Œåˆ†ç»„ï¼Œç»™å®ƒæˆç«‹ä¸€ä¸ªå­—èŠ‚ï¼Œå„å„<code>master</code>èŠ‚ç‚¹ä¸€ä¸ªå­é›†ï¼Œå½“æˆ‘ä»¬æœ‰è¿™ä¸ªå­é›†ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦æ‰§è¡Œ3æ¬¡<code>pipeline</code>å°±å¯ä»¥å®Œæˆå¯¹åº”çš„<code>mget</code>æ“ä½œï¼Œè¿™æ ·å°±å˜æˆäº†nodesæ¬¡ç½‘ç»œæ—¶é—´ï¼Œå¤§å¤§é™ä½ç½‘ç»œå¼€é”€</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572189341535-1572189466437.png" srcset="/img/loading.gif" alt="1572189341535"></p><h3 id="å¹¶è¡ŒIO"><a href="#å¹¶è¡ŒIO" class="headerlink" title="å¹¶è¡ŒIO"></a>å¹¶è¡ŒIO</h3><p>å¹¶è¡ŒIOæ˜¯å¯¹ä¸²è¡ŒIOæ–¹æ¡ˆçš„ä¼˜åŒ–ï¼Œåˆ©ç”¨å¤šçº¿ç¨‹ï¼Œåˆ†åˆ«åœ¨3ä¸ªçº¿ç¨‹ä¸‹å»è·å–å¯¹åº”èŠ‚ç‚¹<code>pipeline</code>çš„è¿”å›å€¼</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572189489205.png" srcset="/img/loading.gif" alt="1572189489205"></p><h3 id="hash-tag"><a href="#hash-tag" class="headerlink" title="hash_tag"></a>hash_tag</h3><p>è¿™æ˜¯æ›´åŠ æç«¯çš„æ–¹æ¡ˆï¼Œå°†keyåšä¸€ä¸ªhash_tagçš„åŒ…è£…ï¼Œå°†tagå€¼ç”¨ä¸€ä¸ªå¤§æ‹¬å·å»æ‹¬èµ·æ¥ï¼Œè¿™æ ·ä¿è¯æ‰€æœ‰çš„keyéƒ½è½åˆ°ä¸€ä¸ªredisèŠ‚ç‚¹ï¼Œè¿™æ ·æ¯æ¬¡mgetåªéœ€è¦æ˜¯ä¸€ä¸ªèŠ‚ç‚¹å»å†™å°±å¥½äº†</p><h3 id="å››ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹"><a href="#å››ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹" class="headerlink" title="å››ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹"></a>å››ç§æ–¹æ¡ˆä¼˜ç¼ºç‚¹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572189600178.png" srcset="/img/loading.gif" alt="1572189600178"></p><h1 id="æ•…éšœè½¬ç§»"><a href="#æ•…éšœè½¬ç§»" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h1><h2 id="æ•…éšœå‘ç°"><a href="#æ•…éšœå‘ç°" class="headerlink" title="æ•…éšœå‘ç°"></a>æ•…éšœå‘ç°</h2><ul><li>é€šè¿‡ping/pongæ¶ˆæ¯å®ç°æ•…éšœå‘ç°ï¼šä¸éœ€è¦sentinel</li><li>ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿ï¼›</li></ul><h3 id="ä¸»è§‚ä¸‹çº¿"><a href="#ä¸»è§‚ä¸‹çº¿" class="headerlink" title="ä¸»è§‚ä¸‹çº¿"></a>ä¸»è§‚ä¸‹çº¿</h3><ul><li>å®šä¹‰ï¼šæŸä¸ªèŠ‚ç‚¹è®¤ä¸ºå¦ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨â€œåè§â€ï¼Œè¿™æ˜¯æŸä¸€ä¸ªèŠ‚ç‚¹çš„è®¤çŸ¥ï¼Œä¸ä»£è¡¨æ‰€æœ‰èŠ‚ç‚¹çš„è®¤çŸ¥ï¼›</li><li>ä¸»è§‚ä¸‹çº¿æµç¨‹ï¼š<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572265817397.png" srcset="/img/loading.gif" alt="1572265817397"><br>è¿™é‡ŒæŠ½è±¡2ä¸ªèŠ‚ç‚¹çš„æ¨¡å‹è§‚å¯Ÿï¼Œç°åœ¨æœ‰èŠ‚ç‚¹1å’ŒèŠ‚ç‚¹2ï¼ŒèŠ‚ç‚¹1ä¼šå®šæœŸå‘é€ä¸€ä¸ªpingæ¶ˆæ¯ç»™èŠ‚ç‚¹2ï¼Œå¦‚æœå‘é€æˆåŠŸå°±æ˜¯ä»£è¡¨pingé€šäº†ï¼Œ ç„¶åèŠ‚ç‚¹2ä¼šå›å¤pongæ¶ˆæ¯ï¼ŒèŠ‚ç‚¹1ä¼šæ›´æ–°ä¸èŠ‚ç‚¹2æœ€åçš„é€šä¿¡æ—¶é—´ï¼Œå¦‚æœè¿™ä¸ªpingå¤±è´¥äº†ï¼Œè¿™ä¸ªé€šä¿¡å¼‚å¸¸å°±ä¼šæ–­å¼€è¿æ¥ï¼Œå†ä¸‹ä¸€æ¬¡è§¦å‘pingæ¶ˆæ¯çš„æ—¶å€™ï¼Œå®ƒä¾ç„¶ä¼šæ‰§è¡Œping/pongè¿™ä¸ªè¿‡ç¨‹ï¼Œå½“å®ƒå‘ç°ä¸èŠ‚ç‚¹2çš„æœ€åæ—¶é—´è¶…è¿‡äº†<code>node-timeout</code>ï¼Œæˆ‘ä»¬ä¹‹å‰é…ç½®çš„<code>cluster-node-timeout</code>ï¼Œå°±ä¼šå°†å®ƒæ ‡è®°ä¸º<code>pfail</code>,<code>pfail</code>å°±æ˜¯ä¸»è§‚ä¸‹çº¿ï¼Œä»¥ä¸Šå†…å®¹å°±æ˜¯ä¸»è§‚ä¸‹çº¿çš„åŸºæœ¬æµç¨‹ï¼›</li></ul><h3 id="å®¢è§‚ä¸‹çº¿"><a href="#å®¢è§‚ä¸‹çº¿" class="headerlink" title="å®¢è§‚ä¸‹çº¿"></a>å®¢è§‚ä¸‹çº¿</h3><ul><li>å®šä¹‰ï¼šå½“åŠæ•°ä»¥ä¸ŠæŒæœ‰æ§½çš„èŠ‚ç‚¹éƒ½æ ‡è®°æŸèŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿ï¼Œè¿™é‡Œçš„åŠæ•°ä»¥ä¸Šæ˜¯é˜²æ­¢ç½‘ç»œåˆ†åŒºçš„æƒ…å†µï¼Œè€Œä¸”è¿˜è¦æ˜¯ä¸»èŠ‚ç‚¹ï¼Œè¿™æ˜¯å› ä¸ºåœ¨é›†ç¾¤æ¨¡å¼æ‰æœ‰èµ„æ ¼è¿›è¡Œè¯»å†™çš„è¯·æ±‚ä»¥åŠè¿›è¡Œæ§½çš„ç›¸å…³ç»´æŠ¤ï¼Œè€Œä»èŠ‚ç‚¹åªè´Ÿè´£å¤åˆ¶ï¼›</li><li>å®¢è§‚ä¸‹çº¿é€»è¾‘æµç¨‹ï¼š<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572266269416.png" srcset="/img/loading.gif" alt="1572266269416"><br>å®ƒæ¥å—åˆ°å…¶ä»–èŠ‚ç‚¹å‘æ¥çš„pingæ¶ˆæ¯ï¼Œå¦‚æœå®ƒåŒ…å«äº†pfailæ¶ˆæ¯ï¼ˆä¸»è§‚ä¸‹çº¿ï¼‰ï¼Œç„¶åå®ƒä¼šå°†ä¸»è§‚ä¸‹çº¿çš„æ¶ˆæ¯å†…å®¹æ·»åŠ åˆ°è‡ªèº«çš„æ•…éšœåˆ—è¡¨ä¸­ï¼Œè¿™ä¸ªæ•…éšœåˆ—è¡¨ä¸­åŒ…å«äº†å½“å‰èŠ‚ç‚¹æ”¶åˆ°æ¯ä¸ªèŠ‚ç‚¹çš„å¯¹å…¶ä»–èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå‡å¦‚æˆ‘å½“å‰æ˜¯èŠ‚ç‚¹2ï¼Œæˆ‘çš„æ•…éšœåˆ—è¡¨é‡Œé¢æœ‰èŠ‚ç‚¹1ä¸€ç›´åˆ°èŠ‚ç‚¹nè¿™æ ·ä¸ºåˆ—ï¼Œæ•…éšœnä¸ºè¡Œè¿™æ ·çš„çŸ©é˜µåˆ—è¡¨èƒ½çŸ¥é“æ¯ä¸ªèŠ‚ç‚¹å¯¹æ¯ä¸ªèŠ‚ç‚¹çš„çœ‹æ³•ï¼Œè¿™æ ·å½“å®ƒæ·»åŠ ä¹‹åå®ƒä¼šå»å°è¯•åšå®¢è§‚ä¸‹çº¿ï¼Œå› ä¸ºå®ƒè¿™ä¸ªåˆ—è¡¨ä¸­ç»´æŠ¤äº†æ‰€æœ‰æ•…éšœåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨ä¹Ÿæ˜¯æœ‰å‘¨æœŸçš„ï¼Œè¿™ä¸ªå‘¨æœŸéœ€è¦åœ¨<code>cluster-node-timeout * 2</code>èŒƒå›´å†…ï¼Œè¿™æ ·æ˜¯ä¸ºäº†ä¿è¯ä¸€ä¸ªå¾ˆä¹…ä¹‹å‰çš„æ•…éšœæ¶ˆæ¯ä¸ä¼šåœ¨æˆ‘è¿™é‡Œå¾ˆä¹…æ˜¯æœ‰æ•ˆçš„ï¼Œä¿è¯äº†å®¢è§‚ä¸‹çº¿çš„å…¬å¹³æ€§å’Œæœ‰æ•ˆæ€§ï¼›</li></ul><h3 id="å°è¯•å®¢è§‚ä¸‹çº¿"><a href="#å°è¯•å®¢è§‚ä¸‹çº¿" class="headerlink" title="å°è¯•å®¢è§‚ä¸‹çº¿"></a>å°è¯•å®¢è§‚ä¸‹çº¿</h3><p><strong>æµç¨‹</strong></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572266968180.png" srcset="/img/loading.gif" alt="1572266968180"></p><p>å®ƒä¼šç»Ÿè®¡æœ‰æ•ˆä¸‹çº¿åˆ—è¡¨æŠ¥å‘Šä¸­çš„æ•°é‡ï¼Œå¦‚æœå°äºé›†ç¾¤ä¸­æŒæœ‰æ§½ä¸»èŠ‚ç‚¹çš„ä¸€åŠåˆ™é€€å‡ºï¼Œå¦‚æœä¸‹çº¿æŠ¥å‘Šå¤§äºä¸»èŠ‚ç‚¹æ•°é‡ä¸€åŠæ—¶ä¼šæ ‡è®°æ•…éšœèŠ‚ç‚¹ä¸ºä¸€ä¸ªå®¢è§‚ä¸‹çº¿çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­å³è¾¹éƒ¨åˆ†ï¼Œå¹¶å‘é›†ç¾¤ä¸­å‘é€å¹¿æ’­é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹å°†æ•…éšœèŠ‚ç‚¹æ ‡è¯†ä¸ºå®¢è§‚ä¸‹çº¿</p><ul><li>é€šçŸ¥é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æ ‡è®°æ•…éšœèŠ‚ç‚¹ä¸ºå®¢è§‚ä¸‹çº¿ï¼›</li><li>é€šçŸ¥æ•…éšœèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹è§¦å‘æ•…éšœè½¬ç§»æµç¨‹ã€‚</li></ul><h2 id="æ•…éšœæ¢å¤"><a href="#æ•…éšœæ¢å¤" class="headerlink" title="æ•…éšœæ¢å¤"></a>æ•…éšœæ¢å¤</h2><p>æ•…éšœæ¢å¤å°±æ˜¯åœ¨å‘ç°ä¸»è§‚ä¸‹çº¿çš„æ“ä½œä¹‹ååé¢åšäº†å®¢è§‚ä¸‹çº¿ï¼Œç„¶åå®¢è§‚ä¸‹çº¿é€šçŸ¥ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ¥å—åˆ°äº†è¿™ä¸ªæ¶ˆæ¯ä¹‹åå®ƒå°±ä¼šå¼€å§‹å‡†å¤‡åšæ•…éšœæ¢å¤ä»è€Œä¿è¯é›†ç¾¤çš„é«˜å¯ç”¨ï¼Œå®ƒä¸»è¦åˆ†ä¸º4ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>èµ„æ ¼æ£€æŸ¥ï¼šå¯¹å¤šä¸ªä»èŠ‚ç‚¹çš„ä¸€ä¸ªèµ„æ ¼è¿›è¡Œå®¡æŸ¥ï¼Œåªæœ‰åœ¨èµ„æ ¼å®¡æŸ¥èŒƒå›´å†…çš„ä»èŠ‚ç‚¹æ‰æœ‰èµ„æ ¼åšæ•…éšœæ¢å¤çš„å·¥ä½œï¼›</li><li>å‡†å¤‡é€‰ä¸¾æ—¶é—´ï¼šè¿™ä¸ªä¸ºäº†ä½¿åç§»é‡æœ€å¤§çš„ä¸€ä¸ªä»èŠ‚ç‚¹å…·å¤‡ä¼˜å…ˆçº§ï¼Œæˆä¸ºä¸»èŠ‚ç‚¹çš„æ¡ä»¶ï¼›</li><li>é€‰ä¸¾æŠ•ç¥¨ï¼šå¯¹å¤šä¸ªé€‰ä¸¾å‡ºæ¥çš„ä»èŠ‚ç‚¹ï¼Œä¸»èŠ‚ç‚¹è¦è¿›è¡Œä¸€ä¸ªæŠ•ç¥¨ï¼Œæœ€ç»ˆé€‰å®šè°æ˜¯æˆä¸ºæœªæ¥çš„ä¸»èŠ‚ç‚¹ï¼›</li><li>æ›¿æ¢ä¸»èŠ‚ç‚¹ã€‚</li></ul><h3 id="æ£€æŸ¥èµ„æ ¼"><a href="#æ£€æŸ¥èµ„æ ¼" class="headerlink" title="æ£€æŸ¥èµ„æ ¼"></a>æ£€æŸ¥èµ„æ ¼</h3><ul><li>æ¯ä¸ªä»èŠ‚ç‚¹æ£€æŸ¥ä¸æ•…éšœä¸»èŠ‚ç‚¹çš„æ–­çº¿æ—¶é—´ï¼›</li><li>å¦‚æœè¶…è¿‡<code>cluster-node-timeout * cluster-slave-validity-factor</code>å–æ¶ˆèµ„æ ¼ï¼›</li><li>cluster-node-timeoutï¼šé»˜è®¤æ—¶é—´æ˜¯15ç§’ï¼›</li><li>cluster-slave-validity-factorï¼šé»˜è®¤æ˜¯10ï¼Œå¦‚æœéƒ½ä½¿ç”¨é»˜è®¤å€¼çš„è¯ç›¸å½“äº150ç§’ï¼Œæ¯ä¸ªä»èŠ‚ç‚¹æ£€æŸ¥ä¸æ•…éšœä¸»èŠ‚ç‚¹çš„æ–­çº¿æ—¶é—´è¶…è¿‡ä¸ª150ç§’å°±æ²¡æœ‰èµ„æ ¼æˆä¸ºä¸»èŠ‚ç‚¹çš„å¯èƒ½æ€§ã€‚</li></ul><h3 id="å‡†å¤‡é€‰ä¸¾æ—¶é—´"><a href="#å‡†å¤‡é€‰ä¸¾æ—¶é—´" class="headerlink" title="å‡†å¤‡é€‰ä¸¾æ—¶é—´"></a>å‡†å¤‡é€‰ä¸¾æ—¶é—´</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572268020906.png" srcset="/img/loading.gif" alt="1572268020906"></p><p>å½“ä»èŠ‚ç‚¹ç¬¦åˆæ•…éšœè½¬ç§»èµ„æ ¼ä¹‹åï¼Œéœ€è¦æ›´æ–°è§¦å‘æ•…éšœé€‰ä¸¾çš„æ—¶é—´ï¼Œåªæœ‰è¾¾åˆ°è¯¥æ—¶é—´æ‰æœ‰å¯èƒ½è§¦å‘åç»­çš„æµç¨‹ï¼Œè¿™ä¸€æ­¥å…¶å®æ˜¯ä¸ºäº†ä¿è¯åç§»é‡æ¯”è¾ƒå¤§çš„ä»èŠ‚ç‚¹æœ‰æ›´å°çš„å»¶è¿Ÿè¾¾åˆ°æ‰€è°“çš„ä¸€ä¸ªé€‰ä¸¾æ—¶é—´ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ä¼šæ›´é«˜ï¼Œå› ä¸ºå½“å‰ä¸»èŠ‚ç‚¹å·²ç»å‘ç”Ÿäº†æ•…éšœï¼Œåªæœ‰åç§»é‡æœ€å¤§çš„æ›´æ¥è¿‘åŸæ¥çš„ä¸»èŠ‚ç‚¹ï¼Œå®ƒæ›´æœ‰å¯èƒ½æˆä¸ºæœªæ¥çš„masterèŠ‚ç‚¹ï¼Œæ‰€æœ‰æˆ‘ä»¬ä¼šç»™å®ƒæ›´å°çš„é€‰ä¸¾æ—¶é—´ï¼Œè®©å®ƒé¦–å…ˆå»è¾¾åˆ°è¿™ä¸ªé€‰ä¸¾æ—¶é—´ï¼Œç„¶åå®Œæˆä¸ºæœªæ¥çš„é€‰ä¸¾ï¼Œè®©å®ƒè·å¾—æ›´é«˜çš„ç¥¨æ•°ï¼Œæœ€ç»ˆæˆä¸ºmasterèŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ‹¿åˆ°é€‰ä¸¾æ—¶é—´ä¹‹åå®ƒä¼šå¯¹ä¸»èŠ‚ç‚¹å‘èµ·ä¸€ä¸ªé€‰ä¸¾ï¼Œè®©ä¸»èŠ‚ç‚¹å‘èµ·ä¸€ä¸ªé€‰ä¸¾ç„¶åä¸»èŠ‚ç‚¹ç»™å®ƒè¿›è¡ŒæŠ•ç¥¨ï¼Œå®ƒçš„ä¸€ä¸ªä¼˜å…ˆçº§æ›´é«˜ä¹Ÿå°±æ˜¯å®ƒçš„åç§»é‡æ›´å¤§å®ƒçš„é€‰ä¸¾æ—¶é—´ä¼šæ›´çŸ­ï¼Œå°±æ˜¯å®ƒè·å¾—é€‰ä¸¾æ—¶é—´è¶ŠçŸ­å®ƒå°±æ›´å¯èƒ½è·å¾—æ›´å¤šçš„ç¥¨æ•°ï¼Œä¾‹å¦‚ç°åœ¨è¿™ä¸ªå›¾ä¸­çš„slave1ç”±äºå®ƒçš„åç§»é‡æ¯”è¾ƒå¤§ï¼Œå®ƒè·å¾—äº†æ›´å¤šçš„ç¥¨æ•°ï¼Œç„¶åslave2å¯èƒ½æ˜¯ç¨åæ‹¿åˆ°é€‰ä¸¾çš„æ—¶é—´ï¼Œå®ƒåªè·å¾—äº†1ç¥¨ï¼Œç„¶åè¿™ä¸ªRedisClusterä¼šè§„å®šå½“ä½ è·å–äº†è¿™ä¸ªé›†ç¾¤ä¸­ä¸»èŠ‚ç‚¹çš„2åˆ†ä¹‹1å†åŠ 1è¿™ä¸ªæ•°å­—ä¹‹åå°±å¯ä»¥åšä¸€ä¸ªæ›¿æ¢ä¸»èŠ‚ç‚¹çš„å·¥ä½œäº†ï¼›</p><h3 id="æ›¿æ¢ä¸»èŠ‚ç‚¹"><a href="#æ›¿æ¢ä¸»èŠ‚ç‚¹" class="headerlink" title="æ›¿æ¢ä¸»èŠ‚ç‚¹"></a>æ›¿æ¢ä¸»èŠ‚ç‚¹</h3><ol><li>å½“å‰ä»èŠ‚ç‚¹å–æ¶ˆå¤åˆ¶å˜ä¸ºä¸»èŠ‚ç‚¹ï¼ˆslaveof no noneï¼‰ï¼›</li><li>æ‰§è¡ŒcluserDelSlotæ’¤é”€æ•…éšœä¸»èŠ‚ç‚¹è´Ÿè´£çš„æ§½ï¼Œå¹¶æ‰§è¡ŒclusterAddSlotæŠŠè¿™äº›æ§½åˆ†é…ç»™è‡ªå·±ï¼›</li><li>å‘é›†ç¾¤å¹¿æ’­è‡ªå·±çš„pongæ¶ˆæ¯ï¼Œè¡¨æ˜å·²ç»æ›¿æ¢äº†æ•…éšœä»èŠ‚ç‚¹ã€‚</li></ol><h2 id="æ•…éšœè½¬ç§»æ¼”ç»ƒ"><a href="#æ•…éšœè½¬ç§»æ¼”ç»ƒ" class="headerlink" title="æ•…éšœè½¬ç§»æ¼”ç»ƒ"></a>æ•…éšœè½¬ç§»æ¼”ç»ƒ</h2><blockquote><p>è¿™é‡Œå¯¹æŸèŠ‚ç‚¹é€šè¿‡<code>kill    -9 {pid}</code>æ¥æ¨¡æ‹Ÿå®•æœºçš„æƒ…å†µï¼Œå‡å¦‚6385éƒ¨ç½²åˆ°ä¸€å°æœºå™¨ä¸Šï¼Œç„¶åçªç„¶å‘ç”Ÿäº†å®•æœºï¼Œè¿™é‡Œå°±ç”¨ <code>kill    -9 {pid}</code>æ¥æ¨¡æ‹Ÿï¼Œçœ‹çœ‹å®ƒèƒ½å¦å®ç°æ•…éšœè½¬ç§»ï¼Œæ•…éšœè½¬ç§»çš„æœ€ç»ˆç›®æ ‡å°±æ˜¯å›¾çš„å³è¾¹ï¼Œ6385æˆä¸ºäº†ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œ6386æˆä¸ºäº†ä¸»èŠ‚ç‚¹ï¼Œå½“ç„¶6385å¯èƒ½æ˜¯ä¸€ä¸ªå¤±è´¥çŠ¶æ€æˆ–è€…æ•…éšœæ¢å¤çš„çŠ¶æ€</p></blockquote><h3 id="å…·ä½“æ­¥éª¤"><a href="#å…·ä½“æ­¥éª¤" class="headerlink" title="å…·ä½“æ­¥éª¤"></a>å…·ä½“æ­¥éª¤</h3><ol><li>æ‰§è¡Œkill -9èŠ‚ç‚¹æ¨¡æ‹Ÿå®•æœºï¼›</li><li>è§‚å¯Ÿå®¢æˆ·ç«¯æ•…éšœæ¢å¤æ—¶é—´ï¼›</li><li>è§‚å¯Ÿå„ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—ã€‚</li></ol><h3 id="å¼€å§‹"><a href="#å¼€å§‹" class="headerlink" title="å¼€å§‹"></a>å¼€å§‹</h3><p>ï¼ˆ1ï¼‰å®¢æˆ·ç«¯æ‰“å°æ—¥å¿—å­˜æ”¾çš„ç›®å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276083100.png" srcset="/img/loading.gif" alt="1572276083100"></p><hr><p>ï¼ˆ2ï¼‰è¿™æ˜¯ä¸€ä¸ªç®€å•çš„whileæ­»å¾ªç¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276112807.png" srcset="/img/loading.gif" alt="1572276112807"></p><hr><p>ï¼ˆ3ï¼‰æŸ¥çœ‹å®¢æˆ·ç«¯çš„æ—¥å¿—</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276191669.png" srcset="/img/loading.gif" alt="1572276191669"></p><hr><p>ï¼ˆ4ï¼‰è¿™ä¸ªæ—¶å€™å°†æœåŠ¡ç«¯ä½¿ç”¨killå…³é—­7000ç«¯å£</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276152318.png" srcset="/img/loading.gif" alt="1572276152318"></p><hr><p>ï¼ˆ5ï¼‰è¿™ä¸ªæ—¶å€™å°±ä¼šæ”¶åˆ°å¾ˆå¤šå¼‚å¸¸ä¿¡æ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276220715.png" srcset="/img/loading.gif" alt="1572276220715"></p><hr><p>ï¼ˆ6ï¼‰ç¨ç­‰ä¸€ä¼šï¼Œä¼šå‘ç°æ¢å¤æ­£å¸¸äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276268731.png" srcset="/img/loading.gif" alt="1572276268731"></p><hr><p>ï¼ˆ7ï¼‰è¿™é‡Œæ¢å¤æ—¶é—´å¤§æ¦‚20å¤šç§’å·¦å³ï¼Œè¿™é‡ŒåŒ…å«äº†ä¸»è§‚ä¸‹çº¿ã€å®¢è§‚ä¸‹çº¿å’Œé€‰ä¸¾çš„æ—¶é—´ï¼Œå¯¹äºä¸€èˆ¬çš„åº”ç”¨æ¥è¯´è¿˜æ˜¯å¯ä»¥å®¹å¿çš„ï¼Œå¦‚æœä½ åœ¨å®¢æˆ·ç«¯åšäº†ä¸€äº›å¯¹æ•…éšœå®¹å¿çš„ç†”æ–­æªæ–½ï¼Œè¿™ä¸ªæ•…éšœæ—¶é—´è¿˜æ˜¯æ¯”è¾ƒå°çš„ï¼Œå¦‚æœä½ ä¸å®¹å¿è¿™äº›æ—¶é—´ä½ å¯ä»¥æŠŠ<code>cluseter-node-timeout</code>è°ƒå°ä¸€äº›ï¼Œä½†æ˜¯åœ¨åé¢çš„å¼€å‘è¿ç»´åœºæ™¯é—®é¢˜çš„æ—¶å€™ä¼šæåˆ°è¿™ä¸ªå‚æ•°ä¼šå½±å“åˆ°å¸¦å®½çš„ä¸€ä¸ªä¼ æ’­çš„é€Ÿç‡ï¼Œå°±æ˜¯è¿™ä¸ªæ¶ˆæ¯ä¼ è¾“çš„é¢‘ç‡ï¼Œå¯èƒ½ä¼šåŠ é‡å¸¦å®½ï¼Œæ‰€ä»¥è¿™ä¸ªå‚æ•°æ˜¯æ¯”è¾ƒç»¼åˆçš„å‚æ•°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276323869.png" srcset="/img/loading.gif" alt="1572276323869"></p><hr><p>ï¼ˆ8ï¼‰ç„¶åçœ‹ä¸€ä¸‹èŠ‚ç‚¹çš„å˜åŒ–ï¼Œä¹‹å‰çš„7000è¢«killäº†ä¹‹å7000çš„ä»èŠ‚ç‚¹7003å˜ä¸ºäº†masterï¼Œ7000å·²ç»æˆä¸ºäº†slaveèŠ‚ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276640360.png" srcset="/img/loading.gif" alt="1572276640360"></p><p>ï¼ˆ9ï¼‰è¿™ä¸ªæ—¶å€™å¯åŠ¨7000ï¼Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276817565.png" srcset="/img/loading.gif" alt="1572276817565"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276838894.png" srcset="/img/loading.gif" alt="1572276838894"></p><p>ï¼ˆ10ï¼‰æ¥ä¸‹æ¥å¯¹æ—¥å¿—åšåˆ†æï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹7000</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276892421.png" srcset="/img/loading.gif" alt="1572276892421"></p><p>è¿™é‡Œç”±äºä½¿ç”¨çš„æ˜¯killæ“ä½œï¼Œæ‰€ä»¥ä¸ä¼šç•™ä¸‹æ—¥å¿—ï¼Œåªä¼šç•™ä¸‹å¯åŠ¨å’Œå¤åˆ¶masteræ—¥å¿—</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572276978705.png" srcset="/img/loading.gif" alt="1572276978705"></p><hr><p>çœ‹7003</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277091059.png" srcset="/img/loading.gif" alt="1572277091059"></p><p>æ”¶åˆ°äº†å®ƒä¸»èŠ‚ç‚¹ä¸‹çº¿çš„æ¶ˆæ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277134120.png" srcset="/img/loading.gif" alt="1572277134120"></p><p>é€‰ä¸¾æ—¶é—´ï¼Œè¿™é‡Œç”±äºæ­å»ºçš„æ˜¯ä¸€ä¸»å·²ä»çš„ç»“æ„ï¼Œæ‰€ä»¥åªæœ‰å®ƒèƒ½å˜æˆä¸»èŠ‚ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277219789.png" srcset="/img/loading.gif" alt="1572277219789"></p><p>æˆä¸ºmaster</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277280574.png" srcset="/img/loading.gif" alt="1572277280574"></p><p>æ¸…é™¤åŸæ¥ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277295453.png" srcset="/img/loading.gif" alt="1572277295453"></p><hr><p>7002çš„æ—¥å¿—</p><p>æ ‡è¯†åŸæ¥ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼šfailing</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277350341.png" srcset="/img/loading.gif" alt="1572277350341"></p><p>å®ƒåŒ…å«äº†åŸç†ä¸»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè¿™é‡Œè¿›è¡Œæ¸…é™¤</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572277439124.png" srcset="/img/loading.gif" alt="1572277439124"></p><h1 id="é›†ç¾¤å¼€å‘è¿ç»´å¸¸è§é—®é¢˜"><a href="#é›†ç¾¤å¼€å‘è¿ç»´å¸¸è§é—®é¢˜" class="headerlink" title="é›†ç¾¤å¼€å‘è¿ç»´å¸¸è§é—®é¢˜"></a>é›†ç¾¤å¼€å‘è¿ç»´å¸¸è§é—®é¢˜</h1><h2 id="é›†ç¾¤å®Œæ•´æ€§"><a href="#é›†ç¾¤å®Œæ•´æ€§" class="headerlink" title="é›†ç¾¤å®Œæ•´æ€§"></a>é›†ç¾¤å®Œæ•´æ€§</h2><p>ä¹‹å‰ä»‹ç»çš„cluster-require-full-coverageé»˜è®¤ä¸ºyesï¼Œæ˜¯å¦éœ€è¦æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹éƒ½æ˜¯åœ¨çº¿çŠ¶æ€ï¼Œè€Œä¸”1684ä¸ªæ§½éƒ½åœ¨ä¸€ä¸ªæœåŠ¡çš„çŠ¶æ€ï¼Œæ‰ä¼šè®¤ä¸ºé›†ç¾¤æ˜¯å®Œæ•´çš„å¯¹å¤–åŒæœåŠ¡</p><ul><li>é›†ç¾¤ä¸­16384ä¸ªæ§½å…¨éƒ¨å¯ç”¨ï¼šä¿è¯é›†ç¾¤å®Œæ•´æ€§ï¼›</li><li>èŠ‚ç‚¹æ•…éšœæˆ–è€…æ­£åœ¨æ•…éšœè½¬ç§»ï¼šï¼ˆerrorï¼‰ CLUSETRDOWN The cluster is downã€‚</li></ul><p>å¤§å¤šæ•°ä¸šåŠ¡æ— æ³•å®¹å¿ï¼Œcluster-require-full-coverageå»ºè®®è®¾ç½®ä¸ºno</p><h2 id="å¸¦å®½æ¶ˆè€—"><a href="#å¸¦å®½æ¶ˆè€—" class="headerlink" title="å¸¦å®½æ¶ˆè€—"></a>å¸¦å®½æ¶ˆè€—</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572352974418.png" srcset="/img/loading.gif" alt="1572352974418"></p><p>Redis Clusterä¼šå®šæœŸäº¤æ¢Gossipæ¶ˆæ¯ä»¥åŠåšä¸€äº›å¿ƒè·³æ£€æµ‹</p><ul><li>å®˜æ–¹å»ºè®®ï¼šèŠ‚ç‚¹ä¸è¦è¶…è¿‡1000ä¸ªèŠ‚ç‚¹ï¼›</li><li>PING/PONGæ¶ˆæ¯ï¼šèŠ‚ç‚¹ä¹‹é—´ä¼šäº¤æ¢PING/PONGæ¶ˆæ¯</li><li>ä¸å®¹å¿½è§†çš„å®½å¸¦æ¶ˆè€—ï¼šå½“èŠ‚ç‚¹è¿‡å¤šçš„æ—¶é—´å°±ä¼šäº§ç”Ÿä¸€ä¸ªé—®é¢˜ï¼Œå¸¦å®½æ¶ˆè€—ï¼Œå› ä¸ºå®ƒåœ¨ä¼ è¾“çš„æ—¶å€™ä¼šå¸¦ä¸€ä¸‹æ•°æ®é‡ï¼Œä¾‹å¦‚å®ƒæœ‰å¤šå°‘æ§½ï¼Œè¿˜éœ€è¦å¸¦å¯¹å…¶ä»–èŠ‚ç‚¹çš„è®¤è¯†çš„ä¿¡æ¯<ul><li>æ¶ˆæ¯å‘é€é¢‘ç‡ï¼šèŠ‚ç‚¹å‘ç°ä¸å…¶å®ƒèŠ‚ç‚¹æœ€åé€šä¿¡æ—¶é—´è¶…è¿‡cluster-node-timeout/2æ—¶ä¼šç›´æ¥å‘é€pingæ¶ˆæ¯ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªcluster-node-timeoutæ•°å­—ä¹Ÿä¼šå†³å®šæ¶ˆæ¯å‘é€é¢‘ç‡ï¼Œè¿™ä¸ªé¢‘ç‡å°±å†³å®šäº†å¸¦å®½ï¼›</li><li>æ¶ˆæ¯æ•°æ®é‡ï¼šslotæ§½æ•°ç»„ï¼ˆ2kbç©ºé—´ï¼‰å’Œæ•´ä¸ªé›†ç¾¤1/10çš„çŠ¶æ€æ•°æ®ï¼ˆ10ä¸ªèŠ‚ç‚¹çŠ¶æ€æ•°æ®çº¦1kbï¼‰</li><li>èŠ‚ç‚¹éƒ¨ç½²çš„é›†ç¾¤è§„æ¨¡ï¼šé›†ç¾¤åˆ†å¸ƒçš„æœºå™¨è¶Šå¤šä¸”æ¯å°æœºå™¨åˆ’åˆ†çš„èŠ‚ç‚¹æ•°å‡åŒ€ï¼Œåˆ™é›†ç¾¤å†…æ•´ä½“çš„å¯ç”¨å¸¦å®½è¶Šé«˜ã€‚</li></ul></li></ul><hr><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>â€‹    ç°åœ¨æœ‰ä¸€ä¸ªé›†ç¾¤</p><ul><li>è§„æ¨¡ï¼šèŠ‚ç‚¹200ä¸ªã€20å°ç‰©ç†æœºï¼ˆæ¯å°10ä¸ªèŠ‚ç‚¹ï¼‰ï¼›</li><li>cluser-node-timeout=15000ï¼Œping/pongå¸¦å®½ä¸º25MB;</li><li>cluster-node-timeout=20000ï¼Œping/pongå¸¦å®½ä½äº15MBï¼Œå½“ç„¶cluster-node-timeoutè¿˜ä¼šæ¶‰åŠåˆ°æ•…éšœè½¬ç§»ä¸€ä¸ªæ—¶é—´çš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨è®¾ç½®çš„æ—¶å€™è¦å»è€ƒè™‘è¿™ä¸ªé—®é¢˜ï¼Œä¸è¦åªè€ƒè™‘å¸¦å®½çš„é—®é¢˜ï¼Œè¿˜è¦è€ƒè™‘æ•…éšœè½¬ç§»æ—¶é—´çš„é—®é¢˜ï¼›</li></ul><p>ä»¥ä¸Šé—®é¢˜ä¼˜åŒ–ï¼š</p><ul><li>é¿å…â€œå¤§â€é›†ç¾¤ï¼šé¿å…å¤šä¸šåŠ¡ä½¿ç”¨ä¸€ä¸ªé›†ç¾¤ï¼Œå¤§ä¸šåŠ¡å¯ä»¥å¤šé›†ç¾¤ã€‚æœ‰äº›å…¬å¸æœ‰äº›é¡¹ç›®ç»„ä¼šä½¿ç”¨éå¸¸å¤§çš„é›†ç¾¤ï¼Œç„¶åå¾ˆå¤šä¸šåŠ¡å»ä½¿ç”¨è¿™æ ·çš„é›†ç¾¤ï¼Œé¦–å…ˆå®ƒçš„é—®é¢˜å°±æ˜¯è¯´ï¼Œå¦‚æœä¸šåŠ¡å¾ˆå¤šæ¶‰åŠåˆ°é‡Œé¢çš„äººæ°´å¹³ä¹Ÿä¸å¤ªç›¸åŒï¼Œä¸€æ—¦æœ‰äººå¼€å‘ä¸è§„èŒƒä¼šé€ æˆP2Pã€é˜»å¡è¿™ç§æƒ…å†µï¼Œä¸€ä¸ªä¸šåŠ¡ä¼šå½±å“å¸¦å¦ä¸€ä¸ªä¸šåŠ¡ï¼ŒåŠæ—¶æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„ï¼Œå®é™…ä¸Šè¿˜æ˜¯æ¯ä¸€ä¸ªRedisèŠ‚ç‚¹ï¼Œæ¯ä¸ªRedisèŠ‚ç‚¹è¿˜æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ¨¡å¼ï¼Œå¯¹äºå¤šä¸ªä¸šåŠ¡çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªé›†ç¾¤ï¼Œç”šè‡³ä¸€äº›å¤§ä¸šåŠ¡å¯ä»¥ä½¿ç”¨å¤šä¸ªé›†ç¾¤ï¼Œå› ä¸ºæˆ‘ä»¬å…¬å¸ä¹‹å‰ä¸€ä¸ªæ¨èæœåŠ¡ï¼Œå®ƒå¯ä»¥æŒ‰ç…§ä¸åŒçš„æ¨èç±»å‹ä½¿ç”¨å¯¹åº”çš„é›†ç¾¤ï¼Œå®é™…ä¸Šä¸åŒæ¨èç±»å‹Listä¹‹é—´æ˜¯æ²¡æœ‰ä¸šåŠ¡æ•°æ®ç›¸å…³æ€§çš„ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥ä½¿ç”¨å¤šé›†ç¾¤ï¼Œåƒè¿™ç§å¦‚æœçœŸçš„éœ€è¦ä½¿ç”¨éå¸¸å¤§æ•°æ®çš„æ—¶å€™ï¼Œå»ºè®®ä½¿ç”¨å¤šä¸ªé›†ç¾¤ï¼›</li><li>cluster-node-timeoutï¼šå¸¦å®½å’Œæ•…éšœè½¬ç§»é€Ÿåº¦çš„å‡è¡¡ï¼šè¿™ä¸ªå½±å“å¸¦å®½ã€æ•…éšœè½¬ç§»çš„æ—¶é—´ï¼Œåœ¨è®¾ç½®çš„æ—¶å€™è¦å¯¹è¿™2ä¸ªæ–¹é¢è¿›è¡Œå‡è¡¡ï¼›</li><li>å°½é‡å‡åŒ€åˆ†é…åˆ°å¤šæœºå™¨ä¸Šï¼šä½¿ç”¨å¤šå°æœºå™¨ï¼Œå®ƒæ—¢ä¿è¯é«˜å¯ç”¨ï¼Œæœºå™¨è¶Šå¤šï¼Œä¸»ä»èŠ‚ç‚¹åˆ†é…ä¼šæ›´å‡åŒ€ï¼Œå¸¦å®½ä¹Ÿä¼šæ›´åŠ å‡åŒ€ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜å¼€å‘äººå‘˜ä¸éœ€è¦å¤ªå…³å¿ƒï¼Œä½†æ˜¯è¿ç»´äººå‘˜éœ€è¦å¤šå…³æ³¨ï¼Œå½“èŠ‚ç‚¹ä¸Šå¾ˆå¤šè§„æ¨¡çš„æ—¶å€™ï¼Œå»ºè®®ä½¿ç”¨ä¸€äº›ï¼šæ¯”å¦‚è‡ªå·±å¼€å‘ä¸€å¥—åˆ†é…è§„åˆ™æ¥è¾¾åˆ°è´Ÿè½½å‡è¡¡ã€‚</li></ul><h2 id="Pub-Subå…‰çˆ†"><a href="#Pub-Subå…‰çˆ†" class="headerlink" title="Pub/Subå…‰çˆ†"></a>Pub/Subå…‰çˆ†</h2><blockquote><p>å‘å¸ƒè®¢é˜…æ¨¡å¼åœ¨é›†ç¾¤ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p></blockquote><p>é—®é¢˜ï¼špublicåœ¨è¿›ç¾¤æ¯ä¸ªèŠ‚ç‚¹å¹¿æ’­ï¼šåŠ é‡å¸¦å®½</p><p>å¯¹ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å»æ‰§è¡Œpublishï¼ˆå‘å¸ƒæ¶ˆæ¯ï¼‰ï¼Œå®ƒä¼šå°†è¿™äº›æ¶ˆæ¯åœ¨é›†ç¾¤ä¸­è¿›è¡Œå¹¿æ’­ï¼Œå¯¹ä¸€ä¸ªèŠ‚ç‚¹è¿›è¡Œå‘å¸ƒï¼Œå…¶ä»–èŠ‚ç‚¹éƒ½ä¼šè®¢é˜…åˆ°å¯¹åº”çš„æ¶ˆæ¯ï¼Œè¿™æ ·ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒèŠ‚ç‚¹å¸¦å®½çš„å¼€é”€ä¼šå¾ˆå¤§ï¼›</p><p>è§£å†³ï¼šå•ç‹¬â€œèµ°â€ä¸€å¥—Redis Sentinel</p><hr><p>ä¸¾ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸‹å¯¹é›†ç¾¤èŠ‚ç‚¹å‘å¸ƒæ¶ˆæ¯ä¼šæ€ä¹ˆæ ·</p><p>7000å¯¹cluster_pubsub_testé¢‘é“å‘å¸ƒhello</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572354891479.png" srcset="/img/loading.gif" alt="1572354891479"></p><p>7001ä¸»èŠ‚ç‚¹ä¸å®ƒçš„ä»èŠ‚ç‚¹7003è®¢é˜…cluster_pubsub_testé¢‘é“</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572354993873.png" srcset="/img/loading.gif" alt="1572354993873"></p><h2 id="é›†ç¾¤å€¾æ–œ"><a href="#é›†ç¾¤å€¾æ–œ" class="headerlink" title="é›†ç¾¤å€¾æ–œ"></a>é›†ç¾¤å€¾æ–œ</h2><blockquote><p>å¯¹äºåˆ†å¸ƒå¼æ•°æ®åº“æ¥è¯´å­˜åœ¨å€¾æ–œé—®é¢˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œæ¥çœ‹ä¸‹RedisClusterå®ƒçš„å€¾æ–œé—®é¢˜</p></blockquote><h3 id="æ•°æ®å€¾æ–œ"><a href="#æ•°æ®å€¾æ–œ" class="headerlink" title="æ•°æ®å€¾æ–œ"></a>æ•°æ®å€¾æ–œ</h3><blockquote><p>å†…å­˜ä¸å‡ï¼Œä¸€ä¸ªèŠ‚ç‚¹æ¯”å…¶ä»–èŠ‚ç‚¹ä½¿ç”¨çš„å†…å­˜å¤šï¼Œä¾‹å¦‚ä¸‹é¢è¿™å¼ å›¾çš„æƒ…å†µï¼Œå‡å¦‚è¿™é‡Œæ˜¯3ä¸ªä¸»ä»ï¼Œè¿™æ˜¯3ä¸ªä¸»èŠ‚ç‚¹ï¼Œç¬¬2ä¸ªä¸»èŠ‚ç‚¹å†…å­˜ä½¿ç”¨æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œä½†æ˜¯å®ƒçš„å¯¹è±¡æ•°åˆæ²¡æœ‰å¤ªå¤šï¼Œé‚£å¯èƒ½å°±æœ‰ä¸€äº›é—®é¢˜</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572355147510.png" srcset="/img/loading.gif" alt="1572355147510"></p><p>å®ƒæ˜¯ç”±è¿™4ç§æƒ…å†µé€ æˆçš„ï¼š</p><ul><li>èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡ï¼šå‡å¦‚ç°åœ¨æœ‰3ä¸ªèŠ‚ç‚¹ï¼Œ16384è¿›è¡Œå¹³å‡åˆ†ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªèŠ‚ç‚¹åˆ†äº†1Wä¸ªæ§½ï¼Œå®ƒçš„æ•°æ®é‡ä¼šåˆ°å¤§ä¸€äº›ï¼Œè¿™æ˜¯æ¯”è¾ƒæ­£å¸¸çš„æƒ…å†µ ï¼›</li><li>ä¸åŒæ§½å¯¹åº”çš„é”®å€¼æ•°é‡å·®å¼‚è¾ƒå¤§ï¼šå°†æ§½åˆ†é…æ¯”è¾ƒå‡åŒ€ï¼Œä½†æ˜¯æœ‰ä¸€äº›æ§½å¯¹åº”çš„é”®å€¼æ•°æ¯”è¾ƒå¤§ï¼Œå°±ä¼šé€ æˆæ•°æ®å€¾æ–œï¼›</li><li>åŒ…å«bigkeyï¼šä¸€ä¸ªéå¸¸å¤§çš„hashï¼Œå› ä¸ºRedisä¸­çš„æ•°æ®åªèƒ½ä»¥keyä¸ºå•ä½è¿›è¡Œè½åœ°åˆ°å…·ä½“çš„èŠ‚ç‚¹ï¼Œä¾‹å¦‚ä¸€ä¸ªhashæˆ–è€…listã€setï¼Œéå¸¸éå¸¸å¤§ï¼Œä¾‹å¦‚æœ‰100Wï¼Œå­˜åœ¨è¿™ç§keyçš„æ—¶å€™å°±ä¼šé€ æˆæ•°æ®å€¾æ–œï¼›</li><li>å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´ï¼šåƒhashã€setã€listã€zsetå†…å­˜é…ç½®éƒ½æœ‰ä¼˜åŒ–å‚æ•°ï¼Œä¾‹å¦‚ziplistä¼˜åŒ–ã€æ•´æ•°é›†åˆä¼˜åŒ–ï¼Œè¿™äº›å¯¹äºRedisæ¥è¯´ä¼šå‡å°‘ä¸€å®šå†…å­˜ï¼Œå‡å¦‚æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº†é‚£æ ·çš„é›†åˆã€å“ˆå¸Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬åšäº†ä¼˜åŒ–ï¼Œä½†æ˜¯æ²¡æœ‰åœ¨æ‰€æœ‰èŠ‚ç‚¹åšä¼˜åŒ–å°±ä¼šå‡ºç°ä¸å‡åŒ€</li><li>è¿˜æœ‰ä¸€äº›æ²¡æœ‰æåˆ°çš„æƒ…å†µ<ul><li>å®¢æˆ·ç¼“å†²åŒºï¼šæŸä¸€ä¸ªèŠ‚ç‚¹çš„å®¢æˆ·ç«¯ç¼“å†²åŒºéå¸¸é«˜ï¼Œä¾‹å¦‚å®ƒçš„èŠ‚ç‚¹æ‰§è¡Œäº†ä¸€äº›å¤§å‘½ä»¤ï¼Œä¹Ÿä¼šå‡ºç°è¿™ç§æƒ…å†µï¼›</li><li>Redisçš„Keyå’ŒValueæ˜¯å­˜åœ¨å“ˆå¸Œè¡¨ä¸­çš„ï¼Œå½“keyæ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œå“ˆå¸Œè¡¨ä¼šåšä¸€ä¸ªæ‰©å®¹ï¼Œåœ¨æ‰©å®¹çš„æ—¶å€™æ­£å¥½è§¦å‘æŸä¸ªæ•°å­—çš„æ—¶å€™ï¼Œä¾‹å¦‚reå“ˆå¸Œè¦å¤§äº2çš„næ¬¡æ–¹çš„æ—¶å€™ï¼Œå®ƒä¼šåšä¸€ä¸ªreå“ˆå¸Œï¼Œè¿™ä¸ªæ—¶å€™ä¼šå¤šå‡ºä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œå‡å¦‚æˆ‘ä»¬ä¸€ä¸ªé”®å€¼æ•°éå¸¸å¤šçš„æ—¶å€™ï¼Œè¿™ä¸ªå“ˆå¸Œè¡¨å¯èƒ½å ç”¨é‡å°±å¾ˆå¤§ï¼Œä¼šå‡ºç°çŸ­æš‚ä¸å‡åŒ€ã€‚</li></ul></li></ul><h4 id="èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡"><a href="#èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡" class="headerlink" title="èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡"></a>èŠ‚ç‚¹å’Œæ§½åˆ†é…ä¸å‡</h4><ul><li>redis-trib.rb info ip:portæŸ¥çœ‹èŠ‚ç‚¹ã€æ§½ã€é”®å€¼åˆ†å¸ƒï¼Œå¦‚æœä½ æ€€ç–‘æœ‰è¿™æ ·é—®é¢˜çš„æ—¶å€™å¯ä»¥å»æ‰§è¡Œï¼›</li><li>redis-trib.rb rebalance ip:portè¿›è¡Œå‡è¡¡ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰ï¼Œå®ƒæœ‰è‡ªå·±å†…éƒ¨å®ç°çš„ç®—æ³•ï¼Œè¿™ä¸ªå»ºè®®è°¨æ…ä½¿ç”¨ï¼Œå› ä¸ºè¿™é‡Œä¸€æ—¦æ¶‰åŠè¿ç§»æ§½çš„é—®é¢˜ï¼Œå°±ä¼šæ¶‰åŠåˆ°å®¢æˆ·ç«¯ï¼Œè™½ç„¶çŸ¥é“æ™ºèƒ½å®¢æˆ·ç«¯å¯ä»¥å¯¹æ§½è¿›è¡Œå…¼å®¹ï¼Œä½†æ˜¯ä¸€æ—¦æ¶‰åŠåˆ°æ§½çš„è¿ç§»çš„æ—¶å€™å»ºè®®è°¨æ…æ“ä½œï¼Œè€Œä¸”å»ºè®®åœ¨è‡ªå·±å¯æ‰§è¡Œçš„è®¡åˆ’èŒƒå›´å†…è¿›è¡Œæ“ä½œï¼›</li></ul><h4 id="ä¸åŒæ§½å¯¹åº”é”®å€¼æ•°é‡å·®å¼‚è¾ƒå¤§"><a href="#ä¸åŒæ§½å¯¹åº”é”®å€¼æ•°é‡å·®å¼‚è¾ƒå¤§" class="headerlink" title="ä¸åŒæ§½å¯¹åº”é”®å€¼æ•°é‡å·®å¼‚è¾ƒå¤§"></a>ä¸åŒæ§½å¯¹åº”é”®å€¼æ•°é‡å·®å¼‚è¾ƒå¤§</h4><p>åœ¨èŠ‚ç‚¹æ§½åˆ†é…æ¯”è¾ƒå‡åŒ€çš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œä½†æ˜¯æœ‰äº›æ§½å®ƒå¯¹åº”çš„é”®å€¼æ•°é‡æ¯”è¾ƒå¤š</p><ul><li>CRC16æ­£å¸¸æƒ…å†µä¸‹æ¯”è¾ƒå‡åŒ€ï¼Œè¿™é‡Œåˆ«äººæµ‹è¯•å¾ˆå¤šæ¬¡äº†ï¼Œä¸ç”¨å»æ€€ç–‘ï¼›</li><li>å¯èƒ½å­˜åœ¨hash_tagï¼šè¿™ä¸ªæ˜¯é€šå¸¸çš„ä¸»è¦åŸå› ï¼Œåœ¨è¿™ç§æ§½å¯¹åº”æ•°é‡ä¸æ˜¯å·®å¼‚æ¯”è¾ƒå¤§çš„æƒ…å†µä¸‹ï¼›</li><li>cluster countkeysinslot {slot}è·å–æ§½å¯¹åº”é”®å€¼ä¸ªæ•°</li></ul><h4 id="åŒ…å«bigkye"><a href="#åŒ…å«bigkye" class="headerlink" title="åŒ…å«bigkye"></a>åŒ…å«bigkye</h4><ul><li>bigkeyï¼šå› ä¸ºä¸€ä¸ªkeyåªèƒ½è½åœ¨ä¸€ä¸ªæ§½ä¸Šä»¥åŠå¯¹åº”çš„ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå‡å¦‚è¯´æœ‰ä¸€ä¸ªå¤§çš„å­—ç¬¦ä¸²æˆ–è€…å‡ ç™¾ä¸‡äººæ•°ç”šè‡³ä¸Šä¸‡å‡ åä¸‡çš„å“ˆå¸Œï¼Œæˆ–è€…setã€zsetã€listç­‰ç­‰ï¼Œå°±ä¼šå‡ºç°æ•°æ®å€¾æ–œ</li><li>ä»èŠ‚ç‚¹ï¼šredis-cli  â€“bigkeysï¼Œè¿™é‡Œå»ºè®®åœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼›</li><li>ä¼˜åŒ–ï¼šä¼˜åŒ–æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚å¯¹ä¸€ä¸ªå¤§çš„åˆ—è¡¨è¿›è¡Œæ‹†åˆ†ï¼ŒæŒ‰å“ˆå¸Œè¿›è¡ŒäºŒæ¬¡å“ˆå¸Œæ‹†åˆ†</li></ul><h4 id="å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´"><a href="#å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´" class="headerlink" title="å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´"></a>å†…å­˜ç›¸å…³é…ç½®ä¸ä¸€è‡´</h4><ul><li>hash-max-ziplist-valueã€set-max-intset-entriesç­‰ï¼Œhash-max-ziplist-valueæ˜¯å¯¹å“ˆå¸Œçš„ä¼˜åŒ–ï¼Œå½“ä¸€å®šæ¡ä»¶æ»¡è¶³çš„æ—¶å€™å“ˆå¸Œä¼šä½¿ç”¨ziplistï¼Œset-max-intset-entriesï¼šæ•´æ•°é›†åˆä¼˜åŒ–ï¼Œå½“æœ‰äº›æ¡ä»¶æ»¡è¶³çš„æ—¶å€™ï¼Œsetä¼šä½¿ç”¨æ•´æ•°é›†åˆæ¥å®ç°å†…å­˜ä¼˜åŒ–ï¼Œå‡å¦‚æˆ‘ä»¬é›†ç¾¤æœ‰6ä¸ªèŠ‚ç‚¹ï¼Œé‚£å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨äº†è¿™ç§ä¼˜åŒ–ï¼Œè€Œä¸”æˆ‘ä»¬é›†ç¾¤ä¸­å¤§é‡ä½¿ç”¨äº†hashã€setï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹æ²¡æœ‰é…ç½®å°±ä¼šé€ æˆèŠ‚ç‚¹æ•°æ®ä¸å‡åŒ€ï¼›</li><li>ä¼˜åŒ–ï¼šå®šæœŸâ€œæ£€æŸ¥â€é…ç½®ä¸€è‡´æ€§ï¼Œè¿™å¯¹äºé›†ç¾¤ç®¡ç†æ˜¯éå¸¸é‡è¦çš„ï¼Œé›†ç¾¤ç»é‡è¾¾æˆç»Ÿä¸€</li></ul><h3 id="è¯·æ±‚å€¾æ–œ"><a href="#è¯·æ±‚å€¾æ–œ" class="headerlink" title="è¯·æ±‚å€¾æ–œ"></a>è¯·æ±‚å€¾æ–œ</h3><blockquote><p>æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„keyè¯·æ±‚é‡éå¸¸é«˜ï¼Œä¹Ÿå°±æ˜¯ä¿—ç§°çš„çƒ­ç‚¹é—®é¢˜</p></blockquote><ul><li>çƒ­ç‚¹keyï¼šé‡è¦çš„keyæˆ–è€…bigkeyï¼Œä¸¾ä¸ªä¾‹å­ï¼šä¸€ä¸ªé‡è¦æ˜æ˜Ÿå‘å¸ƒäº†é‡è¦æ¶ˆæ¯ï¼Œä¾‹å¦‚æ–°æµªå¾®åšä¸Šé¢çš„å¾ˆå¤šå¤§Vï¼Œåœ¨é‡è¦çš„èŠ‚æ—¥ã€æ—¶é—´ç‚¹å‘äº†ä¸€äº›é‡è¦çš„æ¶ˆæ¯ä¼šè½åˆ°keyä¸Šé¢ï¼Œå‡å¦‚æ˜¯æœ‰è¿™æ ·çš„é—®é¢˜ï¼Œå°±ä¼šå‡ºç°çƒ­ç‚¹é—®é¢˜ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯bigkeyï¼šhashæˆ–è€…listæ˜¯ä¸€ä¸ªbigkeyï¼Œè¿™ä¸ªbigkeyåœ¨å¾ˆå¤šä¸šåŠ¡åœºæ™¯ä¼šç”¨åˆ°å®ƒï¼Œä¹Ÿä¼šæœ‰çƒ­ç‚¹çš„é—®é¢˜</li><li>ä¼˜åŒ–ï¼š<ul><li>é¿å…ä½¿ç”¨bigkeyï¼›</li><li>çƒ­ç‚¹ä¸è¦ç”¨hash_tagï¼›</li><li>å¦‚æœçœŸæœ‰è¿™æ ·çš„çƒ­ç‚¹keyï¼Œä½†æ˜¯å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸æ˜¯éå¸¸é«˜çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜+MQã€‚</li></ul></li></ul><h2 id="è¯»å†™åˆ†ç¦»"><a href="#è¯»å†™åˆ†ç¦»" class="headerlink" title="è¯»å†™åˆ†ç¦»"></a>è¯»å†™åˆ†ç¦»</h2><ul><li>åœ¨é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä»èŠ‚ç‚¹æ˜¯ä¸æ¥å—ä»»ä½•è¯»å†™è¯·æ±‚çš„ã€‚<ul><li>å‡å¦‚ä½ å¯¹å®ƒè¿›è¡Œè¯»ï¼Œå®ƒä¼šé‡å®šå‘åˆ°è´Ÿè´£æ§½çš„ä¸»èŠ‚ç‚¹è¿›è¡Œå®Œæˆï¼›</li><li>æœ‰ä¸€ä¸ªå‘½ä»¤å¯ä»¥è¾¾åˆ°è¯»çš„æ•ˆæœï¼š<code>readonly</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿æ¥çº§çš„å‘½ä»¤ï¼Œå½“è¿æ¥æ–­äº†ä¹‹åä½ éœ€è¦å†å»æ‰§è¡Œ<code>readonly</code>æ‰å¯ä»¥å®Œæˆè¿™æ ·çš„å·¥ä½œã€‚</li><li>ä¸‹é¢å¯¹ä¸Šè¿°è¿›è¡Œæ¼”ç¤º</li></ul></li></ul><p>é¦–å…ˆåœ¨7000æ‰§è¡Œå†™å‘½ä»¤</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572357983112.png" srcset="/img/loading.gif" alt="1572357983112"></p><p>å¯¹7003çš„slaveå»æ‰§è¡Œåº¦å‘½ä»¤</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572358024669.png" srcset="/img/loading.gif" alt="1572358024669"></p><blockquote><p>è¿™é‡Œå®ƒä¸ä¼šå»æ‰§è¡Œè¯»çš„å‘½ä»¤</p></blockquote><p>è¿™é‡Œå…ˆæ‰§è¡Œreadonlyï¼Œåœ¨å»è¯»ï¼Œå®ƒå°±ä¼šè‡ªå·±å»æ‰§è¡Œï¼Œå®ƒå¯ä»¥æ‰¿æ‹…è¯»çš„å·¥ä½œï¼Œä½†æ˜¯ä½ éœ€è¦æ¯æ¬¡å»å†™readonly</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572358044173.png" srcset="/img/loading.gif" alt="1572358044173"></p><ul><li>å¦‚æœæƒ³å®Œæˆè¯»å†™åˆ†ç¦»æ˜¯å¾ˆå¤æ‚çš„<ul><li>é¦–å…ˆè¦é¢ä¸´å•æœºèŠ‚ç‚¹çš„é—®é¢˜ ï¼Œå•æœºä¸»ä»ä¼šæœ‰é—®é¢˜ï¼Œä¾‹å¦‚å¤åˆ¶å»¶è¿Ÿã€è¯»å–è¿‡æœŸæ•°æ®ã€ä»èŠ‚ç‚¹æ•…éšœ</li><li>ä½¿ç”¨Redis Clusterå»å®ç°è¯»å†™åˆ†ç¦»çš„æ—¶å€™æˆ‘ä»¬éœ€è¦çŸ¥é“å¯¹åº”çš„slaveæ± å­ï¼ŒRedisClusteræä¾›äº†ä¸€ä¸ªå‘½ä»¤ï¼šcluster slaves {node-id}æ¥è·å¾—å¯¹åº”çš„ä»èŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°è‡ªå·±çš„å®¢æˆ·ç«¯ï¼Œè¿™æœ¬èº«æ˜¯éå¸¸å¤æ‚çš„ï¼Œè¿™é‡Œé¢è¿˜æ¶‰åŠåˆ°ä¸€ä¸ªé—®é¢˜ï¼šå®ƒé‡Œé¢ä¼šæœ‰èŠ‚ç‚¹å’Œæ§½çš„å¯¹åº”å…³ç³»ï¼Œæ€»çš„æ¥è¯´ä½¿ç”¨RedisClusteræ¥å®ç°è¯»å†™åˆ†ç¦»çš„æˆæœ¬æ˜¯éå¸¸é«˜çš„ï¼Œåœ¨çœŸçš„æœ‰è¿™ç§éœ€æ±‚çš„æ—¶å€™å»ºè®®å»è€ƒè™‘æŠŠä½ çš„é›†ç¾¤è§„æ¨¡æ‰©å¤§ä¸€äº›ï¼Œè€Œä¸è¦å»è€ƒè™‘ä½¿ç”¨å®ƒçš„ä»èŠ‚ç‚¹è¿™æ ·çš„æˆæœ¬éå¸¸é«˜ï¼Œå‡å¦‚ä½ æ²¡æœ‰è¿™æ ·çš„æˆæœ¬ï¼Œä½ å¯ä»¥å»è‡ªå·±å®ç°è¿™æ ·çš„å®¢æˆ·ç«¯ï¼Œè™½ç„¶æ•´ä½“æ€è·¯æ„æ€è¯´ä½ è¦ç»´æŠ¤ä¸€ä¸ªå¯ç”¨çš„slaveæ± å­è¿˜è¦ä¿è¯æ§½å’ŒèŠ‚ç‚¹çš„å…³ç³»ä½ èƒ½çŸ¥é“ï¼Œè¿™æ ·å°±å¥½äº†ï¼Œè·Ÿä¹‹å‰è¯´çš„RedisSentinelæ€è·¯æ˜¯åŸºæœ¬ä¸€æ ·çš„</li></ul></li></ul><h2 id="æ•°æ®è¿ç§»"><a href="#æ•°æ®è¿ç§»" class="headerlink" title="æ•°æ®è¿ç§»"></a>æ•°æ®è¿ç§»</h2><p>å®˜æ–¹è¿ç§»å·¥å…·ï¼š<code>redis-trib.rb import</code>å‘½ä»¤å¯ä»¥å°†æ•°æ®è¿ç§»åˆ°é›†ç¾¤ï¼Œå¯¹äºæˆ‘ä»¬å»å‡çº§åˆ°é›†ç¾¤æ˜¯éå¸¸æœ‰å¸®åŠ©çš„ï¼Œå› ä¸ºæˆ‘ä»¬ä¹‹å‰çš„æ•°æ®å¯èƒ½æ˜¯å­˜åœ¨å•èŠ‚ç‚¹ä¸Šï¼Œä½†æ˜¯å®ƒæœ‰ä¸€äº›é—®é¢˜ï¼š</p><ul><li>åªèƒ½ä»å•æœºè¿ç§»åˆ°é›†ç¾¤ï¼›</li><li>ä¸æ”¯æŒåœ¨çº¿è¿ç§»ï¼šsourceéœ€è¦åœå†™ï¼Œåœ¨è¿ç§»æœŸé—´å†™å…¥çš„æ•°æ®æ˜¯ä¸ä¼šè¢«è¿ç§»çš„ï¼›</li><li>ä¸æ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼šè¿ç§»è¿‡ç¨‹ä¸­å¦‚æœæœ‰ä¸­æ–­å®ƒæ²¡æ³•è®°å½•ä¹‹å‰è¿ç§»çš„è¿‡ç¨‹ï¼›</li><li>å®ƒæ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ï¼Œå¦‚æœä½ çš„æ•°æ®é‡æ¯”è¾ƒå¤§çš„è¯ï¼Œå¯èƒ½ä¼šæ¯”è¾ƒæ…¢ã€‚</li></ul><p>åœ¨çº¿è¿ç§»ï¼š</p><ul><li>å”¯å“ä¼šï¼šredis-migate-tool</li><li>è±Œè±†èšï¼šredis-port</li></ul><p>è¿™2ä¸ªå·¥å…·åœ¨å¾ˆå¤šå…¬å¸éƒ½æœ‰ä½¿ç”¨ï¼Œå®ƒåŸºæœ¬åŸç†æ˜¯å•ç‹¬èµ·ä¸€ä¸ªèŠ‚ç‚¹ä¼ªè£…æˆsourceèŠ‚ç‚¹çš„slaveï¼Œè¿™æ ·çš„è¯å®ƒå¯ä»¥æ‹¿åˆ°å…¨é‡æ•°æ®ï¼Œè€Œä¸”å®ƒè¿˜å¯ä»¥å¾—åˆ°æŒç»­çš„æ›´æ–°æ•°æ®ï¼Œç„¶åå®ƒåœ¨åˆ©ç”¨è¿™ä»½æ›´æ–°æ•°æ®ç„¶åå†å»åŒæ­¥ç»™targetèŠ‚ç‚¹ï¼Œåœ¨sourceå’Œtargetä¹‹é—´åšäº†ä¸€å±‚ä¸­è½¬ç«™ï¼Œè¿™ä¸ªä¸­è½¬ç«™å¯ä»¥æ‹¿åˆ°sourceçš„æ›´æ–°æ¥å®ç°è¿ç§»</p><hr><p><strong>æ¼”ç¤º</strong></p><blockquote><p>è¿™é‡Œåªæ¼”ç¤ºå®˜æ–¹å·¥å…·ï¼š</p></blockquote><p>ç°åœ¨æœ‰ä¸€ä¸ªå•èŠ‚ç‚¹ï¼Œç°åœ¨æƒ³æŠŠè¿™é‡Œé¢çš„æ•°æ®è¿ç§»åˆ°é›†ç¾¤ä¸Š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359118991.png" srcset="/img/loading.gif" alt="1572359118991"></p><p>é€šè¿‡<code>redis-trib.rb import</code>è¿›è¡Œè¿ç§»ï¼Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359216532.png" srcset="/img/loading.gif" alt="1572359216532"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359287984.png" srcset="/img/loading.gif" alt="1572359287984"></p><p>ï¼Œåœ¨è¿ç§»æœŸé—´åœ¨è¿™ä¸ªå•èŠ‚ç‚¹å»å†™æ•°æ®ï¼Œç­‰ä¼šå»å¯¹æ¯”å®ƒæ˜¯å¦æ˜¯ä¸€ä¸ªåœ¨çº¿çš„è¿ç§»</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359258889.png" srcset="/img/loading.gif" alt="1572359258889"></p><p>å¤§å°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359369595.png" srcset="/img/loading.gif" alt="1572359369595"></p><p>è¿ç§»å®Œæˆä¹‹åæ¥çœ‹ä¸€ä¸‹é›†ç¾¤çš„ä¿¡æ¯ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å®ƒçš„å¤§å°æ˜¯10002ï¼Œè€Œä¹‹å‰æ˜¯100003ï¼Œå› ä¸ºåœ¨è¿™æœŸé—´è¿ç§»æ•°æ®ï¼Œæ­¤æ—¶åœ¨åŸç†çš„å•æœºèŠ‚ç‚¹åŠ å…¥æ•°æ®æ˜¯ä¸ä¼šåŒæ­¥çš„ï¼Œä¸ºä»€ä¹ˆæ˜¯10002å‘¢ï¼Ÿå› ä¸º<code>redis-trib.rb import</code>ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªscanæ¨¡å¼ï¼Œå®ƒæ˜¯å¯¹è¿™ä¸ªåŸèŠ‚ç‚¹ä½¿ç”¨scanè¿›è¡Œæ‰«æï¼Œå› ä¸ºåœ¨scanæœŸé—´åŠ å…¥æ•°æ®æ­£å¥½è¢«å®ƒscanåˆ°äº†è¢«åŠ å…¥è¿›æ¥ï¼Œæœ‰çš„æ•°æ®è¿‡äº†scançš„ä¸€ä¸ªæ¸¸æ ‡æ‰€ä»¥å®ƒæ²¡æœ‰è¿›è¡Œæ’å…¥ï¼Œæ€»ä¹‹ä¸ç®¡å®ƒåœ¨æ’å…¥æœŸé—´è¿›è¡Œæ’å…¥ä½†æ˜¯å‘¢æˆ‘ä»¬ç°åœ¨å†å»å¯¹åŸèŠ‚ç‚¹æ“ä½œçš„æ—¶å€™åŸèŠ‚ç‚¹å·²ç»æ”¶ä¸åˆ°å¯¹åº”çš„ä¿¡æ¯äº†ï¼Œè¿™ä¸ªå¯¹å¾ˆå¤šåœºæ™¯æ˜¯æ— æ³•å®¹å¿çš„ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ç”¨ä¸Šé¢ä»‹ç»çš„2æ¬¾å·¥å…·</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572359420312.png" srcset="/img/loading.gif" alt="1572359420312"></p><h2 id="é›†ç¾¤vså•æœº"><a href="#é›†ç¾¤vså•æœº" class="headerlink" title="é›†ç¾¤vså•æœº"></a>é›†ç¾¤vså•æœº</h2><h3 id="é›†ç¾¤é™åˆ¶"><a href="#é›†ç¾¤é™åˆ¶" class="headerlink" title="é›†ç¾¤é™åˆ¶"></a>é›†ç¾¤é™åˆ¶</h3><ul><li>keyæ‰¹é‡æ“ä½œæ”¯æŒæœ‰é™ï¼šä¾‹å¦‚mgetã€msetå¿…é¡»åœ¨ä¸€ä¸ªslotï¼Œåœ¨åé¢ä»‹ç»ç¼“å­˜ä¼˜åŒ–ä¸è®¾è®¡ä¼šä½¿ç”¨ä¸€äº›æ–¹æ³•æ¥æ¨¡æ‹Ÿå‡ºmgetã€msetå®Œæˆè¿™æ ·çš„æ•ˆæœï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šå»æ”¯æŒè¿™æ ·çš„å‘½ä»¤ï¼Œä½†æ— æ³•è¾¾åˆ°åŸå­æ€§ï¼›</li><li>keyäº‹åŠ¡å’ŒLuaæ”¯æŒæœ‰é™ï¼šä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨äº‹åŠ¡æˆ–è€…Luaå¿…é¡»å°†è¿™æ•´ä¸ªè¿‡ç¨‹ä¸­ä½¿ç”¨keyå¿…é¡»åœ¨ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå½“ç„¶è¿™é‡Œå¯ä»¥ä½¿ç”¨åƒhash_tagè®©å®ƒå»åˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†æ˜¯å®ƒä½¿ç”¨æ¥è¯´è¿˜æ˜¯ä¼šå—é™çš„ï¼›</li><li>keyæ˜¯æ•°æ®åˆ†åŒºçš„æœ€å°ç²’åº¦ï¼šä¸æ”¯æŒbigkeyåˆ†åŒºï¼›</li><li>ä¸æ”¯æŒå¤šä¸ªæ•°æ®åº“çš„ï¼Œåœ¨é›†ç¾¤æ¨¡å¼ä¸‹åªæœ‰db 0ï¼Œæ²¡æœ‰16ä¸ªæ•°æ®åº“ï¼Œå½“ç„¶åœ¨ä¸€å¸®çŠ¶æ€ä¸‹çš„å•æœºæƒ…å†µä¸‹ä¹Ÿä¸å»ºè®®ä½¿ç”¨è¿™ç§å¤šæ•°æ®åº“æ¨¡å¼ï¼›</li><li>å¤åˆ¶åªæ”¯æŒä¸€å±‚ï¼šä¸æ”¯æŒæ ‘å½¢å¤åˆ¶ç»“æ„ï¼Œåœ¨ä¹‹å‰çš„ä¸»ä»å¤åˆ¶ä¸­ä»‹ç»è¿‡æ ‘å½¢ç»“æ„çš„ä¼˜åŠ¿ï¼Œä½†æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¸‹æ˜¯ä¸æ”¯æŒçš„ã€‚</li></ul><h3 id="æ€è€ƒ-åˆ†å¸ƒå¼Redisä¸ä¸€å®šå¥½"><a href="#æ€è€ƒ-åˆ†å¸ƒå¼Redisä¸ä¸€å®šå¥½" class="headerlink" title="æ€è€ƒ-åˆ†å¸ƒå¼Redisä¸ä¸€å®šå¥½"></a>æ€è€ƒ-åˆ†å¸ƒå¼Redisä¸ä¸€å®šå¥½</h3><ol><li>Redis Clusterï¼šæ»¡è¶³å®¹é‡å’Œæ€§èƒ½çš„æ‰©å±•æ€§ï¼Œä½†åœ¨å¾ˆå¤šä¸šåŠ¡æ˜¯ä¸éœ€è¦çš„ï¼Œå› ä¸ºå¾ˆå¤šä¸šåŠ¡çš„QPSæ˜¯è¾¾ä¸åˆ°è¿™ä¹ˆé«˜çš„ï¼Œæˆ–è€…å®ƒçš„å®¹é‡è¾¾ä¸åˆ°è¿™ä¹ˆé«˜ï¼Œæ‰€ä»¥å¤§å®¶åœ¨ä¼ä¸šé‡Œè¦è€ƒè™‘ä¸€ä¸‹è‡ªå·±éœ€ä¸éœ€è¦Redis Clusterï¼Œä¸è¦ä¸€å‘³å»è¿½æ—¶é«¦ï¼Œä¸è¦å†ä¸äº†è§£çš„æƒ…å†µä¸‹å»åšç”³è¯·ï¼›<ul><li>å¤§å¤šæ•°æ—¶å®¢æˆ·ç«¯æ€§èƒ½ä¼šâ€œé™ä½â€ï¼Œæ¯”å¦‚è¯´æ‰¹é‡æ“ä½œä½ åœ¨æ€ä¹ˆä¼˜åŒ–åœ¨å¤šä¸ªèŠ‚ç‚¹è¿›è¡Œæ“ä½œè‚¯å®šæ²¡æœ‰åœ¨ä¸€ä¸ªèŠ‚ç‚¹é«˜ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ä¸€æ¬¡å‘½ä»¤ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°å¤šèŠ‚ç‚¹å»è·å–ï¼›</li><li>å‘½ä»¤æ— æ³•è·¨èŠ‚ç‚¹æ—¶å€™ç”¨ï¼šmgetã€keysã€scanã€flushã€sinterç­‰ï¼›</li><li>Luaå’Œäº‹åŠ¡æ— æ³•è·¨èŠ‚ç‚¹ä½¿ç”¨ï¼›</li><li>å®¢æˆ·ç«¯ç»´æŠ¤æ›´å¤æ‚ï¼šSDKå’Œåº”ç”¨æœ¬èº«æ¶ˆè€—ï¼ˆä¾‹å¦‚æ›´å¤šçš„è¿æ¥æ± ï¼‰ã€‚</li></ul></li><li>å¾ˆå¤šåœºæ™¯Redis Sentinelå·²ç»åšå¤Ÿå¥½äº†ï¼ŒRedis Sentinelæœ¬èº«æ˜¯é«˜å¯ç”¨äº†ï¼Œè§£å†³å¼€å‘ä¸­çš„ä¸€ä¸ªå¤§çš„é—®é¢˜ï¼Œè™½ç„¶å®ƒæ˜¯ä¸€ä¸ªå•ç‚¹ï¼Œä½†å®ƒèƒ½è¾¾åˆ°ä¸‡çº§åˆ«çš„QPSï¼Œå¯¹äºå¤§éƒ¨åˆ†ä¸šåŠ¡åœºæ™¯æ˜¯è¶³çš„ã€‚</li></ol><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><ul><li>Redis clusteræ•°æ®åˆ†åŒºè§„åˆ™é‡‡ç”¨è™šæ‹Ÿæ§½æ–¹å¼(16384ä¸ªæ§½),æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€<br>éƒ¨åˆ†æ§½å’Œç›¸å…³æ•°æ®,å®ç°æ•°æ®å’Œè¯·æ±‚çš„è´Ÿè½½å‡è¡¡ã€‚</li><li>æ­å»ºé›†ç¾¤åˆ’åˆ†å››ä¸ªæ­¥éª¤:å‡†å¤‡èŠ‚ç‚¹ã€èŠ‚ç‚¹æ¡æ‰‹ã€åˆ†é…æ§½ã€å¤åˆ¶ã€‚<br>redis- trib.rbå·¥å…·ç”¨äºå¿«é€Ÿæ­å»ºé›†ç¾¤ã€‚</li><li>é›†ç¾¤ä¼¸ç¼©é€šè¿‡åœ¨èŠ‚ç‚¹ä¹‹é—´ç§»åŠ¨æ§½å’Œç›¸å…³æ•°æ®å®ç°ã€‚<ul><li>æ‰©å®¹æ—¶æ ¹æ®æ§½è¿ç§»è®¡åˆ’æŠŠæ§½ä»æºèŠ‚ç‚¹è¿‚ç§»åˆ°æ–°èŠ‚ç‚¹ã€‚</li><li>æ”¶ç¼©æ—¶å¦‚æœä¸‹çº¿çš„èŠ‚ç‚¹æœ‰è´Ÿè´£çš„æ§½éœ€è¦è¿ç§»åˆ°å…¶å®ƒèŠ‚ç‚¹,å†é€šè¿‡ cluster forgetiå‘½ï¼Œä»¤è®©é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹å¿˜è®°è¢«ä¸‹çº¿èŠ‚ç‚¹ã€‚</li></ul></li><li>ä½¿ç”¨smarå®¢æˆ·ç«¯æ“ä½œé›†ç¾¤è¾¾åˆ°é€šä¿¡æ•ˆç‡æœ€å¤§åŒ–,å®¢æˆ·ç«¯å…§éƒ¨è´Ÿè´£è®¡ç®—ç»´<br>æŠ¤é”®-&gt;æ§½-&gt;èŠ‚ç‚¹çš„æ˜ å°„,ç”¨äºå¿«é€Ÿå®šä½åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚</li><li>é›†ç¾¤è‡ªåŠ¨æ•…éšœè½¬ç§»è¿‡ç¨‹åˆ†ä¸ºæ•…éšœå‘ç°å’ŒèŠ‚ç‚¹æ¢å¤ã€‚èŠ‚ç‚¹ä¸‹çº¿åˆ†ä¸ºä¸»è§‚ä¸‹çº¿<br>å’Œå®¢è§‚ä¸‹çº¿,å½“è¶…è¿‡åŠæ•°ä¸»èŠ‚ç‚¹è®¤ä¸ºæ•…éšœèŠ‚ç‚¹ä¸ºä¸»è§‚ä¸‹çº¿æ—¶æ ‡è®°å®ƒä¸ºå®¢è§‚<br>ä¸‹çº¿çŠ¶æ€ã€‚ä»èŠ‚ç‚¹è´Ÿè´£å¯¹å®¢è§‚ä¸‹çº¿çš„ä¸»èŠ‚ç‚¹è§¦å‘æ•…éšœæ¢å¤æµç¨‹,ä¿è¯é›†ç¾¤<br>çš„å¯ç”¨æ€§ã€‚</li><li>å¼€å‘è¿ç»´å¸¸è§é—®é¢˜åŒ…æ‹¬ï¼šè¶…å¤§è§„æ¨¡é›†ç¾¤å¸¦å®½æ¶ˆè€—ï¼Œpub/subå¹¿æ’­é—®é¢˜ï¼Œé›†ç¾¤å€¾æ–œé—®é¢˜ï¼Œå•æœºå’Œé›†ç¾¤å¯¹æ¯”ç­‰</li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 8.åˆè¯†Redis Cluster</title>
    <link href="/redis-8.html"/>
    <url>/redis-8.html</url>
    
    <content type="html"><![CDATA[<h1 id="å‘¼å”¤é›†ç¾¤"><a href="#å‘¼å”¤é›†ç¾¤" class="headerlink" title="å‘¼å”¤é›†ç¾¤"></a>å‘¼å”¤é›†ç¾¤</h1><h2 id="å¹¶å‘é‡"><a href="#å¹¶å‘é‡" class="headerlink" title="å¹¶å‘é‡"></a>å¹¶å‘é‡</h2><p>Redisæ¯ç§’å¯ä»¥è¾¾åˆ°æ¯ç§’10W QPSï¼Œä½†æ˜¯æœ‰äº›ä¸šåŠ¡æ˜¯éœ€è¦100W QPS,</p><h2 id="æ•°æ®é‡"><a href="#æ•°æ®é‡" class="headerlink" title="æ•°æ®é‡"></a>æ•°æ®é‡</h2><p>ç°åœ¨æœ‰ä¸€å°æœºå™¨16~256Gï¼Œå‡å¦‚è¯´ä¸€ä¸ªä¼ ç»Ÿçš„Rediséƒ¨ç½²åœ¨ä¸Šé¢ï¼Œå‡å¦‚è¯´ä¸šåŠ¡éœ€è¦500Gæ•°æ®å‘¢ï¼Ÿ</p><h2 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h2><p>é…ç½®â€œå¼ºæ‚â€çš„æœºå™¨ï¼šè¶…å¤§å†…å­˜ã€ç‰›xCPUç­‰ï¼Œä½†æ˜¯éšç€ä¸šåŠ¡é‡å˜å¾—è¶Šæ¥è¶Šå¤§çš„æ—¶å€™ï¼Œå•æœºå·²ç»æ— æ³•æ»¡è¶³äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572003131116.png" srcset="/img/loading.gif" alt="1572003131116"></p><h2 id="æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ"><a href="#æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ"></a>æ­£ç¡®çš„è§£å†³æ–¹æ¡ˆ</h2><p>åˆ†å¸ƒå¼ï¼šç®€å•çš„è®¤ä¸ºåŠ æœºå™¨ï¼›</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572003163058.png" srcset="/img/loading.gif" alt="1572003163058"></p><h1 id="æ•°æ®åˆ†å¸ƒæ¦‚å¿µ"><a href="#æ•°æ®åˆ†å¸ƒæ¦‚å¿µ" class="headerlink" title="æ•°æ®åˆ†å¸ƒæ¦‚å¿µ"></a>æ•°æ®åˆ†å¸ƒæ¦‚å¿µ</h1><p>ç°åœ¨æœ‰ä¸€ä»½å…¨é‡çš„æ•°æ®ï¼Œå®ƒçš„å•æœºå·²ç»æ— æ³•æ»¡è¶³éœ€æ±‚ï¼Œæ‰€ä»¥å°±è¦å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºï¼Œæ¯”å¦‚ç°åœ¨æœ‰100ä»½æ•°æ®æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åˆ†åˆ°è‹¥å¹²ä¸ªå­é›†å½“ä¸­ï¼Œ</p><p>å®ƒçš„åˆ†åŒºè§„åˆ™ï¼š</p><ul><li><p>é¡ºåºåˆ†åŒºï¼šå‡å¦‚æœ‰3ä¸ªèŠ‚ç‚¹<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572003461916.png" srcset="/img/loading.gif" alt="1572003461916" style="zoom: 25%;" /></p></li><li><p>å“ˆå¸Œåˆ†åŒºï¼šå¯¹æ¯ä¸ªæ•°å­—åšä¸€ä¸ªhashå‡½æ•°ï¼Œé€šè¿‡èŠ‚ç‚¹å»ç»™å®ƒå–ä½™,ä¾‹å¦‚<code>hash(key)%3</code>ï¼Œç»“æœæ˜¯0æ”¾1åˆ†åŒºï¼Œ1æ”¾2åˆ†åŒºï¼Œ2æ”¾3åˆ†åŒºï¼Œå®ƒè¿™é‡Œæœ‰å¾ˆçš„å‡½æ•°ï¼Œç­‰ä¼šä¼šä»‹ç»ã€‚<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572003650622.png" srcset="/img/loading.gif" alt="1572003650622" style="zoom:25%;" /></p></li></ul><p><strong>æ•°æ®åˆ†å¸ƒå¯¹æ¯”</strong></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572003693407.png" srcset="/img/loading.gif" alt="1572003693407"></p><h1 id="èŠ‚ç‚¹å–ä½™åˆ†åŒº"><a href="#èŠ‚ç‚¹å–ä½™åˆ†åŒº" class="headerlink" title="èŠ‚ç‚¹å–ä½™åˆ†åŒº"></a>èŠ‚ç‚¹å–ä½™åˆ†åŒº</h1><p>3ä¸ªèŠ‚ç‚¹ä¸­çš„hashåˆ†åŒºï¼š å¯¹æ¯ä¸ªkeyå»æ‰§è¡Œä¸€ä¸ªhanshå‡½æ•°å¯¹3å»å–ä¸€ä¸ªä½™æ•°ï¼Œå¦‚æœæ˜¯0åˆ°1åˆ†åŒºï¼Œ1åˆ°2åˆ†åŒºï¼Œ2åˆ°3åˆ†åŒºâ€¦</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572004167066.png" srcset="/img/loading.gif" alt="1572004167066"></p><p>è¿™æ˜¯ä¸€ä¸ªç®€å•çš„åˆ†åŒºæ“ä½œï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœéœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œä¸šåŠ¡é‡ä¸æ–­å¢å¤§ï¼Œ3ä¸ªèŠ‚ç‚¹æ— æ³•æ»¡è¶³è¦æ±‚ï¼Œç°åœ¨åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ·»åŠ ä¹‹åæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ•°æ®ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå› ä¸ºè¦åšçš„æ˜¯å¯¹æ¯ä¸€ä¸ªæ•°æ®å»å–ä¸€ä¸ªhashå»å–å®ƒçš„èŠ‚ç‚¹æ•°çš„ä½™æ•°ï¼Œé‚£å°±ä¼šæœ‰é€ æˆå¾ˆå¤šçš„æ•°æ®åç§»ï¼ŒåŸæ¥åœ¨ç¬¬1ä¸ªèŠ‚ç‚¹çš„3ï¼ŒåŸæ¥å¯¹3å»å–ä½™æ˜¯0ï¼Œå¯¹4å–ä½™æ˜¯3ï¼Œæ‰€ä»¥å®ƒä¼šåˆ°4èŠ‚ç‚¹â€¦.<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572004395008.png" srcset="/img/loading.gif" alt="1572004395008" style="zoom: 50%;" /></p><p>è¿™é‡Œæœ‰ä¸€ç§æ–¹å¼å«åšâ€œå¤šè¢«æ‰©å®¹â€ï¼Œæ¯”å¦‚åŸæœ¬æ˜¯3ä¸ªèŠ‚ç‚¹ï¼Œæ‰©å®¹çš„æ—¶å€™å†åŠ 3ä¸ªèŠ‚ç‚¹ä¹Ÿå°±æ˜¯3çš„å€æ•°ï¼Œè¿™æ ·åšå¯ä»¥ä¿ç•™ç™¾åˆ†50çš„æ•°æ®ä¸è¢«è¿ç§»ï¼Œä¹‹å‰è¿™æ ·ä¼šè¿ç§»ç™¾åˆ†80ä¼šæœ‰å¾ˆæ˜æ˜¾çš„é™ä½ã€‚å¦‚æœä½ å¸Œæœ›è¿ç§»é‡å°‘å¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œåœ¨è¿ç§»ä¹‹åå»ç¼“å­˜ä¸­ç¬¬ä¸€æ¬¡å¯èƒ½ä¼šå–ä¸åˆ°æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å»æ•°æ®åº“ä¸­è·å–åˆ°é‚£ä¸ªæ•°æ®ï¼Œç„¶åæ”¾åˆ°Redisä¸­ï¼Œè¿™æ ·ä¼šå‡ºç°å¤§é‡çš„ç¼“å­˜å›å†™ï¼Œè¿™æ ·å¯¹ä¸€ä¸ªç³»ç»Ÿæ¥è¯´æ˜¯ä¸€ä¸ªä¸æ­£å¸¸çš„ç°è±¡</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572004570436.png" srcset="/img/loading.gif" alt="1572004570436"></p><ul><li>å®¢æˆ·ç«¯åˆ†ç‰‡ï¼šå“ˆå¸Œ+å–ä½™</li><li>èŠ‚ç‚¹ä¼¸ç¼©ï¼šæ•°æ®èŠ‚ç‚¹å…³ç³»å˜åŒ–ï¼Œå¯¼è‡´æ•°æ®è¿ç§»</li><li>è¿ç§»æ•°é‡å’Œæ·»åŠ èŠ‚ç‚¹æ•°é‡æœ‰å…³ï¼šå»ºè®®ç¿»å€æ‰©å®¹</li></ul><h1 id="ä¸€è‡´æ€§å“ˆå¸Œ"><a href="#ä¸€è‡´æ€§å“ˆå¸Œ" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œ"></a>ä¸€è‡´æ€§å“ˆå¸Œ</h1><blockquote><p>å‰é¢å–ä½™æ˜¯æœ‰é—®é¢˜çš„ï¼ŒåŠ äº†èŠ‚ç‚¹ä¹‹åå®ƒçš„æ•°æ®è¿ç§»é‡æ˜¯éå¸¸å¤§çš„ï¼Œæ— è®ºæ˜¯ç™¾åˆ†50è¿˜æ˜¯ç™¾åˆ†80å®ƒå½±å“çš„èŒƒå›´å¤ªå¤§äº†ï¼Œä¸€è‡´æ€§hashå°±è§£å†³äº†è¿™ä¸ªé—®é¢˜</p></blockquote><h2 id="æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="æ˜¯ä»€ä¹ˆï¼Ÿ"></a>æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å°†æ•°æ®çœ‹æˆä¸€ä¸ªç¯ï¼Œå°†æ•°æ®åšä¸€ä¸ªtokenç¯ï¼Œè¿™ä¸ªtokenç¯çš„æ„æ€ä»£è¡¨æ•°æ®èŒƒå›´ï¼Œ0~2çš„32æ¬¡æ–¹è¿™æ ·çš„èŒƒå›´ï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªèŠ‚ç‚¹å»åˆ†é…ä¸€ä¸ªtokenï¼Œè¿™ä¸ªtokenæ˜¯åœ¨èŒƒå›´å†…ï¼Œæ¯”å¦‚èŠ‚ç‚¹1çš„èŒƒå›´ï¼š0åˆ°å¤šå°‘å¤šå°‘ï¼ŒèŠ‚ç‚¹2æ˜¯å¤šå°‘å¤šå°‘ï¼Œæ¯ä¸€ä¸ªèŒƒå›´è´Ÿè´£ä¸€å®šçš„æ•°æ®ä¸€éƒ¨åˆ†tokenï¼Œå½“æ•°æ®çš„keyå¯¹å®ƒè¿›è¡Œhashè®¡ç®—ä¹‹åï¼Œå®ƒæ˜¯åœ¨æŸèŒƒå›´å†…ï¼Œä¾‹å¦‚å›¾ä¸­çš„èŒƒå›´ï¼Œå®ƒä¼šå»é¡ºæ—¶é’ˆå»æ‰¾èŠ‚ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572005650015-1572005654310.png" srcset="/img/loading.gif" alt="1572005650015"></p><h2 id="è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"><a href="#è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ" class="headerlink" title="è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ"></a>è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ</h2><p>å‡å¦‚ç°åœ¨æ·»åŠ ä¸€ä¸ªnode5ï¼Œè¿™ä¸ªnode5æ˜¯åœ¨1å’Œ2ä¹‹é—´ï¼Œæˆ‘ä»¬ä¸ºå®ƒåˆ†é…äº†ä¸€ä¸ªè¿™æ ·çš„tokenï¼Œè¿™ä¸ªæ—¶å€™åšä¸€ä¸ªæ•°æ®è¿ç§»æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿä¸‹ä¸€æ¬¡å“ˆå¸Œè®¡ç®—ä¹‹åå®ƒè½åˆ°node1å’Œnode5ä¹‹é—´ï¼Œè¿™ä¸ªæ—¶å€™æ•°æ®ä¼šåˆ°node5ä¸Šï¼Œè¿™æ ·å°±å‡ºç°äº†æ•°æ®åç§»ï¼Œä½†æ˜¯å®ƒæœ‰ä¸€ä¸ªå¥½å¤„ï¼šæˆ‘æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åä¸ä¼šå½±å“node3å’Œnode4ï¼Œåªä¼šå½±å“node1ã€node2è¿™äº›æ•°æ®åç§»ï¼Œå®ƒçš„å½±å“èŒƒå›´èƒ½ç¼©å°å¾ˆå¤šï¼Œå°¤å…¶æ˜¯åœ¨æ•°æ®èŠ‚ç‚¹éå¸¸å¤šçš„æ—¶å€™ï¼Œå‡å¦‚ç¯ä¸Šæœ‰1000ä¸ªèŠ‚ç‚¹ï¼Œé‚£ç°åœ¨åœ¨1000ä¸ªèŠ‚ç‚¹ä¸­åŠ å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒå½±å“èŒƒå›´å¯èƒ½å°±åªæœ‰1000åˆ†ä¹‹1ï¼Œä¸€è‡´æ€§å“ˆå¸Œåœ¨èŠ‚ç‚¹æ¯”è¾ƒå¤šçš„æƒ…å†µå»ä½¿ç”¨ï¼Œå®ƒè¿˜æ˜¯ä¸€ç§ç¼“å­˜çš„ä½¿ç”¨æ–¹å¼ï¼Œå› ä¸ºæˆ‘åŸæ¥åœ¨node2å·²ç»å­˜çš„æ•°æ®åœ¨node5ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™å®ƒçš„è§„æ ¼å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£å®ƒåªèƒ½å»node5å»å–ï¼Œä½†node5æ²¡æœ‰å°±åªèƒ½å»æ•°æ®åº“å»å›å†™ï¼Œè™½ç„¶å®ƒä»ç„¶æ˜¯ä¸€ä¸ªç¼“å­˜çš„åœºæ™¯ï¼Œæ— æ³•å®ç°å°†node2çš„æ•°æ®è¿ç§»åˆ°node5è¿™æ˜¯å®ƒçš„ä¸€ä¸ªé—®é¢˜ï¼›</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>å®¢æˆ·ç«¯åˆ†ç‰‡ï¼šå“ˆå¸Œ+é¡ºæ—¶é’ˆï¼ˆä¼˜åŒ–å–èˆï¼‰</li><li>èŠ‚ç‚¹ä¼¸ç¼©ï¼šåªå½±å“é‚»è¿‘èŠ‚ç‚¹ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰æ•°æ®è¿ç§»</li><li>ç¿»å€ä¼¸ç¼©ï¼šç°åœ¨æˆ‘åœ¨2ä¸ªèŠ‚ç‚¹ä¹‹é—´æ·»åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒæ²¡æ³•å®ç°æ•°æ®çš„ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œå› ä¸ºå®ƒæ·»åŠ èŠ‚ç‚¹ä¹‹åï¼Œnode3å’Œnode4è¿˜æ˜¯è´Ÿè´£å¾ˆå¤šæ•°æ®ï¼Œç„¶å1å’Œ2å’Œ5æ•°æ®é‡æ¯”è¾ƒå°æ‰€ä»¥å®ƒä¼šå‡ºç°æµé‡å’Œä¸€äº›æ•°æ®ä¸å‡åŒ€çš„æƒ…å†µï¼Œå¯¹äºåˆ†å¸ƒå¼æ•°æ®åº“æ¥è¯´è¿™ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä½¿ç”¨æ–¹å¼ï¼Œæ‰€ä»¥åœ¨çœŸæ­£éœ€è¦æ‰©å®¹çš„æ—¶å€™å¯èƒ½ä¼šä½¿ç”¨ç¿»å€æ‰©å®¹çš„æ–¹å¼</li></ul><h1 id="è™šæ‹Ÿæ§½åˆ†åŒº"><a href="#è™šæ‹Ÿæ§½åˆ†åŒº" class="headerlink" title="è™šæ‹Ÿæ§½åˆ†åŒº"></a>è™šæ‹Ÿæ§½åˆ†åŒº</h1><h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><ul><li>é¢„è®¾è™šæ‹Ÿæ§½ï¼šæ¯ä¸ªæ§½æ˜ å°„ä¸€ä¸ªæ•°æ®å­é›†ï¼Œä¸€èˆ¬æ¯”èŠ‚ç‚¹æ•°å¤§ï¼Œè¿™ä¸ªæ§½ä½ å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°å­—ï¼Œç„¶åå®ƒæœ‰ä¸€å®šèŒƒå›´ï¼Œæ¯”å¦‚0åˆ°383ï¼Œè¿™ä¸ªæ˜¯<code>RedisCluster</code>çš„èŒƒå›´ï¼Œè¿™ä¸ªæ¦‚å¿µæ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œå®ƒæ¯ä¸€ä¸ªæ§½æ˜¯è´Ÿè´£å¤§æ•°æ®çš„ä¸€ä¸ªå­é›†ï¼Œå‡å¦‚è¯´ç°åœ¨æˆ‘æœ‰10Wä¸ªæ•°æ®ï¼Œ16384ä¸ªæ§½æŒ‰ç…§ä¸€å®šçš„å“ˆå¸Œçš„è§„åˆ™ï¼Œä¾‹å¦‚å¯¹æ¯ä¸€ä¸ªæ•°æ®åšä¸€ä¸ªhashï¼Œç„¶åå¯¹16383è¿›è¡Œå–ä½™ï¼Œå®ƒè½åˆ°æ§½èŒƒå›´å†…å°±è¯æ˜æ˜¯è¿™ä¸ªæ§½ç®¡ç†çš„æ•°æ®ï¼Œä¸‹é¢é€šè¿‡å›¾è¿›è¡Œè¯´æ˜</li><li>è‰¯å¥½çš„å“ˆå¸Œå‡½æ•°ï¼šä¾‹å¦‚CRC16</li><li>æœåŠ¡ç«¯ç®¡ç†èŠ‚ç‚¹ã€æ§½ã€æ•°æ®ï¼šä¾‹å¦‚Redis Cluster</li></ul><h2 id="è™šæ‹Ÿæ§½åˆ†é…"><a href="#è™šæ‹Ÿæ§½åˆ†é…" class="headerlink" title="è™šæ‹Ÿæ§½åˆ†é…"></a>è™šæ‹Ÿæ§½åˆ†é…</h2><p>Redis Clusteræ¨¡å‹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572006846336.png" srcset="/img/loading.gif" alt="1572006846336"></p><p>ç°åœ¨æœ‰5ä¸ªèŠ‚ç‚¹ï¼Œå¯¹æ§½è¿›è¡Œå¹³å‡åˆ†æˆ5ä»½ï¼Œä¾‹å¦‚0åˆ°3276æ˜¯å½’èŠ‚ç‚¹1ç®¡ç†ï¼Œ13108åˆ°16383æ˜¯åˆ°èŠ‚ç‚¹5å»ç®¡ç†ï¼Œå¯¹äºæ¯ä¸ªkeyæ¥å°†ï¼Œæˆ‘ä»¬å¯¹å®ƒåšä¸€ä¸ªå“ˆå¸Œï¼Œåœ¨Redis Clusteré‡Œé¢å°±æ˜¯ä¸€ä¸ªCRC16ç»™å®ƒåšä¸€ä¸ªå“ˆå¸Œï¼Œç„¶åå¯¹16383å»å–ä½™ï¼Œç„¶åå®ƒä¼šå‘é€ç»™Redis Clusterä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå®ƒæ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šè®°å½•è‡ªå·±æ˜¯ä¸æ˜¯è´Ÿè´£è¿™ä¸ªæ§½çš„ï¼Œå‡å¦‚æ˜¯ç®—å‡ºè¿™ä¸ªå€¼æ˜¯100ï¼Œæˆ‘ä»¬å‘é€ç»™èŠ‚ç‚¹1ï¼ŒèŠ‚ç‚¹1å‘ç°å®ƒæ˜¯åœ¨è‡ªå·±è´Ÿè´£çš„æ§½çš„èŒƒå›´å†…ï¼Œå®ƒå»æŠŠå®ƒè¿›è¡Œä¿å­˜ç»™å®ƒè¿”å›ä¸€ä¸ªç»“æœï¼Œå¦‚æœå®ƒå‘ç°ä¸åœ¨è‡ªå·±æ§½è®¿é—®å†…ï¼šç”±äºRedis ClusterèŠ‚ç‚¹ä¹‹é—´æ˜¯ä¸€ä¸ªå…±äº«æ¶ˆæ¯çš„æ¨¡å¼ï¼Œæˆ‘èŠ‚ç‚¹1çŸ¥é“å‰©ä½™çš„èŠ‚ç‚¹è´Ÿè´£å“ªäº›æ§½ï¼Œè¿™æ ·çš„è¯è¿”å›çš„ç»“æœä¼šå‘Šè¯‰ä½ å»å…¶ä»–èŠ‚ç‚¹å»å–ï¼Œå…·ä½“æ˜¯å“ªä¸ªèŠ‚ç‚¹æˆ‘ä¹Ÿå‘Šè¯‰ä½ äº†ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæœåŠ¡ç«¯å»ç®¡ç†æ•°æ®å’Œæ§½è¿˜æœ‰èŠ‚ç‚¹å…³ç³»çš„ä¸€ç§æ¨¡å¼ï¼Œä¸€è‡´æ€§å“ˆå¸Œåˆ†å¸ƒã€å–ä½™å“ˆå¸Œåˆ†å¸ƒéƒ½æœ‰ä¸€ä¸ªé—®é¢˜ï¼šæˆ‘æ·»åŠ æ–°çš„èŠ‚ç‚¹ä¹‹åæ•°æ®ä¼šè¿›è¡Œè¿ç§»ï¼Œä¼šå­˜åœ¨ä¸¢æ•°æ®çš„å¯èƒ½æ€§ï¼Œæ‰€ä»¥å®ƒåªèƒ½ä½œä¸ºç¼“å­˜åœºæ™¯ä½¿ç”¨ï¼Œä½¿ç”¨è™šæ‹Ÿæ§½å°±ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£çš„æ§½èŒƒå›´æ˜¯å›ºå®šçš„ï¼Œä½ åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹ä¹Ÿæ²¡æœ‰æŠŠå…¶ä»–èŠ‚ç‚¹çš„æ§½æŠ¢èµ°ï¼Œå¿…é¡»æ˜¯æˆ‘è¿™ä¸ªèŠ‚ç‚¹æŠŠæˆ‘è¿™ä¸ªæ§½æƒåˆ©å»åˆ†é…ç»™ä½ ï¼ŒæŠŠæ•°æ®æ ¹æ®æ§½åˆ†é…ç»™ä½ ï¼Œè¿™æ ·çš„è¯å°±ä¸ä¼šæœ‰ä¸¢æ•°æ®çš„è¿™æ ·çš„é—®é¢˜ï¼›</p><h1 id="åŸºæœ¬æ¶æ„"><a href="#åŸºæœ¬æ¶æ„" class="headerlink" title="åŸºæœ¬æ¶æ„"></a>åŸºæœ¬æ¶æ„</h1><p>æœåŠ¡ç«¯æ˜¯å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å»è¯»ä¹Ÿè´Ÿè´£å»å†™ï¼Œè€Œä¸”èŠ‚ç‚¹ä¹‹é—´æ˜¯å½¼æ­¤é€šä¿¡çš„ï¼Œå®ƒä»¬å½¼æ­¤ä¹‹é—´çŸ¥é“å½¼æ­¤è´Ÿè´£çš„æ§½ï¼Œç„¶åæŠŠ16384è¿›è¡Œå¹³å‡ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€éƒ¨åˆ†æ§½ï¼Œå®¢æˆ·ç«¯å»è®¿é—®ä»»æ„èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå¦‚æœå®ƒå»è®¿é—®çš„keyåœ¨å¯¹åº”çš„èŠ‚ç‚¹ä¸Šå°±ç»™å®ƒç›´æ¥è¿”å›ï¼Œå¦‚æœä¸åœ¨å¯¹åº”çš„èŠ‚ç‚¹å°±å‘Šè¯‰å®ƒå»å…¶ä»–èŠ‚ç‚¹å»æ‰¾ï¼Œä½†æ˜¯å®ƒä¸ä¼šä¸ºä½ åšè·³è½¬ï¼Œå®ƒä¼šè¿”å›ç»™ä½ å¯¹åº”ç›®æ ‡èŠ‚ç‚¹çš„ç»“æœï¼Œç„¶åä½ å»åšå¯¹åº”çš„è·³è½¬ï¼Œå½“ç„¶è¿™ç§æ–¹å¼æ˜¯æœ‰é—®é¢˜çš„ï¼šå®ƒçš„æ€§èƒ½ä¸å¤Ÿé«˜ï¼Œè€Œä¸”å½“èŠ‚ç‚¹éå¸¸å¤šçš„æ—¶å€™ï¼Œå‘½ä¸­ç‡ä¸ä¼šå¾ˆé«˜ï¼›æ‰€ä»¥è¿™ç§æƒ…å†µè¦ä½¿ç”¨æ™ºèƒ½å®¢æˆ·ç«¯ï¼Œç”¨å®ƒå»çŸ¥é“æ‰€æœ‰èŠ‚ç‚¹ï¼Œå®¢æˆ·ç«¯ä¹ŸçŸ¥é“æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å“ªäº›æ§½ï¼Œè€Œä¸”è¿™ä¸ªæ§½å’ŒèŠ‚ç‚¹çš„å…³ç³»å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¹Ÿä¼šçŸ¥é“ï¼Œè¿™æ˜¯ä¸€ç§é«˜æ•ˆçš„æ–¹å¼ï¼Œè¿™ä¸ªåœ¨ä»‹ç»å®¢æˆ·ç«¯çš„æ—¶å€™ä¼šå»è¯´æ˜ï¼Œè¿™é‡Œå°±è®°ä½å‡ ç‚¹ï¼š</p><ul><li>åœ¨Redis Clusteråˆ†å¸ƒå¼æƒ…å†µä¸‹æ˜¯äº’ç›¸é€šä¿¡çš„ï¼›</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šè´Ÿè´£è¯»å†™ï¼Œå› ä¸ºæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æ•°æ®é›†çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ˜¯åˆ†å¸ƒå¼çš„ç‰¹æ€§ï¼›</li></ul><p><strong>Redis Clusteræ¶æ„</strong></p><ul><li>Redis Clusterä¼šæœ‰ä¸€å †èŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£å»è¯»å†™ï¼›</li><li>å®ƒæœ‰ä¸€ä¸ªmeetæ“ä½œï¼ŒèŠ‚ç‚¹ä¹‹é—´æ˜¯è¿›è¡Œç›¸å…³é€šä¿¡çš„ï¼Œmeetæ“ä½œå°±æ˜¯å®Œæˆè¿™ä¸ªè¿‡ç¨‹çš„åŸºç¡€ï¼›</li><li>æŒ‡æ´¾æ§½ï¼šæ¯ä¸ªèŠ‚ç‚¹æŒ‡æ´¾äº†å¯¹åº”çš„æ§½å®ƒæ‰å¯ä»¥å»è¿›è¡Œæ­£å¸¸çš„è¯»å†™ï¼Œä½ ç°åœ¨å»å¯åŠ¨èŠ‚ç‚¹ï¼Œç„¶åå®ƒæŒ‡å®šä¸€ä¸ªClusteræ¨¡å¼ï¼Œè¿™ä¸ªåé¢å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¸ä¼šæ­£å¸¸è¯»å†™ï¼Œä½ è¦ä¸ºå®ƒæŒ‡æ´¾æ§½ï¼Œå½“æ•°æ®è®¿é—®è¿‡æ¥çš„æ—¶å€™å®ƒå»çœ‹è¿™ä¸ªkeyæ˜¯ä¸æ˜¯åœ¨è‡ªå·±æ§½èŒƒå›´å†…ï¼›</li><li>å®ƒä¸ºäº†ä¿è¯é«˜å¯ç”¨ï¼Œå®ƒä¹Ÿæä¾›äº†å¤åˆ¶ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œä½†æ˜¯å®ƒæœ‰å¾ˆå¤šä¸»èŠ‚ç‚¹ï¼Œå½“ä¸»èŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œå®ƒé€šè¿‡æŸç§å½¢å¼ä¹Ÿå¯ä»¥å®ç°ä¸»å¤‡é«˜å¯ç”¨ï¼Œä¸»èŠ‚ç‚¹æŒ‚äº† ï¼Œä»èŠ‚ç‚¹ä¼šé¡¶ä¸Šæ¥ï¼Œå®ƒå†…éƒ¨ç›‘æ§æ˜¯æ²¡æœ‰ä¾èµ–ä¸Sentinelï¼Œè€Œæ˜¯é€šè¿‡èŠ‚ç‚¹ä¹‹é—´çš„ç›¸äº’ç›‘æ§æ¥å®Œæˆçš„ï¼›</li></ul><p><strong>å®‰è£…</strong></p><ul><li><p>å¯¹äºèŠ‚ç‚¹æ¥è¯´å®ƒäºæ™®é€šRedisèŠ‚ç‚¹çš„åŒºåˆ«å°±æ˜¯å®ƒæœ‰ä¸€ä¸ª<code>cluster-enabled</code>å®ƒæ˜¯å¦æ˜¯é›†ç¾¤æ¨¡å¼ï¼Œå¦‚æœæ˜¯yeså°±ä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨</p></li><li><p><code>meet</code>ï¼šå‡å¦‚è¯´ç°åœ¨æœ‰3ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹Aå¯¹èŠ‚ç‚¹Bå‘é€äº†meetæ“ä½œï¼Œå®ƒä¼šè¿”å›<code>PONG</code>è¯´æ˜Aå’ŒBå·²ç»å¯ä»¥è¿›è¡Œæ¶ˆæ¯äº¤æµäº†ï¼Œç„¶åå½“Aå‘é€ç»™Cmeetçš„æ—¶å€™å®ƒä¹Ÿè¿”å›å¯¹åº”çš„ç»“æœï¼Œè¿™ä¸ªæ—¶å€™Aå’ŒCæ ¹æ®æŸç§åè®®é€šè¿‡Bå¯¹Açš„äº†è§£ï¼ŒBå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„Cï¼Œè¿™æ ·å°±å®Œæˆäº†ç›¸äº’é€šä¿¡<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572008784267.png" srcset="/img/loading.gif" alt="1572008784267" style="zoom:25%;" /></p></li><li><p>æŒ‡æ´¾æ§½ï¼šç°åœ¨æœ‰3ä¸ªä¸»èŠ‚ç‚¹ï¼Œä½†æ˜¯æœ‰16384ä¸ªæ§½ï¼Œ16384æ˜¯<code>Redis Cluster</code>æŒ‡å®šæ§½çš„æ•°é‡ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ºäº†è¾¾åˆ°è´Ÿè´£å‡è¡¡çš„æ•ˆæœï¼Œä¼šç»™æ¯ä¸ªèŠ‚ç‚¹æŒ‡æ´¾æŒ‡å®šçš„æ§½ï¼Œä¾‹å¦‚ç»™AèŠ‚ç‚¹æŒ‡æ´¾0åˆ°5460ï¼ŒBï¼š5461åˆ°10922ï¼ŒCï¼š10923åˆ°16383ï¼Œå½“æˆ‘ä»¬ä¸€ä¸ªkeyè®¿é—®è¿‡æ¥æ—¶å€™ä¼šè®¡ç®—å®ƒçš„å“ˆå¸Œå€¼ï¼Œç„¶åå¯¹16383å»å–ä¸€ä¸ªä½™æ•°ï¼Œçœ‹å®ƒæ˜¯å¦åœ¨å¯¹åº”ä¸€ä¸ªæ§½çš„èŒƒå›´å†…ï¼Œå¦‚æœåœ¨å°±è¿”å›ç»“æœï¼Œå¦‚æœä¸åœ¨è¿”å›å¯¹åº”çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› ä¸ºå®ƒä»¬ç›´æ¥å½¼æ­¤çŸ¥é“å“ªäº›æ§½æ˜¯åœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´å®¢æˆ·ç«¯åªéœ€è¦è®¡ç®—ä¸€ä¸ªkeyç®—å‡ºå¯¹åº”çš„slot</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1572009121295.png" srcset="/img/loading.gif" alt="1572009121295"></p><p><strong>RedisClusterç‰¹æ€§</strong></p><p>å®ƒæœ‰ä¸»ä»å¤åˆ¶ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹éƒ½æœ‰ä»èŠ‚ç‚¹ï¼Œè€Œä¸”ä»–æ˜¯é«˜å¯ç”¨çš„ï¼Œå“ªä¸ªä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œä»èŠ‚ç‚¹éƒ½èƒ½å®Œæˆä¸€ä¸ªæ™‹å‡ï¼Œè€Œä¸”å®ƒæ˜¯åˆ†ç‰‡çš„ï¼šå¤šä¸ªä¸»èŠ‚ç‚¹è¿›è¡Œä¸€ä¸ªè¯»å†™</p></li></ul><h1 id="åŸç”Ÿå®‰è£…"><a href="#åŸç”Ÿå®‰è£…" class="headerlink" title="åŸç”Ÿå®‰è£…"></a>åŸç”Ÿå®‰è£…</h1><h2 id="ä»‹ç»-1"><a href="#ä»‹ç»-1" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><h3 id="ä¸¤ç§å®‰è£…"><a href="#ä¸¤ç§å®‰è£…" class="headerlink" title="ä¸¤ç§å®‰è£…"></a>ä¸¤ç§å®‰è£…</h3><ul><li>åŸç”Ÿå‘½ä»¤å®‰è£…</li></ul><blockquote><p>é€šè¿‡RedisClusteråè®®ï¼Œé€šè¿‡Redis-Cliä»èŠ‚ç‚¹å¯åŠ¨ã€meetã€åˆ†é…æ§½ä»¥åŠã€åˆ†é…ä¸»ä»å…³ç³»æ¥å®ç°å®Œæ•´çš„å®‰è£…è¿‡ç¨‹</p></blockquote><ul><li>å®˜æ–¹å·¥å…·å®‰è£…</li></ul><blockquote><p>ä½¿ç”¨Redisæä¾›çš„rubyå·¥å…·ï¼Œå®ƒå¯ä»¥çœå»ä¸Šé¢çš„è¿‡ç¨‹ï¼Œä½ åªéœ€è¦ç®€å•çš„é…ç½®å°±èƒ½ä¸€é”®å®‰è£…</p></blockquote><h3 id="ç†è§£æ¶æ„"><a href="#ç†è§£æ¶æ„" class="headerlink" title="ç†è§£æ¶æ„"></a>ç†è§£æ¶æ„</h3><blockquote><p>é€šè¿‡ä¸€æ­¥ä¸€æ­¥æ‰‹åŠ¨å»å®‰è£…å¯ä»¥å……åˆ†ç†è§£RedisClusteråŸºæœ¬æ¶æ„ï¼Œ</p></blockquote><ol><li>é…ç½®å¼€å¯èŠ‚ç‚¹ï¼šè¿™å’Œæ™®é€šå¯åŠ¨æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œå®ƒåªæ˜¯åŠ äº†ä¸€äº›clusterçš„ä¸€äº›é…ç½®</li><li>meetï¼šå®ç°èŠ‚ç‚¹ä¹‹é—´çš„ç›¸äº’é€šä¿¡</li><li>æŒ‡æ´¾æ§½ï¼šåªæœ‰æŒ‡æ´¾æ§½ä¹‹åæ‰èƒ½å®ç°å®¢æˆ·ç«¯æ•°æ®çš„è®¿é—®</li><li>ä¸»ä»ï¼šæœ‰äº†ä¸»ä»å…³ç³»å°±èƒ½å®ç°æ•…éšœè‡ªåŠ¨è½¬ç§»</li></ol><h3 id="é…ç½®å¼€å¯Redis"><a href="#é…ç½®å¼€å¯Redis" class="headerlink" title="é…ç½®å¼€å¯Redis"></a>é…ç½®å¼€å¯Redis</h3><h4 id="redis-conf"><a href="#redis-conf" class="headerlink" title="redis.conf"></a>redis.conf</h4><pre><code class="hljs nginx"><span class="hljs-attribute">port</span> <span class="hljs-variable">$port</span>]daemonize <span class="hljs-literal">yes</span>dir<span class="hljs-string">"/opt/redis/redis/data/</span><span class="hljs-string">dbfilename dump-S&#123;port&#125;. rdb</span><span class="hljs-string">logfile "</span><span class="hljs-variable">$&#123;port&#125;</span>.log<span class="hljs-string">"</span><span class="hljs-string">cluster-enabled yes#å½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªclusterèŠ‚ç‚¹</span><span class="hljs-string">cluster-config-file nodes-<span class="hljs-variable">$&#123;port&#125;</span>.conf #ä¸ºclusterèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªè‡ªå·±çš„é…ç½®æ–‡ä»¶</span></code></pre><h4 id="å¼€å¯èŠ‚ç‚¹"><a href="#å¼€å¯èŠ‚ç‚¹" class="headerlink" title="å¼€å¯èŠ‚ç‚¹"></a>å¼€å¯èŠ‚ç‚¹</h4><pre><code class="hljs bash">redis-server redis-7000.confredis-server redis-7001.confredis-server redis-7002.confredis-server redis-7003.confredis-server redis-7004.confredis-server redis-7005.conf</code></pre><h4 id="meet"><a href="#meet" class="headerlink" title="meet"></a>meet</h4><p> <strong>è¯­æ³•</strong></p><pre><code class="hljs bash">cluster meet ip port</code></pre><p> <strong>ä¾‹å­</strong></p><pre><code class="hljs bash">redis-cli -h 127.0.0.1 -p 7000 cluster meet 120.0.0.1 7001redis-cli -h 127.0.0.1 -p 7000 cluster meet 120.0.0.1 7002redis-cli -h 127.0.0.1 -p 7000 cluster meet 120.0.0.1 7003redis-cli -h 127.0.0.1 -p 7000 cluster meet 120.0.0.1 7004redis-cli -h 127.0.0.1 -p 7000 cluster meet 120.0.0.1 7005</code></pre><h4 id="ClusterèŠ‚ç‚¹ä¸»è¦é…ç½®"><a href="#ClusterèŠ‚ç‚¹ä¸»è¦é…ç½®" class="headerlink" title="ClusterèŠ‚ç‚¹ä¸»è¦é…ç½®"></a>ClusterèŠ‚ç‚¹ä¸»è¦é…ç½®</h4><pre><code class="hljs nginx"> <span class="hljs-comment">#ä»£è¡¨å½“å‰èŠ‚ç‚¹æ˜¯ä¸€ä¸ªclusterèŠ‚ç‚¹</span>clustetr-enabled yes<span class="hljs-comment">#å•ä½æ¯«ç§’ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªæ•…éšœè½¬ç§»çš„æ—¶é—´æˆ–è€…èŠ‚ç‚¹è¶…æ—¶æ—¶é—´ï¼Œè¿™é‡Œä¸å¤ªå¥½è¯´ï¼Œåœ¨Redisæºä»£ç ä¸­æ˜¯æœ‰å¾ˆå¤šä½œç”¨çš„ï¼Œä¾‹å¦‚å®ƒæ˜¯ä¸€ä¸ªä¸»è§‚ä¸‹çº¿çš„è¶…æ—¶æ—¶é—´ä»¥åŠä»–æ˜¯ä¸€ä¸ªpingçš„æœ€é•¿ä¸èƒ½å®¹å¿æ—¶é—´çš„2åˆ†ä¹‹1ï¼Œä¸€èˆ¬æ¥è¯´ä½¿ç”¨é»˜è®¤é…ç½®</span>cluster-node-timeout 15000 <span class="hljs-comment">#é›†ç¾¤èŠ‚ç‚¹é…ç½®ï¼Œè¿™é‡Œæ³¨æ„å•æœºå¤šéƒ¨ç½²ï¼Œæœ¬æ¬¡æ¼”ç¤ºä¹Ÿæ˜¯ä¸€ä¸ªå•æœºå¤šéƒ¨ç½²æƒ…å†µä¸‹ï¼Œéƒ½æ˜¯ç”¨ç«¯å£è¿›è¡ŒåŒºåˆ†çš„</span>cluster-config-file "nodes.conf"<span class="hljs-comment">#æ˜¯å¦éœ€è¦å¯¹é›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹æä¾›æœåŠ¡ï¼Œæ‰èƒ½è®¤ä¸ºèŠ‚ç‚¹æ˜¯æ­£ç¡®çš„ã€‚å‡å¦‚æˆ‘é›†ç¾¤ä¸­ä¸€ä¸ªèŠ‚ç‚¹æŒ‚äº†ï¼Œé‚£æˆ‘å¯¹å¤–å°±ä¸æä¾›æœåŠ¡äº†ï¼Œè¿™ä¸ªé»˜è®¤æ˜¯yesï¼Œåœ¨å®é™…ç”Ÿäº§ä¸­è¿™ä¸ªé…ç½®æ˜¯ä¸åˆç†çš„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¼šé…ç½®æˆnoã€‚</span>cluster-require-full-coverage yes</code></pre><h4 id="åˆ†é…å‡‘"><a href="#åˆ†é…å‡‘" class="headerlink" title="åˆ†é…å‡‘"></a>åˆ†é…å‡‘</h4><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash">cluster addslots slot [slot...]</code></pre><p><strong>ä¾‹å­</strong></p><pre><code class="hljs bash">redis-cli -h 127.0.0.1 -p 7000 clusuter addslot &#123;0...5461&#125;redis-cli -h 127.0.0.1 -p 7001 clusuter addslot &#123;5462...10922&#125;redis-cli -h 127.0.0.1 -p 7002 clusuter addslot &#123;10923...16383&#125;</code></pre><h4 id="è®¾ç½®ä¸»ä»"><a href="#è®¾ç½®ä¸»ä»" class="headerlink" title="è®¾ç½®ä¸»ä»"></a>è®¾ç½®ä¸»ä»</h4><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash">cluster replicate node-id <span class="hljs-comment">#é›†ç¾¤èŠ‚ç‚¹çš„id,å®ƒåœ¨ä½ é›†ç¾¤èŠ‚ç‚¹å¯åŠ¨çš„æ—¶å€™å°±ä¼šè¿›è¡Œåˆ†é…ï¼Œè¿™é‡Œçš„node-idå’Œrunidæ˜¯ä¸åŒçš„ï¼Œå› ä¸ºrunidä¼šéšç€é‡å¯è¿›è¡Œé‡ç½®ï¼Œè€Œnode-idä¸ä¼šè¢«é‡ç½®</span></code></pre><p><strong>ä¾‹å­</strong></p><pre><code class="hljs bash">redis-cli -h 127.0.0.1 -p 7003 cluster replicate <span class="hljs-variable">$&#123;node-id-7000&#125;</span>redis-cli -h 127.0.0.1 -p 7004 cluster replicate <span class="hljs-variable">$&#123;node-id-7001&#125;</span>redis-cli -h 127.0.0.1 -p 7005 cluster replicate <span class="hljs-variable">$&#123;node-id-7002&#125;</span></code></pre><blockquote><p>è¿™é‡Œçš„node-idæ˜¯å¦‚ä½•è·å–çš„åœ¨åç»­çš„æ¼”ç¤ºä¸­è¿›è¡Œä»‹ç»</p></blockquote><h2 id="å…·ä½“å®‰è£…"><a href="#å…·ä½“å®‰è£…" class="headerlink" title="å…·ä½“å®‰è£…"></a>å…·ä½“å®‰è£…</h2><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><pre><code class="hljs bash">vim redis-7000.conf</code></pre><p>redis-7000.conf</p><pre><code class="hljs nginx"><span class="hljs-attribute">port</span> <span class="hljs-number">7000</span>daemonize <span class="hljs-literal">yes</span>dir <span class="hljs-string">"/usr/src/redis/data"</span>logfile <span class="hljs-string">"7000.log"</span>dbfilename <span class="hljs-string">"dump-7000.rdb"</span>cluster-enabled <span class="hljs-literal">yes</span>cluster-config-file nodes-<span class="hljs-number">7000</span>.confcluster-require-full-coverage <span class="hljs-literal">no</span></code></pre><p>å…¶ä»–èŠ‚ç‚¹</p><pre><code class="hljs bash">sed <span class="hljs-string">"s/7000/7002/g"</span> redis-7000.conf &gt; redis-7002.confsed <span class="hljs-string">"s/7000/7003/g"</span> redis-7000.conf &gt; redis-7003.confsed <span class="hljs-string">"s/7000/7004/g"</span> redis-7000.conf &gt; redis-7004.confsed <span class="hljs-string">"s/7000/7005/g"</span> redis-7000.conf &gt; redis-7005.conf</code></pre><p>å¯åŠ¨</p><pre><code class="hljs bash">[root@mcr2 config] redis-server  redis-7000.conf[root@mcr2 config] redis-server  redis-7001.conf[root@mcr2 config] redis-server  redis-7002.conf[root@mcr2 config] redis-server  redis-7003.conf[root@mcr2 config] redis-server  redis-7004.conf[root@mcr2 config] redis-server  redis-7005.conf[root@mcr2 config] ps -ef | grep redisroot      10200      1  0 12:04 ?        00:00:00 redis-server *:7000 [cluster]root      10215      1  0 12:05 ?        00:00:00 redis-server *:7001 [cluster]root      10220      1  0 12:05 ?        00:00:00 redis-server *:7002 [cluster]root      10224      1  0 12:05 ?        00:00:00 redis-server *:7003 [cluster]root      10228      1  0 12:05 ?        00:00:00 redis-server *:7004 [cluster]root      10232      1  0 12:05 ?        00:00:00 redis-server *:7005 [cluster]root      10236   9913  0 12:05 pts/1    00:00:00 grep --color=auto redis</code></pre><p>ç°åœ¨è¿æ¥7000ç«¯å£çš„èŠ‚ç‚¹å†™å…¥ä¸€æ¡æ•°æ®ä¼šå‡ºé”™</p><pre><code class="hljs bash">[root@mcr2 config]<span class="hljs-comment"># redis-cli -p 7000</span>127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> k1 v1(error) CLUSTERDOWN The cluster is down</code></pre><blockquote><p>è¿™æ˜¯è¯´ä½ è¿˜æ²¡æœ‰åˆ†é…æ§½ï¼Œæ‰€ä»¥æ— æ³•å†™å…¥æ•°æ®</p></blockquote><p>dataæ–‡ä»¶ä¸­æŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ï¼š</p><pre><code class="hljs bash">[root@mcr2 data] ll<span class="hljs-comment"># xx.log...</span>-rw-r--r-- 1 root root     112 10æœˆ 26 12:04 nodes-7000.conf-rw-r--r-- 1 root root     112 10æœˆ 26 12:05 nodes-7001.conf-rw-r--r-- 1 root root     112 10æœˆ 26 12:05 nodes-7002.conf-rw-r--r-- 1 root root     112 10æœˆ 26 12:05 nodes-7003.conf-rw-r--r-- 1 root root     112 10æœˆ 26 12:05 nodes-7004.conf-rw-r--r-- 1 root root     112 10æœˆ 26 12:05 nodes-7005.conf[root@mcr2 data] cat nodes-7001.confb8706be32b3021222237479148acfbdeb9af9e55 :0 myself,master - 0 0 0 connectedvars currentEpoch 0 lastVoteEpoch 0</code></pre><blockquote><p>è¿™é‡Œçš„<code>b8706be32b3021222237479148acfbdeb9af9e55</code>æ˜¯nodeidï¼Œå®ƒçš„è§’è‰²æ˜¯<code>master</code>ï¼Œmyselfè¡¨ç¤ºè‡ªå·±ï¼Œå‡å¦‚å½“å‰å‡å¦‚äº†åæœŸèŠ‚ç‚¹çš„æ—¶å€™å®ƒå°±ä¼šæœ‰ä¸€äº›å…¶ä»–èŠ‚ç‚¹å¯ä»¥çœ‹åˆ°</p></blockquote><p>ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤å»æŸ¥çœ‹</p><pre><code class="hljs bash">[root@mcr2 data] redis-cli -p 7000 cluster nodes7486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 :7000 myself,master - 0 0 0 connected</code></pre><p>é›†ç¾¤ä¿¡æ¯</p><pre><code class="hljs bash">[root@mcr2 data]<span class="hljs-comment"># redis-cli -p 7000 cluster info</span>cluster_state:fail<span class="hljs-comment">#é›†ç¾¤çŠ¶æ€ï¼šfailå¤±è´¥</span>cluster_slots_assigned:0<span class="hljs-comment">#é›†ç¾¤åˆ†é…çš„æ§½</span>cluster_slots_ok:0<span class="hljs-comment">#é›†é…æˆåŠŸçš„æ§½</span>cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:1cluster_size:0cluster_current_epoch:0cluster_my_epoch:0cluster_stats_messages_sent:0cluster_stats_messages_received:0</code></pre><h3 id="meet-1"><a href="#meet-1" class="headerlink" title="meet"></a>meet</h3><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p  7000 cluster meet 127.0.0.1 7001OK[root@mcr2 config] redis-cli -p  7000 cluster meet 127.0.0.1 7002OK[root@mcr2 config] redis-cli -p  7000 cluster meet 127.0.0.1 7003OK[root@mcr2 config] redis-cli -p  7000 cluster meet 127.0.0.1 7004OK[root@mcr2 config] redis-cli -p  7000 cluster meet 127.0.0.1 7005OK</code></pre><p>meetå®Œä¹‹åæŸ¥çœ‹èŠ‚ç‚¹</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster nodesea47d9f8edeb000478512389731ca9132a69713d 127.0.0.1:7004 master - 0 1572078449112                                                                 3 connected16d4832afd3a8acdb4435e1be4acc733ec6377dd 127.0.0.1:7003 master - 0 1572078449614                                                                 5 connectedb8706be32b3021222237479148acfbdeb9af9e55 127.0.0.1:7001 master - 0 1572078450118                                                                 2 connected7486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 127.0.0.1:7000 myself,master - 0 0 1 co                                                                nnected67dcb98c8e4d12dc0f7a523b744566610821d8f2 127.0.0.1:7005 master - 0 1572078451125                                                                 4 connectedfc9247fe63eeb84196cc2fd0fe936627e1ed767a 127.0.0.1:7002 master - 0 1572078452132                                                                 0 connected</code></pre><h2 id="åˆ†é…æ§½"><a href="#åˆ†é…æ§½" class="headerlink" title="åˆ†é…æ§½"></a>åˆ†é…æ§½</h2><p>ç°åœ¨æ²¡åˆ†é…æ§½çš„æ—¶å€™æ˜¯ä¸èƒ½è¿›è¡Œè¯»å†™çš„</p><pre><code class="hljs bash">[root@mcr2 config]  redis-cli -p 7000127.0.0.1:7000&gt; <span class="hljs-built_in">set</span> k1 v1(error) CLUSTERDOWN The cluster is down</code></pre><p>è¿™é‡Œä¸€ä¸ªä¸ªè®¾ç½®å¾ˆéº»çƒ¦ï¼Œè¿™é‡Œå†™ä¸€ä¸ªè„šæœ¬</p><pre><code class="hljs bash">[root@mcr2 script] vim addslots.shstart=<span class="hljs-variable">$1</span>end=<span class="hljs-variable">$2</span>port=<span class="hljs-variable">$3</span><span class="hljs-keyword">for</span> slot <span class="hljs-keyword">in</span> `seq <span class="hljs-variable">$&#123;start&#125;</span> <span class="hljs-variable">$&#123;end&#125;</span>`<span class="hljs-keyword">do</span>        <span class="hljs-built_in">echo</span> <span class="hljs-string">"slot:<span class="hljs-variable">$&#123;slot&#125;</span>"</span>        redis-cli -p <span class="hljs-variable">$&#123;port&#125;</span> cluster addslots <span class="hljs-variable">$&#123;slot&#125;</span><span class="hljs-keyword">done</span></code></pre><p>æ‰§è¡Œè„šæœ¬</p><pre><code class="hljs bash">[root@mcr2 script] sh addslots.sh  0 5461 7000</code></pre><p>æŸ¥çœ‹ä¿¡æ¯</p><pre><code class="hljs bash">[root@mcr2 script] redis-cli -p 7000127.0.0.1:7000&gt; cluster infocluster_state:okcluster_slots_assigned:5462cluster_slots_ok:5462<span class="hljs-comment"># 5462ä¸ªæ§½</span>cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:6cluster_size:1cluster_current_epoch:5cluster_my_epoch:1cluster_stats_messages_sent:2277cluster_stats_messages_received:2277127.0.0.1:7000&gt; CLUSTER NODES....<span class="hljs-comment">#  nnected 0-5461 æ§½ä¿¡æ¯</span>7486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 127.0.0.1:7000 myself,master - 0 0 1 co                                                                nnected 0-5461</code></pre><p>å…¶ä»–èŠ‚ç‚¹åˆ†æ§½</p><pre><code class="hljs bash">[root@mcr2 script] sh addslots.sh  5462 10922 7001[root@mcr2 script] sh addslots.sh  10923 16383 7002</code></pre><p>ç°åœ¨æŸ¥çœ‹clusterä¿¡æ¯</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster infocluster_state:okcluster_slots_assigned:16384cluster_slots_ok:16384cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:6cluster_size:3cluster_current_epoch:5cluster_my_epoch:1cluster_stats_messages_sent:3114cluster_stats_messages_received:3114</code></pre><blockquote><p>è¿™é‡Œé›†ç¾¤çŠ¶æ€æ˜¯okçš„ï¼Œå…¶ä»–èŠ‚ç‚¹ç•™ç€åšä»èŠ‚ç‚¹</p></blockquote><h2 id="ä¸»ä»åˆ†é…"><a href="#ä¸»ä»åˆ†é…" class="headerlink" title="ä¸»ä»åˆ†é…"></a>ä¸»ä»åˆ†é…</h2><p>å‰é¢ä»‹ç»è¿‡ï¼Œæƒ³è¦ä¸€ä¸ªèŠ‚ç‚¹å˜æˆä¸€ä¸ªèŠ‚ç‚¹çš„ä»èŠ‚ç‚¹è¦é€šè¿‡<code>cluster replicate +node-id</code>ï¼Œè¿™é‡ŒæŸ¥çœ‹é›†ç¾¤ä¸­çš„node-id</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster nodesea47d9f8edeb000478512389731ca9132a69713d 127.0.0.1:7004 master - 0 1572079922359 3 connected16d4832afd3a8acdb4435e1be4acc733ec6377dd 127.0.0.1:7003 master - 0 1572079920347 5 connectedb8706be32b3021222237479148acfbdeb9af9e55 127.0.0.1:7001 master - 0 1572079923367 2 connected 5462-109227486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 127.0.0.1:7000 myself,master - 0 0 1 connected 0-546167dcb98c8e4d12dc0f7a523b744566610821d8f2 127.0.0.1:7005 master - 0 1572079921353 4 connectedfc9247fe63eeb84196cc2fd0fe936627e1ed767a 127.0.0.1:7002 master - 0 1572079924374 0 connected 10923-16383</code></pre><p>7003ç«¯å£çš„èŠ‚ç‚¹åš7000ç«¯å£èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7003 cluster replicate 7486b5c98c7c644bdcc992ec8a0b0a9d711c5a49OK</code></pre><p>è¿™é‡Œå†æ¬¡ä½¿ç”¨<code>cluster nodes</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå®ƒæ˜¯ä¸€ä¸ªslaveèŠ‚ç‚¹</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster nodes16d4832afd3a8acdb4435e1be4acc733ec6377dd 127.0.0.1:7003 slave 7486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 0 1572080237607 5 connected</code></pre><p>7004ç«¯å£å¤åˆ¶7001</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7004 cluster replicate b8706be32b3021222237479148acfbdeb9af9e55OK</code></pre><p>7005å¤åˆ¶7002</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7005 cluster replicate fc9247fe63eeb84196cc2fd0fe936627e1ed767aOK</code></pre><p>ç°åœ¨ä¸€ä¸ª3ä¸»3ä»çš„é›†ç¾¤å°±æ­å»ºå®Œæˆäº†</p><pre><code class="hljs bash">[root@mcr2 config]<span class="hljs-comment"># redis-cli -p 7000 cluster nodes</span>ea47d9f8edeb000478512389731ca9132a69713d 127.0.0.1:7004 slave b8706be32b30212222                                                                37479148acfbdeb9af9e55 0 1572080526708 3 connected16d4832afd3a8acdb4435e1be4acc733ec6377dd 127.0.0.1:7003 slave 7486b5c98c7c644bdc                                                                c992ec8a0b0a9d711c5a49 0 1572080529728 5 connectedb8706be32b3021222237479148acfbdeb9af9e55 127.0.0.1:7001 master - 0 1572080530735                                                                 2 connected 5462-109227486b5c98c7c644bdcc992ec8a0b0a9d711c5a49 127.0.0.1:7000 myself,master - 0 0 1 co                                                                nnected 0-546167dcb98c8e4d12dc0f7a523b744566610821d8f2 127.0.0.1:7005 slave fc9247fe63eeb84196                                                                cc2fd0fe936627e1ed767a 0 1572080531743 4 connectedfc9247fe63eeb84196cc2fd0fe936627e1ed767a 127.0.0.1:7002 master - 0 1572080528217                                                                 0 connected 10923-16383</code></pre><p>æŸ¥çœ‹æ§½çš„åˆ†å¸ƒä¿¡æ¯</p><pre><code class="hljs bash">[root@mcr2 config]<span class="hljs-comment"># redis-cli -p 7000 cluster slots</span>1) 1) (<span class="hljs-built_in">integer</span>) 5462   2) (<span class="hljs-built_in">integer</span>) 10922   3) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7001   4) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 70042) 1) (<span class="hljs-built_in">integer</span>) 0   2) (<span class="hljs-built_in">integer</span>) 5461   3) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7000   4) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 70033) 1) (<span class="hljs-built_in">integer</span>) 10923   2) (<span class="hljs-built_in">integer</span>) 16383   3) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7002   4) 1) <span class="hljs-string">"127.0.0.1"</span>      2) (<span class="hljs-built_in">integer</span>) 7005</code></pre><h1 id="å®˜æ–¹å·¥å…·å®‰è£…"><a href="#å®˜æ–¹å·¥å…·å®‰è£…" class="headerlink" title="å®˜æ–¹å·¥å…·å®‰è£…"></a>å®˜æ–¹å·¥å…·å®‰è£…</h1><h2 id="Rubyç¯å¢ƒå‡†å¤‡"><a href="#Rubyç¯å¢ƒå‡†å¤‡" class="headerlink" title="Rubyç¯å¢ƒå‡†å¤‡"></a>Rubyç¯å¢ƒå‡†å¤‡</h2><blockquote><p>RedisClusteræä¾›äº†Rubyå®‰è£…è„šæœ¬ï¼Œç›¸æ¯”æˆ‘ä»¬ä½¿ç”¨Redis-cliç®€å•å¾ˆå¤šï¼Œä½†æ˜¯ä½¿ç”¨å®ƒéœ€è¦ç¯å¢ƒæ­å»ºï¼Œè¿™é‡Œå°±æ¥ä»‹ç»ä¸€ä¸‹Rubyç¯å¢ƒ</p></blockquote><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>ä¸‹è½½ã€ç¼–è¯‘ã€å®‰è£…Ruby</li><li>å®‰è£…<code>rubygem redis</code>å®¢æˆ·ç«¯</li><li>å®‰è£…<code>redis-trib.rb</code></li></ol><p>ï¼ˆ1ï¼‰ä¸‹è½½ruby</p><pre><code class="hljs bash">wget https://cache.ruby-lang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz</code></pre><p>ï¼ˆ2ï¼‰å®‰è£…ruby</p><pre><code class="hljs bash">tar -xvf ruby-2.3.1.tar.gz ./configure -prefix=/usr/<span class="hljs-built_in">local</span>/rubymakemake install<span class="hljs-built_in">cd</span> /usr/<span class="hljs-built_in">local</span>/rubycp bin/ruby /usr/<span class="hljs-built_in">local</span>/bin</code></pre><p>ï¼ˆ3ï¼‰å®‰è£… rubygem redis</p><pre><code class="hljs bash">wget http://rubygems.org/downloads/redis-3.3.0.gemgem install -i redis-3.3.0.gemgem list --check redis gem</code></pre><p>ï¼ˆ4ï¼‰å®‰è£…redis-trib.rb</p><pre><code class="hljs bash">cp $<span class="hljs-variable">$&#123;REDIS_HOME&#125;</span>/src/redis-trib.rb /usr/<span class="hljs-built_in">local</span>/bin</code></pre><h2 id="rubyç¯å¢ƒå‡†å¤‡-æ“ä½œ"><a href="#rubyç¯å¢ƒå‡†å¤‡-æ“ä½œ" class="headerlink" title="rubyç¯å¢ƒå‡†å¤‡-æ“ä½œ"></a>rubyç¯å¢ƒå‡†å¤‡-æ“ä½œ</h2><pre><code class="hljs bash">[root@mcr2 opt] wget https://cache.rubylang.org/pub/ruby/2.3/ruby-2.3.1.tar.gz[root@mcr2 opt] tar -xvf ruby-2.3.1.tar.gz  -C /usr/src[root@mcr2 opt] <span class="hljs-built_in">cd</span> /usr/src/ruby-2.3.1/[root@mcr2 ruby-2.3.1] ./configure -prefix=/usr/<span class="hljs-built_in">local</span>/ruby[root@mcr2 ruby-2.3.1] make &amp;&amp; make install....ç­‰å¾…[root@mcr2 ruby-2.3.1] cp ruby /usr/<span class="hljs-built_in">local</span>/bin[root@mcr2 ruby-2.3.1] ruby  -vruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-linux][root@mcr2 bin] <span class="hljs-built_in">pwd</span>/usr/<span class="hljs-built_in">local</span>/ruby/bin[root@mcr2 bin] cp gem /usr/<span class="hljs-built_in">local</span>/bin/</code></pre><p>å®‰è£…rediså®¢æˆ·ç«¯</p><pre><code class="hljs bash">[root@mcr2 src] <span class="hljs-built_in">pwd</span>/usr/src[root@mcr2 src] wget http://rubygems.org/downloads/redis3.3.0.gem[root@mcr2 src] gem install -l redis-3.3.0.gem<span class="hljs-comment">#æ£€æŸ¥æ˜¯å¦æœ‰è®©edis</span>[root@mcr2 src] gem list -- check redis gem*** LOCAL GEMS ***bigdecimal (1.2.0)io-console (0.4.2)json (1.7.7)psych (2.0.0)rdoc (4.0.0)redis (3.3.0)[root@mcr2 redis] <span class="hljs-built_in">cd</span> /usr/src/redis/src[root@mcr2 src] ./redis-trib.rb....</code></pre><h2 id="redis-tribæ„å»ºé›†ç¾¤"><a href="#redis-tribæ„å»ºé›†ç¾¤" class="headerlink" title="redis-tribæ„å»ºé›†ç¾¤"></a>redis-tribæ„å»ºé›†ç¾¤</h2><p>å°†<code>redis-trib.rb</code>å‘½ä»¤æ”¾åˆ°å…¨å±€</p><pre><code class="hljs bash">cp <span class="hljs-variable">$&#123;REDIS_HOME&#125;</span>/src/redis-trib.rb /usr/<span class="hljs-built_in">local</span>/bin</code></pre><p>ä¸€é”®å¼€å¯</p><blockquote><p>è¿™é‡Œçš„èŠ‚ç‚¹ç«¯å£åˆ†åˆ«ä¸º8000ã€8001ã€8002ã€8003ã€8004ã€8005</p></blockquote><pre><code class="hljs bash">./redis-trib.rb create --replicas 1 127.0.0.1:8000\ 127.0.0.1:8001\127.0.0.1:8002 127.00.1:8003\127.0.0.1:8004 127.0.0.1:8005</code></pre><blockquote><p>è¿™é‡Œçš„è¯­æ³•ä¸º ./redis-trib.rb create â€“replicas  [ ä»èŠ‚ç‚¹æ•°é‡ ]    ip:[port]    [ ip:[port]  ] â€¦ï¼Œè¿™é‡Œæˆ‘ä»¬åªè¦ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œæ‰€æœ‰å†™çš„æ˜¯1ï¼Œåœ¨æˆ‘ä»¬æ‰§è¡Œçš„å‘½ä»¤ä¸­ï¼Œå‰é¢3ä¸ªæ˜¯ä¸»èŠ‚ç‚¹ï¼Œåé¢3ä¸ªæ˜¯ä»èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯8000å’Œ8003å¯¹åº”ã€8001å’Œ8004ã€8002å’Œ8005ï¼Œå¦‚æœä½ éœ€è¦2ä¸ªä»èŠ‚ç‚¹ï¼Œé‚£ä½ åœ¨ä¸»èŠ‚ç‚¹åé¢åŠ 6ä¸ªä»èŠ‚ç‚¹ï¼Œå½“ä½ æ‰€å¡«çš„æ•°é‡ä»¥åŠå®ƒçš„æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†ï¼Œå®ƒä¼šè¿”å›ç»™ä½ é”™è¯¯</p></blockquote><p>é¦–å…ˆå°†ä¹‹å‰çš„redisé›†ç¾¤å…¨éƒ¨å…³é—­</p><pre><code class="hljs bash">[root@mcr2 config] ps -ef | grep redis-server | grep 700 | awk <span class="hljs-string">'&#123;print $2&#125;'</span> | xargs <span class="hljs-built_in">kill</span></code></pre><p>å°†dataç›®å½•çš„æ•°æ®æ¸…é™¤</p><pre><code class="hljs bash">[root@mcr2 config] <span class="hljs-built_in">cd</span> ../data[root@mcr2 data] rm -rf *</code></pre><p>å¯åŠ¨redisæœåŠ¡</p><pre><code class="hljs bash">[root@mcr2 config] redis-server redis-7000.conf[root@mcr2 config] redis-server redis-7001.conf[root@mcr2 config] redis-server redis-7002.conf[root@mcr2 config] redis-server redis-7003.conf[root@mcr2 config] redis-server redis-7004.conf[root@mcr2 config] redis-server redis-7005.conf</code></pre><p>ä½¿ç”¨<code>redis-trib.rb</code>æ­å»ºé›†ç¾¤</p><pre><code class="hljs bash">[root@mcr2 config] redis-trib.rb  create   --replicas 1 \&gt;  127.0.0.1:7000  127.0.0.1:7001  127.0.0.1:7002 \&gt;  127.0.0.1:7003  127.0.0.1:7004  127.0.0.1:7005</code></pre><p>æ‰§è¡Œå®Œä¸Šé¢çš„å‘½ä»¤ä¼šæœ‰è¿™äº›å†…å®¹ï¼Œè¿™é‡Œæ˜¯ä¸»ä»å¯¹åº”å…³ç³»</p><pre><code class="hljs bash">Adding replica 127.0.0.1:7003 to 127.0.0.1:7000Adding replica 127.0.0.1:7004 to 127.0.0.1:7001Adding replica 127.0.0.1:7005 to 127.0.0.1:7002</code></pre><p>è¿˜æœ‰node-idï¼Œæ§½çš„èŒƒå›´ï¼ŒèŠ‚ç‚¹æ˜¯ä»è¿˜æ˜¯ä¸»</p><pre><code class="hljs bash">M: 709ce3bd4d8fba5f62f57d7ec3b64569a070f22d 127.0.0.1:7000   slots:0-5460 (5461 slots) masterM: d030b2dc316d9c58a4a0b14dcc31e49108d76f9f 127.0.0.1:7001   slots:5461-10922 (5462 slots) masterM: 325733e9d4ded75d31c68f978c75357334163428 127.0.0.1:7002   slots:10923-16383 (5461 slots) masterS: 7a0624a0256fc0f00c1c66096dafda41157fc9dc 127.0.0.1:7003   replicates 709ce3bd4d8fba5f62f57d7ec3b64569a070f22dS: 4052a3fa7cfe1b2ce293b05223516d5819c34ef0 127.0.0.1:7004   replicates d030b2dc316d9c58a4a0b14dcc31e49108d76f9fS: df4b8f2b54c36853d234a079cc273ad300917f2c 127.0.0.1:7005   replicates 325733e9d4ded75d31c68f978c75357334163428</code></pre><p>æœ€åå®ƒé—®ä½ åŒæ„è¿™ä¸ªé…ç½®å—ï¼Œè¿™é‡Œè¾“å…¥yes</p><pre><code class="hljs bash">Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">'yes'</span> to accept): yes</code></pre><p>è¿™é‡Œç¯å¢ƒå°±æ­å»ºå®Œæˆäº†ï¼Œæ¥æ£€éªŒä¸€ä¸‹</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 7000 cluster nodesdf4b8f2b54c36853d234a079cc273ad300917f2c 127.0.0.1:7005 slave 325733e9d4ded75d31c68f978c75357334163428 0 1572138063357 6 connected709ce3bd4d8fba5f62f57d7ec3b64569a070f22d 127.0.0.1:7000 myself,master - 0 0 1 connected 0-54604052a3fa7cfe1b2ce293b05223516d5819c34ef0 127.0.0.1:7004 slave d030b2dc316d9c58a4a0b14dcc31e49108d76f9f 0 1572138060334 5 connectedd030b2dc316d9c58a4a0b14dcc31e49108d76f9f 127.0.0.1:7001 master - 0 1572138062348 2 connected 5461-109227a0624a0256fc0f00c1c66096dafda41157fc9dc 127.0.0.1:7003 slave 709ce3bd4d8fba5f62f57d7ec3b64569a070f22d 0 1572138057313 4 connected325733e9d4ded75d31c68f978c75357334163428 127.0.0.1:7002 master - 0 1572138061342 3 connected 10923-16383[root@mcr2 config] redis-cli -p 7000 cluster infocluster_state:okcluster_slots_assigned:16384cluster_slots_ok:16384cluster_slots_pfail:0cluster_slots_fail:0cluster_known_nodes:6cluster_size:3cluster_current_epoch:6cluster_my_epoch:1cluster_stats_messages_sent:106cluster_stats_messages_received:106</code></pre><h1 id="åŸç”Ÿå‘½ä»¤å’Œredis-trib-rbå¯¹æ¯”"><a href="#åŸç”Ÿå‘½ä»¤å’Œredis-trib-rbå¯¹æ¯”" class="headerlink" title="åŸç”Ÿå‘½ä»¤å’Œredis-trib.rbå¯¹æ¯”"></a>åŸç”Ÿå‘½ä»¤å’Œredis-trib.rbå¯¹æ¯”</h1><h2 id="åŸç”Ÿå‘½ä»¤å®‰è£…"><a href="#åŸç”Ÿå‘½ä»¤å®‰è£…" class="headerlink" title="åŸç”Ÿå‘½ä»¤å®‰è£…"></a>åŸç”Ÿå‘½ä»¤å®‰è£…</h2><ul><li>ç†è§£Redis Clusteræ¶æ„ï¼›</li><li>ç”Ÿäº§ç¯å¢ƒä¸ä½¿ç”¨ã€‚</li></ul><h2 id="å®˜æ–¹å·¥å…·å®‰è£…-1"><a href="#å®˜æ–¹å·¥å…·å®‰è£…-1" class="headerlink" title="å®˜æ–¹å·¥å…·å®‰è£…"></a>å®˜æ–¹å·¥å…·å®‰è£…</h2><ul><li>é«˜æ•ˆã€å‡†ç¡®</li><li>ç”Ÿäº§ç¯å¢ƒå¯ä»¥ä½¿ç”¨ã€‚</li></ul><h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><ul><li>å¯è§†åŒ–éƒ¨ç½²ï¼›</li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 7.RedisSentinel</title>
    <link href="/redis-7.html"/>
    <url>/redis-7.html</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸»ä»å¤åˆ¶é«˜å¯ç”¨"><a href="#ä¸»ä»å¤åˆ¶é«˜å¯ç”¨" class="headerlink" title="ä¸»ä»å¤åˆ¶é«˜å¯ç”¨"></a>ä¸»ä»å¤åˆ¶é«˜å¯ç”¨</h1><h2 id="ä¸»ä»å¤åˆ¶çš„ä½œç”¨"><a href="#ä¸»ä»å¤åˆ¶çš„ä½œç”¨" class="headerlink" title="ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h2><ul><li>ä¸ºä¸»æä¾›å¤‡ä»½ï¼Œå½“ä¸»æŒ‚æ‰åœ¨å¤‡ä»½ä¸­æœ‰ä¸€ä¸ªå®Œæ•´çš„æ•°æ®</li><li>ä¸ºä¸»å®ç°ä¸€ä¸ªåˆ†æµï¼Œå°†å¤§éƒ¨åˆ†è¯»æ”¾åˆ°ä»èŠ‚ç‚¹ä¸­å»æ‰§è¡Œï¼Œå‡è½»ä¸»èŠ‚å‹åŠ›</li></ul><h2 id="ä¸»ä»å¤åˆ¶çš„é—®é¢˜"><a href="#ä¸»ä»å¤åˆ¶çš„é—®é¢˜" class="headerlink" title="ä¸»ä»å¤åˆ¶çš„é—®é¢˜"></a>ä¸»ä»å¤åˆ¶çš„é—®é¢˜</h2><p>å¦‚æœè¯´ä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆå½“æœ‰å®¢æˆ·ç«¯ä¼ é€å†™çš„å‘½ä»¤å°±æ— æ³•è¿›è¡Œæ‰§è¡Œäº†ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ˜¯æ— æ³•å¿å—çš„ï¼Œæˆ‘ä»¬ä¸å¾—ä¸æ‰‹åŠ¨çš„å°†ä¸»èŠ‚ç‚¹è¿›è¡Œé‡å¯ï¼Œç„¶åå°†å…¶ä¸­ä¸€ä¸ª<code>slave</code>èŠ‚ç‚¹æ‰§è¡Œ<code>slaveof no one</code>å°†å®ƒå˜ä¸ºä¸€ä¸ª<code>master</code>èŠ‚ç‚¹ï¼Œç„¶åå†å°†å…¶ä»–èŠ‚ç‚¹å¯¹è¿™ä¸ª<code>master</code>èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ï¼Œç„¶åå»è¿ç§»ä½¿ç”¨Redisçš„å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªåŠŸèƒ½å¯ä»¥ç”¨è„šæœ¬æ¥å®ç°ï¼Œä½†æ˜¯æœ‰å‡ ä¸ªç‚¹æ˜¯å¾ˆå¤æ‚çš„ï¼š</p><ol><li>ä½ æ€ä¹ˆåˆ¤æ–­ä¸€ä¸ª<code>Redis</code>èŠ‚ç‚¹æœ‰é—®é¢˜</li><li>æ€ä¹ˆå»é€šçŸ¥å®¢æˆ·ç«¯ï¼›</li><li>ä¸€ä¸ªå®Œæ•´çš„è¿‡ç¨‹æ€ä¹ˆå»ä¿è¯ä¸€ä¸ªå®Œæ•´äº‹åŠ¡çš„å®ç°ï¼Œå¯¹äºä¸€èˆ¬çš„å¼€å‘ä¸­æˆ–è€…è¿ç»´äººå‘˜æ¥è¯´å•ç‹¬å®ç°è¿™æ ·çš„åŠŸèƒ½æ˜¯æ¯”è¾ƒå›°éš¾çš„</li></ol><p>Redisä¹Ÿæƒ³åˆ°äº†è¿™æ ·çš„é—®é¢˜ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†<code>Redis Sentinel</code>è¿™æ ·ä¸€ä¸ªé«˜å¯ç”¨å®ç°</p><h1 id="Redis-SentinelåŸºæœ¬æ¶æ„"><a href="#Redis-SentinelåŸºæœ¬æ¶æ„" class="headerlink" title="Redis SentinelåŸºæœ¬æ¶æ„"></a>Redis SentinelåŸºæœ¬æ¶æ„</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571664454309.png" srcset="/img/loading.gif" alt="1571664454309"></p><p>å‰é¢æåˆ°çš„å‡ ä¸ªé—®é¢˜ï¼Œé€šè¿‡<code>Redis Sentinel</code>éƒ½èƒ½è§£å†³ï¼Œåœ¨<code>Redis</code>åšä¸»ä»å¤åˆ¶æ—¶ï¼Œå¦‚æœä½¿ç”¨äº†<code>Redis Sentinel</code>ï¼Œå½“<code>master</code> èŠ‚ç‚¹æŒ‚äº†ä¹‹åå®ƒä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li>å¤šä¸ªsentinelå‘ç°å¹¶ç¡®è®¤masteræœ‰é—®é¢˜ï¼›</li><li>é€‰ä¸¾å‡ºä¸€ä¸ª<code>sentinel</code>åšä¸ºé¢†å¯¼ï¼›</li><li>é€‰å‡ºä¸€ä¸ªslaveåšä¸º<code>master</code>ï¼›</li><li>é€šçŸ¥å…¶ä½™slaveæˆä¸ºæ–°çš„masterçš„slaveï¼›</li><li>é€šçŸ¥å®¢æˆ·ç«¯ä¸»ä»å˜åŒ–ï¼›</li><li>ç­‰å¾…è€çš„masterå¤æ´»æˆæ–°çš„masterçš„slaveã€‚</li></ol><p>Redis Sentinelä¼šåˆ†ä¸ºå¤šä¸ªèŠ‚ç‚¹ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆ<code>Redis</code>çš„è¿›ç¨‹ï¼Œä½†<code>Redis Sentinel</code>ä¸ä¼šå»å­˜å‚¨æ•°æ®ï¼Œå®ƒä½œç”¨æ˜¯å¯¹<code>Redis</code>ä¸€ä¸ªæ•…éšœåˆ¤æ–­å’Œæ•…éšœè½¬ç§»çš„å¤„ç†å’Œé€šçŸ¥å®¢æˆ·ç«¯çš„è¿‡ç¨‹ï¼Œåœ¨å›¾ä¸­å¯ä»¥çœ‹å‡ºå®ƒæ˜¯æœ‰å¤šä¸ªï¼Œè¿™æ ·å¯ä»¥æé«˜ç›‘æ§èƒ½åŠ›ï¼Œå¦‚æœä¸€ä¸ª<code>Sentinel</code>èŠ‚ç‚¹æŒ‚äº†è¿˜æ˜¯å¯ä»¥ä¿è¯è¿›è¡Œç›‘æ§çš„ä½œç”¨ï¼›</p><hr><p>ç°åœ¨å®¢æˆ·ç«¯ä¸ä¼šä»<code>Redis</code>ç›´æ¥è·å–ä¿¡æ¯ï¼Œå®ƒä¸å†è®°å½•Redisçš„åœ°å€ï¼Œå®ƒä¼šè®°å½•<code>Redis Sentinel</code>çš„åœ°å€ï¼Œä¾‹å¦‚å¯ä»¥å†™å¤šä¸ª<code>Redis Sentinel</code>ï¼Œå®¢æˆ·ç«¯é€šè¿‡<code>Redis Sentinel</code>è·å–<code>Redis</code>çš„åœ°å€ï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿé¦–å…ˆ<code>Redis Sentinel</code>ä¼šå¯¹<code>Redis</code>èŠ‚ç‚¹è¿›è¡Œç›‘æ§ï¼Œå®ƒçŸ¥é“è°æ˜¯<code>master</code>ã€<code>slave</code>èŠ‚ç‚¹ï¼Œåœ¨è¿™é‡Œï¼Œç”±äºmasterèŠ‚ç‚¹å¯èƒ½ä¼šæŒ‚æ‰ï¼Œ<code>Redis Sentinel</code>ä¼šå¯¹å®¢æˆ·ç«¯è¿›è¡Œä¸€ä¸ªé€šçŸ¥è°æ˜¯ä¸»èŠ‚ç‚¹ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´å°±ä¸ç”¨å…³å¿ƒè°æ˜¯<code>master</code>ï¼Œè¿™æ ·åœ¨masterå‡ºç°æ•…éšœçš„æ—¶å€™ï¼Œ<code>Redis Sentinel</code>ä¼šè¿›è¡Œä¸€ä¸ªæ•…éšœè½¬ç§»ï¼Œè¿™ä¸ªæ—¶å€™ç”±äº<code>master</code>èŠ‚ç‚¹æ”¹å˜äº†ï¼Œä¹‹å‰éœ€è¦åœ¨å®¢æˆ·ç«¯ä¿®æ”¹<code>Redis</code>çš„<code>master</code>èŠ‚ç‚¹è¿æ¥ä¿¡æ¯ï¼Œç°åœ¨å°±ä¸å†éœ€è¦è¿™ä¹ˆåšï¼Œå› ä¸º<code>Redis Sentinel</code>ä¼šé€šçŸ¥å®¢æˆ·ç«¯æ–°çš„<code>master</code>èŠ‚ç‚¹æ˜¯å“ªä¸ªï¼›</p><hr><p><code>Redis Sentinel</code>è¿˜å¯ä»¥ç›‘æ§å¤šä¸ª<code>master-slave</code>,è¿™ä¸ªåœ¨å®ƒå†…éƒ¨æ˜¯æœ‰å®ç°çš„ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°ä¸€å¥—<code>Redis Sentinel</code>ç›‘æ§å¤šå°<code>master-slave</code>ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆå‡å°‘èµ„æºï¼Œæ¯å¥—<code>master-slave</code>ä¼šä½¿ç”¨ä¸€ä¸ª<code>master-name</code>çš„ä¸€ä¸ªé…ç½®åšä¸€ä¸ªæ ‡è¯†</p><h1 id="Redis-Sentineå®‰è£…"><a href="#Redis-Sentineå®‰è£…" class="headerlink" title="Redis Sentineå®‰è£…"></a>Redis Sentineå®‰è£…</h1><h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><ol><li>é…ç½®å¼€å¯ä¸­ä»èŠ‚ç‚¹ï¼›</li><li>é…ç½®å¼€å¯sentinelç›‘æ§ä¸»èŠ‚ç‚¹ï¼ˆsentinelæ˜¯ç‰¹æ®Šçš„Redisï¼‰</li><li>å®é™…åº”ç”¨å¤šå°æœºå™¨ï¼›</li><li>è¯¦ç»†é…ç½®èŠ‚ç‚¹ã€‚</li></ol><h3 id="Redisä¸»èŠ‚ç‚¹"><a href="#Redisä¸»èŠ‚ç‚¹" class="headerlink" title="Redisä¸»èŠ‚ç‚¹"></a>Redisä¸»èŠ‚ç‚¹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571667275501.png" srcset="/img/loading.gif" alt="1571667275501"></p><h3 id="Redisä»èŠ‚ç‚¹"><a href="#Redisä»èŠ‚ç‚¹" class="headerlink" title="Redisä»èŠ‚ç‚¹"></a>Redisä»èŠ‚ç‚¹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571667303435.png" srcset="/img/loading.gif" alt="1571667303435"></p><h3 id="sentinelä¸»è¦é…ç½®"><a href="#sentinelä¸»è¦é…ç½®" class="headerlink" title="sentinelä¸»è¦é…ç½®"></a>sentinelä¸»è¦é…ç½®</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571667449325.png" srcset="/img/loading.gif" alt="1571667449325"></p><blockquote><p>å›¾ä¸­4-7é…ç½®æ˜¯å®ƒçš„æ ¸å¿ƒé…ç½®ï¼Œè¿™é‡Œç®€å•çš„è¿›è¡Œä»‹ç»ä¸€ä¸‹ï¼š</p><p>4ï¼šç›‘æ§ä¸»èŠ‚ç‚¹çš„åå­—æ˜¯ä»€ä¹ˆï¼Œipæ˜¯ä»€ä¹ˆï¼Œæœ€åè¿™ä¸ªâ€œ2â€è¡¨ç¤ºæˆ‘ä»¬å‡ ä¸ª<code>sentinel</code>å¯¹è¿™ä¸ª<code>master</code>    è®¤ä¸ºå®ƒæœ‰é—®é¢˜äº†æ‰å‘åŠ¨æ•…éšœè½¬ç§»ï¼›</p><p>5ï¼š<code>sentinel</code>å¯¹masterèŠ‚ç‚¹å®šæ—¶è¿›è¡Œpingæ“ä½œï¼Œå¦‚æœpingä¸é€šå°±ä»£è¡¨æ˜¯æœ‰é—®é¢˜çš„ï¼›</p><p>6ï¼šå½“é€‰äº†æ–°çš„<code>master</code>ä¹‹åï¼ŒæŠŠå…¶ä»–è€çš„<code>slave</code>å¯¹æ–°çš„<code>master</code>è¿›è¡Œå¤åˆ¶ï¼Œè¿™é‡ŒæŒ‡å¤åˆ¶çš„è¡Œä¸ºæ˜¯å¹¶å‘çš„è¿˜æ˜¯ä¸²è¡Œçš„ï¼Œ1è¡¨ç¤ºæ¯æ¬¡åªèƒ½å¤åˆ¶ä¸€ä¸ªï¼Œä¼˜ç‚¹æ˜¯å¯ä»¥å‡è½»<code>master</code>çš„å‹åŠ›</p><p>7ï¼šè¿™é‡Œå…ˆä¸è¯´</p></blockquote><h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><h3 id="ä¸»èŠ‚ç‚¹"><a href="#ä¸»èŠ‚ç‚¹" class="headerlink" title="ä¸»èŠ‚ç‚¹"></a>ä¸»èŠ‚ç‚¹</h3><pre><code class="hljs bash">vim redis-7000.conf<span class="hljs-comment">#å†…å®¹ï¼š</span>port 7000daemonize yespidfile /var/run/redis-7000.pidlogfile <span class="hljs-string">"7000.log"</span>dir <span class="hljs-string">"/usr/src/redis/data"</span></code></pre><h3 id="ä»èŠ‚ç‚¹"><a href="#ä»èŠ‚ç‚¹" class="headerlink" title="ä»èŠ‚ç‚¹"></a>ä»èŠ‚ç‚¹</h3><pre><code class="hljs bash">sed <span class="hljs-string">"s/7000/7001/g"</span> redis-7000.conf &gt;  redis-7001.confsed <span class="hljs-string">"s/7000/7002/g"</span> redis-7000.conf &gt;  redis-7002.conf<span class="hljs-built_in">echo</span> <span class="hljs-string">"slaveof 192.168.202.102 7000"</span> &gt;&gt; redis-7001.conf<span class="hljs-built_in">echo</span> <span class="hljs-string">"slaveof 192.168.202.102 7000"</span> &gt;&gt; redis-7002.conf</code></pre><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><pre><code class="hljs bash">redis-server redis-7000.confredis-server redis-7001.confredis-server redis-7002.conf</code></pre><h3 id="å®‰è£…Redis-Sentine"><a href="#å®‰è£…Redis-Sentine" class="headerlink" title="å®‰è£…Redis Sentine"></a>å®‰è£…Redis Sentine</h3><p>Sentineé…ç½®æ¨¡æ¿åœ¨Redisç›®å½•åä¸ºï¼š<code>sentinel.conf</code>ï¼Œè¿™é‡Œå°†å®ƒæ‹·è´åˆ°configç›®å½•ä¸­è¿›è¡Œä¸€ä¸ªé…ç½®</p><pre><code class="hljs bash">cp sentinel.conf config<span class="hljs-built_in">cd</span> config<span class="hljs-comment">#å»æ³¨é‡Š</span>cat sentinel.conf  | grep -v <span class="hljs-string">"#"</span> | grep -v <span class="hljs-string">"^$"</span> &gt; redis-sentinel-26379.conf</code></pre><p>redis-sentinel-26379.confå†…å®¹ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">port</span> <span class="hljs-number">26379</span>daemonize <span class="hljs-literal">yes</span>dir <span class="hljs-string">"/usr/src/redis/data/"</span>logfile <span class="hljs-string">"26379.log"</span>sentinel monitor mymaster <span class="hljs-number">192.168.202.102</span> <span class="hljs-number">7000</span> <span class="hljs-number">2</span>sentinel down-after-milliseconds mymaster <span class="hljs-number">30000</span>sentinel parallel-syncs mymaster <span class="hljs-number">1</span>sentinel failover-timeout mymaster <span class="hljs-number">180000</span></code></pre><blockquote><p>è¿™é‡Œæ²¡æœ‰é…ç½®ä»èŠ‚ç‚¹ä¿¡æ¯ï¼Œåªé…ç½®äº†ä¸»èŠ‚ç‚¹ä¿¡æ¯ï¼Œå› ä¸ºå®ƒå¯ä»¥é€šè¿‡ä¸»èŠ‚ç‚¹ä¸­æ‰§è¡Œ<code>info replication</code>æ¥è·å–ä»èŠ‚ç‚¹ä¿¡æ¯</p></blockquote><p>å¯åŠ¨</p><pre><code class="hljs bash">redis-sentinel redis-sentinel-26379.conf</code></pre><p>é…ç½®å¤šä¸ªå¹¶å¯åŠ¨</p><pre><code class="hljs java">sed <span class="hljs-string">"s/26379/26380/g"</span> redis-sentinel-<span class="hljs-number">26379</span>.conf &gt; redis-sentinel-<span class="hljs-number">26380</span>.confsed <span class="hljs-string">"s/26379/26381/g"</span> redis-sentinel-<span class="hljs-number">26379</span>.conf &gt; redis-sentinel-<span class="hljs-number">26381</span>.confredis-sentinel redis-sentinel-<span class="hljs-number">26380</span>.confredis-sentinel redis-sentinel-<span class="hljs-number">26381</span>.conf</code></pre><p>æŸ¥çœ‹ä¿¡æ¯</p><pre><code class="hljs bash">redis-cli  -p 26379 info<span class="hljs-comment"># Server</span>redis_version:3.0.7redis_git_sha1:00000000redis_git_dirty:0redis_build_id:525f217f06e56f1redis_mode:sentinelos:Linux 3.10.0-1062.1.2.el7.x86_64 x86_64arch_bits:64multiplexing_api:epollgcc_version:4.8.5process_id:2781run_id:07bfbcc4b430d20a96e8700fe936b556a8ec6067tcp_port:26379uptime_in_seconds:1021uptime_in_days:0hz:13lru_clock:11420702config_file:/usr/src/redis/config/redis-sentinel-26379.conf<span class="hljs-comment"># Sentinel</span>sentinel_masters:1sentinel_tilt:0sentinel_running_scripts:0sentinel_scripts_queue_length:0master0:name=mymaster,status=ok,address=127.0.0.1:7000,slaves=2,sentinels=3</code></pre><blockquote><p>è¿™é‡Œçœ‹æœ€åä¸€ä¸ªï¼šè¿™é‡Œçš„sentinelsä¸º3ï¼Œè¿™å°±æ„å‘³ç€ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯èƒ½äº’ç›¸æ„ŸçŸ¥çš„</p></blockquote><h1 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571759631135.png" srcset="/img/loading.gif" alt="1571759631135"></p><h1 id="æ•…éšœè½¬ç§»"><a href="#æ•…éšœè½¬ç§»" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h1><blockquote><p>é€šè¿‡<code>Redis</code>çš„æ•…éšœè¿›è¡Œæ¼”ç»ƒï¼Œä¸ºäº†æ¼”ç»ƒè¿™ä¸ªä¸œè¥¿ï¼Œé¦–å…ˆå°†<code>master</code>èŠ‚ç‚¹ç›´æ¥å¹²æ‰ï¼Œç„¶åæˆ‘ä»¬å»å†™ä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œä¸æ–­çš„å»æ­»å¾ªç¯å®¢æˆ·ç«¯å®ç°ï¼Œå½“å®ƒè‡ªåŠ¨å»åšæ•…éšœè½¬ç§»çš„æ—¶å€™è§‚å¯Ÿä¸€ä¸‹å®¢æˆ·ç«¯çš„ååº”ï¼Œæœ€åå†æ¥åˆ†æ<code>master</code>ã€<code>slave</code>æ—¥å¿—</p></blockquote><p> pomä¾èµ–</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>ch.qos.logback<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>logback-classic<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.slf4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>slf4j-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.28<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><p>Javaä»£ç </p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.shui.jedis.demo;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisSentinelFailoverTest</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Logger logger = LoggerFactory.getLogger(RedisSentinelFailoverTest<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        <span class="hljs-keyword">final</span> String masterName = <span class="hljs-string">"mymaster"</span>;        Set&lt;String&gt; sentinels = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();        sentinels.add(<span class="hljs-string">"mcr2.com:26379"</span>);        sentinels.add(<span class="hljs-string">"mcr2.com:26380"</span>);        sentinels.add(<span class="hljs-string">"mcr2.com:26381"</span>);        JedisSentinelPool jedisSentinelPool = <span class="hljs-keyword">new</span> JedisSentinelPool(masterName, sentinels);        <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;            counter++;            Jedis jedis = <span class="hljs-keyword">null</span>;            <span class="hljs-keyword">try</span> &#123;                jedis = jedisSentinelPool.getResource();                <span class="hljs-keyword">int</span> index = <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">100000</span>);                String key = <span class="hljs-string">"k-"</span> + index;                String value = <span class="hljs-string">"v-"</span> + index;                jedis.set(key, value);                <span class="hljs-keyword">if</span> (counter % <span class="hljs-number">100</span> == <span class="hljs-number">0</span>) &#123;                    logger.info(<span class="hljs-string">"&#123;&#125; value is &#123;&#125;"</span>, key, jedis.get(key));                &#125;                TimeUnit.MICROSECONDS.sleep(<span class="hljs-number">1000</span>);            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                logger.error(e.getMessage(), e);                e.printStackTrace();            &#125; <span class="hljs-keyword">finally</span> &#123;                <span class="hljs-keyword">if</span> (jedis != <span class="hljs-keyword">null</span>) &#123;                    jedis.close();                &#125;            &#125;        &#125;    &#125;&#125;</code></pre><p>æ€æ‰ä¸»èŠ‚ç‚¹</p><pre><code class="hljs bash">[root@mcr2 config] ps -ef | grep redis-server | grep 7000[root@mcr2 config] <span class="hljs-built_in">kill</span> -9 6276</code></pre><p>è¿™ä¸ªæ—¶å€™çš„ä¸»èŠ‚ç‚¹å˜ä¸ºäº†ï¼š</p><pre><code class="hljs bash">[root@mcr2 config] redis-cli -p 26379 infomaster0:name=mymaster,status=ok,address=192.168.202.102:7001,slaves=2,sentinels=3</code></pre><p>è¿™ä¸ªæ—¶å€™çš„æ§åˆ¶å°ä¸Šä¾æ—§å¯ä»¥æ­£å¸¸æ‰§è¡Œå‘½ä»¤</p><h1 id="ä¸‰ä¸ªå®šæ—¶å™¨"><a href="#ä¸‰ä¸ªå®šæ—¶å™¨" class="headerlink" title="ä¸‰ä¸ªå®šæ—¶å™¨"></a>ä¸‰ä¸ªå®šæ—¶å™¨</h1><ol><li><p>æ¯10ç§’æ¯ä¸ªsentinelå¯¹masterå’Œslaveæ‰§è¡Œinfo</p><ul><li><p>å‘ç°slaveèŠ‚ç‚¹</p></li><li><p>ç¡®è®¤ä¸»ä»å…³ç³»</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571838045174-1571838045933.png" srcset="/img/loading.gif" alt="1571838045174"></p></li></ul></li><li><p>æ¯2ç§’æ¯ä¸ªsentinelé€šè¿‡masterèŠ‚ç‚¹çš„channeläº¤æ¢ä¿¡æ¯ï¼ˆpub/subï¼‰</p><ul><li><p>é€šè¿‡<code>_sasentinel_:heloo</code>é¢‘é“äº¤äº’</p></li><li><p>äº¤äº’å¯¹èŠ‚ç‚¹çš„â€œçœ‹æ³•â€å’Œè‡ªèº«ä¿¡æ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571838089475-1571838118960.png" srcset="/img/loading.gif" alt="1571838089475"></p></li></ul></li><li><p>æ¯1ç§’æ¯ä¸ªsentinelå¯¹å…¶ä»–sentinelå’Œredisæ‰§è¡Œping</p></li></ol><ul><li><p>å¿ƒè·³æ£€æµ‹ï¼Œå¤±è´¥åˆ¤æ–­ä¾æ®</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571838194743.png" srcset="/img/loading.gif" alt="1571838194743"></p></li></ul><h1 id="ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿"><a href="#ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿" class="headerlink" title="ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿"></a>ä¸»è§‚ä¸‹çº¿å’Œå®¢è§‚ä¸‹çº¿</h1><pre><code class="hljs nginx"><span class="hljs-comment"># ç›‘æ§masterèŠ‚ç‚¹ï¼Œå‚æ•°ï¼š quorumï¼šæ³•å®šäººæ•°ï¼Œå½“è¾¾åˆ°ä¸€ä¸ªæ³•å®šäººæ•°æ—¶å€™æ‰å¯ä»¥åšä¸‹ä¸€æ­¥å·¥ä½œ,è¿™é‡Œé…ç½®çš„quorumé…ç½®çš„æ˜¯ä¸€ä¸ª2ï¼Œè¿™ä¸ª2ä¸€èˆ¬æ¥è¯´æ˜¯è¿™æ ·çš„æ ¼å¼ï¼šä¾‹å¦‚ç°åœ¨æœ‰3ä¸ªsentinelèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå°±é…ç½®2ï¼Œå¦‚æœæœ‰5ä¸ªå°±é…3ï¼Œå»ºè®®æ˜¯`èŠ‚ç‚¹æ•°é™¤ä»¥2å»+1`ï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸‹ï¼šsentinelèŠ‚ç‚¹æœ€å¥½æ˜¯3ä¸ªä»¥ä¸Šçš„åŸºæ•°ï¼Œå°±åƒzoomkeeperé‚£æ ·çš„è§„åˆ™</span><span class="hljs-attribute">sentinel</span> monitor &lt;masterName&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt; <span class="hljs-comment"># ä¾‹å­</span>sentinel monitor myMaster <span class="hljs-number">127.0.0.1</span> <span class="hljs-number">6379</span> <span class="hljs-number">2</span>sentinel down-after-milliseconds &lt;masterName&gt; &lt;timeout&gt;<span class="hljs-comment"># ä¸»è§‚ä¸‹çº¿çš„åˆ¤æ–­ï¼Œä¸€ä¸ªsentinelå¯¹masteræˆ–è€…slaveèŠ‚ç‚¹çš„è¦æ±‚ï¼Œå‰é¢è¯´è¿‡ï¼šæ¯ä¸ªSentinelä¼šæ¯ä¸€ä¸ªå»ping slaveå’Œmasterï¼Œå¦‚æœè¶…è¿‡30ç§’è¿˜æ˜¯æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œå®ƒå°±ä¼šåšä¸‹çº¿çš„åˆ¤æ–­</span>sentinel down-after-milliseconds mymaster <span class="hljs-number">30000</span></code></pre><ul><li><p>ä¸»è§‚ä¸‹çº¿ï¼šæ¯ä¸ªsentinelèŠ‚ç‚¹å¯¹RedisèŠ‚ç‚¹å¤±è´¥çš„â€œåè§â€</p></li><li><p>å®¢è§‚ä¸‹çº¿ï¼šæ‰€æœ‰sentinelèŠ‚ç‚¹å¯¹RedisèŠ‚ç‚¹å¤±è´¥â€œè¾¾æˆå…±è¯†â€ï¼ˆè¶…è¿‡quorumä¸ªç»Ÿä¸€ï¼‰ï¼Œ</p><p><code>sentinel is-master-down-by-addr</code>ï¼šé—®ä¸€ä¸‹å¯¹åº”çš„sentinelèŠ‚ç‚¹æ˜¯å¦ä½ ä¹Ÿè®¤ä¸ºå½“å‰è¿™ä¸ªmasterèŠ‚ç‚¹èŠ‚ç‚¹åšä¸€ä¸ªå®¢è§‚ä¸‹çº¿</p></li></ul><h1 id="é¢†å¯¼è€…é€‰ä¸¾"><a href="#é¢†å¯¼è€…é€‰ä¸¾" class="headerlink" title="é¢†å¯¼è€…é€‰ä¸¾"></a>é¢†å¯¼è€…é€‰ä¸¾</h1><ul><li><p>åŸå› ï¼šåªæœ‰ä¸€ä¸ªsentinelèŠ‚ç‚¹å®Œæˆæ•…éšœè½¬ç§»</p></li><li><p>é€‰ä¸¾ï¼šé€šè¿‡<code>sentinel is-master-down-by-addr</code>å‘½ä»¤éƒ½å¸Œæœ›æˆä¸ºé¢†å¯¼è€…ï¼Œ<code>sentinel is-master-down-by-addr</code>æœ‰2ä¸ªä½œç”¨ï¼š</p><p>ï¼ˆ1ï¼‰å¯¹<code>master</code>èŠ‚ç‚¹çš„å¤±è´¥åˆ¤å®šï¼›</p><p>ï¼ˆ2ï¼‰ç”¨æ¥è¿›è¡Œé¢†å¯¼è€…é€‰ä¸¾ã€‚</p><ol><li>æ¯ä¸ªåšä¸»è§‚ä¸‹çº¿çš„<code>sentinel</code>èŠ‚ç‚¹å‘å…¶ä»–<code>sentinel</code>èŠ‚ç‚¹å‘é€å‘½ä»¤ï¼Œè¦æ±‚å®ƒè®¾ç½®ä¸ºé¢†å¯¼è€…ï¼Œä¾‹å¦‚æœ‰3ä¸ª<code>sentinel</code>èŠ‚ç‚¹ï¼Œ1å®Œæˆä¸»è§‚ä¸‹çº¿ï¼Œç„¶å1å»é—®2ã€3ä½ æ˜¯å¦åŒæ„è‡ªå·±æˆä¸ºé¢†å¯¼è€…ï¼›</li><li>æ”¶åˆ°å‘½ä»¤çš„<code>sentinel</code>èŠ‚ç‚¹å¦‚æœæ²¡æœ‰åŒæ„å…¶ä»–sentinelèŠ‚ç‚¹å‘é€çš„å‘½ä»¤ï¼Œé‚£ä¹ˆå°†åŒæ„è¯¥è¯·æ±‚ï¼Œå¦åˆ™æ‹’ç»ï¼›</li><li>å¦‚æœè¯¥<code>sentinel</code>èŠ‚ç‚¹å‘ç°è‡ªå·±çš„ç¥¨æ•°å·²ç»è¶…è¿‡ä¸ª<code>sentinel</code>é›†åˆåŠæ•°ä¸”è¶…è¿‡<code>quorum</code>ï¼Œé‚£ä¹ˆå®ƒå°†æˆä¸ºé¢†å¯¼è€…ï¼›</li><li>å¦‚æœæ­¤è¿‡ç¨‹æœ‰å¤šä¸ªsentinelèŠ‚ç‚¹æˆä¸ºäº†é¢†å¯¼è€…ï¼Œé‚£ä¹ˆå°†ç­‰å¾…ä¸€æ®µæ—¶é—´é‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚</li></ol></li></ul><h1 id="æ•…éšœè½¬ç§»-1"><a href="#æ•…éšœè½¬ç§»-1" class="headerlink" title="æ•…éšœè½¬ç§»"></a>æ•…éšœè½¬ç§»</h1><ul><li>ä»slaveèŠ‚ç‚¹ä¸­é€‰å‡ºä¸€ä¸ªâ€œåˆé€‚çš„â€èŠ‚ç‚¹ä½œä¸ºæ–°çš„masterèŠ‚ç‚¹ï¼›<ul><li>é€‰æ‹©<code>slave-priority</code>ï¼ˆslaveèŠ‚ç‚¹ä¼˜å…ˆçº§ï¼‰æœ€é«˜çš„slaveèŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œä¸å­˜åœ¨åˆ™ç»§ç»­ï¼Œ<code>slave-priority</code>è¡¨ç¤ºä¼˜å…ˆçº§ï¼Œè¿™ä¸ªé…ç½®ä¸€èˆ¬æ˜¯ä¸é…ç½®çš„ï¼Œæ‰€ä»¥åœ¨slaveèŠ‚ç‚¹ä¸­ä¼˜å…ˆçº§éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¸ªåœ¨ä»€ä¹ˆåœºæ™¯ä¸‹ä¼šä½¿ç”¨å‘¢ï¼Ÿæ¯”å¦‚è¯´ç°åœ¨ä¸€ä¸ªmasterï¼Œ2ä¸ªslaveèŠ‚ç‚¹ï¼Œç„¶åå¸Œæœ›æ€§èƒ½å¥½çš„æœºå™¨å˜æˆmasterï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šç”¨åˆ°<code>slave-priority</code>ï¼›</li><li>ä¸Šé¢ç»§ç»­çš„è¯ï¼šé€‰æ‹©å¤åˆ¶åç§»é‡æœ€å¤§çš„slaveèŠ‚ç‚¹ï¼ˆå¤åˆ¶çš„æœ€å®Œæ•´ï¼‰ï¼Œå¦‚æœå®ƒå’Œmasteråç§»é‡æ¯”è¾ƒæ¥è¿‘å°±æ­£é¢å®ƒä¸masteræ•°æ®ä¸€è‡´æ€§ä¼šæ›´é«˜ä¸€ç‚¹ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™masterèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œå¯èƒ½å‡ºç°äº†æ•°æ®é—®é¢˜ï¼Œè¿™ä¸ªæ—¶å€™å†™å…¥é‡æœ€å¤§çš„èŠ‚ç‚¹å˜æˆmasterï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›ï¼Œä¸å­˜åœ¨åˆ™ç»§ç»­ï¼Œ</li><li>ä¸Šé¢ç»§ç»­çš„è¯ï¼šé€‰æ‹©runIdæœ€å°çš„slaveèŠ‚ç‚¹ã€‚</li></ul></li><li>å¯¹ä¸Šé¢çš„slaveèŠ‚ç‚¹æ‰§è¡Œ<code>slaveof no one</code>å‘½ä»¤è®©å…¶æˆä¸º<code>master</code>èŠ‚ç‚¹ï¼Œå¤åˆ¶è§„åˆ™å’Œ<code>parallel-syncs</code>å‚æ•°æœ‰å…³ï¼Œ<code>parallel-syncs</code>ï¼šå‡å¦‚è¯´ç°åœ¨<code>Redis</code>ä¸Šæ˜¯ä¸€ä¸»ä¸‰ä»ï¼Œç°åœ¨ä¸»æŒ‚æ‰äº†ï¼Œsentinelé€‰æ‹©äº†ä¸€ä¸ª<code>slave</code>èŠ‚ç‚¹ä½œä¸º<code>master</code>ï¼Œå‰©ä¸‹å…¶ä»–çš„å»å¤åˆ¶è¿™ä¸ª<code>master</code>ï¼Œå¦‚æœè¿™ä¸ª<code>parallel-syncs</code>å‚æ•°ä¸º2çš„è¯ï¼Œ2ä¸ªslaveå»åŒæ—¶åšå¤åˆ¶æ“ä½œï¼Œè¿™ä¸ªæ˜¯å¯¹<code>master</code>ç«¯åšä¼˜åŒ–çš„ï¼Œå®ƒå°±åªåšä¸€æ¬¡<code>RDB</code>ç”Ÿæˆè€Œå‡å°‘ä¸€å®šæˆæœ¬ï¼Œä½†æ˜¯å®ƒä¼šå»å®Œæˆ<code>RDB</code>æ–‡ä»¶æ“ä½œä»¥åŠ<code>buffer</code>çš„å‘é€ï¼Œå¯¹äº<code>master</code>èŠ‚ç‚¹æ˜¯æœ‰ä¸€å®šå¼€é”€çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­å®ƒä¼šå ç”¨å¾ˆå¤šçš„ç½‘ç»œèµ„æºå»ä¼ è¾“<code>RDB</code>æ–‡ä»¶ï¼Œè¿™ä¸ªè¦æ ¹æ®<code>Redis</code>çš„<code>master</code>ä½¿ç”¨çš„å†…å­˜å¤§å°æœ‰å…³çš„ï¼ŒåŠ å…¥è¿™ä¸ªå‚æ•°é…ç½®ä¸º1çš„è¯ï¼Œå®ƒä»¬æ˜¯ä¸€ä¸ªé¡ºåºçš„è¿‡ç¨‹ï¼Œé¦–å…ˆçš„ä¸€ä¸ªslaveèŠ‚ç‚¹å»å®Œæˆå¤åˆ¶ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹å»å®Œæˆå¤åˆ¶ï¼Œè¿™æ ·æœ‰æ•ˆå‡å°‘<code>master</code>èŠ‚ç‚¹å¼€é”€ï¼Œä¾‹å¦‚ä½ å¸Œæœ›æ‰€æœ‰slaveèŠ‚ç‚¹å¿«é€Ÿçš„è¿›è¡Œæ¢å¤ï¼Œä¾‹å¦‚ä½ ç”¨äº†è¯»å†™åˆ†ç¦»çš„ä¸œè¥¿ï¼Œä½  å¸Œæœ›èƒ½å¿«é€Ÿæ¢å¤è¿™ä¸ªå‚æ•°å¯ä»¥è®¾ç½®å¤§ä¸€ç‚¹ï¼Œå¦‚æœä½ å¸Œæœ›èµ„æºå¾—åˆ°åˆç†çš„ä¿æŠ¤é‚£å°±é…ç½®ä¸º1ï¼›</li><li>æ›´æ–°å¯¹åŸæ¥<code>master</code>èŠ‚ç‚¹è®¾ç½®ä¸º<code>slave</code>ï¼Œå¹¶ä¿æŒç€å¯¹å…¶â€œå…³æ³¨â€ï¼Œå½“å…¶æ¢å¤åå‘½ä»¤å®ƒå»å¤åˆ¶æ–°çš„<code>master</code>èŠ‚ç‚¹ï¼›</li></ul><h1 id="å¸¸è§å¼€å‘è¿ç»´é—®é¢˜"><a href="#å¸¸è§å¼€å‘è¿ç»´é—®é¢˜" class="headerlink" title="å¸¸è§å¼€å‘è¿ç»´é—®é¢˜"></a>å¸¸è§å¼€å‘è¿ç»´é—®é¢˜</h1><h2 id="èŠ‚ç‚¹è¿ç»´"><a href="#èŠ‚ç‚¹è¿ç»´" class="headerlink" title="èŠ‚ç‚¹è¿ç»´"></a>èŠ‚ç‚¹è¿ç»´</h2><ul><li>æœºå™¨ä¸‹çº¿ï¼šä¾‹å¦‚è¿‡ä¿ç­‰æƒ…å†µï¼Œå…¬å¸ã€ä¸ªäººçš„æœºå™¨éƒ½æœ‰ä¸€ä¸ªä¿è´¨æœŸï¼Œè¿™ä¸ªè¿™ä¸ªä¿è´¨æœŸå†…ä¼šå¯¹å®ƒè¿›è¡Œä¸‹çº¿ï¼Œæ¯”å¦‚è¯´è¿™ä¸ªæœºå™¨å·²ç»ä½¿ç”¨äº†5å¹´ï¼Œå®ƒç°åœ¨ä¸åœ¨è‡ªä¿èŒƒå›´å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦å°†å®ƒè¿›è¡Œä¸‹çº¿ï¼Œè¿™ä¸ªæœºå™¨ä¸Šä¼šæœ‰å¾ˆå¤šæœåŠ¡ï¼Œå…¶ä¸­å°±æœ‰RedisæœåŠ¡ï¼Œè¿™é‡Œæœ‰Sentinelã€ä¸»èŠ‚ç‚¹ã€ä»èŠ‚ç‚¹ï¼›</li><li>æœºå™¨æ€§èƒ½ä¸è¶³ï¼šä¸€äº›å¾ˆè€çš„æœºå™¨æŸäº›ç¡¬ä»¶å¯èƒ½ä¸å¤ªç¨³å®šï¼Œä¾‹å¦‚CPUã€å†…å­˜ã€ç¡¬ç›˜ã€ç½‘ç»œè¿™äº›éƒ½ä¸æ˜¯å¾ˆé—®é¢˜ï¼Œä¾‹å¦‚ç½‘ç»œåˆ‡æ¢åˆ°ä¸€ä¸ªä¸‡å…†ç½‘å¡ï¼Œç¡¬ç›˜ä¸ºäº†æ»¡è¶³æ€§èƒ½è¦æ±‚ä¼šä½¿ç”¨SSDï¼Œå†…å­˜éœ€è¦åœ¨ä¸€ä¸ªæ›´å¤§çš„æœºå™¨ä¸Šå»è¿è¡Œï¼ŒCPUè¦æ¢æ›´å¥½çš„ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å¯¹æœºå™¨åšä¸€ä¸ªä¸Šä¸‹çº¿æ“ä½œï¼›</li><li>èŠ‚ç‚¹è‡ªèº«æ•…éšœï¼šèŠ‚ç‚¹å‡ºç°é—®é¢˜ï¼Œä½†æ˜¯ç”±äºæŸäº›åŸå› æš‚æ—¶æ‰¾ä¸åˆ°è¿™ä¸ªé—®é¢˜çš„å­˜åœ¨ç‚¹ï¼Œæœ‰çš„æ—¶å€™å› ä¸ºæœºå™¨ã€ç³»ç»Ÿä¸€äº›åŸå› é€ æˆçš„ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šå¯¹å®ƒåšä¸€ä¸ªè¿ç§»æˆ–è€…ä¸‹çº¿ï¼Œå°†å®ƒåšåˆ°å…¶ä»–æœºå™¨ã€‚</li></ul><h3 id="ä¸»èŠ‚ç‚¹-1"><a href="#ä¸»èŠ‚ç‚¹-1" class="headerlink" title="ä¸»èŠ‚ç‚¹"></a>ä¸»èŠ‚ç‚¹</h3><pre><code class="hljs bash">sentinel failover &lt;masterName&gt; <span class="hljs-comment">#æ•…éšœè½¬ç§»è¿‡ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªæ‰‹åŠ¨çš„è¿‡ç¨‹ï¼Œå®ƒå»å¿½ç•¥äº†ä¸»è§‚ä¸‹çº¿ã€å®¢è§‚ä¸‹çº¿ã€é¢†å¯¼è€…é€‰ä¸¾ï¼Œè¿™é‡Œçš„é¢†å¯¼è€…æ˜¯æ‰§è¡Œè¿™ä¸ªå‘½ä»¤çš„èŠ‚ç‚¹ï¼Œå®ƒå·²ç»ç¡®å®šä½ è¦ä¸‹çº¿masterï¼Œè¿™é‡Œå°±ä¼šæ‰§è¡Œè¿›è¡Œæ•…éšœè½¬ç§»</span></code></pre><h3 id="ä»èŠ‚ç‚¹-1"><a href="#ä»èŠ‚ç‚¹-1" class="headerlink" title="ä»èŠ‚ç‚¹"></a>ä»èŠ‚ç‚¹</h3><ul><li>ç¡®è®¤æ˜¯ä¸´æ—¶ä¸‹çº¿è¿˜æ˜¯æ°¸ä¹…ä¸‹çº¿ï¼Œä¸´æ—¶ä¸‹çº¿æ˜¯æš‚æ—¶å…³é—­æ‰ä¹‹åé‡å¯ï¼Œæ°¸ä¹…ä¸‹çº¿è¡¨ç¤ºæˆ‘çœŸçš„ä¸éœ€è¦å®ƒäº†ï¼Œä¸åœ¨è¿™ä¸ªæœºå™¨ä¸Šäº†å°±éœ€è¦å¹²æ‰ï¼Œè¿™ä¸ªæ—¶å€™è¿˜è¦åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œä¾‹å¦‚ä¸€äº›é…ç½®ã€ä¸€äº›æ•°æ®ä»¥åŠRDBã€AOFéƒ½è¦åšä¸€äº›å¤„ç†ï¼Œå› ä¸ºå•æœºå¤šéƒ¨ç½²çš„è¯å¯èƒ½ä¸€äº›é…ç½®æ–‡ä»¶åœ¨å¯åŠ¨å…¶ä»–è¿›ç¨‹çš„æ—¶å€™ä¼šæœ‰ä¸€äº›å¹²æ‰°ï¼Œè€Œä¸”ä»èŠ‚ç‚¹åœ¨ä¸‹çº¿çš„æ—¶å€™è¦è€ƒè™‘ä¸€ä¸ªè¯»å†™åˆ†ç¦»çš„æƒ…å†µï¼Œå› ä¸ºæœ‰çš„æ—¶å€™ä½¿ç”¨è¯»å†™åˆ†ç¦»ä»èŠ‚ç‚¹æ˜¯ä¸€ä¸ªè¯»å†™åˆ†ç¦»çš„è¿›ç¨‹ï¼Œå®ƒæœ‰å¾ˆå¤šçš„å®¢æˆ·ç«¯å»è¿æ¥ï¼›</li><li>SentinelåŒä¸Š</li></ul><h3 id="èŠ‚ç‚¹ä¸Šçº¿"><a href="#èŠ‚ç‚¹ä¸Šçº¿" class="headerlink" title="èŠ‚ç‚¹ä¸Šçº¿"></a>èŠ‚ç‚¹ä¸Šçº¿</h3><ul><li>ä¸»èŠ‚ç‚¹ï¼šå¸Œæœ›æŸä¸ªä»èŠ‚ç‚¹å‡ä¸ºä¸»èŠ‚ç‚¹ï¼Œæ‰§è¡Œå‘½ä»¤<code>sentinel failover</code>ï¼Œå¹¶è°ƒæ•´å¸Œæœ›å˜æˆä¸»èŠ‚ç‚¹çš„ä¼˜å…ˆçº§ï¼›</li><li>ä»èŠ‚ç‚¹ï¼š<code>slaveof</code>å³å¯ï¼ŒsentinelèŠ‚ç‚¹å¯ä»¥æ„ŸçŸ¥ï¼›</li><li>sentinelèŠ‚ç‚¹ï¼šå‚è€ƒå…¶ä»–sentinelèŠ‚ç‚¹å¯åŠ¨å³å¯ï¼Œé€šè¿‡channelå®ç°ä¿¡æ¯å…±äº«ã€‚</li></ul><h1 id="é«˜å¯ç”¨è¯»å†™åˆ†ç¦»"><a href="#é«˜å¯ç”¨è¯»å†™åˆ†ç¦»" class="headerlink" title="é«˜å¯ç”¨è¯»å†™åˆ†ç¦»"></a>é«˜å¯ç”¨è¯»å†™åˆ†ç¦»</h1><blockquote><p>å»çœ‹ä¸€çœ‹JedisSentinelPoolçš„å®ç°</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 6.Rediså¤åˆ¶åŸç†å’Œä¼˜åŒ–</title>
    <link href="/redis-6.html"/>
    <url>/redis-6.html</url>
    
    <content type="html"><![CDATA[<h1 id="ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶"><a href="#ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶"></a>ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶</h1><h2 id="å•æœºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#å•æœºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="å•æœºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>å•æœºæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><ul><li>åœ¨ä¸€å°æœºå™¨å»éƒ¨ç½²ä¸€ä¸ª<code>Redis</code>èŠ‚ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬æœºå™¨å‘ç”Ÿæ•…éšœï¼Œä¾‹å¦‚æœºå™¨ç£ç›˜ã€CPUã€ä¸»æ¿åäº†ï¼Œé‚£æˆ‘ä»¬å®¢æˆ·ç«¯æ€ä¹ˆè¿æ¥<code>Redis</code>ï¼Ÿ</li><li>RedisèŠ‚ç‚¹å®•æ‰äº†ï¼Œéœ€è¦è¿›è¡Œé‡å¯ï¼Œè¿™é‡Œé‡å¯æœŸé—´ï¼Œå®¢æˆ·ç«¯æ˜¯è¿æ¥ä¸ä¸Š<code>Redis</code>çš„,è€Œä¸”ä½ ä¹Ÿä¸èƒ½åœ¨ç¬¬ä¸€æ—¶é—´å‘ç°<code>Redis</code>å®•æ‰äº†ï¼›</li><li>å‡å¦‚æœºå™¨æœ‰<code>16G</code>å†…å­˜ï¼Œè€ŒRedisç”¨äº†<code>12G</code>å†…å­˜ï¼Œç°åœ¨æœ‰ä¸€ä¸ªéœ€æ±‚ï¼šæˆ‘çœŸçš„éœ€è¦64Gå†…å­˜ï¼Œé‚£ä¹ˆå•æœºæ˜¯æ»¡è¶³ä¸äº†çš„ï¼Œé‚£è¿™æ ·æ˜¯ä¸æ˜¯éœ€è¦ä¹°ä¸ªæ›´å¥½çš„æœºå™¨ï¼Œä¾‹å¦‚ä¹°ä¸ª<code>128G</code>çš„å†…å­˜ï¼›</li><li><code>Redis</code>å·ç§°å¯ä»¥è¾¾åˆ°10Wçš„QPSï¼Œæˆ‘çš„ä¸šåŠ¡éœ€è¦100Wçš„QPSï¼Œé‚£æˆ‘æ€ä¹ˆå»åšå‘¢ï¼Ÿ</li></ul><hr><h2 id="ä¸»ä»å¤åˆ¶çš„ä½œç”¨"><a href="#ä¸»ä»å¤åˆ¶çš„ä½œç”¨" class="headerlink" title="ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h2><blockquote><p>ä»¥ä¸Šæåˆ°çš„QPSç“¶é¢ˆæ˜¯åˆ†å¸ƒå¼æ¥è§£å†³çš„é—®é¢˜ï¼Œè€Œæ•…éšœæ˜¯é«˜å¯ç”¨é—®é¢˜ï¼Œä¸‹é¢æ¥è®²é«˜å¯ç”¨é—®é¢˜</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571484445203.png" srcset="/img/loading.gif" alt="1571484445203"></p><p>å›¾ä¸­<code>master</code>èŠ‚ç‚¹æ˜¯ä¸»èŠ‚ç‚¹ï¼Œ<code>slave</code>èŠ‚ç‚¹æ˜¯ä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå®ƒä¸€å¼€å§‹æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œå®ƒä¹Ÿå¯ä»¥å¯¹å¤–æä¾›æ­£å¸¸çš„æœåŠ¡ï¼Œå½“ç„¶ä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥æä¾›æ­£å¸¸æœåŠ¡çš„ã€‚å‡å¦‚å·¦è¾¹æ˜¯ä¸€ä¸ªæœ‰æ•°æ®çš„Redisï¼Œå³è¾¹æ˜¯æ²¡æœ‰æ•°æ®çš„Redisï¼Œæ­¤æ—¶å®ƒå°±ä¼šè¿›è¡Œä¸€ä¸ªå¤åˆ¶çš„æ“ä½œï¼Œé‚£ä¹ˆå³è¾¹çš„æ•°æ®ä¼šå°†å·¦è¾¹çš„æ•°æ®åŒæ­¥è¿‡æ¥ï¼Œç„¶åå·¦è¾¹çš„æ•°æ®ä¸æ–­çš„å»å†™æ•°æ®ï¼Œå³è¾¹çš„æ•°æ®ä¼šåšä¸€ä¸ªåŒæ­¥çš„æ›´æ–°ï¼Œè¿™é‡Œå°±èƒ½èµ·åˆ°ä¸€ä¸ªå¤‡ä»½çš„æ•ˆæœï¼Œè¿™æ ·çš„è¯å°±å¯ä»¥ä¸ºæˆ‘ä»¬æ›´æ‰ä¸»æœºå®•æœºçš„æƒ…å†µæä¾›ç±»ä¼¼çš„æ”¯æ´ã€‚</p><h2 id="ä¸€ä¸»å¤šä»"><a href="#ä¸€ä¸»å¤šä»" class="headerlink" title="ä¸€ä¸»å¤šä»"></a>ä¸€ä¸»å¤šä»</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571484530557.png" srcset="/img/loading.gif" alt="1571484530557"></p><p>ä»¥ä¸Šæåˆ°çš„æ˜¯ä¸€ä¸»ä¹‰ä»æ¨¡å¼ï¼ŒRedisè¿˜æä¾›äº†ä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œè¿™æ ·å°±å¯ä»¥åšå‡ºæ›´å¤šé«˜å¯ç”¨çš„é€‰æ‹©ï¼Œä¾‹å¦‚<code>master</code>å’Œä¸€ä¸ª<code>slave</code>åŒæ—¶æŒ‚æ‰äº†ï¼Œé‚£ä¹ˆè¿˜å¯ä»¥æœ‰å¤šä¸ªå¤‡ä»½ï¼ŒåŒæ—¶è¿˜å¯ä»¥æä¾›å¦å¤–çš„åŠŸèƒ½ï¼Œåšä¸€ä¸ªåˆšæ‰æåˆ°çš„è¯»å†™åˆ†ç¦»ï¼Œç›¸å½“äº<code>Redis</code>çš„<code>master</code>èŠ‚ç‚¹å¯èƒ½æœ‰å¤šè¯»å†™ï¼Œå·²ç»è¾¾åˆ°äº†æé™ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥æœ‰å¤šä»½ä»ï¼Œè¿™æ ·å¯ä»¥æŠŠè¯»çš„æµé‡è¿›è¡Œåˆ†æµæ¥å®ç°è´Ÿè½½å‡è¡¡</p><h2 id="ä¸»ä»å¤åˆ¶çš„ä½œç”¨-1"><a href="#ä¸»ä»å¤åˆ¶çš„ä½œç”¨-1" class="headerlink" title="ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h2><ol><li>å®ƒä¸ºä¸€ä¸ªæ•°æ®æä¾›äº†å¤šä¸ªå‰¯æœ¬ï¼Œè¿™ä¸ªå‰¯æœ¬å¯ä»¥æˆä¸ºæˆ‘ä»¬é«˜å¯ç”¨ã€åˆ†å¸ƒå¼çš„åŸºç¡€ï¼›</li><li>æ‰©å±•äº†è¯»çš„æ€§èƒ½ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>ä¸€ä¸ª<code>master</code>å¯ä»¥æœ‰å¤šä¸ª<code>slave</code>ï¼Œæ¯ä¸ªslaveè¿˜å¯ä»¥æœ‰slaveï¼›</li><li>ä¸€ä¸ª<code>slave</code>åªèƒ½æœ‰ä¸€ä¸ª<code>master</code>ï¼›</li><li>æ•°æ®æµå‘æ˜¯å•å‘çš„ï¼Œå¿…é¡»ä»masteræµå‘<code>slave</code></li></ol><h1 id="å¤åˆ¶çš„é…ç½®"><a href="#å¤åˆ¶çš„é…ç½®" class="headerlink" title="å¤åˆ¶çš„é…ç½®"></a>å¤åˆ¶çš„é…ç½®</h1><h2 id="ä¸¤ç§å®ç°æ–¹å¼"><a href="#ä¸¤ç§å®ç°æ–¹å¼" class="headerlink" title="ä¸¤ç§å®ç°æ–¹å¼"></a>ä¸¤ç§å®ç°æ–¹å¼</h2><h3 id="å‘½ä»¤å®ç°"><a href="#å‘½ä»¤å®ç°" class="headerlink" title="å‘½ä»¤å®ç°"></a>å‘½ä»¤å®ç°</h3><p>å¸Œæœ›6380æˆä¸º6379çš„ä»èŠ‚ç‚¹ï¼Œåœ¨6380æ‰§è¡Œ<code>slaveof 127.0.0.1:6379</code>ï¼Œå½“å®ƒæ‰§è¡Œè¿™æ¡å‘½ä»¤ä¹‹åï¼Œç„¶åå°±å®ç°äº†å¤åˆ¶çš„æµç¨‹ï¼Œè¿™ä¸ªå¤åˆ¶æ˜¯éå¸¸å¤æ‚çš„ï¼Œå®ƒåŒ…æ‹¬äº†å…¨é‡å¤åˆ¶ã€å‰é¢çš„å»ºç«‹è¿æ¥ã€å„ç§æœºåˆ¶çš„ç¡®è®¤éƒ½ä¼šæœ‰å¾ˆå¤šçš„è¿‡ç¨‹ï¼›</p><pre><code class="hljs bash">redis-6380&gt;slaveof 127.0.0.1:6379OK</code></pre><blockquote><p>ä¸Šé¢ä»£ç æ˜¯ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹ï¼Œå®ƒä¼šç«‹å³è¿”å›OKï¼Œå®ƒå®é™…ä¸Šæ˜¯éœ€è¦å¾ˆå¤šæ­¥éª¤å’Œæ—¶é—´çš„</p></blockquote><p>å–æ¶ˆå¤åˆ¶ï¼š</p><pre><code class="hljs bash">redis-6380&gt; slaveof on noneOK</code></pre><blockquote><p>è¿™é‡Œå–æ¶ˆä¹‹åï¼Œå®ƒä¹‹å‰ä»ä¸»èŠ‚ç‚¹è·å–çš„æ•°æ®å¹¶ä¸ä¼šè¢«æ¸…é™¤ï¼Œè€Œæ˜¯è¯´æˆ‘ä»¬6379æ–°å†™å…¥çš„æ•°æ®ä¸ä¼šåŒæ­¥åˆ°6380ï¼Œè‡³äº6380è¦åšä»€ä¹ˆå¤„ç†ï¼Œæ¯”å¦‚æˆ‘æƒ³å»<code>slaveof</code>æ–°çš„ä¸»ï¼Œè¿™é‡Œè¦æ³¨æ„ï¼šæ–°çš„ä¸»çš„æ•°æ®åŒæ­¥ç»™ä»èŠ‚ç‚¹æ•°æ®ï¼Œå®ƒçš„é¦–å…ˆç¬¬ä¸€æ­¥ä¼šå°†ä»èŠ‚ç‚¹çš„æ•°æ®æ¸…é™¤æ‰</p></blockquote><h3 id="ä¿®æ”¹é…ç½®"><a href="#ä¿®æ”¹é…ç½®" class="headerlink" title="ä¿®æ”¹é…ç½®"></a>ä¿®æ”¹é…ç½®</h3><pre><code class="hljs nginx"><span class="hljs-attribute">slaveof</span> ip port<span class="hljs-comment"># portä¸»èŠ‚ç‚¹</span>slave-read-only <span class="hljs-literal">yes</span><span class="hljs-comment"># å¸Œæœ›ä»èŠ‚ç‚¹åªåšè¯»çš„æ“ä½œè®¾ç½®ä¸ºyes</span></code></pre><h2 id="æ¼”ç¤º"><a href="#æ¼”ç¤º" class="headerlink" title="æ¼”ç¤º"></a>æ¼”ç¤º</h2><p>masteré…ç½®ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">daemonize</span> <span class="hljs-literal">yes</span>pidfile /var/run/redis-<span class="hljs-number">6379</span>.pidport <span class="hljs-number">6379</span>logfile <span class="hljs-string">"6379.conf"</span><span class="hljs-comment">#save 900 1</span><span class="hljs-comment">#save 300 10</span><span class="hljs-comment">#save 60 10000</span>dbfilename dump-<span class="hljs-number">6379</span>.rdbdir /usr/src/redis/data</code></pre><p>slaveé…ç½®ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">daemonize</span> <span class="hljs-literal">yes</span>pidfile /var/run/redis-<span class="hljs-number">6380</span>.pidport <span class="hljs-number">6380</span>logfile <span class="hljs-string">"6380.conf"</span><span class="hljs-comment">#save 900 1</span><span class="hljs-comment">#save 300 10</span><span class="hljs-comment">#save 60 10000</span>dbfilename dump-<span class="hljs-number">6380</span>.rdbdir /usr/src/redis/dataslaveof <span class="hljs-number">127.0.0.1</span> <span class="hljs-number">6379</span></code></pre><p>æ•°æ®åŒæ­¥ï¼š</p><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> k1 v1OK127.0.0.1:6379&gt;127.0.0.1:6380&gt; get k1<span class="hljs-string">"v1"</span>127.0.0.1:6380&gt;</code></pre><p>æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯ï¼š</p><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication<span class="hljs-comment"># Replication</span>role:master<span class="hljs-comment"># è§’è‰²,masterä»£è¡¨ä¸»</span>connected_slaves:1<span class="hljs-comment"># å­èŠ‚ç‚¹æ•°é‡</span>slave0:ip=127.0.0.1,port=6380,state=online,offset=646,lag=0<span class="hljs-comment"># å­èŠ‚ç‚¹ä¿¡æ¯</span>...127.0.0.1:6380&gt; info replication<span class="hljs-comment"># Replication</span>role:slave<span class="hljs-comment"># è§’è‰²,slaveä»£è¡¨ä»  </span>master_host:127.0.0.1<span class="hljs-comment"># ä»çš„ç«¯å£å·</span>master_port:6379<span class="hljs-comment"># ä»çš„ç«¯å£</span>master_link_status:up <span class="hljs-comment"># è¿æ¥ä¸»çš„çŠ¶æ€</span>...</code></pre><h1 id="å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶"><a href="#å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶" class="headerlink" title="å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶"></a>å…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶</h1><h2 id="runid"><a href="#runid" class="headerlink" title="runid"></a>runid</h2><blockquote><p>åœ¨ä»‹ç»å…¨é‡å¤åˆ¶ä¹‹å‰ï¼Œæ¥çœ‹ä¸€ä¸‹ä»€ä¹ˆæ˜¯<code>runid</code></p></blockquote><p>æŸ¥çœ‹<code>runid</code></p><pre><code class="hljs bash">[root@mcr2 /] redis-cli  -p 6379 info server | grep runrun_id:eed56e3b451472234709f80d43cccaecc1010555[root@mcr2 /] redis-cli  -p 6380 info server | grep runrun_id:7ef316df1ae60b0d57510542ff3a5d8734c752ac</code></pre><p><code>runid</code>çš„ä½œç”¨æ˜¯åšä¸€ä¸ªæ ‡è¯†ï¼Œå‡å¦‚è¯´<code>6380</code>å»å¤åˆ¶<code>6379</code>ï¼Œç„¶åå°±çŸ¥é“6379å¯¹åº”çš„<code>runid</code>ï¼Œåœ¨<code>6380</code>è¿™åšä¸€ä¸ªæ ‡è¯†ï¼Œå½“çªç„¶ä¹‹é—´<code>6379</code>çš„<code>runid</code>å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯èƒ½å®ƒåšäº†ä¸€ä¸ªé‡å¯æˆ–è€…é‡å¤§å˜åŒ–ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘<code>6380</code>å°±æ„Ÿè§‰åˆ°å®ƒåº”è¯¥æ˜¯åšäº†å¾ˆå¤šå˜åŒ–éœ€è¦æŠŠä»–æ•°æ®åŒæ­¥è¿‡æ¥ï¼Œåœ¨6380ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™å®ƒå‹æ ¹ä¸çŸ¥é“<code>6379</code>è¿™ä¸ªç«¯å£å¯¹åº”çš„runidï¼Œå¯¹å®ƒæ¥è¯´æ˜¯ä¸€ä¸ªå…¨æ–°çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å®ƒä¼šè¿›è¡Œä¸€ä¸ªå…¨é‡å¤åˆ¶</p><h2 id="åç§»é‡"><a href="#åç§»é‡" class="headerlink" title="åç§»é‡"></a>åç§»é‡</h2><blockquote><p>æ•°æ®å†™å…¥é‡çš„å­—èŠ‚ï¼Œè®°å½•å†™äº†å¤šå°‘æ•°æ®ï¼Œå¯¹äº6379å»æ‰§è¡Œ<code>set hello</code>ï¼Œå®ƒä¼šæŠŠè¿™ä¸ªå‘½ä»¤åŒæ­¥ç»™6380ï¼Œå®ƒä¹Ÿä¼šè®°å½•è¿™ä¸ªåç§»é‡ï¼Œå°±ç›¸å¯¹äºå†™åç§»é‡ï¼Œå½“è¿™2ä¸ªåç§»é‡è¾¾åˆ°ä¸€è‡´çš„æ—¶å€™ï¼Œè¿™å°±æ˜¯ä¸»ä»æ•°æ®åŒæ­¥çš„è¿‡ç¨‹ã€‚æœ‰ä¸€ç§æƒ…å†µï¼š6379æ¯”6380åç§»é‡å¤§ï¼Œå°±å¯èƒ½å‡ºç°ä¸»ä»ä¸ä¸€è‡´</p></blockquote><p>æŸ¥çœ‹åç§»é‡</p><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication ...master_repl_offset:1597...127.0.0.1:6379&gt; <span class="hljs-built_in">set</span> k1 v1OK127.0.0.1:6379&gt; info replication slave0:ip=127.0.0.1,port=6380,state=online,offset=2111,lag=1 <span class="hljs-comment">#ä»èŠ‚ç‚¹ä¿¡æ¯,è¿™é‡Œåç§»é‡æ˜¯ä¸€è‡´çš„</span>master_repl_offset:2111</code></pre><h2 id="å…¨é‡å¤åˆ¶åˆ†æ"><a href="#å…¨é‡å¤åˆ¶åˆ†æ" class="headerlink" title="å…¨é‡å¤åˆ¶åˆ†æ"></a>å…¨é‡å¤åˆ¶åˆ†æ</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571539767138.png" srcset="/img/loading.gif" alt="1571539767138"></p><p>å¯¹ç»„ä»å¤åˆ¶åšä¸€ä¸ªç®€å•çš„åˆ†æï¼Œå¦‚æœå¯¹ä¸€ä¸ªå­˜äº†å¾ˆå¤šæ•°æ®çš„masterèŠ‚ç‚¹ï¼Œè¿™é‡Œä¸€ä¸ªslaveèŠ‚ç‚¹å»åšä¸€ä¸ªå¤åˆ¶ï¼Œæˆ‘ä»¬æœ€æƒ³è¦ä¸€ä¸ªæŠŠ<code>master</code>å…ˆå‰çš„æ•°æ®æˆ–è€…å½“å‰çš„æ•°åŒæ­¥è¿‡æ¥çš„ï¼ŒåŒæ—¶è¿˜å¸Œæœ›è¿™ä¸ª<code>master</code>åœ¨åŒæ­¥è¿‡ç¨‹æœŸé—´å†™çš„æ•°æ®ä¹ŸåŒæ­¥è¿‡æ¥ï¼Œè¿™æ ·å°±å¯ä»¥è¾¾åˆ°æ•°æ®çš„å®Œå…¨åŒæ­¥çš„æ•ˆæœã€‚åœ¨<code>Redis</code>æä¾›äº†å…¨é‡å¤åˆ¶ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯å®Œæˆä¸Šè¿°çš„è¿‡ç¨‹ï¼Œå®ƒé¦–å…ˆå°†æœ¬èº«<code>RDB</code>æ–‡ä»¶ä¹Ÿå°±æ˜¯å½“å‰çŠ¶æ€å»åŒæ­¥ç»™<code>slave</code>ï¼Œåœ¨æ­¤æœŸé—´å®ƒå†™å…¥çš„å‘½ä»¤ä¼šå•ç‹¬å»è®°å½•èµ·æ¥ï¼Œç„¶åå½“è¿™ä¸ª<code>RDB</code>æ–‡ä»¶åŠ è½½å®Œä¹‹åå®ƒä¼šé€šè¿‡åç§»é‡çš„å¯¹æ¯”ï¼Œå°†è¿™ä¸ªæœŸé—´äº§ç”Ÿçš„å†™å…¥çš„å€¼åŒæ­¥ç»™<code>slave</code>ã€‚å›¾ä¸­è¡¨ç¤ºäº†å¤åˆ¶çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå®ƒå†…éƒ¨æœ‰ä¸€ä¸ª<code>psync</code>å‘½ä»¤æ˜¯ç”¨æ¥åšåŒæ­¥çš„ï¼Œå®é™…ä¸Šå®ƒåœ¨<code>Redis2.8</code>ä¹‹å‰å®ƒæ˜¯å«<code>sync</code>ï¼Œåœ¨è¿™ä¹‹åå°±å«<code>psync</code>äº†ï¼Œå®ƒå¯ä»¥å®Œæˆå…¨é‡å¤åˆ¶å’Œéƒ¨åˆ†å¤åˆ¶åŠŸèƒ½ï¼Œé¦–å…ˆå…ˆä¸ç®¡éƒ¨åˆ†å¤åˆ¶ï¼Œæ¥è¯´ä¸‹å…¨é‡å¤åˆ¶ï¼Œå®ƒæœ‰2ä¸ªå‚æ•°ï¼Œ<code>runidã€åç§»é‡</code>ï¼Œé€šè¿‡è¿™æ¡å‘½ä»¤æŠ¥å‘Šç»™ä¸»èŠ‚ç‚¹è‡ªå·±çš„åç§»é‡æ˜¯å¤šå°‘ï¼Œç„¶åä¸»èŠ‚ç‚¹å¯èƒ½ä¼šæŠŠå¯¹åº”åç§»é‡ä¹‹åçš„æ•°æ®åŒæ­¥ç»™å®ƒï¼Œå¯¹äºæˆ‘ä»¬ç¬¬ä¸€æ¬¡å¤åˆ¶æ¥è¯´çš„é—®é¢˜å°±è¯´ä¸»çš„runidæ˜¯å¤šå°‘ï¼Œè€Œä¸”ä¹Ÿä¸çŸ¥é“åç§»é‡æ˜¯å¤šå°‘ï¼Œåœ¨è¿™é‡Œå‚æ•°ä¼ é€’ä¸ºï¼š<code>? -1</code>ï¼Œmasteræ”¶åˆ°è¿™ä¸ªå‘½ä»¤èƒ½æ„Ÿè§‰å‡ºæ¥ï¼Œä½ æ˜¯è¦åšå…¨é‡å¤åˆ¶çš„ï¼Œå› ä¸ºä½ æ ¹æœ¬ä¸çŸ¥é“æˆ‘æ˜¯è°ï¼Œè€Œä¸”æ²¡æœ‰ä¼ åç§»é‡ï¼Œç°åœ¨masterå°±å‘Šè¯‰ä»èŠ‚ç‚¹ï¼Œæˆ‘çš„runidæ˜¯å¤šå°‘å’Œåç§»é‡æ˜¯å¤šå°‘ï¼Œslaveè¿™ä¸ªæ—¶å€™ä¼šä¿å­˜masterçš„åŸºæœ¬ä¿¡æ¯ï¼Œåœ¨è¿™ä¹‹åmasterä¼šåšä¸€ä¸ªRDBçš„ç”Ÿæˆï¼Œä½¿ç”¨å‰é¢ä»‹ç»çš„<code>bgsave</code>ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¿«ç…§ï¼Œè¿™ä¸ªå¿«ç…§æœ‰ä¸€ä¸ªä¼˜ç‚¹å°±æ˜¯è¯´ç”Ÿæˆè¶Šå¿«è¶Šå¥½ï¼Œä¼ è¾“è¶Šå¿«è¶Šå¥½ï¼Œmasterè¦å°†å…¨é‡æ•°æ®åŒæ­¥ç»™slaveï¼Œç„¶åè¿˜è¦å°†éƒ¨åˆ†æ•°æ®ä¹Ÿå°±æ˜¯RDBå¼€å§‹ç”Ÿæˆåˆ°RDBä¼ è¾“è¿™ä¸ªè¿‡ç¨‹ä¸­ä¸€ä¸ªæ–°å¢å‘½ä»¤è¿›è¡Œä¸€ä¸ªä¿å­˜ï¼Œç„¶ååœ¨RDBåˆ äº†ä¹‹åå°†è¿™äº›å‘½ä»¤ç»™å®ƒä¼ è¾“è¿‡å»ï¼Œåœ¨<code>Redis</code>ä¸­æœ‰ä¸€ä¸ªå¤åˆ¶ç¼“å†²åŒº<code>repl-back-buffer</code>ï¼Œå®ƒå¯ä»¥è®°å½•æœ€æ–°å†™å…¥çš„å‘½ä»¤ï¼Œè¿™æ ·å°±èƒ½å®ç°ä¸Šè¿°çš„æ•ˆæœï¼Œåœ¨åˆ äº†RDBä¹‹åä¼šåšä¸€ä¸ª<code>send buffer</code>,<code>send buffer</code>ä¹‹åå®ƒä¼šæ¸…é™¤è€çš„æ•°æ®ï¼Œç„¶åå°†RDBè¿›è¡ŒåŠ è½½åŒæ—¶å°†bufferä¸­çš„æ•°æ®ä¹ŸåŠ è½½è¿›æ¥ï¼Œè¿™æ ·å°±ä¿è¯<code>master</code>å’Œ<code>slave</code>å®Œå…¨åŒæ­¥ï¼Œè¿™æ ·å°±ä½¿ç”¨äº†æ•°æ®å‰¯æœ¬çš„åŠŸèƒ½ã€‚</p><h2 id="å…¨é‡å¤åˆ¶å¼€é”€"><a href="#å…¨é‡å¤åˆ¶å¼€é”€" class="headerlink" title="å…¨é‡å¤åˆ¶å¼€é”€"></a>å…¨é‡å¤åˆ¶å¼€é”€</h2><ol><li>å› ä¸ºéœ€è¦ä¼ é€’ä¸€ä¸ªRDBï¼Œå®ƒè¦åšbgsaveï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªforkæ“ä½œç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¯¹CPUã€å†…å­˜ã€ç¡¬ç›˜éƒ½ä¼šæœ‰ä¸€å®šå¼€é”€ï¼›</li><li>ç”ŸæˆRDBä¹‹åè¿˜è¦è¿›è¡Œç½‘ç»œä¼ è¾“æ—¶é—´ï¼›</li><li>ä»èŠ‚ç‚¹æ¸…ç©ºæ•°æ®æ—¶é—´ï¼Œå¦‚æœä»èŠ‚ç‚¹ä¹‹å‰æœ‰å¾ˆå¤šæ•°æ®ï¼Œæ¸…ç©ºä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ï¼›</li><li>ä»èŠ‚ç‚¹åŠ è½½RDBçš„æ—¶é—´ï¼›</li><li>å¦‚æœåœ¨åšä¸»ä»å…¨é‡å¤åˆ¶æœ€åä¸€æ­¥åŠ è½½RDBæˆåŠŸä¹‹åï¼Œå¦‚æœæˆ‘ä»¬AOFå¼€å¯çš„è¯ï¼Œå®ƒä¼šæ‰§è¡ŒAOFé‡å†™ï¼Œè¿™æ ·ä¿è¯AOFæ˜¯æœ€æ–°çš„çŠ¶æ€ã€‚</li></ol><h2 id="éƒ¨åˆ†å¤åˆ¶"><a href="#éƒ¨åˆ†å¤åˆ¶" class="headerlink" title="éƒ¨åˆ†å¤åˆ¶"></a>éƒ¨åˆ†å¤åˆ¶</h2><p>åˆ†æä¸€ä¸‹å…¨é‡å¤åˆ¶æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä¸Šé¢æè¿°çš„å¼€é”€ä»¥å¤–ï¼Œå®ƒä¼šæœ‰ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¯´ï¼Œå‡å¦‚masterå’Œslaveçš„ç½‘ç»œå‘ç”Ÿäº†èµ°åŠ¨ï¼Œä¸€æ®µæ—¶é—´å†…è¿™äº›æ•°æ®å°±ä¼šè¿›è¡Œä¸¢å¤±ï¼Œå¯¹äºslaveæ¥è¯´è¿™æ®µæ—¶é—´masteræ›´æ–°æ•°æ®å®ƒä¸çŸ¥é“ï¼Œæœ€ç®€å•çš„è§£å†³åŠæ³•å°±æ˜¯åœ¨åšä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œåœ¨<code>Redis2.8</code> ä¹‹å‰æ˜¯è¿™ä¹ˆåšçš„ï¼Œå¾ˆæ˜¾ç„¶å‰é¢åˆ†æäº†å…¨é‡å¤åˆ¶çš„ä¸€ä¸ªå¼€é”€ï¼Œå…¶å®å®ƒæœ‰å„ç§é—®é¢˜ï¼Œå› ä¸ºæœ¬èº«åœ¨åšä¸€ä¸ªç”Ÿæˆå­è¿›ç¨‹ã€ä¼ è¾“RDBï¼Œä½†åœ¨å•æœºå¤šéƒ¨ç½²çš„è¯ï¼Œä½ åšçš„èµ„æºéš”ç¦»åœ¨å¥½ï¼Œå¾ˆå¤šèµ„æºæ˜¯æ— æ³•åšåˆ°éš”ç¦»çš„ï¼Œæ‰€ä»¥åœ¨<code>Redis2.8</code>ä¸­æä¾›äº†éƒ¨åˆ†å¤åˆ¶åŠŸèƒ½ï¼Œå¸Œæœ›å¦‚æœå‘ç”Ÿç±»ä¼¼æŠ–åŠ¨çš„æ—¶å€™ï¼Œå¯ä»¥æœ‰ä¸€ç§æœºåˆ¶å°†è¿™ä¸ªæŸå¤±é™ä½åˆ°æœ€ä½ï¼Œå›¾ä¸­æè¿°äº†å®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼š</p><p>å¦‚æœå®ƒä»¬ä¹‹é—´å‘ç”Ÿäº†æŠ–åŠ¨ï¼Œç›¸å¯¹äºè¿æ¥æ–­å¼€äº†ï¼Œä½†æ˜¯åœ¨masterå†™å‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒä¼šå†™ä¸€ä»½å¤åˆ¶ç¼“å†²åŒºçš„å‘½ä»¤ï¼Œå½“slaveåœ¨å»è¿æ¥masterçš„æ—¶å€™ä¹Ÿå°±è¿™ç½‘ç»œæŠ–åŠ¨ç»“æŸä¹‹åï¼Œå®ƒä¼šè¿›è¡Œä¸€æ¡<code>pysnc {offset} {runid}</code>å‘½ä»¤ï¼Œå°±æ˜¯æŠŠè‡ªå·±å½“å‰çš„åç§»é‡ä¼ è¾“ç»™masterè¿˜è¦ç»™ä¸€ä¸ª<code>runid</code>ï¼Œå°±ç›¸å¯¹äºslaveæƒ³å¯¹masterå»æ‰§è¡Œä¸€ä¸ª<code>psync</code>å‘½ä»¤ï¼Œå‘Šè¯‰masterå½“å‰è‡ªå·±çš„offsetæ˜¯å¤šå°‘ï¼Œå¦‚æœmasterå‘ç°ä½ ä¼ è¾“çš„åç§»é‡æ˜¯åœ¨å®ƒbufferèŒƒå›´å†…çš„ï¼Œå®ƒè¿™ä¸ªbufferç›¸å¯¹äºä¸€ä¸ªå¯¹åˆ—æœ‰ä¸€ä¸ªæœ€å¼€å§‹å’Œæœ€åä¸€åçš„<code>offset</code>ï¼Œå¦‚æœslaveçš„<code>offset</code>ä¸åœ¨è¿™ä¸ªæœŸé—´å†…å°±è¯æ˜slaveé”™è¿‡äº†å¾ˆå¤šæ•°æ®ï¼Œæ¯•ç«Ÿå®ƒçš„bufferæ˜¯æœ‰é™çš„ï¼Œå®ƒçš„bufferé»˜è®¤æ˜¯<code>1M</code>ï¼Œé€šå¸¸ä¸ºäº†ä¿è¯å…¨é‡ å¤åˆ¶çš„æˆåŠŸï¼Œå¦‚æœæˆ‘ä»¬æŠŠå®ƒé…ç½®å¾ˆå¤§ï¼Œè¿™æ ·å®ƒå¯ä»¥åœ¨ä¸€ä¸ªå¾ˆå¤§çš„èŒƒå›´å†…è¿›è¡Œä¿å­˜ï¼Œè¿™æ ·<code>offset</code>çš„å‘½ä¸­ç‡ä¼šå¾ˆé«˜ï¼Œå°±å¯ä»¥è¿›è¡Œä¸€ä¸ªå…¨é‡å¤åˆ¶ï¼Œå½“å®ƒå‘ç”Ÿä½ çš„offsetåœ¨å®ƒçš„èŒƒå›´å†…å®ƒä¼šè¿”å›<code>continue</code>,å®ƒä¼šä»bufferå¯¹åˆ—ä¸­ä»offsetå¼€å§‹åˆ°ç»“å°¾ä¸€ä¸ªæ•°æ®å…¨éƒ¨ç»™<code>slave</code>ï¼Œè¿™æ ·çš„è¯<code>master</code>å’Œ<code>slave</code>å°±è¾¾åˆ°äº†ä¸€ä¸ªä¸€è‡´ï¼Œåé¢çš„å†™å‘½ä»¤ä¹Ÿä¼šå…¨éƒ¨åŒæ­¥è¿‡æ¥è¾¾åˆ°ä¸€ä¸ªæ•°æ®å‰¯æœ¬è€Œæœ‰æ•ˆé™ä½äº†å…¨é‡å¤åˆ¶çš„å¼€é”€</p><h1 id="å¼€å‘è¿ç»´å¸¸è§é—®é¢˜"><a href="#å¼€å‘è¿ç»´å¸¸è§é—®é¢˜" class="headerlink" title="å¼€å‘è¿ç»´å¸¸è§é—®é¢˜"></a>å¼€å‘è¿ç»´å¸¸è§é—®é¢˜</h1><h2 id="è¯»å†™åˆ†ç¦»"><a href="#è¯»å†™åˆ†ç¦»" class="headerlink" title="è¯»å†™åˆ†ç¦»"></a>è¯»å†™åˆ†ç¦»</h2><ol><li>è¯»å†™åˆ†ç¦»ï¼šè¯»æµé‡åˆ†æ‘Šåˆ°ä»èŠ‚ç‚¹ï¼›</li><li>å¯èƒ½é‡åˆ°é—®é¢˜ï¼š<ul><li>å¤åˆ¶æ•°æ®å»¶è¿Ÿï¼šå¯¹äºå¤§å¤šæƒ…å†µä¸‹å»å†™ä¸€ä¸ªmasterï¼Œå®ƒä¼šåšä¸€ä¸ªå¼‚æ­¥åŒæ­¥ï¼Œå°†è¿™ä¸ªæ•°æ®å¤åˆ¶ç»™slaveï¼Œè¿™æœ¬èº«ä¼šæœ‰ä¸€ä¸ªæ—¶é—´å·®ï¼Œè€Œä¸”å½“masterå‘ç”Ÿé˜»å¡çš„æ—¶å€™ï¼Œå®ƒä¼šå»¶è¿Ÿæ¥å—è¿™æ¡å†™çš„å‘½ä»¤ï¼Œç„¶åå¯èƒ½ä¼šå‘ç”Ÿä¸€äº›è¯»å†™ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå¯¹äºå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿˜æ˜¯ä¸ç”¨è€ƒè™‘è¯»å†™ åˆ†ç¦»æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜çš„ï¼Œå¦‚æœä¸ºäº†é˜²æ­¢è¿™æ ·çš„é—®é¢˜ï¼Œä½ å¯ä»¥å¯¹åç§»é‡åšç›‘æ§ï¼Œå½“ç›‘æ§åˆ°æœ‰é—®é¢˜çš„æ—¶å€™åšä¸€äº›å¤„ç†ï¼Œä¾‹å¦‚åˆ‡æ¢åˆ°masterä¸Šï¼›</li><li>è¯»åˆ°è¿‡æœŸæ•°æ®ï¼šRedisåˆ é™¤è¿‡æœŸæ•°æ®æœ‰2ç§ç­–ç•¥ï¼š<ul><li>å®ƒå»æ“ä½œkeyçš„æ—¶å€™ï¼Œå®ƒæ‰å»çœ‹keyæœ‰æ²¡æœ‰è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸäº†å°±å°†å®ƒåˆ é™¤ï¼Œç„¶åå†è¿”å›ç»™å®¢æˆ·ç«¯ç©ºçš„æ“ä½œï¼›</li><li>å®ƒä¼šæœ‰ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯æ¬¡å»é‡‡é›†ä¸€äº›keyï¼Œçœ‹å®ƒæœ‰æ²¡æœ‰è¿‡æœŸï¼Œè¿™å°±ä¼šç…§æˆä¸€ç§æƒ…å†µï¼Œå½“è¿‡æœŸæ•°é‡éå¸¸å¤šï¼Œè€Œä¸”é‡‡é›†é€Ÿåº¦æ ¹æœ¬æ¯”ä¸ä¸Šè¿‡æœŸæ•°æ®çš„äº§ç”Ÿé€Ÿåº¦çš„æ—¶å€™å°±ä¼šé€ æˆå¾ˆå¤šè¿‡æœŸæ•°æ®æ²¡æœ‰åˆ é™¤ï¼Œä½†æ˜¯Redisä¸­masterå’Œslaveæ˜¯è¾¾æˆè¿™æ ·ä¸€ä¸ªçº¦å®šçš„ï¼šslaveèŠ‚ç‚¹æ˜¯ä¸èƒ½å¤„ç†æ•°æ®çš„ï¼Œå°±ä¼šé€ æˆslaveå¯èƒ½ä¼šè¯»åˆ°è„çš„æ•°æ®ï¼Œä¾‹å¦‚clientæ²¡æœ‰åŠæ—¶å°†è¿‡æœŸæ•°æ®æ‰¾åˆ°ç„¶åæŠŠè¿™ä¸ªåˆ é™¤å‘½ä»¤åŒæ­¥ç»™slaveçš„æ—¶å€™ï¼Œå› ä¸ºslaveæ²¡æœ‰åˆ é™¤æ•°æ®çš„æƒé™æ‰€ä»¥ä¸ä¼šå°†è¿‡æœŸæ•°æ®åˆ é™¤ï¼Œå°±ä¼šé€ æˆslaveå»è¯»åˆ°è¿‡æœŸæ•°æ®ï¼Œä½†åœ¨<code>Redis3.2</code>ä¸­å·²ç»è§£å†³äº†è¿™æ ·çš„é—®é¢˜ã€‚</li></ul></li><li>ä»èŠ‚ç‚¹æ•…éšœï¼šå¦‚æœä»èŠ‚ç‚¹å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œæ€ä¹ˆå°†ä»èŠ‚ç‚¹çš„å®¢æˆ·ç«¯è¿›è¡Œä¸€ä¸ªè¿ç§»ï¼Œå®ƒçš„æˆæœ¬æ˜¯éå¸¸é«˜çš„ï¼Œä½ å¯ä»¥ç”¨ä¸€äº›æ‰‹æ®µæ¥è§£å†³ã€‚ä½ åœ¨è€ƒè™‘ä½¿ç”¨è¯»å†™åˆ†ç¦»ä¹‹å‰é¦–å…ˆè¦è€ƒè™‘å¦‚ä½•å»ä¼˜åŒ–ä¸»èŠ‚ç‚¹ï¼Œå› ä¸ºRedisçš„æ€§èƒ½æ˜¯éå¸¸é«˜çš„ï¼Œå¤§éƒ¨åˆ†åœºæ™¯åŸºæœ¬ä¸Šæ˜¯å¯ä»¥æ»¡è¶³çš„ï¼Œä½ å¯ä»¥ä¼˜åŒ–ä¸€äº›å†…å­˜çš„å‚æ•°ã€AOFçš„ç­–ç•¥è¿™äº›ä¸œè¥¿ï¼Œç„¶åå½“æˆ‘ä»¬å®åœ¨ä¸è¡Œçš„è¯å¯ä»¥è€ƒè™‘è¯»å†™åˆ†ç¦»ï¼›è¿™ä¸ªæ—¶å€™ä½ å¯ä»¥å»ä½¿ç”¨<code>Redis</code>å®˜æ–¹çš„ä¸€äº›åˆ†å¸ƒå¼<code>Redis Cluster</code>åŒ…æ‹¬å…¶ä»–å¼€æºçš„åˆ†å¸ƒå¼æ–¹æ¡ˆæ¥è§£å†³ç±»ä¼¼çš„é—®é¢˜ï¼›</li></ul></li></ol><h2 id="é…ç½®ä¸ä¸€è‡´"><a href="#é…ç½®ä¸ä¸€è‡´" class="headerlink" title="é…ç½®ä¸ä¸€è‡´"></a>é…ç½®ä¸ä¸€è‡´</h2><ol><li>ä¾‹å¦‚maxmemoryä¸ä¸€è‡´ï¼šä¸¢å¤±æ•°æ®ï¼Œä¾‹å¦‚ä¸»èŠ‚ç‚¹é…ç½®<code>4G</code>ï¼Œä»èŠ‚ç‚¹é…ç½®<code>2G</code>ï¼Œè¿™æ ·åšä¸»ä»å¤åˆ¶æ˜¯å¯ä»¥æ­£å¸¸è¿›è¡Œçš„ï¼Œå…¨é‡å¤åˆ¶å¯ä»¥è¿›è¡Œï¼Œ<code>master</code>ä¼ è¾“RDBç»™<code>slave</code>ï¼Œç„¶ååŠ è½½ä¹‹åå‘ç°å®ƒè¿‡å¤§ï¼Œç„¶åå®ƒå°±ä¼šè§¦å‘å®ƒè‡ªå·±çš„<code>maxmemory policy</code>ä¹Ÿå°±æ˜¯æœ€å¤§å†…å­˜çš„è§¦å‘ç­–ç•¥ï¼Œå°†æ•°æ®è¿›è¡Œæ·˜æ±°ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰å¯èƒ½ä¼šäº§ç”ŸOAMé‚£æ ·çš„é—®é¢˜ï¼Œå‡å¦‚è¿™é‡Œè¿‡æœŸæ•°æ®æ¯”è¾ƒå¤šå°±æ˜¯è®¾ç½®TTLçš„æ•°æ®æ¯”è¾ƒå¤šï¼Œé‚£ä¹ˆ<code>maxmemory policy</code>çš„ä¸€ä¸ªè¿‡æœŸç­–ç•¥ä»¥å‰”é™¤è¿™ä¸ªè¿‡æœŸæ•°æ®ä¸ºä¼˜å…ˆçš„ç­–ç•¥ï¼Œé‚£ä¹ˆè¿‡æœŸæ•°æ®å°±ä¼šè¢«å‰”é™¤ï¼Œè¿™é‡Œå¯¹äºæ•°æ®æ¥è¯´å®ƒå·²ç»ä¸æ˜¯ä¸€ä¸ªå®ç°æ•°æ®å‰¯æœ¬çš„åŠŸèƒ½äº†ï¼Œä½†æ˜¯å®ƒä¹Ÿä¸ä¼šæŠ¥ä»»ä½•é”™è¯¯ã€‚å½“æˆ‘ä»¬åœ¨åšä¸€äº›ç±»ä¼¼äºé«˜å¯ç”¨çš„æ—¶å€™ï¼Œéœ€è¦å°†ä»èŠ‚ç‚¹å˜æˆä¸»èŠ‚ç‚¹çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°æ•°æ®å·²ç»ä¸¢å¤±äº†ï¼Œè€Œä¸”å·²ç»æ— æ³•æŒ½å›äº†ï¼Œè¿™é‡Œé¿å…è¿™ç§æƒ…å†µå¯ä»¥ä½¿ç”¨ä¸€äº›æ ‡å‡†çš„å·¥å…·è¿›è¡Œå®‰è£…å¹¶ä¸”åšä¸€ä¸ªç›‘æ§ï¼›</li><li>ä¾‹å¦‚æ•°æ®ç»“æ„ä¼˜åŒ–å‚æ•°ï¼ˆä¾‹å¦‚hash-max-ziplist-entriesï¼‰ï¼šå†…å­˜ä¸ä¸€è‡´ï¼›</li></ol><h2 id="è§„é¿å…¨é‡å¤åˆ¶"><a href="#è§„é¿å…¨é‡å¤åˆ¶" class="headerlink" title="è§„é¿å…¨é‡å¤åˆ¶"></a>è§„é¿å…¨é‡å¤åˆ¶</h2><blockquote><p>å‰é¢å·²ç»æåˆ°å…¨é‡å¤åˆ¶çš„å¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹å¦‚ä½•å»é¿å…è¿™æ ·çš„é—®é¢˜ã€‚</p></blockquote><ol><li>ç¬¬ä¸€æ¬¡å…¨é‡å¤åˆ¶<ul><li>ç¬¬ä¸€æ¬¡ä¸å¯é¿å…ï¼›</li><li>å°ä¸»èŠ‚ç‚¹ã€ä½å³°ï¼š<code>maxmemory</code>ä¸è¦è®¾ç½®è¿‡å¤§ï¼Œè¿™æ ·æˆ‘ä»¬ä¸€ä¸ªbgsaveã€ä¼ è¾“ã€åŠ è½½éƒ½ä¼šå¾ˆå¿«ï¼Œ è€Œä¸”å¼€é”€ä¹Ÿèƒ½å‡å°ï¼Œè¿˜æœ‰ä¸€ç§å¤„ç†æ–¹å¼ï¼Œåœ¨å¤œé—´è®¿é—®é‡ä½çš„æ—¶å€™æ•´ä¸ªRedisé›†ç¾¤æˆ–è€…Rediså¯¹åº”çš„æœºå™¨è´Ÿè½½æ¯”è¾ƒä½çš„æ—¶å€™æˆ‘ä»¬æ¥åšè¿™æ ·çš„æ“ä½œæ¥é¿å…é—®é¢˜ã€‚</li></ul></li><li>èŠ‚ç‚¹è¿è¡ŒIDä¸åŒ¹é…<ul><li>ä¸»èŠ‚ç‚¹é‡å¯ï¼ˆè¿è¡ŒIDå˜åŒ–ï¼‰ï¼šå¯¹äºslaveæ¥è¯´ï¼Œå®ƒä¼šä¿å­˜ä¹‹å‰ä¸»èŠ‚ç‚¹çš„<code>runid</code>ï¼Œå¦‚æœå®ƒå‘ç°<code>runid</code>å‘ç”Ÿå˜åŒ–ï¼Œå®ƒå°±ä¼šè®¤ä¸ºè¿™ä¸ªæ•°æ®å¯èƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œå®ƒè®¤ä¸ºå½“å‰masteræ˜¯ä¸å®‰å…¨çš„ï¼Œå› ä¸ºslaveæ— æ³•çŸ¥é“masteræ˜¯è°ï¼Œæœ€ç®€å•çš„æ–¹å¼å°±æ˜¯åšä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œè¿™ä¸ªæš‚æ—¶æ˜¯æ— æ³•é¿å…çš„ï¼Œåœ¨<code>Redis4.0</code>ä¸­å®ƒæä¾›äº†<code>PSYNC  2</code>è§„åˆ™å¯ä»¥æœ‰æ•ˆè§£å†³è¿™ç±»é—®é¢˜ï¼Œå°±æ˜¯è¯´å¦‚æœrunidå‘ç”Ÿå˜åŒ–ï¼Œå®ƒåšä¸€ä¸ªæ•…éšœè½¬ç§»çš„æ—¶å€™å¯ä»¥æœ‰æ•ˆé¿å…å…¨é‡å¤åˆ¶ï¼›</li><li>æ•…éšœè½¬ç§»ï¼Œä¾‹å¦‚å“¨å…µæˆ–é›†ç¾¤ã€‚</li></ul></li><li>å¤åˆ¶ç§¯å‹ç¼“å†²åŒºä¸è¶³<ul><li>ç½‘è·¯ä¸­æ–­ï¼Œéƒ¨åˆ†å¤åˆ¶æ— æ³•æ»¡è¶³ï¼šå°†æœ€æ–°çš„å†™å…¥å‘½ä»¤å†™å…¥åˆ°ç¼“å†²åŒºï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹åˆ—ï¼Œå®ƒçš„ä¸€ä¸ªé»˜è®¤å€¼æ˜¯<code>1M</code>ï¼Œå¦‚æœå‘ç”Ÿç½‘ç»œæŠ–åŠ¨çš„æƒ…å†µä¸‹å°±å¯ä»¥ä½¿ç”¨éƒ¨åˆ†å¤åˆ¶ï¼Œå¦‚æœä½ çš„slaveåç§»é‡æ˜¯åœ¨ç¼“å†²åŒºçš„èŒƒå›´å†…é‚£ä¹ˆå°±å¯ä»¥å®Œæˆéƒ¨åˆ†å¤åˆ¶ï¼Œæœ‰æ•ˆé¿å…å…¨é‡å¤åˆ¶çš„é—®é¢˜ï¼Œå½“ç„¶å¦‚æœslaveçš„offsetæ˜¯åœ¨è¿™ä¸ªä¹‹å¤–ï¼Œé‚£ä¹ˆå°±æ²¡åŠæ³•ï¼Œåªèƒ½åšä¸€æ¬¡å…¨é‡å¤åˆ¶äº†ï¼Œå½“ç„¶æ¯”è¾ƒç®€å•çš„æ–¹æ³•å°±æ˜¯ä½ å¯ä»¥æŠŠè¿™ä¸ªç¼“å†²åŒºå»è°ƒå¤§ä¸€ç‚¹ï¼›</li><li>å¢å¤§å¤åˆ¶ç¼“å†²åŒºè®¾ç½®<code>rel-backlog-size</code>ï¼Œç½‘ç»œâ€œå¢å¼ºâ€ï¼Œä¾‹å¦‚è®¾ç½®ä¸º10Mæ¥é™ä½å…¨é‡å¤åˆ¶å¯èƒ½äº§ç”Ÿçš„æƒ…å†µï¼Œæœ‰ä¸€ç§æ¯”è¾ƒç§‘å­¦çš„æ–¹æ³•ä½ å¯ä»¥è¿™ä¹ˆå»ç®—ï¼Œå‡è®¾ä¸€èˆ¬çš„ç½‘ç»œçš„ä¸€ä¸ªæ–­å¼€æ—¶é—´æˆ–è€…äº§ç”Ÿæ•…éšœæ—¶é—´å¯èƒ½æ˜¯åˆ†é’Ÿçº§åˆ«çš„ï¼Œé‚£æˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬å½“å‰çš„QPSå†™çš„æ•°é‡ï¼Œç»Ÿè®¡æ¯åˆ†é’Ÿæœ‰å¤šå°‘å­—èŠ‚ï¼Œç„¶åå†ä¹˜ä»¥ä½ å¯¹åº”çš„å‘ç”Ÿæ•…éšœçš„åˆ†é’Ÿï¼Œè¿™ä¸ªå°±æ˜¯å¤åˆ¶ç¼“å†²åŒºç†æƒ³çš„å€¼ã€‚</li></ul></li></ol><h2 id="é¿å…-å¤åˆ¶é£æš´"><a href="#é¿å…-å¤åˆ¶é£æš´" class="headerlink" title="é¿å… å¤åˆ¶é£æš´"></a>é¿å… å¤åˆ¶é£æš´</h2><h3 id="å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´"><a href="#å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´" class="headerlink" title="å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´"></a>å•ä¸»èŠ‚ç‚¹å¤åˆ¶é£æš´</h3><ul><li>é—®é¢˜ï¼šä¸»èŠ‚ç‚¹é‡å¯ï¼Œå¤šä»èŠ‚ç‚¹å¤åˆ¶ï¼šå‡å¦‚è¯´ä¸€ä¸ªmasterèŠ‚ç‚¹æŒ‚äº†å¾ˆå¤šä»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆmasterèŠ‚ç‚¹æŒ‚äº†ä¹‹åé‡å¯ï¼Œè¿™ä¸ªæ—¶å€™æ‰€æœ‰slaveèŠ‚ç‚¹éƒ½è¦åšä¸€ä¸ªä¸»ä»å¤åˆ¶ï¼Œå› ä¸ºå®ƒçš„runidå·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™é‡Œçš„å¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œé¦–å…ˆè¦å°†RDBç”Ÿæˆï¼Œç„¶åè¿›è¡Œä¼ è¾“ï¼Œå½“ç„¶å¯¹äºRedisæ¥è¯´å®ƒæœ‰æ•ˆå»ä¼˜åŒ–äº†è¿™ä¸ªä¸œè¥¿ï¼Œå®ƒå¯ä»¥åªç”Ÿæˆä¸€ä»½RDBæ–‡ä»¶ï¼Œä½†æ˜¯å®ƒè¦åšå¤šæ¬¡ä¼ è¾“ï¼Œæ•´ä¸ªè¿‡ç¨‹æ˜¯å¯¹CPUã€å†…å­˜ã€ç½‘ç»œã€ç¡¬ç›˜éƒ½ä¼šæœ‰ä¸€å®šå¼€é”€ï¼›</li><li>è§£å†³ï¼šæ›´æ¢å¤åˆ¶æªæ–½<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571544297928.png" srcset="/img/loading.gif" alt="1571544297928" style="zoom: 33%;" />ï¼Œç›¸å¯¹äºmasteræŒ‚ä¸€ä¸ªslaveï¼Œslaveè¿˜æŒ‚slaveï¼Œè¿™æ ·masteræ¥è¯´ï¼Œå®ƒèƒ½å‡è½»å‹åŠ›ï¼Œè¿™æ ·æŠŠæ‰€æœ‰é—®é¢˜éƒ½æ§åˆ¶åœ¨slave1èŠ‚ç‚¹ä¸Šï¼Œè¿™æ ·æœ‰æ•ˆå‡å°‘masterèŠ‚ç‚¹ä¸€ä¸ªè´Ÿè½½ï¼Œä½†æ˜¯è¿™ç§æ¶æ„è¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œè¿™ç§æ¶æ„å¯ä»¥ç§°ä¸ºæ ‘å½¢æ¶æ„ï¼Œå®ƒæœ‰ä¸€ä¸ªé—®ï¼šå‡å¦‚ä½ åœ¨åšè¯»å†™åˆ†ç¦»çš„æ—¶å€™ï¼Œslave1å‡ºç°äº†é—®é¢˜ï¼Œä½ æ€ä¹ˆå»å¤„ç†ï¼Œè¿˜æœ‰åœ¨é«˜å¯ç”¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹æ€ä¹ˆå»è¿›è¡Œä¸€ä¸ªæ•…éšœè½¬ç§»è¿™äº›éƒ½æ˜¯ä¸€äº›é—®é¢˜ï¼Œè¿™ä¸ªè¦æ ¹æ®ä¸šåŠ¡åœºæ™¯æ¥è¿›è¡Œåˆ¤æ–­ï¼›</li></ul><h3 id="å•æœºå™¨å¤åˆ¶é£æš´"><a href="#å•æœºå™¨å¤åˆ¶é£æš´" class="headerlink" title="å•æœºå™¨å¤åˆ¶é£æš´"></a>å•æœºå™¨å¤åˆ¶é£æš´</h3><p>å¦‚æœä½ åªæƒ³åšä¸€ä¸ªé«˜å¯ç”¨ï¼Œè€Œä¸åšä¸€ä¸ªè¯»å†™åˆ†ç¦»çš„è¯ï¼Œä¸€ä¸ªèŠ‚ç‚¹å°±å¤Ÿäº†ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœå‡ºç°é—®é¢˜å°±å°†å®ƒå»æ™‹å‡ï¼Œç„¶åç»™å®ƒè‡ªåŠ¨åŠ ä¸€ä¸ªslaveå°±å¥½äº†</p><ul><li><p>é—®é¢˜ï¼šå¦‚å³å›¾ï¼šæœºå™¨å®•æœºåï¼Œå¤§é‡å…¨é‡å¤åˆ¶<img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571544649954.png" srcset="/img/loading.gif" alt="1571544649954" style="zoom: 33%;" />ï¼Œå‡å¦‚æˆ‘ä»¬æœºå™¨ä¸Šå…¨éƒ½æ˜¯masterï¼Œç„¶åæœºå™¨å‘ç”Ÿäº†é‡å¯ï¼Œè¿™ä¸ªæ—¶å€™å°±æ˜¯ä¸€ä¸ªç¾éš¾ï¼Œç›¸å½“äºæ‰€æœ‰slaveéƒ½å»æ‹‰è¿™å°æœºå™¨çš„å…¨é‡å¤åˆ¶ï¼Œé‚£æ ·çš„å¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™æ‰€æœ‰èŠ‚ç‚¹éƒ½è¦åš<code>bgsave</code>ï¼Œç„¶åæ‰€ä»¥èŠ‚ç‚¹éƒ½è¦ä¼ è¾“ä¸€ä»½<code>RDB</code>åˆ°ç›¸åº”çš„æœºå™¨ï¼Œæ— è®ºæ˜¯CPUã€å¸¦å®½éƒ½æ˜¯å·¨å¤§çš„å¼€é”€ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ± æ»¡çš„æƒ…å†µï¼›</p></li><li><p>è§£å†³ï¼šä¸»èŠ‚ç‚¹åˆ†æ•£å¤šæœºå™¨ï¼šåœ¨éƒ¨ç½²çš„æ—¶å€™æˆ‘ä»¬è‡ªå·±å»å†™ä¸€äº›éƒ¨ç½²ç¨‹åºçš„æ—¶å€™ä¼šåˆ»æ„å°†masteråˆ†å¸ƒåˆ°ä¸åŒæœºå™¨ä¸Šï¼Œè¿™æ ·æœ‰æ•ˆå»é¿å…é—®é¢˜ï¼›è¿˜è¦ä¸€ç§å¥½çš„æ–¹æ³•ï¼šå¦‚æœå‡ºç°ç±»ä¼¼é—®é¢˜æˆ‘ä»¬å®Œå…¨å¯ä»¥é‡‡ç”¨é«˜å¯ç”¨çš„æ¶æ„ï¼ŒmasteræŒ‚æ‰ä¹‹åslaveæ™‹å‡æˆmasterï¼Œè¿™æ ·çš„è¯å®ƒå°±ä¸ä¼šæœ‰ç±»ä¼¼çš„é—®é¢˜äº†ã€‚</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 5.å¸¸è§çš„æŒä¹…åŒ–å¼€å‘è¿ç»´é—®é¢˜</title>
    <link href="/redis-5.html"/>
    <url>/redis-5.html</url>
    
    <content type="html"><![CDATA[<h1 id="forkæ“ä½œ"><a href="#forkæ“ä½œ" class="headerlink" title="forkæ“ä½œ"></a>forkæ“ä½œ</h1><h2 id="åŒæ­¥æ“ä½œ"><a href="#åŒæ­¥æ“ä½œ" class="headerlink" title="åŒæ­¥æ“ä½œ"></a>åŒæ­¥æ“ä½œ</h2><ul><li>æäº¤<code>bgsave</code>ã€<code>bgrewriteaof</code>å‘½ä»¤æ—¶ä¼šæ‰§<code>fork</code>æ“ä½œï¼Œ<code>fork</code>æ“ä½œåªæ˜¯åšä¸€ä¸ªå†…å­˜é¡µçš„æ‹·è´ï¼Œè€Œä¸æ˜¯åšä¸€ä¸ªå†…å­˜çš„æ‹·è´ï¼Œæ‰€ä»¥åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹é€Ÿåº¦æ˜¯éå¸¸å¿«çš„ï¼Œä½†æ˜¯å¦‚æœæœ¬èº«è¿™ä¸ª<code>fork</code>æ“ä½œæ¯”è¾ƒæ…¢ï¼Œæˆ–è€…è¯´å¡åœ¨æŸä¸€ä¸ªåœ°æ–¹ï¼Œé‚£ä¹ˆå®ƒä¼šå¡åœ¨<code>Redis</code>çš„ä¸»çº¿ç¨‹ï¼›</li><li><code>fork</code>æ“ä½œçš„æ‰§è¡Œæ—¶é—´å’Œå†…å­˜çš„é‡æœ‰å…³ç³»ï¼Œå†…å­˜é‡è¶Šå¤§å†…å­˜é¡µçš„æ•°æ®ä¹Ÿä¼šè¾ƒå¤§ï¼Œè€Œä¸”å’Œæœºå‹æœ‰å…³ï¼Œè™šæœºã€ç‰©ç†æœºè¿˜æœ‰ç•¥æœ‰ä¸åŒï¼Œè™šæœºå°±ä¼šæ…¢ä¸€äº›ï¼Œè¿™é‡Œå¦‚æœæ‰§è¡Œæ—¶é—´éœ€è¦1ç§’ï¼Œå¯¹äº<code>Redis</code>æ¥è¯´å°±ä¼šå¡ä½ä¸€ç§’ï¼Œå¯¹äºæ¯ç§’æ‰§è¡ŒQPSä¸Šä¸‡çš„åº”ç”¨ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå¡ä¸€ç§’ï¼Œå¦‚æœä½ çš„è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡ä¸‹å°±ä¼šé€ æˆå®¢æˆ·ç«¯è¶…æ—¶ï¼›</li><li>infoï¼š<code>latest_fork_user</code>æŸ¥çœ‹ä¸Šä¸€æ¬¡æ‰§è¡Œforkçš„å¾®å¦™æ•°ï¼Œå¦‚æœè¿™ä¸ªæ•°æ¯”è¾ƒå¤§å¯èƒ½ä¼šé˜»å¡<code>Redis</code>ï¼Œéœ€è¦åšä¸€äº›é‡ç‚¹å…³æ³¨å¯ä»¥åšä¸€äº›ç›‘æ§ï¼›</li></ul><h2 id="æ”¹å–„fork"><a href="#æ”¹å–„fork" class="headerlink" title="æ”¹å–„fork"></a>æ”¹å–„fork</h2><ul><li>ä¼˜å…ˆä½¿ç”¨ç‰©ç†æœºæˆ–è€…é«˜æ•ˆæ”¯æŒ<code>fork</code>æ“ä½œçš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼›</li><li>æ§åˆ¶<code>Redis</code>å®ä¾‹æœ€å¤§å¯ç”¨å†…å­˜ï¼š<code>maxmemory</code>ï¼›</li><li>åˆç†é…ç½®Linuxå†…å­˜åˆ†é…ç­–ç•¥ï¼š<code>vm.overcommit_memory=1</code>ï¼›<a href="https://blog.csdn.net/houjixin/article/details/46412557" target="_blank" rel="noopener">ï¼ˆä»‹ç»ï¼‰</a>ï¼Œåœ¨Linuxä¸­é»˜è®¤æ˜¯0ï¼Œå½“å®ƒå‘ç°æ²¡æœ‰è¶³å¤Ÿå†…å­˜å»åšå†…å­˜åˆ†é…çš„æ—¶å€™ï¼Œå®ƒå°±ä¸å»åˆ†é…ï¼Œå¯¹äº<code>fork</code>æ¥è¯´ï¼Œå®ƒä¼šé€ æˆ<code>fork</code>çš„é˜»å¡ï¼Œå¦‚æœå¸Œæœ›<code>fork</code>ä¸ä¼šé˜»å¡å°†å®ƒè®¾ç½®ä¸º1ï¼›</li><li>é™ä½<code>fork</code>é¢‘ç‡ï¼šä¾‹å¦‚æ”¾å®½<code>AOF</code>é‡å†™è‡ªåŠ¨è§¦å‘æœºåˆ¶ï¼Œä¸å¿…è¦çš„å…¨é‡å¤åˆ¶ï¼›</li></ul><h1 id="å­è¿›ç¨‹å¼€é”€å’Œä¼˜åŒ–"><a href="#å­è¿›ç¨‹å¼€é”€å’Œä¼˜åŒ–" class="headerlink" title="å­è¿›ç¨‹å¼€é”€å’Œä¼˜åŒ–"></a>å­è¿›ç¨‹å¼€é”€å’Œä¼˜åŒ–</h1><h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><h3 id="å¼€é”€"><a href="#å¼€é”€" class="headerlink" title="å¼€é”€"></a>å¼€é”€</h3><p>CPUçš„å¼€é”€ä½“ç°æ¥æ–‡ä»¶çš„é‡å†™ï¼Œåœ¨<code>Redis</code>æ‰§è¡Œ<code>bgsave</code>ã€<code>bgrewriteaof</code>éƒ½ä¼šå°†å†…å­˜çš„æ•°æ®å†™åˆ°ç¡¬ç›˜ï¼Œå®é™…ä¸Šç¡¬ç›˜ä¸Šçš„å¼€é”€ä¹‹å¤–ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªCPUæœºå¯†çš„æ“ä½œï¼Œå› ä¸ºå®ƒçš„å†™å…¥æ˜¯ä¸€ä¸ªéå¸¸é›†ä¸­çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥é€šå¸¸è¿™ä¸ªå­è¿›ç¨‹ä¸€ä¸ªCPUçš„å¼€é”€ä¼šå¤§äº90ä»¥ä¸Šï¼›</p><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><ul><li>ä¸åšCPUç»‘å®šï¼Œä¸è®©<code>Redis</code>è¿›ç¨‹ç»‘å®šåˆ°ä¸€ä¸ªCPUä¸Šï¼Œè¿™æ ·çš„è¯å¦‚æœå‘ç”Ÿäº†è¿™æ ·çš„å­è¿›ç¨‹çš„è¯ï¼Œå®ƒä¼šå’Œçˆ¶è¿›ç¨‹é›†ä¸­çš„å»æ¶ˆè€—CPUï¼Œä¼šå¯¹ä¸»è¿›ç¨‹é€ æˆå¾ˆå¤§çš„èµ„æºå½±å“ï¼›</li><li>ä¸è¦å’ŒCPUå¯†é›†å‹çš„ä¸€äº›åº”ç”¨éƒ¨ç½²åœ¨ä¸€èµ·ï¼Œè¿™æ ·å°±èƒ½ä¿è¯ä¸ä¼šäº§ç”ŸCPUå†…çš„è¿‡æ¸¡ç«äº‰ï¼›</li><li>åœ¨å•æœºå¤šéƒ¨ç½²çš„æ—¶å€™ï¼Œè¦ä¿è¯ä¸è¦å‘ç”Ÿå¤§é‡çš„ AOFé‡å†™ã€RDBçš„<code>bgsave</code>çš„è¿‡ç¨‹ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœä¸€å®šçš„CPUï¼›</li></ul><h2 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h2><h3 id="å¼€é”€-1"><a href="#å¼€é”€-1" class="headerlink" title="å¼€é”€"></a>å¼€é”€</h3><p>å› ä¸ºRedisåœ¨forkçš„æ—¶å€™ä¼šç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹ï¼Œå®ƒç†è®ºä¸Šçš„å ç”¨å†…å­˜ç­‰äºçˆ¶è¿›ç¨‹çš„ï¼Œä½†æ˜¯Linuxæœ‰ä¸€ä¸ªå†™æ—¶å¤åˆ¶çš„æœºåˆ¶ï¼š<code>copy-on-write</code><a href="https://juejin.im/post/5bd96bcaf265da396b72f855" target="_blank" rel="noopener">ï¼ˆä»‹ç»ï¼‰</a>ï¼Œçˆ¶å­è¿›ç¨‹å…±äº«ç‰©ç†è¿›ç¨‹é¡µï¼Œä½†æ˜¯å½“çˆ¶è¿›ç¨‹è¦å†™è¯·æ±‚çš„æ—¶å€™ä¼šåˆ›å»ºä¸€ä¸ªå‰¯æœ¬ï¼Œå®ƒè¿™ä¸ªæ—¶å€™æ‰ä¼šæ¶ˆè€—å†…å­˜ï¼Œè€Œåœ¨æ•´ä¸ªæœŸé—´å­è¿›ç¨‹ä¼šå…±äº«<code>fork</code>æ—¶çˆ¶è¿›ç¨‹ä¸€ä¸ªå†…å­˜çš„å¿«æ—©ï¼Œå°±æ˜¯è¯´ä½ åœ¨<code>AOFé‡å†™</code>æˆ–è€…bgsaveäº§ç”Ÿå­è¿›ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä½ çš„çˆ¶è¿›ç¨‹çš„å†…å­˜é¡µä¼šå¤§é‡çš„å†™å…¥ï¼Œå°±ä¼šè¯æ˜ä½ çš„ä¸€ä¸ªå­è¿›ç¨‹çš„å†…å­˜å¼€é”€æ¯”è¾ƒå¤§ï¼Œå› ä¸ºå®ƒè¦åšä¸€ä¸ª å‰¯æœ¬ï¼Œå¦‚æœä½ æ²¡ä»€ä¹ˆå†™å…¥çš„è¯ï¼Œå®é™…ä¸Šå®ƒä¹Ÿå¼€é”€ä¸äº†å¤šå°‘å†…å­˜ï¼›</p><h3 id="ä¼˜åŒ–-1"><a href="#ä¼˜åŒ–-1" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><ul><li>ä¸å…è®¸å•æœºå¤šéƒ¨ç½²çš„æ—¶å€™äº§ç”Ÿå¤§é‡çš„é‡å†™ï¼Œè¿™æ ·ä½ å†…å­˜å¼€é”€ä¹Ÿä¼šæ¯”è¾ƒå°ï¼›</li><li>åœ¨ä¸»è¿›ç¨‹å†™å…¥é‡æ¯”è¾ƒå°‘çš„æ—¶å€™å»åšä¸€ä¸ªAOFé‡å†™æˆ–bgsaveï¼Œè¿™æ ·ä¼šèŠ‚çœä¸€å®šå†…å­˜ï¼›</li><li>æˆ‘ä»¬å¯ä»¥åœ¨<code>Linux</code>ä¸Šåšä¸€äº›ä¼˜åŒ–çš„å·¥ä½œï¼Œ<code>Linux</code>åœ¨<code>6.38ç‰ˆæœ¬</code>ä¸­å¢åŠ äº†ä¸€ä¸ªå«<code>tph</code>ç‰¹æ€§ï¼Œå®ƒçš„æ„æ€è¯´ï¼Œå®ƒæ”¯æŒå¤§çš„å†…å­˜é¡µçš„åˆ†é…ï¼Œä½†æ˜¯è¿™ä¸ªå¯¹äºæˆ‘ä»¬åˆšæ‰è¯´çš„<code>copy-on-write</code>æ˜¯æœ‰ä¸€å®šé—®é¢˜çš„ï¼Œæˆ‘ä»¬å†™å…¥é‡å¤§çš„æ—¶å€™ï¼Œé‚£ä¹ˆå®ƒæ¯æ¬¡çš„å†…å­˜é¡µç”±åŸæ¥çš„<code>4k</code>å˜æˆäº†<code>2m</code>ï¼Œè¿™æ ·ä¼šæå¤§å¢åŠ å†…å­˜å‰¯æœ¬äº§ç”Ÿæ¦‚ç‡ä»¥åŠå®ƒçš„å¤§å°ï¼Œè¿™æ˜¯ä¸ºäº†å¢åŠ <code>fork</code>çš„é€Ÿåº¦,ä½†å®é™…ä¸Šå¯¹äºæˆ‘ä»¬<code>Redis</code>æ¥è¯´ä¸æ˜¯å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œé€šå¸¸ä¼šç¦æ­¢æ‰ï¼š<code>echo never &gt;/sys/kernel/mm/transparent_hugepage/enabled</code></li></ul><h2 id="ç¡¬ç›˜"><a href="#ç¡¬ç›˜" class="headerlink" title="ç¡¬ç›˜"></a>ç¡¬ç›˜</h2><h3 id="å¼€é”€-2"><a href="#å¼€é”€-2" class="headerlink" title="å¼€é”€"></a>å¼€é”€</h3><p>AOFå’ŒRDBæ–‡ä»¶å†™å…¥é‡æ˜¯æ¯”è¾ƒå¤§çš„è¯ä¼šå¯¹ç¡¬ç›˜é€ æˆä¸€å®šå¼€é”€ï¼Œæˆ‘ä»¬å¯ä»¥å»ç»“åˆiostatï¼Œiotopè¿™æ ·çš„å·¥å…·åˆ†æ</p><h3 id="ä¼˜åŒ–-2"><a href="#ä¼˜åŒ–-2" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><ul><li>ä¸è¦å’Œé«˜ç¡¬ç›˜è´Ÿè½½æœåŠ¡éƒ¨ç½²ä¸€èµ·ï¼šå­˜å‚¨æœåŠ¡ã€æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡ç­‰ï¼›</li><li>Redisé…ç½®æ–‡ä»¶ä¸­<code>no-appendfsync-on-rewrite=yes</code>ï¼Œåœ¨AOFé‡å†™æœŸé—´ï¼Œä¸è¦è¿›è¡Œæ­£å¸¸çš„AOFå»è¿½åŠ ä¸€ä¸ªæ“ä½œï¼Œè¿™æ ·å¯èƒ½ä¼šå‡å°‘æˆ‘ä»¬ç¡¬ç›˜çš„å¼€é”€ï¼›</li><li>æ ¹æ®å†™å…¥é‡å†³å®šç¡¬ç›˜ç±»å‹ï¼šä¾‹å¦‚ssdï¼›</li><li>å•æœºå¤šå®ä¾‹æŒä¹…åŒ–æ–‡ä»¶ç›®å½•å¯ä»¥è€ƒè™‘åˆ†ç›˜ã€èµ„æºé™åˆ¶çš„æ“ä½œï¼›</li></ul><h1 id="AOFé˜»å¡"><a href="#AOFé˜»å¡" class="headerlink" title="AOFé˜»å¡"></a>AOFé˜»å¡</h1><h2 id="AOFè¿½åŠ é˜»å¡"><a href="#AOFè¿½åŠ é˜»å¡" class="headerlink" title="AOFè¿½åŠ é˜»å¡"></a>AOFè¿½åŠ é˜»å¡</h2><p>å¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>AOF</code>çš„ç­–ç•¥ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æ¯ç§’åˆ·ç›˜çš„ç­–ç•¥ï¼Œåˆ·ç›˜ç­–ç•¥æµç¨‹å›¾å¦‚ä¸‹ï¼Œé¦–å…ˆä¸»çº¿ç¨‹å†™å…¥<code>AOF</code>ç¼“å†²åŒºï¼ŒåŒæ—¶å®ƒæœ‰ä¸€ä¸ª<code>AOF</code>åŒæ­¥çº¿ç¨‹è´Ÿè´£æ¯ç§’å»åŒæ­¥åˆ·ç›˜çš„åŠ¨ä½œï¼Œå®ƒè¿˜ä¼šè®°å½•æœ€è¿‘ä¸€æ¬¡çš„åŒæ­¥æ—¶é—´ï¼Œä¸»çº¿ç¨‹è¿˜ä¼šè´Ÿè´£å¯¹ä½ ä¸Šæ¬¡AOFåŒæ­¥çš„æ—¶é—´ï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡åŒæ­¥æ—¶é—´åœ¨2ç§’ä¹‹å†…ï¼Œä¸»çº¿ç¨‹å°±ä¼šè¿”å›ï¼Œå¦‚æœè·ç¦»ä¸Šæ¬¡åŒæ­¥æ—¶é—´è¶…è¿‡2ç§’ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°åŒæ­¥å®Œæˆï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¸ºäº†ä¿è¯AOFå®‰å…¨æ€§çš„ä¸€ç§ç­–ç•¥ï¼Œä¸»çº¿ç¨‹ä¸ºäº†è¾¾åˆ°æ¯ç§’åˆ·ç›˜çš„æ•ˆæœï¼Œå®ƒä¼šé˜»å¡ç›´åˆ°åŒæ­¥å®Œæˆï¼Œè¿™é‡Œä¼šäº§ç”Ÿ2ä¸ªé—®é¢˜ï¼š</p><p>ï¼ˆ1ï¼‰ä¸»çº¿ç¨‹ä¸èƒ½é˜»å¡ï¼Œå› ä¸ºå®ƒè¦è´Ÿè´£æˆ‘ä»¬çš„æ—¥å¸¸å‘½ä»¤çš„å¤„ç†ï¼Œå®ƒæ˜¯éå¸¸å®è´µçš„èµ„æºï¼›</p><p>ï¼ˆ2ï¼‰æ¯ç§’åˆ·ç›˜çš„ç­–ç•¥ä¸ä¼šçœŸæ­£åªä¸¢1ç§’çš„æ•°æ®ï¼Œå®ƒå¯èƒ½ä¼šä¸¢2ç§’çš„ä¸œè¥¿ã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571475697141.png" srcset="/img/loading.gif" alt="1571475697141"></p><h2 id="AOFé˜»å¡å®šä½"><a href="#AOFé˜»å¡å®šä½" class="headerlink" title="AOFé˜»å¡å®šä½"></a>AOFé˜»å¡å®šä½</h2><p>Redisæ—¥å¿—ï¼š</p><pre><code class="hljs vim">Asynchronous aoF fsync <span class="hljs-keyword">is</span> taking too long(disk <span class="hljs-keyword">is</span> busyWriting the aof <span class="hljs-keyword">buffer</span> without waiting <span class="hljs-keyword">for</span> fsync <span class="hljs-keyword">to</span> <span class="hljs-built_in">complete</span>,this may slow down redis</code></pre><hr><p><code>info persistence</code>é€‰é¡¹ä¸­çš„aof delayed fsyncï¼Œå®ƒä¼šè®°å½•ä½ ä¸Šè¯‰è¿‡ç¨‹çš„æ•°é‡ï¼Œæ¯å‘ç”Ÿä¸€æ¬¡åŠ 1ï¼Œä½†æ˜¯è¿™ä¸ªç´¯è®¡è¿‡ç¨‹æ— æ³•çœ‹åˆ°ï¼Œä¾‹å¦‚æŸæ®µæ—¶é—´å‘ç”Ÿçš„æ¬¡æ•°ï¼Œè¿™é‡Œéœ€è¦ä½ å•ç‹¬åšä¸€ä¸ªæ”¶é›†</p><pre><code class="hljs bash">info persistence127.0.0.1: 6379&gt; info persistenceaof delayed fsync: 100</code></pre><hr><p>é€šè¿‡ç¡¬ç›˜è§‚å¯Ÿï¼Œæ‰§è¡ŒLinuxçš„topå‘½ä»¤ï¼Œæ˜¯å¦æœ‰å‘ç”ŸIOèµ„æºæ¯”è¾ƒç´§å¼ çš„æ—¶å€™</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571477131262.png" srcset="/img/loading.gif" alt="1571477131262"></p>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘ 4.æŒä¹…åŒ–</title>
    <link href="/redis-4.html"/>
    <url>/redis-4.html</url>
    
    <content type="html"><![CDATA[<h1 id="æŒä¹…åŒ–çš„ä½œç”¨"><a href="#æŒä¹…åŒ–çš„ä½œç”¨" class="headerlink" title="æŒä¹…åŒ–çš„ä½œç”¨"></a>æŒä¹…åŒ–çš„ä½œç”¨</h1><h2 id="ä»€ä¹ˆæ˜¯æŒä¹…åŒ–"><a href="#ä»€ä¹ˆæ˜¯æŒä¹…åŒ–" class="headerlink" title="ä»€ä¹ˆæ˜¯æŒä¹…åŒ–"></a>ä»€ä¹ˆæ˜¯æŒä¹…åŒ–</h2><p> æŒä¹…åŒ–ï¼ˆPersistenceï¼‰ï¼Œå³æŠŠæ•°æ®ï¼ˆå¦‚å†…å­˜ä¸­çš„å¯¹è±¡ï¼‰ä¿å­˜åˆ°å¯æ°¸ä¹…ä¿å­˜çš„å­˜å‚¨è®¾å¤‡ä¸­ï¼ˆå¦‚ç£ç›˜ï¼‰ã€‚<br>æŒä¹…åŒ– Redis æ‰€æœ‰æ•°æ®ä¿æŒåœ¨å†…å­˜ä¸­ï¼Œå¯¹æ•°æ®çš„æ›´æ–°å°†å¼‚æ­¥åœ°ä¿å­˜åˆ°ç£ç›˜ä¸Šã€‚ </p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571240413585.png" srcset="/img/loading.gif" alt="1571240413585">  </p><h2 id="æŒä¹…åŒ–çš„å®ç°æ–¹å¼"><a href="#æŒä¹…åŒ–çš„å®ç°æ–¹å¼" class="headerlink" title="æŒä¹…åŒ–çš„å®ç°æ–¹å¼"></a>æŒä¹…åŒ–çš„å®ç°æ–¹å¼</h2><h3 id="å¿«ç…§æ–¹å¼æŒä¹…åŒ–"><a href="#å¿«ç…§æ–¹å¼æŒä¹…åŒ–" class="headerlink" title="å¿«ç…§æ–¹å¼æŒä¹…åŒ–"></a>å¿«ç…§æ–¹å¼æŒä¹…åŒ–</h3><p>å¿«ç…§æ–¹å¼æŒä¹…åŒ–å°±æ˜¯åœ¨æŸæ—¶åˆ»æŠŠæ‰€æœ‰æ•°æ®è¿›è¡Œå®Œæ•´å¤‡ä»½ã€‚</p><p>ä¾‹ï¼šMysql çš„ Dump æ–¹å¼ã€Redis çš„ RDB æ–¹å¼ã€‚</p><h3 id="å†™æ—¥å¿—æ–¹å¼æŒä¹…åŒ–"><a href="#å†™æ—¥å¿—æ–¹å¼æŒä¹…åŒ–" class="headerlink" title="å†™æ—¥å¿—æ–¹å¼æŒä¹…åŒ–"></a>å†™æ—¥å¿—æ–¹å¼æŒä¹…åŒ–</h3><p>å†™æ—¥å¿—æ–¹å¼æŒä¹…åŒ–å°±æ˜¯æŠŠç”¨æˆ·æ‰§è¡Œçš„æ‰€æœ‰å†™æŒ‡ä»¤ï¼ˆå¢åˆ æ”¹ï¼‰å¤‡ä»½åˆ°æ–‡ä»¶ä¸­ï¼Œè¿˜åŸæ•°æ®æ—¶åªéœ€è¦æŠŠå¤‡ä»½çš„æ‰€æœ‰æŒ‡ä»¤é‡æ–°æ‰§è¡Œä¸€éå³å¯ã€‚</p><p>ä¾‹ï¼šMysql çš„ Binlogã€Redis çš„ AOFã€Hbase çš„ HLogã€‚</p><h1 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h1><h2 id="ä»€ä¹ˆæ˜¯-RDB"><a href="#ä»€ä¹ˆæ˜¯-RDB" class="headerlink" title="ä»€ä¹ˆæ˜¯ RDB"></a>ä»€ä¹ˆæ˜¯ RDB</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571240680932.png" srcset="/img/loading.gif" alt="1571240680932"></p><p> RDB æŒä¹…åŒ–æ–¹å¼èƒ½å¤Ÿåœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”èƒ½å¯¹ä½ çš„æ•°æ®è¿›è¡Œå¿«ç…§å­˜å‚¨ã€‚<br>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ Redis å°†æ•°æ®åº“å¿«ç…§ä¿å­˜åœ¨åå­—ä¸º dump.rdb çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ã€‚<br>åœ¨ Redis è¿è¡Œæ—¶ï¼Œ RDB ç¨‹åºå°†å½“å‰å†…å­˜ä¸­çš„æ•°æ®åº“å¿«ç…§ä¿å­˜åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œ åœ¨ Redis é‡å¯åŠ¨æ—¶ï¼Œ RDB ç¨‹åºå¯ä»¥é€šè¿‡è½½å…¥ RDB æ–‡ä»¶æ¥è¿˜åŸæ•°æ®åº“çš„çŠ¶æ€ã€‚ </p><h2 id="RDB-çš„ä¸‰ç§ä¸»è¦è§¦å‘æœºåˆ¶"><a href="#RDB-çš„ä¸‰ç§ä¸»è¦è§¦å‘æœºåˆ¶" class="headerlink" title="RDB çš„ä¸‰ç§ä¸»è¦è§¦å‘æœºåˆ¶"></a>RDB çš„ä¸‰ç§ä¸»è¦è§¦å‘æœºåˆ¶</h2><h3 id="save-å‘½ä»¤ï¼ˆåŒæ­¥æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰"><a href="#save-å‘½ä»¤ï¼ˆåŒæ­¥æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰" class="headerlink" title="save å‘½ä»¤ï¼ˆåŒæ­¥æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰"></a>save å‘½ä»¤ï¼ˆåŒæ­¥æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰</h3><p><code>save</code> å±äºOï¼ˆnï¼‰å‘½ä»¤æ‰§è¡Œä¸€ä¸ªåŒæ­¥æ“ä½œï¼Œä»¥ RDB æ–‡ä»¶çš„æ–¹å¼ä¿å­˜æ‰€æœ‰æ•°æ®çš„å¿«ç…§ã€‚</p><pre><code class="hljs bash">127.0.0.1:6379&gt; saveOK</code></pre><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571240796252.png" srcset="/img/loading.gif" alt="1571240796252"></p><p> ç”±äº <code>save</code> å‘½ä»¤æ˜¯åŒæ­¥å‘½ä»¤ï¼Œä¼šå ç”¨ <code>Redis</code> çš„ä¸»è¿›ç¨‹ã€‚è‹¥ <code>Redis</code> æ•°æ®éå¸¸å¤šæ—¶ï¼Œ<code>save</code> å‘½ä»¤æ‰§è¡Œé€Ÿåº¦ä¼šéå¸¸æ…¢ï¼Œé˜»å¡æ‰€æœ‰å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚<br>å› æ­¤å¾ˆå°‘åœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨ SAVE å‘½ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ <code>BGSAVE</code> å‘½ä»¤ä»£æ›¿ã€‚å¦‚æœåœ¨ <code>BGSAVE</code> å‘½ä»¤çš„ä¿å­˜æ•°æ®çš„å­è¿›ç¨‹å‘ç”Ÿé”™è¯¯çš„æ—¶ï¼Œç”¨ SAVE å‘½ä»¤ä¿å­˜æœ€æ–°çš„æ•°æ®æ˜¯æœ€åçš„æ‰‹æ®µã€‚ </p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571240834372.png" srcset="/img/loading.gif" alt="1571240834372"></p><h3 id="bgsave-å‘½ä»¤ï¼ˆå¼‚æ­¥ä¿å­˜æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰"><a href="#bgsave-å‘½ä»¤ï¼ˆå¼‚æ­¥ä¿å­˜æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰" class="headerlink" title="bgsave å‘½ä»¤ï¼ˆå¼‚æ­¥ä¿å­˜æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰"></a>bgsave å‘½ä»¤ï¼ˆå¼‚æ­¥ä¿å­˜æ•°æ®åˆ°ç£ç›˜ä¸Šï¼‰</h3><p><code>bgsave</code> å‘½ä»¤æ‰§è¡Œä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œä»¥ RDB æ–‡ä»¶çš„æ–¹å¼ä¿å­˜æ‰€æœ‰æ•°æ®çš„å¿«ç…§ã€‚</p><pre><code class="hljs bash">127.0.0.1:6379&gt; bgsaveBackground saving started</code></pre><p> Redis ä½¿ç”¨ Linux ç³»ç»Ÿçš„ <code>fock()</code> ç”Ÿæˆä¸€ä¸ªå­è¿›ç¨‹æ¥å°† DB æ•°æ®ä¿å­˜åˆ°ç£ç›˜ï¼Œä¸»è¿›ç¨‹ç»§ç»­æä¾›æœåŠ¡ä»¥ä¾›å®¢æˆ·ç«¯è°ƒç”¨ã€‚<br>å¦‚æœæ“ä½œæˆåŠŸï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯å‘½ä»¤ LASTSAVE æ¥æ£€æŸ¥æ“ä½œç»“æœã€‚ </p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571240943676.png" srcset="/img/loading.gif" alt="1571240943676"></p><h3 id="save-ä¸-bgsave-å¯¹æ¯”"><a href="#save-ä¸-bgsave-å¯¹æ¯”" class="headerlink" title="save ä¸ bgsave å¯¹æ¯”"></a>save ä¸ bgsave å¯¹æ¯”</h3><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">save</th><th align="left">bgsave</th></tr></thead><tbody><tr><td align="left">IO ç±»å‹</td><td align="left">åŒæ­¥</td><td align="left">å¼‚æ­¥</td></tr><tr><td align="left">é˜»å¡ï¼Ÿ</td><td align="left">æ˜¯</td><td align="left">æ˜¯ï¼ˆé˜»å¡å‘ç”Ÿåœ¨ fock ()ï¼Œé€šå¸¸éå¸¸å¿«ï¼‰</td></tr><tr><td align="left">å¤æ‚åº¦</td><td align="left">O(n)</td><td align="left">O(n)</td></tr><tr><td align="left">ä¼˜ç‚¹</td><td align="left">ä¸ä¼šæ¶ˆè€—é¢å¤–çš„å†…å­˜</td><td align="left">ä¸é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤</td></tr><tr><td align="left">ç¼ºç‚¹</td><td align="left">é˜»å¡å®¢æˆ·ç«¯å‘½ä»¤</td><td align="left">éœ€è¦ fock å­è¿›ç¨‹ï¼Œæ¶ˆè€—å†…å­˜</td></tr></tbody></table><h3 id="è‡ªåŠ¨ç”Ÿæˆ-RDB"><a href="#è‡ªåŠ¨ç”Ÿæˆ-RDB" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆ RDB"></a>è‡ªåŠ¨ç”Ÿæˆ RDB</h3><p>é™¤äº†æ‰‹åŠ¨æ‰§è¡Œ <code>save</code> å’Œ <code>bgsave</code> å‘½ä»¤å®ç° RDB æŒä¹…åŒ–ä»¥å¤–ï¼ŒRedis è¿˜æä¾›äº†è‡ªåŠ¨è‡ªåŠ¨ç”Ÿæˆ RDB çš„æ–¹å¼ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶å¯¹ Redis è¿›è¡Œè®¾ç½®ï¼Œ è®©å®ƒåœ¨ â€œN ç§’å†…æ•°æ®é›†è‡³å°‘æœ‰ M ä¸ªæ”¹åŠ¨â€ è¿™ä¸€æ¡ä»¶è¢«æ»¡è¶³æ—¶ï¼Œ è‡ªåŠ¨è¿›è¡Œæ•°æ®é›†ä¿å­˜æ“ä½œã€‚<br>æ¯”å¦‚è¯´ï¼Œ ä»¥ä¸‹è®¾ç½®ä¼šè®© Redis åœ¨æ»¡è¶³ â€œ60 ç§’å†…æœ‰è‡³å°‘æœ‰ 1000 ä¸ªé”®è¢«æ”¹åŠ¨â€ è¿™ä¸€æ¡ä»¶æ—¶ï¼Œ è‡ªåŠ¨è¿›è¡Œæ•°æ®é›†ä¿å­˜æ“ä½œï¼š</p><pre><code class="hljs bash">save 60 1000</code></pre><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571241038316.png" srcset="/img/loading.gif" alt="1571241038316"></p><h2 id="è§¦å‘æœºåˆ¶-ä¸å®¹å¿½è§†çš„æ–¹å¼"><a href="#è§¦å‘æœºåˆ¶-ä¸å®¹å¿½è§†çš„æ–¹å¼" class="headerlink" title="è§¦å‘æœºåˆ¶-ä¸å®¹å¿½è§†çš„æ–¹å¼"></a>è§¦å‘æœºåˆ¶-ä¸å®¹å¿½è§†çš„æ–¹å¼</h2><ol><li>å…¨é‡å¤åˆ¶</li><li>debug reload</li><li>shutdown</li></ol><h2 id="RDB-ç›¸å…³é…ç½®"><a href="#RDB-ç›¸å…³é…ç½®" class="headerlink" title="RDB ç›¸å…³é…ç½®"></a>RDB ç›¸å…³é…ç½®</h2><pre><code class="hljs properties"><span class="hljs-comment"># RDBè‡ªåŠ¨æŒä¹…åŒ–è§„åˆ™</span><span class="hljs-comment"># å½“ 900 ç§’å†…æœ‰è‡³å°‘æœ‰ 1 ä¸ªé”®è¢«æ”¹åŠ¨æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•°æ®é›†ä¿å­˜æ“ä½œ</span><span class="hljs-attr">save</span> <span class="hljs-string">900 1</span><span class="hljs-comment"># å½“ 300 ç§’å†…æœ‰è‡³å°‘æœ‰ 10 ä¸ªé”®è¢«æ”¹åŠ¨æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•°æ®é›†ä¿å­˜æ“ä½œ</span><span class="hljs-attr">save</span> <span class="hljs-string">300 10</span><span class="hljs-comment"># å½“ 60 ç§’å†…æœ‰è‡³å°‘æœ‰ 10000 ä¸ªé”®è¢«æ”¹åŠ¨æ—¶ï¼Œè‡ªåŠ¨è¿›è¡Œæ•°æ®é›†ä¿å­˜æ“ä½œ</span><span class="hljs-attr">save</span> <span class="hljs-string">60 10000</span><span class="hljs-comment"># RDBæŒä¹…åŒ–æ–‡ä»¶å</span><span class="hljs-attr">dbfilename</span> <span class="hljs-string">dump-$&#123;port&#125;.rdb</span><span class="hljs-comment"># æ•°æ®æŒä¹…åŒ–æ–‡ä»¶å­˜å‚¨ç›®å½•</span><span class="hljs-attr">dir</span> <span class="hljs-string">/var/lib/redis</span><span class="hljs-comment"># bgsaveå‘ç”Ÿé”™è¯¯æ—¶æ˜¯å¦åœæ­¢å†™å…¥ï¼Œé€šå¸¸ä¸ºyes</span><span class="hljs-meta">stop-writes-on-bgsave-error</span> <span class="hljs-string">yes</span><span class="hljs-comment"># rdbæ–‡ä»¶æ˜¯å¦ä½¿ç”¨å‹ç¼©æ ¼å¼</span><span class="hljs-attr">rdbcompression</span> <span class="hljs-string">yes</span><span class="hljs-comment"># æ˜¯å¦å¯¹rdbæ–‡ä»¶è¿›è¡Œæ ¡éªŒå’Œæ£€éªŒï¼Œé€šå¸¸ä¸ºyes</span><span class="hljs-attr">rdbchecksum</span> <span class="hljs-string">yes</span></code></pre><h2 id="RDB-çš„ä¼˜ç‚¹"><a href="#RDB-çš„ä¼˜ç‚¹" class="headerlink" title="RDB çš„ä¼˜ç‚¹"></a>RDB çš„ä¼˜ç‚¹</h2><ol><li>RDB æ˜¯ä¸€ä¸ªéå¸¸ç´§å‡‘çš„æ–‡ä»¶ï¼Œå®ƒä¿å­˜äº†æŸä¸ªæ—¶é—´ç‚¹å¾—æ•°æ®é›†ï¼Œéå¸¸é€‚ç”¨äºæ•°æ®é›†çš„å¤‡ä»½ï¼Œæ¯”å¦‚ä½ å¯ä»¥åœ¨æ¯ä¸ªå°æ—¶æŠ¥ä¿å­˜ä¸€ä¸‹è¿‡å» 24 å°æ—¶å†…çš„æ•°æ®ï¼ŒåŒæ—¶æ¯å¤©ä¿å­˜è¿‡å» 30 å¤©çš„æ•°æ®ï¼Œè¿™æ ·å³ä½¿å‡ºäº†é—®é¢˜ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€æ±‚æ¢å¤åˆ°ä¸åŒç‰ˆæœ¬çš„æ•°æ®é›†ã€‚</li><li>RDB æ˜¯ä¸€ä¸ªç´§å‡‘çš„å•ä¸€æ–‡ä»¶ï¼Œå¾ˆæ–¹ä¾¿ä¼ é€åˆ°å¦ä¸€ä¸ªè¿œç«¯æ•°æ®ä¸­å¿ƒæˆ–è€…äºšé©¬é€Šçš„ S3ï¼ˆå¯èƒ½åŠ å¯†ï¼‰ï¼Œéå¸¸é€‚ç”¨äºç¾éš¾æ¢å¤ã€‚</li><li>RDB åœ¨ä¿å­˜ RDB æ–‡ä»¶æ—¶çˆ¶è¿›ç¨‹å”¯ä¸€éœ€è¦åšçš„å°±æ˜¯ fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ¥ä¸‹æ¥çš„å·¥ä½œå…¨éƒ¨ç”±å­è¿›ç¨‹æ¥åšï¼Œçˆ¶è¿›ç¨‹ä¸éœ€è¦å†åšå…¶ä»– IO æ“ä½œï¼Œæ‰€ä»¥ RDB æŒä¹…åŒ–æ–¹å¼å¯ä»¥æœ€å¤§åŒ– redis çš„æ€§èƒ½ã€‚</li><li>ä¸ AOF ç›¸æ¯”ï¼Œåœ¨æ¢å¤å¤§çš„æ•°æ®é›†çš„æ—¶å€™ï¼ŒRDB æ–¹å¼ä¼šæ›´å¿«ä¸€äº›ã€‚</li></ol><h2 id="RDB-çš„ç¼ºç‚¹"><a href="#RDB-çš„ç¼ºç‚¹" class="headerlink" title="RDB çš„ç¼ºç‚¹"></a>RDB çš„ç¼ºç‚¹</h2><ol><li>è€—æ—¶ã€è€—æ€§èƒ½ã€‚RDB éœ€è¦ç»å¸¸ fork å­è¿›ç¨‹æ¥ä¿å­˜æ•°æ®é›†åˆ°ç¡¬ç›˜ä¸Šï¼Œå½“æ•°æ®é›†æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œfork çš„è¿‡ç¨‹æ˜¯éå¸¸è€—æ—¶çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´ Redis åœ¨ä¸€äº›æ¯«ç§’çº§å†…ä¸èƒ½å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚å¦‚æœæ•°æ®é›†å·¨å¤§å¹¶ä¸” CPU æ€§èƒ½ä¸æ˜¯å¾ˆå¥½çš„æƒ…å†µä¸‹ï¼Œè¿™ç§æƒ…å†µä¼šæŒç»­ 1 ç§’ï¼ŒAOF ä¹Ÿéœ€è¦ forkï¼Œä½†æ˜¯ä½ å¯ä»¥è°ƒèŠ‚é‡å†™æ—¥å¿—æ–‡ä»¶çš„é¢‘ç‡æ¥æé«˜æ•°æ®é›†çš„è€ä¹…åº¦ã€‚</li><li>ä¸å¯æ§ã€ä¸¢å¤±æ•°æ®ã€‚å¦‚æœä½ å¸Œæœ›åœ¨ redis æ„å¤–åœæ­¢å·¥ä½œï¼ˆä¾‹å¦‚ç”µæºä¸­æ–­ï¼‰çš„æƒ…å†µä¸‹ä¸¢å¤±çš„æ•°æ®æœ€å°‘çš„è¯ï¼Œé‚£ä¹ˆ RDB ä¸é€‚åˆä½ ã€‚è™½ç„¶ä½ å¯ä»¥é…ç½®ä¸åŒçš„ save æ—¶é—´ç‚¹ (ä¾‹å¦‚æ¯éš” 5 åˆ†é’Ÿå¹¶ä¸”å¯¹æ•°æ®é›†æœ‰ 100 ä¸ªå†™çš„æ“ä½œ)ï¼Œæ˜¯ Redis è¦å®Œæ•´çš„ä¿å­˜æ•´ä¸ªæ•°æ®é›†æ˜¯ä¸€ä¸ªæ¯”è¾ƒç¹é‡çš„å·¥ä½œï¼Œä½ é€šå¸¸ä¼šæ¯éš” 5 åˆ†é’Ÿæˆ–è€…æ›´ä¹…åšä¸€æ¬¡å®Œæ•´çš„ä¿å­˜ï¼Œä¸‡ä¸€åœ¨ Redis æ„å¤–å®•æœºï¼Œä½ å¯èƒ½ä¼šä¸¢å¤±å‡ åˆ†é’Ÿçš„æ•°æ®ã€‚</li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li><code>RDB</code>æ˜¯<code>Redis</code>å†…å­˜åˆ°ç¡¬ç›˜çš„å¿«ç…§ï¼Œç”¨äºæŒä¹…åŒ–ï¼›</li><li>saveé€šå¸¸ä¼šé˜»å¡<code>Redis</code>;</li><li><code>bgsave</code>ä¸ä¼šé˜»å¡<code>Redis</code>ï¼Œä½†æ˜¯ä¼šforkæ–°è¿›ç¨‹ï¼›</li><li><code>save</code>è‡ªåŠ¨é…ç½®æ»¡è¶³ä»»ä¸€å°±ä¼šè¢«æ‰§è¡Œï¼›</li><li>æœ‰äº›è§¦å‘æœºåˆ¶ä¸å®¹å¿½è§†ã€‚</li></ol><h1 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h1><h2 id="ä»€ä¹ˆæ˜¯-AOF"><a href="#ä»€ä¹ˆæ˜¯-AOF" class="headerlink" title="ä»€ä¹ˆæ˜¯ AOF"></a>ä»€ä¹ˆæ˜¯ AOF</h2><p>å¿«ç…§åŠŸèƒ½ï¼ˆRDBï¼‰å¹¶ä¸æ˜¯éå¸¸è€ä¹…ï¼ˆdurableï¼‰ï¼š å¦‚æœ Redis å› ä¸ºæŸäº›åŸå› è€Œé€ æˆæ•…éšœåœæœºï¼Œ é‚£ä¹ˆæœåŠ¡å™¨å°†ä¸¢å¤±æœ€è¿‘å†™å…¥ã€ä¸”ä»æœªä¿å­˜åˆ°å¿«ç…§ä¸­çš„é‚£äº›æ•°æ®ã€‚ ä» 1.1 ç‰ˆæœ¬å¼€å§‹ï¼Œ Redis å¢åŠ äº†ä¸€ç§å®Œå…¨è€ä¹…çš„æŒä¹…åŒ–æ–¹å¼ï¼š AOF æŒä¹…åŒ–ã€‚<br>ä½ å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æ‰“å¼€ AOF æ–¹å¼ï¼š</p><pre><code class="hljs nginx"><span class="hljs-attribute">appendonly</span> <span class="hljs-literal">yes</span></code></pre><p>æ‰“å¼€ AOF åï¼Œ æ¯å½“ Redis æ‰§è¡Œä¸€ä¸ªæ”¹å˜æ•°æ®é›†çš„å‘½ä»¤æ—¶ï¼ˆæ¯”å¦‚ SETï¼‰ï¼Œ è¿™ä¸ªå‘½ä»¤å°±ä¼šè¢«è¿½åŠ åˆ° AOF æ–‡ä»¶çš„æœ«å°¾ã€‚è¿™æ ·çš„è¯ï¼Œ å½“ Redis é‡æ–°å¯æ—¶ï¼Œ ç¨‹åºå°±å¯ä»¥é€šè¿‡é‡æ–°æ‰§è¡Œ AOF æ–‡ä»¶ä¸­çš„å‘½ä»¤æ¥è¾¾åˆ°é‡å»ºæ•°æ®é›†çš„ç›®çš„ã€‚</p><p>AOF è¿è¡ŒåŸç† - åˆ›å»º</p><p>  <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1460000016021226.png" srcset="/img/loading.gif" alt="1460000016021226">  </p><p>AOF è¿è¡ŒåŸç† - æ¢å¤</p><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1460000016021227.png" srcset="/img/loading.gif" alt="1460000016021227.png"> </p><h2 id="AOF-æŒä¹…åŒ–çš„ä¸‰ç§ç­–ç•¥"><a href="#AOF-æŒä¹…åŒ–çš„ä¸‰ç§ç­–ç•¥" class="headerlink" title="AOF æŒä¹…åŒ–çš„ä¸‰ç§ç­–ç•¥"></a>AOF æŒä¹…åŒ–çš„ä¸‰ç§ç­–ç•¥</h2><h3 id="always"><a href="#always" class="headerlink" title="always"></a>always</h3><p>ä½ å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶é…ç½® Redis å¤šä¹…æ‰å°†æ•°æ® fsync åˆ°ç£ç›˜ä¸€æ¬¡ã€‚æ¯æ¬¡æœ‰æ–°å‘½ä»¤è¿½åŠ åˆ° AOF æ–‡ä»¶æ—¶å°±æ‰§è¡Œä¸€æ¬¡ fsync ï¼šéå¸¸æ…¢ï¼Œä¹Ÿéå¸¸å®‰å…¨ã€‚</p><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1460000016021228-1571313423491.png" srcset="/img/loading.gif" alt="1460000016021228"> </p><h3 id="everysec"><a href="#everysec" class="headerlink" title="everysec"></a>everysec</h3><p>æ¯ç§’ fsync ä¸€æ¬¡ï¼šè¶³å¤Ÿå¿«ï¼ˆå’Œä½¿ç”¨ RDB æŒä¹…åŒ–å·®ä¸å¤šï¼‰ï¼Œå¹¶ä¸”åœ¨æ•…éšœæ—¶åªä¼šä¸¢å¤± 1 ç§’é’Ÿçš„æ•°æ®ã€‚<br>æ¨èï¼ˆå¹¶ä¸”ä¹Ÿæ˜¯é»˜è®¤ï¼‰çš„æªæ–½ä¸ºæ¯ç§’ fsync ä¸€æ¬¡ï¼Œ è¿™ç§ fsync ç­–ç•¥å¯ä»¥å…¼é¡¾é€Ÿåº¦å’Œå®‰å…¨æ€§ã€‚</p><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1460000016021229.png" srcset="/img/loading.gif" alt="img"> </p><h3 id="no"><a href="#no" class="headerlink" title="no"></a>no</h3><p>ä»ä¸ fsync ï¼šå°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿæ¥å¤„ç†ï¼Œç”±æ“ä½œç³»ç»Ÿæ¥å†³å®šä»€ä¹ˆæ—¶å€™åŒæ­¥æ•°æ®ã€‚æ›´å¿«ï¼Œä¹Ÿæ›´ä¸å®‰å…¨çš„é€‰æ‹©ã€‚</p><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1460000016021230.png" srcset="/img/loading.gif" alt="no"></p><h3 id="alwaysã€everysecã€no-å¯¹æ¯”"><a href="#alwaysã€everysecã€no-å¯¹æ¯”" class="headerlink" title="alwaysã€everysecã€no å¯¹æ¯”"></a>alwaysã€everysecã€no å¯¹æ¯”</h3><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">ä¼˜ç‚¹</th><th align="center">ç¼ºç‚¹</th></tr></thead><tbody><tr><td align="center">always</td><td align="center">ä¸ä¸¢å¤±æ•°æ®</td><td align="center">IO å¼€é”€å¤§ï¼Œä¸€èˆ¬ SATA ç£ç›˜åªæœ‰å‡ ç™¾ TPS</td></tr><tr><td align="center">everysec</td><td align="center">æ¯ç§’è¿›è¡Œä¸ fsyncï¼Œæœ€å¤šä¸¢å¤± 1 ç§’æ•°æ®</td><td align="center">å¯èƒ½ä¸¢å¤± 1 ç§’æ•°æ®</td></tr><tr><td align="center">no</td><td align="center">ä¸ç”¨ç®¡</td><td align="center">ä¸å¯æ§</td></tr></tbody></table><h2 id="é‡å†™"><a href="#é‡å†™" class="headerlink" title="é‡å†™"></a>é‡å†™</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><p>å› ä¸º <code>AOF</code> çš„è¿ä½œæ–¹å¼æ˜¯ä¸æ–­åœ°å°†å‘½ä»¤è¿½åŠ åˆ°æ–‡ä»¶çš„æœ«å°¾ï¼Œ æ‰€ä»¥éšç€å†™å…¥å‘½ä»¤çš„ä¸æ–­å¢åŠ ï¼Œ <code>AOF</code> æ–‡ä»¶çš„ä½“ç§¯ä¹Ÿä¼šå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœä½ å¯¹ä¸€ä¸ªè®¡æ•°å™¨è°ƒç”¨äº† 100 æ¬¡ <code>INCR</code> ï¼Œ é‚£ä¹ˆä»…ä»…æ˜¯ä¸ºäº†ä¿å­˜è¿™ä¸ªè®¡æ•°å™¨çš„å½“å‰å€¼ï¼Œ <code>AOF</code> æ–‡ä»¶å°±éœ€è¦ä½¿ç”¨ 100 æ¡è®°å½•ï¼ˆentryï¼‰ã€‚ç„¶è€Œåœ¨å®é™…ä¸Šï¼Œ åªä½¿ç”¨ä¸€æ¡ SET å‘½ä»¤å·²ç»è¶³ä»¥ä¿å­˜è®¡æ•°å™¨çš„å½“å‰å€¼äº†ï¼Œ å…¶ä½™ 99 æ¡è®°å½•å®é™…ä¸Šéƒ½æ˜¯å¤šä½™çš„ã€‚<br>ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œ <code>Redis</code> æ”¯æŒä¸€ç§æœ‰è¶£çš„ç‰¹æ€§ï¼š å¯ä»¥åœ¨ä¸æ‰“æ–­æœåŠ¡å®¢æˆ·ç«¯çš„æƒ…å†µä¸‹ï¼Œ å¯¹ <code>AOF</code> æ–‡ä»¶è¿›è¡Œé‡å»ºï¼ˆrebuildï¼‰ã€‚æ‰§è¡Œ <code>bgrewriteaof</code> å‘½ä»¤ï¼Œ <code>Redis</code> å°†ç”Ÿæˆä¸€ä¸ªæ–°çš„ <code>AOF</code> æ–‡ä»¶ï¼Œ è¿™ä¸ªæ–‡ä»¶åŒ…å«é‡å»ºå½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°‘å‘½ä»¤ã€‚<br><code>Redis 2.2</code> éœ€è¦è‡ªå·±æ‰‹åŠ¨æ‰§è¡Œ <code>bgrewriteaof</code> å‘½ä»¤ï¼› <code>Redis 2.4</code> åˆ™å¯ä»¥é€šè¿‡é…ç½®è‡ªåŠ¨è§¦å‘ <code>AOF</code> é‡å†™ã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571316511368.png" srcset="/img/loading.gif" alt="1571316511368">  </p><h3 id="AOF-é‡å†™çš„ä½œç”¨"><a href="#AOF-é‡å†™çš„ä½œç”¨" class="headerlink" title="AOF é‡å†™çš„ä½œç”¨"></a>AOF é‡å†™çš„ä½œç”¨</h3><ul><li>å‡å°‘ç£ç›˜å ç”¨é‡</li><li>åŠ é€Ÿæ•°æ®æ¢å¤</li></ul><h3 id="AOF-é‡å†™çš„å®ç°æ–¹å¼"><a href="#AOF-é‡å†™çš„å®ç°æ–¹å¼" class="headerlink" title="AOF é‡å†™çš„å®ç°æ–¹å¼"></a>AOF é‡å†™çš„å®ç°æ–¹å¼</h3><ul><li><p><strong>bgrewriteaof å‘½ä»¤</strong></p><p>Redis bgrewriteaof å‘½ä»¤ç”¨äºå¼‚æ­¥æ‰§è¡Œä¸€ä¸ª AOFï¼ˆAppendOnly Fileï¼‰æ–‡ä»¶é‡å†™æ“ä½œã€‚é‡å†™ä¼šåˆ›å»ºä¸€ä¸ªå½“å‰ AOF æ–‡ä»¶çš„ä½“ç§¯ä¼˜åŒ–ç‰ˆæœ¬ã€‚<br>å³ä½¿ bgrewriteaof æ‰§è¡Œå¤±è´¥ï¼Œä¹Ÿä¸ä¼šæœ‰ä»»ä½•æ•°æ®ä¸¢å¤±ï¼Œå› ä¸ºæ—§çš„ AOF æ–‡ä»¶åœ¨ bgrewriteaof æˆåŠŸä¹‹å‰ä¸ä¼šè¢«ä¿®æ”¹ã€‚<br>AOF é‡å†™ç”± Redis è‡ªè¡Œè§¦å‘ï¼Œbgrewriteaof ä»…ä»…ç”¨äºæ‰‹åŠ¨è§¦å‘é‡å†™æ“ä½œã€‚<br>å…·ä½“å†…å®¹:</p><ul><li>å¦‚æœä¸€ä¸ªå­ Redis æ˜¯é€šè¿‡ç£ç›˜å¿«ç…§åˆ›å»ºçš„ï¼ŒAOF é‡å†™å°†ä¼šåœ¨ RDB ç»ˆæ­¢åæ‰å¼€å§‹ä¿å­˜ã€‚è¿™ç§æƒ…å†µä¸‹ BGREWRITEAOF ä»»ç„¶ä¼šè¿”å› OK çŠ¶æ€ç ã€‚ä» Redis 2.6 èµ·ä½ å¯ä»¥é€šè¿‡ INFO å‘½ä»¤æŸ¥çœ‹ AOF é‡å†™æ‰§è¡Œæƒ…å†µã€‚</li><li>å¦‚æœåªåœ¨æ‰§è¡Œçš„ AOF é‡å†™è¿”å›ä¸€ä¸ªé”™è¯¯ï¼ŒAOF é‡å†™å°†ä¼šåœ¨ç¨åä¸€ç‚¹çš„æ—¶é—´é‡æ–°è°ƒç”¨ã€‚</li></ul></li></ul><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/3606763245-5b73cfc6d009c_articlex.jpg" srcset="/img/loading.gif" alt="3606763245-5b73cfc6d009c_articlex"></p><ul><li>AOF é‡å†™é…ç½®</li></ul><table><thead><tr><th align="left">é…ç½®å</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">auto-aof-rewrite-min-size</td><td align="left">è§¦å‘ AOF æ–‡ä»¶æ‰§è¡Œé‡å†™çš„æœ€å°å°ºå¯¸</td></tr><tr><td align="left">auto-aof-rewrite-percentage</td><td align="left">è§¦å‘ AOF æ–‡ä»¶æ‰§è¡Œé‡å†™çš„å¢é•¿ç‡</td></tr></tbody></table><table><thead><tr><th align="left">ç»Ÿè®¡å</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">aof_current_size</td><td align="left">AOF æ–‡ä»¶å½“å‰å°ºå¯¸ï¼ˆå­—èŠ‚ï¼‰</td></tr><tr><td align="left">aof_base_size</td><td align="left">AOF æ–‡ä»¶ä¸Šæ¬¡å¯åŠ¨å’Œé‡å†™æ—¶çš„å°ºå¯¸ï¼ˆå­—èŠ‚ï¼‰</td></tr></tbody></table><blockquote><p>AOF é‡å†™è‡ªåŠ¨è§¦å‘æœºåˆ¶ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š</p><ul><li>aof_current_size &gt; auto-aof-rewrite-min-size</li><li>(aof_current_size - aof_base_size) * 100 / aof_base_size &gt; auto-aof-rewrite-percentage</li></ul></blockquote><p>å‡è®¾ Redis çš„é…ç½®é¡¹ä¸ºï¼š</p><pre><code class="hljs pseudocode">auto-aof-rewrite-min-size 64mbauto-aof-rewrite-percentage 100</code></pre><p> å½“ AOF æ–‡ä»¶çš„ä½“ç§¯å¤§äº 64Mbï¼Œå¹¶ä¸” AOF æ–‡ä»¶çš„ä½“ç§¯æ¯”ä¸Šä¸€æ¬¡é‡å†™ä¹‹ä¹…çš„ä½“ç§¯å¤§äº†è‡³å°‘ä¸€å€ï¼ˆ100%ï¼‰æ—¶ï¼ŒRedis å°†æ‰§è¡Œ bgrewriteaof å‘½ä»¤è¿›è¡Œé‡å†™ã€‚ </p><h3 id="AOF-é‡å†™çš„æµç¨‹"><a href="#AOF-é‡å†™çš„æµç¨‹" class="headerlink" title="AOF é‡å†™çš„æµç¨‹"></a>AOF é‡å†™çš„æµç¨‹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571317003921.png" srcset="/img/loading.gif" alt="1571317003921"></p><h2 id="AOF-ç›¸å…³é…ç½®"><a href="#AOF-ç›¸å…³é…ç½®" class="headerlink" title="AOF ç›¸å…³é…ç½®"></a>AOF ç›¸å…³é…ç½®</h2><pre><code class="hljs pseudocode"># å¼€å¯AOFæŒä¹…åŒ–æ–¹å¼appendonly yes# AOFæŒä¹…åŒ–æ–‡ä»¶åappendfilename appendonly-&lt;port&gt;.aof# æ¯ç§’æŠŠç¼“å†²åŒºçš„æ•°æ®åŒæ­¥åˆ°ç£ç›˜appendfsync everysec# æ•°æ®æŒä¹…åŒ–æ–‡ä»¶å­˜å‚¨ç›®å½•dir &#x2F;var&#x2F;lib&#x2F;redis# æ˜¯å¦åœ¨æ‰§è¡Œé‡å†™æ—¶ä¸åŒæ­¥æ•°æ®åˆ°AOFæ–‡ä»¶# è¿™é‡Œçš„ yesï¼Œå°±æ˜¯æ‰§è¡Œé‡å†™æ—¶ä¸åŒæ­¥æ•°æ®åˆ°AOFæ–‡ä»¶no-appendfsync-on-rewrite yes# è§¦å‘AOFæ–‡ä»¶æ‰§è¡Œé‡å†™çš„æœ€å°å°ºå¯¸auto-aof-rewrite-min-size 64mb# è§¦å‘AOFæ–‡ä»¶æ‰§è¡Œé‡å†™çš„å¢é•¿ç‡auto-aof-rewrite-percentage 100</code></pre><h2 id="AOF-çš„ä¼˜ç‚¹"><a href="#AOF-çš„ä¼˜ç‚¹" class="headerlink" title="AOF çš„ä¼˜ç‚¹"></a>AOF çš„ä¼˜ç‚¹</h2><ol><li>ä½¿ç”¨ <code>AOF</code> ä¼šè®©ä½ çš„ <code>Redis</code> æ›´åŠ è€ä¹…ï¼šä½ å¯ä»¥ä½¿ç”¨ä¸åŒçš„ <code>fsync</code> ç­–ç•¥ï¼šæ—  <code>fsync</code>ï¼Œæ¯ç§’ <code>fsync</code>ï¼Œæ¯æ¬¡å†™çš„æ—¶å€™ <code>fsync</code>ã€‚ä½¿ç”¨é»˜è®¤çš„æ¯ç§’ <code>fsync</code> ç­–ç•¥ï¼Œ<code>Redis</code> çš„æ€§èƒ½ä¾ç„¶å¾ˆå¥½ (<code>fsync</code> æ˜¯ç”±åå°çº¿ç¨‹è¿›è¡Œå¤„ç†çš„ï¼Œä¸»çº¿ç¨‹ä¼šå°½åŠ›å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚)ï¼Œä¸€æ—¦å‡ºç°æ•…éšœï¼Œä½ æœ€å¤šä¸¢å¤± 1 ç§’çš„æ•°æ®ã€‚</li><li><code>AOF</code> æ–‡ä»¶æ˜¯ä¸€ä¸ªåªè¿›è¡Œè¿½åŠ çš„æ—¥å¿—æ–‡ä»¶ï¼Œæ‰€ä»¥ä¸éœ€è¦å†™å…¥ seekï¼Œå³ä½¿ç”±äºæŸäº›åŸå›  (ç£ç›˜ç©ºé—´å·²æ»¡ï¼Œå†™çš„è¿‡ç¨‹ä¸­å®•æœºç­‰ç­‰) æœªæ‰§è¡Œå®Œæ•´çš„å†™å…¥å‘½ä»¤ï¼Œä½ ä¹Ÿä¹Ÿå¯ä½¿ç”¨ <code>redis-check-aof</code> å·¥å…·ä¿®å¤è¿™äº›é—®é¢˜ã€‚</li><li><code>Redis</code> å¯ä»¥åœ¨ <code>AOF</code> æ–‡ä»¶ä½“ç§¯å˜å¾—è¿‡å¤§æ—¶ï¼Œè‡ªåŠ¨åœ°åœ¨åå°å¯¹ <code>AOF</code> è¿›è¡Œé‡å†™ï¼š é‡å†™åçš„æ–° <code>AOF</code> æ–‡ä»¶åŒ…å«äº†æ¢å¤å½“å‰æ•°æ®é›†æ‰€éœ€çš„æœ€å°å‘½ä»¤é›†åˆã€‚ æ•´ä¸ªé‡å†™æ“ä½œæ˜¯ç»å¯¹å®‰å…¨çš„ï¼Œå› ä¸º <code>Redis</code> åœ¨åˆ›å»ºæ–° <code>AOF</code> æ–‡ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¼šç»§ç»­å°†å‘½ä»¤è¿½åŠ åˆ°ç°æœ‰çš„ <code>AOF</code> æ–‡ä»¶é‡Œé¢ï¼Œå³ä½¿é‡å†™è¿‡ç¨‹ä¸­å‘ç”Ÿåœæœºï¼Œç°æœ‰çš„ <code>AOF</code> æ–‡ä»¶ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ è€Œä¸€æ—¦æ–° <code>AOF</code> æ–‡ä»¶åˆ›å»ºå®Œæ¯•ï¼Œ<code>Redis</code> å°±ä¼šä»æ—§ <code>AOF</code> æ–‡ä»¶åˆ‡æ¢åˆ°æ–° <code>AOF</code> æ–‡ä»¶ï¼Œå¹¶å¼€å§‹å¯¹æ–° <code>AOF</code> æ–‡ä»¶è¿›è¡Œè¿½åŠ æ“ä½œã€‚</li><li><code>AOF</code> æ–‡ä»¶æœ‰åºåœ°ä¿å­˜äº†å¯¹æ•°æ®åº“æ‰§è¡Œçš„æ‰€æœ‰å†™å…¥ä½œï¼Œ è¿™äº›å†™å…¥æ“ä½œä»¥ Redis åè®®çš„æ ¼å¼ä¿å­˜ï¼Œ å› æ­¤ <code>AOF</code> æ–‡ä»¶çš„å†…å®¹éå¸¸å®¹æ˜“è¢«äººè¯»æ‡‚ï¼Œ å¯¹æ–‡ä»¶è¿›è¡Œåˆ†æï¼ˆparseï¼‰ä¹Ÿå¾ˆè½»æ¾ã€‚ å¯¼å‡ºï¼ˆexportï¼‰ AOF æ–‡ä»¶ä¹Ÿéå¸¸ç®€å•ï¼š ä¸¾ä¸ªä¾‹å­ï¼Œ å¦‚æœä½ ä¸å°å¿ƒæ‰§è¡Œäº† <code>FLUSHALL</code> å‘½ä»¤ï¼Œ ä½†åªè¦ <code>AOF</code> æ–‡ä»¶æœªè¢«é‡å†™ï¼Œ é‚£ä¹ˆåªè¦åœæ­¢æœåŠ¡å™¨ï¼Œ ç§»é™¤ <code>AOF</code> æ–‡ä»¶æœ«å°¾çš„ <code>FLUSHALL</code> å‘½ä»¤ï¼Œ å¹¶é‡å¯ <code>Redis</code> ï¼Œ å°±å¯ä»¥å°†æ•°æ®é›†æ¢å¤åˆ° <code>FLUSHALL</code> æ‰§è¡Œä¹‹å‰çš„çŠ¶æ€ã€‚</li></ol><h2 id="AOF-çš„ç¼ºç‚¹"><a href="#AOF-çš„ç¼ºç‚¹" class="headerlink" title="AOF çš„ç¼ºç‚¹"></a>AOF çš„ç¼ºç‚¹</h2><ol><li>å¯¹äºç›¸åŒçš„æ•°æ®é›†æ¥è¯´ï¼Œ<code>AOF</code> æ–‡ä»¶çš„ä½“ç§¯é€šå¸¸è¦å¤§äº <code>RDB</code> æ–‡ä»¶çš„ä½“ç§¯;</li><li>æ ¹æ®æ‰€ä½¿ç”¨çš„ <code>fsync</code> ç­–ç•¥ï¼ŒAOF çš„é€Ÿåº¦å¯èƒ½ä¼šæ…¢äº <code>RDB</code> ã€‚ åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ æ¯ç§’ fsync çš„æ€§èƒ½ä¾ç„¶éå¸¸é«˜ï¼Œ è€Œå…³é—­ <code>fsync</code> å¯ä»¥è®© <code>AOF</code> çš„é€Ÿåº¦å’Œ <code>RDB</code> ä¸€æ ·å¿«ï¼Œ å³ä½¿åœ¨é«˜è´Ÿè·ä¹‹ä¸‹ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ ä¸è¿‡åœ¨å¤„ç†å·¨å¤§çš„å†™å…¥è½½å…¥æ—¶ï¼Œ<code>RDB</code> å¯ä»¥æä¾›æ›´æœ‰ä¿è¯çš„æœ€å¤§å»¶è¿Ÿæ—¶é—´ï¼ˆlatencyï¼‰ã€‚</li></ol><h1 id="RDB-å’Œ-AOF-çš„æŠ‰æ‹©"><a href="#RDB-å’Œ-AOF-çš„æŠ‰æ‹©" class="headerlink" title="RDB å’Œ AOF çš„æŠ‰æ‹©"></a>RDB å’Œ AOF çš„æŠ‰æ‹©</h1><h2 id="RDB-å’Œ-AOF-å¯¹æ¯”"><a href="#RDB-å’Œ-AOF-å¯¹æ¯”" class="headerlink" title="RDB å’Œ AOF å¯¹æ¯”"></a>RDB å’Œ AOF å¯¹æ¯”</h2><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">RDB</th><th align="left">AOF</th></tr></thead><tbody><tr><td align="left">å¯åŠ¨ä¼˜å…ˆçº§</td><td align="left">ä½</td><td align="left">é«˜</td></tr><tr><td align="left">ä½“ç§¯</td><td align="left">å°</td><td align="left">å¤§</td></tr><tr><td align="left">æ¢å¤é€Ÿåº¦</td><td align="left">å¿«</td><td align="left">æ…¢</td></tr><tr><td align="left">æ•°æ®å®‰å…¨æ€§</td><td align="left">ä¸¢æ•°æ®</td><td align="left">æ ¹æ®ç­–ç•¥å†³å®š</td></tr><tr><td align="left">è¾ƒé‡</td><td align="left">é‡</td><td align="left">è½»</td></tr></tbody></table><p><code>RDB</code>æ˜¯ä¸€ä¸ªå¾ˆé‡çš„æ“ä½œï¼Œå› ä¸ºå®ƒè¦å°†å…¨éƒ¨çš„<code>Redis</code>æ•°æ®æŒªåˆ°ç¡¬ç›˜ä¸­ï¼Œè¿™ä¸ªæ“ä½œå°±æ¶‰åŠåˆ°å¾ˆå¤šæ–¹ä¾¿ï¼Œæˆ‘ä»¬è¦æŠŠè¿™ä¸ªæ•°æ®å…¨éƒ¨ç”±å†…å­˜å»å¯¼åˆ°ç¡¬ç›˜ï¼Œé¦–å…ˆç¡¬ç›˜å†™å…¥é‡å°±å¾ˆå¤§è€Œä¸”å®ƒæ˜¯ä¸€ä¸ªCPUå¯†é›†å½¢æ“ä½œï¼ŒåŒæ—¶å®ƒè¿˜æ‰§è¡Œ<code>bgsave</code>çš„è¯ä¼šæ‰§è¡Œä¸€ä¸ª<code>fork</code>ä¼šäº§ç”Ÿä¸€å®šå†…å­˜å¼€é”€ï¼›</p><p><code>AOF</code>æ¥è¯´ä¸è®¨è®ºé‡æ–°ï¼Œå®ƒæœ¬èº«æ˜¯ä¸€ä¸ªè¿½åŠ æ—¥å¿—ï¼Œå¯¹äºå¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå¯¹ç¡¬ç›˜æ˜¯æœ‰ä¸€å®šå‹åŠ›ï¼Œä½†æ€»ä½“æ˜¯å¾ˆè½»çš„ã€‚</p><h2 id="RDBæœ€ä½³ç­–ç•¥"><a href="#RDBæœ€ä½³ç­–ç•¥" class="headerlink" title="RDBæœ€ä½³ç­–ç•¥"></a>RDBæœ€ä½³ç­–ç•¥</h2><ul><li>æŠŠRDBâ€œå…³â€æ‰ï¼šè¿™é‡Œçš„å…³æ˜¯ä¸€ä¸ªå¼•å·ï¼Œå› ä¸ºåé¢ä¼šä»‹ç»<code>Redis</code>ä¸»ä»å¤åˆ¶ï¼Œ<code>Redis</code>ä¸»ä»å¤åˆ¶å®ƒèµ·åˆ°ä¸€ä¸ªå…¨é‡å¤åˆ¶ï¼Œéœ€è¦ä¸»èŠ‚ç‚¹å»æ‰§è¡Œä¸€æ¬¡<code>bgsave</code>ç„¶åæŠŠ<code>rdbæ–‡ä»¶</code>ä¼ ç»™ä»èŠ‚ç‚¹ï¼Œæ¥å®ç°ä¸€ä¸ªå¤åˆ¶çš„æ•ˆæœï¼Œç¬¬ä¸€æ¬¡å…¨é‡å¤åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œçš„å…³æ˜¯æ°¸è¿œå…³ä¸æ‰çš„ï¼›</li><li>é›†ä¸­ç®¡ç†ï¼š<code>RDB</code>æ˜¯ä¸€ä¸ªå¾ˆé‡çš„æ“ä½œï¼Œå¯¹äºæˆ‘ä»¬æ•°æ®å¤‡ä»½æ˜¯æœ‰ä¸€å®šä½œç”¨çš„ï¼Œå‡å¦‚æˆ‘ä»¬çœŸçš„æƒ³æŒ‰å¤©ã€æŒ‰å°æ—¶æ¥æ¯”è¾ƒå¤§çš„é‡çº§æ¥å¤‡ä»½æ•°æ®ï¼Œæˆ–è€…æŒ‰å¤©æ¥å¤‡ä»½æ•°æ®é‚£ä¹ˆ<code>RDB</code>æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒçš„æ–‡ä»¶å¤§å°æ¯”è¾ƒå°ï¼Œå®ƒçš„ä¼ è¾“é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œå¯¹äºç®¡ç†æœ‰ä¼˜åŠ¿ï¼›</li><li>ä¸»ä»ï¼Œä»å¼€ï¼Ÿï¼šåœ¨åˆ«çš„åœºæ™¯ä¸‹æœ‰çš„æ—¶å€™æ˜¯éœ€è¦åœ¨ä»èŠ‚ç‚¹å»å¼€ä¸€ä¸‹<code>RDB</code>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨æœ¬åœ°å»ä¿å­˜ä¸€ä¸ªå†å²çš„<code>RDB</code>æ–‡ä»¶è¿™æ ·æ˜¯æœ‰ä¸€å®šä¼˜åŠ¿çš„ä½†æ˜¯ä¸€å®šè¦æ§åˆ¶<code>save</code>ä¸è¦å¤ªé¢‘ç¹ï¼Œè¿™æ ·åŠæ—¶æ˜¯ä»èŠ‚ç‚¹ï¼Œè™½ç„¶ä¸è¿›è¡Œ<code>Redis</code> çš„ä¸€ä¸ªè¯»å†™ï¼Œä½†æ˜¯æˆ‘ä»¬æ‰€æœ‰çš„<code>Redis</code>éƒ½æ˜¯ä¸€ä¸ªæ··åˆéƒ¨ç½²ï¼ˆå•æœºå¤šéƒ¨ç½²ï¼‰ï¼Œ<code>RDB</code>æ˜¯ä¸€ä¸ªå¾ˆé‡çš„æ“ä½œä¼šå¤šç¡¬ç›˜ã€CPUã€å†…å­˜æœ‰ä¸€å®šå½±å“ï¼Œè¿™ä¸ªè¦æ ¹æ®å®é™…å¼€å‘æ¥è¿›è¡Œè®¾å®šã€‚</li></ul><h2 id="AOPæœ€ä½³ç­–ç•¥"><a href="#AOPæœ€ä½³ç­–ç•¥" class="headerlink" title="AOPæœ€ä½³ç­–ç•¥"></a>AOPæœ€ä½³ç­–ç•¥</h2><ul><li>â€œå¼€â€ï¼šç¼“å­˜å’Œå­˜å‚¨ï¼šå¤§éƒ¨åˆ†æƒ…å†µæ˜¯å»ºè®®å¼€çš„ï¼Œè¿™æ ·å¯ä»¥ä½“ç°<code>Redis</code>çš„ç‰¹ç‚¹ï¼Œå¯ä»¥æŒä¹…åŒ–ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹åªä¼šä¸¢ä¸€ç§’æ•°æ®ï¼Œé€šå¸¸è®¾ç½®ç­–ç•¥ä¸ºæ¯ç§’å»åˆ·æ–°ç£ç›˜ï¼Œä½†æ˜¯æœ‰çš„æ—¶å€™ï¼Œä¾‹å¦‚ç¼“å­˜çš„åœºæ™¯ï¼Œå®ƒå®Œå…¨æ‹¿<code>Redis</code>å½“ä¸€ä¸ªç¼“å­˜ï¼Œå³ä½¿é‡Œé¢æ•°æ®ä¸¢äº†ï¼Œé‚£ä¹Ÿæ— æ‰€è°“ï¼Œåªéœ€è¦ä¸‹æ¬¡åŠ è½½çš„æ—¶å€™ä»æ•°æ®æºåŠ è½½è¿›æ¥å°±å¥½ï¼Œè€Œä¸”å®ƒå¯¹æ•°æ®æºå‹åŠ›ä¹Ÿæ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œå‡å¦‚ä½ çš„è®¿é—®å¯¹æ•°æ®æºæ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œç¼“å­˜ä¹Ÿåªæ˜¯èµ·åˆ°ä¸€å®šçš„ç¼“å­˜ä½œç”¨æ—¶å€™ï¼Œè¿™æ ·æ—¶å€™å¯ä»¥å…³é—­æ‰ï¼Œ<code>AOF</code>æ˜¯æœ‰ä¸€å®šçš„å¼€é”€çš„ï¼›</li><li><code>AOF</code>é‡å†™é›†ä¸­ç®¡ç†ï¼šè¿™æ ·ä»¥åä¼šæåˆ°ï¼Œå¤§æ¦‚è¯´ä¸€ä¸‹ï¼Œåœ¨å•æœºå¤šéƒ¨ç½²çš„æƒ…å†µä¸‹ï¼Œ å¦‚æœ<code>AOF</code>é›†ä¸­å‘ç”Ÿå¤§é‡çš„<code>fork</code>ï¼Œä½†æ˜¯æˆ‘ä»¬æœºå™¨å†…å­˜æ¯”å¦‚æ˜¯ç™¾åˆ†ç™¾çš„è¯ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¼šåˆ†é…ç™¾åˆ†60~70çš„å†…å­˜ç»™<code>Redis</code>ï¼Œç•™20-30ç»™<code>fork</code>åšæ“ä½œï¼Œå‡å¦‚é›†ä¸­åš<code>fork</code>,æœ‰å¯èƒ½ä¼šå‡ºç°å†…å­˜çˆ†æ»¡çš„æƒ…å†µï¼›</li><li>everysecï¼šå»ºè®®ä½¿ç”¨æ¯ç§’å»åˆ·ç›˜ã€‚</li></ul><h2 id="æœ€ä½³ç­–ç•¥"><a href="#æœ€ä½³ç­–ç•¥" class="headerlink" title="æœ€ä½³ç­–ç•¥"></a>æœ€ä½³ç­–ç•¥</h2><p>æ— è®ºä½¿ç”¨<code>AOF</code>ã€<code>RDB</code>ï¼Œéƒ½å¯ä»¥å»å‚è€ƒ</p><ul><li>å°åˆ†ç‰‡ï¼šæˆ‘ä»¬ä½¿ç”¨ä½¿ç”¨<code>maxmemory</code>ä¸º<code>Redis</code>è¿›è¡Œè§„åˆ’ï¼Œä¾‹å¦‚æˆ‘ä»¬æ¯ä¸ª<code>Redis</code>ä¸€ä¸ª<code>maxmemory</code>åªè®¾ç½®æœ€å¤§å†…å­˜ä¸º<code>4G</code>,è¿™æ ·æ— è®ºæ˜¯<code>fork</code>è¿˜æ˜¯<code>RDB</code>å¤åˆ¶çš„ä¼ è¾“å®ƒéƒ½ä¼šè¾ƒå°çš„å¼€é”€ï¼›</li><li>ç¼“å­˜æˆ–å­˜å‚¨ï¼šå°åˆ†ç‰‡å°±æ˜¯å¤„ç†è¿™äº›é—®é¢˜çš„æœ€å¥½æ–¹æ³•ï¼Œå½“ç„¶å®ƒä¹Ÿæœ‰ä¸€å®šçš„é—®é¢˜ï¼Œåœ¨åˆ†å¸ƒå¼æƒ…å†µä¸‹æˆ‘ä»¬è¦äº§ç”Ÿæ›´å¤šä¸€ä¸ª<code>Redis</code>è¿›ç¨‹ï¼Œé‚£æ ·å¯èƒ½å¯¹CPUå ç”¨ä¼šæ›´å¤šä¸€äº›ï¼Œè¿˜æœ‰å‰é¢æåˆ°çš„æ ¹æ®å­˜å‚¨å’Œç¼“å­˜çš„ç‰¹æ€§å»å†³å®šä½¿ç”¨å“ªç§ç­–ç•¥ï¼›</li><li>ç›‘æ§ï¼ˆç¡¬ç›˜ã€å†…å­˜ã€è´Ÿè½½ã€ç½‘ç»œï¼‰ï¼šè¿™ä¸ªç›¸ä¿¡åœ¨å„å„å…¬å¸éƒ½ä¼šæœ‰å¼€å‘è½¯ä»¶å»ç›‘æ§æœºå™¨çš„æ–¹é¢ï¼Œè¿™æ ·å¯ä»¥å¯¹æœºå™¨æœ‰ä¸€ä¸ªå…¨é¢äº†è§£ï¼Œç„¶ååœ¨å®šä½é—®é¢˜çš„æ—¶å€™å»æŠ“åˆ°ä¸€ä¸ªå…³é”®ç‚¹ï¼›</li><li>è¶³å¤Ÿçš„å†…å­˜ï¼šå‰é¢æåˆ°ä¸è¦æœ‰ç™¾åˆ†ç™¾å†…å­˜æŠŠå®ƒå…¨éƒ½å¸ƒæ»¡ï¼Œå¸ƒæ»¡çš„æƒ…å†µä¼šäº§ç”Ÿå¾ˆå¤šé—®é¢˜ï¼Œåƒforkã€å…¶ä»–å†…å­˜çš„é£™å‡ä¾‹å¦‚å®¢æˆ·ç«¯ç¼“å†²åŒºå®ƒä¸å—<code>maxmemory</code>çš„é™åˆ¶ç±»ä¼¼è¿™æ ·çš„é—®é¢˜ï¼Œå®ƒéƒ½æ˜¯æœ‰é¢å¤–çš„å†…å­˜æ¶ˆè€—çš„ï¼Œåœ¨å®é™…éƒ¨ç½²ä¸­ä¸€å®šè¦æ ¹æ®åœºæ™¯è¿›è¡Œé€‰æ‹©ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘  3.ç‘å£«å†›åˆ€</title>
    <link href="/redis-3.html"/>
    <url>/redis-3.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ…¢æŸ¥è¯¢"><a href="#æ…¢æŸ¥è¯¢" class="headerlink" title="æ…¢æŸ¥è¯¢"></a>æ…¢æŸ¥è¯¢</h1><h2 id="ç”Ÿå‘½å‘¨æœŸ"><a href="#ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ç”Ÿå‘½å‘¨æœŸ"></a>ç”Ÿå‘½å‘¨æœŸ</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571141370781.png" srcset="/img/loading.gif" alt="1571141370781"></p><p><code>Redis</code>æ˜¯ä¸€ä¸ªå•çº¿ç¨‹ï¼Œå½“æœ‰å¤šä¸ªå‘½ä»¤å‘é€è¿‡æ¥æ—¶ï¼Œå®ƒæ˜¯ä¼šè¿›è¡Œæ’é˜Ÿçš„æ‰§è¡Œå‘½ä»¤ï¼Œæ‰§è¡Œå®Œæˆä¹‹åè¿”å›ä¸€ä¸ªç»“æœç»™å®¢æˆ·ç«¯ï¼Œè¿™è¾¹æ ‡é¢˜è®²çš„æ˜¯æ…¢æŸ¥è¯¢ï¼Œåœ¨å›¾ä¸Šæ…¢æŸ¥è¯¢ä¼šå‡ºç°åœ¨ç¬¬ä¸‰é˜¶æ®µ</p><ul><li>æ…¢æŸ¥è¯¢æ˜¯æŒ‡æ‰§è¡Œå‘½ä»¤æ‰€æ¶ˆè€—çš„æ—¶é—´ï¼Œæ³¨æ„ï¼šè¿™é‡Œä¸åŒ…æ‹¬æ’é˜Ÿã€ç½‘ç»œéƒ½ä¸ç®—ï¼›</li><li>å®¢æˆ·ç«¯è¶…æ—¶ä¸ä¸€å®šæœ‰æ…¢æŸ¥è¯¢ï¼Œä½†æ…¢æŸ¥è¯¢æ˜¯å®¢æˆ·ç«¯è¶…æ—¶çš„ä¸€ä¸ªå¯èƒ½å› ç´ ã€‚</li></ul><h2 id="ä¸¤ä¸ªé…ç½®"><a href="#ä¸¤ä¸ªé…ç½®" class="headerlink" title="ä¸¤ä¸ªé…ç½®"></a>ä¸¤ä¸ªé…ç½®</h2><h3 id="slowlog-max-len"><a href="#slowlog-max-len" class="headerlink" title="slowlog-max-len"></a>slowlog-max-len</h3><ol><li>æ…¢æŸ¥è¯¢æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºå¯¹åˆ—ï¼Œå‡å¦‚æˆ‘ä»¬ä¸€æ¡å‘½ä»¤åœ¨ç¬¬ä¸‰æ­¥è¿‡ç¨‹ä¸­ï¼Œå®ƒè¢«åˆ—å…¥æ…¢æŸ¥è¯¢èŒƒå›´å†…ï¼Œå®ƒå°±ä¼šè¿›å…¥ä¸€ä¸ªå¯¹åˆ—ï¼Œå…¶å®å®ƒæ˜¯ç”¨<code>Redis</code>åˆ—è¡¨æ¥  å®ç°çš„ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å¯¹åˆ—ï¼›</li><li>å½“ä½ çš„å¯¹åˆ—æ»¡äº†ä¹‹åï¼Œæœ€å…ˆè¿›çš„ä¼šè¢«çš„ä¸€ä¸ªTå‡ºå»ï¼Œæ¯”å¦‚æˆ‘ä»¬æ…¢æŸ¥è¯¢çš„åˆ—è¡¨æ˜¯ä¸€ä¸ªå›ºå®šé•¿åº¦çš„ï¼›</li><li>å¯¹åˆ—ä¿å­˜åœ¨å†…å­˜å½“ä¸­ï¼Œå½“<code>Redis</code>è¿›è¡Œé‡å¯ä¹‹åï¼Œä¸ä¼šæŒä¹…åŒ–ï¼Œè€Œæ˜¯éšç€é‡å¯è€Œæ¶ˆå¤±ã€‚</li></ol><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571142116030.png" srcset="/img/loading.gif" alt=""></p><p>è¿™é‡Œä½ è®¾ç»™<code>Redis</code>è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå®¢æˆ·ç«¯å‘é€å‘½ä»¤æ—¶ï¼Œå¦‚æœå‘½ä»¤è¶…è¿‡äº†ç»™å®šçš„æ—¶é—´ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥æ…¢æŸ¥è¯¢å¯¹åˆ—ä¸­ï¼›è¿™é‡Œè¿˜ç»™<code>Redis</code>è®¾ç½®äº†æ…¢æŸ¥è¯¢å¯¹åˆ—è®¾ç½®äº†é•¿åº¦ï¼Œé™åˆ¶å¯¹åˆ—ä¸­çš„æ…¢æŸ¥è¯¢å‘½ä»¤çš„æ•°é‡ï¼Œå½“å¯¹åˆ—æ»¡çš„æ—¶å€™ï¼Œå†è¿›å…¥ä¸€æ¡ä¼šå°†æœ€å‰é¢è¿›çš„Tæ‰</p><h3 id="slowlog-log-slower-than"><a href="#slowlog-log-slower-than" class="headerlink" title="slowlog-log-slower-than"></a>slowlog-log-slower-than</h3><ol><li><code>slowlog-log-slower-than</code>ï¼Œæ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå•ä½ï¼šå¾®å¦™ï¼‰ï¼Œå½“å‘½ä»¤å¤§äºå¤šå°‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†å®ƒä»‹å…¥åˆ°æ…¢æŸ¥è¯¢çš„èŒƒå›´å†…ï¼›</li><li><code>slowlog-log-slower-than=0</code> ï¼Œå¦‚æœæƒ³è®°å½•æ‰€æœ‰å‘½ä»¤ï¼Œå°±å°†å®ƒè®¾ç½®ä¸º0ï¼›ä½†ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆåšï¼Œä½†æ˜¯åœ¨ä¸€äº›ç‰¹å®šåœºåˆä¹Ÿä¼šæœ‰å¸®åŠ©ï¼Œæ¯”å¦‚ä½ æƒ³çŸ¥é“æ¯æ¡å‘½ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œåœ¨å®¢æˆ·ç«¯ä¸­æ˜¯ä¸ä¼šè¿”å›æ‰§è¡Œæ—¶é—´çš„ï¼Œè¿™é‡Œå°±è®¾ç½®ä¸º0</li><li><code>slowlog-log-slower-than&lt;0</code>ï¼Œä¸è®°å½•å¦‚ä½•å‘½ä»¤ã€‚</li></ol><h3 id="é…ç½®æ–¹æ³•"><a href="#é…ç½®æ–¹æ³•" class="headerlink" title="é…ç½®æ–¹æ³•"></a>é…ç½®æ–¹æ³•</h3><ol><li>é»˜è®¤å€¼<ul><li>config get slowlog-max-len=128</li><li>config get slowlog-log-slower-than=10000</li></ul></li><li>ä¿®æ”¹é…ç½®æ–‡ä»¶é‡å¯ï¼Œè¿™ç§æ“ä½œä¸å»ºè®®å»ä½¿ç”¨ï¼Œè¿™ç§æ“ä½œæ˜¯åœ¨ç¬¬ä¸€æ¬¡è¿è¡Œ<code>Redis</code>çš„æ—¶å€™å»è¿›è¡Œï¼Œå¦‚æœä½ çš„<code>Redis</code>å¯åŠ¨äº†ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ï¼›</li><li>åŠ¨æ€é…ç½®ï¼›<ul><li>config set slowlog-max-len 1000</li><li>config set slowlog-log-slower-than 1000</li></ul></li></ol><h2 id="ä¸‰ä¸ªå‘½ä»¤"><a href="#ä¸‰ä¸ªå‘½ä»¤" class="headerlink" title="ä¸‰ä¸ªå‘½ä»¤"></a>ä¸‰ä¸ªå‘½ä»¤</h2><ol><li>slowlog get [n]ï¼šè·å–æ…¢æŸ¥è¯¢å¯¹åˆ—ï¼Œè¿™é‡Œçš„nå¯ä»¥é™åˆ¶å¯¹åˆ—çš„é•¿åº¦ï¼Œæ¯”å¦‚næ˜¯10ï¼Œé‚£ä¹ˆåˆ—è¡¨ä¸­æœ€å¤šåªèƒ½æŸ¥è¯¢å‡º10æ¡è®°å½•ï¼›</li><li>slowlog lenï¼šè·å–æ…¢æŸ¥è¯¢å¯¹åˆ—é•¿åº¦ï¼Œå¦‚æœä½ æƒ³çŸ¥é“æ…¢æŸ¥è¯¢å¯¹åˆ—ä¸­æœ‰å¤šå°‘ä¸ªæ…¢æŸ¥è¯¢å¯ä»¥ä½¿ç”¨è¿™ç§å‘½ä»¤</li><li>slowlog resetï¼šæ¸…ç©ºæ…¢æŸ¥è¯¢å¯¹åˆ—ï¼›</li></ol><h2 id="è¿ç»´ç»éªŒ"><a href="#è¿ç»´ç»éªŒ" class="headerlink" title="è¿ç»´ç»éªŒ"></a>è¿ç»´ç»éªŒ</h2><ol><li><code>slowlog-max-len</code> å¯¹åˆ—é•¿åº¦ä¸è¦è®¾ç½®è¿‡å°ï¼Œé€šå¸¸è®¾ç½®1000å·¦å³ï¼Œå®ƒé»˜è®¤æ˜¯128ï¼Œå¯¹åˆ—æ˜¯å­˜åœ¨å†…å­˜å½“ä¸­çš„ï¼Œå½“æˆ‘ä»¬<code>Redis</code>é‡å¯ä¹‹åå®ƒçš„åˆ—è¡¨å°±æ¸…ç©ºäº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„å¯¹åˆ—ï¼Œéšç€æˆ‘ä»¬æ…¢æŸ¥è¯¢æ•°é‡ä¸æ–­å¢åŠ ï¼Œæœ€å¼€å§‹çš„æ…¢æŸ¥è¯¢å°±ä¼šä¸¢æ‰ï¼Œå¯¹äºåˆ†æä¸€ä¸ªå†å²çš„é—®é¢˜å¯èƒ½ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®å¤§ä¸€äº›ï¼›</li><li><code>slowlog-log-slower-than</code> è¶…æ—¶æ—¶é—´ä¸è¦è®¾ç½®è¿‡å¤§ï¼Œé»˜è®¤10msï¼Œé€šå¸¸è®¾ç½®1msï¼Œä¾‹å¦‚æˆ‘ä»¬<code>Redis</code>çš„QPSæ˜¯ä¸‡çº§åˆ«çš„ï¼Œæˆ‘ä»¬å¸Œæœ›å®ƒä¸€ç§’æ‰§è¡Œä¸€ä¸‡æ¬¡ï¼Œé‚£ä¹ˆå¹³å‡æ—¶é—´æ˜¯<code>0.01</code>æ¯«ç§’ï¼ŒåŠ å…¥è¯´æˆ‘ä»¬è®¾ç½®è¿‡å¤§çš„è¯ï¼Œå¿…é¡»10æ¯«ç§’æ‰èƒ½è®°å½•è¿™æ¡å‘½ä»¤ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´å®ƒå¯èƒ½è¶…è¿‡1æ¯«ç§’å°±å¯¹æˆ‘ä»¬<code>QPS</code>æ˜¯æœ‰å½±å“çš„ï¼Œè¿™é‡Œè¦æ ¹æ®<code>QPS</code>æ¥å†³å®šä½ ä¸€ä¸ªé˜ˆå€¼å¤§å°ï¼›</li><li>ç†è§£å‘½ä»¤ç”Ÿå‘½å‘¨æœŸï¼›</li><li>å®šæœŸæŒä¹…åŒ–æ…¢æŸ¥è¯¢ï¼Œè¿™ä¸ªé’ˆå¯¹ç¬¬äºŒæ¡ï¼Œæ…¢æŸ¥è¯¢å­˜å‚¨åœ¨å†…å­˜å½“ä¸­ï¼Œå¦‚æœé€šè¿‡<code>slowlog get</code>è¿™æ ·çš„å‘½ä»¤ï¼Œå®šæœŸå°†æ…¢æŸ¥è¯¢æŒä¹…åŒ–åˆ°å…¶ä»–çš„æ•°æ®æºï¼Œæ¯”å¦‚è¯´<code>mysql</code>ï¼Œè¿™æ ·å°±å¯ä»¥æŸ¥çœ‹åˆ°å†å²çš„æ…¢æŸ¥è¯¢æ“ä½œï¼Œå› ä¸ºæˆ‘ä»¬æ— è®ºè®¾ç½®å¤šå¤§çš„é•¿åº¦ï¼ˆslowlog-log-slower-thenï¼‰ï¼Œå½“æ…¢æŸ¥è¯¢é€æ­¥å¢å¤šçš„æ—¶å€™ï¼Œæœ€å¼€å§‹çš„å‘½ä»¤ä¼šè¢«ä¸¢æ‰ï¼Œå½“æˆ‘ä»¬æŸ¥ä¸€äº›å†å²é—®é¢˜æ—¶è¿™äº›æ•°æ®æ˜¯éå¸¸å…³é”®çš„ï¼Œæ‰€ä»¥ä½ å¯ä»¥ä½¿ç”¨ä¸€äº›æ‰‹æ®µæˆ–è€…å¼€æºçš„è½¯ä»¶æ¥å®ç°è¿™äº›åŠŸèƒ½ã€‚</li></ol><h1 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h1><h2 id="ä»€ä¹ˆæµæ°´çº¿"><a href="#ä»€ä¹ˆæµæ°´çº¿" class="headerlink" title="ä»€ä¹ˆæµæ°´çº¿"></a>ä»€ä¹ˆæµæ°´çº¿</h2><h3 id="ä¸€æ¬¡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹"><a href="#ä¸€æ¬¡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹" class="headerlink" title="ä¸€æ¬¡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹"></a>ä¸€æ¬¡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571144910775.png" srcset="/img/loading.gif" alt="1571144910775"></p><p>å®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œå°†å‘½ä»¤ä¼ è¾“ç»™æœåŠ¡ç«¯ï¼Œå½“æœåŠ¡ç«¯ä¼šæœ‰ä¸€äº›æ’é˜Ÿã€å‘½ä»¤å°†å®ƒå¿½ç•¥ï¼Œå°†å®ƒå½’çº³æˆè®¡ç®—ï¼Œç„¶åæŠŠç»“æœè¿›è¡Œè¿”å›ï¼Œä¸€æ¬¡å‘½ä»¤æ—¶é—´=1æ¬¡ç½‘è·¯æ—¶é—´+1æ¬¡å‘½ä»¤æ—¶é—´ï¼›</p><h3 id="æ‰¹é‡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹"><a href="#æ‰¹é‡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹" class="headerlink" title="æ‰¹é‡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹"></a>æ‰¹é‡ç½‘ç»œå‘½ä»¤é€šä¿¡æ¨¡å‹</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571145159164-1571145214835.png" srcset="/img/loading.gif" alt="1571145159164"></p><p>ä¹‹å‰å­¦è¿‡<code>mget</code>ã€<code>mset</code>è¿™æ ·çš„æ“ä½œï¼Œå‡å¦‚<code>Redis</code>ä¸­æ²¡æœ‰è¿™è¡Œå‘½ä»¤ï¼Œæˆ‘ä»¬åªèƒ½å°†å‘½ä»¤ä»¥næ¬¡å‘½ä»¤è¿›è¡Œå¾ªç¯ä¸€ä¸ªæ“ä½œï¼Œnæ¬¡æ—¶é—´=næ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤æ—¶é—´ï¼›</p><p>ä¸€æ¬¡å‘½ä»¤æ—¶é—´æ˜¯éå¸¸å¿«çš„ï¼Œ<code>Redis</code>çš„QPSå¯ä»¥è¾¾åˆ°ä¸‡çº§ï¼Œé‚£ä¹ˆç½‘ç»œç›¸åï¼Œæœ‰å¾ˆå¤§çš„ä¸åŒï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½å­˜çš„æ˜¯ä¸€ä¸ªå†…ç½‘ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå¤–ç½‘ï¼Œç”šè‡³å¯èƒ½æ˜¯ä¸€ä¸ªè·¨æœºæˆ¿ã€è·¨åœ°åŒºçš„æœ‰å¾ˆå¤šå¯èƒ½ã€‚æˆ‘ä»¬æƒ³å®ç°è¿™æ ·çš„å‘½ä»¤éœ€è¦æ€ä¹ˆå»åšå‘¢ï¼Ÿæ¯”å¦‚æˆ‘ä»¬æœ‰mæ¬¡getæ“ä½œå¯ä»¥ä½¿ç”¨mgetã€msetï¼Œé‚£æˆ‘æƒ³å®ç°mæ¬¡hmsetï¼Œæœ‰æ²¡mhset å‘¢ï¼ŸRedisæ˜¯æ²¡æœ‰çš„ï¼Œæˆ–è€…æˆ‘ä»¬æƒ³åŒæ—¶æ‰§è¡Œmsetã€mgetè¿™æ ·çš„æ“ä½œå‘½ä»¤è¿›è¡Œä¸€ä¸ªç»Ÿä¸€å‘é€è¦æ€ä¹ˆåšå‘¢ï¼Ÿè¿™å°±æ˜¯æµæ°´çº¿å¸®æˆ‘ä»¬å®ç°çš„åŠŸèƒ½ã€‚</p><p>æµæ°´çº¿</p><p>å®ƒæ˜¯å°†ä¸€æ‰¹å‘½ä»¤è¿›è¡Œä¸€ä¸ªæ‰¹é‡æ‰“åŒ…ï¼Œåœ¨æœåŠ¡ç«¯è¿›è¡Œæ‰¹é‡è®¡ç®—ï¼Œç„¶åæŒ‰é¡ºåºå°†ç»“æœè¿”å›ç»™æˆ‘ä»¬ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæµæ°´çº¿ï¼Œæˆ‘ä»¬ä¸€æ¬¡pipelineï¼ˆnè·³å‘½ä»¤ï¼‰=1æ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤æ—¶é—´ï¼Œå¯ä»¥å¤§å¤§å‡å°‘æˆ‘ä»¬ç½‘ç»œçš„å¼€é”€ï¼Œè¿™å°±æ˜¯æµæ°´çº¿</p><h3 id="æµæ°´çº¿ä½œç”¨"><a href="#æµæ°´çº¿ä½œç”¨" class="headerlink" title="æµæ°´çº¿ä½œç”¨"></a>æµæ°´çº¿ä½œç”¨</h3><table><thead><tr><th align="center">å‘½ä»¤</th><th align="center">Nä¸ªå‘½ä»¤æ“ä½œ</th><th align="center">1æ¬¡pipelineï¼ˆnä¸ªå‘½ä»¤ï¼‰</th></tr></thead><tbody><tr><td align="center">æ—¶é—´</td><td align="center">næ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤</td><td align="center">1æ¬¡ç½‘ç»œæ—¶é—´+næ¬¡å‘½ä»¤</td></tr><tr><td align="center">æ•°æ®é‡</td><td align="center">1æ¡å‘½ä»¤</td><td align="center">næ¡å‘½ä»¤</td></tr></tbody></table><p>æ³¨æ„ï¼š</p><ol><li><code>Redis</code>çš„å‘½ä»¤æ—¶é—´æ˜¯å¾®ç§’çº§åˆ«ï¼Œ<code>Redis</code>æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´æœ¬èº«æ˜¯éå¸¸å¿«çš„</li><li><code>pipeline</code>æ¯æ¬¡æ¡æ•°è¦æ§åˆ¶ï¼ˆç½‘è·¯ï¼‰ï¼Œ<code>Redis</code>çš„ç½‘ç»œä¼šæˆä¸ºç“¶é¢ˆï¼Œå› ä¸ºæˆ‘ä»¬ç½‘ç»œç¯å¢ƒè‚¯å®šä¼šç›¸å¯¹å¤æ‚ä¸€äº›ï¼Œæ‰€ä»¥<code>pipeline</code>å°±æ˜¯ä¸ºäº†è§£å†³næ¬¡æ“ä½œç½‘ç»œçš„æ—¶é—´å‡å°</li></ol><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571228474052.png" srcset="/img/loading.gif" alt="1571228474052"></p><p>è¿™å¼ åœ°å›¾ä¸Šï¼šåŒ—äº¬åˆ°ä¸Šæµ·æœ‰1åƒ3ç™¾å…¬é‡Œï¼Œå…‰é€Ÿ=3*108ç±³ç§’=30000å…¬é‡Œ/ç§’ï¼Œè¿™é‡ŒæŠŠå¤æ‚çš„ç½‘ç»œç¯å¢ƒè¿›è¡Œå¿½ç•¥ï¼Œè€Œæ˜¯å®Œå…¨å°†1åƒ3ç™¾å…¬é‡Œçœ‹æˆä¸€ä¸ªå…‰çº¤ï¼Œè€Œä¸”æŠŠå…‰çº¤=å…‰é€Ÿçš„2/3ï¼Œé‚£ä¹ˆä¸€æ¡å‘½ä»¤çš„ä¼ è¾“æ—¶é—´=ï¼ˆ1300 * 2ï¼‰/(300000 * 2/3)=13æ¯«ç§’ï¼Œæˆ‘ä¸€æ¡å‘½ä»¤åœ¨Redisçœ‹æ¥å°±å‡ å¾®å¦™ï¼Œä½†æ˜¯åœ¨ä¸€ä¸ªç½‘ç»œçš„ä¼ è¾“æ—¶é—´æ˜¯ä¸€ä¸ª13æ¯«ç§’ï¼Œè¿™é‡Œæƒ³è±¡æƒ³åšä¸€ä¸ªæ‰¹é‡æ“ä½œï¼Œæ²¡æœ‰ä½¿ç”¨<code>pipeline</code>è¿™æ ·çš„åŠŸèƒ½è€Œæ˜¯ä½¿ç”¨ä¼ ç»Ÿçš„ä¸€ä¸ªå¾ªç¯çš„éå†ï¼Œé‚£æˆ‘ä»¬çš„<code>Redis</code>ä½¿ç”¨æ•ˆç‡ä¸ä¼šå¾ˆé«˜ï¼Œå¦‚æœä½¿ç”¨äº†<code>pipeline</code>ï¼Œé‚£æ—¶é—´æ¶ˆè€—ä¼šè¢«åœ¨ç½‘ç»œä¸Šæ¶ˆè€—ä¸€æ¬¡ï¼Œå®ƒå‘½ä»¤æ‰¹é‡ä¼šæ‰§è¡Œæ¯”è¾ƒå¤šï¼Œè¿™åªæ˜¯ä¸€ä¸ªæç«¯çš„ä¾‹å­</p><h2 id="å®¢æˆ·ç«¯å®ç°"><a href="#å®¢æˆ·ç«¯å®ç°" class="headerlink" title="å®¢æˆ·ç«¯å®ç°"></a>å®¢æˆ·ç«¯å®ç°</h2><h3 id="ä¸ä½¿ç”¨pipeline"><a href="#ä¸ä½¿ç”¨pipeline" class="headerlink" title="ä¸ä½¿ç”¨pipeline"></a>ä¸ä½¿ç”¨pipeline</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571147034871.png" srcset="/img/loading.gif" alt="1571147034871"></p><h3 id="ä½¿ç”¨pipeline"><a href="#ä½¿ç”¨pipeline" class="headerlink" title="ä½¿ç”¨pipeline"></a>ä½¿ç”¨pipeline</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571147128248.png" srcset="/img/loading.gif" alt="1571147128248"></p><h2 id="ä¸åŸç”Ÿæ“ä½œå¯¹æ¯”"><a href="#ä¸åŸç”Ÿæ“ä½œå¯¹æ¯”" class="headerlink" title="ä¸åŸç”Ÿæ“ä½œå¯¹æ¯”"></a>ä¸åŸç”Ÿæ“ä½œå¯¹æ¯”</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571147368279.png" srcset="/img/loading.gif" alt="1571147368279"></p><ul><li>Mæ“ä½œï¼šMæ“ä½œå±äºåŸå­æ“ä½œï¼Œåœ¨<code>Redis</code>æœåŠ¡ç«¯å®ƒæ˜¯æœ‰è¿™æ ·çš„åŸç”Ÿå‘½ä»¤çš„ï¼Œæ‰€ä»¥å®ƒä¼šå…¶ä»–æ“ä½œåœ¨ä¸€ä¸ªå¯¹åˆ—ä¸­æ˜¯ä¸€ä¸ªæ´¾å¯¹çš„æ•ˆæœï¼›</li><li>pipelineï¼šå‡å¦‚pipelineæºå¸¦äº†1000æ¡å‘½ä»¤ï¼Œè€Œä¸”æˆ‘ä»¬æ˜¯åœ¨ä¸€ä¸ªéå¸¸é«˜çš„QPSç¯å¢ƒä¸‹å»æ‰§è¡Œçš„è¯ï¼Œé‚£å®ƒåˆ°redisçš„æ—¶å€™ï¼Œå®ƒæ˜¯å°†pipelineä¸­çš„å‘½ä»¤è¿›è¡Œæ‹†åˆ†ï¼Œè¿™é‡Œçš„å‘½ä»¤ä¸æ˜¯åŸå­çš„å‘½ä»¤ï¼Œè¿™é‡Œè¿”å›çš„ç»“æœæ˜¯æŒ‰é¡ºåºçš„ã€‚</li></ul><h2 id="ä½¿ç”¨å»ºè®®"><a href="#ä½¿ç”¨å»ºè®®" class="headerlink" title="ä½¿ç”¨å»ºè®®"></a>ä½¿ç”¨å»ºè®®</h2><ol><li>æ³¨æ„æ¯æ¬¡<code>pipeline</code>æºå¸¦æ•°æ®é‡ï¼Œ <code>pipeline</code>å¯ä»¥æé«˜æˆ‘ä»¬å¹¶å‘çš„æ•ˆç‡ï¼Œå°±æ˜¯æ‰¹é‡çš„æ•ˆç‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½æ— èŠ‚åˆ¶çš„å»ä½¿ç”¨ï¼Œå¦‚æœå®ç°100ä¸‡æ¬¡çš„æ‰¹é‡æ“ä½œï¼Œé‚£<code>Redis</code>å°†100ä¸‡ä¸ªå‘½ä»¤ä¸€æ¬¡ä¸€æ¬¡å‘é€ï¼Œæ¯”å¦‚ä¼šå¯¹ç½‘ç»œä»¥åŠå®¢æˆ·ç«¯ç­‰å¾…æ—¶é—´éƒ½ä¼šé€ æˆå½±å“ï¼›</li><li><code>pipeline</code>æ¯æ¬¡åªèƒ½ä½œç”¨åœ¨ä¸€ä¸ª<code>Redis</code>èŠ‚ç‚¹ä¸Šï¼›</li><li>Mæ“ä½œä¸<code>pipeline</code>åŒºåˆ«ä¸€å®šè¦æ³¨æ„ã€‚</li></ol><h1 id="å‘å¸ƒè®¢é˜…"><a href="#å‘å¸ƒè®¢é˜…" class="headerlink" title="å‘å¸ƒè®¢é˜…"></a>å‘å¸ƒè®¢é˜…</h1><h2 id="è§’è‰²"><a href="#è§’è‰²" class="headerlink" title="è§’è‰²"></a>è§’è‰²</h2><ul><li>å‘å¸ƒè€…ï¼ˆpublisherï¼‰</li><li>è®¢é˜…è€…ï¼ˆsubscriberï¼‰</li><li>é¢‘é“ï¼ˆchannelï¼‰</li></ul><p>å‘å¸ƒè€…æ¥å‘å¸ƒæ¶ˆæ¯ï¼Œè®¢é˜…è€…æ¥è®¢é˜…é¢‘é“ï¼Œå‘å¸ƒè€…ä¼šå‘å¸ƒå¯¹åº”çš„é¢‘é“ä¸Šï¼Œå‘å¸ƒè€…å‘å¸ƒäº†è®¢é˜…è€…è®¢é˜…çš„é¢‘é“ï¼Œè®¢é˜…è€…å°±èƒ½æ”¶åˆ°æ¶ˆæ¯</p><h2 id="å‘å¸ƒå‘½ä»¤"><a href="#å‘å¸ƒå‘½ä»¤" class="headerlink" title="å‘å¸ƒå‘½ä»¤"></a>å‘å¸ƒå‘½ä»¤</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571150382094.png" srcset="/img/loading.gif" alt="1571150382094"></p><p>è¿™é‡Œå¦‚æœå‘é€ç»™é¢‘é“ä¸€ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªé¢‘é“ä¸­æ²¡æœ‰è®¢é˜…è€…æ—¶ï¼Œè¿”å›ï¼š0</p><h2 id="è®¢é˜…"><a href="#è®¢é˜…" class="headerlink" title="è®¢é˜…"></a>è®¢é˜…</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571150465419.png" srcset="/img/loading.gif" alt="1571150465419"></p><h2 id="å–æ¶ˆè®¢é˜…"><a href="#å–æ¶ˆè®¢é˜…" class="headerlink" title="å–æ¶ˆè®¢é˜…"></a>å–æ¶ˆè®¢é˜…</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571150478793.png" srcset="/img/loading.gif" alt="1571150478793"></p><h2 id="å…¶ä»–API"><a href="#å…¶ä»–API" class="headerlink" title="å…¶ä»–API"></a>å…¶ä»–API</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571150551396.png" srcset="/img/loading.gif" alt="1571150551396"></p><h2 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h2><p>å®ƒäºå‘å¸ƒè®¢é˜…çš„åŒºåˆ«åœ¨äºï¼šå‘å¸ƒè€…å‘å¸ƒçš„æ¶ˆæ¯åªæœ‰ä¸€ä¸ªè®¢é˜…è€…èƒ½æ”¶åˆ°ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ¢çš„åŠŸèƒ½ï¼Œè€Œä¸”<code>Redis</code>ä¹Ÿæ²¡æœ‰æä¾›è¿™æ ·çš„åŠŸèƒ½ï¼Œä½¿ç”¨listé˜»å¡çš„å»æ‹‰çš„åŠŸèƒ½ï¼Œå¤§å®¶å»æŠ¢è¿™ä¸ªä¸œè¥¿ã€‚å½“ä½ åœ¨å¼€å‘çš„è¿™æ ·çš„åŠŸèƒ½æ—¶ï¼Œè¦ææ¸…æ¥šä½ æ˜¯å¸Œæœ›æ¶ˆè´¹è€…éƒ½æ”¶åˆ°è¿˜æ˜¯åªæœ‰ä¸€ä¸ªæ”¶åˆ°ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ol><li>ææ¸…æ¥šå‘å¸ƒè®¢é˜…æ¨¡å¼ä¸­çš„è§’è‰²ï¼›</li><li>é‡è¦çš„APIï¼›</li><li>æ¶ˆæ¯é˜Ÿåˆ—å’Œå‘å¸ƒè®¢é˜…çš„ä½¿ç”¨åœºæ™¯ã€‚</li></ol><h1 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h1><h2 id="ä½å›¾"><a href="#ä½å›¾" class="headerlink" title="ä½å›¾"></a>ä½å›¾</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571151448862.png" srcset="/img/loading.gif" alt="1571151448862"></p><p>å›¾ä¸­æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²å«åš<code>â€œbigâ€</code>ï¼Œå…¶ä¸­ä¸‹é¢å¯¹åº”çš„æ˜¯æ¯ä¸€ä¸ªå­—æ¯çš„asicsç ï¼Œå¯ä»¥çœ‹åˆ°å­—æ¯Bçš„asicsç æ˜¯98ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„äºŒè¿›åˆ¶ï¼Œå®é™…ä¸Šåœ¨ <code>Redis</code>ä¸­å¯ä»¥å¯¹ä½è¿›è¡Œæ“ä½œï¼Œå‡å¦‚è¯´è®¾ç½®äº†ä¸€ä¸ª<code>set key</code>å®ƒçš„å€¼ä¸º<code>â€œbigâ€</code>ï¼Œç„¶å<code>get</code>çš„æ—¶å€™æ˜¯å¯ä»¥å–åˆ°<code>big</code>çš„ç»“æœï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å–åˆ°å®ƒæ¯ä¸€ä¸ªä½å¯¹åº”çš„å€¼</p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> hello bigOK127.0.0.1:6382&gt; GETBIT hello 0 <span class="hljs-comment">#å–ç¬¬ä¸€ä½å­—èŠ‚</span>(<span class="hljs-built_in">integer</span>) 0127.0.0.1:6382&gt; GETBIT hello 1 <span class="hljs-comment">#å–ç¬¬äºŒä½å­—èŠ‚</span>(<span class="hljs-built_in">integer</span>) 1</code></pre><p>å¯¹äº<code>Redis</code>æ¥è¯´ï¼Œå®é™…ä¸Šæ˜¯å¯ä»¥ç›´æ¥æ“ä½œä½çš„ï¼Œä¸‹é¢æ¥ä»‹ç»ä¸‹ç›¸å…³çš„API</p><h2 id="ç›¸å…³å‘½ä»¤"><a href="#ç›¸å…³å‘½ä»¤" class="headerlink" title="ç›¸å…³å‘½ä»¤"></a>ç›¸å…³å‘½ä»¤</h2><h3 id="setbit"><a href="#setbit" class="headerlink" title="setbit"></a>setbit</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571151608426.png" srcset="/img/loading.gif" alt="1571151608426"></p><blockquote><p>è¿”å›ç»“æœæ˜¯å®ƒä¹‹å‰å¯¹åº”ä½çš„å€¼ï¼Œè¿™é‡Œä¹‹å‰æ²¡æœ‰è®¾ç½®å€¼ï¼Œè¿™é‡Œè¿”å›0</p></blockquote><p>ç»“æœä¸ºï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571151685655.png" srcset="/img/loading.gif" alt="1571151685655"></p><p>æ³¨æ„ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152327730.png" srcset="/img/loading.gif" alt="1571152327730"></p><p>åœ¨è¿™é‡Œè®¾ç½®ç´¢å¼•ä¸º50ï¼Œä½ä¸º1çš„æƒ…å†µï¼Œå…¶ä»–æœªè®¾ç½®çš„å®ƒä¼šè‡ªåŠ¨è¡¥0ï¼Œè¿™ä¸ªæ“ä½œæœ¬èº«å°±ä¼šæ¯”è¾ƒæ…¢ï¼Œæ‰€ä»¥ä¸åœ¨ä¸€ä¸ªå¾ˆçŸ­çš„ä½å›¾ä¸Šçªç„¶åšå¾ˆå¤§çš„åç§»é‡ï¼Œè¿™å°±ä¼šå¼•èµ·å¾ˆå¤šé—®é¢˜</p><h3 id="getbit"><a href="#getbit" class="headerlink" title="getbit"></a>getbit</h3><p> <img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152470270.png" srcset="/img/loading.gif" alt="1571152470270"></p><h3 id="bitcount"><a href="#bitcount" class="headerlink" title="bitcount"></a>bitcount</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152540234.png" srcset="/img/loading.gif" alt="1571152540234"></p><h3 id="bitop"><a href="#bitop" class="headerlink" title="bitop"></a>bitop</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152615140.png" srcset="/img/loading.gif" alt="1571152615140"></p><h3 id="bitpos"><a href="#bitpos" class="headerlink" title="bitpos"></a>bitpos</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152708769.png" srcset="/img/loading.gif" alt="1571152708769"></p><h2 id="ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡"><a href="#ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡" class="headerlink" title="ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡"></a>ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡</h2><ol><li>ä½¿ç”¨setå’ŒBitmapå¯¹æ¯”</li><li>1äº¿ç”¨æˆ·ï¼Œ5åƒä¸‡ç‹¬ç«‹è®¿é—®</li></ol><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152865462.png" srcset="/img/loading.gif" alt="1571152865462"></p><h2 id="ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡ï¼ˆç»­ï¼‰"><a href="#ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡ï¼ˆç»­ï¼‰" class="headerlink" title="ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡ï¼ˆç»­ï¼‰"></a>ç‹¬ç«‹ç”¨æˆ·ç»Ÿè®¡ï¼ˆç»­ï¼‰</h2><p>åªæœ‰10ä¸‡ç‹¬ç«‹ç”¨æˆ·å‘¢ï¼Ÿ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571152954190.png" srcset="/img/loading.gif" alt="1571152954190"></p><h2 id="ä½¿ç”¨ç»éªŒ"><a href="#ä½¿ç”¨ç»éªŒ" class="headerlink" title="ä½¿ç”¨ç»éªŒ"></a>ä½¿ç”¨ç»éªŒ</h2><ol><li>type=stringï¼Œæœ€å¤§512MB,å¯¹äºå¤§éƒ¨åˆ†ç‹¬ç«‹ç”¨æˆ·æ˜¯å¯ä»¥æ»¡è¶³çš„ï¼Œå‡å¦‚è¯´æˆ‘ä»¬ä¸¤æ— æ³•æ»¡è¶³çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å°†keyè¿›è¡Œæ‹†åˆ†ï¼Œä½¿ç”¨å¤šä¸ªkeyå®ç°è¿™ä¸ªåŠŸèƒ½ï¼›</li><li>æ³¨æ„setbitæ—¶çš„åç§»é‡ï¼Œå¯èƒ½æœ‰è¾ƒå¤§è€—æ—¶ï¼›</li><li>ä½å›¾ä¸æ˜¯ç»å¯¹å¥½ã€‚</li></ol><h1 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h1><h2 id="æ–°çš„æ•°æ®ç»“æ„"><a href="#æ–°çš„æ•°æ®ç»“æ„" class="headerlink" title="æ–°çš„æ•°æ®ç»“æ„"></a>æ–°çš„æ•°æ®ç»“æ„</h2><ol><li>åŸºäº HyperLogLogç®—æ³•:æå°ç©ºé—´å®Œæˆç‹¬ç«‹æ•°é‡ç»Ÿè®¡ï¼›</li><li>2.æœ¬è´¨è¿˜æ˜¯å­—ç¬¦ä¸²ã€‚</li></ol><h2 id="ä¸‰ä¸ªå‘½ä»¤-1"><a href="#ä¸‰ä¸ªå‘½ä»¤-1" class="headerlink" title="ä¸‰ä¸ªå‘½ä»¤"></a>ä¸‰ä¸ªå‘½ä»¤</h2><h3 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h3><ol><li>pfadd key element [elementâ€¦]:å‘ hyperloglogæ·»åŠ å…ƒç´ </li><li>pfcount key[keyâ€¦]:è®¡ç®— hyperloglogçš„ç‹¬ç«‹æ€»æ•°</li><li>pfmerge deskey sourcekey[ sourcekeyâ€¦J:åˆå¹¶å¤šä¸ª hyperloglog</li></ol><h3 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571154873586.png" srcset="/img/loading.gif" alt="1571154873586"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571154949028.png" srcset="/img/loading.gif" alt="1571154949028"></p><h2 id="å†…å­˜æ¶ˆè€—"><a href="#å†…å­˜æ¶ˆè€—" class="headerlink" title="å†…å­˜æ¶ˆè€—"></a>å†…å­˜æ¶ˆè€—</h2><p>æ’å…¥ç™¾ä¸‡æ¡è®°å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155041539.png" srcset="/img/loading.gif" alt="1571155041539"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155066244.png" srcset="/img/loading.gif" alt="1571155066244"></p><h2 id="ä½¿ç”¨ç»éªŒ-1"><a href="#ä½¿ç”¨ç»éªŒ-1" class="headerlink" title="ä½¿ç”¨ç»éªŒ"></a>ä½¿ç”¨ç»éªŒ</h2><ol><li>æ˜¯å¦èƒ½å®¹å¿é”™è¯¯ï¼Ÿï¼ˆé”™è¯¯ç‡ï¼š0.81%ï¼‰</li><li>æ˜¯å¦éœ€è¦å•æ¡è®°å½•ï¼Ÿ</li></ol><h1 id="GEO"><a href="#GEO" class="headerlink" title="GEO"></a>GEO</h1><h2 id="GEOæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#GEOæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="GEOæ˜¯ä»€ä¹ˆï¼Ÿ"></a>GEOæ˜¯ä»€ä¹ˆï¼Ÿ</h2><blockquote><p>GEOæ˜¯<code>Redis3.2</code>æ–°å¢çš„ç‰¹æ€§ï¼Œç”¨äºè®¡ç®—åœ°ç†ä½ç½®ä¿¡æ¯ç›¸å…³çš„åŠŸèƒ½</p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155474248.png" srcset="/img/loading.gif" alt="1571155474248"></p><h2 id="5ä¸ªåŸå¸‚ç»çº¬åº¦"><a href="#5ä¸ªåŸå¸‚ç»çº¬åº¦" class="headerlink" title="5ä¸ªåŸå¸‚ç»çº¬åº¦"></a>5ä¸ªåŸå¸‚ç»çº¬åº¦</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155530668.png" srcset="/img/loading.gif" alt="1571155530668"></p><h2 id="ç›¸å…³å‘½ä»¤-1"><a href="#ç›¸å…³å‘½ä»¤-1" class="headerlink" title="ç›¸å…³å‘½ä»¤"></a>ç›¸å…³å‘½ä»¤</h2><h3 id="geoadd"><a href="#geoadd" class="headerlink" title="geoadd"></a>geoadd</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155587057.png" srcset="/img/loading.gif" alt="1571155587057"></p><h3 id="geopos"><a href="#geopos" class="headerlink" title="geopos"></a>geopos</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155627868.png" srcset="/img/loading.gif" alt="1571155627868"></p><h3 id="geodist"><a href="#geodist" class="headerlink" title="geodist"></a>geodist</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155666402.png" srcset="/img/loading.gif" alt="1571155666402"></p><h3 id="georadius"><a href="#georadius" class="headerlink" title="georadius"></a>georadius</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155685404.png" srcset="/img/loading.gif" alt="1571155685404"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1571155764137.png" srcset="/img/loading.gif" alt="1571155764137"></p><h2 id="ç›¸å…³è¯´æ˜"><a href="#ç›¸å…³è¯´æ˜" class="headerlink" title="ç›¸å…³è¯´æ˜"></a>ç›¸å…³è¯´æ˜</h2><ol><li>since 3.2+æä¾›çš„åŠŸèƒ½</li><li>type geoKey=zset</li><li>æ²¡æœ‰åˆ é™¤API:<code>zrem key member</code></li></ol>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘  2.å®¢æˆ·ç«¯ä½¿ç”¨</title>
    <link href="/redis-2.html"/>
    <url>/redis-2.html</url>
    
    <content type="html"><![CDATA[<h1 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h1><p>åˆ›å»ºä¸€ä¸ª<code>mavenå·¥ç¨‹</code>ï¼Œåœ¨<code>pom.xml</code>ä¸­åŠ å…¥ä¾èµ–ï¼š</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.9.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><h1 id="Jedisç›´è¿"><a href="#Jedisç›´è¿" class="headerlink" title="Jedisç›´è¿"></a>Jedisç›´è¿</h1><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.shui.jedis.demo;<span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DirectConnectionDemo</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Integer PORT = <span class="hljs-number">6382</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URI = <span class="hljs-string">"mcr2.com"</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Jedis jedis = <span class="hljs-keyword">new</span> Jedis(URI, PORT);    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        kv();        list();        set();        zSet();    &#125;    <span class="hljs-comment">// kv</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">kv</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">"========================kv"</span>);        <span class="hljs-comment">//è·å–Rediså®¢æˆ·ç«¯</span>        <span class="hljs-comment">//set</span>        jedis.set(<span class="hljs-string">"name"</span>, <span class="hljs-string">"shui"</span>);        <span class="hljs-comment">//get</span>        String name = jedis.get(<span class="hljs-string">"name"</span>);        System.out.println(name);    &#125;    <span class="hljs-comment">// list</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">list</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">"========================list"</span>);        jedis.del(<span class="hljs-string">"list"</span>);        jedis.rpush(<span class="hljs-string">"list"</span>, <span class="hljs-string">"1"</span>);        jedis.rpush(<span class="hljs-string">"list"</span>, <span class="hljs-string">"2"</span>);        jedis.rpush(<span class="hljs-string">"list"</span>, <span class="hljs-string">"3"</span>);        jedis.rpush(<span class="hljs-string">"list"</span>, <span class="hljs-string">"4"</span>);        jedis.lrange(<span class="hljs-string">"list"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).forEach(System.out::println);    &#125;    <span class="hljs-comment">// set</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">"========================set"</span>);        jedis.del(<span class="hljs-string">"set"</span>);        jedis.sadd(<span class="hljs-string">"set"</span>, <span class="hljs-string">"a"</span>);        jedis.sadd(<span class="hljs-string">"set"</span>, <span class="hljs-string">"b"</span>);        jedis.sadd(<span class="hljs-string">"set"</span>, <span class="hljs-string">"b"</span>);        jedis.smembers(<span class="hljs-string">"set"</span>).forEach(System.out::println);    &#125;    <span class="hljs-comment">// zSet</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">zSet</span><span class="hljs-params">()</span> </span>&#123;        System.out.println(<span class="hljs-string">"========================zSet"</span>);        jedis.del(<span class="hljs-string">"zset"</span>);        jedis.zadd(<span class="hljs-string">"zset"</span>, <span class="hljs-number">99</span>, <span class="hljs-string">"tom"</span>);        jedis.zadd(<span class="hljs-string">"zset"</span>, <span class="hljs-number">66</span>, <span class="hljs-string">"perter"</span>);        jedis.zadd(<span class="hljs-string">"zset"</span>, <span class="hljs-number">33</span>, <span class="hljs-string">"james"</span>);        System.out.println(jedis.zrangeWithScores(<span class="hljs-string">"zset"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>));    &#125;&#125;</code></pre><h1 id="Jedisè¿æ¥æ± é…ç½®"><a href="#Jedisè¿æ¥æ± é…ç½®" class="headerlink" title="Jedisè¿æ¥æ± é…ç½®"></a>Jedisè¿æ¥æ± é…ç½®</h1><h2 id="é…ç½®åˆ—è¡¨"><a href="#é…ç½®åˆ—è¡¨" class="headerlink" title="é…ç½®åˆ—è¡¨"></a>é…ç½®åˆ—è¡¨</h2><table><thead><tr><th align="center">å‚æ•°å</th><th align="center">å«ä¹‰</th><th align="center">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="center">maxTotal</td><td align="center">èµ„æºæœ€å¤§è¿æ¥æ•°</td><td align="center">8</td></tr><tr><td align="center">maxIdel</td><td align="center">èµ„æºæ± å…è®¸æœ€å¤§ç©ºé—²è¿æ¥æ•°</td><td align="center">8</td></tr><tr><td align="center">minIdle</td><td align="center">èµ„æºæ± ç¡®ä¿æœ€å°‘ç©ºé—²è¿æ¥æ•°</td><td align="center">0</td></tr><tr><td align="center">jmxEnabled</td><td align="center">æ˜¯å¦å¼€å¯jmxç›‘æ§ï¼Œå¯ç”¨äºç›‘æ§</td><td align="center">true</td></tr><tr><td align="center">blockWhenExhausted</td><td align="center">å½“èµ„æºæ± ç”¨å°½åï¼Œè°ƒç”¨è€…æ˜¯å¦çš„è¦ç­‰å¾…ã€‚åªæœ‰å½“ä¸ºtrueæ—¶ï¼Œä¸‹é¢çš„maxWaitMillisæ‰ä¼šç”Ÿæ•ˆ</td><td align="center">true</td></tr><tr><td align="center">maxWaitMillis</td><td align="center">å½“èµ„æºæ± è¿æ¥ç”¨å°½åï¼Œè°ƒç”¨è€…çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼ˆå•ä½ä¸ºæ¯«ç§’ï¼‰</td><td align="center">-1è¡¨ç¤ºæ°¸ä¸è¶…æ—¶</td></tr><tr><td align="center">testOnBorrow</td><td align="center">å‘èµ„æºæ± å€Ÿç”¨è¿æ¥æ—¶æ˜¯å¦åšè¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹ï¼ˆpingï¼‰ï¼Œæ— æ•ˆè¿æ¥ä¼šè¢«ç§»é™¤</td><td align="center">false</td></tr><tr><td align="center">testOnReturn</td><td align="center">å‘èµ„æºæ± å½’è¿˜è¿æ¥æ—¶æ˜¯å¦åšè¿æ¥æœ‰æ•ˆæ€§æ£€æµ‹ï¼ˆpingï¼‰ï¼Œæ— æ•ˆè¿æ¥ä¼šè¢«ç§»é™¤</td><td align="center">false</td></tr></tbody></table><h2 id="é€‚åˆçš„maxTotal"><a href="#é€‚åˆçš„maxTotal" class="headerlink" title="é€‚åˆçš„maxTotal"></a>é€‚åˆçš„maxTotal</h2><p>æ¯”è¾ƒéš¾ç¡®å®šçš„ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><ol><li>å‘½ä»¤å¹³å‡æ‰§è¡Œæ—¶é—´0.1ms=0.0001s;</li><li>ä¸šåŠ¡éœ€è¦50000 QPS;</li><li>maxTotalç†è®ºå€¼=0.001*50000=50ä¸ªã€‚å®é™…å€¼è¦åå¤§ä¸€äº›ã€‚</li></ol><p>è®¾ç½®maxTotaléœ€è¦è€ƒè™‘çš„é—®é¢˜ï¼š</p><ol><li>ä¸šåŠ¡å¸Œæœ›Rediså¹¶å‘é‡ï¼›</li><li>å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤æ—¶é—´ï¼›</li><li>Redisèµ„æºï¼šä¾‹å¦‚<code>nodes(ä¾‹å¦‚åº”ç”¨ä¸ªæ•°)* maxTotal</code>æ˜¯ä¸èƒ½è¶…è¿‡Redisçš„æœ€å¤§è¿æ¥æ•°ã€‚ï¼ˆconfig get maxclientsï¼‰</li></ol><h2 id="é€‚åˆçš„maxIdelå’ŒminIdle"><a href="#é€‚åˆçš„maxIdelå’ŒminIdle" class="headerlink" title="é€‚åˆçš„maxIdelå’ŒminIdle"></a>é€‚åˆçš„maxIdelå’ŒminIdle</h2><p>å»ºè®®<code>maxIdel</code>=<code>minIdle</code>,å‡å¦‚æˆ‘ç°åœ¨<code>maxTotalï¼š100</code>,<code>maxIdelï¼š50</code>,ç°åœ¨å…è®¸æœ€å¤§çš„ç©ºé—²æ•°ä¹Ÿå°±æ˜¯50ï¼Œå‡å¦‚ç°åœ¨å·²ç»åœ¨ä¸€ä¸ªé«˜å³°æœŸï¼Œæˆ‘èµ„æºä¸­çš„è¿æ¥æ± å·²ç»é€šè¿‡<code>getResource</code>è·å–åˆ°äº†ï¼Œè¿™ä¸ªæ—¶å€™ç¬¬51ä¸ªè¿æ¥éœ€è¦é€šè¿‡<code>new Jedis</code>ä»¥åŠ<code>cpçš„ä¸‰æ¬¡æ¡</code>æ‰‹æ‰èƒ½åˆ°æ–°çš„è¿æ¥ï¼Œå®é™…ä¸Šè¿™æœ¬èº«æ˜¯æœ‰ä¸€å®šå¼€é”€çš„ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šå°†è¿™2ä¸ªå±æ€§è®¾ç½®æˆä¸€æ ·å‡å°‘åˆ›å»ºæ–°è¿æ¥çš„å¼€é”€</p><hr><p>å»ºè®®é¢„çƒ­minIdleï¼Œåœ¨JedisPoolåˆå§‹åŒ–çš„æ—¶å€™ï¼Œåœ¨ç¬¬ä¸€æ¬¡<code>getResource</code>çš„æ—¶å€™ï¼Œä¾ç„¶æ˜¯é€šè¿‡<code>new</code>æ¥å®Œæˆçš„ï¼Œå¯¹äºä¸€äº›å¹¶å‘é‡ç‰¹åˆ«å¤§çš„åº”ç”¨æ¥è¯´ï¼Œå®ƒè®¤ä¸ºç¬¬ä¸€æ¬¡<code>new</code>è¿˜æ˜¯ä¸èƒ½å®¹å¿ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥åœ¨åº”ç”¨åˆå§‹åŒ–çš„æ—¶å€™æå‰å»<code>new</code>ä¸€äº›<code>getResource</code>å»è®©å®ƒåšä¸€äº›æ“ä½œ</p><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><h3 id="è·å–è¿æ¥è¶…æ—¶"><a href="#è·å–è¿æ¥è¶…æ—¶" class="headerlink" title="è·å–è¿æ¥è¶…æ—¶"></a>è·å–è¿æ¥è¶…æ—¶</h3><pre><code class="hljs java">redis clients. jedis exceptions. JedisConnectionException: Could not get a resource from the poolCaused by: java util. NoSuch Element Exception: Timeout waiting <span class="hljs-keyword">for</span> idle objectat org.apache commons. pool2 impl. GenericObjectPool. borrowobject(GenericObjectPool java: <span class="hljs-number">449</span>)</code></pre><h3 id="è¿æ¥æ± èµ„æºè€—å°½"><a href="#è¿æ¥æ± èµ„æºè€—å°½" class="headerlink" title="è¿æ¥æ± èµ„æºè€—å°½"></a>è¿æ¥æ± èµ„æºè€—å°½</h3><blockquote><p>åœ¨è¿æ¥æ•°åˆ°æœ€å¤§çš„æ—¶å€™ï¼ŒæŒ‰é“ç†ç°åœ¨ä¼šå‡ºç°ä¸€ä¸ªç­‰çš„è¡Œä¸ºï¼Œä½†åœ¨æˆ‘è¿™è®¾ç½®ä¸ºä¸ç­‰ï¼Œå®ƒå°±ä¼šå‘Šè¯‰ä½ æ± å­çš„èµ„æºè€—å°½</p></blockquote><pre><code class="hljs java">redis clients. jedis. exceptions. Jedis ConnectionException: Could not get a resource from the poolCaused by: java util. NoSuchElementEXception: Pool exhaustedat org. apache commons. pool2impl. GenericObjectPool. borrowobject(GenericObjectPool java: <span class="hljs-number">464</span>)</code></pre><h2 id="è§£å†³æ€è·¯"><a href="#è§£å†³æ€è·¯" class="headerlink" title="è§£å†³æ€è·¯"></a>è§£å†³æ€è·¯</h2><ul><li>æ…¢æŸ¥è¯¢é˜»å¡ï¼šæ± å­è¿æ¥éƒ½è¢«hangä½ï¼›</li></ul><blockquote><p>å‡å¦‚æˆ‘ä»¬è¿æ¥æ± ä¸­è®¾ç½®<code>maxTotalï¼š8</code>,å‡å¦‚ç°åœ¨æœ‰8ä¸ªçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä¸€ä¸ªæ“ä½œï¼Œå¯¹äºRedisæ¥è¯´ï¼Œæ— è®ºå€Ÿè¿˜æ‰§è¡Œæ“ä½œéƒ½æ˜¯éå¸¸å¿«çš„ï¼Œåœ¨æŸä¸€ä¸ªç¬é—´è¿™äº›æ“ä½œéƒ½è¢«hangä½äº†ï¼Œè¿™äº›æ“ä½œæ‰§è¡Œéå¸¸æ…¢ï¼Œä¾‹å¦‚è¿™8ä¸ªéƒ½åœ¨æ‰§è¡Œ<code>keys</code> * æˆ–è€…æŸäº›åŸå› Rediså•çº¿ç¨‹è¢«é˜»å¡äº†è¿™8ä¸ªè¿æ¥éƒ½è¦å¯¹è¿™ä¸ªæ“ä½œè¿›è¡Œç­‰å¾…ï¼Œåœ¨ç­‰å¾…æœŸé—´ï¼Œè¿™ä¸ªæ—¶å€™å†å»ä¸€ä¸ª<code>getResouce</code>å°±ä¼šå‡ºç°åˆšæ‰é‚£æ ·çš„æƒ…å†µ<code>è¿æ¥æ± èµ„æºè€—å°½</code></p></blockquote><ul><li>èµ„æºæ± å‚æ•°ä¸åˆç†ï¼šä¾‹å¦‚QPSé«˜ã€æ± å­å°;</li></ul><blockquote><p>å‡å¦‚QPSä¸º100wï¼Œä½†æ± å­è¿˜è®¾ç½®æˆ8ï¼Œè¿™æ ·å°±ä¸æ˜¯å¾ˆåˆç†</p></blockquote><ul><li>è¿æ¥æ³„éœ²ï¼ˆæ²¡æœ‰close()ï¼‰ï¼šæ­¤ç±»é—®é¢˜æ¯”è¾ƒéš¾å®šä½ï¼Œä¾‹å¦‚<code>client list</code>ã€<code>netstat</code>ç­‰ï¼Œæœ€é‡è¦çš„æ˜¯ä»£ç ;</li><li>DNSå¼‚å¸¸ç­‰ã€‚</li></ul><h2 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h2><p>æ¨¡æ‹Ÿè¿æ¥æ³„éœ²</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.shui.jedis.demo;<span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;<span class="hljs-keyword">import</span> redis.clients.jedis.JedisPool;<span class="hljs-keyword">import</span> redis.clients.jedis.JedisPoolConfig;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JedisPoolOptimizeTest</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        JedisPoolConfig jedisPoolConfig = <span class="hljs-keyword">new</span> JedisPoolConfig();        jedisPoolConfig.setMaxTotal(<span class="hljs-number">10</span>);        jedisPoolConfig.setMaxWaitMillis(<span class="hljs-number">1000</span>);        JedisPool jedisPool = <span class="hljs-keyword">new</span> JedisPool(jedisPoolConfig, <span class="hljs-string">"mcr2.com"</span>, <span class="hljs-number">6382</span>);        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) &#123;            Jedis jedis = <span class="hljs-keyword">null</span>;            <span class="hljs-keyword">try</span> &#123;                jedis = jedisPool.getResource();                System.out.println(jedis.ping());            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;                e.printStackTrace();            &#125;            System.out.println(jedisPool.getResource().ping());        &#125;    &#125;&#125;</code></pre><pre><code class="hljs java">PONGPONGPONGPONGPONGPONGPONGPONGPONGPONGredis.clients.jedis.exceptions.JedisException: Could not get a resource from the poolat redis.clients.util.Pool.getResource(Pool.java:<span class="hljs-number">51</span>)at redis.clients.jedis.JedisPool.getResource(JedisPool.java:<span class="hljs-number">226</span>)at com.shui.jedis.demo.JedisPoolOptimizeTest.main(JedisPoolOptimizeTest.java:<span class="hljs-number">18</span>)Caused by: java.util.NoSuchElementException: Timeout waiting <span class="hljs-keyword">for</span> idle objectat org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="hljs-number">449</span>)at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="hljs-number">363</span>)at redis.clients.util.Pool.getResource(Pool.java:<span class="hljs-number">49</span>)... <span class="hljs-number">2</span> moreException in thread <span class="hljs-string">"main"</span> redis.clients.jedis.exceptions.JedisException: Could not get a resource from the poolat redis.clients.util.Pool.getResource(Pool.java:<span class="hljs-number">51</span>)at redis.clients.jedis.JedisPool.getResource(JedisPool.java:<span class="hljs-number">226</span>)at com.shui.jedis.demo.JedisPoolOptimizeTest.main(JedisPoolOptimizeTest.java:<span class="hljs-number">23</span>)Caused by: java.util.NoSuchElementException: Timeout waiting <span class="hljs-keyword">for</span> idle objectat org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="hljs-number">449</span>)at org.apache.commons.pool2.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:<span class="hljs-number">363</span>)at redis.clients.util.Pool.getResource(Pool.java:<span class="hljs-number">49</span>)... <span class="hljs-number">2</span> more</code></pre>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ Redis-å­¦ä¹ ç¬”è®° ã€‘  1.åŸºæœ¬ä½¿ç”¨</title>
    <link href="/redis-1.html"/>
    <url>/redis-1.html</url>
    
    <content type="html"><![CDATA[<h1 id="å¿«é€Ÿä½¿ç”¨"><a href="#å¿«é€Ÿä½¿ç”¨" class="headerlink" title="å¿«é€Ÿä½¿ç”¨"></a>å¿«é€Ÿä½¿ç”¨</h1><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /optwget  http://download.redis.io/releases/redis-3.0.7.tar.gztar -zxvf redis-3.0.7.tar.gz -C /usr/src<span class="hljs-built_in">cd</span> /usr/srcmv redis-3.0.7/ redis<span class="hljs-built_in">cd</span> redis/make &amp;&amp; make install</code></pre><h2 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h2><p>ç”±äº<code>Redis</code>æ˜¯ä¸€ä¸ªå•çº¿ç¨‹ï¼Œæ‰€ä»¥åœ¨æœåŠ¡å™¨ä¸Šä¼šå¯åŠ¨3ä¸ª<code>Redis</code>æ¥æé«˜æ€§èƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œå…ˆä¸ä»‹ç»å¯åŠ¨å¤šä¸ª<code>Redis</code>ï¼Œè¿™é‡Œä¸ºäº†åŒºåˆ†é…ç½®æ–‡ä»¶ï¼Œå°†é…ç½®æ–‡ç« ç”±<code>redis-prot.conf</code>å‘½å</p><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/src/redismkdir configcp redis.conf config/cat redis.conf | grep -v <span class="hljs-string">"#"</span> | grep -v <span class="hljs-string">"^$"</span> &gt; redis-6382.conf</code></pre><p><code>redis-6382.conf</code>å†…å®¹ï¼š</p><pre><code class="hljs vim">daemonize yesport <span class="hljs-number">6382</span>dir <span class="hljs-string">"/usr/src/redis/data"</span>logfile <span class="hljs-string">"6382.log"</span></code></pre><p>åœ¨<code>redis</code>æ–‡ä»¶ä¸­åˆ›å»º<code>data</code>ç›®å½•</p><pre><code class="hljs bash">mkdir data</code></pre><p>å¯åŠ¨</p><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/src/redisredis-server  config/redis-6382.conf</code></pre><h2 id="ä½¿ç”¨redis-cliè¿æ¥redisæœåŠ¡"><a href="#ä½¿ç”¨redis-cliè¿æ¥redisæœåŠ¡" class="headerlink" title="ä½¿ç”¨redis-cliè¿æ¥redisæœåŠ¡"></a>ä½¿ç”¨<code>redis-cli</code>è¿æ¥<code>redis</code>æœåŠ¡</h2><pre><code class="hljs bash">redis-cli  -p 6382</code></pre><h1 id="APIçš„ä½¿ç”¨å’Œç†è§£"><a href="#APIçš„ä½¿ç”¨å’Œç†è§£" class="headerlink" title="APIçš„ä½¿ç”¨å’Œç†è§£"></a>APIçš„ä½¿ç”¨å’Œç†è§£</h1><h2 id="é€šç”¨å‘½ä»¤"><a href="#é€šç”¨å‘½ä»¤" class="headerlink" title="é€šç”¨å‘½ä»¤"></a>é€šç”¨å‘½ä»¤</h2><h3 id="keys"><a href="#keys" class="headerlink" title="keys"></a>keys</h3><p><strong>è¯­æ³•</strong></p><blockquote><p>keys [pattern]</p></blockquote><p><strong>æ¼”ç¤º</strong></p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> k1 v1OK127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> k2 v2OK127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> k3 v3OK127.0.0.1:6382&gt; KEYS *1) <span class="hljs-string">"k3"</span>2) <span class="hljs-string">"k1"</span>3) <span class="hljs-string">"k2"</span>127.0.0.1:6382&gt; mset hello world hehe haha php good phe thisOK127.0.0.1:6382&gt; KEYS he*1) <span class="hljs-string">"hello"</span>2) <span class="hljs-string">"hehe"</span>127.0.0.1:6382&gt; KEYS he[h<span class="hljs-_">-l</span>]*1) <span class="hljs-string">"hello"</span>2) <span class="hljs-string">"hehe"</span>127.0.0.1:6382&gt; KEYS ph?1) <span class="hljs-string">"php"</span>2) <span class="hljs-string">"phe"</span></code></pre><p><strong>è¯´æ˜</strong></p><blockquote><p>keyså‘½ä»¤ä¸€èˆ¬ä¸å†ç”Ÿäº§ç¯å¢ƒä½¿ç”¨</p></blockquote><h3 id="dbsize"><a href="#dbsize" class="headerlink" title="dbsize"></a>dbsize</h3><p><strong>æ¼”ç¤º</strong></p><pre><code class="hljs bash">127.0.0.1:6382&gt; DBSIZE(<span class="hljs-built_in">integer</span>) 7127.0.0.1:6382&gt;</code></pre><p><strong>è¯´æ˜</strong></p><blockquote><p><code>dbsize</code>æ˜¯å¯ä»¥åœ¨çº¿ä¸Šä½¿ç”¨çš„ï¼Œå®ƒä¸æ˜¯å¯¹<code>redis</code>å…¨å±€éå†ä¸€é€¼ï¼Œ<code>redis</code>å†…ç½®äº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå®ƒä¼šå®æ—¶æ›´æ–°è®¡æ•°å™¨çš„æ€»æ•°</p></blockquote><h3 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h3><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash">exists key <span class="hljs-comment">#æ£€æŸ¥keyæ˜¯å¦å­˜åœ¨ï¼Œ1ï¼štrueï¼Œ0ï¼šfalse</span></code></pre><p><strong>æ¼”ç¤º</strong></p><pre><code class="hljs bash">127.0.0.1:6382&gt; SET a bOK127.0.0.1:6382&gt; EXISTS a(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; del a<span class="hljs-comment">#æ ¹æ®keyè¿›è¡Œåˆ é™¤</span>(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; EXISTS a(<span class="hljs-built_in">integer</span>) 0127.0.0.1:6382&gt;</code></pre><h3 id="del"><a href="#del" class="headerlink" title="del"></a>del</h3><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash">del key [keyâ€¦]<span class="hljs-comment">#åˆ é™¤æŒ‡å®škey-valueï¼Œå¯ä»¥åˆ é™¤å¤šä¸ª</span></code></pre><p><strong>æ¼”ç¤º</strong></p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> a bOK127.0.0.1:6382&gt; get a<span class="hljs-string">"b"</span>127.0.0.1:6382&gt; del a(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; get a(nil)127.0.0.1:6382&gt;</code></pre><h3 id="expireã€ttlã€persist"><a href="#expireã€ttlã€persist" class="headerlink" title="expireã€ttlã€persist"></a>expireã€ttlã€persist</h3><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash">expire key seconds<span class="hljs-comment">#keyåœ¨secondsç§’åè¿‡æœŸ</span>ttl key<span class="hljs-comment">#æŸ¥çœ‹keyå‰©ä½™çš„è¿‡æœŸæ—¶é—´</span>persist key<span class="hljs-comment">#å»æ‰keyçš„è¿‡æœŸæ—¶é—´</span></code></pre><p><strong>æ¼”ç¤º</strong></p><p>è®¾ç½®è¿‡æœŸæ—¶é—´</p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> hello wolrdOK127.0.0.1:6382&gt; EXPIRE hello 20(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; ttl hello(<span class="hljs-built_in">integer</span>) 16127.0.0.1:6382&gt; get hello<span class="hljs-string">"wolrd"</span><span class="hljs-comment">#è¿‡æœŸæ—¶é—´è¿‡å»ä¹‹å</span>127.0.0.1:6382&gt; ttl hello(<span class="hljs-built_in">integer</span>) -2<span class="hljs-comment">#-2è¡¨ç¤ºå·²ç»ä¸å­˜åœ¨äº†</span>127.0.0.1:6382&gt; get hello(nil)</code></pre><p>å»æ‰è¿‡æœŸæ—¶é—´</p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> hello worldOK127.0.0.1:6382&gt; expire hello 20(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; ttl hello(<span class="hljs-built_in">integer</span>) 17127.0.0.1:6382&gt; PERSIST hello(<span class="hljs-built_in">integer</span>) 1127.0.0.1:6382&gt; ttl hello(<span class="hljs-built_in">integer</span>) -1<span class="hljs-comment">#-1è¡¨ç¤ºæ²¡æœ‰è¿‡æœŸæ—¶é—´</span></code></pre><h3 id="type"><a href="#type" class="headerlink" title="type"></a>type</h3><p><strong>è¯­æ³•</strong></p><pre><code class="hljs bash"><span class="hljs-built_in">type</span> key<span class="hljs-comment">#è¿”å›keyçš„ç±»å‹</span></code></pre><p><strong>æ¼”ç¤º</strong></p><pre><code class="hljs bash">127.0.0.1:6382&gt; <span class="hljs-built_in">set</span> k vOK127.0.0.1:6382&gt; TYPE kstring</code></pre><h3 id="æ•°æ®ç»“æ„å’Œå†…éƒ¨ç¼–ç "><a href="#æ•°æ®ç»“æ„å’Œå†…éƒ¨ç¼–ç " class="headerlink" title="æ•°æ®ç»“æ„å’Œå†…éƒ¨ç¼–ç "></a>æ•°æ®ç»“æ„å’Œå†…éƒ¨ç¼–ç </h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570946588148.png" srcset="/img/loading.gif" alt="1570946588148"></p><p>å¯¹äº<code>redis</code>å†…éƒ¨æ¥è¯´ï¼Œå®ƒæœ‰è‡ªå·±çš„å†…éƒ¨ç¼–ç ï¼›</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><p>çœ‹å›¾ä¸­çš„<code>hash</code>ï¼Œå®ƒå¯¹ç”¨æˆ·æ¥è¯´å®ƒæ˜¯ä¸€ä¸ª<code>hash</code>ï¼Œä½†å¯¹äºå®ƒå†…éƒ¨æ¥è¯´ï¼Œå¯èƒ½æ˜¯<code>hashtable</code>ã€<code>ziplist</code>ï¼Œé‚£ä¹ˆ<code>redis</code>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿ</p><p>é¦–å…ˆ<code>redis</code>æ˜¯ä¸€ä¸ªå†…å­˜çš„æ•°æ®åº“ï¼Œå¯¹äºå†…å­˜æ¥è¯´æ˜¯éå¸¸æ˜‚è´µçš„ï¼Œå‡è®¾æˆ‘ä»¬åœ¨ä½¿ç”¨æŸä¸€ç§æ•°æ®ç»“æ„çš„æ—¶å€™ä»¥ç©ºé—´æ¢å–æ—¶é—´çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å‹ç¼©çš„ç»“æ„ï¼Œæ¯”å¦‚<code>hahs</code>çš„<code>ziplist</code>ç»“æ„ï¼Œå½“å®ƒçš„å…ƒç´ æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œé‚£ä¹ˆæˆ‘å°±å¯ä»¥ä½¿ç”¨ç©ºé—´æ¢æ—¶é—´ï¼Œå› ä¸ºå®ƒçš„å…ƒç´ æ¯”è¾ƒå°ï¼Œåœ¨åšä¸€äº›éå†æŸ¥æ‰¾å®ƒä¹Ÿä¸ä¼šæ¶ˆè€—å¾ˆå¤šçš„æ—¶é—´ï¼Œè¿™æ ·ä½¿ç”¨æ›´å°çš„ç©ºé—´æ¥è¾¾åˆ°æ›´ä¼˜çš„å†…å­˜ä½¿ç”¨æ•ˆæœã€‚</p><h2 id="å•çº¿ç¨‹"><a href="#å•çº¿ç¨‹" class="headerlink" title="å•çº¿ç¨‹"></a>å•çº¿ç¨‹</h2><ul><li>ä¸€æ¬¡åªæ‰§è¡Œä¸€æ¡å‘½ä»¤</li><li>æ‹’ç»æ…¢å‘½ä»¤<ul><li>key</li><li>flushall</li><li>flushdb</li><li>slow lua script</li><li>mutil/exec</li><li>operate big value(collection)</li></ul></li><li>å…¶å®ä¸æ˜¯å•çº¿ç¨‹<ul><li>fysnc file descriptor </li><li>close file descriptor </li></ul></li></ul><h2 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h2><h3 id="incrã€decrã€incrbyã€decrby"><a href="#incrã€decrã€incrbyã€decrby" class="headerlink" title="incrã€decrã€incrbyã€decrby"></a>incrã€decrã€incrbyã€decrby</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1835062274102102.png" srcset="/img/loading.gif" alt="incrã€decrã€incrbyã€decrby"></p><h3 id="setã€setnxã€setxx"><a href="#setã€setnxã€setxx" class="headerlink" title="setã€setnxã€setxx"></a>setã€setnxã€setxx</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/18040409055744.png" srcset="/img/loading.gif" alt="incrã€decrã€incrbyã€decrby"></p><h3 id="mgetã€mset"><a href="#mgetã€mset" class="headerlink" title="mgetã€mset"></a>mgetã€mset</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570953277140.png" srcset="/img/loading.gif" alt="1570953277140"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570953443449.png" srcset="/img/loading.gif" alt="1570953443449"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570953459051.png" srcset="/img/loading.gif" alt="1570953459051"></p><h3 id="getsetã€appendã€strlen"><a href="#getsetã€appendã€strlen" class="headerlink" title="getsetã€appendã€strlen"></a>getsetã€appendã€strlen</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570953545704.png" srcset="/img/loading.gif" alt="1570953545704"></p><h3 id="incrbyfloatã€getrangeã€setrange"><a href="#incrbyfloatã€getrangeã€setrange" class="headerlink" title="incrbyfloatã€getrangeã€setrange"></a>incrbyfloatã€getrangeã€setrange</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570953706510.png" srcset="/img/loading.gif" alt="1570953706510"></p><h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><h3 id="hgetã€hsetã€hdel"><a href="#hgetã€hsetã€hdel" class="headerlink" title="hgetã€hsetã€hdel"></a>hgetã€hsetã€hdel</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570954168175.png" srcset="/img/loading.gif" alt="1570954168175"></p><h3 id="hexistsã€hlen"><a href="#hexistsã€hlen" class="headerlink" title="hexistsã€hlen"></a>hexistsã€hlen</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570954337386.png" srcset="/img/loading.gif" alt="1570954337386"></p><h3 id="hmgetã€hmset"><a href="#hmgetã€hmset" class="headerlink" title="hmgetã€hmset"></a>hmgetã€hmset</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570954768771.png" srcset="/img/loading.gif" alt="1570954768771"></p><h3 id="hgetallã€hvalsã€hkeys"><a href="#hgetallã€hvalsã€hkeys" class="headerlink" title="hgetallã€hvalsã€hkeys"></a>hgetallã€hvalsã€hkeys</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570955042992.png" srcset="/img/loading.gif" alt="1570955042992"></p><h3 id="hsetnxã€hincrbyã€hincrbyfloat"><a href="#hsetnxã€hincrbyã€hincrbyfloat" class="headerlink" title="hsetnxã€hincrbyã€hincrbyfloat"></a>hsetnxã€hincrbyã€hincrbyfloat</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570955599297.png" srcset="/img/loading.gif" alt="1570955599297"></p><h3 id="ç›¸ä¼¼çš„API"><a href="#ç›¸ä¼¼çš„API" class="headerlink" title="ç›¸ä¼¼çš„API"></a>ç›¸ä¼¼çš„API</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570955212178.png" srcset="/img/loading.gif" alt="1570955212178"></p><h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><h3 id="å¢-rpush"><a href="#å¢-rpush" class="headerlink" title="å¢-rpush"></a>å¢-rpush</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956073816.png" srcset="/img/loading.gif" alt="1570956073816"></p><h3 id="å¢-lpush"><a href="#å¢-lpush" class="headerlink" title="å¢-lpush"></a>å¢-lpush</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956130261.png" srcset="/img/loading.gif" alt="1570956130261"></p><h3 id="å¢-linsert"><a href="#å¢-linsert" class="headerlink" title="å¢-linsert"></a>å¢-linsert</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956211897.png" srcset="/img/loading.gif" alt="1570956211897"></p><h3 id="åˆ -lpop"><a href="#åˆ -lpop" class="headerlink" title="åˆ -lpop"></a>åˆ -lpop</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956226489.png" srcset="/img/loading.gif" alt="1570956226489"></p><h3 id="åˆ -rpop"><a href="#åˆ -rpop" class="headerlink" title="åˆ -rpop"></a>åˆ -rpop</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956245391.png" srcset="/img/loading.gif" alt="1570956245391"></p><h3 id="åˆ -lrem"><a href="#åˆ -lrem" class="headerlink" title="åˆ -lrem"></a>åˆ -lrem</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956295624.png" srcset="/img/loading.gif" alt="1570956295624"></p><pre><code class="hljs bash">lrem listkey 0 a<span class="hljs-comment">#åˆ é™¤æ‰€æœ‰ç­‰äºaçš„å…ƒç´ </span>lrem listkey -1 c<span class="hljs-comment">#ä»å³è¾¹å¼€å§‹ï¼ŒæŠŠæœ€å³è¾¹çš„cåˆ é™¤</span></code></pre><h3 id="åˆ -ltrim"><a href="#åˆ -ltrim" class="headerlink" title="åˆ -ltrim"></a>åˆ -ltrim</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956626328.png" srcset="/img/loading.gif" alt="1570956626328">     </p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956651183.png" srcset="/img/loading.gif" alt="1570956651183"></p><pre><code class="hljs bash">ltrim listkye 1 4<span class="hljs-comment">#ä¿ç•™1-4çš„æ•°æ®</span></code></pre><h3 id="æŸ¥-lrange"><a href="#æŸ¥-lrange" class="headerlink" title="æŸ¥-lrange"></a>æŸ¥-lrange</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956744153.png" srcset="/img/loading.gif" alt="1570956744153"></p><h3 id="æŸ¥-lindex"><a href="#æŸ¥-lindex" class="headerlink" title="æŸ¥-lindex"></a>æŸ¥-lindex</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570956823765.png" srcset="/img/loading.gif" alt="1570956823765"></p><h3 id="lset"><a href="#lset" class="headerlink" title="lset"></a>lset</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570957349048.png" srcset="/img/loading.gif" alt="1570957349048"></p><h3 id="blpopã€brpop"><a href="#blpopã€brpop" class="headerlink" title="blpopã€brpop"></a>blpopã€brpop</h3><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1570957222653.png" srcset="/img/loading.gif" alt="1570957222653"></p><h3 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3><ul><li>LRPUSH+LPOP=Stack</li><li>LPUSH+RPOP=Queue</li><li>LPUSH+LTRIM=Capped Collection</li><li>LPUSH+BRPOP=Message Queue</li></ul>]]></content>
    
    
    <categories>
      
      <category>è¿ç»´</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ å…­ã€RBAC ã€‘ 4.åŸºäºæ•°æ®åº“Rbacæ•°æ®æ¨¡å‹æ§åˆ¶æƒé™</title>
    <link href="/spring-security-6.4.html"/>
    <url>/spring-security-6.4.html</url>
    
    <content type="html"><![CDATA[<h1 id="åŸºäºæ•°æ®åº“Rbacæ•°æ®æ¨¡å‹æ§åˆ¶æƒé™"><a href="#åŸºäºæ•°æ®åº“Rbacæ•°æ®æ¨¡å‹æ§åˆ¶æƒé™" class="headerlink" title="åŸºäºæ•°æ®åº“Rbacæ•°æ®æ¨¡å‹æ§åˆ¶æƒé™"></a>åŸºäºæ•°æ®åº“Rbacæ•°æ®æ¨¡å‹æ§åˆ¶æƒé™</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568633214421.png" srcset="/img/loading.gif" alt="1568633214421"></p><p>ä¸€èˆ¬çš„å†…éƒ¨ç®¡ç†ç³»ç»Ÿï¼Œæƒé™æ¯”è¾ƒå¤æ‚ï¼Œé€šå¸¸æƒé™éƒ½æ˜¯åŠ¨æ€é…ç½®çš„ï¼Œä¹Ÿå°±æ˜¯ä¸‹é¢æˆ‘ä»¬è¦è®²çš„çš„rbacæ¨¡å‹</p><h1 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h1><p>è¯¦ç»†åŸç†è¯·åº¦å¨˜ï¼Œè¿™é‡Œåªæ˜¯æ¶‰åŠåˆ°ä¼ä¸šæƒé™çš„åŠŸèƒ½çº§æƒé™ï¼Œæ•°æ®çº§æƒé™è¿˜è¦æˆ‘ä»¬è‡ªå·±æ§åˆ¶ï¼ˆç”¨æˆ·åªèƒ½çœ‹è§å®ƒç›¸å…³çš„ä¸šåŠ¡è¡¨æ•°æ®ï¼‰</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568633350762.png" srcset="/img/loading.gif" alt="1568633350762"></p><p>ä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œè¿™é‡Œé‡æ–°åˆ›å»ºä¸€ä¸ªå­å·¥å‚ï¼šmcr-auth-authorizeï¼Œpom.xmlå¦‚ä¸‹ï¼š</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><p>RbacService</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.rbac.service;<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ç”¨æˆ·æƒé™åˆ¤æ–­æ¥å£</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RbacService</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(HttpServletRequest request, Authentication authentication)</span></span>;&#125;</code></pre><p>RbacServiceImpl</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.rbac.service;<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> org.springframework.util.AntPathMatcher;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> java.util.ArrayList;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-meta">@Component</span>(<span class="hljs-string">"rbacService"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RbacServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RbacService</span> </span>&#123;    <span class="hljs-keyword">private</span> AntPathMatcher antPathMatcher = <span class="hljs-keyword">new</span> AntPathMatcher();    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">hasPermission</span><span class="hljs-params">(HttpServletRequest request, Authentication authentication)</span> </span>&#123;        Object principal = authentication.getPrincipal();        <span class="hljs-keyword">boolean</span> hasPermission = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">if</span> (principal <span class="hljs-keyword">instanceof</span> UserDetails) &#123;            String username = ((UserDetails) principal).getUsername();            <span class="hljs-comment">//è¯»å–ç”¨æˆ·æ‰€æ‹¥æœ‰æƒé™çš„æ‰€æœ‰URL è¿™ä¸ªåº”è¯¥æ ¹æ®ç”¨æˆ·åä»æ•°æ®åº“ä¸­æŸ¥è¯¢ æ­¤å¤„åªæ˜¯æ¨¡æ‹Ÿ</span>            List&lt;String&gt; urls = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();            <span class="hljs-keyword">for</span> (String url : urls) &#123;                <span class="hljs-comment">//åŒ¹é… /user/* è¿™ç§æ ¼å¼</span>                <span class="hljs-keyword">if</span> (antPathMatcher.match(url, request.getRequestURI())) &#123;                    hasPermission = <span class="hljs-keyword">true</span>;                    <span class="hljs-keyword">break</span>;                &#125;            &#125;        &#125;        <span class="hljs-keyword">return</span> hasPermission;    &#125;&#125;</code></pre><p>demo#pom.xml</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-authorize<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><p>DemoAuthorizeConfigProvider</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ä¸šåŠ¡æ¨¡å—æƒé™é…ç½®å®ç°</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-meta">@Order</span>(Integer.MAX_VALUE)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoAuthorizeConfigProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthorizeConfigProvider</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;<span class="hljs-comment">//        config.antMatchers(</span><span class="hljs-comment">//                "/user/regist", // æ³¨å†Œè¯·æ±‚</span><span class="hljs-comment">//                "/error",</span><span class="hljs-comment">//                "/connect/*",</span><span class="hljs-comment">//                "/auth/*",</span><span class="hljs-comment">//                "/signin",</span><span class="hljs-comment">//                "/social/signUp",  // appæ³¨å†Œè·³è½¬æœåŠ¡</span><span class="hljs-comment">//                "/swagger-ui.html",</span><span class="hljs-comment">//                "/swagger-ui.html/**",</span><span class="hljs-comment">//                "/webjars/**",</span><span class="hljs-comment">//                "/swagger-resources/**",</span><span class="hljs-comment">//                "/v2/**"</span><span class="hljs-comment">//        ).permitAll();</span>          <span class="hljs-comment">/*</span><span class="hljs-comment"> åˆ©ç”¨@Orderæ³¨è§£å®ç°CommonAuthorizeConfigProviderä¸­çš„æ”¾è¡Œè·¯å¾„ä¸éœ€è¦è‡ªå®šä¹‰æƒé™éªŒè¯</span><span class="hljs-comment"> */</span>        config.anyRequest()                .access(<span class="hljs-string">"@rbacService.hasPermission(request,authentication)"</span>);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ å…­ã€RBAC ã€‘ 3.æƒé™è¡¨è¾¾å¼</title>
    <link href="/spring-security-6.3.html"/>
    <url>/spring-security-6.3.html</url>
    
    <content type="html"><![CDATA[<h1 id="æƒé™è¡¨è¾¾å¼"><a href="#æƒé™è¡¨è¾¾å¼" class="headerlink" title="æƒé™è¡¨è¾¾å¼"></a>æƒé™è¡¨è¾¾å¼</h1><p>é€šè¿‡æºç åˆ†æå¯çŸ¥ï¼Œæœ€ç»ˆçš„é…ç½®éƒ½ä¼šè½¬æˆ<strong>ExpressionUrlAuthorizationConfigurer.AuthorizedUrl</strong>å¹¶è¿›è¡ŒæŠ•ç¥¨å†³å®šã€‚</p><p>å¸¸è§è¡¨è¾¾å¼å¦‚ä¸‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568559383045.png" srcset="/img/loading.gif" alt="1568559383045"></p><p>å¦‚ä½•å†™è”åˆè¡¨è¾¾å¼å‘¢ï¼Ÿå°±æ˜¯æ—¢æ»¡è¶³Aæ¡ä»¶ï¼Œä¹Ÿæ»¡è¶³Bæ¡ä»¶</p><pre><code class="hljs java">.antMatchers(<span class="hljs-string">"xx"</span>).access(<span class="hljs-string">"hasRole('ROLE_USER') and hasRole('ROLE_SUPER')"</span>)</code></pre><p> è¿™ä¸ªéƒ½æ˜¯springè‡ªå·±çš„æƒé™è¡¨è¾¾å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¦å¯ä»¥è‡ªå®šä¹‰å®ç°è‡ªå·±çš„æƒé™è§„åˆ™å‘¢ï¼Ÿå¯ä»¥çš„ï¼è¿™ä¸ªæˆ‘ä»¬ä¸‹ä¸€ç« å†çœ‹æ€ä¹ˆå®ç°ã€‚</p><h1 id="æƒé™ä¸šåŠ¡é…ç½®åˆ†ç¦»"><a href="#æƒé™ä¸šåŠ¡é…ç½®åˆ†ç¦»" class="headerlink" title="æƒé™ä¸šåŠ¡é…ç½®åˆ†ç¦»"></a>æƒé™ä¸šåŠ¡é…ç½®åˆ†ç¦»</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568559938142.png" srcset="/img/loading.gif" alt="1568559938142"></p><p>è¿™é‡Œçš„ä»£ç ä¸åº”è¯¥æ˜¯å†™åœ¨browserä¸­çš„ï¼Œè¿™é‡Œçš„ä»£ç åº”è¯¥ç”±demoæ¨¡å—ä¹Ÿå°±æ˜¯ä½¿ç”¨è€…æ¥ç¼–å†™ï¼Œé‚£ä¹ˆå¦‚ä½•å°†æƒé™æ¨¡å—é…ç½®å’Œä¸šåŠ¡æ¨¡å—é…ç½®æƒ³åˆ†ç¦»å‘¢ï¼Ÿä¸‹é¢å°±æ¥æ»¡è¶³è¿™ä¸ªä¸šåŠ¡åœºæ™¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568560039993.png" srcset="/img/loading.gif" alt="1568560039993"></p><p>å®ç°æ€è·¯å¦‚ä¸‹ï¼š</p><p>æä¾›AuthorizeConfigProvideræ¥å£ï¼Œæä¾›æƒé™è®¾ç½®<br>æƒé™æ¨¡å—çš„é€šç”¨é…ç½®å®ç°è¯¥æ¥å£ï¼Œç„¶åè¿›è¡Œé…ç½®ï¼Œä¸šåŠ¡æ¨¡å—æŒ‰éœ€ä¹Ÿå®ç°è¯¥æ¥å£è¿›è¡Œé…ç½®<br>æœ€åä½¿ç”¨ AuthorizeConfigManagerç±»æ¥ç®¡ç†æ‰€æœ‰çš„AuthorizeConfigProviderå®ç°<br>æ‹¿åˆ°æ‰€æœ‰çš„é…ç½®åï¼Œè¿›è¡Œç»Ÿä¸€è®¾ç½®</p><hr><p>ä»£ç å®ç°å¦‚ä¸‹ï¼š</p><p>æƒé™æ§åˆ¶æ¥å£åŠå®ç° </p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authorize; <span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer; <span class="hljs-comment">/**</span><span class="hljs-comment"> * è‡ªå®šä¹‰æƒé™æ§åˆ¶æ¥å£</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthorizeConfigProvider</span> </span>&#123; <span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> config</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> è¿”å›çš„booleanè¡¨ç¤ºé…ç½®ä¸­æ˜¯å¦æœ‰é’ˆå¯¹anyRequestçš„é…ç½®ã€‚åœ¨æ•´ä¸ªæˆæƒé…ç½®ä¸­ï¼Œ</span><span class="hljs-comment"> * åº”è¯¥æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªé’ˆå¯¹anyRequestçš„é…ç½®ï¼Œå¦‚æœæ‰€æœ‰çš„å®ç°éƒ½æ²¡æœ‰é’ˆå¯¹anyRequestçš„é…ç½®ï¼Œ</span><span class="hljs-comment"> * ç³»ç»Ÿä¼šè‡ªåŠ¨å¢åŠ ä¸€ä¸ªanyRequest().authenticated()çš„é…ç½®ã€‚å¦‚æœæœ‰å¤šä¸ªé’ˆå¯¹anyRequest</span><span class="hljs-comment"> * çš„é…ç½®ï¼Œåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span></span>;&#125;</code></pre><p>é€šç”¨æƒé™è®¾ç½®</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authorize;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.SecurityConstants;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.SecurityProperties;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.core.annotation.Order;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> javax.annotation.Resource;<span class="hljs-comment">/**</span><span class="hljs-comment"> * é€šç”¨æƒé™æ¥å£é…ç½®ç®¡ç†</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-meta">@Order</span>(Integer.MIN_VALUE)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommonAuthorizeConfigProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthorizeConfigProvider</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;        config.antMatchers(                SecurityConstants.DEFAULT_UNAUTHENTICATED_URL,<span class="hljs-comment">//æƒé™è®¤è¯</span>                SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE,<span class="hljs-comment">//æ‰‹æœº</span>                SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_OPENID,<span class="hljs-comment">//openId</span>                securityProperties.getBrowser().getLoginUrl(),<span class="hljs-comment">//ç™»å½•é¡µé¢</span>                SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="hljs-string">"/*"</span>,                securityProperties.getBrowser().getSignUpUrl(),<span class="hljs-comment">//                securityProperties.getBrowser().getSignOutUrl(),</span>                securityProperties.getBrowser().getSession().getSessionInvalidUrl()        ).permitAll();<span class="hljs-comment">//æ”¾è¡Œ</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;&#125;</code></pre><p>ä¸šåŠ¡æ¨¡å—æƒé™è®¾ç½®</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.authorize.AuthorizeConfigProvider;<span class="hljs-keyword">import</span> org.springframework.core.annotation.Order;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ä¸šåŠ¡æ¨¡å—æƒé™é…ç½®å®ç°</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-meta">@Order</span>(Integer.MAX_VALUE)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoAuthorizeConfigProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthorizeConfigProvider</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;        config.antMatchers(                <span class="hljs-string">"/user/regist"</span>, <span class="hljs-comment">// æ³¨å†Œè¯·æ±‚</span>                <span class="hljs-string">"/error"</span>,                <span class="hljs-string">"/connect/*"</span>,                <span class="hljs-string">"/auth/*"</span>,                <span class="hljs-string">"/signin"</span>,                <span class="hljs-string">"/social/signUp"</span>,  <span class="hljs-comment">// appæ³¨å†Œè·³è½¬æœåŠ¡</span>                <span class="hljs-string">"/swagger-ui.html"</span>,                <span class="hljs-string">"/swagger-ui.html/**"</span>,                <span class="hljs-string">"/webjars/**"</span>,                <span class="hljs-string">"/swagger-resources/**"</span>,                <span class="hljs-string">"/v2/**"</span>        ).permitAll();        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;&#125;</code></pre><p>æƒé™æ¥å£ç®¡ç†å™¨åŠå®ç°</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authorize; <span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer; <span class="hljs-comment">/**</span><span class="hljs-comment"> * æƒé™æ§åˆ¶æ¥å£æŒæœ‰ç®¡ç†è€…</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AuthorizeConfigManager</span> </span>&#123; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span></span>;&#125;</code></pre><p>æƒé™æ¥å£ç®¡ç†å™¨åŠå®ç°é»˜è®¤å®ç°</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authorize;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configurers.ExpressionUrlAuthorizationConfigurer;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-keyword">import</span> java.util.Set;<span class="hljs-comment">/**</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultAuthorizeConfigManager</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthorizeConfigManager</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> List&lt;AuthorizeConfigProvider&gt; providers;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">config</span><span class="hljs-params">(ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry config)</span> </span>&#123;        <span class="hljs-keyword">boolean</span> existAnyRequestConfig = <span class="hljs-keyword">false</span>;        String existAnyRequestConfigName = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">for</span> (AuthorizeConfigProvider authorizeConfigProvider : providers) &#123;            <span class="hljs-keyword">boolean</span> currentIsAnyRequestConfig = authorizeConfigProvider.config(config);            <span class="hljs-keyword">if</span> (!existAnyRequestConfig &amp;&amp; !currentIsAnyRequestConfig) &#123;                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"é‡å¤çš„anyRequesté…ç½®:"</span> + existAnyRequestConfigName + <span class="hljs-string">","</span>                        + authorizeConfigProvider.getClass().getSimpleName());            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (currentIsAnyRequestConfig) &#123;                existAnyRequestConfig = <span class="hljs-keyword">true</span>;                existAnyRequestConfigName = authorizeConfigProvider.getClass().getSimpleName();            &#125;        &#125;        <span class="hljs-keyword">if</span> (existAnyRequestConfig) &#123;            config.anyRequest().authenticated();        &#125;    &#125;&#125;</code></pre><p>æµè§ˆå™¨æ¨¡å—é…ç½®è¿›è¡Œè°ƒæ•´ï¼ˆappæ¨¡å—åŒç†ï¼‰ï¼Œå°±æ˜¯å°†åŸæ¥çš„é…ç½®æŠ½ç¦»å‡ºå»ã€‚</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;    <span class="hljs-keyword">private</span> AuthorizeConfigManager authorizeConfigManager;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        BrowserSecurityProperties browser = security.getBrowser();        http                .rememberMe()                .tokenRepository(repository())                .tokenValiditySeconds(browser.getRememberMeSeconds())                .userDetailsService(userDetailsService)                .and()                .logout()<span class="hljs-comment">//                .logoutSuccessUrl("/mcr-logout.html")</span>                .logoutSuccessHandler(logoutSuccessHandler)                .deleteCookies(<span class="hljs-string">"JSESSIONID"</span>)                .logoutUrl(<span class="hljs-string">"/signOut"</span>)                .and()                .sessionManagement()                .invalidSessionStrategy(invalidSessionStrategy)                .maximumSessions(browser.getSession().getMaximumSessions()).maxSessionsPreventsLogin(browser.getSession().isMaxSessionsPreventsLogin())                .expiredSessionStrategy(sessionInformationExpiredStrategy)                .and()                .and()                .apply(smsCodeAuthenticationSecurityConfig)                .and()                .apply(mcrSpringSocialConfigurer)                .and()                .addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"></span><span class="hljs-class">                .<span class="hljs-title">formLogin</span>()</span><span class="hljs-class">                .<span class="hljs-title">successHandler</span>(<span class="hljs-title">authenticationSuccessHandler</span>)</span><span class="hljs-class">                .<span class="hljs-title">failureHandler</span>(<span class="hljs-title">authenticationFailureHandler</span>)</span><span class="hljs-class">                .<span class="hljs-title">loginPage</span>(<span class="hljs-title">SecurityConstants</span>.<span class="hljs-title">DEFAULT_UNAUTHENTICATED_URL</span>)</span><span class="hljs-class">                .<span class="hljs-title">loginProcessingUrl</span>(<span class="hljs-title">SecurityConstants</span>.<span class="hljs-title">DEFAULT_LOGIN_PROCESSING_URL_FORM</span>)</span><span class="hljs-class">                .<span class="hljs-title">and</span>()</span><span class="hljs-class">                .<span class="hljs-title">csrf</span>()</span><span class="hljs-class">                .<span class="hljs-title">disable</span>()</span>;        authorizeConfigManager.config(http.authorizeRequests());    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ å…­ã€RBAC ã€‘ 2.Spring Securityæˆæƒæºç è§£æ</title>
    <link href="/spring-security-6.2.html"/>
    <url>/spring-security-6.2.html</url>
    
    <content type="html"><![CDATA[<h1 id="Spring-Securityæˆæƒæºç è§£æ"><a href="#Spring-Securityæˆæƒæºç è§£æ" class="headerlink" title="Spring Securityæˆæƒæºç è§£æ"></a>Spring Securityæˆæƒæºç è§£æ</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568551319566.png" srcset="/img/loading.gif" alt="1568551319566"></p><blockquote><p>FilterSecurityInterceptorè´Ÿè´£æœ€ç»ˆå†³å®šå½“å‰çš„è¯·æ±‚æ˜¯å¦èƒ½é€šè¿‡è¿‡æ»¤å™¨æ¥è®¿é—®æœ€åçš„apiï¼Œå¦‚æœä¸èƒ½ä¼šæ ¹æ®ä¸åŒçš„åŸå› æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åç”±ExceptionTranslationFilteræ¥å¤„ç†ï¼Œ </p></blockquote><p>ä¸Šé¢çš„è¿‡æ»¤å™¨é“¾æˆ‘å°±ä¸åœ¨é‡å¤è¯´ä¸€éäº†ï¼Œè¿™é‡Œè¦ä»‹ç»çš„AnonymousAuthenticationFilterï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¸­æ–‡æ„æ€ï¼šåŒ¿åè¿‡æ»¤å™¨ï¼Œå®ƒåœ¨å›¾ä¸­è¿‡æ»¤å™¨é“¾ï¼Œç»¿è‰²è¿‡æ»¤å™¨ä¸­çš„æœ€åä¸€ä¸ªï¼Œçœ‹æ¥ä¸€ä¸‹å®ƒçš„doFilteræ–¹æ³•ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;<span class="hljs-keyword">if</span> (SecurityContextHolder.getContext().getAuthentication() == <span class="hljs-keyword">null</span>) &#123;SecurityContextHolder.getContext().setAuthentication(createAuthentication((HttpServletRequest) req));<span class="hljs-comment">//....</span>    &#125;<span class="hljs-keyword">else</span>&#123;<span class="hljs-comment">//...&#125;</span>chain.doFilter(req, res);&#125;</code></pre><p>è¿™é‡Œçš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ¤æ–­SecurityContexté‡Œé¢æ˜¯å¦æœ‰Authentication,å¦‚æœæ˜¯ç©ºçš„ï¼Œå®ƒä¼šæ‰§è¡ŒcreateAuthenticationæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªAuthenticationæ”¾åˆ°SecurityContexté‡Œï¼Œæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Authentication <span class="hljs-title">createAuthentication</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;AnonymousAuthenticationToken auth = <span class="hljs-keyword">new</span> AnonymousAuthenticationToken(key,principal, authorities);auth.setDetails(authenticationDetailsSource.buildDetails(request));<span class="hljs-keyword">return</span> auth;&#125;</code></pre><p>åœ¨è¿™é‡Œçš„AnonymousAuthenticationTokenåˆ›å»ºå¯ä»¥çœ‹ä¸€ä¸‹ä»£ç ä¸­ï¼Œçœ‹å‡ºæ¥è¿™é‡Œçš„ç”¨æˆ·ä¿¡æ¯æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²:â€œanonymousUserâ€ï¼Œä¸å’Œä¹‹å‰çš„Tokenä¸€æ ·æ˜¯UserDetailsæ¥å£çš„å®ç°ï¼Œ</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnonymousAuthenticationFilter</span><span class="hljs-params">(String key)</span> </span>&#123;<span class="hljs-keyword">this</span>(key, <span class="hljs-string">"anonymousUser"</span>, AuthorityUtils.createAuthorityList(<span class="hljs-string">"ROLE_ANONYMOUS"</span>));&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnonymousAuthenticationFilter</span><span class="hljs-params">(String key, Object principal,</span></span><span class="hljs-function"><span class="hljs-params">List&lt;GrantedAuthority&gt; authorities)</span> </span>&#123;Assert.hasLength(key, <span class="hljs-string">"key cannot be null or empty"</span>);Assert.notNull(principal, <span class="hljs-string">"Anonymous authentication principal must be set"</span>);Assert.notNull(authorities, <span class="hljs-string">"Anonymous authorities must be set"</span>);<span class="hljs-keyword">this</span>.key = key;<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">this</span>.authorities = authorities;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnonymousAuthenticationFilter</span><span class="hljs-params">(String key, Object principal,</span></span><span class="hljs-function"><span class="hljs-params">List&lt;GrantedAuthority&gt; authorities)</span> </span>&#123;Assert.hasLength(key, <span class="hljs-string">"key cannot be null or empty"</span>);Assert.notNull(principal, <span class="hljs-string">"Anonymous authentication principal must be set"</span>);Assert.notNull(authorities, <span class="hljs-string">"Anonymous authorities must be set"</span>);<span class="hljs-keyword">this</span>.key = key;<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">this</span>.authorities = authorities;&#125;</code></pre><p>ä¹Ÿå°±æ˜¯è¯´ä¸è¿‡å‰é¢çš„è¿‡æ»¤å™¨éªŒè¯è¿‡æ²¡è¿‡ï¼Œå¦‚æœéƒ½æ²¡è¿‡ï¼Œåœ¨è¿™ä¸ªè¿‡æ»¤å™¨ä¸­è¿˜æ˜¯ä¼šåˆ›å»ºä¸€ä¸ªAuthenticationï¼Œ</p><p>è¿™ä¸ªAuthenticationä¼šä¼ é€’ç»™FilterSecurityInterceptorç”±å®ƒæ¥å†³å®šå½“å‰çš„Authenticationæ‰€åŒ…å«çš„ä¿¡æ¯æ˜¯å¦å¯ä»¥è®¿é—®å½“å‰è¯·æ±‚çš„URL</p><hr><p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹FilterSecurityInterceptorå’ŒExceptionTranslationFilterçš„ä»£ç ï¼Œåœ¨è¿™ä¹‹å‰æ¥çœ‹ä¸€å¼ å›¾ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568552428831.png" srcset="/img/loading.gif" alt="1568552428831"></p><ul><li>FilterSecurityInterceptorï¼šä¸»å…¥å£</li><li>AccessDecisionManagerï¼šè®¿é—®ç®¡ç†è€…ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ‹¥æœ‰1ä¸€ä¸ªæŠ½è±¡å®ç°ï¼Œ3ä¸ªå…·ä½“å®ç°ï¼Œè´Ÿè´£ç®¡ç†ä¸€ç»„AccessDecisionVoterï¼ŒAccessDecisionVoterï¼šæŠ•ç¥¨äººï¼Œåœ¨spring Security3ä¹‹å‰ï¼ŒAccessDecisionManageræ˜¯ä¸€ç»„AccessDecisionVoteræ¥å£çš„å®ç°ï¼Œ ä¸åŒçš„å®ç°å¤„ç†ä¸åŒçš„é€»è¾‘ï¼Œæ¯”å¦‚åˆ¤æ–­å½“å‰Authenticationé‡Œé¢æ˜¯å¦é‡Œé¢åŒ…å«æŸç§è§’è‰²ï¼Œæœ‰çš„æŠ•ç¥¨ä¸­åˆ¤æ–­å½“å‰Authenticationæ˜¯å¦ç»è¿‡èº«ä»½è®¤è¯ï¼Œæœ‰å„ç§å„æ ·çš„åˆ¤æ–­ï¼Œæ¯ç§åˆ¤æ–­é€»è¾‘éƒ½æ˜¯æŠ•ç¥¨è€…çš„å®ç°ï¼Œåœ¨è¿™ä¸ªç®¡ç†è€…é‡Œé¢ç»´æŠ¤äº†ä¸€ç»„å¤´æŠ•ç¥¨è€…ï¼Œå½“å®ƒæ”¶åˆ°è¯·æ±‚ä»¥åï¼Œæ¯ä¸€ä¸ªæŠ•ç¥¨è€…ä¼šæ ¹æ®è‡ªå·±çš„é€»è¾‘å»æŠ•å‡ºè‡ªå·±çš„ä¸€ç¥¨ï¼Œè¯´è¿™ä¸ªè¯·æ±‚æŠ•è¿‡è¿˜æ˜¯ä¸è¿‡</li><li>AbstractAccessDecisionManagerï¼šAccessDecisionManageræ¥å£çš„æŠ½è±¡å®ç°ï¼Œåœ¨å®ƒçš„è¿™ä¸ªå®ç°é‡Œé¢ï¼Œå®ƒä¼šç»¼åˆæ‰€æœ‰æŠ•ç¥¨è€…çš„æŠ•ç¥¨ç»“æœæ¥ç»™å‡ºæœ€ç»ˆçš„ç»“æœï¼Œè¿‡è¿˜æ˜¯ä¸è¿‡ï¼Œåˆ¤æ–­æœ€ç»ˆçš„é€»è¾‘æœ‰3å¥—ä¸åŒçš„é€»è¾‘ï¼Œåˆ†åˆ«åœ¨å®ƒ3ä¸ªå­ç±»é‡Œé¢ï¼š<ul><li>AffirmativeBasedï¼šåªè¦VoteræŠ•è¿‡ï¼Œæ•´ä¸ªè¯·æ±‚å°±æ˜¯é€šè¿‡ï¼Œå¯ä»¥è®¿é—®</li><li>ConsensusBasedï¼šåªè¦æœ‰ä¸€ä¸ªVoteræŠ•ä¸è¿‡ï¼Œæ•´ä¸ªè¯·æ±‚å°±æ‹’æ¥åŠ</li><li>UnanimousBasedï¼šæ ¹æ®VoteræŠ•é€šè¿‡å’Œä¸é€šè¿‡çš„ä¸ªæ•°ï¼Œæ¥æ¯”è¾ƒè¿‡å’Œä¸è¿‡çš„ä¸ªæ•°å¤šï¼Œé€‰æ‹©å¤šçš„ä¸€æ–¹</li></ul></li></ul><p>åœ¨spring Securityä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯AffirmativeBased</p><p>SecurityConfig</p><p>éœ€è¦åˆ¤æ–­ä¸€ä¸ªè¯·æ±‚æ˜¯å¦èƒ½è¿‡ï¼Œéœ€è¦2æ”¾æ•°æ®ï¼Œé¦–å…ˆæ˜¯ç³»ç»Ÿçš„é…ç½®ä¿¡æ¯ï¼ŒA URLè®¿é—®éœ€è¦ä»€ä¹ˆæƒé™ï¼ŒB URLéœ€è¦ä»€ä¹ˆè¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰å†™çš„BrowserSecurityConfigçš„ä»£ç ï¼š</p><pre><code class="hljs java">.authorizeRequests()              .antMatchers(                      <span class="hljs-string">"/session/invalid"</span>,                      browser.getRegistUrl(),                      browser.getLoginUrl(),                      browser.getSignUpUrl(),                      SecurityConstants.DEFAULT_UNAUTHENTICATED_URL,                      SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="hljs-string">"/*"</span>              )              .permitAll()              .antMatchers(<span class="hljs-string">"/user/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)              .anyRequest()              .authenticated()</code></pre><p>FilterSecurityInterceptorä¼šæ ¹æ®å®‰å…¨é…ç½®é‡Œé¢æŠŠä¸Šé¢çš„ä¿¡æ¯è¯»å‡ºæ¥å°è£…æˆConfigAttributeä¸€ç»„å¯¹è±¡ï¼Œè¿™ç»„å¯¹è±¡æ¯ä¸€ä¸ªConfigAttributeå¯¹åº”URLéœ€è¦çš„æƒé™ï¼Œ</p><p>SecurityContextHolderï¼š</p><p>å½“å‰ç”¨æˆ·æ‰€æ‹¥æœ‰çš„æƒé™ä¿¡æ¯ï¼Œç”¨æˆ·æœ‰å“ªäº›æƒé™ï¼Œè¿™äº›ä¿¡æ¯å°±æ˜¯å°è£…åœ¨Authenticationé‡Œé¢çš„</p><hr><p>FilterSecurityInterceptoré€šè¿‡SecurityConfigå’ŒSecurityContextHolderå†åŠ ä¸Šå’ŒFilterSecurityInterceptorå°è£…çš„å½“å‰è¯·æ±‚ä¿¡æ¯ä¼ ç»™AccessDecisionManagerï¼ŒAccessDecisionManageræŠŠè¿™äº›ä¿¡æ¯ç»™æŠ•ç¥¨è€…ï¼Œç”±æŠ•ç¥¨è€…æ¥æŠ•ç¥¨æ˜¯è¿‡è¿˜æ˜¯ä¸è¿‡ï¼Œç„¶åæ±‡æ€»æŠ•ç¥¨ç»“æœè¿‡å‡ºä¸€ä¸ªæœ€ç»ˆç»“æœã€‚</p><hr><p>ä»¥ä¸Šè¯´çš„ä¸€ç»„æŠ•ç¥¨è€…æ˜¯spring3ä»¥å‰ï¼Œåœ¨3ä¹‹åæä¾›äº†ä¸€ç§æ–°çš„ç‰¹æ€§ï¼Œå«springè¡¨è¾¾å¼ï¼ŒåŸºäºä¸Šé¢çš„ç‰¹æ€§ï¼Œspring3æ–°å¢äº†ä¸€ä¸ªWebExpressionVoterï¼Œè¿™ä¸ªæŠ•ç¥¨è€…åŒ…åŠäº†æ‰€æœ‰Voterå·¥ä½œï¼Œåœ¨spring 3ä»¥åï¼Œåœ¨webç¯å¢ƒä¸‹ï¼Œæ‰€æœ‰çš„æŠ•ç¥¨å·¥ä½œç”±è¿™ä¸€ä¸ªæŠ•ç¥¨è¿‡æ»¤å™¨åŒ…åŠäº†</p><hr><p>å‰é¢å›¾ä»‹ç»å®Œäº†ï¼Œæ¥debugæ¥çœ‹ä¸€ä¸‹</p><p>debugä½ç½®ï¼š</p><ul><li>FilterSecurityInterceptorï¼š90è¡Œ</li><li>AbstractSecurityInterceptorï¼š235è¡Œ</li><li>ExceptionTranslationFilterï¼š123è¡Œ</li></ul><p>è®¿é—®æ‹’ç»æµç¨‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568554446330.png" srcset="/img/loading.gif" alt="1568554446330"></p><p>é¦–å…ˆä¼šè¿›å…¥doFilteræ–¹æ³•ï¼Œè¿™é‡Œè°ƒç”¨äº†invokeæ–¹æ³•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568554473190.png" srcset="/img/loading.gif" alt="1568554473190"></p><p>è¿™é‡Œçš„invokeä¼šåšä¸€ä¸ªåˆ¤æ–­ï¼Œä½ å½“å‰çš„è¯·æ±‚ä¹‹å‰æ˜¯å¦ç»è¿‡è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œå¦‚æœä¹‹å‰è¿™ä¸ªè¯·æ±‚ç»è¿‡è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å°±ç›´æ¥å¾€ä¸‹èµ°ï¼Œå®ƒåˆ¤æ–­çš„ä¾æ®ï¼š</p><pre><code class="hljs java">fi.getRequest().getAttribute(FILTER_APPLIED) != <span class="hljs-keyword">null</span></code></pre><p>åˆ¤æ–­è¯·æ±‚çš„FILTER_APPLIEDæ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œå¦‚æœä¸ä¸ºç©ºæœ‰å€¼ï¼Œå°±æŒ‰ä¹‹å‰èµ°è¿‡è¿™ä¸ªè¿‡æ»¤å™¨å¤„ç†ï¼Œè¿™é‡Œæˆ‘æ˜¯ç¬¬ä¸€æ¬¡è®¿é—®è¿™ä¸ªåº”ç”¨ï¼Œæ‰€ä»¥èµ°çš„æ˜¯else</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568554732440.png" srcset="/img/loading.gif" alt="1568554732440"></p><p>é¦–å…ˆå®ƒä¼šç»™è¯·æ±‚ä¸­çš„FILTER_APPLIEDå±æ€§è®¾ç½®ä¸Šï¼Œä¸‹æ¬¡åˆç»è¿‡è¿™ä¸ªè¿‡æ»¤å™¨å°±ä¸ä¼šèµ°elseäº†ï¼Œæœ€å…³é”®çš„ä»£ç ï¼š</p><pre><code class="hljs java">InterceptorStatusToken token = <span class="hljs-keyword">super</span>.beforeInvocation(fi);</code></pre><p>å¦‚æœåœ¨è¿™é‡Œå‡ºäº†é—®é¢˜å®ƒå°±æŠ›å¼‚å¸¸ï¼Œæ•´ä¸ªå°±ä¸­æ–­äº†ï¼Œå¦‚æœä¸æŠ›å¼‚å¸¸æ²¡é—®é¢˜ï¼Œå°±ä¼šå†å¾€ä¸‹è°ƒç”¨è¿‡æ»¤å™¨é“¾ï¼Œã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸‹beforeInvocationè¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568554968267.png" srcset="/img/loading.gif" alt="1568554968267"></p><pre><code class="hljs java">Collection&lt;ConfigAttribute&gt; attributes = <span class="hljs-keyword">this</span>.obtainSecurityMetadataSource().getAttributes(object);</code></pre><p>è¿™é‡Œè·å–äº†å‰é¢ä»‹ç»çš„ConfigAttributeï¼Œè¿™é‡Œæ˜¯æ ¹æ®BrowserSecurityConfigé…ç½®ä¿¡æ¯å°è£…çš„ã€‚</p><p>obtainSecurityMetadataSourceæ–¹æ³•æ˜¯ConfigAttributeé›†åˆçš„å°è£…é€»è¾‘ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568555168543.png" srcset="/img/loading.gif" alt="1568555168543"></p><p>è¿™é‡Œå¯¹requestMapè¿›è¡Œå¾ªç¯ï¼Œå¯ä»¥çœ‹åˆ°requestMapçš„å†…å®¹å°±æ˜¯BrowserSecurityConfigé…ç½®çš„å†…å®¹ï¼Œè¿™é‡Œä¼šæ ¹æ®å½“å‰è¯·æ±‚çš„URLå»åœ¨è¿™ä¸ªrequestMapä¸­å»æ‰¾æ‰€éœ€è¦çš„æƒé™ï¼Œè¿™é‡Œæˆ‘è®¿é—®çš„æ˜¯/userè¿™æ ·çš„åœ°å€ï¼Œè¿”å›å†…å®¹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568555438147.png" srcset="/img/loading.gif" alt="1568555438147"></p><p>è¿™é‡Œè¦æ±‚ç”¨æˆ·hasRole(â€˜ROLE_ADMINâ€™)è¿”å›ä¸ºtrueï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·éœ€è¦æ˜¯ROLE_ADMINè§’è‰²</p><hr><p>å¾€ä¸‹èµ°åˆ°è¿™é‡Œï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568555618786.png" srcset="/img/loading.gif" alt="1568555618786"></p><p>è¿™é‡Œåˆ¤æ–­SecurityContextä¸­çš„Authenticationæ˜¯ä¸æ˜¯ç©ºï¼Œä¹‹å‰ä»‹ç»è¿‡ï¼ŒåŠæ—¶å‰é¢è¿‡æ»¤å™¨éƒ½æ²¡é€šè¿‡ï¼Œè¿˜æ˜¯æœ‰åœ¨æœ€åä¸€ä¸ªè¿‡æ»¤å™¨ä¸­è®¾ç½®Authenticationï¼Œæ‰€ä»¥ä¸å¯èƒ½æ˜¯ç©ºï¼Œè¿™é‡Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸</p><p>åœ¨å¾€ä¸‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568555956517.png" srcset="/img/loading.gif" alt="1568555956517"></p><pre><code class="hljs java">Authentication authenticated = authenticateIfRequired();</code></pre><p>è¿™é‡Œä¼šåˆ°Authenticationåšä¸€äº›åˆ¤æ–­ç„¶åè¿”å›ï¼Œç„¶åæ‰§è¡Œï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</code></pre><p>è¿™é‡Œå°±æ˜¯å‰é¢ä»‹ç»çš„è®¿é—®ç®¡ç†è€…äº†ï¼Œè¿™é‡Œçš„objectå°±æ˜¯è¯·æ±‚ä¿¡æ¯ï¼Œè¿™é‡Œä¼šä½¿ç”¨AffirmativeBased#decideï¼Œå®ƒæ˜¯é»˜è®¤çš„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568556156687.png" srcset="/img/loading.gif" alt="1568556156687"></p><p>è¿™ä¸ªåªè¦æœ‰ä¸€ä¸ªæŠ•ä¸è¿‡ï¼Œé‚£ä¹ˆè¯·æ±‚å°±ä¸è¿‡ï¼Œé¦–å…ˆå®ƒä¼šå¾ªç¯æ‰€æœ‰æŠ•ç¥¨è€…</p><p>åœ¨webç¯å¢ƒä¸‹å°±åªå‰©ä¸‹è¿™ä¸€ä¸ªæŠ•ç¥¨è€…äº†ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ¹æ®è¡¨è¾¾å¼çš„æŠ•ç¥¨å™¨</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568556239210.png" srcset="/img/loading.gif" alt="1568556239210"></p><pre><code class="hljs java"><span class="hljs-keyword">int</span> result = voter.vote(authentication, object, configAttributes);</code></pre><p>è¿™é‡Œä¼šå°†å‰é¢çš„ä¿¡æ¯äº¤ç»™æŠ•ç¥¨å™¨ï¼Œè®©å®ƒå»æŠ•ç¥¨ï¼Œæœ€ç»ˆç»“æœä¸ºâ€œ-1â€ï¼Œå°±æ˜¯ä¸è¿‡æ„æ€ï¼Œå› ä¸ºæˆ‘å½“å‰è®¿é—®çš„è¡¨è¾¾å¼éœ€è¦æƒé™ï¼šhasRole(â€˜ROLE_ADMINâ€™)ï¼Œè€Œæˆ‘è¿™é‡Œçš„æƒé™ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568556466007.png" srcset="/img/loading.gif" alt="1568556466007"></p><p>å®ƒæ˜¯ä¸€ä¸ªåŒ¿åçš„ï¼Œæ‰€ä»¥æœ€ç»ˆç»“æœä¸ºä¸è¿‡ï¼Œè¿™é‡Œå¦‚æœæœ‰ä¸€ä¸ªä¸è¿‡å°±ä¼šå¯¹denyå˜é‡è¿›è¡Œç´¯åŠ ï¼Œå¦‚æœæœ‰ä»»ä½•æŠ•ç¥¨å™¨æŠ•äº†ä¸è¿‡ï¼Œå°±ä¼šæŠ›å¼‚å¸¸</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568556560419.png" srcset="/img/loading.gif" alt="1568556560419"></p><p>è¿™é‡ŒæŠ›å‡ºçš„å¼‚å¸¸ä¼šåœ¨AccessDecisionManagerä¸­è¿›è¡ŒæŠ›å‡ºï¼Œå®ƒä¼šæŠ›ç»™è°ƒç”¨å®ƒçš„FilterSecurityInterceptorï¼Œé‚£ä¹ˆæ•è·åˆ°è¿™ä¸ªè®¿é—®æ‹’ç»å¼‚å¸¸ä»¥åï¼Œä¼šæ‰§è¡Œä»¥ä¸‹ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">catch</span> (AccessDeniedException accessDeniedException) &#123;publishEvent(<span class="hljs-keyword">new</span> AuthorizationFailureEvent(object, attributes, authenticated,accessDeniedException));<span class="hljs-keyword">throw</span> accessDeniedException;&#125;</code></pre><p>é¦–å…ˆåœ¨springå®¹å™¨é‡Œå‘ä¸€ä¸ªäº‹ä»¶ï¼Œç„¶åå†ç»§ç»­æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ï¼Œå†æŠ›å‡ºè¿™ä¸ªå¼‚å¸¸ä¼šè·‘åˆ°ExceptionTranslationFilterè¿‡æ»¤å™¨ä¸Š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568557057727.png" srcset="/img/loading.gif" alt="1568557057727"></p><p>å…ˆæ¥è¯´ä¸‹è¿™2æ®µä»£ç ï¼š</p><pre><code class="hljs java">RuntimeException ase = (AuthenticationException) throwableAnalyzer.getFirstThrowableOfType(AuthenticationException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;<span class="hljs-keyword">if</span> (ase == <span class="hljs-keyword">null</span>) &#123;ase = (AccessDeniedException) throwableAnalyzer.getFirstThrowableOfType(AccessDeniedException<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">causeChain</span>)</span>;&#125;</code></pre><p>é¦–å…ˆå®ƒä¼šå»æ ¹æ®å¼‚å¸¸æ¥çœ‹ä¸€ä¸‹æ˜¯ä¸æ˜¯AuthenticationExceptionï¼Œå‰é¢æŠ›å‡ºçš„æ˜¯ä¸€ä¸ªAccessDeniedExceptionæ‰€ä»¥ï¼Œä¼šè¿”å›ç©ºï¼Œé‚£ä¹ˆå°±ä¼šè¿›åˆ°è¿™ä¸ªifä¸­è¿™é‡Œæ˜¯åˆ¤æ–­æ˜¯å¦æ˜¯AccessDeniedExceptionå¼‚å¸¸ï¼Œè¿™é‡Œå°±æœ‰å€¼äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568557191088.png" srcset="/img/loading.gif" alt="1568557191088"></p><p>æœ‰å€¼ä»¥åï¼Œæ‰§è¡ŒhandleSpringSecurityExceptionæ–¹æ³•æ¥å¤„ç†å¼‚å¸¸ï¼Œ</p><pre><code class="hljs java"><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (exception <span class="hljs-keyword">instanceof</span> AccessDeniedException) &#123;Authentication authentication = SecurityContextHolder.getContext().getAuthentication();<span class="hljs-keyword">if</span> (authenticationTrustResolver.isAnonymous(authentication) || authenticationTrustResolver.isRememberMe(authentication)) &#123;logger.debug(<span class="hljs-string">"Access is denied (user is "</span> + (authenticationTrustResolver.isAnonymous(authentication) ? <span class="hljs-string">"anonymous"</span> : <span class="hljs-string">"not fully authenticated"</span>) + <span class="hljs-string">"); redirecting to authentication entry point"</span>,exception);sendStartAuthentication(request,response,chain,<span class="hljs-keyword">new</span> InsufficientAuthenticationException(<span class="hljs-string">"Full authentication is required to access this resource"</span>));&#125;<span class="hljs-keyword">else</span> &#123;logger.debug(<span class="hljs-string">"Access is denied (user is not anonymous); delegating to AccessDeniedHandler"</span>,exception);accessDeniedHandler.handle(request, response,(AccessDeniedException) exception);&#125;&#125;</code></pre><p>è¿™é‡Œåˆ¤æ–­æ˜¯å¦æ˜¯åŒ¿åçš„èº«ä»½é‚£å°±æ˜¯å› ä¸ºæ²¡æœ‰ç™»å½•ï¼ˆèº«ä»½è®¤è¯ï¼‰æ‰€ä»¥è®¿é—®è¢«æ‹’æ¥äº†ï¼Œè¿™é‡Œä¼šè°ƒç”¨sendStartAuthenticationæŠŠä½ å‘é€å‡ºå»ï¼Œè®©ä½ å¼€å§‹iè¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¦‚æœä¸æ˜¯ä»¥ä¸ºåŒ¿åèº«ä»½è®¿é—®è¢«æ‹’ç»äº†ï¼Œä¼šæ‰§è¡Œæ¥å¤„ç†</p><pre><code class="hljs java">accessDeniedHandler.handle(request, response,(AccessDeniedException) exception);</code></pre><p>org.springframework.security.web.access.AccessDeniedHandlerImpl#handle</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568557636405.png" srcset="/img/loading.gif" alt="1568557636405"></p><p>è¿™ä¸ªå¤„ç†å™¨ä¼šå“åº”403ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯å› ä¸ºè¢«åŒ¿åè¿™ä¸ªèº«ä»½è¢«æ‹’ç»çš„ï¼Œæ‰€ä»¥ä¼šè¿›åˆ°è¿™é‡Œ</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendStartAuthentication</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">HttpServletResponse response, FilterChain chain,</span></span><span class="hljs-function"><span class="hljs-params">AuthenticationException reason)</span> <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;<span class="hljs-comment">// SEC-112: Clear the SecurityContextHolder's Authentication, as the</span><span class="hljs-comment">// existing Authentication is no longer considered valid</span>SecurityContextHolder.getContext().setAuthentication(<span class="hljs-keyword">null</span>);requestCache.saveRequest(request, response);logger.debug(<span class="hljs-string">"Calling Authentication entry point."</span>);authenticationEntryPoint.commence(request, response, reason);&#125;</code></pre><p>è¿™é‡Œå°±ä¼šæŠŠç”¨æˆ·å‘å‡ºå»è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒåˆ°ç™»å½•é¡µé¢ä¸Šå»</p><hr><p>è®¿é—®é€šè¿‡æµç¨‹ï¼š</p><blockquote><p>â€¦.</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ å…­ã€RBAC ã€‘ 1.Spring Securityæˆæƒç®€ä»‹</title>
    <link href="/spring-security-6.1.html"/>
    <url>/spring-security-6.1.html</url>
    
    <content type="html"><![CDATA[<h1 id="æˆæƒæ¦‚å¿µ"><a href="#æˆæƒæ¦‚å¿µ" class="headerlink" title="æˆæƒæ¦‚å¿µ"></a>æˆæƒæ¦‚å¿µ</h1><p>æƒé™ç³»ç»Ÿé€šå¸¸è¦è§£å†³è®¤è¯å’Œæˆæƒ</p><p>è®¤è¯ï¼Œå³åœ¨åº”ç”¨ä¸­è°èƒ½è¯æ˜ä»–å°±æ˜¯ä»–æœ¬äººã€‚ä¸€èˆ¬æä¾›å¦‚ä»–ä»¬çš„èº«ä»½IDä¸€äº›æ ‡è¯†ä¿¡æ¯æ¥è¡¨æ˜ä»–å°±æ˜¯ä»–æœ¬äººï¼Œå¦‚æä¾›èº«ä»½è¯ï¼Œç”¨æˆ·å/å¯†ç æ¥è¯æ˜ã€‚<br>æˆæƒï¼Œä¹Ÿå«è®¿é—®æ§åˆ¶ï¼Œå³åœ¨åº”ç”¨ä¸­æ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºï¼ˆå¦‚è®¿é—®é¡µé¢/ç¼–è¾‘æ•°æ®/é¡µé¢æ“ä½œç­‰ï¼‰ã€‚<br>å‰é¢æˆ‘ä»¬åˆ†æçš„éƒ½æ˜¯è®¤è¯ï¼Œå³ä½ æ˜¯è°é—®é¢˜ï¼Ÿ</p><p>è¿™ç¯‡æˆ‘ä»¬æ¥åˆ†æä½ èƒ½åšä»€ä¹ˆçš„é—®é¢˜ã€‚</p><h1 id="æˆæƒåˆ†æ"><a href="#æˆæƒåˆ†æ" class="headerlink" title="æˆæƒåˆ†æ"></a>æˆæƒåˆ†æ</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/2019050520550057.png" srcset="/img/loading.gif" alt=""></p><p>æƒé™æ˜¯æŸä¸ªèµ„æºèƒ½å¦æ¯ç”¨æˆ·è®¿é—®ï¼Œè€Œå¹¶ä¸æ˜¯èƒ½å¦æ˜¾ç¤ºçš„é—®é¢˜ã€‚</p><h1 id="æƒé™åœºæ™¯"><a href="#æƒé™åœºæ™¯" class="headerlink" title="æƒé™åœºæ™¯"></a>æƒé™åœºæ™¯</h1><p>é€šå¸¸å…¬å¸çš„ç³»ç»Ÿåˆ†å¯¹å¤–ç³»ç»Ÿ æƒé™åœºæ™¯æ¯”è¾ƒç®€å•ï¼Œè€Œå†…éƒ¨ç®¡ç†ç³»ç»Ÿæƒé™åœºæ™¯æ¯”è¾ƒå¤æ‚ï¼ˆä¸šåŠ¡åŠéœ€æ±‚ç»å¸¸å˜åŠ¨ï¼‰</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/20190505205813292.png" srcset="/img/loading.gif" alt=""></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/20190505205850305.png" srcset="/img/loading.gif" alt=""></p><h1 id="æƒé™æ§åˆ¶"><a href="#æƒé™æ§åˆ¶" class="headerlink" title="æƒé™æ§åˆ¶"></a>æƒé™æ§åˆ¶</h1><p>æƒé™æ§åˆ¶æ˜¯åŸºäºç”¨æˆ·-è§’è‰²-æƒé™è¿™å¥—ä½“ç³»ï¼Œè¿™ä¸ªæˆ‘åœ¨åé¢è¯¦ç»†ä»‹ç»ã€‚å…¶å®æˆ‘ä»¬å‰é¢çš„æµè§ˆå™¨é¡¹ç›®å·²ç»æœ‰æƒé™æ§åˆ¶äº†æˆ‘ä»¬å†æ¥çœ‹ä¸‹</p><p>com.b4.mcr.auth.browser.BrowserSecurityConfig#configure</p><pre><code class="hljs java">.antMatchers(                       <span class="hljs-string">"/session/invalid"</span>,                       browser.getRegistUrl(),                       browser.getLoginUrl(),                       browser.getSignUpUrl(),                       SecurityConstants.DEFAULT_UNAUTHENTICATED_URL,                       SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="hljs-string">"/*"</span>               )               .permitAll()               .antMatchers(<span class="hljs-string">"/user/**"</span>).hasRole(<span class="hljs-string">"ADMIN"</span>)</code></pre><p>ç„¶ååœ¨demoæ¨¡å—ä¸­ä¾èµ–ä¸browseræ¨¡å—</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-browser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><p>åœ¨ç™»å½•é¡µé¢è¿›è¡Œç™»å½•ä¹‹åè®¿é—®ï¼š<a href="http://www.pinzhi365.com/user/me" target="_blank" rel="noopener">http://www.pinzhi365.com/user/me</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1568550118535.png" srcset="/img/loading.gif" alt="1568550118535"></p><p>é¡µé¢ä¼šå“åº”403ï¼Œè¿™é‡Œçš„æ„æ€æ˜¯æ²¡æœ‰æƒé™ï¼Œè¿™é‡Œæ˜¯å› ä¸ºåœ¨ä¹‹å‰å†™çš„McrUserDetailsServiceç±»ä¸­ç»™ç”¨æˆ·çš„è§’è‰²ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> SocialUser <span class="hljs-title">buildUser</span><span class="hljs-params">(String username)</span> </span>&#123;        String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialUser(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin,ROLE_USER"</span>));    &#125;</code></pre><p>è¿™é‡Œæˆ‘åœ¨BrowserSecurityConfigä¸­è¦æ±‚è®¿é—®<code>/user/**</code>URLçš„è§’è‰²å«ADMINï¼Œæ‰€ä»¥é¡µé¢403äº†ï¼Œåœ¨è¿™é‡Œä¿®æ”¹ä¸€ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> SocialUser <span class="hljs-title">buildUser</span><span class="hljs-params">(String username)</span> </span>&#123;     String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialUser(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin,ROLE_USER,ROLE_ADMIN"</span>)); &#125;</code></pre><p>è¿™é‡Œæ³¨æ„ï¼Œå‰é¢è¦åŠ ä¸ŠROLE_ï¼Œç„¶åå†å»è®¿é—®<a href="http://www.pinzhi365.com/user/meè¿™ä¸ªURLæ˜¯èƒ½æ­£å¸¸è®¿é—®äº†" target="_blank" rel="noopener">http://www.pinzhi365.com/user/meè¿™ä¸ªURLæ˜¯èƒ½æ­£å¸¸è®¿é—®äº†</a></p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 9.åŸºäºJWTå®ç°SSOå•ç‚¹ç™»å½•</title>
    <link href="/spring-security-5.9.html"/>
    <url>/spring-security-5.9.html</url>
    
    <content type="html"><![CDATA[<p>ä»€ä¹ˆæ˜¯å•ç‚¹ç™»å½•ï¼Ÿè¯·çœ‹ä¸‹é¢è¿™ç¯‡æ–‡ç« </p><blockquote><p><a href="http://www.cnblogs.com/ywlaker/p/6113927.html" target="_blank" rel="noopener">å•ç‚¹ç™»å½•ä¸ç®€å•å®ç°</a></p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567946533501.png" srcset="/img/loading.gif" alt="1567946533501"></p><p>ç°åœ¨æœ‰è¿™ä¹ˆä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼šç°åœ¨æœ‰Aç½‘ç«™å’ŒBç½‘ç«™ï¼Œç”¨æˆ·åœ¨ç™»å½•äº†Aç½‘ç«™ï¼Œç„¶åç”¨æˆ·å†è®¿é—®Bç½‘ç«™æ—¶å€™å°±ä¸ç”¨ç™»å½•äº†ï¼Œç¬”è€…åœ¨è¿™é‡Œä»¥é˜¿é‡Œçš„æ·˜å®ã€å¤©çŒ«ç½‘ç«™ä¸ºä¾‹ï¼š</p><p>ç°åœ¨æˆ‘æµæµªè¿™2ä¸ªç½‘ç«™ï¼Œéƒ½æ˜¯æœªç™»å½•çŠ¶æ€çš„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567949712176.png" srcset="/img/loading.gif" alt="1567949712176"></p><p>åœ¨è¿™é‡Œæˆ‘å…ˆç™»å½•å¤©çŒ«ï¼Œç„¶ååˆ°æ·˜å®ä¸Šåˆ·æ–°çš„æ—¶å€™ï¼Œå°±å·²ç»æ˜¯ç™»å½•çŠ¶æ€äº†ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿™ä¸ªå°±æ˜¯å•ç‚¹ç™»å½•</p><hr><p>ä»¥ä¸Šé¢æµç¨‹å›¾ä¸ºä¾‹ï¼Œæ¥ä»‹ç»ä¸€ä¸‹å·¥ä½œæµç¨‹ï¼š</p><ol><li>å½“è¯·æ±‚å‘ç»™åº”ç”¨Aæ—¶ï¼Œå¦‚æœè¿™ä¸ªè¯·æ±‚éœ€è¦ç™»å½•ä»¥åæ‰èƒ½è®¿é—®ï¼ŒAä¼šå‘è®¤è¯æœåŠ¡å™¨æ¥è¯·æ±‚æˆæƒï¼Œè¿™æ—¶å€™ï¼Œä¼šå°†å®¢æˆ·ç«¯æµè§ˆå™¨å¼•å¯¼åˆ°è®¤è¯æœåŠ¡å™¨ä¸Šå»æˆæƒï¼Œ</li><li>ç”¨æˆ·æˆæƒä¹‹å</li><li>è®¤è¯æœåŠ¡å™¨è¿”å›æˆæƒç ç»™åº”ç”¨A</li><li>åº”ç”¨Aæ‹¿ç€æˆæƒç è¯·æ±‚ä»¤ç‰Œ</li><li>è®¤è¯æœåŠ¡å™¨è¿”å›ç»™åº”ç”¨A JWT</li><li>åº”ç”¨Aè§£æJWTçš„ä¿¡æ¯åšä¸€ä¸ªç™»å½•ï¼Œè¿™æ—¶å€™ç”¨æˆ·å°±åœ¨åº”ç”¨Aä¸Šç™»å½•äº†</li><li>å½“ç”¨æˆ·åœ¨åº”ç”¨Aå®Œæˆç™»å½•ä»¥åï¼Œä»–å»è®¿é—®äº†åº”ç”¨B</li><li>å¯¹äºåº”ç”¨Bæ¥è¯´ï¼Œç”¨æˆ·æ˜¯ä¸€ä¸ªæœªæˆæƒçš„çŠ¶æ€ï¼Œå®ƒä¹Ÿä¸€æ ·ä¼šè¯·æ±‚è®¤è¯æœåŠ¡å™¨ç»™è¿™ä¸ªç”¨æˆ·æˆæƒï¼Œè®©ç”¨æˆ·èƒ½å»è®¿é—®åº”ç”¨Bï¼Œè¿™ä¸ªæ—¶å€™ç”¨æˆ·ä¼šå†ä¸€æ¬¡åšæˆæƒï¼Œä½†æ˜¯ä»–ä¸ç”¨åœ¨ç™»å½•äº†ï¼Œè¯·æ±‚è¿™ä¸ªæˆæƒï¼Œåº”ç”¨Aå’Œåº”ç”¨Bæ˜¯åœ¨åŒä¸€ä¸ªè®¤è¯æœåŠ¡ä¸Šå®Œæˆçš„ï¼Œè€Œè¿™ä¸ªç”¨æˆ·ä¹‹å‰è¿™ä¸ªè®¤è¯æœåŠ¡å™¨ä¸Šæ˜¯ä¸€ä¸ªæˆæƒçŠ¶æ€ï¼Œé‚£ä¹ˆé€šè¿‡æµè§ˆå™¨è·³åˆ°åº”ç”¨Bçš„æ—¶å€™ï¼Œè®¤è¯æœåŠ¡å™¨æ˜¯çŸ¥é“å½“å‰ç”¨æˆ·æ˜¯è°çš„ï¼Œé‚£ä¹ˆå®ƒåªæ˜¯ä¼šè¦æ±‚ç”¨æˆ·å»æˆæƒï¼šä½ å¯ä»¥ç”¨åœ¨æˆ‘è¿™å·²ç™»å½•çš„ä¿¡æ¯å»è®¿é—®åº”ç”¨Bï¼Œ</li><li>åé¢çš„æµç¨‹å’Œ1-6æ˜¯ä¸€æ ·çš„ï¼Œèµ°ä¸€ä¸ªOAuthæµç¨‹</li><li>èµ°å®ŒOAuthä»¥åè®¤è¯æœåŠ¡å™¨ä¼šç»™åº”ç”¨Bä¸€ä¸ªJWTï¼Œè¿™é‡Œçš„JWTä¸åº”ç”¨Açš„JWTæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ä¸ªtokenå­—ç¬¦ä¸²æ˜¯ä¸ä¸€æ ·çš„ï¼Œä½†æ˜¯é€šè¿‡å­—ç¬¦ä¸²è§£æå‡ºæ¥çš„ä¿¡æ¯æ˜¯ä¸€æ ·çš„ï¼Œåº”ç”¨Bæ‹¿åˆ°JWTä¹‹åï¼Œå®ƒè‡ªå·±åšå®ƒçš„è§£æï¼Œå®ƒä¼šè§£æå‡ºä¸€ä¸ªä¸åº”ç”¨Aè§£æä¸€æ ·çš„ç”¨æˆ·ä¿¡æ¯å‡ºæ¥ï¼Œæ¥ç€ç”¨æˆ·ä¿¡æ¯å»æ„å»ºå®ƒçš„Authenticationï¼Œæ”¾åˆ°SecurityContexté‡Œå®Œæˆå®ƒåœ¨åº”ç”¨Bçš„æˆæƒï¼Œæœ€ç»ˆç»“æœæ˜¯åº”ç”¨Aã€Bçš„sessioné‡Œé¢éƒ½æœ‰ä¸€ä¸ªJWTè§£æå‡ºæ¥çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè®¤è¯æœåŠ¡å™¨ç»™çš„JWTä¸ä¸€æ ·ï¼Œä½†æ˜¯è§£æå‡ºæ¥çš„å†…å®¹æ˜¯ä¸€æ ·çš„</li><li>â€¦</li><li>ä½¿ç”¨JWTè¿”å›èµ„æºæœåŠ¡å™¨</li></ol><hr><p>ç¬”è€…åœ¨è¿™é‡Œä¼šé‡å†™åˆ›å»ºä¸€ä¸ªå­pomæ¨¡å—ï¼Œåœ¨è¿™ä¸ªpomæ¨¡å—åä¸ºmcr-auth-sso,å®ƒæœ‰3ä¸ªå­æ¨¡å—ï¼š</p><ol><li>mcr-auth-sso-serverï¼šè®¤è¯æœåŠ¡å™¨</li><li>mcrâ€“auth-sso-client1ï¼šåº”ç”¨A</li><li>mcrâ€“auth-sso-client2ï¼šåº”ç”¨B</li></ol><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567947011810.png" srcset="/img/loading.gif" alt="1567947011810"></p><p>mcr-auth-sso-serverçš„pom.xml</p><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-sso<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mcr-auth-sso-server<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mcr-auth-sso-client1<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mcr-auth-sso-client2<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security.oauth<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.security<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-security-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></code></pre><p>mcr-auth-sso-serverçš„å¯åŠ¨ç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<span class="hljs-meta">@SpringBootApplication</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthSsoServerApplication</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        SpringApplication.run(McrAuthSsoServerApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;    &#125;&#125;</code></pre><p>è®¤è¯æœåŠ¡å™¨çš„ç›¸å…³é…ç½®</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SsoAuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        clients.inMemory()                .withClient(<span class="hljs-string">"client1"</span>)                .secret(<span class="hljs-string">"client1"</span>)                .authorizedGrantTypes(<span class="hljs-string">"authorization_code"</span>, <span class="hljs-string">"refresh_token"</span>)                .scopes(<span class="hljs-string">"all"</span>)                .and()                .withClient(<span class="hljs-string">"client2"</span>)                .secret(<span class="hljs-string">"client2"</span>)                .authorizedGrantTypes(<span class="hljs-string">"authorization_code"</span>, <span class="hljs-string">"refresh_token"</span>)                .scopes(<span class="hljs-string">"all"</span>);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        endpoints.tokenStore(jwtTokenStore()).accessTokenConverter(jwtAccessTokenConverter());    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerSecurityConfigurer security)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        security.tokenKeyAccess(<span class="hljs-string">"isAuthenticated()"</span>);        <span class="hljs-comment">//isAuthenticated()æ˜¯spring securityçš„æˆæƒè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„æ„æ€ï¼šåº”ç”¨è®¿é—®/oauth/tokençš„æ—¶å€™ï¼Œ</span>        <span class="hljs-comment">// éœ€è¦å…ˆç»è¿‡èº«ä»½è®¤è¯ï¼Œä¸ºä»€ä¹ˆéœ€è¦è®¿é—®/oauth/check_tokenï¼Œå› ä¸ºåœ¨å‰é¢ä»‹ç»æµç¨‹çš„åœºæ™¯ä¸­ç¬¬5æ­¥è®¤è¯æœåŠ¡å™¨å‘ç»™åº”ç”¨JWTï¼Œåœ¨ç”ŸæˆJWTï¼Œåœ¨è¿™é‡Œç”±äºé…ç½®äº†ç§˜é’¥å»ç­¾åï¼Œé‚£ä¹ˆç”¨æˆ·æ‹¿åˆ°JWTçš„æ—¶å€™å®ƒè¦è§£æé‡Œé¢çš„ä¸œè¥¿ï¼Œå®ƒè¦</span>        <span class="hljs-comment">//éªŒç­¾åï¼Œç°åœ¨åº”ç”¨Aå°±éœ€è¦çŸ¥é“ç­¾åç”¨çš„ç§˜é’¥æ˜¯ä»€ä¹ˆï¼Œä¸€ä¼šåœ¨clientç«¯ä¼šé…ç½®é€šè¿‡ä»€ä¹ˆæ ·çš„è·¯å¾„ï¼Œclientå¯ä»¥åˆ°è®¤è¯æœåŠ¡å™¨å»æ‹¿è§£æJWTçš„ç§˜é’¥ï¼Œ</span>        <span class="hljs-comment">// ç°åœ¨å½“åº”ç”¨Aè®¿é—®/oauth/check_tokençš„æ—¶å€™,è¿™é‡Œå°±é™åˆ¶äº†å®ƒè¦ç»è¿‡èº«ä»½è®¤è¯æ‰èƒ½è®¿é—®è¿™ä¸ªåœ°å€ï¼Œ</span>        <span class="hljs-comment">//```java  private String tokenKeyAccess = "denyAll()";```è¿™é‡Œé»˜è®¤æ˜¯æ‹’ç»æ‰€æœ‰è®¿é—®</span>    &#125;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">jwtTokenStore</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());    &#125;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;        JwtAccessTokenConverter converter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();        converter.setSigningKey(<span class="hljs-string">"mcr"</span>);<span class="hljs-comment">//ç§˜é’¥</span>        <span class="hljs-keyword">return</span> converter;    &#125;&#125;</code></pre><p>yml</p><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">9999</span>  <span class="hljs-attr">context-path:</span> <span class="hljs-string">/server</span><span class="hljs-attr">security:</span>  <span class="hljs-attr">user:</span>    <span class="hljs-attr">name:</span> <span class="hljs-string">user</span>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span></code></pre><p>mcr-auth-sso-clien1çš„å¯åŠ¨ç±»ã€rest api</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.client1;<span class="hljs-meta">@SpringBootApplication</span><span class="hljs-meta">@RestController</span><span class="hljs-meta">@EnableOAuth</span>2Sso<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthClient1Application</span> </span>&#123;    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/user"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getUser</span><span class="hljs-params">(Authentication user)</span> </span>&#123;        <span class="hljs-keyword">return</span> user;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        SpringApplication.run(McrAuthClient1Application<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;    &#125;&#125;</code></pre><p>yml</p><pre><code class="hljs yml"><span class="hljs-attr">security:</span>  <span class="hljs-attr">oauth2:</span>    <span class="hljs-attr">client:</span>      <span class="hljs-attr">clientId:</span> <span class="hljs-string">client1</span>      <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">client1</span>      <span class="hljs-attr">user-authorization-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/authorize</span>      <span class="hljs-attr">access-token-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/token</span>    <span class="hljs-attr">resource:</span>      <span class="hljs-attr">jwt:</span>        <span class="hljs-attr">key-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/token_key</span>      <span class="hljs-attr">user-info-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/user</span>      <span class="hljs-attr">token-info-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/check_token</span><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>  <span class="hljs-attr">context-path:</span> <span class="hljs-string">/client1</span></code></pre><p>resources/resources/index.html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SSO Client1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>SSO Demo Client1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://localhost:8060/client2/index.html"</span>&gt;</span>è®¿é—®Client2<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>mcr-auth-sso-client2å’Œmcr-auth-sso-client1çš„ä»£ç æ˜¯å·®ä¸å¤šçš„ï¼Œè¿™é‡ŒæŠŠä¸åŒçš„åœ°æ–¹åˆ—å‡ºæ¥</p><p>yml</p><pre><code class="hljs yml"><span class="hljs-attr">security:</span>  <span class="hljs-attr">oauth2:</span>    <span class="hljs-attr">client:</span>      <span class="hljs-attr">clientId:</span> <span class="hljs-string">client2</span>      <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">client2</span>      <span class="hljs-attr">user-authorization-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/authorize</span>      <span class="hljs-attr">access-token-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/token</span>    <span class="hljs-attr">resource:</span>      <span class="hljs-attr">jwt:</span>        <span class="hljs-attr">key-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/token_key</span>      <span class="hljs-attr">user-info-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/user</span>      <span class="hljs-attr">token-info-uri:</span> <span class="hljs-string">http://127.0.0.1:9999/server/oauth/check_token</span>      <span class="hljs-attr">preferTokenInfo:</span> <span class="hljs-literal">false</span><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">8060</span>  <span class="hljs-attr">context-path:</span> <span class="hljs-string">/client2</span></code></pre><p>html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>SSO Client1<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>SSO Demo Client1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"http://localhost:8080/client1/index.html"</span>&gt;</span>è®¿é—®Client2<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><hr><p>ç°åœ¨è®¿é—®client1ï¼Œä¼šè·³è½¬åˆ°è®¤è¯æœåŠ¡å™¨ä¸Šå¼¹å‡ºä¸€ä¸ªç”¨æˆ·å¯†ç çš„è¡¨å•ï¼Œç™»å½•å®Œæˆä»¥åä¼šè·³è½¬åˆ°è®¤è¯æœåŠ¡å™¨ä¸Šæ˜¾ç¤ºè¿™æ ·çš„é¡µé¢</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567953316166.png" srcset="/img/loading.gif" alt="1567953316166"></p><p>è¿™é‡Œé€‰æ‹©æˆæƒæŒ‰é’®ï¼Œä¹‹åå°±èƒ½è®¿é—®clien1çš„indexé¡µé¢äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567953377669.png" srcset="/img/loading.gif" alt="1567953377669"></p><p>ç°åœ¨ç‚¹å‡»è¿™ä¸ªAé“¾æ¥ï¼Œä¹Ÿå°±æ˜¯è¦è·³è½¬åˆ°client2ï¼Œè¿™ä¸ªæ—¶å€™ä¼šç›´æ¥åˆ°è®¤è¯æœåŠ¡å™¨ä¸­æ˜¾ç¤ºè¿™æ ·çš„é¡µé¢</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567953427420.png" srcset="/img/loading.gif" alt="1567953427420"></p><p>åœ¨è¿™é‡Œclient2å¹¶æ²¡æœ‰åƒä¹‹å‰é‚£æ ·è¦æ±‚éœ€è¦ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œè€Œæ˜¯ç›´æ¥è·³è½¬åˆ°äº†è®¤è¯æœåŠ¡å™¨ï¼Œä»¥ä¸Šå°±å®ç°äº†å‰é¢æ‰€è¯´çš„ä¸šåŠ¡åœºæ™¯</p><hr><p>å‰é¢æ¼”ç¤ºçš„æµç¨‹ä¸­ï¼Œæœ€æ ¸å¿ƒçš„åŠŸèƒ½å·²ç»å®ç°äº†ï¼šåªéœ€è¦ç™»å½•ä¸€æ¬¡ï¼ŒåŒæ—¶è®¿é—®åº”ç”¨Aã€Bï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æœ‰è®©ç¬”è€…ä¸çˆ½çš„åœ°æ–¹ï¼šåœ¨è®¤è¯æœåŠ¡å™¨ä¸Šç™»å½•çš„æ—¶å€™ï¼Œæ˜¯ä¸€ä¸ªhttp basicçš„å¼¹æ¡†è®©ç”¨æˆ·å»è¾“å…¥ç”¨æˆ·åå¯†ç ï¼Œè¿™é‡Œè‚¯å®šæ˜¯éœ€è¦å±•ç¤ºä¸€ä¸ªæ¼‚äº®çš„ç™»å½•é¡µé¢ï¼Œå¦å¤–å°±æ˜¯åœ¨ç¬¬ä¸€æ¬¡è®¿é—®åº”ç”¨Aæˆ–Bå®ƒéƒ½ä¼šè®©æˆ‘åšä¸€ä¸ªæˆæƒï¼Œæˆ‘è¦ç‚¹ä¸€ä¸‹æˆæƒæŒ‰é’®ï¼Œä½†æ˜¯åœ¨æˆ‘è‡ªå·±ä¸¤ä¸ªç½‘ç«™ä¸Šæ˜¯ä¸éœ€è¦æˆæƒçš„ï¼Œä½ åªè¦ç™»å½•å°±æ˜¯äº†ï¼Œä¸‹é¢å°±æ¥ç»†åŒ–è¿™ä¸ªåœºæ™¯</p><hr><p>è¡¨å•ç™»å½•</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http.formLogin()                .and()                .authorizeRequests()                .anyRequest()                .authenticated();    &#125;&#125;</code></pre><hr><p>ç”¨æ•°æ®åº“é‡Œçš„è´¦å·å¯†ç åšè®¤è¯</p><p>SecurityConfig</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();&#125;</code></pre><p>UserDetailsServiceå®ç°</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SSoUserDetailsServices</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        String password = passwordEncoder.encode(<span class="hljs-string">"123456"</span>);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username, password, AuthorityUtils                .commaSeparatedStringToAuthorityList(<span class="hljs-string">"ROLE_USER"</span>));    &#125;&#125;</code></pre><hr><p>å–æ¶ˆæˆæƒè¿™ä¸€æ­¥æ“ä½œ</p><blockquote><p>åœ¨spring oauthä¸­è¿™ä¸€æ­¥æ˜¯ä¸èƒ½å»æ‰çš„ï¼Œä½†æ˜¯å¯ä»¥ç”¨ä¸€äº›éªšæ“ä½œå»ä¿®æ”¹ï¼Œè¿™é‡Œéœ€è¦ä»æºç ä¸­æ‰¾åˆ°é‚£ä¸ªæˆæƒé¡µé¢æ˜¯åœ¨å“ªé‡Œç”Ÿæˆå‡ºæ¥çš„ï¼Œç„¶åæ”¹ä¸€ä¸‹è¿™ä¸ªé¡µé¢ï¼Œå·²è¿›å…¥è¿™ä¸ªé¡µé¢è‡ªåŠ¨ç»™å®ƒæˆæƒæäº¤æ‰</p></blockquote><p>WhitelabelApprovalEndpointï¼Œè¿™ä¸ªç±»å°±æ˜¯ç”Ÿæˆæˆæƒé¡µé¢çš„ç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.security.oauth2.provider.endpoint;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.SessionAttributes;<span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Controller for displaying the approval page for the authorization server.</span><span class="hljs-comment"> * </span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Dave Syer</span><span class="hljs-comment"> */</span><span class="hljs-meta">@FrameworkEndpoint</span><span class="hljs-meta">@SessionAttributes</span>(<span class="hljs-string">"authorizationRequest"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WhitelabelApprovalEndpoint</span> </span>&#123;<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/oauth/confirm_access"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">getAccessConfirmation</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;String template = createTemplate(model, request);<span class="hljs-keyword">if</span> (request.getAttribute(<span class="hljs-string">"_csrf"</span>) != <span class="hljs-keyword">null</span>) &#123;model.put(<span class="hljs-string">"_csrf"</span>, request.getAttribute(<span class="hljs-string">"_csrf"</span>));&#125;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ModelAndView(<span class="hljs-keyword">new</span> SpelView(template), model);&#125;<span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">createTemplate</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;String template = TEMPLATE;<span class="hljs-keyword">if</span> (model.containsKey(<span class="hljs-string">"scopes"</span>) || request.getAttribute(<span class="hljs-string">"scopes"</span>) != <span class="hljs-keyword">null</span>) &#123;template = template.replace(<span class="hljs-string">"%scopes%"</span>, createScopes(model, request)).replace(<span class="hljs-string">"%denial%"</span>, <span class="hljs-string">""</span>);&#125;<span class="hljs-keyword">else</span> &#123;template = template.replace(<span class="hljs-string">"%scopes%"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"%denial%"</span>, DENIAL);&#125;<span class="hljs-keyword">if</span> (model.containsKey(<span class="hljs-string">"_csrf"</span>) || request.getAttribute(<span class="hljs-string">"_csrf"</span>) != <span class="hljs-keyword">null</span>) &#123;template = template.replace(<span class="hljs-string">"%csrf%"</span>, CSRF);&#125;<span class="hljs-keyword">else</span> &#123;template = template.replace(<span class="hljs-string">"%csrf%"</span>, <span class="hljs-string">""</span>);&#125;<span class="hljs-keyword">return</span> template;&#125;<span class="hljs-function"><span class="hljs-keyword">private</span> CharSequence <span class="hljs-title">createScopes</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"&lt;ul&gt;"</span>);<span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)Map&lt;String, String&gt; scopes = (Map&lt;String, String&gt;) (model.containsKey(<span class="hljs-string">"scopes"</span>) ? model.get(<span class="hljs-string">"scopes"</span>) : request.getAttribute(<span class="hljs-string">"scopes"</span>));<span class="hljs-keyword">for</span> (String scope : scopes.keySet()) &#123;String approved = <span class="hljs-string">"true"</span>.equals(scopes.get(scope)) ? <span class="hljs-string">" checked"</span> : <span class="hljs-string">""</span>;String denied = !<span class="hljs-string">"true"</span>.equals(scopes.get(scope)) ? <span class="hljs-string">" checked"</span> : <span class="hljs-string">""</span>;String value = SCOPE.replace(<span class="hljs-string">"%scope%"</span>, scope).replace(<span class="hljs-string">"%key%"</span>, scope).replace(<span class="hljs-string">"%approved%"</span>, approved).replace(<span class="hljs-string">"%denied%"</span>, denied);builder.append(value);&#125;builder.append(<span class="hljs-string">"&lt;/ul&gt;"</span>);<span class="hljs-keyword">return</span> builder.toString();&#125;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String CSRF = <span class="hljs-string">"&lt;input type='hidden' name='$&#123;_csrf.parameterName&#125;' value='$&#123;_csrf.token&#125;' /&gt;"</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String DENIAL = <span class="hljs-string">"&lt;form id='denialForm' name='denialForm' action='$&#123;path&#125;/oauth/authorize' method='post'&gt;&lt;input name='user_oauth_approval' value='false' type='hidden'/&gt;%csrf%&lt;label&gt;&lt;input name='deny' value='Deny' type='submit'/&gt;&lt;/label&gt;&lt;/form&gt;"</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String TEMPLATE = <span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;OAuth Approval&lt;/h1&gt;"</span>+ <span class="hljs-string">"&lt;p&gt;Do you authorize '$&#123;authorizationRequest.clientId&#125;' to access your protected resources?&lt;/p&gt;"</span>+ <span class="hljs-string">"&lt;form id='confirmationForm' name='confirmationForm' action='$&#123;path&#125;/oauth/authorize' method='post'&gt;&lt;input name='user_oauth_approval' value='true' type='hidden'/&gt;%csrf%%scopes%&lt;label&gt;&lt;input name='authorize' value='Authorize' type='submit'/&gt;&lt;/label&gt;&lt;/form&gt;"</span>+ <span class="hljs-string">"%denial%&lt;/body&gt;&lt;/html&gt;"</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String SCOPE = <span class="hljs-string">"&lt;li&gt;&lt;div class='form-group'&gt;%scope%: &lt;input type='radio' name='%key%'"</span>+ <span class="hljs-string">" value='true'%approved%&gt;Approve&lt;/input&gt; &lt;input type='radio' name='%key%' value='false'%denied%&gt;Deny&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;"</span>;&#125;</code></pre><p>è¿™ä¸ªç±»æ³¨è§£äº†ä¸€ä¸ª@FrameworkEndpointï¼Œè¿™ä¸ªå’Œ@RestControllerç›¸ä¼¼ï¼Œå¯ä»¥å»åœ¨æ–¹æ³•ä¸Šå†™@RequestMappingï¼Œæˆ‘ä»¬è¦åšçš„äº‹æƒ…å°±æ˜¯åŸæ ·å†™ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„ç±»ï¼Œä¸è¿‡ä¼šæ›¿æ¢æ‰@FrameworkEndpointæ”¹ä¸º@RestControllerï¼Œç”¨@RestControlleræ³¨è§£çš„ç±»ï¼Œå¦‚æœè·Ÿè¿™ä¸ª@RestControllerå£°æ˜äº†ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„@RequestMappingï¼Œspringåœ¨å¤„ç†çš„æ—¶å€™ä¼šä¼˜å…ˆä½¿ç”¨@RestControllerï¼Œè¿™æ ·å°±èƒ½æŠŠè¿™ä¸ªæˆæƒé¡µé¢çš„ä»£ç è¿›è¡Œä¿®æ”¹æˆæˆ‘ä»¬é¢„æœŸçš„æ•ˆæœäº†ï¼Œä¸è¿‡å®ƒè¿™é‡Œçš„getAccessConfirmationæ–¹æ³•ä½¿ç”¨äº†SpelViewç±»ï¼Œè¿™ä¸ªç±»æ˜¯ä¸€ä¸ªç§æœ‰çš„ï¼Œæ‰€ä»¥è¿™ä¸ªç±»ä¹Ÿè¦å¤åˆ¶åœ¨æˆ‘ä»¬è¿™é‡Œ</p><pre><code class="hljs java"><span class="hljs-comment">/*</span><span class="hljs-comment"> * Copyright 2013-2014 the original author or authors.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with</span><span class="hljs-comment"> * the License. You may obtain a copy of the License at</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on</span><span class="hljs-comment"> * an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the</span><span class="hljs-comment"> * specific language governing permissions and limitations under the License.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-keyword">import</span> java.util.HashMap;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> org.springframework.context.expression.MapAccessor;<span class="hljs-keyword">import</span> org.springframework.expression.Expression;<span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;<span class="hljs-keyword">import</span> org.springframework.expression.spel.support.StandardEvaluationContext;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.common.util.RandomValueStringGenerator;<span class="hljs-keyword">import</span> org.springframework.util.PropertyPlaceholderHelper;<span class="hljs-keyword">import</span> org.springframework.util.PropertyPlaceholderHelper.PlaceholderResolver;<span class="hljs-keyword">import</span> org.springframework.web.servlet.View;<span class="hljs-keyword">import</span> org.springframework.web.servlet.support.ServletUriComponentsBuilder;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Simple String template renderer.</span><span class="hljs-comment"> * </span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SsoSpelView</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">View</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String template;<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String prefix;<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> SpelExpressionParser parser = <span class="hljs-keyword">new</span> SpelExpressionParser();<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StandardEvaluationContext context = <span class="hljs-keyword">new</span> StandardEvaluationContext();<span class="hljs-keyword">private</span> PlaceholderResolver resolver;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SsoSpelView</span><span class="hljs-params">(String template)</span> </span>&#123;<span class="hljs-keyword">this</span>.template = template;<span class="hljs-keyword">this</span>.prefix = <span class="hljs-keyword">new</span> RandomValueStringGenerator().generate() + <span class="hljs-string">"&#123;"</span>;<span class="hljs-keyword">this</span>.context.addPropertyAccessor(<span class="hljs-keyword">new</span> MapAccessor());<span class="hljs-keyword">this</span>.resolver = <span class="hljs-keyword">new</span> PlaceholderResolver() &#123;<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">resolvePlaceholder</span><span class="hljs-params">(String name)</span> </span>&#123;Expression expression = parser.parseExpression(name);Object value = expression.getValue(context);<span class="hljs-keyword">return</span> value == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span> : value.toString();&#125;&#125;;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getContentType</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-string">"text/html"</span>;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">render</span><span class="hljs-params">(Map&lt;String, ?&gt; model, HttpServletRequest request, HttpServletResponse response)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> Exception </span>&#123;Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;String, Object&gt;(model);String path = ServletUriComponentsBuilder.fromContextPath(request).build().getPath();map.put(<span class="hljs-string">"path"</span>, (Object) path==<span class="hljs-keyword">null</span> ? <span class="hljs-string">""</span> : path);context.setRootObject(map);String maskedTemplate = template.replace(<span class="hljs-string">"$&#123;"</span>, prefix);PropertyPlaceholderHelper helper = <span class="hljs-keyword">new</span> PropertyPlaceholderHelper(prefix, <span class="hljs-string">"&#125;"</span>);String result = helper.replacePlaceholders(maskedTemplate, resolver);result = result.replace(prefix, <span class="hljs-string">"$&#123;"</span>);response.setContentType(getContentType());response.getWriter().append(result);&#125;&#125;</code></pre><p>WhitelabelApprovalEndpoint</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.sso.server;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.SessionAttributes;<span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@SessionAttributes</span>(<span class="hljs-string">"authorizationRequest"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SsoWhitelabelApprovalEndpoint</span> </span>&#123;    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/oauth/confirm_access"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">getAccessConfirmation</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        String template = createTemplate(model, request);        <span class="hljs-keyword">if</span> (request.getAttribute(<span class="hljs-string">"_csrf"</span>) != <span class="hljs-keyword">null</span>) &#123;            model.put(<span class="hljs-string">"_csrf"</span>, request.getAttribute(<span class="hljs-string">"_csrf"</span>));        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ModelAndView(<span class="hljs-keyword">new</span> SsoSpelView(template), model);    &#125;    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">createTemplate</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;        String template = TEMPLATE;        <span class="hljs-keyword">if</span> (model.containsKey(<span class="hljs-string">"scopes"</span>) || request.getAttribute(<span class="hljs-string">"scopes"</span>) != <span class="hljs-keyword">null</span>) &#123;            template = template.replace(<span class="hljs-string">"%scopes%"</span>, createScopes(model, request)).replace(<span class="hljs-string">"%denial%"</span>, <span class="hljs-string">""</span>);        &#125; <span class="hljs-keyword">else</span> &#123;            template = template.replace(<span class="hljs-string">"%scopes%"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"%denial%"</span>, DENIAL);        &#125;        <span class="hljs-keyword">if</span> (model.containsKey(<span class="hljs-string">"_csrf"</span>) || request.getAttribute(<span class="hljs-string">"_csrf"</span>) != <span class="hljs-keyword">null</span>) &#123;            template = template.replace(<span class="hljs-string">"%csrf%"</span>, CSRF);        &#125; <span class="hljs-keyword">else</span> &#123;            template = template.replace(<span class="hljs-string">"%csrf%"</span>, <span class="hljs-string">""</span>);        &#125;        <span class="hljs-keyword">return</span> template;    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> CharSequence <span class="hljs-title">createScopes</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request)</span> </span>&#123;        StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-string">"&lt;ul&gt;"</span>);        <span class="hljs-meta">@SuppressWarnings</span>(<span class="hljs-string">"unchecked"</span>)        Map&lt;String, String&gt; scopes = (Map&lt;String, String&gt;) (model.containsKey(<span class="hljs-string">"scopes"</span>) ? model.get(<span class="hljs-string">"scopes"</span>) : request                .getAttribute(<span class="hljs-string">"scopes"</span>));        <span class="hljs-keyword">for</span> (String scope : scopes.keySet()) &#123;            String approved = <span class="hljs-string">"true"</span>.equals(scopes.get(scope)) ? <span class="hljs-string">" checked"</span> : <span class="hljs-string">""</span>;            String denied = !<span class="hljs-string">"true"</span>.equals(scopes.get(scope)) ? <span class="hljs-string">" checked"</span> : <span class="hljs-string">""</span>;            String value = SCOPE.replace(<span class="hljs-string">"%scope%"</span>, scope).replace(<span class="hljs-string">"%key%"</span>, scope).replace(<span class="hljs-string">"%approved%"</span>, approved)                    .replace(<span class="hljs-string">"%denied%"</span>, denied);            builder.append(value);        &#125;        builder.append(<span class="hljs-string">"&lt;/ul&gt;"</span>);        <span class="hljs-keyword">return</span> builder.toString();    &#125;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String CSRF = <span class="hljs-string">"&lt;input type='hidden' name='$&#123;_csrf.parameterName&#125;' value='$&#123;_csrf.token&#125;' /&gt;"</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String DENIAL = <span class="hljs-string">"&lt;form id='denialForm' name='denialForm' action='$&#123;path&#125;/oauth/authorize' method='post'&gt;&lt;input name='user_oauth_approval' value='false' type='hidden'/&gt;%csrf%&lt;label&gt;&lt;input name='deny' value='Deny' type='submit'/&gt;&lt;/label&gt;&lt;/form&gt;"</span>;      <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String TEMPLATE = <span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;div style='display:none;'&gt;&lt;h1&gt;OAuth Approval&lt;/h1&gt;"</span>            + <span class="hljs-string">"&lt;p&gt;Do you authorize '$&#123;authorizationRequest.clientId&#125;' to access your protected resources?&lt;/p&gt;"</span>            + <span class="hljs-string">"&lt;form id='confirmationForm' name='confirmationForm' action='$&#123;path&#125;/oauth/authorize' method='post'&gt;&lt;input name='user_oauth_approval' value='true' type='hidden'/&gt;%csrf%%scopes%&lt;label&gt;&lt;input name='authorize' value='Authorize' type='submit'/&gt;&lt;/label&gt;&lt;/form&gt;"</span>            + <span class="hljs-string">"%denial%&lt;/div&gt;&lt;script&gt;document.getElementById('confirmationForm').submit()&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;"</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String SCOPE = <span class="hljs-string">"&lt;li&gt;&lt;div class='form-group'&gt;%scope%: &lt;input type='radio' name='%key%'"</span>            + <span class="hljs-string">" value='true'%approved%&gt;Approve&lt;/input&gt; &lt;input type='radio' name='%key%' value='false'%denied%&gt;Deny&lt;/input&gt;&lt;/div&gt;&lt;/li&gt;"</span>;&#125;</code></pre><p>ç°åœ¨å°±æ¥å®ç°ä¸€ä¸‹ä¸šåŠ¡éœ€æ±‚ï¼š</p><p>WhitelabelApprovalEndpoint</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String TEMPLATE = <span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;div style='display:none;'&gt;&lt;h1&gt;OAuth Approval&lt;/h1&gt;"</span>          + <span class="hljs-string">"&lt;p&gt;Do you authorize '$&#123;authorizationRequest.clientId&#125;' to access your protected resources?&lt;/p&gt;"</span>          + <span class="hljs-string">"&lt;form id='confirmationForm' name='confirmationForm' action='$&#123;path&#125;/oauth/authorize' method='post'&gt;&lt;input name='user_oauth_approval' value='true' type='hidden'/&gt;%csrf%%scopes%&lt;label&gt;&lt;input name='authorize' value='Authorize' type='submit'/&gt;&lt;/label&gt;&lt;/form&gt;"</span>          + <span class="hljs-string">"%denial%&lt;/div&gt;&lt;script&gt;document.getElementById('confirmationForm').submit()&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;"</span>;</code></pre><p>è¿™é‡ŒæŠŠè¿™ä¸ªé¡µé¢çš„å†…å®¹ç»™éšè—æ¥ï¼Œç„¶åç›´æ¥ç”¨jsç»™å®ƒè‡ªåŠ¨æäº¤å°±OKäº†</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 8.ä»¤ç‰Œé…ç½®</title>
    <link href="/spring-security-5.8.html"/>
    <url>/spring-security-5.8.html</url>
    
    <content type="html"><![CDATA[<p>å‰é¢ä¸ºæ­¢ï¼Œå°†è‡ªå®šä¹‰çš„3é‡è®¤è¯æ–¹å¼éƒ½å·²ç»å«æ¥åˆ°è®¤è¯æœåŠ¡å™¨ä¸Šäº†ï¼Œé€šè¿‡è‡ªå®šä¹‰çš„è®¤è¯æ–¹å¼æˆ‘ä»¬å¯ä»¥å‡ºå»å‘OAuthä»¤ç‰Œï¼Œç°åœ¨è¿™ä¸ªtokenå®ƒç°åœ¨å’Œç”Ÿæˆå’Œå­˜å‚¨éƒ½æ˜¯springé»˜è®¤çš„æœºåˆ¶æ¥åšçš„ï¼Œä½†æ˜¯è¿™ä¸ªé»˜è®¤çš„æœºåˆ¶å¹¶ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œåœ¨è¿™é‡Œç¬”è€…ä¼šå¸¦ç€å¤§å®¶æ¥å¦‚ä½•æ¥å®šåˆ¶tokenï¼Œå®šåˆ¶å®ƒçš„ç”Ÿæˆå’Œå­˜å‚¨</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567865190288.png" srcset="/img/loading.gif" alt="1567865190288"></p><p>ç°åœ¨è¦åšçš„äº‹æ˜¯tokençš„å¤„ç†ï¼Œtokençš„å¤„ç†æ˜¯åœ¨è®¤è¯æœåŠ¡å™¨å»å®Œæˆçš„ï¼Œæ‰€ä»¥è¿™é‡Œè¦åšçš„äº‹æƒ…</p><h1 id="åŸºæœ¬çš„Tokenå‚æ•°é…ç½®"><a href="#åŸºæœ¬çš„Tokenå‚æ•°é…ç½®" class="headerlink" title="åŸºæœ¬çš„Tokenå‚æ•°é…ç½®"></a>åŸºæœ¬çš„Tokenå‚æ•°é…ç½®</h1><p>ï¼ˆ1ï¼‰ä¿®æ”¹McrAuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthorizationServerConfig</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;    &#125;</code></pre><p>è¿™é‡Œçš„AuthorizationServerConfigurerAdapteræœ‰3ä¸ªconfigureæ–¹æ³•ï¼Œåˆ†åˆ«è¡¨ç¤ºå®‰å…¨ã€ç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯çš„é…ç½®ã€ç«¯ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567865473251.png" srcset="/img/loading.gif" alt="1567865473251"></p><p> McrAuthorizationServerConfigï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthorizationServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthorizationServerConfigurerAdapter</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationManager authenticationManager;    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å¯¹TokenEndpointçš„å±æ€§å’Œå¢å¼ºåŠŸèƒ½ã€‚</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        endpoints.authenticationManager(authenticationManager)                .userDetailsService(userDetailsService)        ;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·Ÿå®¢æˆ·ç«¯ç›¸å…³çš„é…ç½®ï¼Œè¿™é‡Œä¼šè¦†ç›–æ‰åœ¨ymlä¸­çš„ï¼š</span><span class="hljs-comment">     * security.oauth2.client.xxxçš„é…ç½®</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        clients                <span class="hljs-comment">/*mcr*/</span>                .inMemory()                .withClient(<span class="hljs-string">"mcr"</span>)                .secret(<span class="hljs-string">"mcr"</span>)                .accessTokenValiditySeconds(<span class="hljs-number">7200</span>)                <span class="hljs-comment">//å½“å‰withClientæŒ‡å®šçš„â€œmcrâ€è¿™ä¸ªåº”ç”¨æ‰€èƒ½æ”¯æŒçš„æˆæƒæ¨¡å¼æ˜¯å“ªäº›</span>                .authorizedGrantTypes(<span class="hljs-string">"refresh_token"</span>, <span class="hljs-string">"password"</span>)                <span class="hljs-comment">//å¦‚æœè¿™é‡Œå†™äº†ï¼Œå®¢æˆ·ç«¯åœ¨å‘è¯·æ±‚çš„æ—¶å€™å°±å¯ä»¥ä¸å¸¦scopeå‚æ•°ï¼Œå®ƒä¸å¸¦scopeå‚æ•°ä»¥åï¼Œå°±æ˜¯ä½¿ç”¨è¿™é‡Œé…ç½®çš„ï¼Œå¦‚æœè¯·æ±‚å¸¦äº†scopeï¼Œä¸€å®šè¦æ˜¯åœ¨é…ç½®çš„scopeä¹‹å†…ï¼Œå¦‚æœä¸åœ¨å°±ä¼šä¿å­˜</span>                .scopes(<span class="hljs-string">"all"</span>, <span class="hljs-string">"read"</span>, <span class="hljs-string">"write"</span>)        ;    &#125;&#125;</code></pre><p>æµ‹è¯•ä¸€ä¸‹ï¼Œè¿™é‡Œä»¥å¯†ç æ¨¡å¼ä¸ºä¾‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567866797638.png" srcset="/img/loading.gif" alt="1567866797638"></p><p>è¿™é‡Œä¸ä¼ é€’scopeï¼Œå°±ä½¿ç”¨äº†æˆ‘ä»¬è‡ªå·±é…çš„scoopeï¼Œè¿‡æœŸæ—¶é—´ä¹Ÿæ˜¯æˆ‘ä»¬è‡ªå·±é…çš„ï¼Œæ²¡æœ‰é—®é¢˜</p><p>ä½¿ç”¨ç®€åŒ–æ¨¡å¼ç™»å½•ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567866911929.png" srcset="/img/loading.gif" alt="1567866911929"></p><p>è¿™é‡Œç”±äºé…ç½®ä¸­ä¸åŒ…å«è¿™ä¸ªæ¨¡å¼ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°è¿™æ ·çš„ä¿¡æ¯</p><hr><p>æ”¯æŒå¤šä¸ªclientç«¯</p><p>McrAuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;       clients               <span class="hljs-comment">/*mcr*/</span>               .inMemory()               .withClient(<span class="hljs-string">"mcr"</span>)               .secret(<span class="hljs-string">"mcr"</span>)               .accessTokenValiditySeconds(<span class="hljs-number">7200</span>)               .authorizedGrantTypes(<span class="hljs-string">"refresh_token"</span>, <span class="hljs-string">"password"</span>)               .scopes(<span class="hljs-string">"all"</span>, <span class="hljs-string">"read"</span>, <span class="hljs-string">"write"</span>)               .and()               <span class="hljs-comment">/*xxx*/</span>               .inMemory()               .withClient(<span class="hljs-string">"mcr"</span>)               .secret(<span class="hljs-string">"mcr"</span>)               .accessTokenValiditySeconds(<span class="hljs-number">7200</span>)               .authorizedGrantTypes(<span class="hljs-string">"refresh_token"</span>, <span class="hljs-string">"password"</span>)               .scopes(<span class="hljs-string">"all"</span>, <span class="hljs-string">"read"</span>, <span class="hljs-string">"write"</span>)       ;   &#125;</code></pre><p>è¿™é‡Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯åšä¸€ä¸ªå¯é‡ç”¨çš„æ¨¡å—ï¼Œä¸Šé¢è¿™æ ·å†™æ˜¯ä¸èƒ½è®©ä½¿ç”¨è€…è¿›è¡Œä¿®æ”¹çš„ï¼Œè¿™é‡Œæ”¹ä¸ºå¯ä»¥è®©ä½¿ç”¨è€…è¿›è¡Œé…ç½®</p><p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªOAuth2ClientPropertiesç±»ï¼Œå°†ä¸Šé¢è¿™äº›ClientDetailsServiceConfigurerç±»çš„æ–¹æ³•ï¼Œåšä¸ºè¿™ä¸ªç±»çš„å‚æ•°</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-comment">/**</span><span class="hljs-comment"> * OAuth2å®¢æˆ·ç«¯é…ç½®</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OAuth2ClientProperties</span> </span>&#123;    <span class="hljs-keyword">private</span> String clientId;    <span class="hljs-keyword">private</span> String clientSecret;    <span class="hljs-keyword">private</span> String[] authorizedGrantTypes = &#123;&#125;;<span class="hljs-comment">//æˆæƒç±»å‹</span>    <span class="hljs-keyword">private</span> String[] redirectUris = &#123;&#125;; <span class="hljs-comment">// ä¿¡ä»»çš„å›è°ƒåŸŸ</span>    <span class="hljs-keyword">private</span> String[] scopes = &#123;&#125;;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> accessTokenValiditySeconds; <span class="hljs-comment">// tokenæœ‰æ•ˆæœŸ é»˜è®¤å•ä½ç§’</span>&#125;</code></pre><p>ç”±äºå¯ä»¥é…ç½®å¤šä¸ªï¼Œè¿™é‡Œçš„OAuth2Propertiesç±»ä¸­æœ‰ä¸€ä¸ªOAuth2ClientPropertiesæ•°ç»„ </p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-comment">/**</span><span class="hljs-comment"> * oauth2é…ç½®</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OAuth2Properties</span> </span>&#123;    <span class="hljs-keyword">private</span> OAuth2ClientProperties[] clients = &#123;&#125;;&#125;</code></pre><p>SecurityProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> OAuth2Properties oAuth2=<span class="hljs-keyword">new</span> OAuth2Properties();</code></pre><p>yml</p><pre><code class="hljs yml"><span class="hljs-comment">#security:</span><span class="hljs-comment">#  oauth2:</span><span class="hljs-comment">#    client:</span><span class="hljs-comment">#      client-id: mcr</span><span class="hljs-comment">#      client-secret: mcr</span><span class="hljs-attr">mcr:</span>  <span class="hljs-attr">b4:</span>    <span class="hljs-attr">security:</span>      <span class="hljs-attr">oAuth2:</span>        <span class="hljs-attr">clients:</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">clientId:</span> <span class="hljs-string">mcr</span>            <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">mcr</span>            <span class="hljs-attr">authorizedGrantTypes:</span> <span class="hljs-string">["refresh_token",</span> <span class="hljs-string">"password"</span><span class="hljs-string">]</span>            <span class="hljs-attr">scopes:</span> <span class="hljs-string">["all",</span> <span class="hljs-string">"read"</span><span class="hljs-string">]</span>            <span class="hljs-attr">accessTokenValiditySeconds:</span> <span class="hljs-number">7200</span>          <span class="hljs-bullet">-</span> <span class="hljs-attr">clientId:</span> <span class="hljs-string">test</span>            <span class="hljs-attr">clientSecret:</span> <span class="hljs-string">test</span>            <span class="hljs-attr">authorizedGrantTypes:</span> <span class="hljs-string">["refresh_token",</span> <span class="hljs-string">"password"</span><span class="hljs-string">]</span>            <span class="hljs-attr">scopes:</span> <span class="hljs-string">["all",</span> <span class="hljs-string">"read"</span><span class="hljs-string">]</span></code></pre><p>McrAuthorizationServerConfig#configure</p><pre><code class="hljs java">    <span class="hljs-keyword">private</span> SecurityProperties security; <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(ClientDetailsServiceConfigurer clients)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        OAuth2Properties oAuth2 = securityProperties.getOAuth2();        InMemoryClientDetailsServiceBuilder builder = clients.inMemory();        OAuth2ClientProperties[] oAuth2Clients = oAuth2.getClients();        <span class="hljs-keyword">if</span> (ArrayUtils.isNotEmpty(oAuth2.getClients())) &#123;            <span class="hljs-keyword">for</span> (OAuth2ClientProperties item : oAuth2Clients) &#123;                builder                        .withClient(item.getClientId())                        .secret(item.getClientSecret())                        .accessTokenValiditySeconds(item.getAccessTokenValiditySeconds())                        <span class="hljs-comment">//å½“å‰withClientæŒ‡å®šçš„â€œmcrâ€è¿™ä¸ªåº”ç”¨æ‰€èƒ½æ”¯æŒçš„æˆæƒæ¨¡å¼æ˜¯å“ªäº›</span>                        .authorizedGrantTypes(item.getAuthorizedGrantTypes())                        <span class="hljs-comment">//å¦‚æœè¿™é‡Œå†™äº†ï¼Œå®¢æˆ·ç«¯åœ¨å‘è¯·æ±‚çš„æ—¶å€™å°±å¯ä»¥ä¸å¸¦scopeå‚æ•°ï¼Œå®ƒä¸å¸¦scopeå‚æ•°ä»¥åï¼Œå°±æ˜¯ä½¿ç”¨è¿™é‡Œé…ç½®çš„ï¼Œå¦‚æœè¯·æ±‚å¸¦äº†scopeï¼Œä¸€å®šè¦æ˜¯åœ¨é…ç½®çš„scopeä¹‹å†…ï¼Œå¦‚æœä¸åœ¨å°±ä¼šä¿å­˜</span>                        .scopes(item.getScopes());                clients.setBuilder(builder);            &#125;        &#125;    &#125;</code></pre><p>ä½¿ç”¨mcrç™»å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567869976917.png" srcset="/img/loading.gif" alt="1567869976917"></p><p>ä½¿ç”¨testç™»å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567869997849.png" srcset="/img/loading.gif" alt="1567869997849"></p><p>è¿™é‡Œç”±äºæˆ‘æ²¡ç»™testç”¨æˆ·é…ç½®è¿‡æœŸæ—¶é—´ï¼Œæ‰€ä»¥0åœ¨è¿™é‡Œè¡¨ç¤ºæ°¸ä¸è¿‡æœŸï¼Œåœ¨å®é™…å¼€å‘ä¸­ä¸€å®šè¦ç»™é‚£ä¸ªè¿‡æœŸå±æ€§é…é»˜è®¤å€¼</p><hr><p>æ§åˆ¶ä»¤ç‰Œå­˜å‚¨</p><p>ç°åœ¨ä»¤ç‰Œæ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­çš„ï¼Œä¸€æ¡£æœåŠ¡é‡å¯ï¼Œå†…å­˜ä¸­å°±æ²¡æœ‰æ•°æ®äº†ï¼Œè¿™é‡Œå°†å­˜å‚¨æ”¹ä¸ºredisï¼Œä¹‹å‰ä»‹ç»è¿‡TokenStoreæ˜¯æ¥åšä»¤ç‰Œå­˜å‚¨çš„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567870398556.png" srcset="/img/loading.gif" alt="1567870398556"></p><p>TokenStoreæä¾›äº†å‡ ç§å®ç°ç±»ï¼Œè¿™é‡Œä½¿ç”¨RedisTokenSotre</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.data.redis.connection.RedisConnectionFactory;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.TokenStore;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.provider.token.store.redis.RedisTokenStore;<span class="hljs-keyword">import</span> javax.annotation.Resource;<span class="hljs-comment">/**</span><span class="hljs-comment"> * rediså­˜å‚¨token</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenStoreConfig</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> RedisConnectionFactory redisConnectionFactory;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">redisTokenStore</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RedisTokenStore(redisConnectionFactory);    &#125;&#125;</code></pre><p>McrAuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> TokenStore tokenStore;   <span class="hljs-comment">/**</span><span class="hljs-comment">    * å¯¹TokenEndpointçš„å±æ€§å’Œå¢å¼ºåŠŸèƒ½ã€‚</span><span class="hljs-comment">    */</span>   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;       endpoints.authenticationManager(authenticationManager)               .userDetailsService(userDetailsService)               .tokenStore(tokenStore)       ;   &#125;</code></pre><h1 id="ä½¿ç”¨JWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œ"><a href="#ä½¿ç”¨JWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œ" class="headerlink" title="ä½¿ç”¨JWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œ"></a>ä½¿ç”¨JWTæ›¿æ¢é»˜è®¤ä»¤ç‰Œ</h1><p>OAuth2Properties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> String jwtSignKey = <span class="hljs-string">"mcr"</span>;</code></pre><p>TokenStoreConfig</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-comment">/**</span><span class="hljs-comment"> * rediså­˜å‚¨token</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TokenStoreConfig</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> RedisConnectionFactory redisConnectionFactory;    <span class="hljs-meta">@Bean</span>    <span class="hljs-meta">@ConditionalOnProperty</span>(prefix = <span class="hljs-string">"mcr.b4.security.oAuth2"</span>, name = <span class="hljs-string">"storeType"</span>, havingValue = <span class="hljs-string">"redis"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">redisTokenStore</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RedisTokenStore(redisConnectionFactory);    &#125;    <span class="hljs-meta">@Configuration</span>    <span class="hljs-meta">@AllArgsConstructor</span>    <span class="hljs-meta">@ConditionalOnProperty</span>(prefix = <span class="hljs-string">"mcr.b4.security.oAuth2.storeType"</span>, name = <span class="hljs-string">"storeType"</span>, havingValue = <span class="hljs-string">"jwt"</span>, matchIfMissing = <span class="hljs-keyword">true</span>)    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtTokenConfig</span> </span>&#123;        <span class="hljs-keyword">private</span> SecurityProperties securityProperties;        <span class="hljs-meta">@Bean</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> TokenStore <span class="hljs-title">jwtTokenStore</span><span class="hljs-params">()</span> </span>&#123;            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());        &#125;        <span class="hljs-comment">/**</span><span class="hljs-comment">         * tokenç”Ÿæˆå¤„ç†</span><span class="hljs-comment">         */</span>        <span class="hljs-meta">@Bean</span>        <span class="hljs-function"><span class="hljs-keyword">public</span> JwtAccessTokenConverter <span class="hljs-title">jwtAccessTokenConverter</span><span class="hljs-params">()</span> </span>&#123;            OAuth2Properties oAuth2 = securityProperties.getOAuth2();            JwtAccessTokenConverter jwtAccessTokenConverter = <span class="hljs-keyword">new</span> JwtAccessTokenConverter();            jwtAccessTokenConverter.setSigningKey(oAuth2.getJwtSignKey());            <span class="hljs-keyword">return</span> jwtAccessTokenConverter;        &#125;    &#125;&#125;</code></pre><p>è¿™é‡Œæ¥ä»‹ç»ä¸€ä¸‹ConditionalOnPropertyæ³¨è§£</p><pre><code class="hljs java"><span class="hljs-meta">@ConditionalOnProperty</span>(prefix = <span class="hljs-string">"mcr.b4.security.oAuth2.storeType"</span>, name = <span class="hljs-string">"storeType"</span>, havingValue = <span class="hljs-string">"jwt"</span>, matchIfMissing = <span class="hljs-keyword">true</span>)</code></pre><p>è¿™é‡ŒæŒ‡çš„æ˜¯ymlã€propertiesé…ç½®æ–‡ä»¶ä¸­é…ç½®äº†â€mcr.b4.security.oAuth2.storeTypeçš„å€¼ä¸ºjwtï¼Œé‚£ä¹ˆè¿™ä¸ªç±»çš„é…ç½®å°±ä¼šç”Ÿæ•ˆï¼Œè¿™é‡Œçš„matchIfMissingå±æ€§ä¸ºtrueè¡¨ç¤ºå¦‚æœymlæ²¡é…ç½®ï¼Œä¹Ÿä¼šç”Ÿæ•ˆ</p><hr><p>McrAuthorizationServerConfig</p><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)  <span class="hljs-keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * å¯¹TokenEndpointçš„å±æ€§å’Œå¢å¼ºåŠŸèƒ½ã€‚</span><span class="hljs-comment">   */</span>  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;      endpoints.authenticationManager(authenticationManager)              .userDetailsService(userDetailsService)              .tokenStore(tokenStore)      ;      <span class="hljs-keyword">if</span> (jwtAccessTokenConverter != <span class="hljs-keyword">null</span>) &#123;          endpoints.accessTokenConverter(jwtAccessTokenConverter);      &#125;  &#125;</code></pre><p>ç™»å½•å“åº”çš„æ•°æ®æˆè¿™ä¸ªæ ·å­ï¼š</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"access_token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJyb290IiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iLCJST0xFX1VTRVIiXSwianRpIjoiNTVlNDVjNDUtZWM2ZC00NmMyLWI3NzgtZjY3MmYyYTAwNjFjIiwiY2xpZW50X2lkIjoidGVzdCIsInNjb3BlIjpbImFsbCJdfQ.oD1kF5KeQSKydVgZ6kAAwF0RMpOvXn_ttRQtjaZbEk8"</span>,<span class="hljs-attr">"token_type"</span>: <span class="hljs-string">"bearer"</span>,<span class="hljs-attr">"refresh_token"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJyb290Iiwic2NvcGUiOlsiYWxsIl0sImF0aSI6IjU1ZTQ1YzQ1LWVjNmQtNDZjMi1iNzc4LWY2NzJmMmEwMDYxYyIsImV4cCI6MTU3MDUyMjQzNywiYXV0aG9yaXRpZXMiOlsiYWRtaW4iLCJST0xFX1VTRVIiXSwianRpIjoiNmYxOWUwYTYtNTRmMi00ZDQ0LWEzMDYtODFkMWM1NDQ2MGNlIiwiY2xpZW50X2lkIjoidGVzdCJ9.MiapW2WqZGpntAraHeO2mJwt99de2xJhpLpA15MoIX0"</span>,<span class="hljs-attr">"scope"</span>: <span class="hljs-string">"all"</span>,<span class="hljs-attr">"jti"</span>: <span class="hljs-string">"55e45c45-ec6d-46c2-b778-f672f2a0061c"</span>&#125;</code></pre><p>è¯»è€…å¯ä»¥æ‹¿ç€access_tokenå»åœ¨çº¿è§£æjwtçš„ç½‘ç«™ï¼š <a href="http://jwt.calebb.net/ä¸­æŸ¥çœ‹å†…å®¹ï¼š" target="_blank" rel="noopener">http://jwt.calebb.net/ä¸­æŸ¥çœ‹å†…å®¹ï¼š</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567930569350.png" srcset="/img/loading.gif" alt="1567930569350"></p><p>è®¿é—®<a href="http://localhost:80/user/me/v3å“åº”å†…å®¹æ˜¯ç©ºçš„ï¼ŒåŸå› æ˜¯è¿™é‡Œä½¿ç”¨äº†@AuthenticationPrincipalæ³¨è§£ï¼Œç°åœ¨çš„Principalä¸æ˜¯UserDetailsï¼Œè€Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ‹¿ä¸åˆ°" target="_blank" rel="noopener">http://localhost:80/user/me/v3å“åº”å†…å®¹æ˜¯ç©ºçš„ï¼ŒåŸå› æ˜¯è¿™é‡Œä½¿ç”¨äº†@AuthenticationPrincipalæ³¨è§£ï¼Œç°åœ¨çš„Principalä¸æ˜¯UserDetailsï¼Œè€Œæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œæ‹¿ä¸åˆ°</a></p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me/v3"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentUser</span><span class="hljs-params">(@AuthenticationPrincipal UserDetails authentication)</span> </span>&#123;    <span class="hljs-keyword">return</span> authentication;&#125;</code></pre><p>éœ€è¦æ”¹ä¸ºè¿™æ ·</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me/v3"</span>) <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentUser</span><span class="hljs-params">(Authentication authentication)</span> </span>&#123;     <span class="hljs-keyword">return</span> authentication; &#125;</code></pre><p>å“åº”å†…å®¹ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"authorities"</span>: [        &#123;            <span class="hljs-attr">"authority"</span>: <span class="hljs-string">"admin"</span>        &#125;,        &#123;            <span class="hljs-attr">"authority"</span>: <span class="hljs-string">"ROLE_USER"</span>        &#125;    ],    <span class="hljs-attr">"details"</span>: &#123;        <span class="hljs-attr">"remoteAddress"</span>: <span class="hljs-string">"0:0:0:0:0:0:0:1"</span>,        <span class="hljs-attr">"sessionId"</span>: <span class="hljs-literal">null</span>,        <span class="hljs-attr">"tokenValue"</span>: <span class="hljs-string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX25hbWUiOiJyb290IiwiYXV0aG9yaXRpZXMiOlsiYWRtaW4iLCJST0xFX1VTRVIiXSwianRpIjoiZWJhYTRkMDEtNDgwMy00ZjkyLWJhZGQtMWFjNTZhMjdmNzE0IiwiY2xpZW50X2lkIjoidGVzdCIsInNjb3BlIjpbImFsbCJdfQ.3mCvI7PYBsbRk3qirgTg-NaipfV3JyZljiiHc0fXk9w"</span>,        <span class="hljs-attr">"tokenType"</span>: <span class="hljs-string">"bearer"</span>,        <span class="hljs-attr">"decodedDetails"</span>: <span class="hljs-literal">null</span>    &#125;,    <span class="hljs-attr">"authenticated"</span>: <span class="hljs-literal">true</span>,    <span class="hljs-attr">"userAuthentication"</span>: &#123;        <span class="hljs-attr">"authorities"</span>: [            &#123;                <span class="hljs-attr">"authority"</span>: <span class="hljs-string">"admin"</span>            &#125;,            &#123;                <span class="hljs-attr">"authority"</span>: <span class="hljs-string">"ROLE_USER"</span>            &#125;        ],        <span class="hljs-attr">"details"</span>: <span class="hljs-literal">null</span>,        <span class="hljs-attr">"authenticated"</span>: <span class="hljs-literal">true</span>,        <span class="hljs-attr">"principal"</span>: <span class="hljs-string">"root"</span>,        <span class="hljs-attr">"credentials"</span>: <span class="hljs-string">"N/A"</span>,        <span class="hljs-attr">"name"</span>: <span class="hljs-string">"root"</span>    &#125;,    <span class="hljs-attr">"principal"</span>: <span class="hljs-string">"root"</span>,    <span class="hljs-attr">"oauth2Request"</span>: &#123;        <span class="hljs-attr">"clientId"</span>: <span class="hljs-string">"test"</span>,        <span class="hljs-attr">"scope"</span>: [            <span class="hljs-string">"all"</span>        ],        <span class="hljs-attr">"requestParameters"</span>: &#123;            <span class="hljs-attr">"client_id"</span>: <span class="hljs-string">"test"</span>        &#125;,        <span class="hljs-attr">"resourceIds"</span>: [        ],        <span class="hljs-attr">"authorities"</span>: [        ],        <span class="hljs-attr">"approved"</span>: <span class="hljs-literal">true</span>,        <span class="hljs-attr">"refresh"</span>: <span class="hljs-literal">false</span>,        <span class="hljs-attr">"redirectUri"</span>: <span class="hljs-literal">null</span>,        <span class="hljs-attr">"responseTypes"</span>: [        ],        <span class="hljs-attr">"extensions"</span>: &#123;        &#125;,        <span class="hljs-attr">"refreshTokenRequest"</span>: <span class="hljs-literal">null</span>,        <span class="hljs-attr">"grantType"</span>: <span class="hljs-literal">null</span>    &#125;,    <span class="hljs-attr">"credentials"</span>: <span class="hljs-string">""</span>,    <span class="hljs-attr">"clientOnly"</span>: <span class="hljs-literal">false</span>,    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"root"</span>&#125;</code></pre><p>è¿™é‡Œçš„ä¿¡æ¯ï¼Œå®ƒä¸æ˜¯æŒ‰ç…§jwtæ¥ç”Ÿæˆçš„ï¼Œè€Œè¿™é‡Œçš„ä¿¡æ¯æ˜¯æŒ‰ç…§spring securityçš„Authenticationæ¥ç”Ÿæˆï¼Œå¦‚ä½•è‡ªå®šä¹‰jwtçš„ä¿¡æ¯ï¼Ÿæ¯”å¦‚æˆ‘æƒ³åœ¨è¿™é‡Œçš„jsonä¸­åŠ ä¸€ä¸ªå­—æ®µè¯¥æ€ä¹ˆåŠ ï¼Ÿè¿™é‡Œæ¥å®ç°ä¸‹è¿™ä¸ªåŠŸèƒ½</p><p>åˆ†ææºç å¯çŸ¥</p><p>DefaultTokenServices#createAccessToken</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567931505416.png" srcset="/img/loading.gif" alt="1567931505416"></p><p>è¿™é‡Œçš„tokenæ˜¯é€šè¿‡UUIDç”Ÿæˆçš„ï¼Œè€Œå®ƒè¿™é‡Œçš„ç”Ÿæˆæ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡å®ç°ã€ç»§æ‰¿æ–¹å¼æ¥é‡å†™ç”Ÿæˆé€»è¾‘ï¼Œä¸è¿‡è¿™é‡Œçš„æœ€ä¸‹æ–¹è°ƒç”¨äº†TokenEnhancerè¿™å¯¹è±¡çš„enhanceæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨æ¥å¢å¼ºçš„ï¼Œä¹‹å‰æœ‰æåˆ°è¿‡ï¼Œè¿™é‡Œå¯ä»¥å®ç°TokenEnhanceræ¥å£çš„enhanceæ–¹æ³•æ¥å¯¹ç”Ÿæˆçš„tokenåŠ å­—æ®µè¿›å»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.jwt;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è‡ªå®šä¹‰tokenå¢å¼ºå™¨</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrJwtTokenEnhancer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TokenEnhancer</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2AccessToken <span class="hljs-title">enhance</span><span class="hljs-params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> </span>&#123;        Map&lt;String, Object&gt; info = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        <span class="hljs-comment">// éœ€è¦å¢åŠ çš„ä¿¡æ¯</span>        <span class="hljs-comment">// æ‰€ä»¥å¦‚æœæ˜¯éœ€è¦åŠ¨æ€çš„è¯ï¼Œåªèƒ½åœ¨è¯¥æ–¹æ³•ä¸­å»è°ƒç”¨ä¸šåŠ¡æ–¹æ³•æ·»åŠ åŠ¨æ€å‚æ•°ä¿¡æ¯</span>        info.put(<span class="hljs-string">"company"</span>, <span class="hljs-string">"mcr"</span>);        <span class="hljs-comment">// è®¾ç½®é™„åŠ ä¿¡æ¯</span>        ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(info);        <span class="hljs-keyword">return</span> accessToken;    &#125;&#125;</code></pre><p>TokenStoreConfig#JwtTokenConfig</p><pre><code class="hljs java">  <span class="hljs-meta">@Bean</span><span class="hljs-meta">@ConditionalOnMissingBean</span>(TokenEnhancer<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">TokenEnhancer</span> <span class="hljs-title">jwtTokenEnhancer</span>() </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrJwtTokenEnhancer();    &#125;</code></pre><p>McrAuthorizationServerConfig</p><pre><code class="hljs java"> <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)   <span class="hljs-keyword">private</span> JwtAccessTokenConverter jwtAccessTokenConverter;   <span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)   <span class="hljs-keyword">private</span> TokenEnhancer jwtTokenEnhancer;<span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;       endpoints.authenticationManager(authenticationManager)               .userDetailsService(userDetailsService)               .tokenStore(tokenStore)       ;       <span class="hljs-keyword">if</span> (jwtAccessTokenConverter != <span class="hljs-keyword">null</span> &amp;&amp; jwtTokenEnhancer != <span class="hljs-keyword">null</span>) &#123;           TokenEnhancerChain enhancerChain = <span class="hljs-keyword">new</span> TokenEnhancerChain();           List&lt;TokenEnhancer&gt; enhancers = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();           enhancers.add(jwtTokenEnhancer);           enhancers.add(jwtAccessTokenConverter);           enhancerChain.setTokenEnhancers(enhancers);           endpoints                   .tokenEnhancer(enhancerChain)                   .accessTokenConverter(jwtAccessTokenConverter);       &#125;   &#125;</code></pre><p>ä¸Šé¢ä»£ç ä¸­ä½¿ç”¨äº†TokenEnhancerChainè¿™ä¹ˆä¸€ä¸ªç±»ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨æ˜¯å°†å¢å¼ºå™¨è¿æ¥èµ·æ¥ï¼Œå› ä¸ºå‰é¢é€šè¿‡jwtè½¬æ¢å™¨è½¬æ¢ï¼Œè€Œåœ¨è¿™é‡Œåˆä½¿ç”¨äº†å¢å¼ºå™¨ï¼Œæ‰€ä»¥éœ€è¦ç”¨å®ƒå°†2ä¸ªç±»ç›¸è¿èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªé“¾</p><p>ç°åœ¨é‡æ–°ç™»å½•ï¼Œæ‹¿åˆ°tokenåœ¨åˆ°é‚£ä¸ªç½‘ç«™ä¸Šå»çœ‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567932671671.png" srcset="/img/loading.gif" alt="1567932671671"></p><p>ä¸è¿‡åœ¨æˆ‘è‡ªå·±çš„<a href="http://localhost:80/user/me/v3" target="_blank" rel="noopener">http://localhost:80/user/me/v3</a> rest apiæ˜¯çœ‹ä¸åˆ°è¿™ä¸ªå­—æ®µçš„ï¼Œç°åœ¨å°±æ¥å®ç°ä¸€ä¸‹è¿™ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆåœ¨demoæ¨¡å—åŠ å…¥ä¸€ä¸ªä¾èµ–</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.jsonwebtoken<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jjwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.9.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><p>UserController</p><pre><code class="hljs java">      <span class="hljs-meta">@Autowired</span> <span class="hljs-keyword">private</span> SecurityProperties securityProperties;<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me/v4"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentAuthentication2</span><span class="hljs-params">(Authentication authentication, HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> UnsupportedEncodingException </span>&#123;        String authorization = request.getHeader(<span class="hljs-string">"Authorization"</span>);        String token = StringUtils.substringAfter(authorization, <span class="hljs-string">"bearer "</span>);        String jwtSigningKey = securityProperties.getOAuth2().getJwtSignKey();        <span class="hljs-comment">// ç”Ÿæˆçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯ org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter</span>        <span class="hljs-comment">// æºç é‡Œé¢æŠŠsigningkeyå˜æˆutf8äº†</span>        <span class="hljs-comment">// JwtAccessTokenConverterç±»ï¼Œè§£æå‡ºæ¥æ˜¯ä¸€ä¸ªmap</span>        <span class="hljs-comment">// æ‰€ä»¥è¿™ä¸ªè‡ªå¸¦çš„JwtAccessTokenConverterå¯¹è±¡ä¹Ÿæ˜¯å¯ä»¥ç›´æ¥ç”¨æ¥è§£æçš„</span>        <span class="hljs-keyword">byte</span>[] bytes = jwtSigningKey.getBytes(StandardCharsets.UTF_8);        Claims body = Jwts.parser().setSigningKey(bytes).parseClaimsJws(token).getBody();        String company = (String) body.get(<span class="hljs-string">"company"</span>);        log.info(<span class="hljs-string">"å…¬å¸åç§°:&#123;&#125;"</span>, company);        <span class="hljs-keyword">return</span> body;    &#125;</code></pre><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567933366085.png" srcset="/img/loading.gif" alt="1567933366085"></p><h1 id="TOKENåˆ·æ–°"><a href="#TOKENåˆ·æ–°" class="headerlink" title="TOKENåˆ·æ–°"></a>TOKENåˆ·æ–°</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567933734791.png" srcset="/img/loading.gif" alt="1567933734791"></p><p>è¿™ä¸ªè¿‡ç¨‹å¯ä»¥åœ¨ç”¨æˆ·æ— æ„ŸçŸ¥çš„æƒ…å†µä¸‹å»åšï¼Œå½“ç”¨æˆ·è®¿é—®appçš„æ—¶å€™ï¼Œtokenè¿‡æœŸäº†ï¼Œå®¢æˆ·ç«¯é‚£è¾¹å°±ä¼šå»è¯·æ±‚ä¸Šé¢è¿™ä¸ªåœ°å€ï¼Œå¸¦ä¸Šç™»å½•æ—¶æ‹¿åˆ°çš„refresh_tokenï¼Œå¯¹tokenè¿›è¡Œåˆ·æ–°ã€‚è¿™é‡Œè¦æ³¨æ„refresh_tokenä¹Ÿæ˜¯æœ‰è¿‡æœŸæ—¶é—´çš„ï¼Œå»ºè®®å¯ä»¥è®¾ç½®é•¿ä¸€äº›ï¼Œ</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 7.é‡æ„æ³¨å†Œé€»è¾‘</title>
    <link href="/spring-security-5.7.html"/>
    <url>/spring-security-5.7.html</url>
    
    <content type="html"><![CDATA[<p>é€šè¿‡å‰é¢ç« èŠ‚ï¼Œå·²ç»å°†ç™»å½•é€»è¾‘è·‘é€šäº†ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦åœ¨æ•°æ®åº“ä¸­æœ‰è¿™ä¹ˆä¸€æ¡è®°å½•çš„æƒ…å†µä¸‹æ‰èƒ½è·å–ä»¤ç‰Œï¼Œå¦‚æœæ•°æ®åº“ä¸­æ˜¯æ²¡è®°å½•çš„ï¼Œå®ƒæ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿä¹‹å‰æµè§ˆå™¨ç¤¾äº¤ç™»å½•å®ƒçš„æ³¨å†Œæµç¨‹å¤„ç†è®²è¿‡è¿™å—ï¼Œä¹‹å‰é€šè¿‡ProviderSignInUtilsè¿›è¡Œè¯»å†™æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·å®ƒæ˜¯åŸºäºsessionçš„ï¼Œåœ¨æˆ‘ä»¬ç°åœ¨çš„appæ¨¡å—ä½¿ç”¨æ˜¯è¡Œä¸é€šçš„ï¼Œè¿™é‡Œå°±éœ€è¦è¿›è¡Œæ”¹é€ ï¼Œè¿™é‡Œå°±ä½¿ç”¨redisæ¥è¿›è¡Œå­˜å‚¨ï¼Œè¿™é‡Œçš„æ”¹é€ æ€è·¯å’Œå‰é¢çš„â€œé‡æ„çŸ­ä¿¡ç™»å½•â€ç« èŠ‚çš„æ€è·¯æ˜¯ä¸€æ ·çš„</p><hr><p>AppSignUpUtilså·¥å…·ç±»æ¥ä»£æ›¿ProviderSignInUtilså·¥å…·ï¼Œä½¿ç”¨çš„æ˜¯redisæ¥å­˜å‚¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.social;<span class="hljs-comment">/**</span><span class="hljs-comment"> * ç¤¾äº¤ç”¨æˆ·å’Œç³»ç»Ÿç”¨æˆ·çš„å…³ç³»æ³¨å†Œ</span><span class="hljs-comment"> * ProviderSignInUtils æ¨¡æ‹Ÿå…¶ä¸­éƒ¨åˆ†çš„åŠŸèƒ½</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppSignUpUtils</span> </span>&#123;    <span class="hljs-keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;    <span class="hljs-keyword">private</span> UsersConnectionRepository usersConnectionRepository;    <span class="hljs-keyword">private</span> ConnectionFactoryLocator connectionFactoryLocator;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¿å­˜ç¤¾äº¤ä¿¡æ¯åˆ°redis</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">saveConnectionData</span><span class="hljs-params">(ServletWebRequest request, ConnectionData connectionData)</span> </span>&#123;        redisTemplate.opsForValue().set(buildKey(request), connectionData);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç¤¾äº¤ç”¨æˆ·ä¿¡æ¯å…¥åº“</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doPostSignUp</span><span class="hljs-params">(String userId, WebRequest request)</span> </span>&#123;        String key = buildKey(request);        <span class="hljs-keyword">if</span> (!redisTemplate.hasKey(key)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AppSecretException(<span class="hljs-string">"æ— æ³•æ‰¾åˆ°ç¼“å­˜çš„ç”¨æˆ·ç¤¾äº¤è´¦å·ä¿¡æ¯"</span>);        &#125;        ConnectionData connectionData = (ConnectionData) redisTemplate.opsForValue().get(key);        Connection&lt;?&gt; connection = connectionFactoryLocator.getConnectionFactory(connectionData.getProviderId())                .createConnection(connectionData);        usersConnectionRepository.createConnectionRepository(userId).addConnection(connection);        redisTemplate.delete(key);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">buildKey</span><span class="hljs-params">(WebRequest request)</span> </span>&#123;        String deviceId = request.getHeader(<span class="hljs-string">"deviceId"</span>);        <span class="hljs-keyword">if</span> (StringUtils.isBlank(deviceId)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AppSecretException(<span class="hljs-string">"è®¾å¤‡idå‚æ•°ä¸èƒ½ä¸ºç©º"</span>);        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-string">"mcr:security:social.connect."</span> + deviceId;    &#125;&#125;</code></pre><p>å…‰è¿™ä¸ªå·¥å…·ç±»æ˜¯ä¸å¤Ÿçš„ï¼Œæˆ‘ä»¬è¦è®©å½“ç”¨æˆ·å»æ³¨å†Œçš„æ—¶å€™ï¼Œä¸è¦è·³åˆ°æˆ‘ä»¬ä¹‹å‰é…çš„æ³¨å†Œé¡µé¢ä¸Šå»ï¼Œè€Œæ˜¯è·³åˆ°æŒ‡å®šçš„æœåŠ¡é‡Œé¢ï¼Œè€Œæ˜¯è·³åˆ°æŒ‡å®šçš„æœåŠ¡ä¸Šå»ï¼Œè€Œè¿™ä¸ªæœåŠ¡ä½¿ç”¨è¿™ä¸ªAppSignUpUtilsæ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ä¸”ç›´æ¥å°†ç”¨æˆ·ä¿¡æ¯ç”¨jsonçš„å½¢å¼è¿”å›ç»™appï¼Œé‚£ä¹ˆç°åœ¨æ¥åšä¸€ä¸ªé…ç½®çš„ä¿®æ”¹ï¼Œåœ¨ä¿®æ”¹ä¹‹å‰æ¥çœ‹ä»¥ä¸‹ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableSocial</span><span class="hljs-meta">@Order</span>(<span class="hljs-number">0</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialConfigurerAdapter</span> </span>&#123;<span class="hljs-comment">//..</span>    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SpringSocialConfigurer <span class="hljs-title">mcrSpringSocialConfigurer</span><span class="hljs-params">()</span> </span>&#123;        McrSpringSocialConfigurer mcrSpringSocialConfigurer = <span class="hljs-keyword">new</span> McrSpringSocialConfigurer(securityProperties.getSocial().getFilterProcessesUrl());        mcrSpringSocialConfigurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());        <span class="hljs-keyword">return</span> mcrSpringSocialConfigurer;    &#125;&#125;</code></pre><p>ç°åœ¨æµè§ˆå™¨ç¯å¢ƒä¸‹æ˜¯æ²¡é—®é¢˜çš„ï¼Œåœ¨è¿™é‡Œä¸è¦å»æ”¹å®ƒï¼Œè€Œåœ¨appç¯å¢ƒä¸‹é‡‡ç”¨å¦å¤–ä¸€ç§é…ç½®,è¿™é‡Œéœ€è¦è®°ä½springä¸­çš„BeanPostProcessoræ¥å£ï¼Œå®ƒçš„ä½œç”¨æ˜¯åœ¨IOCå®¹å™¨æ‰€æœ‰beanåˆå§‹åŒ–ä¹‹å‰å’Œåˆå§‹åŒ–ä¹‹åéƒ½è¦ç»è¿‡è¿™2ä¸ªæ–¹æ³•ï¼Œ </p><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.beans.factory.config;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BeanPostProcessor</span> </span>&#123;<span class="hljs-function">Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException</span>;<span class="hljs-function">Object <span class="hljs-title">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException</span>;&#125;</code></pre><p>è¿™é‡Œåœ¨åç½®å¤„ç†çš„æ–¹æ³•ä¸­åˆ¤æ–­beançš„åå­—æ˜¯ä¸æ˜¯mcrSpringSocialConfigurerï¼Œæ˜¯çš„è¯å°†å®ƒçš„signupUrlè®¾ç½®æˆ/<code>social/signUp</code></p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-comment">/**</span><span class="hljs-comment"> * åç½®å¤„ç†å™¨ springBean åˆå§‹åŒ–ä¹‹å‰å’Œä¹‹å</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringSocialConfigurerPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanPostProcessor</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;        <span class="hljs-keyword">return</span> bean;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>&#123;        <span class="hljs-keyword">if</span> (StringUtils.equals(beanName, <span class="hljs-string">"mcrSpringSocialConfigurer"</span>)) &#123;            McrSpringSocialConfigurer configurer = (McrSpringSocialConfigurer) bean;            configurer.signupUrl(<span class="hljs-string">"/social/signUp"</span>);<span class="hljs-comment">//æ›´æ¢æµè§ˆå™¨çš„é»˜è®¤æ³¨å†Œ</span>            <span class="hljs-keyword">return</span> configurer;        &#125;        <span class="hljs-keyword">return</span> bean;    &#125;&#125;</code></pre><p>springbeanç”Ÿå‘½å‘¨æœŸå…³ç³»å¦‚ä¸‹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/20190501135420696.png" srcset="/img/loading.gif" alt=""></p><p>æ³¨å†Œå¤„ç†ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.controller;<span class="hljs-meta">@RestController</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppSecurityController</span> </span>&#123; <span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> ProviderSignInUtils providerSignInUtils; <span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> AppSignUpUtils appSignUpUtils; <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/social/signUp"</span>)<span class="hljs-meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)<span class="hljs-function"><span class="hljs-keyword">public</span> SocialUserInfoVO <span class="hljs-title">getSocialUserInfo</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;SocialUserInfoVO userInfo = <span class="hljs-keyword">new</span> SocialUserInfoVO();Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(<span class="hljs-keyword">new</span> ServletWebRequest(request)); ConnectionData connectionData=connection.createData();userInfo.setProviderId(connection.getKey().getProviderId());userInfo.setProviderUserId(connection.getKey().getProviderUserId());userInfo.setNickname(connection.getDisplayName());userInfo.setHeadimg(connection.getImageUrl()); appSignUpUtils.saveConnectionData(<span class="hljs-keyword">new</span> ServletWebRequest(request), connectionData);<span class="hljs-keyword">return</span> userInfo;&#125;&#125;</code></pre><p>McrResourceServerConfig</p><pre><code class="hljs java">.antMatchers(                    <span class="hljs-string">"/social/signUp"</span>,</code></pre><p>UserController#æ–¹æ³•è¿›è¡Œä¿®æ”¹</p><pre><code class="hljs java"> <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ProviderSignInUtils providerSignInUtils;    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/regist"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">regist</span><span class="hljs-params">(UserVO userVO, HttpServletResponse response, HttpServletRequest request)</span> </span>&#123;        String userId = userVO.getUserName();        <span class="hljs-comment">//ã€ç»‘å®šé€»è¾‘....</span><span class="hljs-comment">//        providerSignInUtils.doPostSignUp(userId, new ServletWebRequest(request, response));</span>        appSignUpUtils.doPostSignUp(userId, <span class="hljs-keyword">new</span> ServletWebRequest(request, response));    &#125;</code></pre><hr><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 6.é‡æ„ç¤¾äº¤ç™»å½•</title>
    <link href="/spring-security-5.6.html"/>
    <url>/spring-security-5.6.html</url>
    
    <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>ä¹‹å‰åšbrowserèµ°çš„æ˜¯ä¸€ä¸ªæ ‡å‡†çš„OAuthæµç¨‹ï¼Œä½†æ˜¯ç°åœ¨åœ¨Appçš„ç¯å¢ƒä¸‹ï¼Œæ¶æ„å°±å˜æˆäº†ç”¨æˆ·è®¿é—®çš„ç¡¬èµ¢æ˜¯ä¸€ä¸ªAppï¼Œè¿™æ—¶å€™ç”¨æˆ·åœ¨appä¸­å»åˆ°ç‚¹å‡»QQç™»å½•ï¼Œå®é™…ä¸Šå®ƒä¸æ˜¯è®¿é—®æˆ‘ä»¬ä¸šåŠ¡ç³»ç»Ÿä¸­çš„è¯·æ±‚è·¯å¾„ï¼Œè€Œæ˜¯ä¸€ä¸ªæœåŠ¡æä¾›å•†çš„SDKï¼Œè¿™ä¸ªSDKä¼šå¼•å¯¼ç”¨æˆ·å®Œæˆæˆæƒæµç¨‹ï¼Œä¸åŒçš„æœåŠ¡å•†å¯¹äºSDKå®ƒçš„å®ç°æ˜¯ä¸ä¸€æ ·çš„ï¼Œé€‰çš„æˆæƒæ¨¡å¼ä¹Ÿä¸ä¸€æ ·çš„ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šæœ‰2ç§æ¨¡å¼ï¼š</p><p>ï¼ˆ1ï¼‰ç®€åŒ–æ¨¡å¼ï¼šSDKå°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ï¼Œç„¶åç”¨æˆ·æˆæƒä»¥åï¼Œå®ƒè¿”å›çš„ä¸æ˜¯æˆæƒç ï¼Œè¿”å›çš„æ˜¯accessTokenæˆ–è€…openidï¼Œåˆ°è¿™ä¸€æ­¥æ—¶ï¼Œappå°±çŸ¥é“ç”¨æˆ·å®ƒçš„openIdäº†ï¼Œè¿™æ—¶å€™ï¼Œappå¯ä»¥ç”¨openIdæˆ–è€…accessTokenç›´æ¥å»èµ„æºæœåŠ¡å™¨è·å–ç”¨æˆ·ä¿¡æ¯çš„ï¼Œä½†æ˜¯å®ƒå¹¶ä¸èƒ½æ‹¿è¿™2ä¸ªæ¥è®¿é—®æˆ‘ä»¬è‡ªå·±çš„åç«¯åº”ç”¨æœåŠ¡ï¼Œå› ä¸ºè¿™é‡Œçš„accessTokenæ˜¯æœåŠ¡æä¾›å•†å‘çš„ï¼Œè€Œå®ƒè¦è®¿é—®æˆ‘ä»¬è¿™é‡Œçš„åº”ç”¨æœåŠ¡ï¼Œéœ€è¦æˆ‘ä»¬å‘çš„ä»¤ç‰Œï¼Œåœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä½œä¸ºåç«¯åº”ç”¨æ¥è¯´éœ€è¦ç»™appæä¾›ä¸€ä¸ªæœåŠ¡ï¼Œè®©å®ƒå¯ä»¥ç”¨openIdæ¥æ¢æˆ‘ä»¬è¿™çš„ä»¤ç‰Œï¼Œå¯¹äºç°åœ¨çš„ä¸šåŠ¡åœºæ™¯ï¼Œå…¶å®å’Œå‰é¢çš„çŸ­ä¿¡éªŒè¯ç ç™»å½•å·®ä¸å¤šï¼Œåªä¸è¿‡è¿™é‡ŒéªŒçš„æ˜¯openIdï¼Œæ‹¿è¿™ä¸ªopenIdå»æ•°æ®åº“é‡ŒæŸ¥å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åå­˜åœ¨å°±ç”Ÿæˆä»¤ç‰Œç»™ç”¨æˆ·ï¼Œå¦‚æœä¸å­˜å°±å“åº”é”™è¯¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567846953327.png" srcset="/img/loading.gif" alt="1567846953327"></p><p>ï¼ˆ2ï¼‰æ ‡å‡†æˆæƒç æ¨¡å¼ï¼šæœåŠ¡æä¾›å•†æä¾›çš„app sdkå®ƒèµ°çš„æ˜¯æ ‡å‡†çš„æˆæƒç æµç¨‹ï¼Œåœ¨appä¸Šåšå®Œæˆæƒï¼Œå®ƒæ‹¿åˆ°çš„æ˜¯æˆæƒç ï¼Œè¿™é‡Œéœ€è¦æŠŠæˆæƒç ç»™æœåŠ¡å™¨ï¼Œç”±æœåŠ¡å™¨æ¥ç”³è¯·ä»¤ç‰Œï¼ŒæœåŠ¡æä¾›å•†çš„è®¤è¯æœåŠ¡å™¨æŠŠä»¤çˆ±ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ä»¥åï¼Œç¬¬ä¸‰æ–¹åº”ç”¨æœåŠ¡å®ƒå»æ‹¿ç€ä»¤ç‰Œè¯»ç”¨æˆ·æ•°æ®ï¼Œå¦‚æœèƒ½è¯»åˆ°ç”¨æˆ·æ•°æ®ï¼Œæ ¹æ®ç”¨æˆ·ä¿¡æ¯å®ƒå»ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œç»™appï¼Œåœ¨è¿™ä¸ªæµç¨‹ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹çš„ï¼Œå› ä¸ºåœ¨æ ‡å‡†æµç¨‹é‡Œé¢ï¼Œæˆ‘ä»¬æ˜¯æœ‰è¿™ä¸ª æœåŠ¡çš„ï¼Œæ¥å—è®¤è¯æœåŠ¡å™¨è¿”å›çš„è¯·æ±‚ï¼Œç„¶åæå–é‡Œé¢çš„æˆæƒç å†å»å‘ä»¤ç‰Œï¼Œæˆ‘ä»¬æ˜¯æœ‰è¿™ä¹ˆä¸€ä¸ªæœåŠ¡æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚çš„ï¼Œåœ¨è¿™ä¸ªç¯å¢ƒä¸‹çš„è¯·æ±‚å®ƒå‘åˆ°çš„æ˜¯æ‰‹æœºappä¸Šå»ï¼Œappè¦åšçš„æ˜¯æŠŠè¯·æ±‚åŸå°ä¸åŠ¨è½¬å‘åˆ°æˆ‘ä»¬çš„æœåŠ¡å™¨å°±å¯ä»¥äº†ï¼Œæˆ–è€…æŠŠé‡Œé¢æºå¸¦çš„æˆæƒç æ‹¿å‡ºæ¥</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567849217792.png" srcset="/img/loading.gif" alt="1567849217792"></p><h1 id="ç®€åŒ–æ¨¡å¼"><a href="#ç®€åŒ–æ¨¡å¼" class="headerlink" title="ç®€åŒ–æ¨¡å¼"></a>ç®€åŒ–æ¨¡å¼</h1><p>McrResourceServerConfigï¼š</p><pre><code class="hljs java">   <span class="hljs-keyword">private</span> SpringSocialConfigurer mcrSpringSocialConfigurer;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;http.               .apply(mcrSpringSocialConfigurer)</code></pre><p>æ ¹æ®ä¸Šé¢æè¿°ä¸­ï¼Œè¿™é‡Œéœ€è¦è·å–è¯·æ±‚ä¸­çš„openIdã€providerIdï¼Œç„¶ååˆ°æ•°æ®åº“ä¸­æŸ¥æ‰¾ï¼Œè¿™é‡Œåšäº†ä¸€ä¸ªOpenIdAuthenticationToken</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.social.openid; <span class="hljs-keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;<span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<span class="hljs-keyword">import</span> org.springframework.security.core.SpringSecurityCoreVersion; <span class="hljs-keyword">import</span> java.util.Collection; <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenIdAuthenticationToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractAuthenticationToken</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID; <span class="hljs-comment">// ~ Instance fields</span><span class="hljs-comment">// ================================================================================================</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<span class="hljs-comment">//openId</span><span class="hljs-keyword">private</span> String providerId;<span class="hljs-comment">//ä¾›åº”å•†ID</span> <span class="hljs-comment">// ~ Constructors</span><span class="hljs-comment">// ===================================================================================================</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpenIdAuthenticationToken</span><span class="hljs-params">(Object principal, String providerId)</span> </span>&#123;<span class="hljs-keyword">super</span>(<span class="hljs-keyword">null</span>);<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">this</span>.providerId = providerId;<span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// must use super, as we override</span>&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpenIdAuthenticationToken</span><span class="hljs-params">(Object principal,</span></span><span class="hljs-function"><span class="hljs-params"> Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;<span class="hljs-keyword">super</span>(authorities);<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// must use super, as we override</span>&#125; <span class="hljs-comment">// ~ Methods</span><span class="hljs-comment">// ========================================================================================================</span>  <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getPrincipal</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.principal;&#125; <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCredentials</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getProviderId</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> providerId;&#125; <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthenticated</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAuthenticated)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<span class="hljs-keyword">if</span> (isAuthenticated) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);&#125; <span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">false</span>);&#125; <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eraseCredentials</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">super</span>.eraseCredentials();&#125; &#125;</code></pre><p>è¿™é‡Œå’Œä¹‹å‰åšç™»å½•ç™»å½•ä¸€æ ·ï¼Œå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œæ”¾åˆ°spring securityçš„è¿‡æ»¤å™¨é“¾ä¸Šæ¥æ‹¦æˆªç‰¹å®šçš„è¯·æ±‚ï¼Œå¦‚æœæ˜¯ç‰¹å®šçš„é‚£ä¸ªQQç™»å½•è¯·æ±‚çš„è¯ï¼Œå°±è·å–è¯·æ±‚ä¸­openIdã€providerIdå°†å®ƒç»„åˆæˆä¸Šé¢è¿™ä¸ªOpenIdAuthenticationTokenäº¤ç»™AuthenticationManager</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.social.openid;<span class="hljs-comment">/**</span><span class="hljs-comment"> * é€»è¾‘é€šçŸ­ä¿¡ç™»å½•éªŒè¯</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * </span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenIdAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractAuthenticationProcessingFilter</span> </span>&#123;    <span class="hljs-keyword">private</span> String openIdParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_OPENID;    <span class="hljs-comment">// æœåŠ¡æä¾›å•†idï¼Œqqè¿˜æ˜¯å¾®ä¿¡</span>    <span class="hljs-keyword">private</span> String providerIdParameter = SecurityConstants.DEFAULT_PARAMETER_NAME_PROVIDERID;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> postOnly = <span class="hljs-keyword">true</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OpenIdAuthenticationFilter</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> AntPathRequestMatcher(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_OPENID, <span class="hljs-string">"POST"</span>));    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">                                                HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;        <span class="hljs-keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="hljs-string">"POST"</span>)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AuthenticationServiceException(                    <span class="hljs-string">"Authentication method not supported: "</span> + request.getMethod());        &#125;        String openId = obtainOpenId(request);        String providerId = obtainProviderId(request);        <span class="hljs-keyword">if</span> (openId == <span class="hljs-keyword">null</span>) &#123;            openId = <span class="hljs-string">""</span>;        &#125;        <span class="hljs-keyword">if</span> (providerId == <span class="hljs-keyword">null</span>) &#123;            providerId = <span class="hljs-string">""</span>;        &#125;        openId = openId.trim();        OpenIdAuthenticationToken authRequest = <span class="hljs-keyword">new</span> OpenIdAuthenticationToken(openId, providerId);        <span class="hljs-comment">// Allow subclasses to set the "details" property</span>        setDetails(request, authRequest);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAuthenticationManager().authenticate(authRequest);    &#125;    <span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">obtainOpenId</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;        <span class="hljs-keyword">return</span> request.getParameter(openIdParameter);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">obtainProviderId</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;        <span class="hljs-keyword">return</span> request.getParameter(providerIdParameter);    &#125;    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDetails</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">                              OpenIdAuthenticationToken authRequest)</span> </span>&#123;        authRequest.setDetails(authenticationDetailsSource.buildDetails(request));    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setOpenIdParameter</span><span class="hljs-params">(String openIdParameter)</span> </span>&#123;        Assert.hasText(openIdParameter, <span class="hljs-string">"Username parameter must not be empty or null"</span>);        <span class="hljs-keyword">this</span>.openIdParameter = openIdParameter;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPostOnly</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> postOnly)</span> </span>&#123;        <span class="hljs-keyword">this</span>.postOnly = postOnly;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">getOpenIdParameter</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> openIdParameter;    &#125;&#125;</code></pre><p>åˆ›å»ºAuthenticationProviderçš„å®ç°ç±»ï¼Œç”¨äºOpenIdAuthenticationTokençš„æ•ˆéªŒï¼Œè¿™é‡Œé€šè¿‡ä¹‹å‰åœ¨socialä¸­ä»‹ç»çš„UsersConnectionRepositoryæ¥é€šè¿‡appå‘è¿‡æ¥çš„openIdã€providerIdåˆ°æ•°æ®åº“ä¸­è¿›è¡ŒæŸ¥è¯¢</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.social.openid; <span class="hljs-keyword">import</span> org.apache.commons.collections.CollectionUtils;<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationProvider;<span class="hljs-keyword">import</span> org.springframework.security.authentication.InternalAuthenticationServiceException;<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<span class="hljs-keyword">import</span> org.springframework.social.connect.UsersConnectionRepository;<span class="hljs-keyword">import</span> org.springframework.social.security.SocialUserDetailsService; <span class="hljs-keyword">import</span> java.util.HashSet;<span class="hljs-keyword">import</span> java.util.Set; <span class="hljs-comment">/**</span><span class="hljs-comment"> * éªŒè¯OpenIdAuthenticationToken</span><span class="hljs-comment"> * æŸ¥è¯¢ç¤¾äº¤æ•°æ®åº“è¡¨UserConnection</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenIdAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;  <span class="hljs-keyword">private</span> SocialUserDetailsService userDetailsService; <span class="hljs-keyword">private</span> UsersConnectionRepository usersConnectionRepository; <span class="hljs-comment">/*</span><span class="hljs-comment"> * (non-Javadoc)</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * @see org.springframework.security.authentication.AuthenticationProvider#</span><span class="hljs-comment"> * authenticate(org.springframework.security.core.Authentication)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123; OpenIdAuthenticationToken authenticationToken = (OpenIdAuthenticationToken) authentication; Set&lt;String&gt; providerUserIds = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();providerUserIds.add((String) authenticationToken.getPrincipal());<span class="hljs-comment">//openId</span><span class="hljs-comment">//UserConnection è¿™ä¸ªè¡¨é‡ŒæŸ¥è¯¢ä¿¡æ¯</span>Set&lt;String&gt; userIds = usersConnectionRepository.findUserIdsConnectedTo(authenticationToken.getProviderId(), providerUserIds); <span class="hljs-keyword">if</span>(CollectionUtils.isEmpty(userIds) || userIds.size() != <span class="hljs-number">1</span>) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalAuthenticationServiceException(<span class="hljs-string">"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯"</span>);&#125; String userId = userIds.iterator().next(); UserDetails user = userDetailsService.loadUserByUserId(userId); <span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalAuthenticationServiceException(<span class="hljs-string">"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯"</span>);&#125; OpenIdAuthenticationToken authenticationResult = <span class="hljs-keyword">new</span> OpenIdAuthenticationToken(user, user.getAuthorities()); authenticationResult.setDetails(authenticationToken.getDetails()); <span class="hljs-keyword">return</span> authenticationResult;&#125; <span class="hljs-comment">/*</span><span class="hljs-comment"> * (non-Javadoc)</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * @see org.springframework.security.authentication.AuthenticationProvider#</span><span class="hljs-comment"> * supports(java.lang.Class)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> </span>&#123;<span class="hljs-keyword">return</span> OpenIdAuthenticationToken<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">isAssignableFrom</span>(<span class="hljs-title">authentication</span>)</span>;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> SocialUserDetailsService <span class="hljs-title">getUserDetailsService</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> userDetailsService;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserDetailsService</span><span class="hljs-params">(SocialUserDetailsService userDetailsService)</span> </span>&#123;<span class="hljs-keyword">this</span>.userDetailsService = userDetailsService;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> UsersConnectionRepository <span class="hljs-title">getUsersConnectionRepository</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> usersConnectionRepository;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUsersConnectionRepository</span><span class="hljs-params">(UsersConnectionRepository usersConnectionRepository)</span> </span>&#123;<span class="hljs-keyword">this</span>.usersConnectionRepository = usersConnectionRepository;&#125; &#125;</code></pre><p>å°†ä»¥ä¸Šçš„ä»£ç è¿›è¡Œé…ç½®</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.social.openid;<span class="hljs-comment">/**</span><span class="hljs-comment"> * openId æƒé™é…ç½®ç±»</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OpenIdAuthenticationSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityConfigurerAdapter</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>, <span class="hljs-title">HttpSecurity</span>&gt; </span>&#123;    <span class="hljs-keyword">private</span> SocialUserDetailsService userDetailsService;    <span class="hljs-keyword">private</span> UsersConnectionRepository usersConnectionRepository;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        OpenIdAuthenticationProvider provider = <span class="hljs-keyword">new</span> OpenIdAuthenticationProvider();        provider.setUserDetailsService(userDetailsService);        provider.setUsersConnectionRepository(usersConnectionRepository);        OpenIdAuthenticationFilter filter = <span class="hljs-keyword">new</span> OpenIdAuthenticationFilter();        filter.setAuthenticationManager(http.getSharedObject(AuthenticationManager<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;        filter.setAuthenticationFailureHandler(authenticationFailureHandler);        filter.setAuthenticationSuccessHandler(authenticationSuccessHandler);        <span class="hljs-comment">//å¯†ç ç™»å½•åç½®è¿‡æ»¤</span>        http.                authenticationProvider(provider)                .addFilterAfter(filter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;    &#125;&#125;</code></pre><h1 id="æ ‡å‡†æˆæƒç æ¨¡å¼"><a href="#æ ‡å‡†æˆæƒç æ¨¡å¼" class="headerlink" title="æ ‡å‡†æˆæƒç æ¨¡å¼"></a>æ ‡å‡†æˆæƒç æ¨¡å¼</h1><p>ç°åœ¨å…ˆæ¥çœ‹ä¸‹ä»€ä¹ˆéƒ½ä¸åšçš„æ•ˆæœï¼Œä¸è¿‡ç°åœ¨ç”±äºæ²¡æ³•æ‹¿åˆ°æˆæƒç ï¼Œåœ¨è¿™é‡Œæˆ‘æŠŠmcr-demoæ¨¡å—ä¸­ä¾èµ–çš„appå…ˆæ”¹ä¸ºbrowserï¼Œåœ¨è·å–æˆæƒç çš„åœ°æ–¹æ‰“ä¸Šæ–­ç‚¹ï¼Œç„¶åè¿›è¡ŒQQç™»å½•çš„æ“ä½œï¼Œæ‹¿åˆ°æˆæƒç åœ¨åˆ‡æ¢å›ä½¿ç”¨appä¾èµ–ï¼Œå°†æˆæƒç è¾“å…¥ä¸Šå»</p><p> æ–­ç‚¹ä½ç½®ï¼š</p><p>OAuth2AuthenticationServiceçš„98è¡Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567850144540.png" srcset="/img/loading.gif" alt="1567850144540"></p><p>ç„¶åè¿›è¡ŒQQç™»å½•æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™åœ¨IDEä¸­å°±èƒ½çœ‹åˆ°æˆæƒç çš„å€¼äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567850994429.png" srcset="/img/loading.gif" alt="1567850994429"></p><p>è¿™é‡Œä¸è¦æŠŠæ–­ç‚¹æ”¾èµ°ï¼Œå°†è¿™é‡Œçš„æˆæƒç å¤åˆ¶å‡ºæ¥ï¼Œç„¶åæŠŠmcr-demoæ¨¡å—ä¸­çš„browseråˆ‡æ¢å›appï¼Œè¿›è¡Œé‡å¯</p><hr><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 5.é‡æ„çŸ­ä¿¡ç™»å½•</title>
    <link href="/spring-security-5.5.html"/>
    <url>/spring-security-5.5.html</url>
    
    <content type="html"><![CDATA[<p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567834291046.png" srcset="/img/loading.gif" alt="1567834291046"></p><p>appçš„çŸ­ä¿¡éªŒè¯ç ç™»å½•å’Œbrowserçš„æœ‰æ‰€ä¸åŒï¼Œå°±æ˜¯ç°åœ¨åœ¨appæ¨¡å—ä¸­æ˜¯ä¸èƒ½ä½¿ç”¨sessionï¼Œé‚£ä¹ˆå°±ä»¥ä¸ºç€ç”Ÿæˆçš„å®é™…éªŒè¯ç æ— æ³•å­˜å‚¨èµ·æ¥ï¼Œè¿™é‡Œæˆ‘ä»¬è¿›è¡Œé‡æ„ï¼Œå°†ä¹‹å‰çš„sessionæ”¹ä¸ºä½¿ç”¨redisæ¥è¿›è¡Œå­˜å‚¨ï¼Œè€Œåœ¨browserä¸‹é¢è¿˜æ˜¯ä½¿ç”¨sessionå­˜å‚¨ã€‚</p><hr><p>åŠ å…¥ä¹‹å‰å†™å¥½çš„è¿‡æ»¤å™¨å’ŒéªŒè¯ç é…ç½®ï¼Œ McrResourceServerConfig</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> SmsCodeAuthenticationSecurityConfig smsCodeAuthenticationSecurityConfig;<span class="hljs-keyword">private</span> ValidateCodeFilter validateCodeFilter;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    http            .addFilterBefore(validateCodeFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">            .<span class="hljs-title">apply</span>(<span class="hljs-title">smsCodeAuthenticationSecurityConfig</span>)</span><span class="hljs-class">            .<span class="hljs-title">and</span>()</span></code></pre><p>å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ¥è´Ÿè´£ç®¡ç†éªŒè¯ç çš„å­˜å‚¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ValidateCodeDTO;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-comment">/**</span><span class="hljs-comment"> * éªŒè¯ç å­˜å‚¨æ¥å£</span><span class="hljs-comment"> * (é€‚é…æµè§ˆå™¨å’Œapp)</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ValidateCodeRepository</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¿å­˜éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeDTO code, ValidateCodeType validateCodeType)</span></span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-function">ValidateCodeDTO <span class="hljs-title">get</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span></span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç§»é™¤éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">remove</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span></span>;&#125;</code></pre><p>åœ¨appæ¨¡å—ä¸‹é¢ï¼Œé€šè¿‡redisè¿›è¡Œç®¡ç†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.validate.code;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ValidateCodeDTO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeException;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeRepository;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeType;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.data.redis.core.RedisTemplate;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-keyword">import</span> javax.annotation.Resource;<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<span class="hljs-comment">/**</span><span class="hljs-comment"> * rediså­˜å‚¨éªŒè¯ç </span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisValidateCodeRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeRepository</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> RedisTemplate&lt;Object, Object&gt; redisTemplate;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯ç æ”¾å…¥redisè§„åˆ™æ¨¡å¼ï¼šCODE_&#123;TYPE&#125;_&#123;DEVICEId&#125;</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String CODE_KEY_PATTERN = <span class="hljs-string">"CODE_%s_%s"</span>;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeDTO code, ValidateCodeType validateCodeType)</span> </span>&#123;        redisTemplate.opsForValue().set(buildKey(request, validateCodeType), code, <span class="hljs-number">180</span>, TimeUnit.MINUTES);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeDTO <span class="hljs-title">get</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;        String key = buildKey(request, validateCodeType);        <span class="hljs-comment">// æ‹¿åˆ°åˆ›å»º create() å­˜å‚¨åˆ°sessionçš„codeéªŒè¯ç å¯¹è±¡</span>        <span class="hljs-keyword">return</span> (ValidateCodeDTO) redisTemplate.opsForValue().get(key);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">remove</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;        String key = buildKey(request, validateCodeType);        redisTemplate.delete(key);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ„å»ºéªŒè¯ç æ”¾å…¥redisæ—¶çš„key; åœ¨ä¿å­˜çš„æ—¶å€™ä¹Ÿä½¿ç”¨è¯¥key</span><span class="hljs-comment">     *</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">buildKey</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;        String deviceId = request.getHeader(<span class="hljs-string">"deviceId"</span>);        <span class="hljs-keyword">if</span> (StringUtils.isBlank(deviceId)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"è¯·åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦deviceIdå‚æ•°"</span>);        &#125;        <span class="hljs-keyword">return</span> String.format(CODE_KEY_PATTERN, validateCodeType, deviceId);    &#125;&#125;</code></pre><p>åœ¨browserä¸­åˆ™ä½¿ç”¨sessinç®¡ç†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.validate.code;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ValidateCodeDTO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeRepository;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeType;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.HttpSessionSessionStrategy;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.SessionStrategy;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-comment">/**</span><span class="hljs-comment"> * sessionå­˜å‚¨å®ç°</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SessionValidateCodeRepository</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeRepository</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ“ä½œsessionçš„å·¥å…·ç±»</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯ç æ”¾å…¥sessionçš„æ—¶å€™å‰ç¼€</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">static</span> String SESSION_KEY_PREFIX = <span class="hljs-string">"SESSION_KEY_FOR_CODE"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¿å­˜éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeDTO code, ValidateCodeType validateCodeType)</span> </span>&#123;        sessionStrategy.setAttribute(request, getSessionKey(validateCodeType), code);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeDTO <span class="hljs-title">get</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;        String sessionKey = getSessionKey(validateCodeType);        <span class="hljs-comment">// æ‹¿åˆ°åˆ›å»º create() å­˜å‚¨åˆ°sessionçš„codeéªŒè¯ç å¯¹è±¡</span>        <span class="hljs-keyword">return</span> (ValidateCodeDTO) sessionStrategy.getAttribute(request, sessionKey);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç§»é™¤éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">remove</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeType validateCodeType)</span> </span>&#123;        sessionStrategy.removeAttribute(request, getSessionKey(validateCodeType));    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ„å»ºéªŒè¯ç æ”¾å…¥sessionæ—¶çš„key; åœ¨ä¿å­˜çš„æ—¶å€™ä¹Ÿä½¿ç”¨è¯¥key</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSessionKey</span><span class="hljs-params">(ValidateCodeType validateCodeType)</span> </span>&#123;        <span class="hljs-keyword">return</span> SESSION_KEY_PREFIX + validateCodeType.toString().toUpperCase();    &#125;&#125;</code></pre><p>AbstractValidateCodeProcessor</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.impl;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ImageCodeDTO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ValidateCodeDTO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.*;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.HttpSessionSessionStrategy;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.SessionStrategy;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestBindingException;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestUtils;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractValidateCodeProcessor</span>&lt;<span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ValidateCodeDTO</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeProcessor</span> </span>&#123;       <span class="hljs-keyword">private</span> ValidateCodeRepository validateCodeRepository;     <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;      ...    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”Ÿæˆæ ¡éªŒç </span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> C <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;      <span class="hljs-comment">//...</span>        <span class="hljs-keyword">return</span> (C) validateCodeGenerator.generate(request);    &#125;       <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¿å­˜æ ¡éªŒç </span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, C validateCode)</span> </span>&#123;        ValidateCodeDTO validateCodeDTO = <span class="hljs-keyword">new</span> ValidateCodeDTO(validateCode.getCode(), validateCode.getExpireTime());        validateCodeRepository.save(request, validateCodeDTO, getValidateCodeType());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é€æ ¡éªŒç ï¼Œç”±å­ç±»å®ç°</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(ServletWebRequest request, C validateCode)</span> <span class="hljs-keyword">throws</span> Exception</span>;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        ValidateCodeType processorType = getValidateCodeType();        String sessionKey = getSessionKey();<span class="hljs-comment">//        C codeInSession = (C) sessionStrategy.getAttribute(request, sessionKey);</span>                   <span class="hljs-keyword">if</span> ... <span class="hljs-keyword">if</span> (codeInSession.isExpired()) &#123;            validateCodeRepository.remove(request, getValidateCodeType());            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(processorType + <span class="hljs-string">"éªŒè¯ç å·²è¿‡æœŸ"</span>);        &#125;<span class="hljs-comment">//        sessionStrategy.removeAttribute(request, sessionKey);</span>        validateCodeRepository.remove(request, getValidateCodeType());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ„å»ºéªŒè¯ç æ”¾å…¥sessionæ—¶çš„key</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSessionKey</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> SESSION_KEY_PREFIX + getValidateCodeType().toString().toUpperCase();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ ¹æ®è¯·æ±‚çš„urlè·å–æ ¡éªŒç çš„ç±»å‹</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> ValidateCodeType <span class="hljs-title">getValidateCodeType</span><span class="hljs-params">()</span> </span>&#123;        String type = StringUtils.substringBefore(getClass().getSimpleName(), <span class="hljs-string">"CodeProcessor"</span>);        <span class="hljs-keyword">return</span> ValidateCodeType.valueOf(type.toUpperCase());    &#125;&#125;</code></pre><p>ç°åœ¨æ¥é€šè¿‡å·¥å…·è·å–çŸ­ä¿¡éªŒè¯ç ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567838325205.png" srcset="/img/loading.gif" alt="1567838325205"></p><p>è¿™é‡Œéœ€è¦åŠ å…¥deviceIdå¤´ä¿¡æ¯</p><hr><p>å‘é€çŸ­ä¿¡ç™»å½•è¯·æ±‚ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567838526854.png" srcset="/img/loading.gif" alt="1567838526854"></p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 4.é‡æ„ç”¨æˆ·å¯†ç ç™»å½•</title>
    <link href="/spring-security-5.4.html"/>
    <url>/spring-security-5.4.html</url>
    
    <content type="html"><![CDATA[<p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1234345624623dsafasfd.png" srcset="/img/loading.gif" alt="1234345624623dsafasfd"></p><p>åœ¨æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ï¼Œè‡ªå·±å†™çš„ç™»å½•æµç¨‹ï¼Œéœ€è¦å€ŸåŠ©å›¾ä¸­çš„ä»£ç çš„è¯ï¼Œé¦–å…ˆä»TokenEndpointåˆ°TokenGranterï¼Œè¿™äº›ä»£ç æ˜¯æˆ‘ä»¬ä¸èƒ½ç”¨çš„ï¼Œè¿™æ˜¯å‘è·å–ä»¤ç‰Œçš„è¯·æ±‚ï¼Œè€Œæˆ‘ä»¬è¦å‘ç™»å½•çš„è¯·æ±‚ï¼Œæˆ‘ä»¬è¦ç”¨è‡ªå·±çš„è¿‡æ»¤å™¨å»å¤„ç†ç™»å½•è¯·æ±‚ï¼Œä¸€ç›´åˆ°4ç§æˆæƒæ¨¡å¼ç”Ÿæˆä»¤ç‰Œè¿™äº›é€»è¾‘æˆ‘ä»¬éƒ½æ˜¯ä¸èƒ½ç”¨çš„ã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/adsfasdfweroiqwyeuryqowe.png" srcset="/img/loading.gif" alt="adsfasdfweroiqwyeuryqowe"></p><p>æˆ‘ä»¬è¦ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬è¦ç”¨çš„æ˜¯æ˜¯AuthorizationServerTokenServicesï¼Œå®ƒæ¥äº§ç”Ÿä»¤ç‰Œï¼Œåœ¨å“ªé‡Œç”¨å®ƒï¼Ÿåœ¨æˆ‘ä»¬è‡ªå·±å†™åˆ°AuthenticationSuccessHandlerå®ç°ç±»é‡Œï¼Œä¸ç®¡ä½ çš„ç™»å½•è¯·æ±‚æ˜¯ä»€ä¹ˆï¼Œä¸ç®¡è¢«å“ªä¸ªè¿‡æ»¤å™¨æ¥æ‹¦æˆªï¼Œä¸ç®¡ç»å†äº†ä»€ä¹ˆç™»å½•é€»è¾‘çš„å¤„ç†ï¼Œæœ€ç»ˆå½“ç”¨æˆ·ç™»å½•æˆåŠŸä»¥åï¼Œå®ƒéƒ½ä¼šäº¤åˆ°ä¸€ä¸ªAuthenticationSuccessHandleræ¥å£çš„å®ç°é‡Œé¢å»åšä¸€ä¸ªå¤„ç†ï¼Œæˆ‘ä»¬è¦åšçš„äº‹æƒ…æ˜¯ä»€ä¹ˆï¼Ÿè¦åšçš„å°±æ˜¯åœ¨è¿™ä¸ªæ¥å£çš„å®ç°é‡Œé¢å»è°ƒAuthorizationServerTokenServicesï¼Œç„¶åå»äº§ç”Ÿä»¤ç‰Œå“åº”å‡ºå»ã€‚ä¹‹å‰æˆ‘ä»¬åœ¨åšè¿™ä¸ªæµè§ˆå™¨æ¨¡å—ä¸­å†™è¿‡ä¸€ä¸ªMcrAuthenticationSuccessHandlerï¼Œè¿”å›ç»™å‰ç«¯ä¸€ä¸ªjsonæ•°æ®</p><p>ï¼Œè¿™é‡Œè¦æ”¹æˆä½¿ç”¨AuthorizationServerTokenServicesæ¥ç”Ÿæˆä»¤ç‰Œï¼Œä¸Šä¸€ç« é‡Œè¯´è¿‡ï¼Œè¦é€šè¿‡å®ƒç”Ÿæˆä»¤ç‰Œï¼Œéœ€è¦ä¼ çš„å‚æ•°æ˜¯OAuth2Authenticationï¼Œè¦æƒ³ç”ŸæˆOAuth2Authenticationï¼Œè¿˜éœ€è¦OAuth2Requestã€Authenticationï¼Œæˆ‘ä»¬ä¹‹å‰åœ¨spring security oauthé‡Œé¢å®ƒæ˜¯é€šè¿‡ä¸åŒçš„æˆæƒæ¨¡å¼ç„¶åæ ¹æ®æˆæƒæ¨¡å¼ä¼ çš„å‚æ•°ï¼Œæ¥æ„å»ºå‡ºAuthenticationæ¥çš„ï¼Œåœ¨æˆ‘ä»¬çš„åœºæ™¯ï¼Œç»è¿‡å‰é¢çš„ç™»å½•é€»è¾‘å¤„ç†ï¼Œæœ€åè¿›åˆ°AuthenticationSuccessHandlerçš„æ—¶å€™ï¼Œå®ƒçš„onAuthenticationSuccessæ–¹æ³•å‚æ•°ä¸­å°±æœ‰ä¸€ä¸ªç»„è£…å¥½çš„Authenticationï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬ä»£ç é‡Œé¢æ˜¯ä¸éœ€è¦å¤„ç†Authenticationå®ƒçš„ä¸€ä¸ªåˆ›å»ºè¿‡ç¨‹çš„ï¼Œå› ä¸ºå®ƒåœ¨ä¹‹å‰ç™»å½•çš„è¿‡ç¨‹å·²ç»åˆ›å»ºå¥½äº†ï¼Œæœ€ç»ˆå°±å˜æˆéœ€è¦å¤„ç†OAuth2Requestï¼Œå¦‚æœèƒ½æŠŠè¿™ä¸ªä¸œè¥¿æ„å»ºå‡ºæ¥ï¼Œé‚£ä¹ˆé‚£è¿™2ä¸ªå¯¹è±¡å°±èƒ½æ„å»ºå‡ºOAuth2Authenticationï¼Œæœ‰äº†OAuth2Authenticationå°±èƒ½é€šè¿‡AuthorizationServerTokenServicesæ„å»ºå‡ºOAuth2AccessTokenæ¥ã€‚</p><p>OAuth2Requestå¦‚ä½•æ„å»ºï¼Ÿ</p><p>é€šè¿‡ClientDetailsï¼šç¬¬ä¸‰æ–¹å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œè¿˜æœ‰ä¸€ä¸ªTokenRequestï¼šå½“å‰æ‹¿tokenè¯·æ±‚é‡Œé¢ä¸€äº›å‚æ•°çš„ä¿¡æ¯ï¼Œé€šè¿‡2ä¸¤ä¸ªç±»æ‹¼æˆä¸€ä¸ªOAuth2Request</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567685551563.png" srcset="/img/loading.gif" alt="1567685551563"></p><p>ClientDetailsä»æ¥å“ªæ¥çš„å‘¢ï¼Ÿ</p><p>æ˜¯ä»ClientDetailsServiceè¯»å‡ºæ¥çš„ï¼Œè¿™ä¸ªClientDetailsServiceæ¥å—ä¸€ä¸ªClientIdï¼Œç„¶åè¿”å›ä¸€ä¸ªClientDetailsï¼Œé‚£ä¹ˆClientIdä»å“ªæ¥ï¼Ÿâ€”â€”ä»è¯·æ±‚å‚æ•°é‡Œæ¥ï¼Œç¬¬ä¸‰æ–¹å‘è¯·æ±‚çš„æ—¶å€™ï¼Œè¦æŠŠClientIdå’ŒClientSecretåšä¸€ä¸ªBase64ç¼–ç æ”¾åˆ°è¯·æ±‚å¤´é‡Œé¢</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567685682407.png" srcset="/img/loading.gif" alt="1567685682407"></p><p>ç„¶åé€šè¿‡è§£æè¿™ä¸ªBase64çš„ä¸²æ¥æ‹¿åˆ°ClientIdï¼Œæœ‰ClientIdä»¥åå°±èƒ½æ‹¿åˆ°ClientDetails</p><p>TokenRequestæ€ä¹ˆæ¥çš„ï¼Ÿ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567685847409.png" srcset="/img/loading.gif" alt="1567685847409"></p><p>å®ƒæ˜¯å®ä¾‹åŒ–å‡ºæ¥çš„ï¼Œé€šè¿‡ClientDetailsä¸€äº›å±æ€§ï¼Œå’Œè¯·æ±‚å‚æ•°ä¸­çš„ä¸€äº›å±æ€§ç›´æ¥å®ä¾‹åŒ–å‡ºæ¥çš„</p><hr><ol><li>å†™ä»£ç çš„ä½ç½®åœ¨McrAuthenticationSuccessHandleré‡Œ</li><li>æœ€ç»ˆçš„ç›®æ ‡æ˜¯è·å–ä¸€ä¸ªAccessTokenï¼Œé‚£ä¹ˆå°±éœ€è¦å…ˆè·å–åˆ°ClientDetailså’ŒTokenRequestï¼Œæ‰€ä»¥è¦å…ˆä»ClientIdå…¥æ‰‹ï¼Œæ•´ä¸ªæ€è·¯</li></ol><p>ä¸‹é¢æ¥å¼€å§‹å†™ä»£ç </p><p>é¦–å…ˆè¦è·å–ClientIdï¼Œå°±è¦ä»è¯·æ±‚å¤´çš„Authorizationä¸­çš„Base64å­—èŠ‚ç è¿›è¡Œè§£æï¼Œè¿™é‡Œçš„è§£æé€»è¾‘åœ¨BasicAuthenticationFilterä¸­æœ‰ç°æˆçš„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567686175081.png" srcset="/img/loading.gif" alt="1567686175081"></p><p>ï¼Œè¿™é‡Œè·å–çš„usernameå°±æ˜¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567686228018.png" srcset="/img/loading.gif" alt="1567686228018"></p><hr><p>æˆåŠŸå¤„ç†å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.authentication;<span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationSuccessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SavedRequestAwareAuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-keyword">private</span> ClientDetailsService clientDetailsService;    <span class="hljs-keyword">private</span> AuthorizationServerTokenServices authorizationServerTokenServices;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        String header = request.getHeader(<span class="hljs-string">"Authorization"</span>);        <span class="hljs-keyword">if</span> (header == <span class="hljs-keyword">null</span> || !header.startsWith(<span class="hljs-string">"Basic "</span>)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnapprovedClientAuthenticationException(<span class="hljs-string">"è¯·æ±‚å¤´æ— Clientä¿¡æ¯"</span>);        &#125;        String[] tokens = extractAndDecodeHeader(header);        <span class="hljs-keyword">assert</span> tokens.length == <span class="hljs-number">2</span>;        String clientId = tokens[<span class="hljs-number">0</span>];        String clientSecret = tokens[<span class="hljs-number">1</span>];        ClientDetails clientDetails = clientDetailsService.loadClientByClientId(clientId);        <span class="hljs-keyword">if</span> (clientDetails == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnapprovedClientAuthenticationException(<span class="hljs-string">"clientIdå¯¹åº”çš„é…ç½®ä¿¡æ¯ä¸å­˜åœ¨"</span> + clientId);        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!StringUtils.equals(clientDetails.getClientSecret(), clientSecret)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UnapprovedClientAuthenticationException(<span class="hljs-string">"clientSecretä¸åŒ¹é…"</span> + clientId);        &#125;        TokenRequest tokenRequest = <span class="hljs-keyword">new</span> TokenRequest(MapUtils.EMPTY_MAP, clientId, clientDetails.getScope(), <span class="hljs-string">"custom"</span>);        OAuth2Request oAuth2Request = tokenRequest.createOAuth2Request(clientDetails);        OAuth2Authentication oAuth2Authentication = <span class="hljs-keyword">new</span> OAuth2Authentication(oAuth2Request, authentication);        OAuth2AccessToken accessToken = authorizationServerTokenServices.createAccessToken(oAuth2Authentication);        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);        response.getWriter().write(objectMapper.writeValueAsString(accessToken));    &#125;    <span class="hljs-keyword">private</span> String[] extractAndDecodeHeader(String header)            <span class="hljs-keyword">throws</span> IOException &#123;        <span class="hljs-keyword">byte</span>[] base64Token = header.substring(<span class="hljs-number">6</span>).getBytes(StandardCharsets.UTF_8);        <span class="hljs-keyword">byte</span>[] decoded;        <span class="hljs-keyword">try</span> &#123;            decoded = Base64.decode(base64Token);        &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException e) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(                    <span class="hljs-string">"Failed to decode basic authentication token"</span>);        &#125;        <span class="hljs-comment">//ç”¨æˆ·å+â€œï¼šâ€+å¯†ç ç»„æˆçš„</span>        String token = <span class="hljs-keyword">new</span> String(decoded, StandardCharsets.UTF_8);        <span class="hljs-comment">//æ‹¿åˆ°ä»¥åå®ƒä¼šæ‰¾ä¸Šé¢å­—ç¬¦ä¸²â€œ:â€çš„ä½ç½®</span>        <span class="hljs-keyword">int</span> delim = token.indexOf(<span class="hljs-string">":"</span>);        <span class="hljs-comment">//å¦‚æœæ²¡æ‰¾åˆ°å°±æŠ›å‡ºå¼‚å¸¸</span>        <span class="hljs-keyword">if</span> (delim == -<span class="hljs-number">1</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(<span class="hljs-string">"Invalid basic authentication token"</span>);        &#125;        <span class="hljs-comment">//ä»å¼€å§‹ï¼Œåˆ°å†’å·çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è·å–äº†ç”¨æˆ·åï¼Œä»å†’å·å¾€åä¹Ÿå°±æ˜¯å¯†ç ï¼ŒæŠŠè¿™2æ®µæ”¾åˆ°springæ•°ç»„è¿”å›</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String[]&#123;token.substring(<span class="hljs-number">0</span>, delim), token.substring(delim + <span class="hljs-number">1</span>)&#125;;    &#125;&#125;</code></pre><p>McrResourceServerConfig</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableResourceServer</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrResourceServerConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ResourceServerConfigurerAdapter</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http                .formLogin()                .successHandler(authenticationSuccessHandler)                .failureHandler(authenticationFailureHandler)                .loginPage(SecurityConstants.DEFAULT_UNAUTHENTICATED_URL)                .loginProcessingUrl(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM)                .and()                .authorizeRequests()                .antMatchers(                        SecurityConstants.DEFAULT_UNAUTHENTICATED_URL,                        SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="hljs-string">"/*"</span>                ).permitAll()                .anyRequest()                .authenticated()                .and()                .csrf()                .disable();    &#125;&#125;</code></pre><p>ç°åœ¨æ¥è®¿é—®<code>/authentication/form</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567691286732.png" srcset="/img/loading.gif" alt="1567691286732"></p><p>è¿™é‡Œå’Œè¡¨å•ç™»å½•çš„å·®åˆ«åœ¨äºè¯·æ±‚å¤´ä¸Šéœ€è¦å¸¦ä¸Š<code>Authorization</code></p><hr><p>è®¿é—®å—ä¿æŠ¤çš„<code>rest api</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567691505306.png" srcset="/img/loading.gif" alt="1567691505306"></p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 3.Spring Security OAuthæ ¸å¿ƒæºç è§£æ</title>
    <link href="/spring-security-5.3.html"/>
    <url>/spring-security-5.3.html</url>
    
    <content type="html"><![CDATA[<p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567511400096.png" srcset="/img/loading.gif" alt=""></p><p>ä¸Šä¸€ç« é€šè¿‡2ä¸ªæ³¨è§£å®ç°äº†OAuth2æ ‡å‡†çš„4ç§æˆæƒæ¨¡å¼ï¼Œä¹‹å‰æåˆ°è¿‡ï¼Œè¿™4ç§æˆæƒæ¨¡å¼åœ¨å®é™…ä¸šåŠ¡åœºæ™¯æ˜¯ä¸èƒ½ç”¨çš„ï¼Œæ¯”å¦‚è¯´æ‰‹æœºå·ç +éªŒè¯ç ç™»å½•è¿™ç§ï¼Œåé¢ç¬”è€…ä¼šå¸¦ç€å¤§å®¶å»ç”¨æˆ‘ä»¬ä¹‹å‰çš„ä»£ç å»å«æ¥åˆ°è¿™å†™æˆæƒç æ¨¡å¼ä¸­ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œç¬”è€…ä¼šå¸¦ç€å¤§å®¶æ¥è¯»ä¸€åº¦æºç </p><hr><h1 id="æµç¨‹"><a href="#æµç¨‹" class="headerlink" title="æµç¨‹"></a>æµç¨‹</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1234345624623dsafasfd.png" srcset="/img/loading.gif" alt=""></p><blockquote><p>è¿™é‡Œç»¿è‰²çš„æ–¹å—ä»£è¡¨å®ä½“ç±»ï¼Œè“è‰²çš„æ–¹å—è¡¨ç¤ºæ¥å£ï¼Œæ¥å£ä¸­çš„æ‹¬å·è¡¨ç¤ºå®é™…ä¸Šä½¿ç”¨çš„å®ç°ç±»</p></blockquote><p>TokenEndpointï¼šå®ƒæ˜¯æ•´ä¸ªæµç¨‹çš„å…¥å£ç‚¹ï¼Œå¯ä»¥ç†è§£æˆcontrollerï¼Œå®ƒæ¥å¤„ç†è·å–ä»¤ç‰Œçš„è¯·æ±‚ï¼Œå®ƒçš„postAccessTokenæ–¹æ³•æ˜¯ä¸€ä¸ªpostè¯·æ±‚ï¼Œåœ°å€ä¸º/oauth/tokenï¼Œå°±æ˜¯ä¹‹å‰è·å–tokençš„é‚£ä¸ªåœ°å€</p><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">"/oauth/token"</span>, method=RequestMethod.POST)<span class="hljs-function"><span class="hljs-keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="hljs-title">postAccessToken</span><span class="hljs-params">(Principal principal, @RequestParam</span></span><span class="hljs-function"><span class="hljs-params">Map&lt;String, String&gt; parameters)</span> <span class="hljs-keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;  &#125;</code></pre><p>ClientDetailsServiceï¼šç”¨æ¥è¯»å–ç¬¬ä¸‰æ–¹åº”ç”¨çš„ä¿¡æ¯çš„ï¼Œä¹‹å‰å‘è¯·æ±‚çš„æ—¶å€™éƒ½ä¼šå¸¦ä¸€ä¸ªclientIdå’ŒclientSecretæ¥å‘Šè¯‰å®ƒæ˜¯å“ªä¸ªåº”ç”¨åœ¨è¯·æ±‚æˆæƒï¼Œè¿™ä¸ªæ¥å£ä¼šæ ¹æ®ç¬¬ä¸‰æ–¹å‘é€çš„clientIdå»è¯»å–ç›¸åº”çš„clientçš„ä¸€äº›é…ç½®ä¿¡æ¯ï¼Œä¾‹å¦‚ä¹‹å‰åœ¨ymlä¸­é…çš„client-idã€client-secretï¼Œå…¶å®è¿˜æœ‰ä¸€äº›ä¿¡æ¯å¯ä»¥é…ç½®</p><hr><p>ClientDetailsï¼šClientDetailsServiceè¯»å‡ºæ¥çš„è¿™äº›é…ç½®ä¿¡æ¯éƒ½ä¼šå†™åˆ°ClientDetailsè¿™ä¸ªå¯¹è±¡çš„é‡Œé¢å»ï¼Œå®ƒå­˜å‚¨çš„ä¿¡æ¯æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨çš„ä¿¡æ¯</p><hr><p>TokenRequestï¼šTokenEndpointä¼šåˆ›å»ºä¸€ä¸ªTokenRequestçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°è£…äº†/oauth/tokenè¯·æ±‚ä¸­å…¶ä»–å‚æ•°çš„ä¿¡æ¯ï¼Œä¾‹å¦‚grant_typeã€codeã€client_idâ€¦è¿™äº›ä¿¡æ¯ï¼Œç„¶åå®ƒä¼šæŠŠClientDetailsä¹ŸåŒæ—¶æ”¾åˆ°TokenRequesté‡Œé¢ï¼Œå› ä¸ºç¬¬ä¸‰æ–¹åº”ç”¨çš„ä¿¡æ¯ä¹Ÿæ˜¯ä»¤ç‰Œè¯·æ±‚çš„ä¸€éƒ¨åˆ†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567600898713.png" srcset="/img/loading.gif" alt="1567600898713"></p><hr><p>TokenGranterï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TokenGranter</span> </span>&#123;<span class="hljs-function">OAuth2AccessToken <span class="hljs-title">grant</span><span class="hljs-params">(String grantType, TokenRequest tokenRequest)</span></span>;&#125;</code></pre><p>åœ¨TokenEndpoint132è¿›è¡Œä½¿ç”¨</p><pre><code class="hljs java">OAuth2AccessToken token = getTokenGranter().grant(tokenRequest.getGrantType(), tokenRequest);</code></pre><p>å®ƒæ˜¯ä»¤ç‰Œæˆæƒè€…ï¼Œåœ¨è¿™ä¸ªæ¥å£å°è£…äº†4ç§æˆæƒæ¨¡å¼å®ç°å’Œåˆ·æ–°ä»¤ç‰Œæˆæƒå®ç°ï¼Œåœ¨è¿™ä¸ªæ¥å£é‡Œé¢ï¼Œå®ƒä¼šæ ¹æ®ç¬¬ä¸‰æ–¹è¯·æ±‚ä¼ ä¸Šæ¥çš„grant_typeå»æŒ‘ä¸€ä¸ªå…·ä½“å®ç°æ¥æ‰§è¡Œä»¤ç‰Œç”Ÿæˆé€»è¾‘ï¼Œä¸ç®¡æ˜¯å“ªä¸ªå®ç°ï¼Œåœ¨ç”Ÿæˆçš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šäº§ç”Ÿ2ä¸ªå¯¹è±¡ï¼š</p><ol><li>OAuth2Requestï¼šè¿™ä¸ªå¯¹è±¡æ˜¯ClientDetailså’ŒTokenRequestå®ƒä»¬çš„ä¿¡æ¯æ•´åˆï¼ŒæŠŠè¿™2ä¸ªå¯¹è±¡æ•´åˆåˆ°ä¸€èµ·ï¼Œå˜ä¸ºæ–°çš„å¯¹è±¡</li><li>Authenticationï¼šè¿™ä¸ªæ¥å£å°è£…äº†ä½ å½“å‰æˆæƒç”¨æˆ·çš„ä¸€äº›ä¿¡æ¯ï¼Œè°åœ¨åšæˆæƒï¼Œè¿™é‡Œå°±æ˜¯åšæˆæƒçš„ç”¨æˆ·çš„ä¿¡æ¯ï¼Œå®ƒé‡Œé¢çš„ä¿¡æ¯æ˜¯é€šè¿‡UserDetailsServiceè¯»å‡ºæ¥çš„</li></ol><hr><p>OAuth2Authenticationï¼šOAuth2Requestå¯¹è±¡å’ŒAuthenticationç»„åˆè€Œæˆï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼šç¬¬ä¸‰æ–¹æˆæƒçš„é‚£ä¸ªç”¨æˆ·æ˜¯å“ªä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç„¶ååœ¨è¯·æ±‚å“ªä¸ªç”¨æˆ·ç»™ä½ æˆæƒï¼Œç”¨çš„æˆæƒæ¨¡å¼æ˜¯ä»€ä¹ˆï¼Œæˆæƒçš„å‚æ•°æ˜¯ä»€ä¹ˆ</p><hr><p>AuthorizationServerTokenServicesï¼šOAuth2Authenticationä¼šä¼ ç»™AuthorizationServerTokenServicesæ¥å£çš„å®ç°ï¼Œè¿™ä¸ªæ¥å£æ˜¯è®¤è¯æœåŠ¡å™¨çš„ä»¤ç‰ŒæœåŠ¡ï¼Œå®ƒæ‹¿åˆ°Authenticationä¿¡æ¯ä»¥åï¼Œå®ƒä¼šæœ€ç»ˆç»™ç¬¬ä¸‰æ–¹ç”Ÿæˆä¸€ä¸ªOAuth2Authenticationä»¤ç‰Œã€‚</p><hr><p>DefaultTokenServicesï¼šå®ƒæ˜¯AuthorizationServerTokenServicesæ¥å£çš„é»˜è®¤å®ç°ï¼Œå®ƒé‡Œé¢åŒ…å«äº†ï¼š</p><ul><li>TokenStoreï¼šç”¨æ¥å¯¹tokenè¿›è¡Œå­˜å‚¨</li><li>TokenEnhancerï¼šä»¤ç‰Œå¢å¼ºå™¨ï¼Œå½“ä»¤ç‰Œç”Ÿæˆå‡ºä»¥åï¼Œå¯ä»¥å»æ”¹é€ ä»¤ç‰Œ</li></ul><hr><h1 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h1><p>æ–­ç‚¹ä½ç½®ï¼š</p><ul><li>TokenEndpointï¼š95è¡Œ</li></ul><hr><p>è¿™é‡Œä»¥å¯†ç æˆæƒæ¨¡å¼åšæ¼”ç¤ºï¼Œå› ä¸ºå®ƒçš„æ­¥éª¤å°±ä¸€ä¸ªï¼Œä¸åƒæˆæƒç æ¨¡å¼é‚£æ ·è¦2æ­¥ï¼Œ</p><p>ç°åœ¨ä½¿ç”¨å‰é¢ä»‹ç»çš„å·¥å…·æ¥è¿›è¡Œå‘é€</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567602161087.png" srcset="/img/loading.gif" alt="1567602161087"></p><hr><p>TokenEndpoint#postAccessTokenï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567602341977.png" srcset="/img/loading.gif" alt="1567602341977"></p><p>é¦–å…ˆä¼šä»è¯·æ±‚ä¸­è·å–clientIdï¼Œç„¶åé€šè¿‡clientIdå»è°ƒç”¨ClientDetailsService#loadClientByClientIdæ–¹æ³•æ¥è·å–ç¬¬ä¸‰æ–¹åº”ç”¨çš„è¯¦ç»†é…ç½®ï¼Œä¹Ÿå°±æ˜¯ClientDetails</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567602469054.png" srcset="/img/loading.gif" alt="1567602469054"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567602693706.png" srcset="/img/loading.gif" alt="1567602693706"></p><p>åœ¨è¿™é‡Œå¯ä»¥çœ‹åˆ°å®ƒæœ‰å¾ˆå¤šé…ç½®çš„é¡¹ï¼Œç„¶åå°†è¿™ä¸ªClientDetailsï¼Œä»¥åŠç¬¬ä¸‰æ–¹å‘é€çš„å…¶ä»–å‚æ•°ä¼ ç»™OAuth2RequestFactory#createTokenRequestæ–¹æ³•å»è¿”å›ä¸€ä¸ªTokenRequestå¯¹è±¡ï¼Œæ‹¿åˆ°TokenRequestä»¥åï¼Œä¼šå¯¹å®ƒè¿™ä¸ªè¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­</p><pre><code class="hljs java"><span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦ä¼ é€’äº†clientId</span><span class="hljs-keyword">if</span> (clientId != <span class="hljs-keyword">null</span> &amp;&amp; !clientId.equals(<span class="hljs-string">""</span>)) &#123;<span class="hljs-comment">//clientIdæ˜¯ä¸æ˜¯å’Œé…ç½®çš„clientIdæ˜¯å¦åŒ¹é…</span><span class="hljs-keyword">if</span> (!clientId.equals(tokenRequest.getClientId())) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidClientException(<span class="hljs-string">"Given client ID does not match authenticated client"</span>);&#125;&#125;<span class="hljs-keyword">if</span> (authenticatedClient != <span class="hljs-keyword">null</span>) &#123;      <span class="hljs-comment">//æ£€æŸ¥scopeï¼Œæ‰€è°“çš„scopeæ˜¯ç¬¬ä¸‰æ–¹è¯·æ±‚çš„åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œä¹‹å‰è¯´è¿‡clientå¯ä»¥æœ‰å¾ˆå¤šé…ç½®é¡¹ï¼Œå…¶ä¸­å°±æœ‰clientèƒ½å‘å‡ºå»ä»€ä¹ˆæ ·çš„æˆæƒï¼Œå¦‚æœä½ é…äº†çš„è¯ï¼Œå®ƒä¼šå»åšè¿™äº›æ£€æŸ¥ï¼Œç¬¬ä¸‰æ–¹å½“å‰è¯·æ±‚çš„æˆæƒåªèƒ½åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥å‘çš„æˆæƒé›†åˆé‡Œé¢æ‰èƒ½é€šè¿‡è¿™ä¸ªæ ¡éªŒ</span>oAuth2RequestValidator.validateScope(tokenRequest, authenticatedClient);&#125;<span class="hljs-comment">//åˆ¤æ–­GrantTypeæ˜¯å¦æœ‰å€¼ï¼Œ</span><span class="hljs-keyword">if</span> (!StringUtils.hasText(tokenRequest.getGrantType())) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidRequestException(<span class="hljs-string">"Missing grant type"</span>);&#125;<span class="hljs-comment">//å¦‚æœä¼ äº†GrantType,å®ƒè¿™é‡Œä¼šåˆ¤æ–­è¿™ä¸ªGrantTypeæ˜¯ä¸æ˜¯ç®€åŒ–æ¨¡å¼ï¼Œå¦‚æœæ˜¯ç®€åŒ–æ¨¡å¼å®ƒä¼šæŠ›å¼‚å¸¸ï¼Œå› ä¸ºæ‰€è°“çš„ç®€åŒ–æ¨¡å¼å°±æ˜¯æˆæƒç æ¨¡å¼é‡Œçš„ç®€åŒ–ï¼Œåœ¨ç”¨æˆ·åœ¨æˆæƒçš„æ—¶å€™ç›´æ¥æ”¾å›ä»¤ç‰Œï¼Œæ‰€ä»¥åœ¨æˆæƒç æ¨¡å¼é‡Œé¢æ˜¯ä¸ä¼šæœ‰ç¬¬äºŒæ­¥è¯·æ±‚ä»¤ç‰Œè¿™æ ·æœåŠ¡è¢«è°ƒç”¨çš„ï¼Œæ‰€ä»¥ä½ åœ¨è¯·æ±‚ä»¤ç‰Œçš„æ—¶å€™ä¼ çš„æ˜¯ç®€åŒ–æ¨¡å¼ï¼Œè¿™æ˜¯ä¸æ”¯æŒçš„</span><span class="hljs-keyword">if</span> (tokenRequest.getGrantType().equals(<span class="hljs-string">"implicit"</span>)) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidGrantException(<span class="hljs-string">"Implicit grant type not supported from token endpoint"</span>);&#125;<span class="hljs-comment">//åˆ¤æ–­å½“å‰æ˜¯ä¸æ˜¯ä¸€ä¸ªæˆæƒç æ¨¡å¼çš„è¯·æ±‚ï¼Œä¹‹å‰æ¼”ç¤ºä¸­ï¼Œæˆæƒç æ¨¡å¼æ˜¯2æ­¥ï¼Œåœ¨æˆæƒç æ¨¡å¼ä¸­ä½ å‘å‡ºå»çš„ä»¤ç‰Œå®ƒæ‰€åŒ…å«çš„æƒé™scopeä¸æ˜¯åœ¨å‘ä»¤ç‰Œè¿™ä¸ªè¯·æ±‚é‡Œå†³å®šçš„ï¼Œè€Œæ˜¯åœ¨ç»™æˆæƒç é‡Œé¢å†³å®šçš„ï¼Œå°±æ˜¯åœ¨ç”¨æˆ·ç¡®è®¤çš„æ—¶å€™ï¼Œç”¨æˆ·ç¡®è®¤ä¹‹åï¼ŒæœåŠ¡å™¨ä¼šç»™æˆæƒç ï¼Œç”¨æˆ·ç¡®è®¤çš„æ—¶å€™å®ƒä¼šç»™ç¬¬ä¸‰æ–¹è¯»çš„æƒé™ï¼Œç„¶åè¿™ä¸ªä¿¡æ¯åŒ…å«åœ¨æˆæƒç é‡Œé¢ç»™åˆ°ç¬¬ä¸‰æ–¹ï¼Œç¬¬ä¸‰æ–¹åœ¨æ¢è®¿é—®ä»¤ç‰Œçš„æ—¶å€™ï¼Œå®ƒå°±åªèƒ½æ‹¿åˆ°è¯»çš„æƒé™ï¼Œå®ƒä¸èƒ½è¯´æ¢ä»¤ç‰Œçš„æ—¶å€™ï¼Œè‡ªå·±å¸¦ä¸ªå‚æ•°è¯´è¦ä¸€ä¸ªå†™çš„æƒé™ï¼Œè¿™æ˜¯ä¸è®¤çš„ï¼Œæ‰€ä»¥åœ¨æˆæƒç æ¨¡å¼çš„è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ç›´æ¥æŠŠtokené‡Œçš„scopeï¼Œå°±æ˜¯ç¬¬ä¸‰æ–¹æ‰€è¦æ±‚çš„æƒé™ç»™å˜ä¸ºç©ºçš„ï¼Œå®ƒä¼šåœ¨åé¢ä»¥ä½ ä¹‹å‰å‘è¿‡æˆæƒç é‡Œé¢å»æ‰¾ä½ ä¹‹å‰çš„å‘å‡ºå»çš„æˆæƒç ï¼Œç„¶åæ ¹æ®æˆæƒç é‡Œé¢é‡æ–°æŠŠscopeè®¾ä¸Šï¼Œè€Œä¸ä¼šç”¨ä½ è¯·æ±‚ä»¤ç‰Œé‡Œå¸¦çš„scope</span><span class="hljs-keyword">if</span> (isAuthCodeRequest(parameters)) &#123;<span class="hljs-comment">// The scope was requested or determined during the authorization step</span><span class="hljs-keyword">if</span> (!tokenRequest.getScope().isEmpty()) &#123;logger.debug(<span class="hljs-string">"Clearing scope of incoming token request"</span>);tokenRequest.setScope(Collections.&lt;String&gt; emptySet());&#125;&#125;<span class="hljs-comment">//åˆ¤æ–­æ˜¯ä¸æ˜¯åˆ·æ–°ä»¤ç‰Œè¯·æ±‚ï¼Œå› ä¸ºåˆ·æ–°ä»¤ç‰Œå®ƒä¹Ÿæœ‰è‡ªå·±çš„é»˜è®¤çš„scopeï¼Œæ‰€ä»¥åœ¨è¿™é‡Œå¦‚æœæ˜¯åˆ·æ–°ä»¤ç‰Œè¯·æ±‚ï¼Œå®ƒä¼šæŠŠscopeé‡æ–°è®¾ä¸€ä¸‹ </span><span class="hljs-keyword">if</span> (isRefreshTokenRequest(parameters)) &#123;<span class="hljs-comment">// A refresh token has its own default scopes, so we should ignore any added by the factory here.</span>tokenRequest.setScope(OAuth2Utils.parseParameterList(parameters.get(OAuth2Utils.SCOPE)));&#125;</code></pre><p>é€šè¿‡å‰é¢ä¸€ç³»åˆ—æ£€æŸ¥ä»¥åï¼Œæœ€ç»ˆä¼šæŠŠtokenRequestä¼ ç»™TokenGranter#grantæ–¹æ³•æ¥äº§ç”ŸOAuth2AccessTokenå¯¹è±¡ï¼Œç„¶åé€šè¿‡å†…éƒ¨çš„getResponseæ–¹æ³•å“åº”ç»™å‰ç«¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567603732339.png" srcset="/img/loading.gif" alt="1567603732339"></p><hr><p>TokenGranterè¿™ä¸ªæ¥å£åé¢å°è£…äº†4ç§æˆæƒæ¨¡å¼åŠ ä¸Šåˆ·æ–°è¿™ç§æ¨¡å¼ï¼Œä¸€å…±5ä¸ªæ¨¡å¼æ¥äº§ç”ŸAccessTokenï¼Œé‚£ä¹ˆæ¥è¿›å»çœ‹ä¸€ä¸‹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567604010304.png" srcset="/img/loading.gif" alt="1567604010304">ç°åœ¨åœ¨AuthorizationServerEndpointsConfigurer#tokenGranteræ–¹æ³•ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨CompositeTokenGranterä¹Ÿå°±æ˜¯TokenGranterå®ç°ç±»çš„grantæ–¹æ³•</p><hr><p>CompositeTokenGranter#grantï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567604177639.png" srcset="/img/loading.gif" alt="1567604177639"></p><p>è¿™é‡Œå®ƒé€šè¿‡æˆå‘˜å˜é‡tokenGrantersçš„TokenGranteræ³›å‹é›†åˆè¿›è¡Œéå†ï¼Œè¿™é‡Œçš„tokenGrantersçš„sizeä¸º5ï¼Œä¹Ÿå°±æ˜¯è¯´çš„4ç§æˆæƒæ¨¡å¼+åˆ·æ–°æˆæƒï¼Œè¿™é‡Œçš„æ–¹æ³•ä¸­å¯¹è¿™ä¸ªé›†åˆè¿›è¡Œéå†ç„¶åè°ƒç”¨è€…5ä¸ªå®ç°ç±»çš„grantæ–¹æ³•ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567604529494.png" srcset="/img/loading.gif" alt="1567604529494"></p><p>ï¼Œè¿™äº›å®ç°ç±»çš„grantæ–¹æ³•ä¼šæ ¹æ®å‚æ•°ä¸­ä¼ é€’çš„grantTypeçš„å€¼å»åˆ¤æ–­æ˜¯ä¸æ˜¯è¦ç”¨è‡ªå·±çš„æˆæƒæ–¹å¼ï¼Œå¦‚æœä¸æ˜¯åˆ™ç›´æ¥è¿”å›nullï¼Œå¦‚æœæ˜¯åˆ™ç”Ÿæˆç»§ç»­å¾€ä¸‹èµ°</p><hr><p>è¿™é‡Œæ ¹æ®clientIdæ‹¿åˆ°æˆ‘åœ¨ymlä¸­é…ç½®çš„ä¿¡æ¯å°è£…æˆClientDetails</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567604901778.png" srcset="/img/loading.gif" alt="1567604901778"></p><p>ç„¶åå°†é…ç½®ä¿¡æ¯å’ŒgrantTypeä¼ é€’ç»™validateGrantTypeæ–¹æ³•è¿›è¡Œæ ¡éªŒ</p><hr><p>æœ€ç»ˆè¿”å›å€¼æ˜¯è°ƒç”¨äº†ä¸€ä¸ªgetAccessTokenè·å–çš„</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> OAuth2AccessToken <span class="hljs-title">getAccessToken</span><span class="hljs-params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;<span class="hljs-keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));&#125;</code></pre><p>è¿™é‡Œå®é™…ä¸Šè°ƒç”¨äº†AuthorizationServerTokenServicesçš„createAccessTokenæ–¹æ³•ï¼ŒcreateAccessTokenæ–¹æ³•ä¸­éœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œçš„å‚æ•°ç±»å‹ä¸ºOAuth2Authenticationï¼Œè¿™ä¸ªOAuth2Authenticationæ˜¯ç”±5ç§æˆæƒæ¨¡å¼ç”Ÿæˆçš„ï¼Œæˆ‘ç°åœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯å¯†ç æ¨¡å¼ï¼Œé€šè¿‡ç”¨æˆ·åå¯†ç æ¥è·å–å½“å‰æˆæƒç”¨æˆ·çš„ä¿¡æ¯ï¼Œè€Œåœ¨æˆæƒç æ¨¡å¼é‡Œé¢ï¼Œåˆ™è¦é€šè¿‡ç¬¬ä¸€æ­¥å‘å‡ºå»çš„æˆæƒç ï¼Œå‘æˆæƒç çš„æ—¶å€™ï¼Œå®ƒè¿™é‡Œä¼šè®°ä¸‹æ¥è¿™ä¸ªæˆæƒç å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯æ˜¯ä»€ä¹ˆï¼Œç„¶åç¬¬ä¸‰æ–¹æ‹¿è¿™ä¸ªæˆæƒç æ¥æ¢ä»¤ç‰Œçš„æ—¶å€™ï¼Œè¿™é‡Œæ ¹æ®æˆæƒç åœ¨æŠŠä¹‹å‰æˆæƒç å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯è¯»å‡ºæ¥ï¼Œè¿™äº›å¤„ç†é€»è¾‘æ–¹å¼åœ¨ä¸åŒçš„æˆæƒæ¨¡å¼ä¸‹æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™é‡Œçš„getOAuth2Authenticationåœ¨ä¸åŒçš„æˆæƒæ¨¡å¼æœ‰ä¸åŒçš„å®ç°ï¼Œé‚£ä¹ˆç°åœ¨ä¾‹å­ä¸­çš„æ˜¯å¯†ç æ¨¡å¼ä¸€ä¸ªå®ç°ï¼Œ</p><p>ResourceOwnerPasswordTokenGranter#getOAuth2Authentication</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567605829832.png" srcset="/img/loading.gif" alt="1567605829832"></p><p>åœ¨è¿™é‡Œæ ¹æ®è¯·æ±‚å‚æ•°çš„ç”¨æˆ·åå¯†ç å»å®ä¾‹åŒ–äº†ä¸€ä¸ªä¹‹å‰åå¤è¯´çš„UsernamePasswordAuthenticationTokenï¼Œç„¶åä¼ é€’ç»™AuthenticationManagerå»åšè®¤è¯ï¼Œåœ¨è¿™ä¸ªè®¤è¯çš„è¿‡ç¨‹ä¸­ï¼Œå®ƒå®é™…ä¼šè°ƒç”¨æˆ‘ä»¬å†™çš„UserDetailsServiceå®ç°ï¼Œå»æ•°æ®åº“ä¸­çš„ä¿¡æ¯åšè®¤è¯ï¼Œå¦‚æœè®¤è¯é€šè¿‡å°±ä»£è¡¨è¿™é‡Œçš„userAuthè¿™ä¸ªAuthenticationå¯¹è±¡æ˜¯æ­£ç¡®çš„</p><pre><code class="hljs java">OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);</code></pre><p>ç„¶åå°†ClientDetailså’ŒTokenRequeståˆèµ·æ¥åˆ›å»ºä¸€ä¸ªOAuth2Requestï¼Œæ¥çœ‹ä¸€ä¸‹å®ƒæ˜¯æ€ä¹ˆæ‹¼å‡ºæ¥çš„ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨äº†ä¸€ä¸ªcreateOAuth2Requestæ–¹æ³•ï¼ŒæŠŠç¬¬ä¸‰æ–¹åº”ç”¨çš„ä¿¡æ¯ä¼ ç»™å®ƒå°±å¯ä»¥äº†ï¼Œè¿™å—ä»£ç çœ‹ä¸€ä¸‹ï¼Œç­‰ä¼šä¼šæŠŠè¿™äº›ä»£ç æ‹·èµ°ï¼Œç”¨ä¸€äº›ä»£ç è‡ªå·±æ¥ç”Ÿæˆæœ€åçš„token</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> OAuth2Request <span class="hljs-title">createOAuth2Request</span><span class="hljs-params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;<span class="hljs-keyword">return</span> tokenRequest.createOAuth2Request(client);&#125;</code></pre><hr><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> OAuth2AccessToken <span class="hljs-title">getAccessToken</span><span class="hljs-params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;<span class="hljs-keyword">return</span> tokenServices.createAccessToken(getOAuth2Authentication(client, tokenRequest));&#125;</code></pre><p>å‰é¢çš„getAccessTokenæ–¹æ³•æ‰§è¡Œä¸€æ—¦æˆåŠŸäº†è¿”å›çš„OAuth2Authenticationå¯¹è±¡å°±å»åˆ›å»ºäº†ä¸€ä¸ªAccessTokenï¼Œç„¶åå“åº”å‡ºå»ï¼Œæ•´ä¸ªæµç¨‹å°±ç»“æŸäº†</p><hr><p>åœ¨ç»“æŸä¹‹å‰æ¥çœ‹çœ‹DefaultTokenServicesæ˜¯å¦‚ä½•æŠŠAccessTokenç”Ÿæˆå‡ºæ¥çš„</p><p>æ–­ç‚¹ï¼š84è¡Œï¼ŒcreateAccessTokenæ–¹æ³•ä¸­</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567606898774.png" srcset="/img/loading.gif" alt="1567606898774"></p><p>é¦–å…ˆæ–¹æ³•ç¬¬1è¡Œï¼Œå°†authenticationæ”¾å…¥TokenStoreçš„getAccessTokenæ–¹æ³•ä¸­ï¼Œè¿™é‡Œçš„TokenStoreå°±æ˜¯ä¹‹å‰è¯´çš„åŒä¸€ä¸ªç”¨æˆ·ï¼Œå¦‚æœä»¤ç‰Œæ²¡æœ‰è¿‡æœŸï¼Œåœ¨å»æ‹¿å–ä»¤ç‰Œæ—¶å€™å®ƒä¼šæŠŠä¹‹å‰å‘çš„ä»¤ç‰Œå†å‘ç»™ä½ ï¼Œæ‰€ä»¥ä¸€æ¥åˆ°ç¬¬1è¡Œå®ƒä¼šå»æ‰¾ï¼Œå½“å‰çš„ç”¨æˆ·æ˜¯ä¸æ˜¯å‘è¿‡ä»¤ç‰Œï¼Œç„¶ååˆ¤æ–­è¿™ä¸ªä»¤ç‰Œæ˜¯ä¸æ˜¯ç©ºçš„ï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œå°±è¯´æ˜åœ¨è¿™ä¸ªè¯·æ±‚ä¹‹å‰å‘ç»™ä»¤ç‰Œç»™è¿™ä¸ªç”¨æˆ·ï¼Œç„¶ååˆ¤æ–­ä¹‹å‰å‘ç»™ç”¨æˆ·çš„ä»¤ç‰Œæ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå¦‚æœå·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆå°†ä¼šä»TokenStoreæŠŠç›¸åº”çš„RefreshTokenå’ŒAccessTokenå…¨éƒ½åˆ æ‰ï¼Œå¦‚æœæ²¡è¿‡æœŸï¼Œåˆ™é‡æ–°æŠŠä»¤ç‰Œå­˜ä¸‹æ¥ï¼Œå› ä¸ºå¯èƒ½æ˜¯ç”¨å¦ä¸€ç§æ–¹å¼æ¥è®¿é—®è¿™ä¸ªä»¤ç‰Œçš„ï¼Œä¸€å¼€å§‹è¯·æ±‚è¿™ä¸ªä»¤ç‰Œå¯èƒ½æ˜¯æ‹¿æˆæƒç æ¨¡å¼è¯·æ±‚çš„ï¼Œåæ¥åˆç”¨å¯†ç æ¨¡å¼åˆè¯·æ±‚äº†ä¸€æ¬¡ï¼Œè¿™æ—¶å€™å­˜çš„ä¿¡æ¯æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è¿™ä¸ªä»¤ç‰Œæ²¡è¿‡æœŸï¼Œä½†æ˜¯è¿™é‡Œè¿˜æ˜¯ä¼šé‡å†™å­˜ä¸€ä¸‹ï¼Œå¦‚æœå­˜çš„ä»¤ç‰Œä¸è¿‡æœŸçš„è¯ï¼Œé‚£ä¹ˆå°±ç›´æ¥æŠŠè¿™ä¸ªå­˜åœ¨çš„ä»¤ç‰Œåœ¨å‘å›å»ï¼Œé‚£ä¹ˆå¦‚æœè¿‡æœŸäº†æˆ–è€…å®ƒæœ¬èº«å°±æ²¡å‘è¿‡ï¼Œç¬¬ä¸‰æ–¹æ˜¯ç¬¬ä¸€æ¬¡ï¼Œé‚£ä¹ˆå°±ä¼šæ¥ç€å¾€ä¸‹èµ°ï¼š</p><pre><code class="hljs java"><span class="hljs-comment">//çœ‹refreshTokenæœ‰æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰çš„è¯å»ºç«‹ä¸€ä¸ªåˆ·æ–°ä»¤ç‰Œï¼Œç„¶åæ‹¿å–å½“å‰çš„ç”¨æˆ·</span><span class="hljs-keyword">if</span> (refreshToken == <span class="hljs-keyword">null</span>) &#123;refreshToken = createRefreshToken(authentication);&#125;<span class="hljs-comment">// But the refresh token itself might need to be re-issued if it has</span><span class="hljs-comment">// expired.</span><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refreshToken <span class="hljs-keyword">instanceof</span> ExpiringOAuth2RefreshToken) &#123;ExpiringOAuth2RefreshToken expiring = (ExpiringOAuth2RefreshToken) refreshToken;<span class="hljs-keyword">if</span> (System.currentTimeMillis() &gt; expiring.getExpiration().getTime()) &#123;refreshToken = createRefreshToken(authentication);&#125;&#125;<span class="hljs-comment">//è¿™é‡Œå°†authenticationå’ŒrefreshTokenæ‹¼æˆä¸€ä¸ªaccessToken</span>OAuth2AccessToken accessToken = createAccessToken(authentication, refreshToken);tokenStore.storeAccessToken(accessToken, authentication);<span class="hljs-comment">// In case it was modified</span>refreshToken = accessToken.getRefreshToken();<span class="hljs-keyword">if</span> (refreshToken != <span class="hljs-keyword">null</span>) &#123;tokenStore.storeRefreshToken(refreshToken, authentication);&#125;<span class="hljs-keyword">return</span> accessToken;</code></pre><p>accessTokensç”Ÿæˆé€»è¾‘ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> OAuth2AccessToken <span class="hljs-title">createAccessToken</span><span class="hljs-params">(OAuth2Authentication authentication, OAuth2RefreshToken refreshToken)</span> </span>&#123;DefaultOAuth2AccessToken token = <span class="hljs-keyword">new</span> DefaultOAuth2AccessToken(UUID.randomUUID().toString());<span class="hljs-keyword">int</span> validitySeconds = getAccessTokenValiditySeconds(authentication.getOAuth2Request());<span class="hljs-keyword">if</span> (validitySeconds &gt; <span class="hljs-number">0</span>) &#123;token.setExpiration(<span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + (validitySeconds * <span class="hljs-number">1000L</span>)));&#125;token.setRefreshToken(refreshToken);token.setScope(authentication.getOAuth2Request().getScope());<span class="hljs-keyword">return</span> accessTokenEnhancer != <span class="hljs-keyword">null</span> ? accessTokenEnhancer.enhance(token, authentication) : token;&#125;</code></pre><p>è¿™é‡Œé€šè¿‡UUIDå½“åšæ„é€ å‡½æ•°çš„å‚æ•°å®ä¾‹åŒ–ä¸€ä¸ªDefaultOAuth2AccessTokenï¼Œç„¶åæŠŠç›¸åº”çš„åˆ·æ–°ä»¤ç‰Œï¼Œè¿‡æœŸæ—¶é—´ã€scopeè®¾ä¸Šï¼Œç„¶åè°ƒç”¨ä¹‹å‰ä»‹ç»çš„TokenEnhancer#enhanceå¢å¼ºæ–¹æ³•ï¼Œè¿™é‡Œå…ˆåˆ¤æ–­æ˜¯å¦é…äº†</p><p>TokenEnhancerï¼Œå¦‚æœé…ç½®äº†å°±å»æŠŠç”Ÿæˆçš„tokenä¼ è¿›å»ï¼Œè¿™é‡Œå¯ä»¥å¾€tokenåšä¸€äº›è‡ªå®šä¹‰çš„ä¸œè¥¿</p><hr><p>å›åˆ°DefaultTokenServices#createAccessTokenæ–¹æ³•ä¸­</p><pre><code class="hljs java">OAuth2AccessToken accessToken = createAccessToken(authentication, refreshToken);tokenStore.storeAccessToken(accessToken, authentication);<span class="hljs-comment">// In case it was modified</span>refreshToken = accessToken.getRefreshToken();<span class="hljs-keyword">if</span> (refreshToken != <span class="hljs-keyword">null</span>) &#123;tokenStore.storeRefreshToken(refreshToken, authentication);&#125;</code></pre><p>ç”Ÿæˆå®Œä»¤ç‰Œä»¥åï¼Œé€šè¿‡TokenStoreè¿›è¡ŒæŒä¹…åŒ–ï¼Œç„¶åé€šè¿‡è¿”å›çš„ä»¤ç‰Œè·å–refreshTokenï¼Œå¦‚æœrefreshTokenä¸ä¸ºç©ºå†ç”¨TokenStoreæŠŠrefreshTokenå­˜ä¸€ä¸‹ï¼Œç„¶åæŠŠè¿™ä¸ªtokenè¿”å›å›å»ï¼Œè¿™é‡Œå°±æ˜¯ç”Ÿæˆä»¤ç‰Œçš„ä¸€ä¸ªé€»è¾‘ï¼Œè¿™é‡Œæ¶‰åŠåˆ°2ä¸ªä¸œè¥¿ï¼šTokenStoreã€TokenEnhancer</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 2.å®ç°æ ‡å‡†åˆ°OAuthæœåŠ¡å™¨æä¾›å•†</title>
    <link href="/spring-security-5.2.html"/>
    <url>/spring-security-5.2.html</url>
    
    <content type="html"><![CDATA[<p>å› ä¸ºè¿™é‡Œæ˜¯é’ˆå¯¹APPè¿›è¡Œå¼€å‘ï¼Œæ‰€ä»¥ä»£ç å¤§éƒ¨åˆ†æ˜¯æ”¾åˆ°Appæ¨¡å—ä¸­çš„</p><p>é¦–å…ˆå°†demoæ¨¡å—ä¸­pom.xmlä¿®æ”¹æˆä¾èµ–appæ¨¡å—</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-app<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><p>ï¼Œç„¶åå®ƒä¼šé»˜è®¤ä¾èµ–æˆåŠŸã€å¤±è´¥å¤„ç†å™¨ï¼Œæ‰€ä»¥å…ˆå°†åœ¨ä¼šå»browseræ¨¡å—ä¸­å†™çš„å¤„ç†å™¨å¤åˆ¶åˆ°è¿™ä¸ªæ¨¡å—é‡Œé¢ï¼Œç°åœ¨æš‚æ—¶å…ˆè¿™æ ·ï¼Œåé¢å†æ ¹æ®ä¸šåŠ¡é€»è¾‘è¿›è¡Œä¿®æ”¹</p><p>æˆåŠŸå¤„ç†å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.authentication;<span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationSuccessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SavedRequestAwareAuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-keyword">private</span> SecurityProperties security;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        <span class="hljs-keyword">if</span> (security.getBrowser().getLoginType().equals(LoginType.JSON)) &#123;            response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(authentication)));        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">super</span>.onAuthenticationSuccess(request, response, authentication);        &#125;    &#125;&#125;</code></pre><p>å¤±è´¥å¤„ç†å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app.authentication;<span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationFailureHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ExceptionMappingAuthenticationFailureHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-keyword">private</span> SecurityProperties security;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        <span class="hljs-keyword">if</span> (security.getBrowser().getLoginType().equals(LoginType.JSON)) &#123;            response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(exception.getMessage())));        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">super</span>.onAuthenticationFailure(request, response, exception);        &#125;    &#125;&#125;</code></pre><p>è®¤è¯æœåŠ¡å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableAuthorizationServer;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableAuthorizationServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthorizationServerConfig</span> </span>&#123;        &#125;</code></pre><p>åœ¨å¯åŠ¨ä¸­ï¼Œæ§åˆ¶å°ä¸Šä¼šå¤šå‡º/oauth/xxçš„åœ°å€</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567518323763.png" srcset="/img/loading.gif" alt="1567518323763"></p><p>ç°åœ¨æ¥è®¿é—®/oauth/authorizeè·¯å¾„ï¼Œè¿™ä¸ªæ–¹æ³•å®ƒæ˜¯éœ€è¦ä¸€äº›å‚æ•°çš„ï¼Œè¿™é‡Œç¬”è€…æ¥<a href="https://oauth.net/2/" target="_blank" rel="noopener">OAuth2å®˜æ–¹ç½‘</a>ä¸­çœ‹ä¸€ä¸‹å‚æ•°çš„ä»‹ç»ï¼Œåœ¨ç½‘ç«™ä¸­çš„ç¬¬4ç« ã€‚ç°åœ¨æ ¹æ®å®˜æ–¹ç½‘æ¥å¡«å†™å‚æ•°ï¼Œæ¥è®¿é—®ç°åœ¨æ¥è®¿é—®<a href="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=b4c44489-0061-437f-b2c6-5a156251269a&amp;redirect_uri=http://example.com&amp;scope=allï¼Œè¿™é‡Œçš„client_idå†æ§åˆ¶å°ä¸Šæ‰“å°äº†" target="_blank" rel="noopener">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=b4c44489-0061-437f-b2c6-5a156251269a&amp;redirect_uri=http://example.com&amp;scope=allï¼Œè¿™é‡Œçš„client_idå†æ§åˆ¶å°ä¸Šæ‰“å°äº†</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567518956135.png" srcset="/img/loading.gif" alt="1567518956135"></p><p>ç°åœ¨æµè§ˆå™¨ä¸­ä¼šå‡ºç°è¿™ä¸ªå¼¹æ¡†ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567519655298.png" srcset="/img/loading.gif" alt="1567519655298"></p><p>ç°åœ¨æˆ‘è¿™é‡Œæ‰®æ¼”äº†ä¸€ä¸ªæœåŠ¡æä¾›å•†çš„è§’è‰²ï¼Œè¿™é‡Œçš„client_idæ˜¯æä¾›ç»™ç»™ç¬¬ä¸‰æ–¹è®©å®ƒå»å¼•å¯¼ç”¨æˆ·æ¥æˆæƒçš„ï¼Œä½œä¸ºæˆ‘æ¥è¯´æˆ‘éœ€è¦çŸ¥é“ä¸‰ä»¶äº‹ï¼š</p><ul><li>å“ªä¸ªåº”ç”¨åœ¨è¯·æ±‚æˆæƒï¼Œè¿™é‡Œçš„client_idå°±æ˜¯æ¥åŒºåˆ†çš„ï¼Œæ¯ä¸ªåº”ç”¨åœ¨æˆ‘è¿™æ¥æ³¨å†Œæ—¶ï¼Œæˆ‘éƒ½åˆ†ä¸€ä¸ªä¸åŒçš„client_idç»™ä»–ä»¬</li><li>ä½ åœ¨è¯·æ±‚æˆ‘çš„å“ªä¸ªç”¨æˆ·ç»™ä½ æˆæƒï¼Œè¿™é‡Œè¯·æ±‚ä¸Šé¢çš„åœ°å€ä¼šå¼¹å‡ºä¸€ä¸ªbasicå¯¹è¯æ¡†ï¼Œåœ¨è¿™ä¸ªæ¡†ä¸­çš„ç”¨æˆ·åå°±æ˜¯æ¥å‘Šè¯‰æˆ‘ä½ æ˜¯æˆ‘ç³»ç»Ÿä¸­çš„å“ªä¸ªç”¨æˆ·åœ¨æˆæƒ</li><li>ç»™ç¬¬ä¸‰æ–¹ä»€ä¹ˆæˆæƒï¼Œé€šè¿‡åœ°å€ä¸Šé¢çš„scopeå‚æ•°æ¥åŒºåˆ†ï¼Œè¿™ä¸ªå‚æ•°æ˜¯æœåŠ¡å•†è‡ªå·±å®šä¹‰äº†ï¼Œå¯ä»¥å®šä¹‰ä»»æ„çš„å­—ç¬¦ä¸²ï¼Œç„¶åç¬¬ä¸‰æ–¹è¯·æ±‚çš„æ—¶å€™ï¼Œæ ¹æ®è¿™ä¸ªæœåŠ¡æä¾›å•†çš„è§„åˆ™å¸¦ç€å­—ç¬¦ä¸²æ¥å‘Šè¯‰æœåŠ¡æä¾›å•†æˆ‘éœ€è¦ä»€ä¹ˆæ ·çš„æƒé™</li></ul><p>åœ¨è¿™é‡Œçš„å¯¹è¯æ¡†å¡«å†™çš„ç”¨æˆ·åã€å¯†ç æœ€ç»ˆä¼šäº¤ç»™UserDetailsServiceï¼Œç”¨å®ƒå»æ ¡éªŒï¼Œè¿™é‡Œæˆ‘ä»¬ä¹‹å‰å°±å†™è¿‡äº†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security.service;<span class="hljs-meta">@Service</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span>, <span class="hljs-title">SocialUserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;    <span class="hljs-function"><span class="hljs-keyword">private</span> SocialUser <span class="hljs-title">buildUser</span><span class="hljs-params">(String username)</span> </span>&#123;        String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialUser(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        log.info(<span class="hljs-string">"è¡¨å•ç™»å½•ç”¨æˆ·-&gt;&#123;&#125;è¿›è¡Œæ•ˆéªŒ"</span>, username);        <span class="hljs-keyword">return</span> buildUser(username);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SocialUserDetails <span class="hljs-title">loadUserByUserId</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        log.info(<span class="hljs-string">"ç¤¾äº¤ç™»å½•ç”¨æˆ·id-&gt;&#123;&#125;è¿›è¡Œæ•ˆéªŒ"</span>, userId);        <span class="hljs-keyword">return</span> buildUser(userId);    &#125;&#125;</code></pre><p>ä¸Šé¢ä»£ç ä¸­ï¼Œå¯†ç ä¸€å®šè¦æ˜¯123ï¼Œè´¦å·æ˜¯éšä¾¿å¡«çš„ï¼Œåœ¨å¯¹è¯æ¡†ä¸­æŒ‰ç…§è¿™ä¸ªæ¥å¡«ï¼Œç„¶åæµè§ˆå™¨æƒ³æ˜¾ç¤ºçš„å†…å®¹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567519813050.png" srcset="/img/loading.gif" alt="1567519813050"></p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œåœ¨UserDetailsServiceä¸­è¿”å›çš„UserDetailséœ€è¦æœ‰userè¿™æ ·çš„è§’è‰²æ‰è¡Œï¼Œè¿™é‡Œåœ¨McrUserDetailsServiceä¸­ä¿®æ”¹ä¸€ä¸‹</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> SocialUser <span class="hljs-title">buildUser</span><span class="hljs-params">(String username)</span> </span>&#123;     String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);     <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialUser(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin,ROLE_USER"</span>)); &#125;</code></pre><hr><p>ç„¶åé‡å¯ä¸€ä¸‹ï¼Œä½†æ˜¯è¿™é‡Œçš„client_idæ˜¯åœ¨æ§åˆ¶å°å‡ºç°çš„ï¼Œè€Œé‡å¯ä¹‹ååˆä¼šå˜ï¼Œè¿™é‡Œé…ç½®ä¸€ä¸‹yumï¼Œè®©å®ƒå˜æˆä¸€ä¸ªå›ºå®šçš„</p><pre><code class="hljs yml"><span class="hljs-attr">security:</span>  <span class="hljs-attr">oauth2:</span>    <span class="hljs-attr">client:</span>      <span class="hljs-attr">client-id:</span> <span class="hljs-string">mcr</span>      <span class="hljs-attr">client-secret:</span> <span class="hljs-string">mcr</span></code></pre><p>ç°åœ¨è®¿é—®<a href="http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=mcr&amp;redirect_uri=http://example.com&amp;scope=allï¼Œæµè§ˆå™¨æ˜¾ç¤ºï¼š" target="_blank" rel="noopener">http://localhost:8080/oauth/authorize?response_type=code&amp;client_id=mcr&amp;redirect_uri=http://example.com&amp;scope=allï¼Œæµè§ˆå™¨æ˜¾ç¤ºï¼š</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567520336913.png" srcset="/img/loading.gif" alt="1567520336913"></p><p>è¿™åªæ˜¯Oauthæˆæƒçš„é¡µé¢ï¼Œè¿™ç›¸å¯¹äºæˆ‘ä»¬ä¹‹å‰ç”¨QQæˆæƒçœ‹åˆ°çš„é‚£ä¸ªQQçš„é¡µé¢ï¼Œåœ¨è¿™é‡Œå¯ä»¥å†³å®šåŒæ„æˆæƒå’Œæ‹’ç»æˆæƒï¼Œåœ¨è¿™é‡Œå®ƒé—®mcrè¯·æ±‚ä½ ç»™å®ƒallè¿™æ ·çš„æƒé™ï¼Œè¿™é‡Œé€‰æ‹©ç¬¬ä¸€ä¸ªå•é€‰æŒ‰é’®åŒæ„ï¼Œç‚¹å‡»AuthorizeæŒ‰é’®ç¡®è®¤ï¼Œåœ¨è¿™é‡Œå°±ä¼šè·³è½¬åˆ°redirect_uriçš„é¡µé¢ä¸Šå»å¹¶ä¸”åœ¨urlä¸Šå¸¦äº†æˆæƒç ï¼Œè¿™ä¸ªé¡µé¢å¯ä»¥ç†è§£ä¸ºç¬¬ä¸‰æ–¹çš„é¡µé¢ï¼Œå®ƒæ‹¿åˆ°äº†æˆæƒç ä»¥åï¼Œå®ƒåº”è¯¥å»æ‹¿è¿™ä¸ªæˆæƒç æ¥æ¢accessToken</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567521410778.png" srcset="/img/loading.gif" alt="1567521410778"></p><p>æ¢å–è®¤è¯ç éœ€è¦é€šè¿‡postè¯·æ±‚æ–¹å¼è®¿é—®<code>/oauth/token</code>åœ°å€å¹¶å¸¦ä¸Šæˆæƒç å‚æ•°ï¼Œè¿™é‡Œä½¿ç”¨ä¹‹å‰ä»‹ç»çš„ å·¥å…·æˆ–ä½¿ç”¨post manæ¥è®¿é—®è¿™ä¸ªåœ°å€ï¼Œåœ¨è¿™é‡Œçš„è¯·æ±‚å¤´ä¸­éœ€è¦ç»™Authorizationå¡«å†™ä»¥ä¸‹å†…å®¹ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567521606320.png" srcset="/img/loading.gif" alt="1567521606320"></p><p>ç„¶å¼¹å‡ºè¿™ä¸ªï¼ŒUsernameæ ¹æ®åœ¨ymlä¸­é…ç½®çš„client-idé…ç½®ï¼Œå¯†ç æ ¹æ®client-secretçš„é…ç½®ï¼Œæˆ‘åœ¨ymlä¸­è¿™2ä¸ªéƒ½é…çš„æ˜¯mcrï¼Œæ‰€ä»¥å°±éƒ½å¡«mcr</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567521634226.png" srcset="/img/loading.gif" alt="1567521634226"></p><p>ç„¶åæ ¹æ®ä¹‹å‰è¯´çš„OAuth2å®˜æ–¹æ–‡ç« å¡«å†™ç›¸å…³çš„å‚æ•°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567521749036.png" srcset="/img/loading.gif" alt="1567521749036"></p><p>åœ¨è¿™é‡Œé¢å¡«å†™</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567521766712.png" srcset="/img/loading.gif" alt="1567521766712"></p><p>ç„¶åç‚¹å‡»Sendæäº¤ï¼Œå“åº”å‡ºè¿™ä¹ˆä¸€æ®µjson</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"access_token"</span>: <span class="hljs-string">"f776ca27-ee02-4b90-b7ad-0fc2b0d9d539"</span>,<span class="hljs-attr">"token_type"</span>: <span class="hljs-string">"bearer"</span>,<span class="hljs-attr">"refresh_token"</span>: <span class="hljs-string">"df5415e9-5251-43ec-a2cc-74fd3c02d26c"</span>,<span class="hljs-attr">"expires_in"</span>: <span class="hljs-number">43199</span>,<span class="hljs-attr">"scope"</span>: <span class="hljs-string">"all"</span>&#125;</code></pre><p>è¿™æ ·çš„æˆæƒç æ¨¡å¼æˆæƒçš„æµç¨‹å°±èµ°å®Œäº†ï¼Œä¸‹é¢æ¥ä»‹ç»å¯†ç æˆæƒæ¨¡å¼ï¼Œå®ƒè®¿é—®çš„åœ°å€åå‰é¢è®¿é—®çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿæ˜¯<code>/oauth/token</code>ï¼Œè¿™é‡Œçš„è¯·æ±‚å¤´ä¸­ä¹Ÿè¦å¸¦ä¸ŠAuthorizationä¿¡æ¯ï¼Œä½†æ˜¯å®ƒè¿™é‡Œçš„å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567522099570.png" srcset="/img/loading.gif" alt="1567522099570"></p><p>åœ¨å¯†ç æ¨¡å¼ä¸­ï¼Œç”¨æˆ·æ˜¯æŠŠæœåŠ¡æä¾›å•†ä¸Šçš„ç”¨æˆ·åå’Œå¯†ç å‘Šè¯‰ç¬¬ä¸‰æ–¹ï¼Œç„¶åç¬¬ä¸‰æ–¹æ‹¿ç€ç”¨æˆ·åå¯†ç å‘Šè¯‰ä»–çš„ç”¨æˆ·åå¯†ç å»åˆ°æœåŠ¡æä¾›å•†é‚£è¯´ç”¨æˆ·ç»™äº†æˆ‘æˆæƒäº†ï¼Œé‚£ä¹ˆè¿™é‡ŒæœåŠ¡æä¾›å•†æ˜¯æ²¡æ³•åˆ¤æ–­ï¼Œè¿™ç”¨æˆ·åå¯†ç æ˜¯ç”¨æˆ·çœŸæ­£ç»™ä½ çš„è¿˜æ˜¯è‡ªå·±å·çš„ï¼Œåœ¨ä¸€ä¸ªäº’è”ç½‘çš„åœºæ™¯ä¸‹ï¼Œæ¯”å¦‚è¯´æˆ‘å’ŒQQä¹‹é—´ï¼Œé‚£ä¹ˆä½¿ç”¨è¿™ç§æ¨¡å¼æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºQQä¸èƒ½åˆ¤æ–­ä½ çš„ç”¨æˆ·åå¯†ç åˆ°åº•æ˜¯æ€ä¹ˆæ¥çš„ï¼Œä½†æ˜¯åœ¨æˆ‘ä»¬è¿™ä¸ªåœºæ™¯é‡Œï¼Œè¿™ç§æˆæƒæ–¹å¼æ˜¯å¯ç”¨çš„ï¼Œå› ä¸ºåœ¨æˆ‘è¿™ä¸ªåœºæ™¯é‡Œï¼Œæˆ‘æ˜¯æ‰®æ¼”æœåŠ¡æä¾›å•†çš„è§’è‰²ï¼Œè€Œæ‰®æ¼”ç¬¬ä¸‰æ–¹çš„è§’è‰²æ˜¯è‡ªå·±å…¬å¸çš„Appï¼Œæˆ‘ä»¬ä¹‹é—´æ˜¯ä¸€ä¼™çš„ï¼Œæˆ‘æ˜¯å¯ä»¥è®©ç”¨æˆ·æŠŠç”¨æˆ·åå¯†ç å‘Šè¯‰Appï¼Œç„¶åä»–ä»¬æ‹¿ç€ç”¨æˆ·åå¯†ç æ¢tokenï¼Œæ‰€ä»¥è¿™ä¸ªæˆæƒæ¨¡å¼åœ¨è‡ªå·±å…¬å¸çš„appå’Œè‡ªå·±å…¬å¸çš„æœåŠ¡å™¨ä¹‹é—´é‡‡ç”¨è¿™ç§æˆæƒæ¨¡å¼æ¢tokenæ˜¯å¯è¡Œçš„ï¼Œç°åœ¨ä¼šåˆ°å·¥å…·é‡Œï¼Œå‘é€è¯·æ±‚çš„å“åº”ï¼š</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"access_token"</span>: <span class="hljs-string">"f776ca27-ee02-4b90-b7ad-0fc2b0d9d539"</span>,<span class="hljs-attr">"token_type"</span>: <span class="hljs-string">"bearer"</span>,<span class="hljs-attr">"refresh_token"</span>: <span class="hljs-string">"df5415e9-5251-43ec-a2cc-74fd3c02d26c"</span>,<span class="hljs-attr">"expires_in"</span>: <span class="hljs-number">42570</span>,<span class="hljs-attr">"scope"</span>: <span class="hljs-string">"all"</span>&#125;</code></pre><p>è¿™é‡Œçš„access_tokenå’Œä¹‹å‰çš„æˆæƒç æ¨¡å¼æ‹¿åˆ°çš„access_tokenæ˜¯ä¸€æ ·çš„ï¼ŒåŒ…æ‹¬<code>df5415e9-5251-43ec-a2cc-74fd3c02d26c</code>è¿™äº›ï¼Œè™½ç„¶ç”¨çš„æˆæƒæ¨¡å¼ä¸åŒï¼Œä½†æ˜¯æˆ‘ç”¨çš„æ˜¯åŒä¸€ä¸ªç”¨æˆ·ï¼ŒåŒä¸€ä¸ªç”¨æˆ·åå¤å»è¯·æ±‚çš„æ—¶å€™<code>spring security oauth</code>ä¼šåˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯ä¸æ˜¯å‘è¿‡<code>access_token</code>ï¼Œè¿™é‡Œå› ä¸ºåœ¨æˆæƒç æ¨¡å¼ä¸­ä½¿ç”¨rootè´¦å·å‘è¿‡ä¸€ä¸ª<code>/oauth/token</code>ï¼Œç„¶ååœ¨å¯†ç æ¨¡å¼ä¸­å†æ¥è¯·æ±‚<code>/oauth/token</code>ï¼Œå®ƒä»»ç„¶ä¼šæŠŠä¸€æ ·çš„tokenå‘ç»™å®ƒï¼Œåªè¦è¿™ä¸ª<code>token</code>è¿˜æ²¡è¿‡æœŸï¼ŒåŒä¸€ä¸ªç”¨æˆ·æ¥è¯·æ±‚ä»¤ç‰Œæ—¶å€™ï¼Œ<code>spring security oauth</code>ç§ä¼šå‘åŒä¸€ä¸ªä»¤ç‰Œä¸‹å»</p><hr><p>ç°åœ¨ç¬”è€…æ¼”ç¤ºäº†2ç§æˆæƒç æ¨¡å¼ï¼Œå‰©ä¸‹çš„2ç§å°±ä¸æ¼”ç¤ºäº†ï¼Œè¿™é‡Œå®é™…ä¸Šå·²ç»å®ç°äº†4ç§æˆæƒç æ¨¡å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†™çš„ä»£ç åº”è¯¥è¿˜æœ‰å°è±¡ï¼Œå°±åœ¨ä¸€ä¸ªç±»ä¸ŠåŠ äº†ä¸€ä¸ªæ³¨è§£ï¼Œå°±å®Œæˆäº†è¿™äº›åŠŸèƒ½ï¼Œåé¢çš„æ¡ˆä¾‹ä¼šå°†æ€ä¹ˆæ¥åšå®šåˆ¶åŒ–çš„ä¸œè¥¿ï¼Œåœ¨è¿™é‡Œå°±å…ˆç”¨<code>spring security oauth</code>çš„æ ‡å‡†å®ç°</p><hr><p>ç°åœ¨è®¤è¯æœåŠ¡å™¨å·²ç»å®ç°äº†ï¼Œæ¥ä¸‹æ¥å®ç°èµ„æºæœåŠ¡å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.app;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableResourceServer</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrResourceServerConfig</span> </span>&#123;&#125;</code></pre><blockquote><p>å…ˆæ¥æ¥è®¿é—®ä¹‹å‰å†™çš„rest apiï¼š<a href="http://localhost:8080/user/meï¼Œå“åº”å†…å®¹ï¼š" target="_blank" rel="noopener">http://localhost:8080/user/meï¼Œå“åº”å†…å®¹ï¼š</a></p></blockquote><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567523445358.png" srcset="/img/loading.gif" alt="1567523445358"></p><p>åœ¨è¿™é‡Œçš„çŠ¶æ€ç æ˜¯401ï¼Œæ„æ€æ˜¯æ²¡æœ‰åšèº«ä»½è®¤è¯ï¼Œé‚£ä¹ˆè¦åšèº«ä»½è®¤è¯çš„è¯å°±è¦æŠŠåˆšæ‰çš„tokenå¸¦ä¸Šå°±è¡Œäº†ï¼Œä½†æ˜¯ç°åœ¨ä¸èƒ½ç”¨ä¹‹å‰æ‹¿åˆ°çš„tokenï¼Œå› ä¸ºç°åœ¨æ²¡æœ‰é…tokençš„å­˜å‚¨æ¨¡å¼ï¼Œå®é™…ä¸Šé»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯å­˜åœ¨å†…å­˜é‡Œçš„ï¼Œåˆšåˆšå› ä¸ºåŠ äº†ä¸€ä¸ªç±»ï¼Œæˆ‘é‡å¯äº†æœåŠ¡å™¨ï¼Œå†…å­˜ä¸­çš„ä¿¡æ¯éƒ½å·²ç»æ¸…æ‰äº†ï¼Œæ‰€ä»¥è¦é‡æ–°åœ¨è¯·æ±‚ä¸€ä¸‹<code>/oauth/token</code>æ¥è·å–æ–°çš„<code>access_token</code>ï¼Œå°†è¿™ä¸ªä¿¡æ¯å¡«å†™åˆ°è¦è®¿é—®çš„<code>rest api</code>çš„headerä¸­ï¼Œkeyä¸º:Authorizationï¼Œå€¼çš„è¯å…‰æ˜¯ä¸€ä¸ª<code>access_token</code>è¿˜ä¸è¡Œï¼Œå‰é¢è¿˜è¦åŠ ä¸Šè·å–çš„<code>token_type</code>çš„å€¼</p><p>å°±åƒè¿™æ ·ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567523833496.png" srcset="/img/loading.gif" alt="1567523833496"></p><p>ç„¶åå†å»å‘é€ï¼Œå°±èƒ½æ­£å¸¸çš„æ‹¿åˆ°ä¿¡æ¯äº†</p><hr><p>oauthçš„æµç¨‹å‘tokenï¼Œç„¶åç”¨tokenæ¥æ•ˆéªŒèº«ä»½ï¼Œè®¿é—®æœåŠ¡ï¼Œè¿™æ ·ä¸€ä¸ªæµç¨‹å°±å·²ç»èµ°é€šäº†ï¼Œç°åœ¨è™½ç„¶æµç¨‹èµ°é€šäº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ˜¯æŒ‰ç…§oauthåè®®æ ‡å‡†çš„è§„èŒƒå’Œspring securityçš„é»˜è®¤å®ç°æ¥èµ°çš„ï¼Œè¿™é‡Œé¢å­˜åœ¨å¾ˆå¤šé—®é¢˜ï¼Œé¦–å…ˆæˆ‘çš„è®¤è¯æ–¹å¼åªèƒ½æ˜¯oauthåè®®è§„å®šçš„è¿™4ç§æˆæƒæ¨¡å¼ï¼Œæ¯”å¦‚æˆ‘ç°åœ¨æƒ³é€šè¿‡æ‰‹æœºå·ç +çŸ­ä¿¡éªŒè¯ç æ¥ç™»å½•ï¼Œè¾“å…¥è¿™äº›ä¹‹åï¼Œåœ¨æˆ‘ä»¬æœåŠ¡å™¨ä¸­è¿›è¡ŒéªŒè¯ï¼ŒéªŒè¯æˆåŠŸä»¥åï¼Œå‘ä»–ä¸€ä¸ªaccess_tokenï¼Œè¿™ä¸ªåœ¨é»˜è®¤è®¾ç½®å’Œå®ç°é‡Œé¢æˆ‘æ˜¯å®ç°ä¸äº†çš„ï¼Œå…¶ä»–çš„æ¯”å¦‚è¯´ç°åœ¨access_tokenæ˜¯å­˜åœ¨å†…å­˜é‡Œçš„ï¼ŒæœåŠ¡å™¨å·²é‡å¯å°±æ²¡äº†ï¼ŒæœåŠ¡å™¨å‘å‡ºå»çš„tokenå®ƒçš„è¿™ä¸ªæ ·å­æ˜¯éšæœºç”Ÿæˆçš„ä¸²ï¼Œé‚£ä¹ˆèƒ½ä¸èƒ½å»å®šåˆ¶å®ƒï¼Œæ¯”å¦‚ç”¨ç°åœ¨æµè¡Œçš„jwtæ¥åšæˆ‘ä»¬è¿™é‡Œçš„tokenï¼Œç­‰ç­‰ä¸€ç³»åˆ—é—®é¢˜ï¼Œåœ¨åé¢çš„ç« èŠ‚å» ä»‹ç»ç»™å¤§å®¶</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äº”ã€OAuth ã€‘ 1.Spring Security OAuthç®€ä»‹</title>
    <link href="/spring-security-5.1.html"/>
    <url>/spring-security-5.1.html</url>
    
    <content type="html"><![CDATA[<p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567510663145.png" srcset="/img/loading.gif" alt="1567510663145"></p><p>ä¹‹å‰çš„ç™»å½•çš„è®¤è¯ä¿¡æ¯æ˜¯å­˜å‚¨åˆ°<code>session</code>ä¸­çš„ï¼Œç”¨æˆ·é€šè¿‡æµè§ˆå™¨æ¯æ¬¡å»è®¿é—®æœåŠ¡æ—¶ï¼Œæ¯æ¬¡éƒ½ä¼šæ£€æŸ¥æµè§ˆå™¨çš„cookieé‡Œæ˜¯å¦å­˜åœ¨<code>JSessionID</code>ï¼Œå¦‚æœä¸å­˜åœ¨å°±ä¼šåœ¨æœåŠ¡å™¨ä¸Šæ–°å»º<code>session</code>ï¼ŒæŠŠè¿™ä¸ª<code>sesion id</code>å†™åˆ°æµè§ˆå™¨çš„cookieé‡Œï¼Œè¿™æ ·ç”¨æˆ·æ¯æ¬¡é€šè¿‡æµè§ˆå™¨å»å‘è¯·æ±‚çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·æµè§ˆå™¨ä¸­çš„<code>JSessionID</code>æ‰¾åˆ°ç›¸åº”çš„sessionæ‹¿å‡ºæ¥ï¼Œè¿™ä¸ªæ˜¯ä¹‹å‰å¼€å‘ä¸­åŸºäºæœåŠ¡å™¨sessionä¸€ç§ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„ä¸€ç§ç™»å½•æ–¹å¼ï¼Œéšç€æŠ€æœ¯ä¸æ–­å‘å±•ï¼Œä¸€ç§æ–°çš„å‰ç«¯æŠ€æœ¯æ¸ é“å‡ºç°äº†ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„æ‰‹æœºAPPï¼Œé™¤äº†è¿™ç§APPä»¥å¤–ï¼Œæœ¬èº«çš„éƒ¨ç½²æ–¹å¼ä¹Ÿåœ¨æ¼”è¿›ï¼Œç°åœ¨æ¯”è¾ƒæµç¨‹çš„æ–¹å¼ï¼šå‰åç«¯åˆ†ç¦»ï¼Œåœ¨å‰åç«¯åˆ†ç¦»çš„æ—¶å€™ï¼Œhtmlä¸åœ¨å’ŒæœåŠ¡å™¨æ”¾åœ¨ä¸€å—éƒ¨ç½²ï¼Œå®ƒä¼šå•ç‹¬æ”¾åˆ°ä¸€ä¸ªweb serverä¸Šï¼Œåœ¨é‡‡ç”¨å‰ååˆ†ç¦»çš„æ¶æ„çš„æ—¶å€™ï¼Œç”¨æˆ·ç›´æ¥è®¿é—®çš„æ˜¯web serverï¼Œé’ˆå¯¹è¿™ä¸ªhtmlä¸€äº›æ¸²æŸ“ã€ajaxè¯·æ±‚çš„ä¸€äº›å¤„ç†ï¼Œéƒ½æ˜¯ç”±web serveræ¥å®Œæˆï¼Œajaxè¯·æ±‚å‘ç»™web serverä»¥åï¼Œweb serverå†å»è®¿é—®application serveræ¥æ‹¿æ•°æ®ï¼Œä¸ç®¡æ˜¯æ‰‹æœºAPPã€è¿˜æ˜¯å‰åç«¯åˆ†ç¦»å½“æ¶æ„æ¼”å˜æˆè¿™æ ·å­çš„æ—¶å€™ï¼Œä¸€ä¸ªæœ€æ ¹æœ¬çš„å˜åŒ–å‡ºç°äº†ï¼šç”¨æˆ·ä¸åœ¨æ˜¯é€šè¿‡æµè§ˆå™¨ç›´æ¥è®¿é—®æˆ‘ä»¬çš„åº”ç”¨ï¼Œè€Œæ˜¯é€šè¿‡ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œä¾‹å¦‚appã€web serverè®¿é—®æˆ‘ä»¬çš„åº”ç”¨çš„æœåŠ¡å™¨ï¼Œä¸åœ¨æ˜¯æµè§ˆå™¨ï¼Œè€Œæ˜¯ä¸€äº›å…¶ä»–çš„åº”ç”¨ï¼Œè¿™æ—¶å€™åœ¨ä½¿ç”¨ä¹‹å‰çš„cookie sessionçš„æ–¹å¼å°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œé¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œå½“åœ¨å‰ååˆ†ç¦»æ¶æ„ä¸‹ï¼Œæ˜¯å¦èƒ½ç”¨cookie+sesisonè¿™ç§æ–¹å¼ï¼Œç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯å®ƒåœ¨appä¸­ä¼šæœ‰ä¸€äº›é—®é¢˜ï¼š</p><ul><li>å¼€å‘ç¹çï¼šåœ¨æµè§ˆå™¨ä¸­cookieè¿™ç§åŠŸèƒ½æ˜¯è‡ªå¸¦çš„ï¼Œæˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™ä¸éœ€è¦é’ˆå¯¹cookieå»å†™å¤ªå¤šä»£ç ï¼Œå¯¹äºappæ¥è¯´ï¼Œappæ¯æ¬¡å…³é—­å†æ‰“å¼€ä»¥åï¼Œä½ è¦é‡æ–°åœ¨ä»£ç é‡Œé¢å»å®ä¾‹åŒ–httpçš„å®¢æˆ·ç«¯ï¼Œå»å‘è¯·æ±‚ï¼Œæ¯æ¬¡å»å‘httpï¼Œå®¢æˆ·ç«¯éƒ½æ˜¯ç©ºçš„ï¼Œéƒ½æ˜¯åˆå§‹åŒ–çš„çŠ¶æ€ï¼Œæ‰€ä»¥éœ€è¦å¤„ç†cookieä¹‹å‰å­˜çš„æ•°æ®</li><li>å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒå·®ï¼šåŸºäºcookie+sessionè¿™ç§æ–¹å¼ï¼Œå®ƒçš„éªŒè¯å·¥ä½œéƒ½æ˜¯æœåŠ¡å™¨è‡ªå·±å»åšçš„ï¼Œå…¶å®ä¹Ÿæ²¡æœ‰ä»€ä¹ˆéªŒè¯å·¥ä½œï¼Œæ‹¿è¿‡æ¥çš„è¿™ä¸ªè¯·æ±‚ï¼Œcookieé‡Œæœ‰session idï¼Œé‚£ä¹ˆå°±ç›´æ¥ä»sessioné‡Œæ‹¿ä¸œè¥¿ï¼Œå°±è®¤ä¸ºä½ ç™»å½•äº†ï¼Œæ²¡æœ‰æ‰€è°“å†å»éªŒä»€ä¹ˆä¸œè¥¿ï¼Œè¿™æ—¶å€™å°±å¯¼è‡´ï¼Œå¦‚æœä½ çš„JSessionIDåˆ«äº†çŸ¥é“äº†ï¼Œä»–ç”¨è¿™ä¸ªJSessionIDæ”¾åˆ°cookieé‡Œï¼Œå°±å¯ä»¥ç›´æ¥è·å–ç”¨æˆ·èº«ä»½ï¼Œè¿™é‡Œæœ‰äººä¼šæƒ³åˆ°å¯ä»¥æŠŠsessionçš„å¤±æ•ˆæ—¶é—´è®¾æ–­ä¸€ç‚¹ï¼Œä½†æ˜¯è¿™å›å¯¼è‡´ç”¨æˆ·é¢‘ç¹é‡æ–°ç™»å½•ã€‚</li><li>æœ‰äº›å‰ç«¯çš„æŠ€æœ¯ä¸æ”¯æŒcookieã€å¦‚å°ç¨‹åº</li></ul><p>ç”±äºå­˜åœ¨è¿™äº›é—®é¢˜ï¼Œå½“è®¿é—®è€…ä¸åœ¨æ˜¯æµè§ˆå™¨ï¼Œè€Œæ˜¯ä¸€äº›åº”ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±åº”è¯¥ä½¿ç”¨å¦å¤–ä¸€ç§æ–¹å¼æ¥å¤„ç†ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯çš„å­˜å‚¨ï¼Œè¿™ä¸ªæ–¹å¼å°±æ˜¯ä»¤ç‰Œçš„æ–¹å¼ï¼Œåœ¨spring socialå°†çš„é‚£ç§ï¼Œä¹Ÿå°±æ˜¯tokenï¼Œå…¶å®å®ƒçš„åŸç†å’Œsessionçš„åŸç†å·®ä¸å¤šï¼Œå®ƒä¹Ÿæ˜¯è¦ç»™ç”¨æˆ·ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼Œåªä¸è¿‡åœ¨sessionçš„æ–¹å¼ä¸‹ï¼Œæˆ‘æ˜¯å¾€æµè§ˆå™¨çš„cookieé‡Œå»å†™ä¸€ä¸ªJSessionIDï¼Œè€Œä»¤ç‰Œçš„æ–¹å¼ï¼Œæˆ‘æ˜¯ç›´æ¥å‘ç»™ç”¨æˆ·ä¸€ä¸ªtokenï¼Œç”¨æˆ·æ¯æ¬¡è®¿é—®éƒ½è¦å¸¦ç€è¿™ä¸ªä»¤ç‰Œï¼Œè€Œæˆ‘ä»¬è¿™çš„åº”ç”¨æœåŠ¡å™¨ä¸åœ¨æŠŠç”¨æˆ·ä¿¡æ¯å­˜å‚¨å†sessionä¸­ï¼Œè€Œæ˜¯æ ¹æ®ç”¨æˆ·æ¯æ¬¡è¯·æ±‚å¸¦ç€è¿™ä¸ªä»¤ç‰Œæ¥åˆ¤æ–­ä»–æ˜¯è°ï¼Œä»–æœ‰ä»€ä¹ˆæƒé™ã€‚ä»¤ç‰Œçš„è¡¨ç°å½¢å¼æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå½“é‡‡ç”¨ä»¤ç‰Œè¿™ç§æ–¹å¼æ—¶å€™ï¼Œæˆ‘å‰é¢è¯´çš„è¿™äº›é—®é¢˜å®ƒéƒ½ä¼šå¾—åˆ°ä¸€ä¸ªè§£å†³ï¼š</p><ul><li>è§£å†³å¼€å‘ç¹çï¼šå› ä¸ºä»¤ç‰Œå‘ç»™appä»¥åï¼Œappæ¯æ¬¡å‘è¯·æ±‚å¸¦ç€è¿™ä¸ªä»¤ç‰Œå®ƒä¸æ˜¯é€šè¿‡cookieæ¥å¸¦çš„ï¼Œè€Œæ˜¯httpè¯·æ±‚çš„å‚æ•°ï¼Œå®ƒå°±åƒå¸¦ä¸€ä¸ªæ™®é€šå‚æ•°ä¸€æ ·å¸¦ä¸Šå°±å¯ä»¥äº†ï¼Œä¸éœ€è¦é’ˆå¯¹ä»¤ç‰Œä¸“é—¨å»å†™cookieçš„ä»£ç </li><li>è§£å†³å®‰å…¨æ€§å’Œå®¢æˆ·ä½“éªŒå·®ï¼šåœ¨sessionæ–¹å¼ä¸­ï¼Œå†™JSessionIDæ˜¯ç”±æœåŠ¡å™¨æ¥å®Œæˆçš„ï¼Œæˆ‘ä»¬æ˜¯æ²¡æ³•å»å¹²æ¶‰çš„ï¼Œä½†æ˜¯ç”¨tokenè¿™ç§æ–¹å¼ï¼Œ tokenæ€ä¹ˆæ¥ç”Ÿæˆã€é‡Œé¢åŒ…å«çš„ä¿¡æ¯ã€æˆ‘ä»¬æ€ä¹ˆæ¥æ ¡éªŒè¿™äº›æˆ‘ä»¬éƒ½æ˜¯å¯ä»¥æ¥æ§åˆ¶çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªä»¤ç‰ŒåŠ å¾ˆå¤šæŠ€æœ¯æ‰‹æ®µæ¥å¢å¼ºå®ƒçš„å®‰å…¨æ€§ã€‚åŸºäºsessionæ¥è§£å†³å®‰å…¨é—®é¢˜ä¼šå¯¼è‡´ç”¨æˆ·é¢‘ç¹ç™»å½•ï¼ŒåŸºäºtokençš„æ–¹å¼æˆ‘ä»¬å°±å¯ä»¥è®¾è®¡ä¸€ç§tokenåˆ·æ–°çš„æœºåˆ¶ï¼Œåœ¨ä¸‰æ–¹ç™»å½•çš„æ—¶å€™ä¹Ÿèƒ½çœ‹åˆ°ï¼Œä½ åœ¨å®ŒOAuthæµç¨‹ä»¥åå®ƒä¼šç»™ä¸€ä¸ªtokenï¼Œè¿˜ä¼šç»™ä½ ä¸€ä¸ªrefresh tokenï¼Œè¿™ä¸ªrefresh tokenå°±å¯ä»¥è®©ç”¨æˆ·åœ¨æ²¡æœ‰æ„Ÿè§‰çš„æƒ…å†µä¸‹å»åˆ·æ–°ä»¤ç‰Œï¼Œä¸éœ€è¦ç”¨æˆ·é¢‘ç¹ç™»å½•ï¼Œè¿™æ ·æ—¢å¯ä»¥ä¿è¯ç”¨æˆ·çš„å®‰å…¨æ€§è¿˜å¯ä»¥ä¿è¯ç”¨æˆ·çš„ä½“éªŒ</li><li>è§£å†³æœ‰äº›å‰ç«¯çš„æŠ€æœ¯ä¸æ”¯æŒcookieï¼šè¿™é‡Œä¸ä½¿ç”¨cookieï¼Œè¿™ä¸ªé—®é¢˜å°±ä¸å­˜åœ¨äº†</li></ul><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567224896676.png" srcset="/img/loading.gif" alt="1567224896676"></p><p>è¯´åˆ°è¿™ï¼Œç°åœ¨åšè®¤è¯çš„æ–¹å¼å°±å˜æˆäº†å‘ä»¤ç‰Œçš„æ–¹å¼åœ¨è‡ªå·±çš„åº”ç”¨å’Œå…¶ä»–åº”ç”¨ä¹‹é—´å®Œæˆæˆæƒï¼Œè¯´åˆ°è¿™é‡Œï¼Œç›¸ä¿¡è¯»è€…è„‘æµ·é‡Œç¬¬ä¸€ä¸ªæƒ³åˆ°çš„å°±æ˜¯ä¹‹å‰åœ¨spring socialä»‹ç»çš„OAuthåè®®ï¼Œå®ƒæˆæƒçš„æ–¹å¼å°±æ˜¯ä»¤ç‰Œï¼Œåœ¨ç°åœ¨çš„åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å°±å˜æˆäº†æœåŠ¡æä¾›å•†ï¼Œç°åœ¨çš„appå’Œå‰åç«¯åˆ†ç¦»ä¸­çš„å‰ç«¯å°±å˜æˆäº†ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæˆ‘åªè¦ç»™å®ƒä»¬å‘ä»¤ç‰Œï¼Œå®ƒä»¬æ‹¿åˆ°ä»¤ç‰Œæ¥è®¿é—®æˆ‘ï¼Œæˆ‘è¿™é‡Œæ¥éªŒè¿™ä¸ªä»¤ç‰Œå°±å¯ä»¥äº†ï¼Œä¹‹å‰è¯´å¾—spring socialä¸­å°è£…çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨clientå®ƒæ‰€è¦åšçš„äº‹æƒ…ï¼Œä½¿ç”¨å®ƒå¯ä»¥å¾ˆå¿«å¼€å‘ç¬¬ä¸‰åº”ç”¨è§’è‰²çš„åº”ç”¨ï¼Œå»è¿ä»»æ„ä¸€ä¸ªæˆ‘æƒ³è¿çš„æœåŠ¡æä¾›å•†ï¼Œè€Œè¿™é‡Œè¯´çš„spring oauthåˆ™æ˜¯å°è£…äº†æœåŠ¡æä¾›å•†æ‰€è¦å®Œæˆçš„ç»å¤§éƒ¨åˆ†è¡Œä¸ºï¼Œä½¿ç”¨å®ƒå°±å¯ä»¥å¿«é€Ÿæ­å»ºèµ·ä¸€ä¸ªæœåŠ¡æä¾›å•†çš„ç¨‹åºæ¥ã€‚</p><hr><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567511400096.png" srcset="/img/loading.gif" alt="1567511400096"></p><p>è¦å®ç°oauthæœåŠ¡æä¾›å•†è¿™ä¸ªè§’è‰²ï¼Œå®ƒçš„æ‰€æœ‰åŠŸèƒ½ï¼Œå®é™…ä¸Šå°±å®ç°2ä¸ªæœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰è¯´çš„è®¤è¯æœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨ï¼Œ</p><ul><li>åœ¨è®¤è¯æœåŠ¡å™¨ä¸­æœ‰ä¸¤å¤§èŒƒå¼<ul><li>å®ç°æˆ‘ä»¬ä¹‹å‰ä»‹ç»çš„oauthåè®®ä¸­çš„æˆæƒæ¨¡å¼ï¼ˆæˆæƒç æ¨¡å¼ã€å¯†ç æ¨¡å¼ã€å®¢æˆ·ç«¯æ¨¡å¼ã€ç®€åŒ–æ¨¡å¼ï¼‰ï¼Œé€šè¿‡è¿™4ç§æˆæƒæ¨¡å¼è®©æˆ‘ä»¬çš„åº”ç”¨æ¥ç¡®è®¤ç”¨æˆ·çš„èº«ä»½ä»¥åç”¨æˆ·æ‹¥æœ‰çš„æƒé™ï¼Œåœ¨spring security oauthæŠŠè¿™4ç§æˆæƒæ¨¡å¼éƒ½æ›¿æˆ‘ä»¬å®ç°äº†ï¼Œè¿™4ç§æˆæƒæ¨¡å¼å®ç°äº†ä»¥åï¼Œé€šè¿‡è¿™4ç§æ¨¡å¼çŸ¥é“ç”¨æˆ·çš„èº«ä»½åæƒé™ä»¥åï¼Œæ ¹æ®è¿™äº›ä¿¡æ¯æ¥ç”Ÿæˆå’Œå­˜å‚¨è¿™äº›ä»¤ç‰Œï¼Œè¿™é‡Œçš„ç”Ÿæˆå’Œå­˜å‚¨æ²¡æœ‰æ˜ç¡®çš„è§„å®šï¼Œtokenè¦æŒ‰ç…§ä»€ä¹ˆè§„åˆ™æ¥ç”Ÿæˆï¼Œä½†åœ¨spring security oauthä¸­é»˜è®¤å®šåˆ¶äº†ä¸€å¥—ç”Ÿæˆè§„åˆ™ï¼ŒæŒ‰ç…§å®ƒçš„æƒ³æ³•åšçš„å®ç° </li></ul></li><li>èµ„æºæœåŠ¡å™¨å°±æ˜¯æ¥ä¿æŠ¤èµ„æºï¼Œåœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬è¦ä¿æŠ¤çš„èµ„æºæ˜¯ä»€ä¹ˆï¼Œå°±æ˜¯å€¼æˆ‘ä»¬å†™çš„restæœåŠ¡ï¼Œæ€ä¹ˆæ¥ä¿æŠ¤è¿™äº›æœåŠ¡å‘¢ï¼ŸæŒ‰ç›®å‰ç”¨çš„spring securityï¼Œå®ƒæ˜¯åœ¨èµ„æºä¹‹å‰åŠ ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œspring security oauthæ˜¯å¦‚ä½•æ¥å®ç°èµ„æºæœåŠ¡å™¨çš„åŠŸèƒ½å‘¢ï¼Ÿå®ƒæ˜¯åœ¨spring securityè¿‡æ»¤å™¨é“¾ä¸ŠåŠ äº†ä¸€ä¸ªæ–°çš„è¿‡æ»¤å™¨ï¼šOAuth2AuthenticationProcessingFilterï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä¼šåœ¨è¯·æ±‚ä¸­æ‹¿å‡ºä½ å‘å‡ºå»çš„tokenï¼Œå› ä¸ºä½ å‘å‡ºå»çš„tokenï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å®ƒåœ¨è°ƒä½ åˆ°restæœåŠ¡çš„æ—¶å€™ï¼Œä¸€å®šä¼šå¸¦ç€tokenè¿‡æ¥ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨ä½œç”¨ä»é‚£ä¸ªè¯·æ±‚ä¸­æŠŠå¸¦ç€çš„tokenæ‹¿å‡ºæ¥ï¼Œæ ¹æ®ä½ é…çš„å­˜å‚¨ç­–ç•¥å»å­˜å‚¨é‡Œæ‰¾åˆ°tokenå¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·ä¿¡æ¯æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦æœ‰æƒé™ç­‰ç­‰ä¸€ç³»åˆ—åˆ¤æ–­æ¥å†³å®šå®ƒæœ€ç»ˆæ˜¯å¦èƒ½è®¿é—®ä½ çš„restæœåŠ¡ï¼Œè¿™æ ·å°±å®ç°äº†èµ„æºæœåŠ¡å™¨çš„åŠŸèƒ½</li></ul><p>åœ¨è¿™ä¸ªåœºæ™¯ä¸‹é¢è¿˜è¦ä¸€ä¸ªæœ€ç»ˆé—®é¢˜ï¼šæˆ‘ä»¬ä¸å¸Œæœ›è®©ç”¨æˆ·å»èµ°è¿™4ç§æ ‡å‡†çš„æˆæƒæ¨¡å¼çš„ï¼Œæ¯”å¦‚è¯´æˆ‘çš„æ‰‹æœºå·å’ŒçŸ­ä¿¡éªŒè¯ç ç™»å½•æ–¹å¼ï¼Œå®ƒè·Ÿè¿™æ ‡å‡†çš„4ç§æˆæƒæ¨¡å¼æ˜¯æ­ä¸ä¸Šçš„ï¼Œæ ‡å‡†çš„æˆæƒæ¨¡å¼æ˜¯æ²¡æœ‰è®©ä½ è¾“å…¥æ‰‹æœºå·ã€è¾“å…¥çŸ­ä¿¡å°±å‘ä¸€ä¸ªtokenç»™ä½ ï¼Œæˆ‘ä»¬è¦åšçš„é¢å¤–äº‹æƒ…å°±æ˜¯è®©æˆ‘ä»¬è‡ªå®šä¹‰è¿™ç§è®¤è¯æ–¹å¼ï¼Œå®ƒä¹Ÿå¯ä»¥å«æ¥åˆ°è®¤è¯æœåŠ¡å™¨ä¸Šå»ï¼Œè®©ç”¨æˆ·å+å¯†ç ã€æ‰‹æœºå·+çŸ­ä¿¡éªŒè¯ç ã€ç¬¬ä¸‰æ–¹è®¤è¯é€šè¿‡è¿™äº›è®¤è¯ä»¥åå®ƒä¹Ÿå¯ä»¥å»è°ƒè¿™ä¸ªtokenç”Ÿæˆçš„æœºåˆ¶æ¥ç”Ÿæˆtokenæ¥ï¼Œå‘ç»™ä¸‰æ–¹åº”ç”¨ï¼Œä¸€æ—¦å®ç°è¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘ä»¬æ•´ä¸ªæµç¨‹å°±è·‘åŒäº†ï¼Œæˆ‘çš„ç¬¬ä¸‰æ–¹åº”ç”¨å°±å¯ä»¥å¼•å¯¼ç”¨æˆ·èµ°æˆ‘ä»¬è‡ªå®šä¹‰åˆ°è®¤è¯ï¼ŒæˆåŠŸäº†ä»¥åå‘ä¸€ä¸ªtokenç»™ç¬¬ä¸‰æ–¹ï¼Œç¬¬ä¸‰æ–¹æ‹¿åˆ°è¿™ä¸ªtokenï¼Œæ¯æ¬¡å»è®¿é—®æœåŠ¡çš„æ—¶å€™ï¼Œå¸¦ç€è¿™ä¸ªtokenï¼Œé€šè¿‡è¿‡æ»¤å™¨é“¾ä¸Šçš„è¿‡æ»¤å™¨æ¥è®¤è¯ï¼Œæ¥è·å–æˆæƒç­‰â€¦ï¼Œè¿™æ ·å‰é¢æè¿°çš„åœºæ™¯é€šè¿‡è¿™ç§æ–¹å¼å°±å®ç°äº†ï¼Œåœ¨ä¸Šé¢å›¾ä¸­ï¼Œç»¿è‰²éƒ¨åˆ†éƒ½æ˜¯spring securityå®ç°å¥½çš„ï¼Œçº¢è‰²çš„éƒ¨åˆ†æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ä»£ç ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„ä»£ç é‡Œé¢ï¼Œèµ„æºè¿™ä¸€å—æ˜¯ä¸ç”¨æ”¹çš„ï¼Œå®ƒæ˜¯æ ‡å‡†çš„restæœåŠ¡ï¼Œè¦æ”¹çš„åœ°æ–¹å°±æ˜¯ä¹‹å‰è¯´çš„3ç§è®¤è¯æ–¹å¼ï¼ŒæŠŠå®ƒåšä¸€ä¸ªä¿®æ”¹</p><hr><p>å†…å®¹ç®€ä»‹</p><ul><li>å®ç°ä¸€ä¸ªæ ‡å‡†çš„oauth2åè®®ä¸­providerè§’è‰²çš„ä¸»è¦åŠŸèƒ½</li><li>é‡æ„ä¹‹å‰ä¸‰ç§è®¤è¯æ–¹å¼çš„ä»£ç ï¼Œä½¿å…¶æ”¯æŒtoken</li><li>é«˜çº§ç‰¹æ€§</li></ul>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ å››ã€Session ã€‘ 1.Sessionç®¡ç†</title>
    <link href="/spring-security-4.1.html"/>
    <url>/spring-security-4.1.html</url>
    
    <content type="html"><![CDATA[<h1 id="å•æœºSessionç®¡ç†"><a href="#å•æœºSessionç®¡ç†" class="headerlink" title="å•æœºSessionç®¡ç†"></a>å•æœºSessionç®¡ç†</h1><p>ä¹‹å‰äº†è§£å¾ˆå¤šç§ç™»å½•æ–¹å¼ï¼Œè™½ç„¶å®ƒä»¬çš„æ–¹å¼ä¸åŒï¼Œä½†æ˜¯å®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œæœ€ç»ˆç™»å½•æˆåŠŸä»¥åç”¨æˆ·ä¿¡æ¯æ˜¯æ”¾åˆ°æœåŠ¡å™¨çš„sessionä¸­çš„ï¼Œåœ¨è¿™é‡Œæ¥ä»‹ç»Sessionç®¡ç†</p><hr><h2 id="Sessionè¶…æ—¶å¤„ç†"><a href="#Sessionè¶…æ—¶å¤„ç†" class="headerlink" title="Sessionè¶…æ—¶å¤„ç†"></a>Sessionè¶…æ—¶å¤„ç†</h2><p>sessionæ˜¯æœ‰è¶…æ—¶æ—¶é—´çš„ï¼Œä¸åŒçš„åº”ç”¨sessionè¶…æ—¶æ—¶é—´ä¸ä¸€æ ·ï¼Œå¯èƒ½1å°æ—¶ã€2å°æ—¶ï¼Œé‚£ä¹ˆsessionå¹²æ‰ä»¥åï¼Œç”¨æˆ·åœ¨è¿›è¡Œæ“ä½œä¼šæ€ä¹ˆæ ·ï¼Ÿæ€ä¹ˆæ¥å¤„ç†ï¼Ÿ</p><hr><p>ymlï¼š</p><p>è¿™é‡Œå°†è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º10ç§’ï¼Œå½“ç”¨æˆ·10ç§’ä¸è¿›è¡Œæ“ä½œï¼Œsessionå°±ä¼šå¤±æ•ˆ</p><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">session:</span>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">10</span></code></pre><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹å®é™…æƒ…å†µï¼Œç°åœ¨è¿›è¡Œç™»å½•ï¼Œç„¶å10ç§’ä¸æ“ä½œï¼Œè®¿é—®è¯·æ±‚ï¼Œä»»ç„¶å¯ä»¥è®¿é—®ï¼Œè¿™å°±è¯´æ˜sessionæ²¡æœ‰å¤±æ•ˆï¼Œèº«ä»½ä¿¡æ¯è¿˜åœ¨sessionä¸­ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§æƒ…å†µï¼Œæ¥çœ‹ä¸€ä¸‹spring bootçš„ä»£ç ï¼ŒTomcatEmbeddedServletContainerFactory#configureSessionï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureSession</span><span class="hljs-params">(Context context)</span> </span>&#123;<span class="hljs-keyword">long</span> sessionTimeout = getSessionTimeoutInMinutes(); <span class="hljs-comment">//è·å–ymlä¸­é…ç½®çš„è¶…æ—¶æ—¶é—´</span>context.setSessionTimeout((<span class="hljs-keyword">int</span>) sessionTimeout);<span class="hljs-keyword">if</span> (isPersistSession()) &#123;Manager manager = context.getManager();<span class="hljs-keyword">if</span> (manager == <span class="hljs-keyword">null</span>) &#123;manager = <span class="hljs-keyword">new</span> StandardManager();context.setManager(manager);&#125;configurePersistSession(manager);&#125;<span class="hljs-keyword">else</span> &#123;context.addLifecycleListener(<span class="hljs-keyword">new</span> DisablePersistSessionListener());&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span> <span class="hljs-title">getSessionTimeoutInMinutes</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">long</span> sessionTimeout = getSessionTimeout();<span class="hljs-keyword">if</span> (sessionTimeout &gt; <span class="hljs-number">0</span>) &#123;      <span class="hljs-comment">//å°†ç§’è½¬æ¢æˆäº†åˆ†é’Ÿæ•°ï¼Œç„¶åå®ƒæ‹¿ç§’æ•°è½¬æ¢çš„åˆ†é’Ÿæ•°å’Œ1åšæ¯”è¾ƒï¼Œç„¶åå»å–å®ƒçš„æœ€å¤§å€¼ï¼Œä¹Ÿå°±æ˜¯ä½ è®¾ç½®çš„è¿‡æœŸæ—¶é—´æœ€å°‘è¦æ˜¯1åˆ†é’Ÿï¼Œ</span>sessionTimeout = Math.max(TimeUnit.SECONDS.toMinutes(sessionTimeout), <span class="hljs-number">1L</span>); &#125;    <span class="hljs-comment">//å®ƒè¿”å›å»çš„sessionTimeoutæ˜¯ä»¥åˆ†é’Ÿä¸ºå•ä½çš„æ•°å€¼</span><span class="hljs-keyword">return</span> sessionTimeout;&#125;</code></pre><p>åœ¨spring booté‡Œsessionçš„è¶…æ—¶æ—¶é—´æœ€å°‘ä¸º1åˆ†é’Ÿï¼Œä½ è®¾ç½®çš„æ¯”1åˆ†é’Ÿå°‘ï¼Œå®ƒä¹Ÿä¼šç»™ä½ è®¾ç½®ä¸€åˆ†é’Ÿï¼Œè¿™é‡Œæˆ‘è¯´äº†è¿™ä¹ˆä¹…ï¼Œå°±æ˜¯åœ¨æ‹–è¿™1åˆ†é’Ÿï¼ˆå˜»å˜»ï¼‰ï¼Œç°åœ¨1åˆ†é’Ÿè¿‡æœŸäº†åå¤´åœ¨æ¥è®¿é—®ï¼Œå°±ä¼šå“åº”å‡ºï¼š</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"content"</span>: <span class="hljs-string">"è¯·å¼•å¯¼ç”¨æˆ·è·³è½¬åˆ°ç™»å½•é¡µé¢"</span>&#125;</code></pre><p>è¿™å°±ä»£è¡¨æ”¾åˆ°sessioné‡Œçš„ç”¨æˆ·ä¿¡æ¯æ²¡æœ‰äº†ï¼Œè¯´æ˜sessionå¤±æ•ˆäº†</p><hr><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç»™ç”¨æˆ·ä¸€ä¸ªç‰¹æ®Šçš„æç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·ä½ çš„sessionå¤±æ•ˆäº†æ‰€ä»¥ä½ è¦é‡æ–°ç™»å½•ï¼Œè€Œä¸Šé¢çš„å“åº”å¼ä¸å‹å¥½çš„ï¼Œå®ƒè¿™é‡Œæ²¡è¯´æ˜ä½ æ˜¯æ²¡æœ‰ç™»å½•ã€è¿˜æ˜¯ç™»å½•äº†sessionè¿‡æœŸäº†éœ€è¦é‡æ–°ç™»å½•ï¼Œè¿™ä¸ªå®ƒæ˜¯åŒºåˆ†ä¸å‡ºæ¥äº†ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œåšä¸€ä¸ªæ›´ç»†åŒ–çš„å¤„ç†</p><hr><p>sessionè¿‡æœŸä¹‹åï¼Œå†æ¬¡è®¿é—®ï¼Œä¼šè·³è½¬åˆ°/session/invalidåœ°å€</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    http.sessionManagement()            .invalidSessionUrl(<span class="hljs-string">"/session/invalid"</span>)              .antMatchers(                    <span class="hljs-string">"/session/invalid"</span>,</code></pre><p>BrowserSecurityControllerï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/session/invalid"</span>)    <span class="hljs-meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)    <span class="hljs-function"><span class="hljs-keyword">public</span> McrSecurityVO <span class="hljs-title">sessionInvalid</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrSecurityVO(<span class="hljs-string">"sessionså¤±æ•ˆ"</span>);    &#125;</code></pre><p>è¿™é‡Œç›´æ¥é‡å¯æœåŠ¡å™¨ï¼Œsessionå°±å…¨éƒ¨å¤±æ•ˆäº†ï¼Œå“åº”å†…å®¹ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"content"</span>: <span class="hljs-string">"sessionså¤±æ•ˆ"</span>&#125;</code></pre><h2 id="Sessionå¹¶å‘æ§åˆ¶"><a href="#Sessionå¹¶å‘æ§åˆ¶" class="headerlink" title="Sessionå¹¶å‘æ§åˆ¶"></a>Sessionå¹¶å‘æ§åˆ¶</h2><p>åœ¨æœ‰äº›ç½‘ç«™å¯èƒ½ä¼šæœ‰è¿™æ ·çš„éœ€æ±‚ï¼šç”¨æˆ·åœ¨Aæœºå™¨ä¸Šç™»å½•äº†ä»¥åï¼Œè¿‡äº†ä¸€æ®µæ—¶é—´ï¼Œä»–åœ¨Bæœºå™¨ä¸Šä¹Ÿç™»å½•äº†ï¼Œåœ¨Bæœºå™¨ä¸Šç™»å½•äº†æ—¶å€™ï¼Œå¦‚æœAæœºå™¨æŠ¥é€€å‡ºï¼Œè¦æŠŠAæœºå™¨çš„ç™»å½•ï¼Œsessionç»™æ˜¯å¤±æ•ˆæ‰ï¼Œä¹Ÿå°±æ˜¯åé¢çš„sessionè¸¢å¤„å‰é¢çš„sesion</p><hr><p>ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œå°†è¿‡æœŸæ—¶é—´æ”¹ä¸€ä¸‹</p><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>  <span class="hljs-attr">session:</span>    <span class="hljs-attr">timeout:</span> <span class="hljs-number">600</span></code></pre><hr><pre><code class="hljs java">http.sessionManagement()              .invalidSessionUrl(<span class="hljs-string">"/session/invalid"</span>)              .maximumSessions(<span class="hljs-number">1</span>)</code></pre><p>maximumSessionsï¼šæœ€å¤§çš„sessionæ•°é‡ï¼ŒåŒä¸€ä¸ªç”¨æˆ·ï¼Œå®ƒåé¢çš„ç™»å½•æ‰€äº§ç”Ÿçš„sessionï¼Œå°±ä¼šæŠŠä¹‹å‰ç™»å½•æ‰€äº§ç”Ÿçš„sessionç»™å¤±æ•ˆæ‰ï¼Œç„¶åå‰é¢çš„ç”¨æˆ·å†å»è®¿é—®ä¼šå“åº”ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"content"</span>: <span class="hljs-string">"sessionså¤±æ•ˆ"</span>&#125;</code></pre><p>è¿™é‡Œåº”è¯¥æç¤ºç”¨æˆ·è¢«å…¶ä»–åœ°æ–¹ç™»å½•ï¼Œè¿™é‡Œæœ‰æ˜¯æä¾›äº†ç›¸åº”çš„å¤„ç†çš„</p><p>è¿™é‡Œå¯ä»¥åœ¨æœåŠ¡å™¨ç«¯åšä¸€ä¸ªè®°å½•ï¼Œå¯ä»¥å»å®ç°<code>SessionInformationExpiredStrategy</code>æ¥å£ï¼Œ</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SessionInformationExpiredStrategy</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">onExpiredSessionDetected</span><span class="hljs-params">(SessionInformationExpiredEvent eventÃ˜)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException</span>;&#125;</code></pre><p>SessionInformationExpiredStrategyæ¥å£å®ç°ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.session;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredEvent;<span class="hljs-keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredStrategy;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrExpiredSessionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SessionInformationExpiredStrategy</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onExpiredSessionDetected</span><span class="hljs-params">(SessionInformationExpiredEvent eventÃ˜)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;         eventÃ˜.getResponse().setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);        eventÃ˜.getResponse().getWriter().write(<span class="hljs-string">"å¹¶å‘ç™»å½•ï¼"</span>);    &#125;&#125;</code></pre><hr><p>BrowserSecurityConfigï¼š</p><pre><code class="hljs java">http.sessionManagement()         .invalidSessionUrl(<span class="hljs-string">"/session/invalid"</span>)         .maximumSessions(<span class="hljs-number">1</span>)         .expiredSessionStrategy(<span class="hljs-keyword">new</span> McrExpiredSessionStrategy())</code></pre><hr><p>ç°åœ¨æ‹¿2ä¸ªæµè§ˆå™¨ç™»å½•åŒä¸€ä¸ªè´¦å·ï¼Œå‰é¢ä¸€ä¸ªç›¸åº”ï¼š</p><pre><code class="hljs plain">å¹¶å‘ç™»å½•ï¼</code></pre><hr><p>ç°åœ¨éœ€æ±‚å˜äº†ï¼šä¸æ˜¯æŠŠå‰é¢çš„Tæ‰ï¼Œè€Œæ˜¯ä¸è®©ç¬¬äºŒä¸ªç”¨æˆ·ç™»å½•</p><p>BrowserSecurityConfigï¼š</p><pre><code class="hljs java"><span class="hljs-comment">//å½“sessionè¾¾åˆ°æœ€å¤§çš„ä»¥åï¼Œé˜»æ­¢æ‰åæ¥çš„ç™»å½•è¡Œä¸º  </span>.maximumSessions(<span class="hljs-number">1</span>).maxSessionsPreventsLogin(<span class="hljs-keyword">true</span>)</code></pre><p>ç¬¬2ä¸ªç”¨æˆ·ç™»å½•æ—¶æµè§ˆå™¨å“åº”ï¼š</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"content"</span>:<span class="hljs-string">"Maximum sessions of 1 for this principal exceeded"</span>&#125;</code></pre><h2 id="é‡æ„ä»£ç "><a href="#é‡æ„ä»£ç " class="headerlink" title="é‡æ„ä»£ç "></a>é‡æ„ä»£ç </h2><p>ç°åœ¨çš„ä»£ç ï¼š</p><pre><code class="hljs java">http.sessionManagement()             .invalidSessionUrl(<span class="hljs-string">"/session/invalid"</span>)             .maximumSessions(<span class="hljs-number">1</span>).maxSessionsPreventsLogin(<span class="hljs-keyword">true</span>)             .expiredSessionStrategy(<span class="hljs-keyword">new</span> McrExpiredSessionStrategy())  <span class="hljs-comment">//..</span>    .antMatchers(                     <span class="hljs-string">"/session/invalid"</span>,</code></pre><p>ç°åœ¨è¿™æ ·æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºè¿™ä¸ªä»£ç æ˜¯ä¸€ä¸ªå…¬å…±çš„æ¨¡å—ï¼Œåœ¨ä½¿ç”¨è€…å°†è¿™äº›ä»£ç å¯¼å…¥å®ƒçš„å·¥ç¨‹ä¸­ï¼Œæ˜¯æ— æ³•è¿›è¡Œä¿®æ”¹çš„ï¼Œæ¯”å¦‚è¿™é‡Œçš„<code>/session/invalid</code>,å®ƒè¿”å›çš„æ˜¯jsonï¼Œé‚£ä¹ˆä½¿ç”¨è€…çš„é¡¹ç›®å¯èƒ½æ²¡æœ‰ä½¿ç”¨å‰ååˆ†ç¦»ï¼Œå°±æ²¡å¿…è¦ä½¿ç”¨jsonï¼Œä»–è·Ÿå¸Œæœ›è¿™é‡Œçš„å¤„ç†èƒ½è·³è½¬åˆ°ä¸€ä¸ªé¡µé¢ä¸Šå»ï¼Œ</p><p>McrExpiredSessionStrategyå“åº”çš„å†…å®¹ï¼Œä»–ä¹Ÿæ— æ³•å»ä¿®æ”¹ï¼Œè¿™äº›éƒ½æ˜¯ä¸åˆç†çš„ï¼Œè¿™é‡Œå°†è¿™äº›è¿›è¡Œé‡æ„</p><hr><p>é¦–å…ˆå°†è¿™äº›é…ç½®ä½¿ç”¨æˆ·é€šè¿‡ymlè¿›è¡Œæ§åˆ¶ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SessionProperties</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åŒä¸€ä¸ªç”¨æˆ·åœ¨ç³»ç»Ÿä¸­çš„æœ€å¤§sessionæ•°ï¼Œé»˜è®¤1</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> maximumSessions = <span class="hljs-number">1</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è¾¾åˆ°æœ€å¤§sessionæ—¶æ˜¯å¦é˜»æ­¢æ–°çš„ç™»å½•è¯·æ±‚ï¼Œé»˜è®¤ä¸ºfalseï¼Œä¸é˜»æ­¢ï¼Œæ–°çš„ç™»å½•ä¼šå°†è€çš„ç™»å½•å¤±æ•ˆæ‰</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> maxSessionsPreventsLogin;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * sessionå¤±æ•ˆæ—¶è·³è½¬çš„åœ°å€</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> String sessionInvalidUrl = SecurityConstants.DEFAULT_SESSION_INVALID_URL;&#125;</code></pre><p>BrowserSecurityPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * sessionç›¸å…³é…ç½®</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> SessionProperties session = <span class="hljs-keyword">new</span> SessionProperties();</code></pre><p>sessionå¤±æ•ˆã€sessionå¹¶å‘ï¼šåˆ¤æ–­å½“å‰è®¿é—®urlçš„åœ°å€æ˜¯ä¸æ˜¯.htmlç»“å°¾çš„ï¼Œå¦‚æœæ˜¯ï¼Œå°±è·³è½¬åˆ°æŒ‡å®šçš„URLå»ï¼Œå¦‚æœä¸æ˜¯åˆ™å“åº”jsonï¼Œå®ƒä»¬2ä¸ªåˆ†åˆ«é…ç½®invalidSessionStrategyå’ŒexpiredSessionStrategyï¼Œå®ƒä»¬ä¸¤ä¸ªçš„é€»è¾‘ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬è¿™é‡Œéå¸¸ç›¸è¯†ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿™é‡Œå…ˆåˆ›å»ºä¸€ä¸ªæŠ½è±¡ç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.session;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.vo.McrSecurityVO;<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.slf4j.Logger;<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;<span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<span class="hljs-keyword">import</span> org.springframework.security.web.DefaultRedirectStrategy;<span class="hljs-keyword">import</span> org.springframework.security.web.RedirectStrategy;<span class="hljs-keyword">import</span> org.springframework.security.web.util.UrlUtils;<span class="hljs-keyword">import</span> org.springframework.util.Assert;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractSessionStrategy</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Logger logger = LoggerFactory.getLogger(getClass());    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·³è½¬çš„url</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> String destinationUrl;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é‡å®šå‘ç­–ç•¥</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> RedirectStrategy redirectStrategy = <span class="hljs-keyword">new</span> DefaultRedirectStrategy();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·³è½¬å‰æ˜¯å¦åˆ›å»ºæ–°çš„session</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> createNewSession = <span class="hljs-keyword">true</span>;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper = <span class="hljs-keyword">new</span> ObjectMapper();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> invalidSessionUrl è·³è½¬åœ°å€</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractSessionStrategy</span><span class="hljs-params">(String invalidSessionUrl)</span> </span>&#123;        Assert.isTrue(UrlUtils.isValidRedirectUrl(invalidSessionUrl), <span class="hljs-string">"url must start with '/' or with 'http(s)'"</span>);        <span class="hljs-keyword">this</span>.destinationUrl = invalidSessionUrl;    &#125;    <span class="hljs-comment">/*</span><span class="hljs-comment">     * (non-Javadoc)</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * @see org.springframework.security.web.session.InvalidSessionStrategy#</span><span class="hljs-comment">     * onInvalidSessionDetected(javax.servlet.http.HttpServletRequest,</span><span class="hljs-comment">     * javax.servlet.http.HttpServletResponse)</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onSessionInvalid</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        <span class="hljs-keyword">if</span> (createNewSession) &#123;            request.getSession();        &#125;        String sourceUrl = request.getRequestURI();        String targetUrl;        <span class="hljs-keyword">if</span> (StringUtils.endsWithIgnoreCase(sourceUrl, <span class="hljs-string">".html"</span>)) &#123;            targetUrl = destinationUrl + <span class="hljs-string">".html"</span>;            logger.info(<span class="hljs-string">"sessionå¤±æ•ˆ,è·³è½¬åˆ°"</span> + targetUrl);            redirectStrategy.sendRedirect(request, response, targetUrl);        &#125; <span class="hljs-keyword">else</span> &#123;            String message = <span class="hljs-string">"sessionå·²å¤±æ•ˆ"</span>;            <span class="hljs-keyword">if</span> (isConcurrency()) &#123;                message = message + <span class="hljs-string">"ï¼Œæœ‰å¯èƒ½æ˜¯å¹¶å‘ç™»å½•å¯¼è‡´çš„"</span>;            &#125;            response.setStatus(HttpStatus.UNAUTHORIZED.value());            response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(message)));        &#125;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * sessionå¤±æ•ˆæ˜¯å¦æ˜¯å¹¶å‘å¯¼è‡´çš„</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isConcurrency</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * Determines whether a new session should be created before redirecting (to</span><span class="hljs-comment">     * avoid possible looping issues where the same session ID is sent with the</span><span class="hljs-comment">     * redirected request). Alternatively, ensure that the configured URL does</span><span class="hljs-comment">     * not pass through the &#123;<span class="hljs-doctag">@code</span> SessionManagementFilter&#125;.</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> createNewSession defaults to &#123;<span class="hljs-doctag">@code</span> true&#125;.</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setCreateNewSession</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> createNewSession)</span> </span>&#123;        <span class="hljs-keyword">this</span>.createNewSession = createNewSession;    &#125;&#125;</code></pre><p>sessionè¿‡æœŸç­–ç•¥ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.session;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> org.springframework.security.web.session.InvalidSessionStrategy;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrInvalidSessionStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSessionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvalidSessionStrategy</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrInvalidSessionStrategy</span><span class="hljs-params">(String invalidSessionUrl)</span> </span>&#123;        <span class="hljs-keyword">super</span>(invalidSessionUrl);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onInvalidSessionDetected</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        onSessionInvalid(request, response);    &#125;&#125;</code></pre><p>sessionå¹¶å‘ç­–ç•¥ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.session;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredEvent;<span class="hljs-keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredStrategy;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrExpiredSessionStrategy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractSessionStrategy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SessionInformationExpiredStrategy</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrExpiredSessionStrategy</span><span class="hljs-params">(String invalidSessionUrl)</span> </span>&#123;        <span class="hljs-keyword">super</span>(invalidSessionUrl);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onExpiredSessionDetected</span><span class="hljs-params">(SessionInformationExpiredEvent event)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        onSessionInvalid(event.getRequest(), event.getResponse());    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isConcurrency</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;&#125;</code></pre><p>è¿™é‡Œçš„2ä¸ªç­–ç•¥ï¼Œä¸èƒ½ç›´æ¥é…ç½®åœ¨BrowserSecurityConfigä¸­ï¼Œå› ä¸ºå¯èƒ½æˆ‘ä»¬æä¾›çš„è¿™2ä¸ªç­–ç•¥ä¸æ»¡è¶³ä½¿ç”¨è€…çš„éœ€æ±‚ï¼Œè¿™é‡Œé€šè¿‡ConditionalOnMissingBeanæ³¨è§£å»åˆ¤æ–­ä½¿ç”¨è€…æ˜¯å¦æœ‰å®ç°InvalidSessionStrategyç±»æ³¨å…¥åˆ°IOCå®¹å™¨ä¸­ï¼Œå¦‚æœæœ‰å°±ç”¨ä½¿ç”¨è€…è‡ªå·±çš„ï¼Œå¦‚æœæ²¡æœ‰å°±ç”¨æˆ‘ä»¬é»˜è®¤çš„</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-keyword">import</span> com.b4.mcr.auth.browser.session.McrExpiredSessionStrategy;<span class="hljs-keyword">import</span> com.b4.mcr.auth.browser.session.McrInvalidSessionStrategy;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.SecurityProperties;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.web.session.InvalidSessionStrategy;<span class="hljs-keyword">import</span> org.springframework.security.web.session.SessionInformationExpiredStrategy;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityBeanConfig</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-meta">@Bean</span>    <span class="hljs-meta">@ConditionalOnMissingBean</span>(InvalidSessionStrategy<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">InvalidSessionStrategy</span> <span class="hljs-title">invalidSessionStrategy</span>() </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrInvalidSessionStrategy(securityProperties.getBrowser().getSession().getSessionInvalidUrl());    &#125;    <span class="hljs-meta">@Bean</span>    <span class="hljs-meta">@ConditionalOnMissingBean</span>(SessionInformationExpiredStrategy<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">SessionInformationExpiredStrategy</span> <span class="hljs-title">sessionInformationExpiredStrategy</span>() </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrExpiredSessionStrategy(securityProperties.getBrowser().getSession().getSessionInvalidUrl());    &#125;&#125;</code></pre><p>BrowserSecurityConfigï¼š</p><pre><code class="hljs java"> <span class="hljs-keyword">private</span> InvalidSessionStrategy invalidSessionStrategy;    <span class="hljs-keyword">private</span> SessionInformationExpiredStrategy sessionInformationExpiredStrategy;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<span class="hljs-comment">//...</span>           http.sessionManagement()                .invalidSessionStrategy(invalidSessionStrategy)                .maximumSessions(browser.getSession().getMaximumSessions()).maxSessionsPreventsLogin(browser.getSession().isMaxSessionsPreventsLogin())                .expiredSessionStrategy(sessionInformationExpiredStrategy)<span class="hljs-comment">//...</span>&#125;</code></pre><h1 id="é›†ç¾¤Sessionç®¡ç†"><a href="#é›†ç¾¤Sessionç®¡ç†" class="headerlink" title="é›†ç¾¤Sessionç®¡ç†"></a>é›†ç¾¤Sessionç®¡ç†</h1><p>åœ¨é»˜è®¤çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„sessionæ˜¯æ”¾åœ¨ä¸­é—´ä»¶æœåŠ¡å™¨é‡Œé¢çš„ï¼Œæ¯”å¦‚tomcatã€websocketä¹‹ç±»çš„æœåŠ¡å™¨ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬çš„ç³»ç»Ÿéƒ¨ç½²æˆé›†ç¾¤çš„æ—¶å€™å°±ä¼šæœ‰ä¸€äº›é—®é¢˜ï¼šæ¯”å¦‚å‰é¢è´Ÿè½½å‡è¡¡çš„æ—¶å€™ï¼Œä½ çš„ç™»å½•è¯·æ±‚å¯èƒ½å‘åˆ°ä½ é›†ç¾¤çš„Aæœºå™¨ä¸Šï¼Œç„¶åä»–ç™»å½•ä»¥åï¼ŒæŠŠç™»å½•ä¿¡æ¯æ”¾åˆ°Aæœºå™¨çš„sessionä¸Šï¼Œåç»­çš„è¯·æ±‚æ•°æ®çš„æœåŠ¡å®ƒå¯èƒ½ä¼šå‘åˆ°Bæœºå™¨ä¸Šï¼Œè€ŒBæœºå™¨çš„sessionå¹¶æ²¡æœ‰ä½ Aæœºå™¨é‡Œé¢çš„sessionç™»å½•ä¿¡æ¯ï¼Œæ‰€ä»¥Bæœºå™¨ä¼šè¦æ±‚ç”¨æˆ·å†ç™»å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567351628532.png" srcset="/img/loading.gif" alt="1567351628532"></p><p>å¦‚ä½•ä¸€ä¸ªå½“ç”¨çš„è½¯ä»¶ï¼Œæ”¾åœ¨äº’è”ç½‘ä¸Šç»™ç”¨æˆ·ç”¨çš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šè‡³å°‘éƒ¨ç½²2å°æœºå™¨ï¼Œå› ä¸ºå¦‚æœåªéƒ¨ä¸€å°é‚£ä¹ˆè¿™å¤ªæœºå™¨å‡ºé—®é¢˜äº†ï¼Œä½ çš„æœåŠ¡å°±ä¸­æ–­äº†ï¼Œè¿™å¯¹äºå¤§å¤šæ•°å…¬å¸æ¥è¯´æ˜¯ä¸€ä¸ªå¾ˆä¸¥é‡çš„ç”Ÿäº§äº‹æ•…ï¼Œæ˜¯ä¸èƒ½æ¥æ”¶çš„ï¼Œæ‰€ä»¥ä¼šéƒ¨ä¸€ä¸ªé›†ç¾¤ï¼Œè‡³å°‘2å°æœºå™¨ï¼Œå‰é¢æœ‰ä¸€ä¸ªè´Ÿè½½å‡è¡¡ï¼Œå‰é¢æœ‰ä¸€å°æœºå™¨downäº†ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªè¿˜å¯ä»¥ä¸ºç”¨æˆ·æä¾›æœåŠ¡ï¼Œåœ¨è¿™ä¸ªç¯å¢ƒä¸‹ï¼ŒåŸºäºsessionçš„èº«ä»½è®¤è¯å°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼šç”¨æˆ·çš„ç™»å½•è¯·æ±‚æ˜¯å‘åˆ°Server1ä¸Šçš„ï¼Œé‚£ä¹ˆsessionä¹Ÿæ˜¯è·Ÿç€æœåŠ¡å™¨èµ°çš„ï¼Œæ‰€ä»¥å½“ç”¨æˆ·ç™»å½•æˆåŠŸä»¥åï¼Œå®ƒçš„ç»è¿‡è®¤è¯çš„SecurityContextã€Authenticationéƒ½æ˜¯æ”¾åˆ°Server1çš„sessioné‡Œé¢çš„ï¼Œé‚£ä¹ˆåœ¨åç»­çš„ç”¨æˆ·å‘é€è¯·æ±‚ä¸­ï¼Œå¦‚æœä½ å‰é¢çš„è´Ÿè½½å‡è¡¡æ²¡æœ‰åšä¸€äº›ç‰¹æ®Šå¤„ç†ï¼Œå®ƒå¯èƒ½ä¼šå‘åˆ°Server2ä¸Šï¼Œé‚£ä¹ˆå½“åé¢çš„è¯·æ±‚å‘åˆ°Server2ä¸Šçš„æ—¶å€™ï¼Œä½ Server2ä¸Šçš„sessionå¹¶æ²¡æœ‰ä½ ä¹‹å‰åœ¨Server1ä¸Šæ”¾çš„é‚£äº›ç»è¿‡è®¤è¯çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆServer2å°±ä¼šæ‹’ç»æ‰ä½ çš„æœåŠ¡è¯·æ±‚ï¼Œè®©ä½ å†å»ç™»å½•ä¸€éï¼Œè¿™ä¸ªå°±æ˜¯æˆ‘ä»¬å°±æ˜¯è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜ï¼šåœ¨é›†ç¾¤ç¯å¢ƒä¸‹å¤„ç†sessionï¼Œè§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼šä¸æŠŠsessionæ”¾åˆ°æœåŠ¡å™¨ä¸Šï¼Œè€ŒæŠŠå®ƒæŠ½å–å‡ºæ¥ï¼Œå°±è±¡å›¾2é‚£æ ·ï¼ŒServer1ã€Server2ä¾ç„¶æ˜¯é›†ç¾¤å¯¹å¤–æä¾›ç¯å¢ƒï¼Œä½†æ˜¯æˆ‘ä¸åœ¨æ¯ä¸€ä¸ªæœåŠ¡å™¨ä¸Šå•ç‹¬å»ç®¡ç†è‡ªå·±çš„sessionï¼Œè€ŒæŠŠsessionè¿™äº›ä¿¡æ¯æŠ½å–å‡ºæ¥æ”¾åœ¨ç‹¬ç«‹æµ‹å­˜å‚¨ä¸­ï¼Œè¿™æ ·ç”¨æˆ·å‘äº†ä¸€ä¸ªç™»å½•è¯·æ±‚ï¼Œå‘å¾€Server1çš„æ—¶å€™ï¼ŒServer1ç»è¿‡è®¤è¯ä»¥åå®ƒæ˜¯æŠŠä¿¡æ¯æ‰€å¯¹åº”çš„sessionæ”¾åˆ°äº†ä¸€ä¸ªç‹¬ç«‹çš„å­˜å‚¨é‡Œé¢ï¼Œè¿™äº‹æƒ…åç»­çš„è¯·æ±‚å¦‚æœå‘åˆ°Server2ä¸Šï¼ŒServer2åœ¨æ ¡éªŒç”¨æˆ·è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä»sessionæ‹¿ä¿¡æ¯çš„æ—¶å€™ï¼Œå®ƒä¹Ÿæ˜¯ä»å­˜å‚¨é‡Œé¢å»æ‰¾sessionä¿¡æ¯ï¼Œè¿™æ—¶å€™å°±è§£å†³äº†å›¾1çš„é—®é¢˜ã€‚</p><hr><p>åœ¨springä¸­ä¸“é—¨æœ‰ä¸€ä¸ªé¡¹ç›®æ›¿æˆ‘ä»¬æ¥å®Œæˆè¿™ä¸ªäº‹æƒ…ï¼Œåœ¨browserçš„pom.xmlä¸­çš„è¿™ä¸ªä¾èµ–ï¼š</p><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></code></pre><p>å®ƒçš„ä½œç”¨å°±æ˜¯æ¥å®Œæˆä¸Šé¢è¯´çš„å·¥ä½œï¼Œæˆ‘ä»¬åªéœ€è¦å‘Šè¯‰å®ƒä½ åé¢é‡‡ç”¨çš„å­˜å‚¨æ˜¯ä»€ä¹ˆä»¥åŠå­˜å‚¨æ‰€åœ¨çš„åœ°å€å’Œç«¯å£å°±å¯ä»¥äº†ï¼Œspring sessionå®ƒæ”¯æŒå“ªäº›å­˜å‚¨å‘¢ï¼Ÿ</p><pre><code class="hljs java"><span class="hljs-comment">/*</span><span class="hljs-comment"> * Copyright 2012-2016 the original author or authors.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span><span class="hljs-comment"> * you may not use this file except in compliance with the License.</span><span class="hljs-comment"> * You may obtain a copy of the License at</span><span class="hljs-comment"> *</span><span class="hljs-comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><span class="hljs-comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span><span class="hljs-comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="hljs-comment"> * See the License for the specific language governing permissions and</span><span class="hljs-comment"> * limitations under the License.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> org.springframework.boot.autoconfigure.session;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Supported Spring Session data store types.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Tommy Ludwig</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> EddÃº MelÃ©ndez</span><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.4.0</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> StoreType &#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Redis backed sessions.</span><span class="hljs-comment"> */</span>REDIS,<span class="hljs-comment">/**</span><span class="hljs-comment"> * Mongo backed sessions.</span><span class="hljs-comment"> */</span>MONGO,<span class="hljs-comment">/**</span><span class="hljs-comment"> * JDBC backed sessions.</span><span class="hljs-comment"> */</span>JDBC,<span class="hljs-comment">/**</span><span class="hljs-comment"> * Hazelcast backed sessions.</span><span class="hljs-comment"> */</span>HAZELCAST,<span class="hljs-comment">/**</span><span class="hljs-comment"> * Simple in-memory map of sessions.</span><span class="hljs-comment"> */</span>HASH_MAP,<span class="hljs-comment">/**</span><span class="hljs-comment"> * No session data-store.</span><span class="hljs-comment"> */</span>NONE;&#125;</code></pre><p>ä¸Šé¢æ˜¯spring sessionæ‰€æ”¯æŒçš„å­˜å‚¨ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨redisæ¥è¿›è¡Œæ¼”ç¤º</p><p>å®‰è£…redisï¼š</p><pre><code class="hljs bash">docker run --name redis -p 6379:6379 -d redis:3.2</code></pre><p>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨rediså‘¢ï¼Ÿå› ä¸ºsessionå®ƒæ˜¯ä¸€ä¸ªéå¸¸é¢‘ç¹è®¿é—®çš„ä¸œè¥¿ï¼Œå› ä¸ºspring securityå®ƒçš„åŸç†æ˜¯åœ¨ä½ è¯·æ±‚ä¹‹å‰åŠ ä¸€ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œæ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šè¿‡è¿™ä¸ªè¿‡æ»¤å™¨é“¾ï¼Œç„¶åæ¯ä¸ªè¯·æ±‚è¿‡è¿™ä¸ªè¿‡æ»¤å™¨é“¾çš„æ—¶å€™éƒ½ä¼šä»sessioné‡Œå»è¯»SecurityContext,é‚£ä¹ˆå¦‚æœè¿™é‡Œä½¿ç”¨JDBCï¼Œä¹Ÿå°±æ˜¯æ•°æ®é‡Œï¼Œé‚£ä¹ˆè¿™ä¸ªè¯»å–çš„å‹åŠ›å°±éå¸¸å¤§ï¼Œå› ä¸ºæ¯ä¸ªè¯·æ±‚éƒ½ä¼šå»è¯»æ•°æ®ï¼Œsessionå®ƒæœ¬èº«æ˜¯æœ‰ä¸€ä¸ªå¤±æ•ˆæ€§çš„ï¼Œå¦‚æœä½ æŠŠsessionå­˜åˆ°æ•°æ®åº“é‡Œé¢ï¼Œè¿˜è¦è‡ªå·±æ¸…ç†å®ƒï¼Œå»ç»´æŠ¤é‡Œé¢çš„æ•°æ®ï¼Œè€Œrediså®ƒæœ¬èº«å¸¦æœ‰ä¸€ä¸ªè¶…æ—¶çš„ç‰¹æ€§ï¼Œä½ æŠŠæ•°æ®å¸¦è¿›å»å°±å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œåˆ°äº†è¿™ä¸ªæ—¶é—´ï¼Œæ•°æ®å°±æ¸…äº†ã€‚è™½ç„¶ä½¿ç”¨JDBCï¼Œspring sessionä¹Ÿä¼šæ¸…ï¼Œä½†æ˜¯redisæ€§èƒ½æ›´å¥½ä¸€äº›</p><hr><p> ymlï¼š</p><pre><code class="hljs yml"><span class="hljs-attr">spring:</span>  <span class="hljs-attr">session:</span>    <span class="hljs-attr">store-type:</span> <span class="hljs-string">redis</span>  <span class="hljs-attr">redis:</span>    <span class="hljs-attr">host:</span> <span class="hljs-string">mcr.com</span></code></pre><p>æ¥åˆ°ç™»å½•é¡µçš„æ—¶å€™ï¼Œä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜ï¼Œå›¾å½¢éªŒè¯ç æ²¡å‡ºæ¥ã€‚ç°åœ¨æ§åˆ¶å°ä¸ŠæŠ¥äº†ä¸€ä¸ªå¼‚å¸¸ï¼š</p><pre><code class="hljs css"><span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.data</span><span class="hljs-selector-class">.redis</span><span class="hljs-selector-class">.serializer</span><span class="hljs-selector-class">.SerializationException</span>: <span class="hljs-selector-tag">Cannot</span> <span class="hljs-selector-tag">serialize</span>; <span class="hljs-selector-tag">nested</span> <span class="hljs-selector-tag">exception</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.core</span><span class="hljs-selector-class">.serializer</span><span class="hljs-selector-class">.support</span><span class="hljs-selector-class">.SerializationFailedException</span>: <span class="hljs-selector-tag">Failed</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">serialize</span> <span class="hljs-selector-tag">object</span> <span class="hljs-selector-tag">using</span> <span class="hljs-selector-tag">DefaultSerializer</span>; <span class="hljs-selector-tag">nested</span> <span class="hljs-selector-tag">exception</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.IllegalArgumentException</span>: <span class="hljs-selector-tag">DefaultSerializer</span> <span class="hljs-selector-tag">requires</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">Serializable</span> <span class="hljs-selector-tag">payload</span> <span class="hljs-selector-tag">but</span> <span class="hljs-selector-tag">received</span> <span class="hljs-selector-tag">an</span> <span class="hljs-selector-tag">object</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">type</span> <span class="hljs-selector-attr">[com.b4.mcr.auth.core.model.dto.ImageCodeDTO]</span></code></pre><p>è¿™é‡Œè¯´ImageCodeDTOåºåˆ—åŒ–å‡ºäº†é—®é¢˜ï¼Œå®ƒéœ€è¦ä¸€ä¸ªå¯åºåˆ—åŒ–çš„ç±»å‹ï¼ŒåŸå› æ˜¯ImageCodeDTOæ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œä¸ºä»€ä¹ˆä¼šæŠ¥è¿™ä¸ªé”™ï¼ŒåŸå› æ˜¯sessionç°åœ¨å·²ç»æ”¾åˆ°redisé‡Œé¢å»ç®¡ç†äº†ï¼Œç”Ÿæˆå›¾å½¢éªŒè¯ç æœ‰ä¸€æ­¥æ˜¯æŠŠç”Ÿæˆçš„å›¾å½¢éªŒè¯ç æ”¾åˆ°sessioné‡Œé¢å»ï¼Œç„¶ååé¢å†å‘è¯·æ±‚çš„æ—¶å€™å†ä»sessioné‡Œæ‹¿å‡ºæ¥éªŒï¼Œè¿™æ—¶å€™æ”¾åˆ°sessionå®é™…ä¸Šå°±æ˜¯æ”¾åˆ°redisé‡Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567423581144.png" srcset="/img/loading.gif" alt="1567423581144"></p><p>æ”¾åˆ°redisé‡Œçš„ä¸œè¥¿éƒ½éœ€è¦æ˜¯å¯åºåˆ—åŒ–çš„ï¼Œè¿™é‡ŒæŠŠValidateCodeDTOã€ImageCodeDTOå®ç°Serializableæ¥å£</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCodeDTO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ValidateCodeDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span><span class="hljs-class"></span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">ValidateCodeDTO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span></span></code></pre><p>å®ç°Serializableæ¥å£ä»¥ä¸ºï¼Œè¿™é‡Œçš„å±æ€§ä¹Ÿè¦å®ç°Serializableæ¥å£ï¼Œä½†æ˜¯è¿™é‡Œçš„ImageCodeDTOä¸­ç”¨äº†ä¸€ä¸ªBufferedImageçš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯JDKæä¾›çš„ä¸€ä¸ªç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BufferedImage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">java</span>.<span class="hljs-title">awt</span>.<span class="hljs-title">Image</span></span><span class="hljs-class">                           <span class="hljs-keyword">implements</span> <span class="hljs-title">WritableRenderedImage</span>, <span class="hljs-title">Transparency</span></span></code></pre><p>å®ƒæœ¬èº«æ²¡æœ‰å®ç°Serializableæ¥å£ï¼Œè¿™ä¸ªç±»åœ¨å¾€redisé‡Œé¢æ”¾åˆ°çš„æ—¶å€™æ˜¯æ”¾ä¸è¿›å»çš„ï¼Œæ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿè¿™é‡Œæƒ³ä¸€ä¸‹ï¼Œæˆ‘ä»¬æ”¾åˆ°redisï¼ˆsessionï¼‰é‡Œé¢çš„æ•°æ®æ˜¯å¯ä»¥ä¸éœ€è¦æ”¾å›¾ç‰‡è¿›å»çš„ï¼Œåªè¦æŠŠç”Ÿæˆçš„éªŒè¯ç å­—ç¬¦ä¸²æ”¾è¿›å»å°±è¡Œï¼Œå› ä¸ºéªŒçš„æ—¶å€™åªè¦éªŒå­—ç¬¦ä¸²ï¼Œé‚£ä¸ªå›¾ç‰‡åªæ˜¯ç”Ÿæˆçš„æ—¶å€™ï¼Œç»™ç”¨æˆ·çœ‹çš„ã€‚</p><p>è¿™é‡Œæ”¹ä¸€ä¸‹AbstractValidateCodeProcessor#saveï¼Œ</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">    * ä¿å­˜æ ¡éªŒç </span><span class="hljs-comment">    */</span>   <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, C validateCode)</span> </span>&#123;       ValidateCodeDTO validateCodeDTO = <span class="hljs-keyword">new</span> ValidateCodeDTO(validateCode.getCode(), validateCode.getExpireTime());       sessionStrategy.setAttribute(request, getSessionKey(), validateCodeDTO);   &#125;</code></pre><p>è¿™é‡Œå¦‚æœvalidateCodeå‚æ•°æ˜¯ä¸€ä¸ªå›¾ç‰‡å¯¹è±¡ï¼Œsessionä¸­ä¿å­˜çš„æ˜¯ä¸€ä¸ªvalidateCodeDTOå¯¹è±¡ï¼Œå®ƒé‡Œé¢å¹¶æ²¡æœ‰BufferedImageç±»å‹çš„å±æ€§ï¼Œè¿™æ ·é—®é¢˜å°±è§£å†³äº†ã€‚</p><hr><p>ç°åœ¨åŒæ—¶å¯åŠ¨2ä¸ªè¿™æ ·çš„å·¥å‚ï¼Œç¬¬ä¸€ä¸ªå·¥å‚ç™»å½•ä¹‹åï¼Œç¬¬äºŒä¸ªå·¥å‚å°±ä¸ç”¨ç™»å½•ï¼Œå¯ä»¥ç›´æ¥è®¿é—®æˆ‘ä»¬å†™çš„rest apiäº†ï¼Œè¿™å°±è¯´æ˜sessionæ˜¯å…±äº«çš„ï¼Œè¿™æ ·å°±å®ç°äº†æè¿°çš„é›†ç¾¤åœºæ™¯</p><h1 id="é€€å‡º"><a href="#é€€å‡º" class="headerlink" title="é€€å‡º"></a>é€€å‡º</h1><h2 id="ç‚¹å‡»é€€å‡º"><a href="#ç‚¹å‡»é€€å‡º" class="headerlink" title="ç‚¹å‡»é€€å‡º"></a>ç‚¹å‡»é€€å‡º</h2><p>index.html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>index<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>index <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/logout"</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><hr><p>ä»¥ä¸Šä»£ç å°±å®Œæˆäº†é€€å‡ºåŠŸèƒ½ï¼Œè¿™é‡Œçš„/logoutå¤„ç†çš„äº‹æƒ…ï¼š</p><ul><li>ä½¿å½“å‰sessionå¤±æ•ˆ</li><li>æ¸…é™¤ä¸å½“å‰ç”¨æˆ·ç›¸å…³çš„remember-meè®°å½•</li><li>æ¸…ç©ºå½“å‰çš„SecurityContext</li><li>é‡å®šå‘åˆ°ç™»å½•é¡µ</li></ul><p>è¿™é‡Œé€€å‡ºè·³è½¬åˆ°ç™»å½•é¡µé¢çš„æ—¶å€™</p><pre><code class="hljs http"><span class="hljs-attribute">http://www.pinzhi365.com/authentication/require?logout</span></code></pre><p>åé¢ä¼šå¸¦ä¸Š?logout</p><hr><p>ä»¥ä¸Šå°±æ˜¯spring securityé»˜è®¤é€€å‡ºçš„å¤„ç†ï¼Œå¦‚æœè¿™é‡Œçš„é»˜è®¤å¤„ç†ä¸ç¬¦åˆæˆ‘ä»¬çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¦å¦‚ä½•æ¥ä¸ªæ€§åŒ–å‘¢ï¼Ÿç°åœ¨å°±æ¥ç»™è¯»è€…ä»¬ä»‹ç»ä¸€ä¸‹ç›¸å…³çš„é…ç½®ã€‚</p><p>ä¸æƒ³ä½¿ç”¨<code>/logout</code>ï¼Œä½¿ç”¨<code>/signOut</code></p><p>BrowserSecurityConfig:</p><pre><code class="hljs java">http.logout()               .logoutUrl(<span class="hljs-string">"/signOut"</span>)</code></pre><p>index.html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>index<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>index <span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/signOut"</span>&gt;</span>é€€å‡º<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>é€€å‡ºæˆåŠŸä»¥åï¼Œé»˜è®¤çš„æƒ…å†µä¸‹æ˜¯è·³åˆ°ç™»å½•é¡µé“¾æ¥ä¸Šçš„ï¼Œåœ¨æˆ‘ä»¬è¿™è·³åˆ°å…¶ä»–é¡µé¢</p><p>BrowserSecurityConfig:</p><pre><code class="hljs java">http.logout()              .logoutSuccessUrl(<span class="hljs-string">"/mcr-logout.html"</span>)</code></pre><p>mcr-logout.htmlï¼š</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Title<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>é€€å‡ºæˆåŠŸ<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><h2 id="é€€å‡ºæˆåŠŸå¤„ç†å™¨"><a href="#é€€å‡ºæˆåŠŸå¤„ç†å™¨" class="headerlink" title="é€€å‡ºæˆåŠŸå¤„ç†å™¨"></a>é€€å‡ºæˆåŠŸå¤„ç†å™¨</h2><p>BrowserSecurityProperties:</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">   * é€€å‡ºä¹‹åè°ƒç”¨çš„è¯·æ±‚</span><span class="hljs-comment">   */</span>  <span class="hljs-keyword">private</span> String signOutUrl;</code></pre><blockquote><p>è¿™é‡Œå®Œæˆä¸€ä¸ªåŠŸèƒ½ï¼Œä½¿ç”¨è€…é…äº†signOutUrlï¼Œé‚£ä¹ˆå°±è·³åˆ°signOutUrlä¸Šå»ï¼Œå¦‚æœæ²¡é…ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å®ƒéœ€è¦ä¸€ä¸ªjsonæ ¼å¼çš„è¿”å›</p></blockquote><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.session.logout;<span class="hljs-keyword">import</span> com.b4.demo.core.model.vo.McrSecurityVO;<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.springframework.security.core.Authentication;<span class="hljs-keyword">import</span> org.springframework.security.web.DefaultRedirectStrategy;<span class="hljs-keyword">import</span> org.springframework.security.web.RedirectStrategy;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.logout.LogoutSuccessHandler;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrLogoutSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">LogoutSuccessHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> RedirectStrategy redirectStrategy = <span class="hljs-keyword">new</span> DefaultRedirectStrategy();    <span class="hljs-keyword">private</span> ObjectMapper objectMapper = <span class="hljs-keyword">new</span> ObjectMapper();    <span class="hljs-keyword">private</span> String signOutUrl;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrLogoutSuccessHandler</span><span class="hljs-params">(String signOutUrl)</span> </span>&#123;        <span class="hljs-keyword">this</span>.signOutUrl = signOutUrl;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onLogoutSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        log.info(<span class="hljs-string">"ç”¨æˆ·-&gt;&#123;&#125;é€€å‡ºæˆåŠŸ"</span>, authentication.getName());        <span class="hljs-keyword">if</span> (signOutUrl == <span class="hljs-keyword">null</span>) &#123;            response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(<span class="hljs-string">"é€€å‡ºæˆåŠŸ"</span>)));        &#125; <span class="hljs-keyword">else</span> &#123;            redirectStrategy.sendRedirect(request, response, signOutUrl);        &#125;    &#125;&#125;</code></pre><p>BrowserSecurityBeanConfig:</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>   <span class="hljs-meta">@ConditionalOnMissingBean</span>(LogoutSuccessHandler<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">   <span class="hljs-title">public</span> <span class="hljs-title">LogoutSuccessHandler</span> <span class="hljs-title">logoutSuccessHandler</span>() </span>&#123;       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrLogoutSuccessHandler(securityProperties.getBrowser().getSignOutUrl());   &#125;</code></pre><p>BrowserSecurityConfig</p><pre><code class="hljs java">    <span class="hljs-keyword">private</span> LogoutSuccessHandler logoutSuccessHandler; <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        <span class="hljs-comment">//..  </span>http                .logout()<span class="hljs-comment">//                .logoutSuccessUrl("/mcr-logout.html")</span>                .logoutSuccessHandler(logoutSuccessHandler)</code></pre><p>è¿™ä¸€ï¼šè¿™é‡Œå¦‚æœå†™äº†é€€å‡ºè·³è½¬çš„é¡µé¢ï¼Œè¿™é‡Œçš„å¤„ç†å™¨å°±ä¸ç”Ÿæ•ˆäº†ï¼Œè¿™é‡Œåªèƒ½æœ‰ä¸€ä¸ª</p><hr><p>é€€å‡ºçš„æ—¶å€™æ¸…é™¤cookie</p><pre><code class="hljs JAVA">http              .logout()              .deleteCookies(<span class="hljs-string">"JSESSIONID"</span>)</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸‰ã€Social ã€‘ 3.QQç™»å½•</title>
    <link href="/spring-security-3.3.html"/>
    <url>/spring-security-3.3.html</url>
    
    <content type="html"><![CDATA[<h1 id="å¼€å‘æµç¨‹"><a href="#å¼€å‘æµç¨‹" class="headerlink" title="å¼€å‘æµç¨‹"></a>å¼€å‘æµç¨‹</h1><p>ä»¥ä¸‹å†…å®¹ä¸­è·å–QQç”¨æˆ·ä¿¡æ¯ä»¥åŠQQä¸­çš„ä¸€äº›å‚æ•°ï¼Œè¯·å‚è€ƒ<a href="https://connect.qq.com/" target="_blank" rel="noopener">QQäº’è”æ–‡æ¡£</a>ã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567224896676.png" srcset="/img/loading.gif" alt=""></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567227175116.png" srcset="/img/loading.gif" alt=""></p><p>è¦å®ç°ç±»ä¼¼QQç™»å½•è¿™ç§ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œå‰é¢è¯´äº†ï¼Œéœ€è¦èµ°ä¸€ä¸ª<code>OAuth</code>æµç¨‹æ‹¿åˆ°æœåŠ¡æä¾›å•†çš„çš„ç”¨æˆ·ä¿¡æ¯ï¼Œé‚£ä¹ˆä¹‹å‰å°†SpringSocialåŸºæœ¬æ¦‚å¿µçš„æ—¶å€™ï¼ŒæœåŠ¡æä¾›å•†çš„ä¿¡æ¯æ˜¯å°è£…åœ¨Connectioné‡Œçš„ï¼Œæ‰€æœ‰ç°åœ¨è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯éœ€è¦æ‹¿åˆ°ä¸€ä¸ªConnectionï¼Œé‚£ä¹ˆæˆ‘è¦æ‹¿åˆ°ä¸€ä¸ªConnectionï¼Œæˆ‘å°±éœ€è¦æœ‰ä¸€ä¸ª<code>ConnectionFactory</code>å·¥å‚ï¼Œé‚£ä¹ˆæˆ‘è¦æ„å»º<code>ConnectionFactory</code>æˆ‘éœ€è¦2ä¸ªä¸œè¥¿ï¼š<code>ServiceProvider</code>ã€<code>ApiAdapter</code>ï¼›</p><p>é‚£ä¹ˆè¿™ä¸ª<code>ServiceProvider</code>æœåŠ¡æä¾›å•†çš„å®ç°ï¼Œå®ƒä¹Ÿéœ€è¦2ä¸ªä¸œè¥¿ï¼š</p><ol><li><code>OAuth2Operations</code>æ¥å£çš„å®ç°</li><li><code>Api</code>æ¥å£çš„å®ç°ï¼Œå®ƒæ˜¯ç”¨æ¥è¯»å–ç”¨æˆ·çš„ä¿¡æ¯çš„ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯å’ŒæœåŠ¡æä¾›å•†ç´§å¯†ç›¸å…³çš„ï¼Œæ¯ä¸ªæœåŠ¡å•†éƒ½ä¸ä¸€æ ·ï¼Œç­‰ä¼šå°±å…ˆä»è¿™é‡Œå…¥æ‰‹</li></ol><p>æ•´ä¸ªå¼€å‘çš„æµç¨‹ï¼šå…ˆä»<code>Api</code>å¼€å§‹ ï¼Œè·å–ç”¨æˆ·ä¿¡æ¯çš„å®ç°ï¼Œç„¶åæœ‰äº†<code>Api</code>æˆ‘ç”¨å®ƒé»˜è®¤çš„<code>OAuth2Template</code>åšä¸º<code>OAuth2Operations</code>çš„å®ç°ï¼Œç”¨è¿™2ä¸ªä¸œè¥¿æ„å»ºå‡º<code>ServiceProvider</code>æ¥ï¼Œç„¶åå®ç°è¿™ä¸ª<code>ApiAdapter</code>,<code>ServiceProvider</code>å’Œ<code>ApiAdapter</code>æœ‰äº†ï¼Œå°±å¯ä»¥æ„å»ºå‡ºä¸€ä¸ª<code>ConnectionFactory</code>ï¼Œæœ‰äº†è¿™ä¸ªä¸œè¥¿æˆ‘å°±å¯ä»¥é€šè¿‡ï¼Œæœ‰äº†<code>ConnectionFactory</code>å°±å¯ä»¥æ‹¿åˆ°æˆ‘çš„ç”¨æˆ·ä¿¡æ¯äº†ï¼Œæœ‰äº†ç”¨æˆ·ä¿¡æ¯ä»¥åï¼Œæˆ‘ä»¬ä¼šåœ¨æ•°æ®åº“é‡Œå»ºä¸€å¼ <code>UserConnection</code>è¡¨ï¼Œç„¶åè¿™ä¸ª<code>JdbcUsersConnectionRepository</code>ï¼Œè¿™ä¸ªä¸œè¥¿<code>SpringSocial</code>å·²ç»æä¾›äº†ï¼Œåªéœ€è¦é…ç½®ä¸€ä¸‹å‘Šè¯‰å®ƒæ•°æ®åº“åœ¨å“ªå°±å¯ä»¥äº†ï¼Œé‚£ä¹ˆè¿™äº›æœ‰äº†ä¹‹åï¼Œå°±å¯ä»¥é€šè¿‡<code>ConnectionFactory</code>æ‹¿åˆ°æˆ‘ä»¬çš„æœåŠ¡æä¾›å•†ç”¨æˆ·ä¿¡æ¯ï¼Œé‚£ä¹ˆæ•´ä¸ªæµç¨‹å°±å¯ä»¥è½¬èµ·æ¥äº†ï¼Œè½¬èµ·æ¥ä»¥åæ ¹æ®é—®é¢˜ä¸€æ­¥æ­¥é€æ¸å»ç»†åŒ–</p><h1 id="Api"><a href="#Api" class="headerlink" title="Api"></a>Api</h1><p>é¦–å…ˆæ¥åˆ°æ–‡æ¡£<a href="https://wiki.connect.qq.com/get_user_info" target="_blank" rel="noopener">https://wiki.connect.qq.com/get_user_info</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567246322516.png" srcset="/img/loading.gif" alt="1567246322516"></p><p>æ ¹æ®æ–‡ç« ä¸Šçš„josnå°è£…æˆä¸€ä¸ªç±»ï¼Œè¿™é‡Œä¸»è¦éœ€è¦å¤šåŠ ä¸€ä¸ª<code>openId</code>å­—æ®µ</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.api;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQUserInfo</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ret;    <span class="hljs-keyword">private</span> String msg;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> is_lost;    <span class="hljs-keyword">private</span> String nickname;    <span class="hljs-keyword">private</span> String gender;    <span class="hljs-keyword">private</span> String province;    <span class="hljs-keyword">private</span> String city;    <span class="hljs-keyword">private</span> String year;    <span class="hljs-keyword">private</span> String constellation;    <span class="hljs-keyword">private</span> String figureurl;    <span class="hljs-keyword">private</span> String figureurl_1;    <span class="hljs-keyword">private</span> String figureurl_2;    <span class="hljs-keyword">private</span> String figureurl_qq_1;    <span class="hljs-keyword">private</span> String figureurl_qq_2;    <span class="hljs-keyword">private</span> String figureurl_qq;    <span class="hljs-keyword">private</span> String figureurl_type;    <span class="hljs-keyword">private</span> String is_yellow_vip;    <span class="hljs-keyword">private</span> String vip;    <span class="hljs-keyword">private</span> String yellow_vip_level;    <span class="hljs-keyword">private</span> String level;    <span class="hljs-keyword">private</span> String is_yellow_year_vip;    <span class="hljs-keyword">private</span> String openId;&#125;</code></pre><p>å®šä¹‰ä¸€ä¸ªè·å–QQä¿¡æ¯çš„æ¥å£</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.api;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">QQ</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–QQä¿¡æ¯</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span>   QQä¿¡æ¯</span><span class="hljs-comment">     */</span>    <span class="hljs-function">QQUserInfo <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span></span>;&#125;</code></pre><p>ä¹‹å‰è¯´æ‰€æœ‰çš„<code>Api</code>éƒ½è¦ç»§æ‰¿<code>AbstractOAuth2ApiBinding</code>ï¼Œå…ˆæ¥çœ‹ä¸‹å®ƒé•¿ä»€ä¹ˆæ ·å­</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractOAuth2ApiBinding</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApiBinding</span>, <span class="hljs-title">InitializingBean</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String accessToken;<span class="hljs-keyword">private</span> RestTemplate restTemplate;<span class="hljs-comment">//...</span>&#125;</code></pre><p>åœ¨è¿™ä¸ªæŠ½è±¡ç±»é‡Œé¢å®ƒæä¾›äº†2ä¸ªå±æ€§ï¼š</p><ol><li><code>accessToken</code>ï¼šæˆ‘ä»¬ç°åœ¨çš„<code>api</code>åœ¨æ•´ä¸ªæµç¨‹é‡Œæ˜¯æ‰§è¡Œç¬¬6æ­¥è·å–ç”¨æˆ·ä¿¡æ¯çš„ï¼Œæ‰§è¡Œç¬¬6æ­¥éœ€è¦ç¬¬5æ­¥æœ€åæœ€åæ”¶åˆ°çš„ä»¤ç‰Œï¼Œæ‹¿è¿™ä¸ªä»¤ç‰Œæ‰èƒ½è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œè¿™é‡Œæ³¨æ„ï¼šæ¯ä¸€ä¸ªäººèµ°è¿™ä¸ªæµç¨‹å®ƒè·å–åˆ°çš„ä»¤ç‰Œéƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™ä¸ªæ•°æ®å®ƒæ˜¯ç±»çš„æˆå‘˜å˜é‡ï¼Œé‚£ä¹ˆæ„å¤–ç€ï¼Œè¿™ä¸ªç±»çš„å®ç°ç±»å®ƒä¸æ˜¯ä¸€ä¸ªå•ä¾‹å¯¹è±¡ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªç”¨æˆ·å®ƒèµ°å®Œè‡ªå·±çš„è¿™ä¸ª<code>OAuth</code>æµç¨‹ï¼Œéƒ½ä¼šå¯¹ç”¨æˆ·å•ç‹¬åˆ›å»ºä¸€ä¸ªå®ç°ï¼Œåœ¨é‡Œé¢å­˜è¿™ä¸ªç”¨æˆ·ä»–è‡ªå·±ç‰¹æœ‰çš„<code>accessToken</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå¤šå®ç°çš„å¯¹è±¡ï¼›</li><li><code>restTemplate</code>ï¼šå› ä¸ºç¬¬6æ­¥è·å–ç”¨æˆ·ä¿¡æ¯éœ€è¦å¾€æœåŠ¡æä¾›å•†å‘é€httpè¯·æ±‚ï¼Œè¿™ä¸ª<code>restTemplate</code>å°±æ˜¯httpè¯·æ±‚å·¥å…·ã€‚</li></ol><p>æ¥åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿<code>AbstractOAuth2ApiBinding</code>ï¼Œå®ç°QQæ¥å£</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.api;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.AbstractOAuth2ApiBinding;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractOAuth2ApiBinding</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">QQ</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> QQUserInfo <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;    &#125;&#125;</code></pre><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸‹QQæ–‡æ¡£ï¼Œè¦å‘ä¸€ä¸ªä»€ä¹ˆè¯·æ±‚ï¼Œä¼ é€’ä»€ä¹ˆå‚æ•°,æ–‡æ¡£åœ°å€ï¼š<a href="https://wiki.connect.qq.com/openapiè°ƒç”¨è¯´æ˜_oauth2-0" target="_blank" rel="noopener">https://wiki.connect.qq.com/openapi%E8%B0%83%E7%94%A8%E8%AF%B4%E6%98%8E_oauth2-0</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567248607175.png" srcset="/img/loading.gif" alt=""></p><p>æƒ³è°ƒç”¨è¿™ä¸ªè¯·æ±‚ï¼Œæœ‰3ä¸ªå‚æ•°ï¼š</p><ol><li>access_tokenï¼šèµ°å®Œå›¾1 å‰5æ­¥æ‹¿åˆ°çš„ä»¤ç‰Œï¼Œè¿™é‡Œçš„<code>access_token</code>å°±åœ¨<code>AbstractOAuth2ApiBinding</code>é‡Œé¢</li><li>oauth_consumer_keyï¼šä½ è¦ç”¨QQã€å¾®ä¿¡ç™»å½•é¦–å…ˆè¦åˆ°QQäº’è”ã€å¾®ä¿¡å¼€æ”¾å¹³å°ä¸Šå»æ³¨å†Œï¼Œæ³¨å†Œå®Œäº† ä»¥åï¼Œå®ƒä¼šåˆ†é…ç»™ä½ ä¸€ä¸ª<code>appId</code></li><li>openidï¼šç”¨æˆ·çš„IDï¼Œä¸QQå·ç ä¸€ä¸€å¯¹åº”ã€‚ â€œå¯é€šè¿‡è°ƒç”¨<a href="https://graph.qq.com/oauth2.0/me?access_token=YOUR_ACCESS_TOKEN" target="_blank" rel="noopener">https://graph.qq.com/oauth2.0/me?access_token=YOUR_ACCESS_TOKEN</a> æ¥è·å–ã€‚â€</li></ol><p>é¦–å…ˆå°†è¯´è¿™3ä¸ªå‚æ•°ï¼Œå…¶ä¸­çš„<code>access_token</code>å·²ç»å¤„ç†äº†ï¼Œè¿™é‡Œè¦æŠŠå¦å¤–2ä¸ªå†™ä¸€ä¸‹</p><pre><code class="hljs java"><span class="hljs-comment">//æ³¨å†Œqqäº’è”åˆ†é…çš„appid</span><span class="hljs-keyword">private</span> String appId;<span class="hljs-comment">//qqç”¨æˆ·çš„Id</span><span class="hljs-keyword">private</span> String openId;</code></pre><p>ç„¶åè¿˜æœ‰2ä¸ªhttpè·¯å¾„ï¼š</p><ol><li>é€šè¿‡<code>access_token</code>å»æ‹¿<code>openId</code>å‘çš„è¯·æ±‚åœ°å€</li><li>è·å–ç”¨æˆ·ä¿¡æ¯çš„è¯·æ±‚åœ°å€</li></ol><p>è¿™é‡Œå°†2ä¸ªè¯·æ±‚è·¯å¾„å£°æ˜æˆå¸¸é‡</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_GET_OPENID = <span class="hljs-string">"https://graph.qq.com/oauth2.0/me?access_token=%s"</span>;  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_GET_USERINFO = <span class="hljs-string">"https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s"</span>;</code></pre><blockquote><p>ä»QQäº’è”æ–‡æ¡£é‡Œï¼Œå¯ä»¥çœ‹åˆ°è·å–ç”¨æˆ·ä¿¡æ¯æ˜¯éœ€è¦<code>access_token</code>å‚æ•°çš„ï¼Œä½†åœ¨æˆ‘ä»¬è¿™é‡Œä¸éœ€è¦å†™ï¼Œå› ä¸ºè¿™ä¸€æ­¥äº¤ç»™æˆ‘ä»¬çˆ¶ç±»æ¥å¤„ç†äº†ï¼Œå®ƒä¼šè‡ªåŠ¨å¾—å°†<code>access_token</code>æ›¿æˆ‘ä»¬æŒ‚ä¸Šå»</p></blockquote><p>æ„é€ å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQImpl</span><span class="hljs-params">(String accessToken, String appId)</span> </span>&#123;     <span class="hljs-keyword">super</span>(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);     <span class="hljs-keyword">this</span>.appId = appId; &#125;</code></pre><p>ä¸Šé¢ä»£ç è°ƒç”¨äº†çˆ¶ç±»çš„2ä¸ªå‚æ•°çš„æ„é€ å™¨ï¼Œç¬¬2ä¸ªå‚æ•°ä½¿ç”¨äº†<code>TokenStrategy.ACCESS_TOKEN_PARAMETER</code>ç­–ç•¥ï¼Œæ¥çœ‹ä¸€ä¸‹çˆ¶ç±»çš„ä¸€ä¸ªå‚æ•°çš„æ„é€ å™¨ï¼Œå®ƒä¼šè°ƒç”¨è‡ªå·±2ä¸ªå‚æ•°çš„æ„é€ å™¨ï¼ŒåŒæ—¶ç”¨ä¸€ä¸ªé»˜è®¤çš„<code>token</code>ç­–ç•¥å»è°ƒï¼Œ</p><p><code>TokenStrategy.AUTHORIZATION_HEADER</code>ï¼šåœ¨å‘è¯·æ±‚çš„æ—¶å€™ï¼Œé»˜è®¤æŠŠ<code>accessToken</code>æ”¾åˆ°è¯·æ±‚å¤´é‡Œé¢ï¼Œä½†æ˜¯åœ¨QQæ–‡æ¡£ä¸Šè¦æ±‚<code>accessToken</code>åº”è¯¥è¦æ”¾åˆ°æŸ¥è¯¢å‚æ•°é‡Œé¢å»ï¼š<a href="https://graph.qq.com/user/get_user_info?access_token=YOUR_ACCESS_TOKEN&oauth_consumer_key=YOUR_APP_ID&openid=YOUR_OPENID" target="_blank" rel="noopener">https://graph.qq.com/user/get_user_info?access_token=YOUR_ACCESS_TOKEN&amp;oauth_consumer_key=YOUR_APP_ID&amp;openid=YOUR_OPENID</a>ï¼Œ<code>AbstractOAuth2ApiBinding</code>çš„ä¸€ä¸ªå‚æ•°çš„æ„é€ å™¨ä¼šå°†å‚æ•°æ”¾åˆ°<code>Authorizationè¯·æ±‚å¤´</code>é‡Œé¢ï¼Œæ‰€ä»¥é»˜è®¤çš„ä»£ç è¡Œä¸ºä¸ç¬¦åˆåšQQç™»å½•çš„è¦æ±‚ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥è°ƒç”¨2ä¸ªå‚æ•°çš„æ„é€ å™¨ï¼Œä½¿ç”¨<code>AUTHORIZATION_HEADER</code>ç­–ç•¥</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-title">AbstractOAuth2ApiBinding</span><span class="hljs-params">(String accessToken)</span> </span>&#123;<span class="hljs-keyword">this</span>(accessToken, TokenStrategy.AUTHORIZATION_HEADER);&#125;</code></pre><p>é€šè¿‡ä¸Šé¢è¿™ä¸ªæ„é€ å™¨ï¼Œä½ åœ¨ä½¿ç”¨å®ƒé‡Œé¢çš„<code>restTemplate</code>å‘è¯·æ±‚çš„æ—¶å€™ï¼Œå®ƒä¼šè‡ªåŠ¨æŠŠ<code>accessToken</code>ä½œä¸ºæŸ¥è¯¢å‚æ•°ï¼ŒæŠŠå®ƒæŒ‚ä¸Šå»</p><hr><p>QQäº’è”æ–‡æ¡£ä¸Šï¼Œè¦æ±‚å…ˆè¦è·å–<code>openId</code>ï¼Œè·å–<code>openId</code>ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQImpl</span><span class="hljs-params">(String accessToken, String appId)</span> </span>&#123;      <span class="hljs-comment">//...</span>       String url = String.format(URL_GET_OPENID, accessToken);       String result = getRestTemplate().getForObject(url, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;       log.info(result);       <span class="hljs-keyword">this</span>.openId = StringUtils.substringBetween(result, <span class="hljs-string">"\"openid\":\""</span>, <span class="hljs-string">"\"&#125;"</span>);       log.info(<span class="hljs-string">"openId-&gt;&#123;&#125;"</span>, <span class="hljs-keyword">this</span>.openId);   &#125;</code></pre><p>è¿™é‡Œè¦é€šè¿‡æˆªå–æ¥è·å–<code>openId</code>ï¼Œæ–‡æ¡£è¯´å®ƒæ˜¯é•¿è¿™ä¸ªæ ·å­çš„ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567250832980.png" srcset="/img/loading.gif" alt="1567250832980"></p><p>å®ç°QQæ¥å£æ–¹æ³•ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> ObjectMapper objectMapper=<span class="hljs-keyword">new</span> ObjectMapper(); <span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> QQUserInfo <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span> </span>&#123;     String url = String.format(URL_GET_USERINFO, appId, openId);     String result = getRestTemplate().getForObject(url, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;     log.info(result);     <span class="hljs-keyword">try</span> &#123;         QQUserInfo qqUserInfo = objectMapper.readValue(result, QQUserInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;         qqUserInfo.setOpenId(openId);         <span class="hljs-keyword">return</span> qqUserInfo;     &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;         e.printStackTrace();         <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"è·å–ç”¨æˆ·å¤±è´¥"</span>, e);     &#125; &#125;</code></pre><p>å®Œæ•´ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.api;<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.AbstractOAuth2ApiBinding;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.TokenStrategy;<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractOAuth2ApiBinding</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">QQ</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_GET_OPENID = <span class="hljs-string">"https://graph.qq.com/oauth2.0/me?access_token=%s"</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_GET_USERINFO = <span class="hljs-string">"https://graph.qq.com/user/get_user_info?oauth_consumer_key=%s&amp;openid=%s"</span>;    <span class="hljs-comment">//æ³¨å†Œqqäº’è”åˆ†é…çš„appid</span>    <span class="hljs-keyword">private</span> String appId;    <span class="hljs-comment">//qqç”¨æˆ·çš„Id</span>    <span class="hljs-keyword">private</span> String openId;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQImpl</span><span class="hljs-params">(String accessToken, String appId)</span> </span>&#123;        <span class="hljs-keyword">super</span>(accessToken, TokenStrategy.ACCESS_TOKEN_PARAMETER);        <span class="hljs-keyword">this</span>.appId = appId;        String url = String.format(URL_GET_OPENID, accessToken);        String result = getRestTemplate().getForObject(url, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;        log.info(result);        <span class="hljs-keyword">this</span>.openId = StringUtils.substringBetween(result, <span class="hljs-string">"\"openid\":\""</span>, <span class="hljs-string">"\"&#125;"</span>);        log.info(<span class="hljs-string">"openId-&gt;&#123;&#125;"</span>, <span class="hljs-keyword">this</span>.openId);    &#125;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper=<span class="hljs-keyword">new</span> ObjectMapper();    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> QQUserInfo <span class="hljs-title">getUserInfo</span><span class="hljs-params">()</span> </span>&#123;        String url = String.format(URL_GET_USERINFO, appId, openId);        String result = getRestTemplate().getForObject(url, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;        log.info(result);        <span class="hljs-keyword">try</span> &#123;            QQUserInfo qqUserInfo = objectMapper.readValue(result, QQUserInfo<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;            qqUserInfo.setOpenId(openId);            <span class="hljs-keyword">return</span> qqUserInfo;        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;            e.printStackTrace();            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"è·å–ç”¨æˆ·å¤±è´¥"</span>, e);        &#125;    &#125;&#125;</code></pre><h1 id="ServiceProvider"><a href="#ServiceProvider" class="headerlink" title="ServiceProvider"></a>ServiceProvider</h1><p>ç°åœ¨<code>api</code>æœ‰äº†ï¼Œè¿™é‡Œçœ‹å›¾2å®ƒè¿˜éœ€è¦ä¸€ä¸ª<code>OAuth2Operations</code>å®ç°ç±»ï¼Œè¿™é‡Œå°±å…ˆæš‚æ—¶ä½¿ç”¨å®ƒé»˜è®¤æä¾›çš„<code>OAuth2Template</code>ï¼Œç°åœ¨å°±å¯ä»¥æ¥å†™<code>ServiceProvider</code>äº†</p><p>å®Œæ•´ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.connect;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.social.qq.api.QQ;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.social.qq.api.QQImpl;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.AbstractOAuth2ServiceProvider;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.OAuth2Operations;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.OAuth2ServiceProvider;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.OAuth2Template;<span class="hljs-comment">/**</span><span class="hljs-comment"> * QQServiceProvider</span><span class="hljs-comment"> * appIdï¼šæ³¨å†Œqqäº’è”åˆ†é…çš„id</span><span class="hljs-comment"> * appSecretï¼šæ³¨å†Œqqäº’è”çš„åˆ†é…å¯†ç </span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractOAuth2ServiceProvider</span>&lt;<span class="hljs-title">QQ</span>&gt; </span>&#123;    <span class="hljs-keyword">private</span> String appId;    <span class="hljs-comment">//å°†ç”¨æˆ·å¯¼å‘çš„è®¤è¯æœåŠ¡å™¨çš„åœ°å€</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_AUTHORIZE = <span class="hljs-string">"https://graph.qq.com/oauth2.0/authorize"</span>;    <span class="hljs-comment">//ç¬¬ä¸‰æ–¹æ‹¿ç€æˆæƒç è·å–Tokençš„åœ°å€</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String URL_ACCESS_TOKEN = <span class="hljs-string">"https://graph.qq.com/oauth2.0/token"</span>;    <span class="hljs-comment">//æä¾›OAuth2Operations</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQServiceProvider</span><span class="hljs-params">(String appId, String appSecret)</span> </span>&#123;        <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> OAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));        <span class="hljs-keyword">this</span>.appId = appId;    &#125;    <span class="hljs-comment">//æä¾›Api</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> QQ <span class="hljs-title">getApi</span><span class="hljs-params">(String accessToken)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QQImpl(accessToken, appId);    &#125;&#125;</code></pre><p>ç¼–å†™<code>QQServiceProvider</code>ï¼Œç»§æ‰¿<code>AbstractOAuth2ServiceProvider</code>ï¼Œå®ƒè¿™é‡Œæœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼š<code>getApi</code>ï¼Œéœ€è¦æˆ‘ä»¬æ¥å®ç°ï¼Œå®ƒä¼šå°†å‰5æ­¥æµç¨‹ä¸­å¾—åˆ°çš„ä»¤ç‰Œäº¤ç»™ä¹‹å‰å†™çš„<code>QQImpl</code>ï¼Œæ‰€ä»¥è¿™é‡Œçš„<code>getApi</code>å®ä¾‹åŒ–çš„æ—¶å€™é€šè¿‡æ„é€ å™¨ä¼ ç»™<code>QQImpl</code>ï¼Œè¿™é‡Œçš„<code>appId</code>æ˜¯å›ºå®šå”¯ä¸€çš„ï¼Œå®ƒä¸ä¼šå˜ã€‚</p><pre><code class="hljs java"><span class="hljs-comment">//æä¾›Api</span>  <span class="hljs-meta">@Override</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> QQ <span class="hljs-title">getApi</span><span class="hljs-params">(String accessToken)</span> </span>&#123;      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QQImpl(accessToken, appId);  &#125;</code></pre><p>ç„¶åè¯´ä¸‹æ„é€ å™¨</p><pre><code class="hljs java"><span class="hljs-comment">//æä¾›OAuth2Operations</span>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQServiceProvider</span><span class="hljs-params">(String appId, String appSecret)</span> </span>&#123;       <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> OAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));       <span class="hljs-comment">//...</span>   &#125;</code></pre><p>è¿™é‡Œè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ æ–¹å™¨ï¼Œè¿™é‡Œéœ€è¦ä¼ é€’ä¸€ä¸ª<code>OAuth2Operations</code>æ¥å£çš„å®ç°ç±»ï¼Œä¹‹å‰è¯´è¿‡æš‚æ—¶ä½¿ç”¨å®ƒé»˜è®¤æä¾›çš„<code>OAuth2Template</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AbstractOAuth2ServiceProvider</span><span class="hljs-params">(OAuth2Operations oauth2Operations)</span> </span>&#123;<span class="hljs-keyword">this</span>.oauth2Operations = oauth2Operations;&#125;</code></pre><p>è¿™é‡Œä½¿ç”¨äº†<code>OAuth2Template</code>4ä¸ªå‚æ•°çš„æ„é€ å™¨</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Constructs an OAuth2Template for a given set of client credentials. </span><span class="hljs-comment"> * Assumes that the authorization URL is the same as the authentication URL.</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> clientId the client ID</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> clientSecret the client secret</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> authorizeUrl the base URL to redirect to when doing authorization code or implicit grant authorization</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> accessTokenUrl the URL at which an authorization code, refresh token, or user credentials may be exchanged for an access token.</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OAuth2Template</span><span class="hljs-params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;<span class="hljs-keyword">this</span>(clientId, clientSecret, authorizeUrl, <span class="hljs-keyword">null</span>, accessTokenUrl);&#125;</code></pre><ol><li>clientIdï¼šå®ƒå°±æ˜¯<code>appId</code>,QQä¸Šæ³¨å†Œçš„æ—¶å€™ä¼šåˆ†é…ç»™ä½ ä¸€ä¸ª<code>appId</code></li><li>clientSecretï¼šQQäº’è”ç½‘ä¸Šæ³¨å†Œæ—¶å€™ï¼Œå®ƒä¼šåˆ†é…ç»™ä½ ä¸€ä¸ªApp Secret</li><li>authorizeUrlï¼šå›¾1çš„ç¬¬1æ­¥ï¼Œå°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¯¼å‘çš„URLåœ°å€</li><li>accessTokenUrlï¼šå›¾1çš„ç¬¬4æ­¥ï¼Œç”¨æˆ·åŒæ„æˆæƒçš„æ—¶å€™ï¼Œç”¨æˆ·æœåŠ¡å™¨è¿”å›ä¸€ä¸ªæˆæƒç ï¼Œæ‹¿ç€æˆæƒç å»ç”³è¯·ä»¤ç‰Œçš„åœ°å€</li></ol><p>è¿™é‡Œæˆ‘ä»¬å†™çš„<code>QQServiceProvider</code>ä¸ºä»€ä¹ˆä¼šæœ‰<code>appId</code>ã€<code>appSecret</code>2ä¸ªå‚æ•°ï¼Œå› ä¸ºä½¿ç”¨è€…Aï¼Œåœ¨ä½¿ç”¨æˆ‘ä»¬çš„ä»£ç çš„æ—¶å€™ï¼Œå®ƒçš„<code>appId</code>ã€<code>appSecret2</code>ä¸ä½¿ç”¨è€…Bæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ¯ä¸ªäººç”³è¯·æ‹¿åˆ°çš„<code>appId</code>ã€<code>appSecret</code>éƒ½ä¸ä¸€æ ·</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQServiceProvider</span><span class="hljs-params">(String appId, String appSecret)</span> </span>&#123;          <span class="hljs-comment">//...</span>&#125;</code></pre><h1 id="ApiAdapter"><a href="#ApiAdapter" class="headerlink" title="ApiAdapter"></a>ApiAdapter</h1><p>ä¹‹å‰å°†å›¾2å³è¾¹éƒ¨åˆ†çš„ä»£ç å®Œæˆäº†ï¼Œç°åœ¨æ¥å®ç°å·¦è¾¹çš„ä»£ç ï¼Œå›¾ä¸­è¡¨ç¤º<code>ConnectionFactory</code>ä¸­éœ€è¦<code>ServiceProvider</code>ï¼Œå·²ç»å®ç°äº†ï¼Œç°åœ¨è¿˜éœ€è¦<code>ApiAdapter</code>ï¼Œ<code>ApiAdapter</code>çš„ä½œç”¨ï¼šå°†ä¹‹å‰å†™çš„<code>Api</code>æ‰€è·å–åˆ°çš„ä¸ªæ€§åŒ–æœåŠ¡æä¾›å•†ç”¨æˆ·æ•°æ®å’Œ<code>SpringSocial</code>æ ‡å‡†çš„æ•°æ®ç»“æ„ä¹‹é—´åšä¸€ä¸ªé€‚é…</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.connect;<span class="hljs-comment">/**</span><span class="hljs-comment"> * QQAdapter</span><span class="hljs-comment"> * å°†æœåŠ¡æä¾›å•†ç”¨æˆ·ä¿¡æ¯è¿›è¡Œç»Ÿä¸€çš„é€‚é…</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQAdapter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApiAdapter</span>&lt;<span class="hljs-title">QQ</span>&gt; </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-comment">//ç”¨æ¥æµ‹è¯•å½“å‰APIæ˜¯å¦å¯ç”¨</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">test</span><span class="hljs-params">(QQ api)</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;    <span class="hljs-comment">//è®¾ç½®åˆ›å»ºConnectionçš„æ—¶å€™éœ€è¦çš„ä¸€äº›é…ç½®é¡¹ConnectionValues</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setConnectionValues</span><span class="hljs-params">(QQ api, ConnectionValues values)</span> </span>&#123;        QQUserInfo userInfo = api.getUserInfo();        values.setDisplayName(userInfo.getNickname());        values.setImageUrl(userInfo.getFigureurl_qq_1());        values.setProfileUrl(<span class="hljs-keyword">null</span>);<span class="hljs-comment">//ä¸»é¡µ</span>        values.setProviderUserId(userInfo.getOpenId());<span class="hljs-comment">//ç”¨æˆ·åœ¨æœåŠ¡æä¾›å•†çš„å”¯ä¸€æ ‡ç¤ºï¼ŒopenID</span>    &#125;    <span class="hljs-comment">//ç»‘å®šè§£ç»‘çš„æ—¶å€™</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserProfile <span class="hljs-title">fetchUserProfile</span><span class="hljs-params">(QQ api)</span> </span>&#123;        <span class="hljs-comment">// TODO Auto-generated method stub</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">updateStatus</span><span class="hljs-params">(QQ api, String message)</span> </span>&#123;        <span class="hljs-comment">//do noting</span>    &#125;&#125;</code></pre><h1 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h1><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xdc.mcr.core.social.qq.connect;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å°†ä¹‹å‰å†™çš„</span><span class="hljs-comment"> * QQServiceProviderå’ŒQQAdapterä¼ é€’è¿›æ¥åˆ›å»º</span><span class="hljs-comment"> * QQConnectionFactory</span><span class="hljs-comment"> * providerIdï¼šç”¨æˆ·åœ¨æœåŠ¡å•†çš„å”¯ä¸€æ ‡ç¤ºopenId</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQConnectionFactory</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OAuth2ConnectionFactory</span>&lt;<span class="hljs-title">QQ</span>&gt; </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQConnectionFactory</span><span class="hljs-params">(String providerId, String appId, String appSecret)</span> </span>&#123;      <span class="hljs-keyword">super</span>(providerId, <span class="hljs-keyword">new</span> QQServiceProvider(appId, appSecret), <span class="hljs-keyword">new</span> QQAdapter());   &#125;&#125;</code></pre><p>æ¥çœ‹ä¸€ä¸‹å®ƒ çˆ¶ç±»<code>OAuth2ConnectionFactory</code>çš„æ„é€ å™¨</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * Create a &#123;<span class="hljs-doctag">@link</span> OAuth2ConnectionFactory&#125;.</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> providerId the provider id e.g. "facebook"</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> serviceProvider the ServiceProvider model for conducting the authorization flow and obtaining a native service API instance.</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> apiAdapter the ApiAdapter for mapping the provider-specific service API model to the uniform &#123;<span class="hljs-doctag">@link</span> Connection&#125; interface.</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">OAuth2ConnectionFactory</span><span class="hljs-params">(String providerId, OAuth2ServiceProvider&lt;S&gt; serviceProvider, ApiAdapter&lt;S&gt; apiAdapter)</span> </span>&#123;<span class="hljs-keyword">super</span>(providerId, serviceProvider, apiAdapter);&#125;</code></pre><p>è¿™é‡Œæœ‰3ä¸ªå‚æ•°ï¼š</p><ol><li><code>ProviderId</code>æä¾›å•†çš„å”¯ä¸€æ ‡è¯†ï¼Œè¿™ä¸ªå› ä¸ºæ¯ä¸ªä½¿ç”¨è€…çš„éƒ½ä¸ä¸€æ ·ï¼Œç­‰ä¼šé€šè¿‡é…ç½®æ–‡ä»¶é…è¿›æ¥</li><li>ServiceProviderï¼šå®ƒç±»å‹æ˜¯<code>OAuth2ServiceProvider</code>ï¼Œä¹‹å‰æˆ‘ä»¬å†™çš„<code>QQServiceProvider</code>å°±æ˜¯è¿™ä¸ªç±»å‹çš„å­ç±»ï¼Œè¿™é‡ŒæŠŠ<code>QQServiceProvider</code>çš„å®ä¾‹ä¼ é€’è¿›å»</li><li>ApiAdapterï¼šè¿™é‡Œè¦æ±‚æ˜¯å®ç°<code>ApiAdapter</code>æ¥å£çš„ï¼Œä¹Ÿå°±æ˜¯å‰é¢å†™çš„<code>QQAdapter</code>ï¼Œä¼ é€’è¿›å»</li></ol><h1 id="SpringSocialé…ç½®"><a href="#SpringSocialé…ç½®" class="headerlink" title="SpringSocialé…ç½®"></a>SpringSocialé…ç½®</h1><p>å›¾2ä¸­çš„Connectionä¸éœ€è¦å®ç°ï¼Œç°åœ¨åªå·®<code>UsersConnectionRepository</code>äº†ï¼Œè¿™ä¸ªå®é™…ä¸Š<code>SpringSocial</code>å·²ç»ä¸ºæˆ‘ä»¬æä¾›å¥½äº†ï¼Œåªéœ€è¦é…ä¸€ä¸‹</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableSocial</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> DataSource dataSource;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UsersConnectionRepository <span class="hljs-title">getUsersConnectionRepository</span><span class="hljs-params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;        <span class="hljs-comment">//Encryptors.noOpText()ä¸åšåŠ è§£å¯†</span>        JdbcUsersConnectionRepository repository = <span class="hljs-keyword">new</span> JdbcUsersConnectionRepository(dataSource, connectionFactoryLocator, Encryptors.noOpText());        <span class="hljs-comment">//å»ºè¡¨çš„å‰ç¼€</span>        <span class="hljs-comment">//repository.setTablePrefix("t_");</span>        <span class="hljs-keyword">return</span> repository;    &#125;    <span class="hljs-comment">//å°†SpringSocialFilteræ·»åŠ åˆ°å®‰å…¨é…ç½®çš„Bean</span>    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SpringSocialConfigurer <span class="hljs-title">socialSecurityConfig</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SpringSocialConfigurer();    &#125;&#125;</code></pre><p>è¯´ä¸‹è¿™è¡Œä»£ç </p><pre><code class="hljs java">JdbcUsersConnectionRepository repository = <span class="hljs-keyword">new</span> JdbcUsersConnectionRepository(dataSource, connectionFactoryLocator, Encryptors.noOpText());</code></pre><p>è¿™é‡Œ<code>JdbcUsersConnectionRepository</code>çš„æ„é€ å™¨æœ‰3ä¸ªå‚æ•°ï¼š</p><ol><li><p><code>dataSource</code>ï¼šå‘Šè¯‰å®ƒæ•°æ®æºçš„ä½ç½®</p></li><li><p><code>connectionFactoryLocator</code>ï¼šè´Ÿè´£å»æŸ¥æ‰¾<code>ConnectionFactory</code>ï¼Œå› ä¸ºåœ¨ç³»ç»Ÿé‡Œï¼Œå¯èƒ½ä¼šæœ‰å¾ˆå¤šä¸ª<code>ConnectionFactory</code>ï¼Œæ¯”å¦‚æˆ‘åˆšåˆšå†™äº†ä¸€ä¸ªQQçš„<code>ConnectionFactory</code>ï¼Œåé¢å†™å¾®ä¿¡çš„æ—¶å€™è¿˜è¦å†å†™ä¸€ä¸ªå¾®ä¿¡çš„<code>ConnectionFactory</code>ï¼Œè¿™ä¸ªä¸œè¥¿å®ƒä¼šæ ¹æ®æ¡ä»¶å»æŸ¥æ‰¾ä½ å½“å‰åº”è¯¥ç”¨å“ªä¸ª<code>ConnectionFactory</code>æ¥æ„å»º<code>Connection</code>æ•°æ®</p></li><li><p><code>textEncryptor</code>ï¼šå¸®ä½ æŠŠæ’åˆ°æ•°æ®åº“é‡Œçš„æ•°æ®åšä¸€ä¸ªåŠ è§£å¯†ï¼Œå› ä¸ºæ’å…¥åˆ°æ•°æ®åº“é‡Œçš„æ˜¯ä¸€äº›æ¯”è¾ƒæ•æ„Ÿçš„æ•°æ®ï¼Œç”¨æˆ·çš„<code>accessToken</code>è¿™äº›ä¸œè¥¿ï¼Œé‚£ä¹ˆä¸ºäº†ä¿è¯å®ƒçš„å®‰å…¨ï¼Œå°±éœ€è¦é€šè¿‡è¿™ä¸ªå·¥å…·</p><p><code>Encryptors</code>ç±»ä¸­æä¾›äº†ä¸€äº›é»˜è®¤çš„å·¥å…·ï¼Œè¿™é‡Œæˆ‘å°±é€‰æ‹©ä½¿ç”¨é‡Œé¢çš„<code>noOpText</code>ï¼Œä¸åšä»»ä½•æ“ä½œï¼Œè¯»è€…åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯åˆ«è¿™ä¹ˆå¹²</p></li></ol><p>è¿™é‡Œéœ€è¦åœ¨æ•°æ®åº“ä¸­å»ºç«‹ä¸€ä¸ª<code>UserConnection</code>çš„è¡¨ï¼Œè¿™ä¸ªå»ºè¡¨çš„è„šæœ¬å’Œ<code>JdbcUsersConnectionRepository</code>åœ¨ä¸€ä¸ªåŒ…ä¸‹ï¼Œå°†è¿™ä¸ªè„šæœ¬åœ¨ä½ çš„æ•°æ®åº“ä¸­æ‰§è¡Œä¸€ä¸‹</p><pre><code class="hljs mysql">create table UserConnection (userId varchar(255) not null,providerId varchar(255) not null,providerUserId varchar(255),rank int not null,displayName varchar(255),profileUrl varchar(512),imageUrl varchar(512),accessToken varchar(512) not null,secret varchar(512),refreshToken varchar(512),expireTime bigint,primary key (userId, providerId, providerUserId));create unique index UserConnectionRank on UserConnection(userId, providerId, rank);</code></pre><p>ä»‹ç»ä¸€ä¸‹è¿™é‡Œçš„å­—æ®µï¼š</p><ul><li>userIdï¼šè¿™ä¸ªæ˜¯ä¸šåŠ¡ç³»ç»Ÿä¸­çš„ç”¨æˆ·id</li><li>providerIdï¼šæœåŠ¡æä¾›å•†çš„idï¼Œæ˜¯QQã€å¾®ä¿¡è¿˜æ˜¯å…¶ä»–çš„æœåŠ¡æä¾›å•†</li><li>providerUserIdï¼šä¹‹å‰æåˆ°çš„<code>openId</code></li><li>rankï¼šç­‰çº§</li><li>displayNameï¼šæ˜µç§°</li><li>profileUrlï¼š ä¸»é¡µåœ°å€</li><li>imageUrlï¼šå¤´åƒåœ°å€</li><li>accessTokenã€<code>secret</code>ã€<code>refreshToken</code>ã€<code>expireTime</code>ï¼šè¿™äº›æ˜¯è·Ÿ<code>OAuthåè®®</code>ç›¸å…³çš„</li></ul><p>è¿™é‡Œæœ€é‡è¦çš„æ˜¯å‰3ä¸ªå­—æ®µï¼Œè¿™é‡Œçš„<code>userId</code>æ˜¯æˆ‘ä»¬ä¸šåŠ¡ç³»ç»Ÿçš„<code>userId</code>ï¼Œ<code>providerId</code>æ˜¯æœåŠ¡æä¾›å•†çš„ç”¨æˆ·idï¼Œå’Œæˆ‘ä»¬ä¸šåŠ¡ç³»ç»Ÿä¹‹é—´çš„ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼Œåœ¨æˆ‘ä»¬ç¤¾äº¤ç™»å½•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯æ‹¿åˆ°äº†ç¤¾äº¤ç”¨æˆ·çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯<code>providerId</code>å’Œ<code>providerUserId</code>å¯ä»¥æ‹¿åˆ°<code>userId</code>ï¼Œé‚£ä¹ˆæ‹¿åˆ°<code>userId</code>ä»¥åæˆ‘æœ€ç»ˆç™»å½•æˆåŠŸä»¥åæ”¾åˆ°<code>session</code>é‡Œé¢åº”è¯¥æ˜¯ä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯ï¼Œè€Œä¸æ˜¯ä¸€ä¸ª<code>userId</code>ï¼Œé‚£ä¹ˆå¦‚ä½•ä»è¿™ä¸ª<code>userId</code>è½¬æ¢æˆä¸€ä¸ªå®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¬ä¸‹é¢æ¥ç€æ¥è¯´ï¼š</p><p>ä¹‹å‰è¯´çš„<code>UserDetailsService</code>å®ƒçš„ä½œç”¨å°±æ˜¯æ ¹æ®ç”¨æˆ·ç™»å½•è¡¨å•ä¸Šå¡«çš„è¿™ä¸ªç”¨æˆ·åå»è¯»å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè·Ÿç”¨æˆ·ä¿¡æ¯ä¼šå°è£…åˆ°ä¸€ä¸ª<code>UserDetails</code>æ¥å£ä¸­ï¼Œç„¶åæ‹¿è¿™ä¸ªç”¨æˆ·ä¿¡æ¯å»æ ¡éªŒï¼Œå¦‚æœæ ¡éªŒæˆåŠŸäº†è¿™ä¸ªä¿¡æ¯å°±ä¼šè¢«æ”¾åˆ°<code>session</code>é‡Œï¼Œä¸è¿™ä¸ªæœºåˆ¶ç±»ä¼¼ï¼Œ<code>SpringSocial</code>æä¾›äº†ä¸€ä¸ªå«åš<code>SocialUserDetailsService</code>çš„æ¥å£ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.social.security;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UsernameNotFoundException;<span class="hljs-comment">/**</span><span class="hljs-comment"> * similar to &#123;<span class="hljs-doctag">@link</span> UserDetailsService&#125; but loads details by user id, not username</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Stefan Fussennegger</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SocialUserDetailsService</span> </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> UserDetailsService#loadUserByUsername(String)</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> userId the user ID used to lookup the user details</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> the SocialUserDetails requested</span><span class="hljs-comment"> */</span><span class="hljs-function">SocialUserDetails <span class="hljs-title">loadUserByUserId</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException</span>;&#125;</code></pre><p>è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ç¤¾äº¤ç™»å½•çš„æ—¶å€™ç”¨çš„ï¼Œè¿™é‡Œä¼ è¿›æ¥çš„æ˜¯<code>SpringSocial</code>æ ¹æ®æ ¹æ®ç¤¾äº¤ç½‘ç«™çš„openIdæŸ¥å‡ºæ¥çš„ç”¨æˆ·çš„<code>userId</code>ï¼Œä½ è¦åšçš„å°±æ˜¯æ ¹æ®è¿™ä¸ª<code>userId</code>å»æ„å»ºä¸€ä¸ª<code>SocialUserDetails</code>å®ä¾‹ï¼Œæ¥çœ‹ä¸€ä¸‹<code>SocialUserDetails</code></p><pre><code class="hljs java">tations under the License. */<span class="hljs-keyword">package</span> org.springframework.social.security;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetails;<span class="hljs-comment">/**</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Stefan Fussennegger</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SocialUserDetails</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UserDetails</span> </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * The user's identity at the provider.</span><span class="hljs-comment"> * Might be same as &#123;<span class="hljs-doctag">@link</span> #getUsername()&#125; if users are identified by username</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> user's id used to assign connections</span><span class="hljs-comment"> */</span><span class="hljs-function">String <span class="hljs-title">getUserId</span><span class="hljs-params">()</span></span>;&#125;</code></pre><p>è¿™é‡Œçš„<code>SocialUserDetails</code>ç»§æ‰¿äº†<code>UserDetails</code>æ¥å£ï¼Œå®ƒè¿™é‡Œå¤šäº†ä¸€ä¸ª<code>userId</code>å­—æ®µ</p><hr><p>McrUserDetailsServiceï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security.service;<span class="hljs-meta">@Service</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span>, <span class="hljs-title">SocialUserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;    <span class="hljs-function"><span class="hljs-keyword">private</span> SocialUser <span class="hljs-title">buildUser</span><span class="hljs-params">(String username)</span> </span>&#123;        String password = passwordEncoder.encode(<span class="hljs-string">"123"</span>);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialUser(username, password, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        log.info(<span class="hljs-string">"è¡¨å•ç™»å½•ç”¨æˆ·-&gt;&#123;&#125;è¿›è¡Œæ•ˆéªŒ"</span>, username);        <span class="hljs-keyword">return</span> buildUser(username);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SocialUserDetails <span class="hljs-title">loadUserByUserId</span><span class="hljs-params">(String userId)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        log.info(<span class="hljs-string">"ç¤¾äº¤ç™»å½•ç”¨æˆ·id-&gt;&#123;&#125;è¿›è¡Œæ•ˆéªŒ"</span>, userId);        <span class="hljs-keyword">return</span> buildUser(userId);    &#125;&#125;</code></pre><h1 id="é…ç½®QQç™»å½•"><a href="#é…ç½®QQç™»å½•" class="headerlink" title="é…ç½®QQç™»å½•"></a>é…ç½®QQç™»å½•</h1><p>ç°åœ¨ç¦»å®Œæˆè¿˜å·®2ä»¶äº‹</p><ol><li>ä¸€äº›é…ç½®ï¼šQQç™»å½•éœ€è¦çš„<code>appId</code>ã€<code>appSecret</code>ï¼Œè¿™äº›è¿˜æ²¡é…ï¼ŒæŠŠè¿™äº›é…ç½®åŠ ä¸Š</li><li>åœ¨é¡µé¢ä¸ŠåŠ ä¸€ä¸ªQQç™»å½•çš„å…¥å£</li></ol><p>QQPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.social.SocialProperties;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialProperties</span> </span>&#123;<span class="hljs-keyword">private</span> String providerId = <span class="hljs-string">"qq"</span>;<span class="hljs-comment">//é»˜è®¤çš„providerId</span> &#125;</code></pre><p>è¿™é‡Œç»§æ‰¿äº†<code>SpringSocial</code>æä¾›çš„<code>SocialProperties</code></p><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.boot.autoconfigure.social;<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Base &#123;<span class="hljs-doctag">@link</span> ConfigurationProperties properties&#125; for spring social.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Stephane Nicoll</span><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.4.0</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialProperties</span> </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Application id.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String appId;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Application secret.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String appSecret;<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAppId</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appId;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAppId</span><span class="hljs-params">(String appId)</span> </span>&#123;<span class="hljs-keyword">this</span>.appId = appId;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAppSecret</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.appSecret;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAppSecret</span><span class="hljs-params">(String appSecret)</span> </span>&#123;<span class="hljs-keyword">this</span>.appSecret = appSecret;&#125;&#125;</code></pre><p>è¿™é‡Œæä¾›äº†æˆ‘ä»¬éœ€è¦çš„<code>appId</code>å’Œ<code>appSecret</code></p><hr><p>ç°åœ¨éœ€è¦æŠŠè¿™ä¸ªé…ç½®åŠ åˆ°<code>SecurityProperties</code>é‡Œé¢ï¼Œä½†æ˜¯ä¸èƒ½ç›´æ¥åŠ ï¼Œéœ€è¦åŠ ä¸€å±‚<code>SocialProperties</code></p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialProperties</span> </span>&#123;    <span class="hljs-keyword">private</span> QQProperties qq = <span class="hljs-keyword">new</span> QQProperties();&#125;</code></pre><p>SecurityPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> SocialProperties social = <span class="hljs-keyword">new</span> SocialProperties();</code></pre><p>QQAutoConfigï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.config;<span class="hljs-comment">/**</span><span class="hljs-comment"> * QQAutoConfigé…ç½®ç±»</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Configuration</span><span class="hljs-comment">//å½“é…ç½®äº†mcr.security.social.qq.app-idæ—¶æ‰ç”Ÿæ•ˆ</span><span class="hljs-meta">@ConditionalOnProperty</span>(prefix = <span class="hljs-string">"mcr.b4.security.social.qq"</span>, name = <span class="hljs-string">"app-id"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQAutoConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialAutoConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-comment">//å°†é…ç½®æ–‡ä»¶ä¸­çš„ProviderIdï¼ŒAppIdï¼ŒAppSecretè¯»å–å‡ºæ¥ï¼Œç»™QQConnectionFactory</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-keyword">protected</span> ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;        QQProperties qqConfig = securityProperties.getSocial().getQq();        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QQConnectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(), qqConfig.getAppSecret());    &#125;&#125;</code></pre><p>ymlï¼š</p><pre><code class="hljs java">mcr:  b4:    security:      social:        qq:          app-id: xxxx           app-secret: xxxx</code></pre><p>BrowserSecurityConfig:</p><pre><code class="hljs java">  <span class="hljs-keyword">private</span> SpringSocialConfigurer socialSecurityConfig;  <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;http.                .apply(socialSecurityConfig)<span class="hljs-comment">//...</span>&#125;</code></pre><p>mcr-login.htmlï¼š</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ç¤¾äº¤ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/auth/qq"</span>&gt;</span>QQç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></code></pre><p>è§£é‡Šä¸€ä¸‹è¿™ä¸ªè·¯å¾„ï¼Œè¿™ä¸ªè·¯å¾„ç”±ä¸¤æ®µç»„æˆï¼Œ</p><p>authï¼šä¹‹å‰<code>SpringSocial</code>åŸºæœ¬åŸç†è¯´çš„è¿‡æ»¤å™¨<code>SocialAuthenticationFilter</code>æ‹¦æˆªï¼Œåœ¨363è¡Œ</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_FILTER_PROCESSES_URL = <span class="hljs-string">"/auth"</span>;</code></pre><p>qqï¼šè¿™ä¸ªqqæ˜¯æˆ‘ä»¬ä¹‹å‰å†™çš„QQAutoConfig#createConnectionFactoryä¼ é€’çš„getProviderIdï¼Œä¹Ÿå°±æ˜¯qq</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span>  <span class="hljs-keyword">protected</span> ConnectionFactory&lt;?&gt; createConnectionFactory() &#123;      QQProperties qqConfig = securityProperties.getSocial().getQq();      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> QQConnectionFactory(qqConfig.getProviderId(), qqConfig.getAppId(), qqConfig.getAppSecret());  &#125;</code></pre><h1 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h1><p>ç°åœ¨ç‚¹å‡»QQç™»å½•çš„Aé“¾æ¥ï¼Œä¼šå‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567265942100.png" srcset="/img/loading.gif" alt="1567265942100"></p><p>å®ƒè¯´é‡å®šå‘çš„URLæ˜¯éæ³•çš„ï¼Œåœ¨ä¹‹å‰å°†æµç¨‹çš„æ—¶å€™ï¼Œç¬¬3æ­¥ç”¨æˆ·åŒæ„æˆæƒä»¥åæœåŠ¡æä¾›å•†ä¼šæºå¸¦æˆæƒç ï¼Œè·³å›åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨ä¸Šï¼Œåœ¨è°ƒå›å»çš„æ—¶å€™è·³çš„åœ°å€å°±æ˜¯ç°åœ¨æµè§ˆå™¨ä¸Šurlçš„queryå‚æ•°<code>redirect_uri</code>ï¼Œè¿™ä¸ªåœ°å€æ˜¯å¦‚ä½•æ¥ç¡®å®šçš„å‘¢ï¼Ÿæˆ‘ä»¬åœ¨QQäº’è”ä¸Šå»æ³¨å†Œæˆ‘ä»¬åº”ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦å¡«å†™ä¸€ä¸ªç½‘ç«™çš„å›è°ƒåŸŸï¼Œæˆ‘è¿™çš„å›è°ƒåŸŸæ˜¯ï¼š<a href="http://www.pinzhi365.com/qqLogin/callback.doï¼Œè€Œç°åœ¨çš„æ˜¯ï¼šhttp://localhost:8080/auth/qq&amp;state=831e84cf-c5a3-4e24-ada5-aaae4d425613ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜" target="_blank" rel="noopener">http://www.pinzhi365.com/qqLogin/callback.doï¼Œè€Œç°åœ¨çš„æ˜¯ï¼šhttp://localhost:8080/auth/qq&amp;state=831e84cf-c5a3-4e24-ada5-aaae4d425613ï¼Œæ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜</a></p><pre><code class="hljs http">https://graph.qq.com/oauth2.0/show?which=error&amp;display=pc&amp;error=100010&amp;client_id=101547043&amp;response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8080%2Fauth%2Fqq&amp;state=831e84cf-c5a3-4e24-ada5-aaae4d425613</code></pre><p>è¿™é‡Œè¦æ³¨æ„ï¼šåœ¨<code>SpringSocial</code>é‡Œé¢ï¼Œç¬¬1æ­¥å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ï¼Œè¦è§¦å‘è¿™ä¸ªï¼Œæˆ‘ä»¬æ‰€è®¿é—®çš„åœ°å€<code>/auth/qq</code>è·Ÿæœ€ç»ˆç”¨æˆ·åŒæ„æˆæƒè·³è½¬å›æ¥çš„åœ°å€æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œéƒ½æ˜¯é¡µé¢ä¸Šå†™çš„<code>/auth/qq</code></p><hr><p>å°†<code>redirect_uri</code>å‚æ•°çš„å€¼ä¸QQäº’è”ä¸Šé…ç½®çš„å›è°ƒåŸŸä¿æŒä¸€è‡´</p><p>è¿™é‡Œä½¿ç”¨<code>SwitchHosts</code>å·¥å…·æ”¹ä¸€ä¸‹hostæ–‡ä»¶ï¼Œè¿™æ ·å½“è®¿é—® <a href="http://www.pinzhi365.comæ—¶å°±ä¼šè®¿é—®è‡ªå·±çš„æœºå™¨" target="_blank" rel="noopener">www.pinzhi365.comæ—¶å°±ä¼šè®¿é—®è‡ªå·±çš„æœºå™¨</a></p><pre><code class="hljs accesslog"><span class="hljs-number">127.0.0.1</span> www.pinzhi365.com</code></pre><p>å®ƒç°åœ¨è®¿é—®çš„æ˜¯80ï¼Œæ‰€ä»¥è¿˜éœ€è¦æ”¹ä¸€ä¸‹<code>yml</code></p><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">80</span></code></pre><p>ç°åœ¨<code>SocialAuthenticationFilter</code>å®ƒä¼šå¤„ç†<code>/auth</code>å¼€å¤´çš„è¯·æ±‚ï¼Œè¦æ€ä¹ˆæ”¹å˜å®ƒå‘¢ï¼Ÿæ¥çœ‹ä¹‹å‰å†™çš„<code>SocialConfig#socialSecurityConfig</code>çš„é…ç½®ï¼Œæ¥çœ‹ä¸€ä¸‹<code>SpringSocialConfigurer</code>çš„<code>configure</code>æ–¹æ³•ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;ApplicationContext applicationContext = http.getSharedObject(ApplicationContext<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;UsersConnectionRepository usersConnectionRepository = getDependency(applicationContext, UsersConnectionRepository<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;SocialAuthenticationServiceLocator authServiceLocator = getDependency(applicationContext, SocialAuthenticationServiceLocator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;SocialUserDetailsService socialUsersDetailsService = getDependency(applicationContext, SocialUserDetailsService<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;SocialAuthenticationFilter filter = <span class="hljs-keyword">new</span> SocialAuthenticationFilter(http.getSharedObject(AuthenticationManager<span class="hljs-class">.<span class="hljs-keyword">class</span>), </span><span class="hljs-class"><span class="hljs-title">userIdSource</span> !</span>= <span class="hljs-keyword">null</span> ? userIdSource : <span class="hljs-keyword">new</span> AuthenticationNameUserIdSource(), usersConnectionRepository, authServiceLocator);RememberMeServices rememberMe = http.getSharedObject(RememberMeServices<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;<span class="hljs-keyword">if</span> (rememberMe != <span class="hljs-keyword">null</span>) &#123;filter.setRememberMeServices(rememberMe);&#125;<span class="hljs-keyword">if</span> (postLoginUrl != <span class="hljs-keyword">null</span>) &#123;filter.setPostLoginUrl(postLoginUrl);filter.setAlwaysUsePostLoginUrl(alwaysUsePostLoginUrl);&#125;<span class="hljs-keyword">if</span> (postFailureUrl != <span class="hljs-keyword">null</span>) &#123;filter.setPostFailureUrl(postFailureUrl);&#125;<span class="hljs-keyword">if</span> (signupUrl != <span class="hljs-keyword">null</span>) &#123;filter.setSignupUrl(signupUrl);&#125;<span class="hljs-keyword">if</span> (connectionAddedRedirectUrl != <span class="hljs-keyword">null</span>) &#123;filter.setConnectionAddedRedirectUrl(connectionAddedRedirectUrl);&#125;<span class="hljs-keyword">if</span> (defaultFailureUrl != <span class="hljs-keyword">null</span>) &#123;filter.setDefaultFailureUrl(defaultFailureUrl);&#125;http.authenticationProvider(<span class="hljs-keyword">new</span> SocialAuthenticationProvider(usersConnectionRepository, socialUsersDetailsService)).addFilterBefore(postProcess(filter), AbstractPreAuthenticatedProcessingFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;&#125;</code></pre><p>å®ƒåœ¨è¿™é‡Œå®ä¾‹åŒ–äº†ä¸€ä¸ª<code>SocialAuthenticationFilter</code>ï¼Œç„¶åå®ä¾‹åŒ–è¿™ä¸ªè¿‡æ»¤å™¨ä»¥åï¼Œå®ƒåœ¨ä¸‹é¢åšäº†ä¸€äº›å¤„ç†ï¼Œæœ€ç»ˆå®ƒæŠŠè¿™ä¸ªè¿‡æ»¤å™¨åŠ åˆ°äº†<code>SpringSecurity</code>çš„è¿‡æ»¤å™¨é“¾ä¸Šï¼Œå®ƒåœ¨åŠ å…¥ä¹‹å‰è°ƒç”¨äº†ä¸€ä¸ª<code>postProcess</code>æ–¹æ³•</p><pre><code class="hljs java">.addFilterBefore(postProcess(filter), AbstractPreAuthenticatedProcessingFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;</code></pre><p>æˆ‘ä»¬ç°åœ¨è¦åšçš„æ˜¯è‡ªå·±å†™ä¸€ä¸ªç±»å»ç»§æ‰¿<code>SpringSocialConfigurer</code>ï¼Œç„¶åæŠŠå®ƒçš„<code>postProcess</code>æ–¹æ³•è¦†ç›–æ‰ï¼Œå®ç°æˆ‘ä»¬éœ€è¦çš„é€»è¾‘</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-keyword">import</span> org.springframework.social.security.SocialAuthenticationFilter;<span class="hljs-keyword">import</span> org.springframework.social.security.SpringSocialConfigurer;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è‡ªå·±åˆ›å»ºMcrSpringSocialConfigurerç»§æ‰¿SpringSocialConfigurerï¼Œé‡å†™</span><span class="hljs-comment"> * postProcessï¼Œå°†è‡ªå·±é…ç½®çš„filterProcessesUrlè®¾ç½®è¿›å»ã€‚</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrSpringSocialConfigurer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SpringSocialConfigurer</span> </span>&#123;<span class="hljs-keyword">private</span> String filterProcessesUrl;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">McrSpringSocialConfigurer</span><span class="hljs-params">(String filterProcessesUrl)</span> </span>&#123;<span class="hljs-keyword">this</span>.filterProcessesUrl = filterProcessesUrl;&#125;<span class="hljs-meta">@Override</span><span class="hljs-keyword">protected</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">postProcess</span><span class="hljs-params">(T object)</span> </span>&#123;SocialAuthenticationFilter filter = (SocialAuthenticationFilter) <span class="hljs-keyword">super</span>.postProcess(object);filter.setFilterProcessesUrl(filterProcessesUrl);<span class="hljs-keyword">return</span> (T) filter;&#125;&#125;</code></pre><p>ä¸Šé¢ä»£ç ä¸­çš„<code>postProcess</code>æ–¹æ³•ä¸­çš„å‚æ•°objectå®é™…ä¸Šå°±æ˜¯è¦æ”¾åˆ°è¿‡æ»¤å™¨é“¾ä¸Šçš„<code>SocialAuthenticationFilter</code>ï¼Œåœ¨è¿™é‡Œä½¿ç”¨å®ƒçš„<code>setFilterProcessesUrl</code>æ–¹æ³•æ”¹å˜é»˜è®¤çš„<code>/auth</code>ï¼Œè¿™é‡Œä¸ç›´æ¥å†™æ­»åœ¨è¿™é‡Œï¼Œè¦åšæˆå¯é…ç½®çš„ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨æ„é€ å™¨æ¥ç»™<code>filterProcessesUrl</code>èµ‹å€¼</p><p>SocialPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> String filterProcessesUrl=<span class="hljs-string">"/auth"</span>;</code></pre><p>SocialConfigï¼š</p><pre><code class="hljs java"> <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;  <span class="hljs-comment">//å°†SpringSocialFilteræ·»åŠ åˆ°å®‰å…¨é…ç½®çš„Bean  </span><span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SpringSocialConfigurer <span class="hljs-title">socialSecurityConfig</span><span class="hljs-params">()</span> </span>&#123;        McrSpringSocialConfigurer mcrSpringSocialConfigurer = <span class="hljs-keyword">new</span> McrSpringSocialConfigurer(securityProperties.getSocial().getFilterProcessesUrl());        <span class="hljs-keyword">return</span> mcrSpringSocialConfigurer;    &#125;</code></pre><p>ymlï¼š</p><pre><code class="hljs yml"><span class="hljs-attr">mcr:</span>  <span class="hljs-attr">b4:</span>    <span class="hljs-attr">security:</span>      <span class="hljs-attr">social:</span>        <span class="hljs-attr">filterProcessesUrl:</span> <span class="hljs-string">/qqLogin</span>        <span class="hljs-attr">qq:</span>          <span class="hljs-attr">providerId:</span> <span class="hljs-string">callback.do</span></code></pre><p><code>mcr-login.html</code>ï¼Œä¿®æ”¹aæ ‡ç­¾è·³è½¬çš„åœ°å€</p><pre><code class="hljs java">&lt;a href="/qqLogin/callback.do"&gt;QQç™»å½•&lt;/a&gt;</code></pre><p>ç°åœ¨è®¿é—®ï¼š<a href="http://www.pinzhi365.com/mcr-login.htmlï¼Œæ‰«ç ç™»å½•ï¼Œé¡µé¢å“åº”å†…å®¹ï¼š" target="_blank" rel="noopener">http://www.pinzhi365.com/mcr-login.htmlï¼Œæ‰«ç ç™»å½•ï¼Œé¡µé¢å“åº”å†…å®¹ï¼š</a></p><pre><code class="hljs json">&#123;<span class="hljs-attr">"content"</span>: <span class="hljs-string">"è¯·å¼•å¯¼ç”¨æˆ·è·³è½¬åˆ°ç™»å½•é¡µé¢"</span>&#125;</code></pre><p>æ§åˆ¶å°å†…å®¹ï¼š</p><pre><code class="hljs angelscript"><span class="hljs-number">2019</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">48</span>:<span class="hljs-number">27.204</span>  INFO <span class="hljs-number">51488</span> --- [p-nio<span class="hljs-number">-80</span>-exec<span class="hljs-number">-7</span>] c.b.m.a.b.BrowserSecurityController      : å¼•å‘è·³è½¬çš„è¯·æ±‚-&gt;http:<span class="hljs-comment">//www.pinzhi365.com/signin</span></code></pre><p>ç”±äº<code>/signin</code>è¿™ä¸ªè¯·æ±‚æ²¡åšæˆæƒï¼Œæ‰€ä»¥é¡µé¢ä¸Šå°±ä¼šå“åº”è¿™ä¸ªå†…å®¹ï¼Œä¸ºä»€ä¹ˆä¼šè·³è½¬åˆ°<code>/signin</code>åœ°å€å‘¢ï¼Ÿè¿™é‡Œè¦è·Ÿåˆ°<code>SpringSocial</code>ä¸­çš„ä»£ç é‡Œé¢å»çœ‹ä¸€ä¸‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Œåœ¨æ ¹ä¹‹å‰ï¼Œå…ˆä»‹ç»ä¸€ä¸‹<code>SpringSocial</code>å¯¹æ•´ä¸ªæµç¨‹çš„å¤„ç†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567270429093.png" srcset="/img/loading.gif" alt="1567270429093"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567227175116-1567271294474.png" srcset="/img/loading.gif" alt=""></p><p>è¿™å¼ å›¾å°±æ˜¯<code>SpringSocial</code>ä¸‰æ–¹ç™»å½•çš„æ—¶å€™æ¶‰åŠåˆ°çš„ä¸€ä¸ªæ¥å£å’Œå®ç°ç±»ä»¥åŠå®ƒä»¬ä¹‹é—´çš„è°ƒç”¨é¡ºåºï¼Œå’Œä¹‹å‰çš„ç”¨æˆ·åå¯†ç ç™»å½•å’Œæ‰‹æœºéªŒè¯ç ç™»å½•çš„æµç¨‹å®ƒçš„æ ¸å¿ƒæ˜¯ä¸€è‡´çš„ï¼Œé€šè¿‡è¿‡æ»¤å™¨å»æ‹¦æˆªæŸä¸€ä¸ªç‰¹å®šçš„è¯·æ±‚ï¼Œæ‹¿åˆ°è¿™ä¸ªè¯·æ±‚ä»¥åï¼ŒæŠŠå®ƒé‡Œé¢çš„èº«ä»½è®¤è¯æ‰€éœ€è¦çš„ä¿¡æ¯åŒ…è£…åˆ°ä¸€ä¸ª<code>Authentication</code>å®ç°é‡Œé¢ï¼Œç„¶åæŠŠæŠŠ<code>Authentication</code>äº¤ç»™<code>AuthenticationManager</code>ï¼Œæ ¹æ®ä¼ é€’è¿›æ¥çš„<code>Authentication</code>ç±»å‹ä¸åŒä»å®ƒæ‰€ç®¡ç†çš„<code>AuthenticationProvider</code>æ¥å£å®ç°é‡Œé¢æŒ‘ä¸€ä¸ª<code>Provider</code>æ¥å¤„ç†ä¼ è¿›å»çš„æ ¡éªŒä¿¡æ¯ï¼Œåœ¨å¤„ç†çš„è¿‡ç¨‹ä¸­å®ƒä¼šå»è°ƒæˆ‘ä»¬è‡ªå·±å†™çš„<code>UserDetailsService</code>æ¥å£çš„å®ç°ï¼Œæ¥è·å–ä¸šåŠ¡ç³»ç»Ÿä¸­ç”¨æˆ·çš„ä¿¡æ¯ï¼Œç„¶åæŠŠä¸šåŠ¡ç³»ç»Ÿçš„ä¿¡æ¯å°è£…åœ¨ä¸€ä¸ª<code>UserDetails</code>æ¥å£çš„å®ç°é‡Œé¢ï¼Œç„¶åè¿›ä¸€ç³»åˆ—çš„æ£€æŸ¥å’Œæ ¡éªŒï¼Œå¦‚æœéƒ½é€šè¿‡äº†ï¼Œå®ƒä¼šæŠŠç”¨æˆ·ä¿¡æ¯æ”¾åˆ°æˆ‘ä»¬ä¹‹å‰å°è£…çš„<code>Authentication</code>é‡Œï¼Œç„¶åæŠŠ<code>Authentication</code>æ ‡è®°æˆç»è¿‡è®¤è¯çš„ç„¶åæ”¾åˆ°<code>SecurityContext</code>é‡Œé¢å®Œæˆç™»å½•ï¼Œè¿™ä¸ªæ ¸å¿ƒæµç¨‹æ˜¯æ°¸è¿œä¸å˜çš„ï¼Œè¯»è€…ä¸€å®šè¦æ·±åˆ»çš„ç†è§£å®ƒï¼Œç„¶åæŠŠå®ƒè®°ä½ï¼Œè¿™ä¸ªæ˜¯Spring Securityæœ€å…³é”®çš„çŸ¥è¯†ï¼Œä½ æŠŠå®ƒç†è§£äº†ï¼Œå…¶å®æ‰€æœ‰ç™»å½•æ–¹å¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡åœ¨<code>SpringSocial</code>æä¾›çš„ç¬¬ä¸‰æ–¹ç™»å½•é‡Œé¢æ¶‰åŠåˆ°äº†ä¸€äº›ç‰¹æ®Šçš„ä¸œè¥¿ï¼Œæ¯”å¦‚å®ƒåœ¨è¿™ä¸ªè¿‡æ»¤å™¨åœ¨å°è£…<code>Authentication</code>ç»™è¿™ä¸ª<code>AuthenticationManager</code>çš„æ—¶å€™ç”¨åˆ°äº†ä¸€ä¸ªæ¥å£å«åš<code>SocialAuthenticationService</code>ï¼Œå›¾ä¸Šè“è‰²çš„éƒ¨åˆ†æ˜¯<code>SpringSocial</code>å†…éƒ¨å°è£…å¥½çš„ä¸éœ€è¦å»åŠ¨çš„ï¼Œæ©˜è‰²çš„æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„ï¼Œè“è‰²çš„è¿™äº›åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­å®ƒä¼šè°ƒç”¨ä¸€äº›æˆ‘ä»¬è‡ªå·±å†™çš„ä»£ç ï¼Œä¾‹å¦‚è¿™é‡Œçš„<code>OAuth2AuthenticationService</code>,å®ƒçš„ä½œç”¨æ˜¯æ‰§è¡Œæ•´ä¸ªOAuthæµç¨‹ï¼Œåœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå®ƒä¼šå»æ‰æˆ‘ä»¬è‡ªå·±å†™çš„<code>ConnectionFactory</code> ï¼Œé€šè¿‡<code>ConnectionFactory</code> ä¼šæ‹¿åˆ°<code>ServiceProvider</code>ï¼Œ<code>ServiceProvider</code>é‡Œæœ‰ä¸€ä¸ª<code>OAuth2Operations</code>ï¼Œè¿™ä¸ª<code>OAuth2Operations</code>ä¼šå¸®åŠ©<code>SpringSocial</code>å®Œæˆæ•´ä¸ªæµç¨‹ï¼Œå®Œæˆæµç¨‹ä»¥åå®ƒä¼šæ‹¿åˆ°æœåŠ¡æä¾›å•†çš„ç”¨æˆ·ä¿¡æ¯ï¼ŒæœåŠ¡æä¾›å•†çš„ç”¨æˆ·ä¿¡æ¯ä¼šè¢«å°è£…åˆ°<code>Connection</code>é‡Œé¢ï¼Œç„¶å<code>Connection</code>ä¼šè¢« å°è£…æˆä¸€ä¸ª<code>SocialAuthenticationToken</code>ï¼Œå®ƒåŒ…å«äº†<code>Connection</code>ä¿¡æ¯ï¼Œæ•´ä¸ª<code>Authentication</code>ä¼šäº¤ç»™<code>AuthenticationManager</code>ï¼Œç„¶åå®ƒæ‹¿åˆ°è¿™ä¸ª<code>token</code>é‡Œé¢ï¼Œå®ƒä¼šæŒ‘<code>SocialAuthenticationProvider</code>å‡ºå¤„ç†è¿™ä¸ª<code>token</code>ï¼Œ<code>SocialAuthenticationProvider</code>åœ¨å¤„ç†çš„æ—¶å€™ï¼Œå®ƒä¼šæ ¹æ®ä¼ å…¥çš„<code>Connection</code>ä¹Ÿå°±æ˜¯æœåŠ¡æä¾›å•†çš„ç”¨æˆ·ä¿¡æ¯ä½¿ç”¨<code>JdbcUsersConnectionRepository</code>è¿™ä¸ªç±»åˆ°æ•°æ®åº“é‡Œå»æŸ¥ä¸€ä¸ª<code>userId</code>å‡ºæ¥ï¼ŒæŸ¥å‡ºæ¥çš„ç”¨æˆ·idä»¥åæ‹¿è¿™ä¸ªidå»è°ƒç”¨æˆ‘ä»¬è‡ªå·±å†™çš„<code>SocialUserDetailsService</code>å®ç°ï¼Œè¿™ä¸ªæœåŠ¡å®ƒå»ä¸šåŠ¡ç³»ç»Ÿé‡ŒæŠŠçœŸæ­£ä½ è¦æ”¾åˆ°<code>session</code>é‡Œçš„ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢å‡ºæ¥ï¼Œä¹Ÿå°±æ˜¯<code>SocialUserDetails</code>ï¼ŒæŠŠè¿™ä¸ªä¿¡æ¯æ”¾åˆ°<code>SocialAuthenticationToken</code>é‡Œé¢ï¼Œç„¶åæ ‡è®°æˆå·²ç»è¿‡è®¤è¯ï¼Œæ”¾å…¥<code>SecurityContext</code>é‡Œï¼Œæœ€ç»ˆæ”¾åˆ°<code>session</code>ä¸­</p><hr><p>å›åˆ°åˆšåˆšä¹‹å‰å‡ºé”™çš„åœ°æ–¹ï¼Œå›æƒ³ä¸€ä¸‹ï¼Œæ˜¯å·²ç»è°ƒåˆ°äº†QQä¸Šï¼Œæ‰‹æœºæ‰«å®ŒäºŒç»´ç ï¼Œè¿›è¡Œäº†æˆæƒè¿™ä¸ªç¡®è®¤ï¼Œæˆæƒç¡®è®¤ä»¥åå®ƒå®é™…ä¸Šæ˜¯è·³å›æˆ‘ä»¬çš„demoé¡¹ç›®ä¸Šï¼Œåœ¨è°ƒå›æˆ‘ä»¬çš„<code>demoé¡¹ç›®</code>ä¸Šçš„æ—¶å€™å¹¶æ²¡æœ‰æƒ³è±¡çš„é‚£æ ·ï¼Œè€Œæ˜¯è°ƒåˆ°äº†<code>/signin</code> URLä¸Šå»ï¼Œå®é™…ä¸Šæˆ‘ä»¬å‡ºé—®é¢˜çš„ç‚¹ä»»ç„¶æ˜¯åœ¨èµ°æˆ‘ä»¬çš„<code>OAuthæµç¨‹</code>ä¸­å‡ºç°çš„é—®é¢˜ï¼Œä¹Ÿå°±è¯´æœ€ç»ˆæˆ‘è¿˜æ²¡æœ‰è·å–ä¸€ä¸ªæ­£ç¡®çš„<code>SocialAuthentication</code>äº¤ç»™<code>AuthenticationManager</code>å»éªŒè¯ï¼Œè€Œæ˜¯åœ¨è¿™<code>OAuth2AuthenticationService</code>åœ¨å®ƒå»èµ°<code>OAuth</code>æµç¨‹çš„ä¸­é—´å‡ºäº†é—®é¢˜ï¼Œç°åœ¨æ¥è·Ÿè¸ªä¸€ä¸‹ï¼š</p><hr><p><code>OAuth2AuthenticationService</code>é‡Œé¢æœ€é‡è¦çš„æ–¹æ³•<code>getAuthToken</code>ï¼Œå®ƒæ˜¯æ¥æ‹¿å–è®¤è¯ä»¤ç‰Œçš„ï¼Œè¿™å°±æ˜¯åœ¨èµ°<code>OAuthæµç¨‹</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> SocialAuthenticationToken <span class="hljs-title">getAuthToken</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> SocialAuthenticationRedirectException </span>&#123;String code = request.getParameter(<span class="hljs-string">"code"</span>);<span class="hljs-keyword">if</span> (!StringUtils.hasText(code)) &#123;OAuth2Parameters params =  <span class="hljs-keyword">new</span> OAuth2Parameters();params.setRedirectUri(buildReturnToUrl(request));setScope(request, params);params.add(<span class="hljs-string">"state"</span>, generateState(connectionFactory, request));addCustomParameters(params);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocialAuthenticationRedirectException(getConnectionFactory().getOAuthOperations().buildAuthenticateUrl(params));&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (StringUtils.hasText(code)) &#123;<span class="hljs-keyword">try</span> &#123;String returnToUrl = buildReturnToUrl(request);AccessGrant accessGrant = getConnectionFactory().getOAuthOperations().exchangeForAccess(code, returnToUrl, <span class="hljs-keyword">null</span>);<span class="hljs-comment">// TODO avoid API call if possible (auth using token would be fine)</span>Connection&lt;S&gt; connection = getConnectionFactory().createConnection(accessGrant);<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SocialAuthenticationToken(connection, <span class="hljs-keyword">null</span>);&#125; <span class="hljs-keyword">catch</span> (RestClientException e) &#123;logger.debug(<span class="hljs-string">"failed to exchange for access"</span>, e);<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125;&#125; <span class="hljs-keyword">else</span> &#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125;&#125;</code></pre><p>é¦–å…ˆå®ƒä»è¯·æ±‚ä¸­è·å–<code>code</code>çš„å‚æ•°ï¼Œæ‹¿ä»–åšåˆ¤æ–­ è¿™ä¸ª<code>code</code>æ˜¯ä¸æ˜¯æœ‰å€¼ï¼Œä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªåˆ¤æ–­ï¼Œå› ä¸ºä¹‹å‰è¯´è¿‡åœ¨<code>SpringSocial</code>é‡Œé¢ç¬¬ä¸€æ­¥å°±æ˜¯ç”¨æˆ·ç‚¹QQç™»å½•çš„æ—¶å€™ï¼Œå°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ï¼Œç”¨æˆ·ç‚¹çš„è¿™ä¸ªè¯·æ±‚å’Œè®¤è¯æœåŠ¡å™¨ï¼Œç”¨æˆ·åŒæ„å®Œæˆæƒä»¥åè®¤è¯æœåŠ¡å™¨è°ƒå›ä»¥åå¸¦ç€æˆæƒç è¿™2ä¸ªåœ°å€æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯ä»£ç ä¸­å†™çš„<code>/qqLogin/callback.do</code>,é‚£ä¹ˆä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ä¸ª<code>SocialAuthenticationFilter</code>å®ƒè¦å¤„ç†2ä¸ªè¯·æ±‚ï¼Œ</p><p>ç”¨æˆ·ç‚¹QQç™»å½•çš„æ—¶å€™ï¼Œå®ƒè¦æ¥å¤„ç†ï¼ŒæŠŠé¡µé¢å¯¼å‘QQç™»å½•çš„ç½‘ç«™ä¸Šå»ï¼Œç„¶åç”¨æˆ·åœ¨QQç½‘ç«™æˆæƒå®Œï¼Œæ‰«å®Œç åŒæ„ä»¥åï¼Œä»QQè·³å›æ¥ä¹Ÿæ˜¯ç”±<code>SocialAuthenticationFilter</code>æ¥å¤„ç†ï¼Œæ‰€ä»¥ç¬¬ä¸€è¡Œåˆ¤æ–­è¯·æ±‚ä¸­æœ‰æ²¡æœ‰codeï¼ˆæˆæƒç ï¼‰ï¼Œå¦‚æœæœ‰ï¼Œå°±è®¤ä¸ºæ˜¯ç¬¬3æ­¥ä»æœåŠ¡å™¨ä¸Šè·³å›æ¥çš„ï¼Œå¦‚æœæ²¡æœ‰æˆæƒç ï¼Œå°±è®¤ä¸ºæ˜¯ç¬¬1æ­¥ï¼Œå®ƒä¼šæŠ›å‡ºä¸€ä¸ª<code>SocialAuthenticationRedirectException</code>çš„å¼‚å¸¸ï¼Œ<code>SpringSocial</code>æ•è·åˆ°è¿™ä¸ªå¼‚å¸¸ä»¥åå°±ä¼šæŠŠç”¨æˆ·é‡å®šå‘åˆ°QQçš„ç½‘ç«™ä¸Šå»</p><p>å¦‚æœä¼ è¿›æ¥çš„è¯·æ±‚æœ‰<code>codeå‚æ•°</code>é‚£ä¹ˆè¯´æ˜æ˜¯æœåŠ¡å™¨è·³è½¬å›æ¥çš„ï¼Œé‚£ä¹ˆå®ƒè¦åšçš„äº‹æƒ…å°±æ˜¯æ‹¿åˆ°è¿æ¥å·¥å‚çš„<code>OAuthOperations</code>ç„¶åè°ƒç ”å®ƒçš„<code>exchangeForAccess</code>ï¼Œè¿™é‡Œå°±æ˜¯æ‹¿è¿”å›çš„æˆæƒç å»æ¢ä»¤ç‰Œï¼Œä¹Ÿå°±æ˜¯æµç¨‹å›¾ä¸­çš„ç¬¬4æ­¥å’Œç¬¬5æ­¥ï¼Œæˆ‘ä»¬ç°åœ¨é‡åˆ°çš„é—®é¢˜å°±æ˜¯åœ¨ç½‘ç«™æˆæƒä¹‹åï¼Œè·³å›æ¥è¡Œä¸ºå¹¶ä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„</p><hr><p>ç°åœ¨åœ¨<code>OAuth2AuthenticationService</code>çš„98è¡Œå’Œ103è¡Œã€267è¡Œï¼Œ</p><p><code>AbstractAuthenticationProcessingFilter</code>çš„230è¡Œæ‰“ä¸€ä¸ªæ–­ç‚¹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567272856158.png" srcset="/img/loading.gif" alt="1567272856158"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273669776.png" srcset="/img/loading.gif" alt="1567273669776"></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273839249.png" srcset="/img/loading.gif" alt="1567273839249"></p><p>ç„¶åå†æ¥æ‰«ç è¿›è¡Œç™»å½•ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567272963991.png" srcset="/img/loading.gif" alt="1567272963991"></p><p>å½“å®ƒæ‰§è¡Œäº†98è¡Œä¹‹åï¼Œä¼šå‡ºç°å¼‚å¸¸ï¼Œå®ƒçš„å¼‚å¸¸ä¿¡æ¯ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273032467.png" srcset="/img/loading.gif" alt="1567273032467"></p><pre><code class="hljs routeros">Could <span class="hljs-keyword">not</span> extract response: <span class="hljs-literal">no</span> suitable HttpMessageConverter found <span class="hljs-keyword">for</span> response<span class="hljs-built_in"> type </span>[interface java.util.Map] <span class="hljs-keyword">and</span> content<span class="hljs-built_in"> type </span>[text/html]</code></pre><p>ä¸èƒ½æŠ½å–<code>response</code>çš„ä¿¡æ¯ï¼Œæ²¡æœ‰åˆé€‚çš„<code>HttpMessageConverter</code> ä¸ºæˆ‘ä»¬çš„å“åº”ç±»å‹ï¼Œ<code>Map</code>å’Œ<code>content type text/html</code>è¿™æ˜¯QQå“åº”å›æ¥çš„<code>content type</code>ï¼Œé‚£ä¹ˆæŠ¥è¿™ä¸ªå¼‚å¸¸å°±æ˜¯å› ä¸ºåœ¨<code>exchangeForAccess</code>æ˜¯æœ‰é—®é¢˜çš„</p><pre><code class="hljs java">AccessGrant accessGrant = getConnectionFactory().getOAuthOperations().exchangeForAccess(code, returnToUrl, <span class="hljs-keyword">null</span>);</code></pre><hr><p>æ¥çœ‹ä¸€ä¸‹<code>OAuth2Template#exchangeForAccess</code>ï¼Œå®ƒå»äº¤æ¢<code>accessToken</code>åšäº†ä»€ä¹ˆ</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> AccessGrant <span class="hljs-title">exchangeForAccess</span><span class="hljs-params">(String authorizationCode, String redirectUri, MultiValueMap&lt;String, String&gt; additionalParameters)</span> </span>&#123;MultiValueMap&lt;String, String&gt; params = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();<span class="hljs-keyword">if</span> (useParametersForClientAuthentication) &#123;params.set(<span class="hljs-string">"client_id"</span>, clientId);params.set(<span class="hljs-string">"client_secret"</span>, clientSecret);&#125;params.set(<span class="hljs-string">"code"</span>, authorizationCode);params.set(<span class="hljs-string">"redirect_uri"</span>, redirectUri);params.set(<span class="hljs-string">"grant_type"</span>, <span class="hljs-string">"authorization_code"</span>);<span class="hljs-keyword">if</span> (additionalParameters != <span class="hljs-keyword">null</span>) &#123;params.putAll(additionalParameters);&#125;<span class="hljs-keyword">return</span> postForAccessGrant(accessTokenUrl, params);&#125;</code></pre><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯OAuth2ä¸­é€šè¿‡<code>accessToken</code>æ¢å–ä»¤ç‰Œçš„æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¸Šé¢è®¾äº†ä¸€äº›å‚æ•°ï¼Œåˆ°<code>postForAccessGrant</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> AccessGrant <span class="hljs-title">postForAccessGrant</span><span class="hljs-params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;<span class="hljs-keyword">return</span> extractAccessGrant(getRestTemplate().postForObject(accessTokenUrl, parameters, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;&#125;</code></pre><p>ç”¨å®ƒè‡ªå·±çš„<code>restTemplate</code>å‘äº†ä¸€ä¸ªpostè¯·æ±‚ï¼Œå‘å‡ºå»çš„<code>post</code>è¯·æ±‚åœ¨å›æ¥çš„æ—¶å€™è¦æŠŠå“åº”çš„æ•°æ®è½¬æ¢æˆä¸€ä¸ª<code>map</code>ï¼Œå®ƒç”¨<code>restTemplate</code>ï¼Œå°±æ„å‘³ç€å®ƒæœŸæœ›è¿”å›æ¥çš„æ˜¯ä¸€ä¸ª<code>json</code>æ ¼å¼çš„æ•°æ®ï¼Œç„¶åè¿”å›<code>content type</code>ä¹Ÿæ˜¯ä¸€ä¸ª<code>application/json</code>ï¼Œè€Œåˆšæ‰çœ‹åˆ°çš„é”™è¯¯ä¿¡æ¯é‡Œè¿”å›æ¥çš„æ˜¯ä¸€ä¸ª<code>text/html</code>ï¼Œæ‰€ä»¥æŠ¥äº†è¿™ä¹ˆä¸€ä¸ªé”™è¯¯ï¼ŒæŠ¥äº†è¿™ä¸ªé”™è¯¯ä»¥åå®ƒå°±ä¼šè¢«æ•è·åˆ°å®ƒå°±ä¼šè¿”å›<code>null</code>ï¼Œç„¶åå¾€ä¸‹èµ°çš„ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273714849.png" srcset="/img/loading.gif" alt="1567273714849"></p><p>å¦‚æœ<code>token</code>è¿”å›<code>null</code>é‚£ä¹ˆå®ƒè¿™é‡Œä¹Ÿå°±è¿”å›<code>null</code>ï¼Œåˆ°è¿™è¿”å›<code>null</code>ï¼Œ<code>Social</code>åˆæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273869452.png" srcset="/img/loading.gif" alt="1567273869452"></p><p>ç„¶åå®ƒå°±ä¼šè¢«<code>AbstractAuthenticationProcessingFilter</code>æ•è·åˆ°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567273908737.png" srcset="/img/loading.gif" alt="1567273908737"></p><p>æœ€åä¼šè°ƒç”¨å¤±è´¥å¤„ç†å™¨ä¸Šå»</p><p><code>SocialAuthenticationFilter</code>çš„å¤±è´¥å¤„ç†å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> SimpleUrlAuthenticationFailureHandler delegateAuthenticationFailureHandler;<span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();<span class="hljs-keyword">private</span> String filterProcessesUrl = DEFAULT_FILTER_PROCESSES_URL;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SocialAuthenticationFilter</span><span class="hljs-params">(AuthenticationManager authManager, UserIdSource userIdSource, UsersConnectionRepository usersConnectionRepository, SocialAuthenticationServiceLocator authServiceLocator)</span> </span>&#123;<span class="hljs-keyword">this</span>.delegateAuthenticationFailureHandler = <span class="hljs-keyword">new</span> SimpleUrlAuthenticationFailureHandler(DEFAULT_FAILURE_URL);&#125;<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_FAILURE_URL = <span class="hljs-string">"/signin"</span>;</code></pre><p>å®ƒä¼šå°†æˆ‘ä»¬å½“å‰åº”ç”¨é‡å®šå‘åˆ°<code>DEFAULT_FAILURE_URL</code>è·¯å¾„ä¸Šå»ï¼Œä¹Ÿå°±æ˜¯<code>/signin</code>ï¼Œå¾€è¿™å»è·³ï¼Œå› ä¸ºåœ¨<code>browseré…ç½®</code>ä¸­æ²¡åšè¿™ä¸ªè¯·æ±‚çš„æˆæƒï¼Œæ‰€ä»¥å°±åœ¨æµè§ˆå™¨ä¸­å“åº”è¯·å…ˆæˆæƒçš„ä¿¡æ¯</p><hr><p>ç°åœ¨é—®é¢˜çš„æ ¹æºæ‰¾åˆ°äº†ï¼Œå®ƒçš„<code>OAuth2RestTemplate</code>æ˜¯ä¸èƒ½å¤„ç†<code>html</code>è¿™ç§<code>content type</code>çš„å“åº”çš„ï¼Œä¸ºä»€ä¹ˆä¸èƒ½å¤„ç†ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>&#123;ClientHttpRequestFactory requestFactory = ClientHttpRequestFactorySelector.getRequestFactory();RestTemplate restTemplate = <span class="hljs-keyword">new</span> RestTemplate(requestFactory);List&lt;HttpMessageConverter&lt;?&gt;&gt; converters = <span class="hljs-keyword">new</span> ArrayList&lt;HttpMessageConverter&lt;?&gt;&gt;(<span class="hljs-number">2</span>);converters.add(<span class="hljs-keyword">new</span> FormHttpMessageConverter());converters.add(<span class="hljs-keyword">new</span> FormMapHttpMessageConverter());converters.add(<span class="hljs-keyword">new</span> MappingJackson2HttpMessageConverter());restTemplate.setMessageConverters(converters);restTemplate.setErrorHandler(<span class="hljs-keyword">new</span> LoggingErrorHandler());<span class="hljs-keyword">if</span> (!useParametersForClientAuthentication) &#123;List&lt;ClientHttpRequestInterceptor&gt; interceptors = restTemplate.getInterceptors();<span class="hljs-keyword">if</span> (interceptors == <span class="hljs-keyword">null</span>) &#123;   <span class="hljs-comment">// defensively initialize list if it is null. (See SOCIAL-430)</span>interceptors = <span class="hljs-keyword">new</span> ArrayList&lt;ClientHttpRequestInterceptor&gt;();restTemplate.setInterceptors(interceptors);&#125;interceptors.add(<span class="hljs-keyword">new</span> PreemptiveBasicAuthClientHttpRequestInterceptor(clientId, clientSecret));&#125;<span class="hljs-keyword">return</span> restTemplate;&#125;</code></pre><p>å®ƒåœ¨åŠ åˆ›å»º<code>RestTemplate</code>å¾€é‡Œé¢åŠ <code>HttpMessageConverter</code>çš„æ—¶å€™ï¼Œå®ƒæ²¡æœ‰åŠ å¤„ç†<code>text/html contont type</code>è¿™ç§<code>HttpMessageConverter</code>ï¼Œæ‰€ä»¥ç°åœ¨è¦åšçš„äº‹æƒ…å°±æ˜¯æ›¿æ¢æ‰è¿™ä¸ª<code>OAuth2</code>é»˜è®¤çš„çš„<code>createRestTemplate</code>ï¼Œå†™ä¸€ä¸ªè‡ªå·±çš„å®ç°ï¼Œç„¶ååœ¨è‡ªå·±çš„å®ç°é‡Œå¤šåŠ ä¸€ä¸ª<code>HttpMessageConverter</code>ï¼Œè®©å®ƒå¯ä»¥å¤„ç†<code>text/html</code>çš„<code>contont type</code>ï¼›</p><p>é¦–é€‰åˆ›å»ºä¸€ä¸ªç±»å®ç°<code>OAuth2Template</code>ï¼Œè¿™é‡Œé¦–å…ˆåŠ ä¸Š<code>MessageConverter</code>çš„æ”¯æŒ</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.connect;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.http.converter.StringHttpMessageConverter;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.AccessGrant;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.OAuth2Template;<span class="hljs-keyword">import</span> org.springframework.util.MultiValueMap;<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQOAuth2Template</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OAuth2Template</span> </span>&#123;      <span class="hljs-comment">//...</span>      <span class="hljs-comment">//é‡å†™createRestTemplateï¼Œè§£å†³ä¸èƒ½å¤„ç†text/html</span>   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">protected</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>&#123;      RestTemplate restTemplate = <span class="hljs-keyword">super</span>.createRestTemplate();      restTemplate.getMessageConverters().add(<span class="hljs-keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="hljs-string">"UTF-8"</span>)));      <span class="hljs-keyword">return</span> restTemplate;   &#125; &#125;</code></pre><p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒæŒ‰ç…§ <code>OAuth2</code>é»˜è®¤çš„æƒ³æ³•æ¥è¯´ï¼Œå®ƒå‘å‡ºçš„è¯·æ±‚å‘å“åº”çš„ç»“æœæ˜¯ä¸€ä¸ª<code>json</code></p><p><code>org.springframework.social.oauth2.OAuth2Template#postForAccessGrantï¼š</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> AccessGrant <span class="hljs-title">postForAccessGrant</span><span class="hljs-params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;<span class="hljs-keyword">return</span> extractAccessGrant(getRestTemplate().postForObject(accessTokenUrl, parameters, Map<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;&#125;</code></pre><p>å®ƒæŠŠjsonè§£ææˆä¸€ä¸ª<code>map</code>ä¼ ç»™<code>extractAccessGrant</code>æ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">private</span> AccessGrant <span class="hljs-title">extractAccessGrant</span><span class="hljs-params">(Map&lt;String, Object&gt; result)</span> </span>&#123;<span class="hljs-keyword">return</span> createAccessGrant((String) result.get(<span class="hljs-string">"access_token"</span>), (String) result.get(<span class="hljs-string">"scope"</span>), (String) result.get(<span class="hljs-string">"refresh_token"</span>), getIntegerValue(result, <span class="hljs-string">"expires_in"</span>), result);&#125;</code></pre><p>åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢å®ƒä»è¿™ä¸ª<code>map</code>ä¸­å»è·å–<code>access_token</code>ã€<code>refresh_token</code>ã€<code>scope</code>ã€<code>expires_in</code>ï¼Œè¿™4ä¸ªå­—æ®µï¼Œç„¶åæ‹¿è¿™4ä¸ªå­—æ®µå»å®ä¾‹åŒ–ä¸€ä¸ª<code>AccessGrant</code>ï¼Œè¿™ä¸ª<code>AccessGrant</code>ç±»æ˜¯å¯¹<code>OAuthåè®®</code>ä¸­è®¿é—®ä»¤ç‰Œ<code>access_token</code>çš„å°è£…ï¼Œè¿™æ˜¯å®ƒé»˜è®¤çš„ä¸€ä¸ªæƒ³æ³•ï¼Œä½†æ˜¯åœ¨å®é™…ä¸Šå‘¢ï¼Ÿæ¥çœ‹çœ‹QQäº’è”ä¸Šçš„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567275464175.png" srcset="/img/loading.gif" alt="1567275464175"></p><p>è¿™é‡Œçš„è¯´æ˜ï¼Œå®ƒæœ€ç»ˆè¿”å›æ˜¯å¹¶ä¸æ˜¯ä¸€ä¸ªjson</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567275497959.png" srcset="/img/loading.gif" alt="1567275497959"></p><p>è€Œæ˜¯è¿™æ ·çš„å­—ç¬¦ä¸²ï¼Œç”¨<strong>&amp;</strong>éš”å¼€çš„3ä¸ªå­—æ®µ,ä¸‹é¢é’ˆå¯¹è¿™ç§ç‰¹æ®Šçš„å“åº”æ ¼å¼æ¥è¿›è¡Œä¸€ä¸ªå¤„ç†ï¼Œè¿™é‡Œé€šè¿‡&amp;è¿›è¡Œåˆ†å‰²ï¼Œç„¶åä¸€ä¸ªä¸ªè·å–=åé¢çš„å€¼æ¥è·å–<code>accessToken</code>ã€<code>expiresIn</code>ã€<code>refreshToken</code>æ¥å®ä¾‹åŒ–<code>AccessGrant</code></p><pre><code class="hljs java"><span class="hljs-comment">//qqäº’è”è·å–accessTokeçš„å“åº”è¿”å›çš„æ˜¯&amp;æ‹¼æ¥çš„å­—ç¬¦ä¸²</span>   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">protected</span> AccessGrant <span class="hljs-title">postForAccessGrant</span><span class="hljs-params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;      String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;            log.info(<span class="hljs-string">"è·å–accessTokeçš„å“åº”ï¼š"</span>+responseStr);            String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, <span class="hljs-string">"&amp;"</span>);            String accessToken = StringUtils.substringAfterLast(items[<span class="hljs-number">0</span>], <span class="hljs-string">"="</span>);      Long expiresIn = <span class="hljs-keyword">new</span> Long(StringUtils.substringAfterLast(items[<span class="hljs-number">1</span>], <span class="hljs-string">"="</span>));      String refreshToken = StringUtils.substringAfterLast(items[<span class="hljs-number">2</span>], <span class="hljs-string">"="</span>);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AccessGrant(accessToken, <span class="hljs-keyword">null</span>, refreshToken, expiresIn);   &#125;</code></pre><p>æœ€åä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è°ƒç”¨è¿™ä¸ª<code>postForAccessGrant</code>ä¹‹å‰æ‹¼è£…çš„ä¸€äº›å‚æ•°çš„æ—¶å€™çš„é€»è¾‘ï¼›org.springframework.social.oauth2.OAuth2Template#exchangeForAccessï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> AccessGrant <span class="hljs-title">exchangeForAccess</span><span class="hljs-params">(String authorizationCode, String redirectUri, MultiValueMap&lt;String, String&gt; additionalParameters)</span> </span>&#123;MultiValueMap&lt;String, String&gt; params = <span class="hljs-keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();<span class="hljs-keyword">if</span> (useParametersForClientAuthentication) &#123;params.set(<span class="hljs-string">"client_id"</span>, clientId);params.set(<span class="hljs-string">"client_secret"</span>, clientSecret);&#125;params.set(<span class="hljs-string">"code"</span>, authorizationCode);params.set(<span class="hljs-string">"redirect_uri"</span>, redirectUri);params.set(<span class="hljs-string">"grant_type"</span>, <span class="hljs-string">"authorization_code"</span>);<span class="hljs-keyword">if</span> (additionalParameters != <span class="hljs-keyword">null</span>) &#123;params.putAll(additionalParameters);&#125;<span class="hljs-keyword">return</span> postForAccessGrant(accessTokenUrl, params);&#125;</code></pre><p>è¿™é‡Œæœ‰5ä¸ªå‚æ•°ï¼Œåœ¨QQäº’è”ä¸Šä¹Ÿè¦æ±‚5ä¸ªå‚æ•°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567275898849.png" srcset="/img/loading.gif" alt="1567275898849"></p><p>è¿™é‡Œæ˜¯<code>OAuthåè®®</code>è¦æ±‚çš„ï¼Œæ‰€ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å°±å¯ä»¥äº†ï¼Œä½†æ˜¯è¿™æœ‰ä¸€ä¸ªï¼Œå®ƒæœ‰ä¸€ä¸ªå±æ€§å«åš<code>useParametersForClientAuthentication</code>ï¼Œåªæœ‰è¿™ä¸ªå±æ€§æ˜¯<code>true</code>æ‰ä¼šå¸¦å…¥<code>client_id</code>ã€<code>client_secret</code>ï¼Œåœ¨é»˜è®¤æƒ…å†µä¸‹å®ƒä¸º<code>false</code>ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬å†™çš„ä»£ç ä¸­çš„æ„é€ å‡½æ•°è¿™ï¼Œè°ƒç”¨<code>useParametersForClientAuthentication</code>çš„setæ–¹æ³•ï¼Œç»™å®ƒæ”¹ä¸º<code>true</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQOAuth2Template</span><span class="hljs-params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;     <span class="hljs-keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);     <span class="hljs-comment">//useParametersForClientAuthenticationä¸ºtrueæ—¶exchangeForAccessæ–¹æ³•ã€‚æ‰ä¼šsetclientId</span>     setUseParametersForClientAuthentication(<span class="hljs-keyword">true</span>);  &#125;</code></pre><p>å®Œæ•´ä»£ç ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social.qq.connect;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.http.converter.StringHttpMessageConverter;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.AccessGrant;<span class="hljs-keyword">import</span> org.springframework.social.oauth2.OAuth2Template;<span class="hljs-keyword">import</span> org.springframework.util.MultiValueMap;<span class="hljs-keyword">import</span> org.springframework.web.client.RestTemplate;<span class="hljs-keyword">import</span> java.nio.charset.Charset;<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QQOAuth2Template</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OAuth2Template</span> </span>&#123;       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQOAuth2Template</span><span class="hljs-params">(String clientId, String clientSecret, String authorizeUrl, String accessTokenUrl)</span> </span>&#123;      <span class="hljs-keyword">super</span>(clientId, clientSecret, authorizeUrl, accessTokenUrl);      <span class="hljs-comment">//useParametersForClientAuthenticationä¸ºtrueæ—¶exchangeForAccessæ–¹æ³•ã€‚æ‰ä¼šsetclientId</span>      setUseParametersForClientAuthentication(<span class="hljs-keyword">true</span>);   &#125;      <span class="hljs-comment">//qqäº’è”è·å–accessTokeçš„å“åº”è¿”å›çš„æ˜¯&amp;æ‹¼æ¥çš„å­—ç¬¦ä¸²</span>   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">protected</span> AccessGrant <span class="hljs-title">postForAccessGrant</span><span class="hljs-params">(String accessTokenUrl, MultiValueMap&lt;String, String&gt; parameters)</span> </span>&#123;      String responseStr = getRestTemplate().postForObject(accessTokenUrl, parameters, String<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;            log.info(<span class="hljs-string">"è·å–accessTokeçš„å“åº”ï¼š"</span>+responseStr);            String[] items = StringUtils.splitByWholeSeparatorPreserveAllTokens(responseStr, <span class="hljs-string">"&amp;"</span>);            String accessToken = StringUtils.substringAfterLast(items[<span class="hljs-number">0</span>], <span class="hljs-string">"="</span>);      Long expiresIn = <span class="hljs-keyword">new</span> Long(StringUtils.substringAfterLast(items[<span class="hljs-number">1</span>], <span class="hljs-string">"="</span>));      String refreshToken = StringUtils.substringAfterLast(items[<span class="hljs-number">2</span>], <span class="hljs-string">"="</span>);            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AccessGrant(accessToken, <span class="hljs-keyword">null</span>, refreshToken, expiresIn);   &#125;      <span class="hljs-comment">//é‡å†™createRestTemplateï¼Œè§£å†³ä¸èƒ½å¤„ç†text/html</span>   <span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">protected</span> RestTemplate <span class="hljs-title">createRestTemplate</span><span class="hljs-params">()</span> </span>&#123;      RestTemplate restTemplate = <span class="hljs-keyword">super</span>.createRestTemplate();      restTemplate.getMessageConverters().add(<span class="hljs-keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="hljs-string">"UTF-8"</span>)));      <span class="hljs-keyword">return</span> restTemplate;   &#125; &#125;</code></pre><p> ä¿®æ”¹com.b4.mcr.auth.core.social.qq.connect.QQServiceProvider#QQServiceProvider</p><pre><code class="hljs java"><span class="hljs-comment">//æä¾›OAuth2Operations</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">QQServiceProvider</span><span class="hljs-params">(String appId, String appSecret)</span> </span>&#123;      <span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> QQOAuth2Template(appId, appSecret, URL_AUTHORIZE, URL_ACCESS_TOKEN));      <span class="hljs-keyword">this</span>.appId = appId;  &#125;</code></pre><h1 id="å¤„ç†æ³¨å†Œé€»è¾‘"><a href="#å¤„ç†æ³¨å†Œé€»è¾‘" class="headerlink" title="å¤„ç†æ³¨å†Œé€»è¾‘"></a>å¤„ç†æ³¨å†Œé€»è¾‘</h1><p>ç°åœ¨æ‰«å®Œç ï¼Œæµè§ˆå™¨çš„å“åº”ï¼š</p><pre><code class="hljs json">&#123;<span class="hljs-attr">"content"</span>: <span class="hljs-string">"è¯·å¼•å¯¼ç”¨æˆ·è·³è½¬åˆ°ç™»å½•é¡µé¢"</span>&#125;</code></pre><p>æ§åˆ¶å°ä¸Šï¼š</p><pre><code class="hljs angelscript"><span class="hljs-number">2019</span><span class="hljs-number">-09</span><span class="hljs-number">-01</span> <span class="hljs-number">09</span>:<span class="hljs-number">55</span>:<span class="hljs-number">49.188</span>  INFO <span class="hljs-number">22124</span> --- [p-nio<span class="hljs-number">-80</span>-exec<span class="hljs-number">-2</span>] c.b.m.a.b.BrowserSecurityController      : å¼•å‘è·³è½¬çš„è¯·æ±‚-&gt;http:<span class="hljs-comment">//www.pinzhi365.com/signup</span></code></pre><p>ç°åœ¨ä¸åˆšæ‰ä¸åŒï¼Œè¿™é‡Œè·³è½¬åˆ°äº†<code>/signup</code>åœ°å€</p><hr><p>ç°åœ¨debugï¼Œæ¥è·Ÿä¸€ä¸‹æºç ï¼Œåœ¨<code>SocialAuthenticationProvider</code>64è¡Œ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303470227.png" srcset="/img/loading.gif" alt="1567303470227"></p><p><code>SocialAuthenticationFilter</code>333è¡Œæ‰“ç«¯ç‚¹</p><hr><p>ç„¶åæ¥æ‰«ç è¿›è¡Œç™»å½•ï¼Œ</p><p>åœ¨<code>authenticate</code>ï¼Œä¸­çš„<code>connection</code>ï¼Œå°±æ˜¯æœåŠ¡æä¾›å•†ç»™çš„ç”¨æˆ·ä¿¡æ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303654006.png" srcset="/img/loading.gif" alt="1567303654006"></p><p>ï¼Œè¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ª<code>toUserId</code>æ–¹æ³•ï¼Œå°†<code>connection</code>å¯¹è±¡ä¼ é€’è¿›å»ï¼Œè¿™é‡Œçš„<code>toUserId</code>æ˜¯åœ¨æˆ‘ä»¬æ•°æ®åº“çš„<code>UsersConnection</code>è¡¨é‡Œé¢æ ¹æ®<code>openId</code>å»æŸ¥è¯¢<code>userId</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303706754.png" srcset="/img/loading.gif" alt="1567303706754"></p><p>å› ä¸º<code>UsersConnection</code>è¡¨é‡Œé¢æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥æ˜¯<code>null</code>çš„ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303811677.png" srcset="/img/loading.gif" alt="1567303811677"></p><p><code>SocialAuthenticationFilter#doAuthentication</code>æ•è·åˆ°äº†æŠ›å‡ºçš„å¼‚å¸¸ï¼Œå®ƒä¼šåˆ¤æ–­<code>signupUrl</code>å±æ€§æ˜¯ä¸æ˜¯ç©ºçš„ï¼Œå¦‚æœæ˜¯ç©ºçš„ï¼Œå®ƒä¼šè®¤ä¸ºä½ è®¾ç½®äº†ä¸€ä¸ªæ³¨å†Œçš„é¡µé¢ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæŠ›å‡º<code>SocialAuthenticationRedirectException</code>å¼‚å¸¸ï¼Œ<code>SpringSocial</code>æ‹¿åˆ°è¿™ä¸ªå¼‚å¸¸å°±ä¼šè·³è½¬åˆ°ä½ æŒ‡å®šçš„æ³¨å†Œé¡µçš„URLä¸Šï¼Œé»˜è®¤çš„æ³¨å†Œé¡µé¢å°±æ˜¯<code>/signup</code>ï¼Œå› ä¸ºåœ¨é…ç½®ä¸­æ²¡æœ‰åšæˆæƒï¼Œæ‰€ä»¥ä¼šè¢«æ‹¦ä¸‹æ¥ï¼Œå“åº”éœ€è¦æˆæƒçš„æç¤ºä¿¡æ¯</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303877749.png" srcset="/img/loading.gif" alt="1567303877749"></p><hr><p>ä»¥ä¸Šå°±æ˜¯äº§ç”Ÿæœ€ç»ˆç»“æœçš„åŸå› ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œæˆ‘ä»¬å»å†™ä¸€ä¸ªæ³¨å†Œé¡µï¼Œç„¶åæŠŠè¿™ä¸ª<code>signupUrl</code>é…ç½®æˆè‡ªå·±å†™çš„æ³¨å†Œé¡µï¼Œåœ¨åˆ°<code>BrowserSecurityConfig</code>é…ç½®ä¸€ä¸‹URLï¼Œä¸ç»è¿‡èº«ä»½è®¤è¯å°±å¯ä»¥è®¿é—®ï¼Œé¦–å…ˆåœ¨<code>mcr-auth-browser</code>ä¸­å†™é»˜è®¤çš„æ³¨å†Œé¡µï¼š</p><p>mcr-signUp.html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>æ ‡å‡†æ³¨å†Œé¡µ<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>æ ‡å‡†æ³¨å†Œé¡µ<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>è¿™æ˜¯ç³»ç»Ÿæ³¨å†Œé¡µé¢ï¼Œè¯·é…ç½®mcr.b4.security.browser.signUpUrlå±æ€§æ¥è®¾ç½®è‡ªå·±çš„æ³¨å†Œé¡µ<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>BrowserSecurityPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> String signUpUrl = <span class="hljs-string">"/mcr-signUp.html"</span>;</code></pre><p>åœ¨<code>demoæ¨¡å—</code>ä¸­ï¼Œä½¿ç”¨è‡ªå·±çš„æ³¨å†Œé¡µï¼š</p><blockquote><p>è¿™é‡Œè¡¨å•ä¸­çš„actionï¼Œä¸ç”¨ç®¡ä»–ï¼Œå› ä¸ºæ¯ä¸ªæ³¨å†Œçš„é€»è¾‘éƒ½ä¸ä¸€æ ·ï¼Œå› ä¸ºè¿™é‡Œæœ‰2ç§å¯èƒ½ï¼Œè¿™ä¸ªç”¨æˆ·åœ¨ä½¿ç”¨è€…çš„ç³»ç»Ÿä¸­æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç”¨æˆ·ï¼Œå®ƒä»¥å‰æ²¡æœ‰ç”¨ç”¨æˆ·åå¯†ç ç™»å½•è¿‡ï¼Œè¿™ä¸ªæ—¶å€™ä»–å¯èƒ½æ˜¯æ³¨å†Œä¸€ä¸ªå…¨æ–°çš„ç”¨æˆ·ï¼Œå¦å¤–ä¸€ç§å¯èƒ½æ˜¯è¿™ä¸ªç”¨æˆ·ä»¥å‰ä»–æœ‰è‡ªå·±çš„ç”¨æˆ·åå¯†ç ï¼Œè¿™ä¸ªæ—¶å€™ä»–è¦åšçš„äº‹æƒ…å¯èƒ½å°±ä¸æ˜¯ä¸€ä¸ªæ³¨å†Œäº†ï¼Œæ˜¯ä¸€ä¸ªç»‘å®šï¼Œä»–è¦æŠŠå½“å‰çš„QQç”¨æˆ·ç»‘å®šåˆ°ç³»ç»Ÿçš„è´¦æˆ·ä¸Šå»</p></blockquote><p>demo-signUp.html</p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Demoæ³¨å†Œé¡µ<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/user/regist"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>ç”¨æˆ·å:<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"userName"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>å¯†ç :<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"type"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"regist"</span>&gt;</span>æ³¨å†Œ<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"type"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"binding"</span>&gt;</span>ç»‘å®š<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>ç„¶åä½¿ç”¨è€…éœ€è¦è‡ªå·±å†™æ³¨å†Œé€»è¾‘ï¼›</p><p>UserController</p><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/regist"</span>)  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">regist</span><span class="hljs-params">(UserVO userVO)</span> </span>&#123;      <span class="hljs-comment">//æ³¨å†Œç”¨æˆ·...</span>  &#125;</code></pre><p>yml</p><pre><code class="hljs yml"><span class="hljs-attr">mcr:</span>  <span class="hljs-attr">b4:</span>    <span class="hljs-attr">security:</span>      <span class="hljs-attr">browser:</span>        <span class="hljs-attr">signUpUrl:</span> <span class="hljs-string">/demo-signUp.html</span></code></pre><p>BrowserSecurityConfig</p><pre><code class="hljs java">.antMatchers(                      browser.getSignUpUrl(),</code></pre><p>åœ¨<code>Socialé…ç½®</code>ä¸­å‘Šè¯‰<code>SocialAuthenticationFilter</code>è·³è½¬çš„æ³¨å†Œé¡µé¢è·¯å¾„åœ¨å“ªé‡Œ</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialConfigurerAdapter</span> </span>&#123;<span class="hljs-comment">//...</span> <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> SpringSocialConfigurer <span class="hljs-title">mcrSpringSocialConfigurer</span><span class="hljs-params">()</span> </span>&#123;        McrSpringSocialConfigurer mcrSpringSocialConfigurer = <span class="hljs-keyword">new</span> McrSpringSocialConfigurer(securityProperties.getSocial().getFilterProcessesUrl());        mcrSpringSocialConfigurer.signupUrl(securityProperties.getBrowser().getSignUpUrl());        <span class="hljs-keyword">return</span> mcrSpringSocialConfigurer;    &#125;&#125;</code></pre><hr><p>ç°åœ¨è¿›è¡Œç™»å½•å°±èƒ½è·³è½¬åˆ°æŒ‡å®šçš„æ³¨å†Œé¡µé¢ä¸Šå»äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567307154192.png" srcset="/img/loading.gif" alt="1567307154192"></p><hr><p>ç°åœ¨å®ƒèƒ½è·³åˆ°è‡ªå·±å†™demoæ³¨å†Œé¡µé¢ä¸Šå»äº†ï¼Œç°åœ¨æœ‰2ä¸ªé—®é¢˜ï¼š</p><ol><li>åœ¨demoé¡µé¢ä¸Šï¼Œæˆ‘ä¸æƒ³å¹²å·´å·´å°±æ˜¾ç¤ºç™»å½•é¡µï¼Œæˆ‘å¯èƒ½è¦æ˜¾ç¤ºä¸€äº›è·Ÿå½“å‰ç”¨æˆ·ä¿¡æ¯ç›¸å…³çš„ä¸€äº›æ¶ˆæ¯ï¼Œæ¯”å¦‚ä½ å½“å‰åœ¨ç”¨QQçš„å“ªä¸ªè´¦å·ç™»å½•ï¼Œç„¶åæŠŠå¤´åƒæ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œå‘Šè¯‰ç”¨æˆ·ä½ æ˜¯åœ¨ç”¨è¿™ä¸ªè´¦å·åœ¨ç™»å½•ï¼Œä½  æ˜¯è¦æ³¨å†Œä¸€ä¸ªæ–°ç”¨æˆ·è¿˜æ˜¯è¦æŠŠè¿™ä¸ªQQç»‘å®šå·²æœ‰çš„ç”¨æˆ·ä¸Šï¼Œè¿™æ ·è®©ç”¨æˆ·çš„æ„Ÿè§‰æ›´å‹å¥½ï¼Œåœ¨æ³¨å†Œé¡µä¸Šå¦‚ä½•æ‹¿åˆ°æˆ‘åœ¨ä¹‹å‰OAuthæµç¨‹é‡Œæ‹¿åˆ°çš„ç¤¾äº¤ç”¨æˆ·çš„ä¿¡æ¯ï¼Ÿ</li><li>æˆ‘åœ¨ç‚¹æ³¨å†Œæˆ–è€…ç»‘å®šä»¥åï¼Œæˆ‘è¿™ä¸ªè¯·æ±‚æäº¤åˆ°æˆ‘demoé¡¹ç›®çš„ç»‘å®šã€æ³¨å†Œè¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œä¸ç®¡æ˜¯æ³¨å†Œè¿˜æ˜¯ç»‘å®šæœ€ç»ˆæˆ‘èƒ½ç¡®å®šç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬è¯´çš„<code>userId</code>ï¼Œå¦‚ä½•æŠŠè¿™ä¸ª<code>userId</code>åœ¨ä¼ ç»™<code>SpringSocial</code>ï¼Œè®©<code>SpringSocial</code>æŠŠç”¨æˆ·idè·Ÿæˆ‘ä¹‹å‰æ‹¿åˆ°çš„é‚£äº›ç¤¾äº¤ç”¨æˆ·çš„ä¿¡æ¯ä¸€èµ·å­˜åˆ°æ•°æ®åº“<code>UserConnection</code>è¡¨é‡Œé¢å»ï¼Ÿ</li></ol><p>ä¸ºäº†å¤„ç†è¿™2ä¸ªé—®é¢˜ï¼Œ<code>Spring</code>æä¾›äº†ä¸€ä¸ªå·¥å…·ç±»ï¼š<code>ProviderSignInUtils</code></p><p>SocialConfig</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> ProviderSignInUtils <span class="hljs-title">providerSignInUtils</span><span class="hljs-params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ProviderSignInUtils(connectionFactoryLocator,              getUsersConnectionRepository(connectionFactoryLocator));  &#125;</code></pre><p>å…ˆå®šä¹‰ä¸€ä¸ªç›¸åº”æ•°æ®çš„ç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.model.vo;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialUserInfoVO</span> </span>&#123;    <span class="hljs-keyword">private</span> String providerId;    <span class="hljs-keyword">private</span> String providerUserId;    <span class="hljs-keyword">private</span> String nickname;    <span class="hljs-keyword">private</span> String headimg;&#125;</code></pre><p>BrowserSecurityControllerï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@Slf</span>4j-<span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/authentication"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityController</span> </span>&#123;   <span class="hljs-comment">//properties....</span>      <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ProviderSignInUtils providerSignInUtils;    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/social/user"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> SocialUserInfoVO <span class="hljs-title">getSocialUserInfo</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;        SocialUserInfoVO socialUserInfoVO = <span class="hljs-keyword">new</span> SocialUserInfoVO();        Connection&lt;?&gt; connection = providerSignInUtils.getConnectionFromSession(<span class="hljs-keyword">new</span> ServletWebRequest(request, response));        socialUserInfoVO.setProviderId(connection.getKey().getProviderId());        socialUserInfoVO.setProviderUserId(connection.getKey().getProviderUserId());        socialUserInfoVO.setNickname(connection.getDisplayName());        socialUserInfoVO.setHeadimg(connection.getImageUrl());        <span class="hljs-keyword">return</span> socialUserInfoVO;    &#125;    +    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/authentication/require"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> McrSecurityVO <span class="hljs-title">requireAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;      <span class="hljs-comment">//...</span>    &#125;&#125;</code></pre><p><code>ProviderSignInUtils</code>æ˜¯ä»<code>session</code>é‡Œé¢æ‹¿<code>Connection</code>ä¿¡æ¯çš„ï¼Œ<code>Connection</code>æ˜¯ä»€ä¹ˆæ—¶å€™æ”¾åˆ°<code>session</code>é‡Œé¢çš„å‘¢ï¼Ÿ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567303877749.png" srcset="/img/loading.gif" alt="1567303877749"></p><p>è¿˜è®°å¾—ä¹‹å‰ä»‹ç»çš„è¿™ä¸ªä»£ç å§ï¼Ÿ</p><p>åé¢å®ƒæ‰§è¡Œäº†ä¸€æ®µï¼Œå®ƒæ˜¯åœ¨è·³è½¬é¡µé¢ä¹‹å‰ï¼ŒæŠŠ<code>Connection</code>ä»<code>token</code>é‡Œæ‹¿å‡ºæ¥ï¼Œæ”¾åˆ°<code>session</code>ä¸­ï¼Œç„¶åæŠŠè·³æ”¾å…¥<code>session</code>ä»¥åè·³åˆ°äº†æˆ‘ä»¬çš„æ³¨å†Œé¡µä¸Šå»</p><pre><code class="hljs java"><span class="hljs-keyword">if</span> (signupUrl != <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// store ConnectionData in session and redirect to register page</span>sessionStrategy.setAttribute(<span class="hljs-keyword">new</span> ServletWebRequest(request), ProviderSignInAttempt.SESSION_ATTRIBUTE, <span class="hljs-keyword">new</span> ProviderSignInAttempt(token.getConnection()));<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> SocialAuthenticationRedirectException(buildSignupUrl(request));&#125;</code></pre><p>ï¼Œç„¶åæˆ‘ç°åœ¨å»å‘å†™å¥½çš„<code>/social/user</code>ï¼Œè¯·æ±‚ï¼Œä»<code>session</code>ä¸­æ‹¿å‡ºæ¥ï¼Œæ‹¼æˆç”¨æˆ·ä¿¡æ¯ç»™å‰ç«¯ã€‚</p><p>ç°åœ¨ç”¨æˆ·å®Œæˆæ³¨å†Œè¿‡ç¨‹ä»¥åï¼Œä¸ç®¡æ˜¯æ³¨å†Œè¿˜æ˜¯ç»‘å®šï¼Œå®ƒéƒ½ä¼šæ‹¿åˆ°ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ä½•æŠŠè¿™ä¸ªå”¯ä¸€æ ‡è¯†ç»™æˆ‘ä»¬çš„<code>SpringSocial</code>ï¼Ÿ</p><p>UserController</p><pre><code class="hljs java"><span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ProviderSignInUtils providerSignInUtils;    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/regist"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">regist</span><span class="hljs-params">(UserVO userVO, HttpServletResponse response, HttpServletRequest request)</span> </span>&#123;        <span class="hljs-comment">//ä¸ç®¡æ˜¯æ³¨å†Œç”¨æˆ·è¿˜æ˜¯ç»‘å®šç”¨æˆ·ï¼Œéƒ½ä¼šæ‹¿åˆ°ä¸€ä¸ªç”¨æˆ·å”¯ä¸€æ ‡è¯†</span>        String userId = userVO.getUserName();        <span class="hljs-comment">//ä»¥ä¸‹çœç•¥æ³¨å†Œã€ç»‘å®šé€»è¾‘....</span>        providerSignInUtils.doPostSignUp(userId, <span class="hljs-keyword">new</span> ServletWebRequest(request, response));    &#125;</code></pre><p>è¿™é‡Œé€šè¿‡<code>ProviderSignInUtils</code>çš„<code>doPostSignUp</code>å°±èƒ½æŠŠæ•°æ®æ’å…¥åˆ°æ•°æ®åº“ä¸­çš„<code>UsersConnection</code>è¡¨é‡Œé¢å»äº†ï¼Œç°åœ¨æŠŠè¿™ä¸ªæ³¨å†Œè¯·æ±‚é…ç½®ä¸€ä¸‹ï¼Œè®©å®ƒä¸ç”¨æˆæƒå°±èƒ½è®¿é—®</p><p>BrowserSecurityPropertiesï¼š</p><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment">    * æ³¨å†Œè¯·æ±‚</span><span class="hljs-comment">    */</span>   <span class="hljs-keyword">private</span> String registUrl = <span class="hljs-string">"/user/regist"</span>;</code></pre><p>BrowserSecurityConfigï¼š</p><pre><code class="hljs java">.antMatchers(        browser.getRegistUrl(), <span class="hljs-comment">//...</span></code></pre><p>ç°åœ¨è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šQQæ‰«ç ç™»å½•ï¼Œæ•´ä¸ªæµç¨‹è·‘é€šäº†ï¼Œå¯æ˜¯æ¯æ¬¡éƒ½ä¼šè·³è½¬åˆ°æ³¨å†Œé¡µé¢ä¸Šå»ï¼Œè¿™ä»€ä¹ˆæ€ä¹ˆå›äº‹ï¼Ÿåœ¨SocialAuthenticationProvider#authenticateä¸­ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567318854639.png" srcset="/img/loading.gif" alt="1567318854639"></p><p>è¿™é‡Œä¾ç„¶æ‹¿ä¸åˆ°<code>userId</code>ï¼Œæ‰€ä»¥æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶åæ•è·åˆ°äº†ï¼Œ<code>SpringSocial</code>å°±è®¤ä¸ºåœ¨è¡¨é‡Œæ²¡æœ‰è¿›è¡Œæ³¨å†Œï¼Œé‚£ä¹ˆå°±è·³è½¬æ³¨å†Œé¡µé¢ä¸Šäº†ï¼Œä½†æ˜¯æˆ‘ä»¬æ•°æ®åº“çš„<code>UsersConnection</code>è¡¨é‡Œé¢æœ‰æ•°æ®å•Šï¼Ÿä¸ºä»€ä¹ˆä¼šæŸ¥ä¸åˆ°æ•°æ®ï¼Ÿ</p><p>ç°åœ¨å°±æ¥è·Ÿä¸€ä¸‹è¿™ä¸ª<code>toUserId</code>æ–¹æ³•ã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567319073110.png" srcset="/img/loading.gif" alt="1567319073110"></p><p>è¿™é‡Œçœ‹åˆ°ï¼Œå®ƒè¿™ä½¿ç”¨çš„<code>UsersConnectionRepository</code>å®ç°ç±»æ˜¯<code>InMemoryUsersConnectionRepository</code>ï¼Œæ²¡æœ‰ç”¨æˆ‘ä»¬é…ç½®çš„<code>JdbcUsersConnectionRepository</code>ï¼Œæ‰€ä»¥éœ€è¦åœ¨æˆ‘ä»¬çš„é…ç½®ç±»ä¸­åŠ ä¸Š<code>@Order</code>æ³¨è§£</p><pre><code class="hljs java"><span class="hljs-meta">@Order</span>(<span class="hljs-number">0</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SocialConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SocialConfigurerAdapter</span></span></code></pre><p>å› ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Ÿå› ä¸º<code>SpringSocial</code>ä¸­çš„é…ç½®ï¼Œæ¯”è¿™ä¸ª<code>SocialConfig</code>é…ç½®å…ˆæ‰§è¡Œäº†ï¼Œè€Œå®ƒé‚£è¾¹çš„é»˜è®¤çš„</p><p><code>UsersConnectionRepository</code>æ˜¯<code>InMemoryUsersConnectionRepository</code>ï¼Œæ‰€ä»¥è¿™é‡Œå°±å¿…é¡»æ¯”å®ƒå…ˆæ‰§è¡Œã€‚</p><hr><p>è¿™ä¸ªæ³¨å†Œæ˜¯éœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥çš„ï¼Œæœ‰äº›æ—¶å€™ä¸æƒ³è¿™ä¹ˆåšï¼Œå¾®ä¿¡ã€QQç™»å½•ä»¥åï¼Œè™½ç„¶è¿™ä¸ªç”¨æˆ·åœ¨ç³»ç»Ÿé‡Œæ²¡æœ‰è¿™ä¸ªç”¨æˆ·ï¼Œä½†æ˜¯æˆ‘ä¸è¦æ±‚ä½ å»æ³¨å†Œï¼Œæˆ‘ç›´æ¥å·å·çš„ç»™ä½ æ³¨å†Œä¸€ä¸ªç”¨æˆ·ï¼Œä½ å°±å¯ä»¥ä¸ç”¨è·³åˆ°åˆšåˆšé‚£ä¸ªæ³¨å†Œé¡µé¢å»ï¼Œç›´æ¥è®©ç”¨æˆ·è¿›ç³»ç»Ÿ</p><hr><p>åœ¨å¼€å§‹ä»£ç ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹æºç ï¼›</p><p>SocialAuthenticationProviderï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567321588180.png" srcset="/img/loading.gif" alt="1567321588180"></p><p>è¿™é‡Œé€šè¿‡<code>UsersConnectionRepository</code>ï¼Œä¹Ÿå°±æ˜¯<code>JdbcUsersConnectionRepository</code>ï¼Œé€šè¿‡å®ƒçš„<code>findUserIdsWithConnection</code>æ–¹æ³•æ¥æ‹¿å–<code>userId</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">findUserIdsWithConnection</span><span class="hljs-params">(Connection&lt;?&gt; connection)</span> </span>&#123;ConnectionKey key = connection.getKey();List&lt;String&gt; localUserIds = jdbcTemplate.queryForList(<span class="hljs-string">"select userId from "</span> + tablePrefix + <span class="hljs-string">"UserConnection where providerId = ? and providerUserId = ?"</span>, String<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">key</span>.<span class="hljs-title">getProviderId</span>(), <span class="hljs-title">key</span>.<span class="hljs-title">getProviderUserId</span>())</span>;<span class="hljs-keyword">if</span> (localUserIds.size() == <span class="hljs-number">0</span> &amp;&amp; connectionSignUp != <span class="hljs-keyword">null</span>) &#123;String newUserId = connectionSignUp.execute(connection);<span class="hljs-keyword">if</span> (newUserId != <span class="hljs-keyword">null</span>)&#123;createConnectionRepository(newUserId).addConnection(connection);<span class="hljs-keyword">return</span> Arrays.asList(newUserId);&#125;&#125;<span class="hljs-keyword">return</span> localUserIds;&#125;</code></pre><p>è¿™é‡Œé€šè¿‡<code>jdbcTemplate</code>æ‰§è¡Œ<code>sqlè¯­å¥</code>ï¼Œç„¶ååˆ¤æ–­è¿™ä¸ª<code>sqlè¯­å¥</code>è·å–åˆ°æ•°æ®æ˜¯ä¸æ˜¯ç©ºçš„ï¼Œå¦‚æœä¸æ˜¯ç©ºçš„ï¼Œå®ƒå°±ä¼šæ‰§è¡Œï¼š</p><pre><code class="hljs java">String newUserId = connectionSignUp.execute(connection);</code></pre><p>â€‹    è¿™é‡Œçš„<code>connectionSignUp</code>æ˜¯<code>ConnectionSignUp</code>æ¥å£ï¼Œå®ƒè¿™æ²¡æœ‰å®ç°ç±»ï¼Œæ‰€ä»¥å®ƒè¿™é‡Œå¯¹è±¡æ˜¯ç©ºçš„ï¼Œå°±ä¸ä¼šèµ°é‡Œé¢çš„ä»£ç ï¼Œæˆ‘ä»¬è¿™è¿™é‡Œå®šä¹‰ä¸€ä¸ªç±»å®ç°è¿™ä¸ªæ¥å£ï¼Œåœ¨executeè°ƒç”¨è‡ªå·±çš„æ³¨å†Œæ–¹æ³•ï¼Œç„¶åè¿”å›æˆ‘ä»¬ä¸šåŠ¡ç³»ç»Ÿé‡Œé¢çš„<code>userId</code>å‡ºå»ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä»£ç çš„<code>newUserId</code>ï¼Œå¦‚æœä¸ä¸º<code>null</code>ï¼Œå®ƒä¼šæ‰§è¡Œ</p><pre><code class="hljs java">createConnectionRepository(newUserId).addConnection(connection);</code></pre><p>è¿™é‡Œå®ƒå°†<code>newUserId</code>å’Œ<code>Connection</code>ä¿¡æ¯ä¸€èµ·æ’åˆ°æ•°æ®åº“é‡Œï¼Œå»ºä¸€æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯å®ƒæ ¹æ®ä½ ç¤¾äº¤è´¦å·ä¿¡æ¯ï¼Œé»˜è®¤çš„å¸®ä½ æ³¨å†Œç„¶åç™»å½•ä¸Šï¼Œå°±æ˜¯è¿™ä¹ˆä¸€ä¸ªé€»è¾‘</p><hr><p>ç°åœ¨æˆ‘ä»¬è¦åšçš„å°±æ˜¯ç»™<code>JdbcUsersConnectionRepository</code>æ·»åŠ ä¸€ä¸ª<code>ConnectionSignUp</code>å®ç°ç±»ï¼Œç»™å®ƒé‡Œé¢çš„<code>connectionSignUp</code>èµ‹å€¼</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security;<span class="hljs-keyword">import</span> org.springframework.social.connect.Connection;<span class="hljs-keyword">import</span> org.springframework.social.connect.ConnectionSignUp;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoConnectionSignUp</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ConnectionSignUp</span> </span>&#123;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see org.springframework.social.connect.ConnectionSignUp#execute(org.springframework.social.connect.Connection)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">execute</span><span class="hljs-params">(Connection&lt;?&gt; connection)</span> </span>&#123;<span class="hljs-comment">//æ ¹æ®ç¤¾äº¤ç”¨æˆ·ä¿¡æ¯é»˜è®¤åˆ›å»ºç”¨æˆ·å¹¶è¿”å›ç”¨æˆ·å”¯ä¸€æ ‡è¯†</span><span class="hljs-keyword">return</span> connection.getDisplayName();&#125;&#125;</code></pre><p>SocialConfig:</p><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span>(required = <span class="hljs-keyword">false</span>)    <span class="hljs-keyword">private</span> ConnectionSignUp connectionSignUp;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UsersConnectionRepository <span class="hljs-title">getUsersConnectionRepository</span><span class="hljs-params">(ConnectionFactoryLocator connectionFactoryLocator)</span> </span>&#123;     <span class="hljs-comment">//...</span>        <span class="hljs-keyword">if</span> (connectionSignUp != <span class="hljs-keyword">null</span>) &#123;            repository.setConnectionSignUp(connectionSignUp);        &#125;        <span class="hljs-keyword">return</span> repository;    &#125;</code></pre><h1 id="ç»‘å®šå’Œè§£ç»‘å¤„ç†"><a href="#ç»‘å®šå’Œè§£ç»‘å¤„ç†" class="headerlink" title="ç»‘å®šå’Œè§£ç»‘å¤„ç†"></a>ç»‘å®šå’Œè§£ç»‘å¤„ç†</h1><p>ç»‘å®šçš„æµç¨‹å’ŒQQç™»å½•æµç¨‹æ˜¯ä¸€æ ·çš„ï¼Œä¸ä¸€æ ·çš„åœ°æ–¹ï¼šæˆ‘åœ¨QQç™»å½•ï¼Œå¼€å§‹èµ°æµç¨‹çš„æ—¶å€™ï¼Œæˆ‘æ˜¯ä¸çŸ¥é“å½“å‰ç³»ç»Ÿçš„ç™»å½•è´¦å·æ˜¯è°çš„ï¼Œå› ä¸ºè¦åœ¨èµ°å®Œæµç¨‹ä»¥åç”¨æ‹¿åˆ°çš„ç¤¾äº¤è´¦å·å»ç™»å½•ç³»ç»Ÿï¼Œè€Œç»‘å®šè´¦å·æ˜¯å·²ç»çŸ¥é“å½“å‰ç”¨æˆ·æ˜¯è°äº†ï¼Œç„¶åå†å»èµ°é‚£ä¸ªæµç¨‹ï¼Œç»“æŸä»¥åæŠŠç³»ç»Ÿè´¦å·å’Œç¤¾äº¤è´¦å·è¿›è¡Œä¸€ä¸ªå…³è”ï¼Œ<code>SpringSocial</code>å¯¹è¿™æ ·çš„åœºæ™¯æä¾›äº†é»˜è®¤æ”¯æŒï¼Œä¸‹é¢æ¥çœ‹ä¸€ä¸‹ï¼Œå¦‚ä½•åœ¨<code>SpringSocial</code>æä¾›çš„é»˜è®¤æ”¯æŒè‡ªå·±å†™ä»£ç ï¼Œå®ç°è¿™ä¸ªåœºæ™¯</p><hr><h2 id="æŸ¥è¯¢ç»‘å®šçŠ¶æ€"><a href="#æŸ¥è¯¢ç»‘å®šçŠ¶æ€" class="headerlink" title="æŸ¥è¯¢ç»‘å®šçŠ¶æ€"></a>æŸ¥è¯¢ç»‘å®šçŠ¶æ€</h2><p>ç°åœ¨éœ€è¦3ä¸ªæœåŠ¡ï¼š</p><ol><li>è·å–æ‰€æœ‰çš„ç¤¾äº¤ç½‘ç«™çš„ç»‘å®šä¿¡æ¯ï¼Œå‡è®¾æˆ‘ä»¬ç³»ç»Ÿä¸­è¦æ±‚æœ‰QQã€å¾®ä¿¡ã€å¾®åš3ç§ï¼Œé‚£ä¹ˆé¦–å…ˆå°±è¦å…ˆæŸ¥è¯¢å½“å‰ç”¨æˆ·çš„ç»‘å®šä¿¡æ¯</li><li>ç»‘å®šä¿¡æ¯</li><li>è§£é™¤ç»‘å®šä¿¡æ¯</li></ol><p>è¿™3ä¸ªæœåŠ¡<code>SpringSocial</code>éƒ½ä¸ºæˆ‘ä»¬æä¾›äº†ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯å»è°ƒå®ƒçš„æœåŠ¡</p><p>è·å–å½“å‰ç™»å½•è´¦å·ç»‘å®šä¿¡æ¯çš„æœåŠ¡ï¼š</p><pre><code class="hljs http"><span class="hljs-attribute">http://www.pinzhi365.com/connect</span></code></pre><p>è¿™ä¸ªæœåŠ¡é¡µé¢å“åº”å†…å®¹ï¼š</p><pre><code class="hljs routeros">Whitelabel <span class="hljs-builtin-name">Error</span> PageThis application has <span class="hljs-literal">no</span> explicit mapping <span class="hljs-keyword">for</span> /error, so you are seeing this as a fallback.Sun Sep 01 19:46:33 CST 2019There was an unexpected <span class="hljs-builtin-name">error</span> (<span class="hljs-attribute">type</span>=Method <span class="hljs-keyword">Not</span> Allowed, <span class="hljs-attribute">status</span>=405).Request method <span class="hljs-string">'GET'</span> <span class="hljs-keyword">not</span> supported</code></pre><p>æ§åˆ¶å°ï¼š</p><pre><code class="hljs oxygene"><span class="hljs-number">2019</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">19</span>:<span class="hljs-number">46</span>:<span class="hljs-number">33.658</span>  WARN <span class="hljs-number">52916</span> --- [p-nio-<span class="hljs-number">80</span>-exec-<span class="hljs-number">8</span>] o.s.web.servlet.PageNotFound             : Request <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">GET</span>' <span class="hljs-title">not</span> <span class="hljs-title">supported</span></span></code></pre><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé”™è¯¯ï¼Ÿæ¥çœ‹ä¸€ä¸‹<code>ConnectController</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567338754296.png" srcset="/img/loading.gif" alt="1567338754296"></p><p>è¿™ä¸ªç±»å°±æ˜¯åˆšæ‰è®¿é—®<code>/connect</code>è¯·æ±‚çš„å¤„ç†å™¨ï¼Œå½“è¯·æ±‚è¿™ä¸ªURLçš„æ—¶å€™ä¼šè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(method=RequestMethod.GET)<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">connectionStatus</span><span class="hljs-params">(NativeWebRequest request, Model model)</span> </span>&#123;setNoCache(request);processFlash(request, model);Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = connectionRepository.findAllConnections();model.addAttribute(<span class="hljs-string">"providerIds"</span>, connectionFactoryLocator.registeredProviderIds());model.addAttribute(<span class="hljs-string">"connectionMap"</span>, connections);<span class="hljs-keyword">return</span> connectView();&#125;</code></pre><p>åœ¨è¿™é‡Œé€šè¿‡<code>Model</code>æ¥å­˜å‚¨äº†ä¸€äº›æ•°æ®ï¼Œè€Œè¿™é‡Œçš„æ•°æ®ï¼Œå°±æ˜¯æˆ‘ä»¬è¦çš„ç»‘å®šä¿¡æ¯</p><p>ï¼Œè¿™é‡Œå®ƒæ²¡ç”¨ä½¿ç”¨<code>@ResponseBody</code>æ³¨è§£ï¼Œé‚£ä¹ˆå°±æ„å‘³ç€ï¼Œå®ƒä¼šè·³è½¬åˆ°ä¸€ä¸ªé¡µé¢ä¸Šå»ï¼Œå®ƒè¿™é‡Œè¿”å›çš„æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">connectView</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> getViewPath() + <span class="hljs-string">"status"</span>;&#125;</code></pre><p>åœ¨è¿™é‡Œè®¾ç½®ä¸€ä¸ªç«¯ç‚¹ï¼Œç»§ç»­è®¿é—®ï¼š<a href="http://www.pinzhi365.com/connectï¼Œ" target="_blank" rel="noopener">http://www.pinzhi365.com/connectï¼Œ</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567341713955.png" srcset="/img/loading.gif" alt="1567341713955"></p><p>è¿™é‡Œçš„providerIdså°±æ˜¯ç»‘å®šä¿¡æ¯äº†ï¼Œç„¶åçœ‹ä¸€ä¸‹è¿”å›ç»“æœï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567341566840.png" srcset="/img/loading.gif" alt="1567341566840"></p><p>è¿™é‡Œè¿”å›<code>connect/status</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªè§†å›¾çš„åå­—ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬è¿™é‡Œæ²¡æœ‰å†™è¿™ä¸ªè§†å›¾ï¼Œæ‰€ä»¥å°±å‡ºå»</p><pre><code class="hljs oxygene"><span class="hljs-number">2019</span>-<span class="hljs-number">09</span>-<span class="hljs-number">01</span> <span class="hljs-number">19</span>:<span class="hljs-number">46</span>:<span class="hljs-number">33.658</span>  WARN <span class="hljs-number">52916</span> --- [p-nio-<span class="hljs-number">80</span>-exec-<span class="hljs-number">8</span>] o.s.web.servlet.PageNotFound             : Request <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">GET</span>' <span class="hljs-title">not</span> <span class="hljs-title">supported</span></span></code></pre><p>æç¤ºä¿¡æ¯</p><hr><p>ç°åœ¨å°±æ¥å†™ä¸€ä¸‹è¿™ä¸ªè§†å›¾</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-meta">@Component</span>(<span class="hljs-string">"connect/status"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrConnectionStatusView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractView</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">renderMergedOutputModel</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt; connections = (Map&lt;String, List&lt;Connection&lt;?&gt;&gt;&gt;) model.get(<span class="hljs-string">"connectionMap"</span>);        Map&lt;String, Boolean&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        <span class="hljs-keyword">for</span> (String key : connections.keySet()) &#123;            result.put(key, CollectionUtils.isNotEmpty(connections.get(key)));        &#125;        response.setContentType(<span class="hljs-string">"application/json;charset=UTF-8"</span>);        response.getWriter().write(objectMapper.writeValueAsString(result));    &#125;&#125;</code></pre><p>è¿™é‡Œè¯´ä¸€ä¸‹ï¼šå®ƒçš„<code>model</code>å‚æ•°å­˜å‚¨äº†ä¹‹å‰è¯´çš„<code>org.springframework.social.connect.web.ConnectController#connectionStatus(org.springframework.web.context.request.NativeWebRequest, org.springframework.ui.Model)</code>ä¸­é€šè¿‡<code>model</code>å­˜å‚¨çš„æ•°æ®ï¼Œè¿™é€šè¿‡<code>model</code>é‚£å‡ºæ¥ï¼Œåšä¸€äº›å¤„ç†ï¼Œå“åº”å‡ºå»å°±å®ŒæˆæŸ¥è¯¢ç»‘å®šä¿¡æ¯åŠŸèƒ½äº†ï¼Œç°åœ¨è®¿é—®<a href="http://www.pinzhi365.com/connectçš„å“åº”ç»“æœï¼š" target="_blank" rel="noopener">http://www.pinzhi365.com/connectçš„å“åº”ç»“æœï¼š</a></p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"callback.do"</span>: <span class="hljs-literal">true</span>&#125;</code></pre><p>è¿™é‡ŒåšæŸ¥è¯¢ç»‘å®šä¿¡æ¯è¦æ³¨æ„ï¼šä½ è®¤è¯æˆåŠŸï¼Œæ”¾åˆ°<code>session</code>é‡Œçš„<code>UserDetails</code>ä¸€å®šè¦æ˜¯ä¸€ä¸ª<code>SocialUserDetails</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬è‡ªå·±å†™çš„<code>McrUserDetailsService</code>è¿™é‡Œçš„è¿”å›å€¼è¦æ˜¯SocialUserDetailsçš„å®ç°ï¼Œå› ä¸ºåªæœ‰åœ¨è¿™ä¸ªæ¥å£æ‰æœ‰<code>getUserId</code>æ–¹æ³•ï¼Œå®ƒæ‰èƒ½æ‹¿åˆ°ä½ çš„ç”¨æˆ·idï¼Œåœ¨è¡¨é‡Œé¢å»æŸ¥ï¼Œå¦‚æœä½ è¿”å›çš„æ˜¯ä¸€ä¸ª<code>UserDetails</code>æ¥å£çš„å®ç°å°±æ²¡æœ‰è¿™ä¸ªæ–¹æ³•çš„ï¼Œæ‰€ä»¥è¿™ä¸ªåŠŸèƒ½å°±æ²¡æ³•å®ç°äº†</p><h2 id="ç»‘å®š"><a href="#ç»‘å®š" class="headerlink" title="ç»‘å®š"></a>ç»‘å®š</h2><p>browserï¼šmcr-banding.html </p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>æ ‡å‡†ç»‘å®šé¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/connect/callback.do"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>ç»‘å®šQQ<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>è¿™é‡Œçš„<code>/connect/callback.do</code>ï¼Œ<code>/connect</code>æ˜¯å›ºå®šçš„ï¼Œåé¢çš„<code>callback.do</code>æ˜¯<code>providerId</code>ï¼Œå°±æ˜¯ä¹‹å‰<code>QQProperties</code>ä¸­çš„<code>providerId</code>å±æ€§ï¼Œç»‘å®šåŠŸèƒ½å®Œæˆï¼è®¿é—®ï¼š<a href="http://www.pinzhi365.com/mcr-banding.htmlæµ‹è¯•å§ï¼Œè¿™é‡Œä¼šå‡ºç°100010å¼‚å¸¸ï¼ŒåŸå› æ˜¯æˆ‘è¿™é‡Œçš„`callback.do`åœ¨org.springframework.social.connect.web.ConnectController#connectè¿™é‡Œè¢«`@PathVariable`æ³¨è§£è¿‡æ»¤æˆ`callback`ï¼Œ`.do`è¢«å¿½ç•¥äº†ï¼Œæ‰€ä»¥åœ¨QQäº’è”ä¸Šéœ€è¦å°†`.do`å»æ‰ï¼Œç„¶åå› ä¸ºå®ƒç»‘å®šçš„å›è°ƒåœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä¼šå˜æˆhttp://www.pinzhi365.com/connect/callback&amp;state=eab45238-f697-49bc-b5ad-6bd6b6397a3dï¼Œæ‰€ä»¥åœ¨QQäº’è”ä¸Šè¦å†™2ä¸ªå›è°ƒè¯·æ±‚ï¼Œè¿™é‡Œä½¿ç”¨åˆ†å·éš”å¼€" target="_blank" rel="noopener">http://www.pinzhi365.com/mcr-banding.htmlæµ‹è¯•å§ï¼Œè¿™é‡Œä¼šå‡ºç°100010å¼‚å¸¸ï¼ŒåŸå› æ˜¯æˆ‘è¿™é‡Œçš„`callback.do`åœ¨org.springframework.social.connect.web.ConnectController#connectè¿™é‡Œè¢«`@PathVariable`æ³¨è§£è¿‡æ»¤æˆ`callback`ï¼Œ`.do`è¢«å¿½ç•¥äº†ï¼Œæ‰€ä»¥åœ¨QQäº’è”ä¸Šéœ€è¦å°†`.do`å»æ‰ï¼Œç„¶åå› ä¸ºå®ƒç»‘å®šçš„å›è°ƒåœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒä¼šå˜æˆhttp://www.pinzhi365.com/connect/callback&amp;state=eab45238-f697-49bc-b5ad-6bd6b6397a3dï¼Œæ‰€ä»¥åœ¨QQäº’è”ä¸Šè¦å†™2ä¸ªå›è°ƒè¯·æ±‚ï¼Œè¿™é‡Œä½¿ç”¨åˆ†å·éš”å¼€</a></p><blockquote><p>è¿™é‡Œymlã€é¡µé¢ä¸Šçš„è¯·æ±‚ç¬”è€…å°±ä¸å»å†™å“ªé‡Œè¦æ”¹äº†</p></blockquote><pre><code class="hljs http"><span class="hljs-attribute">http://www.pinzhi365.com/qqLogin/callback;http://www.pinzhi365.com/connect/callback</span></code></pre><hr><p>ç»‘å®šå®Œä¹‹åçš„å¤„ç†</p><p>å½“ç»‘å®šæˆåŠŸä¹‹åï¼Œæ§åˆ¶å°ï¼š</p><pre><code class="hljs oxygene"><span class="hljs-number">2019</span>-<span class="hljs-number">09</span>-<span class="hljs-number">02</span> <span class="hljs-number">22</span>:<span class="hljs-number">10</span>:<span class="hljs-number">47.422</span>  WARN <span class="hljs-number">61344</span> --- [p-nio-<span class="hljs-number">80</span>-exec-<span class="hljs-number">6</span>] o.s.web.servlet.PageNotFound             : Request <span class="hljs-function"><span class="hljs-keyword">method</span> '<span class="hljs-title">GET</span>' <span class="hljs-title">not</span> <span class="hljs-title">supported</span></span></code></pre><p>åˆå¼•å‘äº†è¿™æ ·çš„å¼‚å¸¸ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>å› ä¸ºç»‘å®šå®Œä¹‹åï¼Œ<code>spring social</code>ä¼šåˆ°<code>org.springframework.social.connect.web.ConnectController#connectionStatus(java.lang.String, org.springframework.web.context.request.NativeWebRequest, org.springframework.ui.Model)</code>è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œåœ¨è¿™é‡Œå®ƒä¹Ÿè¿”å›äº†ä¸€ä¸ªè§†å›¾ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping</span>(value=<span class="hljs-string">"/&#123;providerId&#125;"</span>, method=RequestMethod.GET)<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">connectionStatus</span><span class="hljs-params">(@PathVariable String providerId, NativeWebRequest request, Model model)</span> </span>&#123;<span class="hljs-comment">//...</span><span class="hljs-keyword">if</span> (connections.isEmpty()) &#123;<span class="hljs-keyword">return</span> connectView(providerId); &#125; <span class="hljs-keyword">else</span> &#123;model.addAttribute(<span class="hljs-string">"connections"</span>, connections);<span class="hljs-keyword">return</span> connectedView(providerId);&#125;&#125;<span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">connectView</span><span class="hljs-params">(String providerId)</span> </span>&#123;<span class="hljs-keyword">return</span> getViewPath() + providerId + <span class="hljs-string">"Connect"</span>;&#125;</code></pre><p>é€šè¿‡debugï¼Œçœ‹åˆ°è¿™é‡Œè¿”å›çš„æ˜¯<code>connect/callbackConnected</code>ï¼Œå‰é¢çš„connectå’Œä¹‹å‰ä¸€æ ·æ˜¯å›ºå®šçš„ï¼Œè€Œåé¢çš„åˆ™æ˜¯é€šè¿‡<code>QQProperties</code>ä¸­çš„<code>providerId</code>å±æ€§+â€œConnectedâ€</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567433331902.png" srcset="/img/loading.gif" alt="1567433331902"></p><p>è¿™é‡Œå°±æ¥å†™ä¸€ä¸ªè¿™ä¸ªè§†å›¾ï¼Œè¿™é‡Œå› ä¸ºQQä¼šå†™æˆ<code>connect/callbackConnected</code>ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘è¿™é‡Œè¿˜æœ‰ä¸ªå¾®ä¿¡ã€æ–°æµªçš„ï¼Œé‚£å°±åˆè¦åœ¨å†™ä¸€éï¼Œä½†æ˜¯é‡Œé¢çš„å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ç”¨<code>@Component</code>æ³¨å…¥åˆ°IOCä¸­ï¼ŒæŠŠè¿™ä¸ªå½“åšä¸€ä¸ªå…¬å…±çš„ï¼Œé€šè¿‡é…ç½®ç±»ï¼Œåˆ†åˆ«æ³¨å…¥è¿›å»ï¼Œå› ä¸ºæ¯ä¸ªä¸‰æ–¹ç™»å½•ï¼Œåœ¨æˆ‘ä»¬ç³»ç»Ÿä¸­éƒ½ä¼šæœ‰ä¸€ä¸ªé…ç½®ç±»ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆæ¥</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-keyword">import</span> org.springframework.web.servlet.view.AbstractView;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrConnectionView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractView</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">renderMergedOutputModel</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);        response.getWriter().write(<span class="hljs-string">"&lt;h3&gt;ç»‘å®šæˆåŠŸ&lt;/h3&gt;"</span>);    &#125;&#125;</code></pre><p>QQAutoConfigï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>(<span class="hljs-string">"connect/callbackConnected"</span>)   <span class="hljs-meta">@ConditionalOnMissingBean</span>(name = <span class="hljs-string">"connect/callbackConnected"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> View <span class="hljs-title">qqConnectedView</span><span class="hljs-params">()</span> </span>&#123;       <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrConnectionView();   &#125;</code></pre><h2 id="è§£ç»‘"><a href="#è§£ç»‘" class="headerlink" title="è§£ç»‘"></a>è§£ç»‘</h2><p>è¿™é‡Œçš„è§£ç»‘å’Œç»‘å®šçš„è¯·æ±‚æ˜¯ä¸€æ ·çš„ï¼ŒåŒºåˆ«åœ¨äºè§£ç»‘çš„è¯·æ±‚æ–¹å¼æ˜¯<code>delete</code>ï¼Œè¿™é‡Œé¡µé¢ä¸Šæ— æ³•å¼„deleteè¯·æ±‚ï¼Œæœ‰äººç¬¬ä¸€æ—¶é—´æƒ³åˆ°ä½¿ç”¨<code>post man</code>æ¥è®¿é—®ï¼Œä½†æ˜¯ä½¿ç”¨<code>post man</code>å°±ä¸æ˜¯ä¸€ä¸ªä¼šè¯çš„äº†ï¼Œåˆè¦é‡æ–°ç™»å½•ï¼Œä¸å¤ªæ–¹ä¾¿ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨<code>restlet client</code>å·¥å…·æ¥è®¿é—®ï¼Œå› ä¸ºå®ƒæ˜¯æµè§ˆå™¨ä¸Šé¢çš„ï¼Œæ‰€ä»¥è¿˜åœ¨ä¸€ä¸ªä¼šè¯ä¸Š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567434697756.png" srcset="/img/loading.gif" alt="1567434697756"></p><p>è¿™é‡Œå“åº”äº†ä¸€ä¸ª302ï¼Œå®ƒçš„è§£ç»‘æœ€ç»ˆä¹Ÿä¼šè¿”å›åˆ°è§†å›¾ä¸Šå»ï¼Œå®ƒè¿™é‡Œè¿”å›çš„è§†å›¾å’Œç»‘å®šè¿”å›çš„è§†å›¾åå­—éå¸¸åƒï¼Œä¸è¿‡å®ƒåœ¨æœ«å°¾å°‘äº†ä¸€ä¸ªed</p><p>QQAutoConfigï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>(&#123;<span class="hljs-string">"connect/callbackConnected"</span>, <span class="hljs-string">"connect/callbackConnect"</span>&#125;)<span class="hljs-meta">@ConditionalOnMissingBean</span>(name = <span class="hljs-string">"connect/callbackConnected"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> View <span class="hljs-title">qqConnectedView</span><span class="hljs-params">()</span> </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrConnectionView();&#125;</code></pre><p>ç°åœ¨ç»‘å®šå’Œè§£ç»‘ä½¿ç”¨äº†ä¸€ä¸ªè§†å›¾ï¼Œè¦å¦‚ä½•åŒºåˆ†å‘¢ï¼Ÿç»‘å®šçš„<code>model</code>ä¸­æœ‰<code>connection</code>ï¼Œè€Œè§£ç»‘ä¸­æ²¡æœ‰ï¼Œå¯ä»¥æ‹¿æ¥åšåˆ¤æ–­ï¼Œå“åº”ä¸åŒçš„å†…å®¹</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.social;<span class="hljs-keyword">import</span> org.springframework.web.servlet.view.AbstractView;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrConnectionView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractView</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">renderMergedOutputModel</span><span class="hljs-params">(Map&lt;String, Object&gt; model, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);        <span class="hljs-keyword">if</span> (model.get(<span class="hljs-string">"connection"</span>) != <span class="hljs-keyword">null</span>) &#123;            response.getWriter().write(<span class="hljs-string">"&lt;h3&gt;ç»‘å®šæˆåŠŸ&lt;/h3&gt;"</span>);        &#125; <span class="hljs-keyword">else</span> &#123;            response.getWriter().write(<span class="hljs-string">"&lt;h3&gt;è§£å®šæˆåŠŸ&lt;/h3&gt;"</span>);        &#125;    &#125;&#125;</code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸‰ã€Social ã€‘ 2.SpringSocialåŸºæœ¬åŸç†</title>
    <link href="/spring-security-3.2.html"/>
    <url>/spring-security-3.2.html</url>
    
    <content type="html"><![CDATA[<p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567224896676.png" srcset="/img/loading.gif" alt="1567224896676"></p><p>ä¸Šä¸€ç« äº†è§£åˆ°<code>OAuth</code>åè®®å®é™…ä¸Šå°±æ˜¯æˆæƒåè®®ï¼Œå®ƒçš„ç›®çš„æ˜¯è®©ç”¨æˆ·åœ¨ä¸äº¤æœåŠ¡æä¾›å•†çš„ç”¨æˆ·åå’Œå¯†ç äº¤ç»™ç¬¬ä¸‰æ–¹åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œè®©ç¬¬ä¸‰æ–¹åº”ç”¨å¯ä»¥æœ‰æƒé™å»è®¿é—®ç”¨æˆ·å­˜åœ¨çš„æœåŠ¡æä¾›å•†ä¸Šçš„ä¸€äº›èµ„æºï¼Œè¿™ä¸ªæ˜¯<code>OAuth</code>åè®®å­˜åœ¨çš„ç›®çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæˆæƒåè®®å’Œæˆ‘ä»¬è¦å®ç°çš„ç¬¬ä¸‰æ–¹ç™»å½•æ˜¯ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿå…ˆæ¥è¯´ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œåœ¨ä¸Šä¸€ç« ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬èµ°å®Œè¿™ä¸ªæˆæƒåè®®æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œè¯´çš„åœºæ™¯æ˜¯æ‹¿ç”¨æˆ·çš„è‡ªæ‹æ•°æ®ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä¸å»æ‹¿ç”¨æˆ·çš„è‡ªæ‹æ•°æ®ï¼Œè€Œæ˜¯æ‹¿ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œæ¯”å¦‚å®ƒçš„æ˜µç§°ã€å¤´åƒï¼Œæˆ‘æ‹¿åˆ°äº†è¿™äº›æ•°æ®ä¿¡æ¯ä»¥åï¼Œæˆ‘æ ¹æ®ç”¨æˆ·ä¿¡æ¯æ„å»º<code>Authentication</code>ï¼Œæ”¾è¿›<code>SecurityContext</code>é‡Œé¢ï¼Œè¿™é‡Œ2ä¸ªç±»ä¹‹å‰è¯´è¿‡äº†ï¼Œè¯»è€…åº”è¯¥è¿˜æœ‰å°è±¡ï¼Œå½“ä½ å¾€<code>SecurityContext</code>é‡Œé¢æ”¾å…¥ç»è¿‡éªŒè¯çš„<code>Authentication</code>å®ä¾‹çš„æ—¶å€™ï¼Œå®é™…å¯¹<code>SpringSecurity</code>æ¥è¯´å·²ç»ç™»å½•æˆåŠŸäº†ï¼Œå¦‚æœæˆ‘ä»¬å¼•å¯¼ç”¨æˆ·èµ°å®Œè¿™ä¸ªæµç¨‹å®é™…ä¸Šå°±ç›¸å½“äºç”¨æˆ·ä½¿ç”¨äº†å®ƒåœ¨æœåŠ¡æä¾›å•†ä¸Šçš„ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ç™»å½•äº†æˆ‘ä»¬çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œè¿™ä¸ªå°±æ˜¯æ‰€è°“çš„ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆQQã€å¾®ä¿¡ç™»å½•ï¼‰ï¼Œå®ƒçš„ä¸€ä¸ªå®ç°åŸºæœ¬åŸç†å’Œæµç¨‹ï¼Œé‚£ä¹ˆ<code>SpringSocial</code>æ˜¯å¹²ä»€ä¹ˆçš„å‘¢ï¼Ÿå®ƒå®é™…ä¸Šå°±æ˜¯æŠŠè¿™ä¸ªæµç¨‹ï¼Œç»™ä½ å°è£…èµ·æ¥å®ç°äº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567224268835.png" srcset="/img/loading.gif" alt="1567224268835"></p><p><code>SpringSocial</code>å®ƒæŠŠæ•´ä¸ªæµç¨‹å°è£…åˆ°äº†<code>SocialAuthenticationFilter</code>è¿‡æ»¤å™¨é‡Œé¢ï¼Œç„¶åæŠŠè¿™ä¸ªè¿‡æ»¤å™¨åŠ åˆ°äº†<code>SpringSecurity</code>çš„è¿‡æ»¤å™¨é“¾ä¸Šï¼Œè¿™æ ·å½“ä½ è®¿é—®æ¯ä¸€ä¸ªè¯·æ±‚çš„æ—¶å€™ï¼Œ<code>SocialAuthenticationFilter</code>ä¼šæŠŠè¿™ä¸ªè¯·æ±‚æ‹¦ä¸‹æ¥ï¼Œç„¶åå¸¦ç€ä½ æŠŠå›¾1çš„æµç¨‹èµ°å®Œï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯å®ç°äº†å¾®ä¿¡ã€QQç™»å½•ï¼Œè¿™ä¸ªå°±æ˜¯å®ƒçš„æ ¸å¿ƒäº‹æƒ…</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567227175116.png" srcset="/img/loading.gif" alt="1567227175116"></p><p>å›¾1æ˜¯ä¸€ä¸ªé€»è¾‘å›¾ï¼Œç°åœ¨æ¥çœ‹ä¸€ä¸‹åœ¨<code>SpringSocial</code>å®ƒæ˜¯å¦‚ä½•æŠŠè¿™æ ·ä¸€ä¸ªæµç¨‹å°è£…åˆ°<code>SpringSocial</code>ç‰¹æœ‰çš„ä¸€äº›æ¥å£å’Œç±»é‡Œé¢çš„ã€‚</p><hr><p>é¦–å…ˆä»‹ç»ä¸€ä¸‹<code>ServiceProvider</code>ï¼Œå®ƒæ˜¯å›¾1ä¸­æœåŠ¡æä¾›å•†çš„æŠ½è±¡ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªå…·ä½“çš„æœåŠ¡æä¾›å•†ï¼Œæ¯”å¦‚QQã€å¾®ä¿¡ã€æ–°æµªï¼Œä½ éƒ½éœ€è¦æä¾›ä¸€ä¸ª<code>ServiceProvider</code>çš„å®ç°ç±»ï¼Œ<code>SpringSocial</code>ç»™æˆ‘ä»¬ æä¾›äº†ä¸€ä¸ª<code>AbstractOAuth2ServiceProvider</code>ï¼Œè¿™æ ·ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»™æˆ‘ä»¬å®ç°äº†ä¸€äº›å…±æœ‰çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ä½ æƒ³å®ç°QQæœåŠ¡æä¾›å•†å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªè¦ç»§æ‰¿è¿™ä¸ªæŠ½è±¡ç±»å°±OKäº†ã€‚</p><hr><p>è¯·çœ‹å›¾1ï¼Œåœ¨è¿™ä¸ªæœåŠ¡æä¾›å•†çš„6æ­¥ä¸­ï¼Œ1-5æ­¥å®ƒæ˜¯ä¸€ä¸ªæ ‡å‡†æµç¨‹ï¼Œä¹Ÿå°±æ˜¯æ‰€è¯´çš„<code>OAuth</code>åè®®æµç¨‹ï¼Œè€Œç¬¬6æ­¥æ˜¯ä¸€ä¸ªä¸ªæ€§åŒ–çš„æµç¨‹ï¼Œå› ä¸ºç¬¬6æ­¥æ¯ä¸€ä¸ªæœåŠ¡æä¾›å•†å®ƒæ‰€æä¾›çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå®ƒçš„æ•°æ®ç»“æ„éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¯èƒ½æœ‰çš„æœåŠ¡æä¾›å•†æä¾›3ä¸ªå­—æ®µï¼Œæœ‰çš„æä¾›5ä¸ªï¼Œæœ‰çš„äººçš„å¤´åƒå­—æ®µå«åš<code>headerImage</code>ï¼Œæœ‰çš„å«åš<code>image</code>ï¼Œå› ä¸ºéƒ½ä¸ä¸€æ ·ï¼Œæ‰€æœ‰ç¬¬6æ­¥æ˜¯ä¸ªæ€§åŒ–çš„ï¼Œé’ˆå¯¹è¿™2å—ï¼Œ<code>ServiceProvider</code>é‡Œåˆ†åˆ«æœ‰2ä¸ªå°è£…</p><ol><li>OAuth2Operationsï¼šè¿™ä¸ªå°±æ˜¯<code>OAuth2</code>çš„ç›¸å…³æ“ä½œç±»ï¼Œå®ƒå°è£…äº†ç¬¬ä¸€æ­¥åˆ°ç¬¬5æ­¥<code>OAuth</code>åè®®çš„æ ‡å‡†æµç¨‹ï¼Œ<code>SpringSocial</code>æä¾›ç»™æˆ‘ä»¬äº†ä¸€ä¸ªé»˜è®¤çš„å®ç°<code>OAuth2Template</code>ï¼Œè¿™ä¸ªç±»ä¼šå¸®åŠ©æˆ‘ä»¬å®Œæˆ<code>OAuth</code>åè®®çš„æµç¨‹;</li><li>Apiï¼š<code>Api</code>æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„æ¥å£ï¼Œå› ä¸ºæ¯ä¸€ä¸ªæœåŠ¡æä¾›å•†å®ƒå¯¹ç”¨æˆ·åŸºæœ¬ä¿¡æ¯çš„è°ƒç”¨éƒ½æ˜¯æœ‰åŒºåˆ«çš„ï¼Œæ‰€ä»¥åœ¨è¿™ä¸€å—è¦è‡ªå·±å»å†™ä¸€ä¸ªæ¥å£æ¥å°è£…è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯ç¬¬6æ­¥çš„è¡Œä¸ºï¼Œè¿™é‡Œ<code>SpringSocial</code>ä¹Ÿæä¾›äº†æŠ½è±¡ç±»ï¼š<code>AbstractOAuth2ApiBinding</code>ï¼Œæ¥å¸®åŠ©æˆ‘ä»¬æ›´å¿«çš„å®ç°æˆ‘ä»¬ç¬¬6æ­¥æ‰€éœ€è¦å°è£…çš„<code>Api</code>å®ç°ã€‚</li></ol><hr><p>ç°åœ¨çœ‹åˆ°çš„è¿™3ä¸ªæ¥å£ä»¥åŠç›¸åº”çš„<code>æŠ½è±¡ç±»/å®ç°</code>å®é™…ä¸Šæ˜¯å°è£…äº†å›¾1ä¸­è·ŸæœåŠ¡æä¾›å•†ç›¸å…³çš„ä¸œè¥¿ï¼Œä¹Ÿå°±æ˜¯ç¬¬1æ­¥åˆ°ç¬¬6æ­¥çš„è¡Œä¸ºï¼Œé‚£ä¹ˆåˆ°ç¬¬7æ­¥ï¼Œè·ŸæœåŠ¡æä¾›å•†æ²¡æœ‰ä»»ä½•å…³ç³»äº†ï¼Œç¬¬7æ­¥æ•´ä¸ªéƒ½æ˜¯åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨å†…éƒ¨å®Œæˆçš„ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢å›¾ä¸­å·¦è¾¹è¿™ä¸€å—</p><ol><li>Connectionï¼šè¿™ä¸ªæ¥å£ä¸æ˜¯æ•°æ®åº“ä¸­çš„<code>Connection</code>ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°è£…æˆ‘ä»¬å‰6æ­¥å®Œæˆä»¥åè·å¾—åˆ°çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨å®é™…ä»£ç ä¸­ç”¨å¾—å®ç°ç±»å«åš<code>OAuth2Connection</code>ï¼›</li><li>ConnectionFactoryï¼š<code>Connection</code>å®ƒæ˜¯ç”±è°åˆ›å»ºå‡ºæ¥çš„ï¼Ÿå®ƒæ˜¯ç”±<code>ConnectionFactory</code>è¿æ¥å·¥å‚åˆ›å»ºå‡ºæ¥çš„ï¼Œå®é™…ä¸Šè¦ç”¨åˆ°çš„ç±»å«åš<code>OAuth2ConnectionFactory</code>ï¼Œè¿™ä¸ªå·¥å‚è´Ÿè´£åˆ›å»º<code>Connection</code>å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯åŒ…å«äº†ç”¨æˆ·ä¿¡æ¯çš„å¯¹è±¡ï¼Œä¸ºäº†åˆ›å»ºè¿™ä¸ªå¯¹è±¡ï¼Œå®ƒä¸€å®šå…ˆèµ°å³è¾¹çš„æµç¨‹ï¼Œèµ°å³è¾¹æµç¨‹å°±éœ€è¦<code>ServiceProvider</code>ï¼Œæ‰€ä»¥åœ¨<code>OAuth2ConnectionFactory</code>é‡Œé¢å°±åŒ…å«ä¸€ä¸ª<code>ServiceProvider</code>å®ä¾‹çš„ï¼Œå³è¾¹è¿™å¥—ä¸œè¥¿æ˜¯è¢« å°è£…èµ·æ¥æ”¾åˆ°<code>ConnectionFactory</code>é‡Œé¢çš„ï¼Œé‚£ä¹ˆåœ¨æˆ‘ä»¬ä»£ç é‡Œä¼šè°ƒç”¨<code>ConnectionFactory</code>ï¼Œç”¨å®ƒé‡Œé¢çš„<code>ServiceProvider</code>å»èµ°å›¾1çš„å‰6æ­¥æµç¨‹ï¼Œè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œç„¶åæŠŠè¿™ä¸ªç”¨æˆ·ä¿¡æ¯å°è£…æˆ<code>Connection</code>ï¼›</li><li>ApiAdapterï¼šè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ª<code>Connection</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªå›ºå®šçš„æ•°æ®ç»“æ„ï¼Œå°±æ˜¯å®ƒçš„å­—æ®µåéƒ½æ˜¯å›ºå®šçš„ï¼Œå‰é¢è¯´äº†ï¼Œåœ¨èµ°è¿™ä¸ªæµç¨‹çš„æ—¶å€™ç¬¬6æ­¥ï¼Œè·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯å®é™…ä¸Šæ˜¯æ¯ä¸€ä¸ªæœåŠ¡æä¾›å•†å®ƒçš„å®šä¹‰éƒ½ä¸ä¸€æ ·çš„ï¼Œå¦‚ä½•æŠŠè¿™äº›ä¸ä¸€æ ·çš„æ•°æ®ç»“æ„è½¬æ¢æˆ<code>Connection</code>è¿™æ ·æ ‡å‡†çš„æ•°æ®ç»“æ„ï¼Œè¿™ä¸ªæ˜¯ç”±å«åš<code>ApiAdapter</code>ï¼Œè¿™æ ·ä¸€ä¸ªæ¥å£çš„å®ç°æ¥å®Œæˆçš„ï¼Œ<code>ApiAdapter</code>é¡¾åæ€ä¹‰å°±åœ¨å›¾ä¸Šçš„<code>Api</code>å’Œ<code>Connection</code>ä¹‹å‰åšä¸€ä¸ªé€‚é…ï¼›</li><li>UsersConnectionRepositoryï¼šåˆšåˆšè¯´<code>Connection</code>å°è£…éƒ½æ˜¯æœåŠ¡æä¾›å•†é‡Œé¢çš„ç”¨æˆ·ä¿¡æ¯ï¼Œåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡ç³»ç»Ÿé‡Œé¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¼šæŠŠä¸šåŠ¡ç³»ç»Ÿçš„ç”¨æˆ·å­˜åœ¨<code>user</code>çš„ä¸€å¼ è¡¨é‡Œé¢ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸šåŠ¡ç³»ç»Ÿé‡Œé¢çš„ç”¨æˆ·ä¿¡æ¯å¦‚ä½•å’Œæˆ‘çš„æœåŠ¡æä¾›å•†ç”¨æˆ·ä¿¡æ¯å…³è”åœ¨ä¸€èµ·å‘¢ï¼Ÿæ¢å¥è¯æ¥è¯´ï¼ŒæœåŠ¡æä¾›å•†é‡Œé¢Aç”¨æˆ·ï¼Œå®ƒè¦ç™»å½•çš„æ—¶å€™ï¼Œä½ æ€ä¹ˆçŸ¥é“å®é™…ä¸Šæ˜¯æˆ‘ä¸šåŠ¡ç³»ç»Ÿé‡Œçš„å¼ ä¸‰ç™»å½•äº†ï¼Œè¿™ä¸ªå¯¹åº”å…³ç³»æ˜¯æ€ä¹ˆå»ºç«‹çš„ï¼Ÿå®é™…ä¸Šè¿™ä¸ªå¯¹åº”å…³ç³»æ˜¯å­˜åœ¨æ•°æ®åº“é‡Œçš„ï¼Œæ•°æ®åº“é‡Œæœ‰ä¸€ä¸ªå«åš<code>UsersConnection</code>è¡¨ï¼Œè¿™å¼ è¡¨å­˜å‚¨äº†ä½ ä¸šåŠ¡ç³»ç»Ÿé‡Œçš„userè¡¨<code>user_id</code>ï¼Œå’Œä¸€ä¸ªæœåŠ¡æä¾›å•†çš„ç”¨æˆ·<code>connection</code>ä¹‹å‰çš„ä¸€ä¸ªå¯¹åº”å…³ç³»ï¼Œé‚£ä¹ˆç”±è°æ“ä½œè¿™ä¸ª<code>UsersConnection</code>è¡¨å‘¢ï¼Ÿå®ƒæ˜¯ç”±<code>UsersConnectionRepository</code>æ¥æ“ä½œçš„ï¼Œä»è¿™ä¸ªåå­—çœ‹æ¥ï¼Œå®ƒæ˜¯ä¸€ä¸ªå­˜å‚¨å™¨ï¼ŒçœŸæ­£æˆ‘ä»¬åœ¨ä»£ç é‡Œè¦åˆ°çš„å®ç°ç±»å«åš<code>JdbcUsersConnectionRepository</code>ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨å°±æ˜¯é’ˆå¯¹æ•°æ®åº“é‡Œé¢<code>UsersConnection</code>è¿™å¼ è¡¨å»åšä¸€äº›<code>CRUD</code>æ“ä½œã€‚</li></ol><hr><p>è¿™é‡Œå°±ä»‹ç»å®Œäº†ï¼Œéœ€è¦æ³¨æ„ï¼š è¿™é‡Œçš„æ¦‚å¿µéƒ½æ˜¯åœ¨å¼€å‘ä¸­æˆ‘ä»¬è‡ªå·±è¦å†™ä»£ç çš„æ—¶å€™æ¶‰åŠåˆ°çš„ä¸€äº›æ¦‚å¿µï¼Œå°±åƒä¹‹å‰è¯´çš„ç™»å½•æˆåŠŸçš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¼šå®ç°ä¸€ä¸ªæ¥å£ï¼Œå«<code>AuthenticationSuccessHandler</code>ï¼Œä¸é‚£ä¸ªæ„æ€ç±»ä¼¼ï¼Œç°åœ¨å°†çš„æ˜¯ä¸€äº›é›¶æ•£çš„æ¥å£ï¼Œæˆ‘ä»¬è¦è‡ªå·±å»å®ç°å®ƒï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½æŠŠQQç™»å½•ã€å¾®ä¿¡ç™»å½•çš„é€»è¾‘æ¶åœ¨è¿™ä¸ª<code>SpringSocial</code>ä¸Šï¼Œä½†æ˜¯å®é™…ä¸Š<code>SpringSocial</code>å·²ç»æŠŠç»å¤§éƒ¨åˆ†ç¬¬ä¸‰æ–¹ç™»å½•é€»è¾‘æ‰€éœ€è¦å®ç°çš„ä»£ç éƒ½å®ç°äº†ï¼Œæˆ‘ä»¬åœ¨è¿™åªæ˜¯ä»‹ç»äº†è·Ÿæˆ‘ä»¬è‡ªå·±è¦åšçš„äº‹æƒ…ç›¸å…³çš„ä¸€äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬æŠŠè¿™äº›ä¸œè¥¿å®ç°ä»¥åï¼Œæˆ‘ä»¬å°±èƒ½æŠŠæ•´ä¸ªæµç¨‹è·‘èµ·æ¥ï¼Œé‚£ä¹ˆæŠŠæ•´ä¸ªæµç¨‹è·‘èµ·æ¥ä»¥åï¼Œæˆ‘ä»¬åœ¨è¿›åˆ°<code>SpringSocial</code>ä»£ç é‡Œé¢è·Ÿç€æµç¨‹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¼šçœ‹åˆ°<code>SpringSocial</code>ææˆ‘ä»¬å»å®ç°ï¼Œä¸ç”¨å»ç®¡çš„é‚£äº›ä»£ç å®ƒåˆ°åº•éƒ½åšäº†ä»€ä¹ˆï¼Œäº†è§£è¿™æ˜¯çŸ¥è¯†ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹åŠ¨æ‰‹å†™ä¸€ä¸ªç¬¬3æ–¹ç™»å½•äº†ï¼Œåœ¨åŠ¨æ‰‹ä¹‹å‰æ¥çœ‹ä¸€ä¸‹<code>Spring</code>çš„<a href="https://projects.spring.io/spring-social/" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/spring-social.png" srcset="/img/loading.gif" alt=""></p><p>å®ƒè¿™é‡Œæä¾›äº†ä¸€äº›å®ç°ï¼Œå¦‚æœä½ æƒ³è¿<code>FaceBook</code>ï¼Œå°±å¼•åˆ°è‡ªå·±çš„å·¥ç¨‹ä¸­å°±OKäº†ï¼Œå®ƒæŠŠæ•´ä¸ªéœ€è¦å®ç°çš„ä¸œè¥¿éƒ½æä¾›äº†ï¼Œç›´æ¥ç”¨å°±OKäº†</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸‰ã€Social ã€‘ 1.OAuthåè®®ç®€ä»‹</title>
    <link href="/spring-security-3.1.html"/>
    <url>/spring-security-3.1.html</url>
    
    <content type="html"><![CDATA[<hr><h1 id="OAuthåè®®è§£å†³çš„é—®é¢˜"><a href="#OAuthåè®®è§£å†³çš„é—®é¢˜" class="headerlink" title="OAuthåè®®è§£å†³çš„é—®é¢˜"></a>OAuthåè®®è§£å†³çš„é—®é¢˜</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567212996187.png" srcset="/img/loading.gif" alt="1567212996187"></p><p>å¦‚æœè¦å¼€å‘ä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨è¿›è¡Œå¾®ä¿¡å›¾ç‰‡çš„æ•°æ®çš„è¯»å–ï¼Œå¹¶å°†ç…§ç‰‡è¿›è¡Œç¾åŒ–å¤„ç†ã€‚é‚£ä¹ˆè¿™é‡Œå°±ä¼šå‡ºç°å¾®ä¿¡ä¸ä¼šå°†å¾®ä¿¡çš„è´¦å·å’Œå¯†ç ç»™ç¬¬ä¸‰æ–¹åº”ç”¨çš„é—®é¢˜ã€‚</p><p>å³æ˜¯ç»™äº†ç”¨æˆ·åå’Œå¯†ç ä¹Ÿä¼šå­˜åœ¨å¾®ä¿¡è´¦å·å®‰å…¨é—®é¢˜ä»¥åŠå¾®ä¿¡åº”ç”¨çš„æƒé™é—®é¢˜ã€‚å› æ­¤OAuthåè®®å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜çš„ã€‚</p><p>å¯¹äºå¾®ä¿¡åŠ©æ‰‹æ¥è¯´é»˜è®¤çš„æƒ…å†µä¸‹å¯ä»¥æŠŠä¸ºå¾®ä¿¡æ‰€æœ‰ç”¨æˆ·ç­‰å˜æˆæ½œåœ¨ç”¨æˆ·ï¼Œæ¯”ä»0å¼€å§‹æ‰©å±•å®¢æˆ·æ•ˆç‡å’Œæˆæœ¬éƒ½è¦å¥½çš„å¤šã€‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567213462066.png" srcset="/img/loading.gif" alt="1567213462066"></p><p>é‚£ä¹ˆè¿™é‡Œå°±æœ‰ä¸€ä¸ªé—®é¢˜äº†ï¼šå¾®ä¿¡è‚¯å®šä¸ä¼šå…è®¸æˆ‘éšä¾¿å»è¯»å¾®ä¿¡çš„ç”¨æˆ·ä¿¡æ¯çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä¸€ä¸ªç”¨æˆ·çš„æˆæƒç”¨æˆ·åŒæ„æˆ‘å»è¯»å¾®ä¿¡çš„è‡ªæ‹æ•°æ®ï¼Œæœ‰äº†è¿™ä¸ªæˆæƒä»¥åå°±å¯ä»¥å‘Šè¯‰å¾®ä¿¡è¯´ç”¨æˆ·åŒæ„äº†ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¾®ä¿¡å°±ä¼šæŠŠç”¨æˆ·çš„è‡ªæ‹æ•°æ®å¼€æ”¾ç»™æˆ‘ï¼Œé‚£ä¹ˆå¦‚ä½•æ¥å¾—åˆ°ç”¨æˆ·æˆæƒå‘¢ï¼Ÿä¼ ç»Ÿçš„åšæ³•æˆ‘è·Ÿç”¨æˆ·å»è¦ç”¨æˆ·çš„å¾®ä¿¡çš„è´¦å·å’Œå¯†ç ï¼Œå…ˆä¸è¯´ç”¨æˆ·ä¼šä¸ä¼šç»™ï¼Œå°±ç®—ç”¨æˆ·æŠŠè´¦å·å’Œå¯†ç ç»™æˆ‘äº†ï¼Œæˆ‘æ‹¿ç€è¿™ä¸ªè´¦å·å’Œå¯†ç  å»å¾®ä¿¡è¯»ç”¨æˆ·çš„è‡ªæ‹æ•°æ®ä¹Ÿæ˜¯å­˜åœ¨å¾ˆå¤šé—®é¢˜çš„ï¼š</p><ol><li>åº”ç”¨å¯ä»¥è®¿é—®ç”¨æˆ·åœ¨å¾®ä¿¡ä¸Šçš„æ‰€æœ‰æ•°æ®ï¼›</li><li>ç”¨æˆ·åªæœ‰ä¿®æ”¹å¯†ç æ‰èƒ½æ”¶å›æˆæƒï¼›</li><li>å¯†ç æ³„éœ²çš„å¯èƒ½æ€§å¤§å¤§æé«˜ã€‚</li></ol><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567213713727.png" srcset="/img/loading.gif" alt="1567213713727"></p><p><code>OAuth</code>åè®®å°±æ˜¯æ¥è§£å†³ä»¥ä¸Šé—®é¢˜çš„ï¼Œå®ƒçš„ä¸»è¦æ€è·¯å°±æ˜¯ç”¨æˆ·ä¸ç”¨åœ¨æŠŠå¯†ç å‘Šè¯‰æˆ‘ï¼Œè€Œæ˜¯äº¤ç»™ä¸€ä¸ªä»¤ç‰Œï¼ˆ<code>Token</code>ï¼‰ï¼Œé‚£ä¹ˆæˆ‘å†å»è®¿é—®å¾®ä¿¡ä¸Šç”¨æˆ·çš„è‡ªæ‹æ•°æ®çš„æ—¶å€™ï¼Œæˆ‘å°±ä¸ç”¨ç”¨æˆ·çš„ç”¨æˆ·åå’Œå¯†ç äº†ï¼Œè€Œæ˜¯æ”¹æˆç”¨ç”¨æˆ·çš„ä»¤ç‰Œï¼Œé‚£ä¹ˆè¿™æ ·ä¹‹å‰å‡ ä¸ªé—®é¢˜å°±éƒ½ä¸å­˜åœ¨äº†ï¼Œç¬¬1ä¸ªé—®é¢˜ï¼šé¦–å…ˆè¿™ä¸ªä»¤ç‰Œå†™ç€ä½ åªèƒ½è®¿é—®ç”¨æˆ·çš„è‡ªæ‹æ•°æ®ï¼Œæ‰€ä»¥ä½ å°±ä¸èƒ½è®¿é—®ç”¨æˆ·åœ¨å¾®ä¿¡ä¸Šå…¶ä»–çš„æ•°æ®ï¼Œç¬¬2ä¸ªé—®é¢˜ï¼šè¿™ä¸ªä»¤ç‰Œä¸Šä¼šæœ‰ä¸€ä¸ªæœ‰æ•ˆæœŸï¼Œæ¯”å¦‚è¯´è¿™ä¸ªä»¤ç‰Œåªèƒ½ç”¨ä¸€ä¸ªæœˆï¼Œé‚£ä¹ˆä¸€ä¸ªæœˆä»¥åå°±å†ä¹Ÿä¸èƒ½è®¿é—®ç”¨æˆ·çš„è‡ªæ‹æ•°æ®äº†ï¼Œç„¶åæœ€åä¸€ä¸ªé—®é¢˜ï¼šâ€œå¯†ç æ³„éœ²çš„å¯èƒ½æ€§å¤§å¤§æé«˜â€ï¼Œè¿™é‡Œ æ ¹æœ¬ä¸éœ€è¦å¯†ç å°±ä¹Ÿè§£å†³äº†ã€‚</p><h1 id="OAuthåè®®è¿è¡Œæµç¨‹"><a href="#OAuthåè®®è¿è¡Œæµç¨‹" class="headerlink" title="OAuthåè®®è¿è¡Œæµç¨‹"></a>OAuthåè®®è¿è¡Œæµç¨‹</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567214223221.png" srcset="/img/loading.gif" alt="1567214223221"></p><p>ç›¸å…³è§’è‰²ï¼š</p><ul><li><code>Provider</code>(æœåŠ¡æä¾›å•†)ï¼šå®ƒè´Ÿè´£æä¾›ä»¤ç‰Œï¼Œåœ¨ä¹‹å‰ä¾‹å­ä¸­ï¼Œå¾®ä¿¡æ¥æä¾›è¿™ä¸ªä»¤ç‰Œï¼Œæ‰€ä»¥å¾®ä¿¡æ˜¯æœåŠ¡å™¨æä¾›å•†<code>Provider</code></li><li><code>Resource Owner</code>(èµ„æºæ‰€æœ‰è€…)ï¼šç”¨æˆ·çš„è‡ªæ‹æ•°æ®ï¼Œæ‰€æœ‰è€…ä¸ºç”¨æˆ·è‡ªå·±</li><li><code>Client</code>(ç¬¬ä¸‰æ–¹åº”ç”¨)ï¼šæ…•è¯¾å¾®ä¿¡åŠ©æ‰‹</li><li><code>Authorization Server</code>(è®¤è¯æœåŠ¡å™¨)ï¼šè®¤è¯ç”¨æˆ·èº«ä»½ï¼Œäº§ç”Ÿä»¤ç‰Œ</li><li><code>Resource Server</code>(èµ„æºæœåŠ¡å™¨)ï¼šå­˜æ”¾æ•°æ®çš„ã€‚å¹¶åœ¨è¿™é‡ŒéªŒè¯è¯·æ±‚ä¸­æºå¸¦çš„<code>Token</code>ä¿¡æ¯</li></ul><h1 id="è®¿é—®æµç¨‹"><a href="#è®¿é—®æµç¨‹" class="headerlink" title="è®¿é—®æµç¨‹"></a>è®¿é—®æµç¨‹</h1><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567214618345.png" srcset="/img/loading.gif" alt="1567214618345"></p><ol><li>ç”¨æˆ·åœ¨ä½¿ç”¨ç¬¬ä¸‰æ–¹åº”ç”¨çš„æ—¶å€™ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚ç”¨æˆ·è¿›è¡Œå¾®ä¿¡çš„æˆæƒã€‚</li><li>ç”¨æˆ·åŒæ„æˆæƒåï¼Œç¬¬ä¸‰æ–¹åº”ç”¨è¯·æ±‚å¾®ä¿¡çš„è®¤è¯æœåŠ¡å™¨ï¼Œå¹¶éªŒè¯ç”¨æˆ·æ˜¯å¦åŒæ„äº†æˆæƒï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å°±ä¼šå»è®¿é—®æœåŠ¡æä¾›å•†çš„è®¤è¯æœåŠ¡å™¨ç„¶åå‘Šè¯‰å®ƒè¯´ç”¨æˆ·åŒæ„æˆ‘æ¥è®¿é—®ç”¨æˆ·çš„è‡ªæ‹æ•°æ®äº†ï¼Œä½ ç»™æˆ‘ä¸€ä¸ªä»¤ç‰Œ</li><li>è®¤è¯æœåŠ¡å™¨ä¼šéªŒè¯ç¬¬3æ–¹åº”ç”¨è¯´çš„æ˜¯ä¸æ˜¯å®è¯ï¼Œç”¨æˆ·æ˜¯ä¸æ˜¯çœŸçš„åŒæ„ä½ æ¥è®¿é—®äº†ï¼Œå¦‚æœç¡®å®åŒæ„äº†é‚£ä¹ˆè®¤è¯æœåŠ¡å™¨å°±ä¼šå‘æ”¾ä¸€ä¸ªä»¤ç‰Œç»™ç¬¬3æ–¹åº”ç”¨</li><li>ç¬¬ä¸‰æ–¹åº”ç”¨æ‹¿åˆ°è¿™ä¸ªä»¤ç‰Œä»¥åï¼Œå®ƒå°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªä»¤ç‰Œå»è¯·æ±‚èµ„æºæœåŠ¡å™¨å»ç”³è¯·è·å–èµ„æºï¼Œèµ„æºæœåŠ¡å™¨ä¼šéªŒè¯ç”³è¯·èµ„æºè¯·æ±‚æºå¸¦çš„ä»¤ç‰Œï¼Œç¡®è®¤ä»¤ç‰Œæ— è¯¯é‚£ä¹ˆå°±ä¼šåŒæ„ç”¨æˆ·çš„èµ„æºå¼€æ”¾ç»™ç¬¬ä¸‰æ–¹åº”ç”¨</li></ol><h1 id="æˆæƒç æ¨¡å¼å…·ä½“çš„å®ç°æ­¥éª¤"><a href="#æˆæƒç æ¨¡å¼å…·ä½“çš„å®ç°æ­¥éª¤" class="headerlink" title="æˆæƒç æ¨¡å¼å…·ä½“çš„å®ç°æ­¥éª¤"></a>æˆæƒç æ¨¡å¼å…·ä½“çš„å®ç°æ­¥éª¤</h1><p>è¿™é‡Œæ ¹æ®ä¸åŒåœºæ™¯ï¼Œ<code>OAuth</code>ä¸­å®šä¹‰äº†4ç§æˆæƒæ¨¡å¼ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567214719109.png" srcset="/img/loading.gif" alt="1567214719109"></p><p>æˆæƒç æ¨¡å¼æ˜¯è¿™è¿™4ç§é‡Œé¢åŠŸèƒ½æœ€å®Œæ•´ï¼Œæµç¨‹æœ€ä¸¥å¯†çš„æˆæƒæ¨¡å¼ï¼Œä½ ç°åœ¨åœ¨äº’è”ç½‘ä¸Šèƒ½çœ‹åˆ°çš„æ‰€æœ‰æä¾›å•†ï¼Œä¸ç®¡æ˜¯å¾®åšä¹Ÿå¥½ï¼Œå¾®ä¿¡ä¹Ÿå¥½ï¼Œæ‰€æœ‰çš„æœåŠ¡æä¾›å•†å…¨éƒ½æ˜¯é‡‡ç”¨æˆæƒç æ¨¡å¼æ¥å®Œæˆæ•´ä¸ªOAuthæµç¨‹çš„ã€‚</p><p>ä¸‹é¢å°±æ¥ä»‹ç»ä¸€ä¸‹æˆæƒç æ¨¡å¼æµç¨‹ï¼š</p><ol><li>ç”¨æˆ·è®¿é—®æˆ‘ä»¬çš„å®¢æˆ·ç«¯åº”ç”¨ï¼Œå¦‚æœç¬¬ä¸‰æ–¹åº”ç”¨å®ƒéœ€è¦ç”¨æˆ·çš„æˆæƒï¼Œå®ƒä¼šå°†ç”¨æˆ·å¯¼å‘ è®¤è¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆç”¨æˆ·åŒæ„æˆæƒçš„åŠ¨ä½œä¼šåœ¨è®¤è¯æœåŠ¡å™¨ä¸Šæ¥å®Œæˆï¼›</li><li>å¦‚æœç”¨æˆ·åŒæ„æˆæƒï¼Œé‚£ä¹ˆè®¤è¯æœåŠ¡å™¨ä¼šå°†ç”¨æˆ·é‡æ–°å¯¼å›åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨ä¸Šå»ï¼Œå¯¼å›å»çš„æ—¶å€™ï¼Œå¯¼å›åˆ°ç¬¬ä¸‰æ–¹åº”ç”¨çš„å“ªä¸ªåœ°å€ä¸Šè¿™ä¸ªæ˜¯ç”±ç¬¬ä¸‰æ–¹åº”ç”¨å’Œè®¤è¯æœåŠ¡å™¨äº‹å…ˆå•†é‡å¥½çš„ï¼Œé‚£ä¹ˆå®ƒå°†ç”¨æˆ·å¯¼å›äº‹å…ˆå•†é‡å¥½çš„<code>URL</code>ä¸Šçš„åŒæ—¶ï¼Œå®ƒä¼šæºå¸¦ä¸€ä¸ªæˆæƒç ï¼Œæ³¨æ„ï¼šè¿™é‡Œä¸æ˜¯è¿”å›æˆ‘ä»¬è¦çš„ä»¤ç‰Œï¼Œä¸æ˜¯<code>token</code>ï¼Œè€Œæ˜¯æˆæƒç ï¼›</li><li>å®¢æˆ·ç«¯åœ¨æ”¶åˆ°è¿™ä¸ªæˆæƒç ä»¥åï¼Œå®ƒä¼šæ‹¿ç€è¿™ä¸ªæˆæƒç å‘è®¤è¯æœåŠ¡å™¨å»ç”³è¯·ä»¤ç‰Œï¼Œè¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯åç«¯çš„æœåŠ¡å™¨å»å®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·æ˜¯ä¸å¯è§çš„</li><li>è®¤è¯æœåŠ¡å™¨ä¼šå¯¹ç”³è¯·ä»¤ç‰Œè¿™ä¸ªè¯·æ±‚ä¸­æºå¸¦çš„æˆæƒç è¿›è¡ŒéªŒè¯çœ‹æ˜¯ä¸æ˜¯å®ƒä¹‹å‰å‘ç»™å®¢æˆ·ç«¯çš„ï¼Œå¦‚æœæ˜¯ï¼šé‚£ä¹ˆå®ƒä¼šå‘å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè®¿é—®ä»¤ç‰Œï¼ˆ<code>Token</code>ï¼‰</li></ol><p>è¿™é‡Œçš„å°±æ˜¯æˆæƒç æ¨¡å¼çš„ä¸»è¦æµç¨‹ï¼Œä¸ºä»€ä¹ˆå«æˆæƒç æ¨¡å¼ï¼Œå› ä¸ºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿä¸€ä¸ªæˆæƒç ï¼Œåœ¨å…¶ä»–æ¨¡å¼é‡Œæ˜¯æ²¡æœ‰è¿™ä¸ªæˆæƒç çš„ï¼Œæ‰€ä»¥å«æˆæƒç æ¨¡å¼ï¼Œè¿™ä¸ªæ¨¡å¼æœ‰2ä¸ªä¸»è¦çš„ç‰¹ç‚¹ï¼š</p><ol><li>ç”¨æˆ·åŒæ„è¿™ä¸ªæˆæƒçš„åŠ¨ä½œæ˜¯åœ¨è®¤è¯æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå…¶ä»–æˆæƒæ¨¡å¼é‡Œé¢ï¼Œå¯†ç æ¨¡å¼å’Œå®¢æˆ·ç«¯æ¨¡å¼è¿™ä¸ªåŒæ„æˆæƒéƒ½æ˜¯åœ¨ç¬¬ä¸‰æ–¹åº”ç”¨å®Œæˆçš„ï¼Œå®Œæˆä»¥åï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å»å‘è®¤è¯æœåŠ¡å™¨ä¸­å¸¦ç€ä¸€å †ä¿¡æ¯è¯´ç”¨æˆ·æˆæƒç»™æˆ‘äº†ï¼ŒåŒæ„æˆ‘æ¥è®¿é—®ï¼Œè¿™ä¸ªæ—¶å€™è®¤è¯æœåŠ¡å™¨æ²¡æ³•ç¡®å®šç”¨æˆ·æ˜¯ä¸æ˜¯çœŸçš„æˆæƒäº†ï¼Œæœ‰å¯èƒ½è¿™ä¸ªä¿¡æ¯æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ä¼ªé€ çš„ï¼Œè¿™é‡Œåœ¨æˆæƒç æ¨¡å¼é‡ŒåŒæ„æˆæƒè¿™ä¸ªåŠ¨ä½œæ˜¯åœ¨è®¤è¯æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œæ‰€ä»¥è®¤è¯æœåŠ¡å™¨å¯ä»¥æ˜ç¡®çš„çŸ¥é“ç”¨æˆ·ç¡®å®åŒæ„äº†æˆæƒï¼›</li><li>åœ¨ç”¨æˆ·åŒæ„æˆæƒçš„æ—¶å€™ï¼Œä»è®¤è¯æœåŠ¡å™¨è®¿é—®ç¬¬ä¸‰æ–¹çš„æ—¶å€™ï¼Œå®ƒæºå¸¦çš„å¹¶ä¸æ˜¯ä»¤ç‰Œï¼Œè€Œæ˜¯ä¸€ä¸ªæˆæƒç ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨åœ¨æ¥åˆ°è¿™ä¸ªæˆæƒç ä»¥åè¦ä»ç¬¬ä¸‰æ–¹åº”ç”¨çš„æœåŠ¡å™¨å†å‘ä¸€ä¸ªè¯·æ±‚ç»™è®¤è¯æœåŠ¡å™¨ï¼Œæ‹¿ç€è¿™ä¸ªæˆæƒç å»æ¢ä»¤ç‰Œï¼Œåœ¨è¿™ä¸ªæ¨¡å¼ä¸‹é¢ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæœåŠ¡å™¨ï¼Œé‚£ä¹ˆæœ‰äº›ç½‘ç«™å®ƒå¯èƒ½å°±æ˜¯ä¸€ä¸ªé™æ€ç½‘ç«™å®ƒåªæœ‰é¡µé¢ï¼Œå®ƒæ²¡æœ‰æœåŠ¡å™¨ï¼Œé‚£ä¹ˆè¿™ç§ç½‘ç«™å°±ä¼šä½¿ç”¨4ç§æ¨¡å¼çš„ç¬¬2ç§ï¼šç®€åŒ–æ¨¡å¼ï¼Œåœ¨ç®€åŒ–æ¨¡å¼é‡Œé¢ä»è®¤è¯æœåŠ¡å™¨è¿”å›ç¬¬ä¸‰æ–¹åº”ç”¨çš„æ—¶å€™ï¼Œç›´æ¥å¸¦çš„å°±æ˜¯ä»¤ç‰Œï¼Œå› ä¸ºè¿™ç§æ¨¡å¼ä¸‹ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å®ƒæ²¡æœ‰æœåŠ¡å™¨ï¼Œé‚£ä¹ˆåªèƒ½è¿”å›åˆ°é¡µé¢ä¸Šï¼Œç„¶ååœ¨é¡µé¢ä¸Šç”¨è„šæœ¬å»è¯»å–è¿”å›çš„ä»¤ç‰Œï¼›</li></ol>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äºŒã€Form ã€‘  2.è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯é€»è¾‘</title>
    <link href="/spring-security-2.2.html"/>
    <url>/spring-security-2.2.html</url>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰é€šè¿‡userå’Œæ§åˆ¶å°ä¸Šçš„å¯†ç è¿›è¡Œç™»å½•ï¼Œåœ¨å®é™…å¼€å‘è‚¯å®šä¸ä¼šè¿™ä¹ˆåšç™»å½•ï¼Œè¿™é‡Œç¬”è€…ä¼šå¸¦ç€è¯»è€…æ¥å®ç°å®é™…çš„ç™»å½•åŠŸèƒ½</p><hr><h1 id="ä¸ªæ€§åŒ–ç™»å½•é¡µ"><a href="#ä¸ªæ€§åŒ–ç™»å½•é¡µ" class="headerlink" title="ä¸ªæ€§åŒ–ç™»å½•é¡µ"></a>ä¸ªæ€§åŒ–ç™»å½•é¡µ</h1><p>é¦–å…ˆè‡ªå·±åˆ›å»ºä¸€ä¸ªç™»å½•é¡µé¢ï¼Œ<code>browser#resources/resources/mcr-login.html</code></p><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>ç™»å½•é¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ç™»å½•é¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/authentication/form"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>è´¦å·<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>å¯†ç <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span></code></pre><p>å‘Šè¯‰<code>spring security</code>ç™»å½•é¡µé¢çš„ä½ç½®ï¼Œå½“ç”¨æˆ·æ²¡åšç™»å½•æ—¶ï¼Œå°±ä¼šè·³è½¬åˆ°è¿™é‡Œ</p><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http                 .formLogin()+                .loginPage(<span class="hljs-string">"/mcr-login.html"</span>)...    &#125;</code></pre><p>ä¹‹å‰çœ‹æºç çš„æ—¶å€™ï¼Œ<code>UsernamePasswordAuthenticationFilter</code>ï¼Œå®ƒåªå¤„ç†<code>/login</code>çš„<code>postè¯·æ±‚</code>ï¼Œæ‰€ä»¥è¿˜éœ€è¦é…ç½®ä¸€ä¸‹ï¼Œå‘Šè¯‰<code>UsernamePasswordAuthenticationFilter</code>å»å¤„ç†æˆ‘ä»¬ç¼–å†™çš„å…¶ä»–è·¯å¾„ï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;     http             .formLogin()            .loginProcessingUrl(<span class="hljs-string">"/authentication/form"</span>)       ... &#125;</code></pre><p>å¯åŠ¨ï¼Œè®¿é—®ï¼š<a href="http://localhost:8080/user.html" target="_blank" rel="noopener">http://localhost:8080/user.html</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566906164555.png" srcset="/img/loading.gif" alt="1566906164555"></p><p>è¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿâ€”â€”å› ä¸ºç°åœ¨<code>spring security</code>è·³è½¬çš„åˆ°äº†<code>mcr-login.html</code>ï¼Œè€Œå®ƒä¹Ÿæ˜¯å—ä¿æŠ¤çš„ï¼Œæ‰€ä»¥ä¼šç»§ç»­è·³è½¬ï¼Œè€Œè·³è½¬çš„é¡µé¢æ˜¯<code>mcr-login.html</code>ï¼Œè¿™æ ·å°±ä¼šå‡ºç°å¤šæ¬¡è·³è½¬çš„æƒ…å†µ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566906354466.png" srcset="/img/loading.gif" alt="1566906354466"></p><p> <code>mcr-login.html</code>ä¸éœ€è¦ä¿æŠ¤</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;     http             .formLogin()       ...             .and()             .authorizeRequests()         â†“å…³é”®ä»£ç              .antMatchers(<span class="hljs-string">"/mcr-login.html"</span>)             .permitAll()             .anyRequest().authenticated(); &#125;</code></pre><p>ç°åœ¨è‡ªå®šä¹‰çš„é¡µé¢æ˜¯å‡ºæ¥äº†ï¼Œè¿›è¡Œç™»å½•æ—¶ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566907097168.png" srcset="/img/loading.gif" alt="1566907097168"></p><p>è¿™æ˜¯å› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>spring security</code>æä¾›äº†è·¨åŸŸè¯·æ±‚çš„é˜²æŠ¤ï¼Œè¿™é‡Œéœ€è¦å…³é—­é˜²æŠ¤</p><pre><code class="hljs java"><span class="hljs-meta">@Override</span>   <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;       http        ...               .authorizeRequests()...           â†“å…³é”®ä»£ç                .and()               .csrf()               .disable();   &#125;</code></pre><h1 id="è‡ªå®šä¹‰è®¤è¯é€»è¾‘"><a href="#è‡ªå®šä¹‰è®¤è¯é€»è¾‘" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯é€»è¾‘"></a>è‡ªå®šä¹‰è®¤è¯é€»è¾‘</h1><p>ä¹‹å‰é€šè¿‡è´¦å·ï¼šuserï¼Œå¯†ç ï¼šæ§åˆ¶å°ä¸Šçš„ï¼Œæ¥è®¤è¯é€šè¿‡ï¼Œå®é™…å¼€å‘ä¸ä¼šè¿™æ ·å§ï¼Ÿè¿™é‡Œå°±æ¥å¸¦ç€ç¬”è€…æ¥å®ç°è‡ªå®šä¹‰è®¤è¯é€»è¾‘</p><hr><p>åœ¨è¿™ä¹‹å‰ï¼Œå…ˆæ¥ä»‹ç»ä¸€ä¸‹<code>UserDetailsService</code>ï¼Œå®ƒæ˜¯ä¸“é—¨è´Ÿè´£å¤„ç†è®¤è¯çš„ï¼Œè¿™é‡Œçš„<code>username</code>å‚æ•°æ˜¯ç”¨æˆ·åœ¨è¡¨å•ä¸­è¾“å…¥çš„è´¦å·ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è´¦å·å»æ•°æ®åº“ä¸­æ‹¿å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè¿”å›ç»™<code>spring security</code>ï¼Œ<code>spring security</code>å°±ä¼šæ‹¿ç€è¿™ä¸ªä¿¡æ¯å»å’Œè¡¨å•è¾“å…¥çš„è´¦å·å¯†ç å»åšå¤„ç†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.security.core.userdetails;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;<span class="hljs-function">UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException</span>;&#125;</code></pre><p>ç¼–å†™ä¸€ä¸ªç±»å®ç°<code>UserDetailsService</code>æ¥å£ï¼Œå‡å¦‚æ‰€æœ‰è´¦å·çš„å¯†ç éƒ½æ˜¯123</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.security.service;<span class="hljs-meta">@Service</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;        log.info(<span class="hljs-string">"ç”¨æˆ·-&gt;&#123;&#125;è¿›è¡Œäº†ç™»å½•"</span>, username);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username, <span class="hljs-string">"123"</span>, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));    &#125;&#125;</code></pre><p>è¿™é‡Œè¿”å›çš„UserDetailsç±»å‹ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯å®ƒè‡ªå¸¦çš„Userç±»ï¼Œåœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥è‡ªå·±åˆ›å»ºä¸€ä¸ªUserç±»å®ç°æ¥å£ï¼Œè¿™ä¸ªæ¥å£åŒ…å«æ–¹æ³•ï¼š</p><ul><li>getAuthoritiesï¼šæƒé™ä¿¡æ¯</li><li>getPasswordï¼šå¯†ç </li><li>getUsernameï¼šè´¦å·</li><li>isAccountNonExpiredï¼šè´¦æˆ·æ˜¯å¦è¿‡æœŸï¼štrueï¼ˆå¦ï¼‰ï¼Œfalseï¼ˆæ˜¯ï¼‰</li><li>isAccountNonLockedï¼šè´¦æˆ·æ˜¯å¦é”å®š</li><li>isCredentialsNonExpiredï¼šå¯†ç æ˜¯å¦è¿‡æœŸ</li><li>isEnabledï¼šè´¦å·æ˜¯å¦å¯ç”¨</li></ul><p>ä»æ•°æ®åº“ä¸­è¯»å–çš„å¯†ç ä¸ä¼šæ˜¯123ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹åŠ å¯†å™¨æ¥æ¨¡æ‹Ÿä¸€ä¸‹ç”¨æˆ·å¯†ç æ˜¯åŠ å¯†çš„ï¼Œè¿™ä¸ªä¸€èˆ¬æ˜¯ç”¨åˆ°æ³¨å†Œä½¿ç”¨çš„</p><p><code>PasswordEncoder</code>å°±æ˜¯åŠ å¯†å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">PasswordEncoder</span> </span>&#123;Â    <span class="hljs-comment">//åŠ å¯†</span>    <span class="hljs-function">String <span class="hljs-title">encode</span><span class="hljs-params">(CharSequence var1)</span></span>;    <span class="hljs-comment">//éªŒè¯æ˜¯å¦åŒ¹é…</span>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(CharSequence var1, String var2)</span></span>;&#125;</code></pre><p>å°†åŠ å¯†å™¨æ³¨å…¥åˆ°IOCå®¹å™¨ä¸­</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> PasswordEncoder <span class="hljs-title">passwordEncoder</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BCryptPasswordEncoder();    &#125;</code></pre><p>McrUserDetailsServiceï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Service</span><span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrUserDetailsService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsService</span> </span>&#123;    <span class="hljs-meta">@Resource</span>+    <span class="hljs-keyword">private</span> PasswordEncoder passwordEncoder;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> UserDetails <span class="hljs-title">loadUserByUsername</span><span class="hljs-params">(String username)</span> <span class="hljs-keyword">throws</span> UsernameNotFoundException </span>&#123;+        String pwd = passwordEncoder.encode(<span class="hljs-string">"123"</span>);        log.info(<span class="hljs-string">"ç”¨æˆ·-&gt;&#123;&#125;è¿›è¡Œäº†ç™»å½•ï¼Œå®ƒçš„å¯†ç æ˜¯-&gt;&#123;&#125;"</span>, username, pwd);+        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(username, pwd, AuthorityUtils.commaSeparatedStringToAuthorityList(<span class="hljs-string">"admin"</span>));    &#125;&#125;</code></pre><h1 id="å¤„ç†ä¸åŒè¯·æ±‚"><a href="#å¤„ç†ä¸åŒè¯·æ±‚" class="headerlink" title="å¤„ç†ä¸åŒè¯·æ±‚"></a>å¤„ç†ä¸åŒè¯·æ±‚</h1><p>è¿™é‡Œå®ç°ä»¥ä¸‹å›¾ä¸­çš„åŠŸèƒ½ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566914744512.png" srcset="/img/loading.gif" alt="1566914744512"></p><p>å¯¹å“åº”æç¤ºä¿¡æ¯è¿›è¡Œå°è£…</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.model.vo;<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrSecurityVO</span> </span>&#123;    <span class="hljs-keyword">private</span> Object content;&#125;</code></pre><p>controller:</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/authentication"</span>)<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityController</span> </span>&#123;    <span class="hljs-keyword">private</span> RequestCache requestCache = <span class="hljs-keyword">new</span> HttpSessionRequestCache();    <span class="hljs-keyword">private</span> RedirectStrategy redirectStrategy = <span class="hljs-keyword">new</span> DefaultRedirectStrategy();    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/require"</span>)    <span class="hljs-meta">@ResponseStatus</span>(HttpStatus.UNAUTHORIZED)    <span class="hljs-function"><span class="hljs-keyword">public</span> McrSecurityVO <span class="hljs-title">requireAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        SavedRequest savedRequest = requestCache.getRequest(request, response);        <span class="hljs-keyword">if</span> (savedRequest != <span class="hljs-keyword">null</span>) &#123;            String targetUrl = savedRequest.getRedirectUrl();            log.info(<span class="hljs-string">"å¼•å‘è·³è½¬çš„è¯·æ±‚-&gt;&#123;&#125;"</span>, targetUrl);            <span class="hljs-keyword">if</span> (StringUtils.endsWithIgnoreCase(targetUrl, <span class="hljs-string">".html"</span>)) &#123;                redirectStrategy.sendRedirect(request, response, <span class="hljs-string">"/mcr-login.html"</span>);            &#125;        &#125;        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> McrSecurityVO(<span class="hljs-string">"è¯·å¼•å¯¼ç”¨æˆ·è·³è½¬åˆ°ç™»å½•é¡µé¢"</span>);    &#125;&#125;</code></pre><p>ä¿®æ”¹é…ç½®ï¼Œè·³è½¬åˆ°<code>/authentication/require</code></p><pre><code class="hljs java"> <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http                .formLogin()+               .loginPage(<span class="hljs-string">"/authentication/require"</span>)                .loginProcessingUrl(<span class="hljs-string">"/authentication/form"</span>)                .and()                .authorizeRequests()+               .antMatchers(<span class="hljs-string">"/mcr-login.html"</span>, <span class="hljs-string">"/authentication/require"</span>)                .permitAll()                .anyRequest().authenticated()                .and()                .csrf()                .disable();    &#125;</code></pre><h1 id="ç™»å½•æˆåŠŸå’Œç™»å½•å¤±è´¥çš„å“åº”"><a href="#ç™»å½•æˆåŠŸå’Œç™»å½•å¤±è´¥çš„å“åº”" class="headerlink" title="ç™»å½•æˆåŠŸå’Œç™»å½•å¤±è´¥çš„å“åº”"></a>ç™»å½•æˆåŠŸå’Œç™»å½•å¤±è´¥çš„å“åº”</h1><ul><li>å¤„ç†æˆåŠŸå“åº”ï¼šAuthenticationSuccessHandler</li><li>å¤„ç†å¤±è´¥å“åº”ï¼šAuthenticationFailureHandler</li></ul><p>è¿™2ä¸ªç±»éƒ½æ˜¯æ¥å£ç±»ï¼Œä½¿ç”¨å®ƒä»¬éœ€è¦å®ç°è¿™2ä¸ªæ¥å£</p><p>æˆåŠŸå¤„ç†ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.authentication;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationSuccessHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);        response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(authentication)));    &#125;&#125;</code></pre><p>å¤±è´¥å¤„ç†ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.authentication;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationFailureHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationFailureHandler</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);        response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(exception.getMessage())));    &#125;&#125;</code></pre><p>é…ç½®ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http                   .formLogin()+                   .successHandler(authenticationSuccessHandler)+                  .failureHandler(authenticationFailureHandler)                   .loginPage(<span class="hljs-string">"/authentication/require"</span>)                   .loginProcessingUrl(<span class="hljs-string">"/authentication/form"</span>)               ...    &#125;&#125;</code></pre><h1 id="è®¤è¯æµç¨‹æºç è¯¦æƒ…"><a href="#è®¤è¯æµç¨‹æºç è¯¦æƒ…" class="headerlink" title="è®¤è¯æµç¨‹æºç è¯¦æƒ…"></a>è®¤è¯æµç¨‹æºç è¯¦æƒ…</h1><p>æµç¨‹å›¾ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566918955707.png" srcset="/img/loading.gif" alt="1566918955707"></p><ul><li><p>UsernamePasswordAuthenticationFilter:è¡¨å•ç”¨æˆ·åç™»é™†è¿‡æ»¤å™¨</p></li><li><p>AuthenticationManagerï¼šç®¡ç†æ‰€æœ‰çš„Providerï¼Œå¹¶é€‰æ‹©é€‚åˆçš„è¿›è¡ŒéªŒè¯</p></li><li><p>AuthenticationProviderï¼šéªŒè¯æä¾›è€…ï¼Œå¯ä»¥è‡ªå·±å†™providerå¤„ç†è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯é€»è¾‘</p></li><li><p>UserDetailsServiceï¼šéªŒè¯ç”¨æˆ·ç™»é™†ä¿¡æ¯</p></li><li><p>UserDetails:ç”¨æˆ·ä¿¡æ¯</p></li><li><p>Authentication:è®¤è¯ä¿¡æ¯å°è£…</p><hr></li></ul><p>UsernamePasswordAuthenticationFilter :</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566919161314.png" srcset="/img/loading.gif" alt="1566919161314"></p><p>é€šè¿‡ç”¨æˆ·å¡«å†™çš„è¡¨å•ä¿¡æ¯å°è£…æˆUsernamePasswordAuthenticationToken  </p><p>UsernamePasswordAuthenticationToken  ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566919277796.png" srcset="/img/loading.gif" alt="1566919277796"></p><p>è¿™é‡Œå®ƒé¦–å…ˆè°ƒç”¨äº†è‡ªå·±çš„çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œä¼ é€’äº†ä¸€ä¸ªnull</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566919334433.png" srcset="/img/loading.gif" alt="1566919334433"></p><p>è¿™ä¸ªå®é™…ä¸Šå°±æ˜¯åˆšåˆšè®²çš„UserDetailsä¸­çš„æƒé™ä¿¡æ¯ï¼Œç”±äºç°åœ¨è¿˜åœ¨åšè®¤è¯å¤„ç†ï¼Œæ²¡ç¡®å®šç”¨æˆ·çš„è´¦å·å’Œå¯†ç æ˜¯å¦æ­£ç¡®ï¼Œæ‰€ä»¥è¿™é‡Œè¿˜æ²¡æœ‰ç»™å®šæƒé™ä¿¡æ¯ï¼Œæ¥ç€å®ƒå°†è´¦å·å’Œå¯†ç èµ‹ç»™è‡ªå·±çš„æœ¬åœ°å˜é‡ä¸Šï¼Œæœ€åçš„ï¼š<code>setAuthenticated(false);</code>è¿™ä¸ªæ–¹æ³•çš„æ„æ€æ˜¯å½“å‰ç”¨æˆ·ä¿¡æ¯æ˜¯å¦ç»è¿‡äº†èº«ä»½è®¤è¯ï¼Œè¿™é‡Œè¿˜åœ¨è®¤è¯ï¼Œæ‰€ä»¥ä¼ false</p><hr><p>å›åˆ°<code>UsernamePasswordAuthenticationFilter#attemptAuthentication</code>æ–¹æ³•ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œå®ƒç„¶åæ‰§è¡Œäº†è¿™ä¹ˆä¸€æ®µä»£ç ï¼Œä¼ é€’äº†requestå’Œå‰é¢çš„<code>UsernamePasswordAuthenticationToken</code>å¯¹è±¡</p><pre><code class="hljs java">setDetails(request, authRequest);</code></pre><hr><p>è¿™é‡Œçš„<code>setDetails</code>æ–¹æ³•ä¸­è°ƒç”¨äº†å‚æ•°<code>authRequest</code>çš„<code>setDetails</code>æ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDetails</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">UsernamePasswordAuthenticationToken authRequest)</span> </span>&#123;authRequest.setDetails(authenticationDetailsSource.buildDetails(request));&#125;</code></pre><p>æ¥çœ‹çœ‹<code>authenticationDetailsSource.buildDetails(request)</code>æ˜¯çš„è¿”å›ç»“æ„</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566919792395.png" srcset="/img/loading.gif" alt="1566919792395"></p><p>è¿™é‡Œå°±æ˜¯å°†ipåœ°å€å’Œ<code>sessionId</code>è®¾ç½®ç»™<code>UsernamePasswordAuthenticationToken</code>å¯¹è±¡</p><hr><p>å›åˆ°<code>UsernamePasswordAuthenticationFilter</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566919884046.png" srcset="/img/loading.gif" alt="1566919884046"></p><p>è¿™é‡Œå°†tokenäº¤ç»™äº†<code>AuthenticationManager</code></p><hr><p><code>ProviderManager#authenticate</code>,è¿™é‡Œçš„<code>ProviderManager</code>ï¼Œå®ç°äº†<code>AuthenticationManager</code>æ¥å£ï¼Œå®é™…ä¸Šç”¨å¾—æ˜¯å®ƒ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566920015141.png" srcset="/img/loading.gif" alt="1566920015141"></p><p>è¿™é‡Œå®ƒä¼šæ‹¿å–æ‰€æœ‰çš„<code>AuthenticationProvider</code>æ¥è¿›è¡Œéå†ï¼Œè°ƒç”¨æ¯ä¸ª<code>AuthenticationProvider</code>çš„<code>supports</code>æ–¹æ³•å¹¶ä¼ é€’<code>token</code>ï¼Œè¿™é‡Œçš„<code>supports</code>æ–¹æ³•ä¼šæ ¹æ®<code>token</code>ï¼ŒæŸ¥çœ‹è‡ªå·±æ˜¯å¦å¯¹è¿™ä¸ª<code>token</code>æ”¯æŒè®¤è¯ï¼Œå¦‚æœæ”¯æŒå°±ä¼šè°ƒç”¨è‡ªå·±çš„<code>authenticate</code>æ–¹æ³•ï¼Œå°†<code>token</code>ä¼ é€’è¿›å»</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566920224819.png" srcset="/img/loading.gif" alt="1566920224819"></p><p>æ¥çœ‹ä¸‹<code>AuthenticationProvider#authenticate</code>ï¼Œå®ƒçš„<code>authenticate</code>æ–¹æ³•å±äºå®ƒçš„çˆ¶ç±»çš„</p><p><code>AbstractUserDetailsAuthenticationProvider#authenticate</code></p><pre><code class="hljs java">UserDetails user = <span class="hljs-keyword">this</span>.userCache.getUserFromCache(username);<span class="hljs-keyword">if</span> (user == <span class="hljs-keyword">null</span>) &#123;cacheWasUsed = <span class="hljs-keyword">false</span>;<span class="hljs-keyword">try</span> &#123;user = retrieveUser(username,(UsernamePasswordAuthenticationToken) authentication);&#125;<span class="hljs-keyword">catch</span> (UsernameNotFoundException notFound) &#123;logger.debug(<span class="hljs-string">"User '"</span> + username + <span class="hljs-string">"' not found"</span>);<span class="hljs-keyword">if</span> (hideUserNotFoundExceptions) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,<span class="hljs-string">"Bad credentials"</span>));&#125;<span class="hljs-keyword">else</span> &#123;<span class="hljs-keyword">throw</span> notFound;&#125;&#125;</code></pre><p>è¿™é‡Œå®ƒé¦–å…ˆä¼šé€šè¿‡ç”¨æˆ·çš„è´¦å·ä»ç¼“å­˜ä¸­æ‹¿ï¼Œå¦‚æœæ‹¿ä¸åˆ°å°±è°ƒç”¨<code>retrieveUser</code>æ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> UserDetails <span class="hljs-title">retrieveUser</span><span class="hljs-params">(String username,</span></span><span class="hljs-function"><span class="hljs-params">UsernamePasswordAuthenticationToken authentication)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;UserDetails loadedUser;<span class="hljs-keyword">try</span> &#123;loadedUser = <span class="hljs-keyword">this</span>.getUserDetailsService().loadUserByUsername(username);&#125;&#125;</code></pre><p>åœ¨è¿™é‡Œè¿™ä¸€æ®µ            <code>loadedUser = this.getUserDetailsService().loadUserByUsername(username);</code>å®é™…ä¸Šè°ƒç”¨çš„å°±æ˜¯æˆ‘ä¹‹å‰ç¼–å†™çš„<code>McrUserDetailsService#loadUserByUsername</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566920666268.png" srcset="/img/loading.gif" alt="1566920666268"></p><p>å›åˆ°<code>AbstractUserDetailsAuthenticationProvider#authenticate</code></p><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;preAuthenticationChecks.check(user);additionalAuthenticationChecks(user,(UsernamePasswordAuthenticationToken) authentication);&#125;<span class="hljs-keyword">catch</span> (AuthenticationException exception) &#123;<span class="hljs-comment">//..</span>&#125;<span class="hljs-comment">//...</span><span class="hljs-keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user);</code></pre><p>preAuthenticationChecks.checkï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultPreAuthenticationChecks</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsChecker</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span><span class="hljs-params">(UserDetails user)</span> </span>&#123;<span class="hljs-keyword">if</span> (!user.isAccountNonLocked()) &#123;logger.debug(<span class="hljs-string">"User account is locked"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> LockedException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.locked"</span>,<span class="hljs-string">"User account is locked"</span>));&#125;<span class="hljs-keyword">if</span> (!user.isEnabled()) &#123;logger.debug(<span class="hljs-string">"User account is disabled"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> DisabledException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.disabled"</span>,<span class="hljs-string">"User is disabled"</span>));&#125;<span class="hljs-keyword">if</span> (!user.isAccountNonExpired()) &#123;logger.debug(<span class="hljs-string">"User account is expired"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AccountExpiredException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.expired"</span>,<span class="hljs-string">"User account has expired"</span>));&#125;&#125;&#125;</code></pre><p>æ£€æŸ¥ç”¨æˆ·æ˜¯å¦é”å®šã€ç”¨æˆ·è´¦å·æ˜¯å¦å¯åŠ¨ã€ç”¨æˆ·è´¦å·æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå‡ºç°ä¸€ä¸ªå°±ä¼šæŠ›å‡ºå¯¹åº”çš„å¼‚å¸¸</p><hr><p>additionalAuthenticationChecksï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">additionalAuthenticationChecks</span><span class="hljs-params">(UserDetails userDetails,</span></span><span class="hljs-function"><span class="hljs-params">UsernamePasswordAuthenticationToken authentication)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;Object salt = <span class="hljs-keyword">null</span>;<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.saltSource != <span class="hljs-keyword">null</span>) &#123;salt = <span class="hljs-keyword">this</span>.saltSource.getSalt(userDetails);&#125;<span class="hljs-keyword">if</span> (authentication.getCredentials() == <span class="hljs-keyword">null</span>) &#123;logger.debug(<span class="hljs-string">"Authentication failed: no credentials provided"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,<span class="hljs-string">"Bad credentials"</span>));&#125;String presentedPassword = authentication.getCredentials().toString();<span class="hljs-keyword">if</span> (!passwordEncoder.isPasswordValid(userDetails.getPassword(),presentedPassword, salt)) &#123;logger.debug(<span class="hljs-string">"Authentication failed: password does not match stored value"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BadCredentialsException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.badCredentials"</span>,<span class="hljs-string">"Bad credentials"</span>));&#125;&#125;</code></pre><p>è¿™é‡Œé€šè¿‡passwordEncoderåŠ å¯†è§£å¯†å™¨å»æ ¡éªŒå½“å‰å¯†ç æ˜¯å¦åŒ¹é…ï¼Œä¸åŒ¹é…çš„è¯å°±æŠ›å‡ºå¼‚å¸¸</p><hr><p>postAuthenticationChecks.checkï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultPostAuthenticationChecks</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserDetailsChecker</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">check</span><span class="hljs-params">(UserDetails user)</span> </span>&#123;<span class="hljs-keyword">if</span> (!user.isCredentialsNonExpired()) &#123;logger.debug(<span class="hljs-string">"User account credentials have expired"</span>);<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> CredentialsExpiredException(messages.getMessage(<span class="hljs-string">"AbstractUserDetailsAuthenticationProvider.credentialsExpired"</span>,<span class="hljs-string">"User credentials have expired"</span>));&#125;&#125;&#125;</code></pre><hr><p>åœ¨é‡Œæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œå°±è®¤ä¸ºç”¨æˆ· è®¤è¯æ˜¯æˆåŠŸçš„ï¼Œç”¨æˆ·è®¤è¯æˆåŠŸçš„æ—¶å€™ä¼šè¿”å›ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">return</span> createSuccessAuthentication(principalToReturn, authentication, user)</code></pre><p>createSuccessAuthentication:</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Authentication <span class="hljs-title">createSuccessAuthentication</span><span class="hljs-params">(Object principal,</span></span><span class="hljs-function"><span class="hljs-params">Authentication authentication, UserDetails user)</span> </span>&#123;UsernamePasswordAuthenticationToken result = <span class="hljs-keyword">new</span> UsernamePasswordAuthenticationToken(principal, authentication.getCredentials(),authoritiesMapper.mapAuthorities(user.getAuthorities()));result.setDetails(authentication.getDetails());<span class="hljs-keyword">return</span> result;&#125;</code></pre><p>è¿™é‡Œå°±ä¼šæ‹¿ä¹‹å‰çš„tokenï¼Œé‡æ–°å®ä¾‹åŒ–ä¸€ä¸ªtokenï¼Œå¹¶æŠŠæƒé™ä¿¡æ¯è®¾ç½®ä¸Šå»ï¼Œå®ƒåœ¨è¿™æ¬¡è°ƒç”¨çš„å¦å¤–ä¸€ä¸ªæ„é€ æ–¹æ³•,è°ƒç”¨setAuthenticatedä¼ é€’trueï¼Œè¡¨ç¤ºè¿™ä¸ªè´¦å·ä¿¡æ¯å·²ç»è®¤è¯é€šè¿‡äº†</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UsernamePasswordAuthenticationToken</span><span class="hljs-params">(Object principal, Object credentials,</span></span><span class="hljs-function"><span class="hljs-params">Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;<span class="hljs-keyword">super</span>(authorities);<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">this</span>.credentials = credentials;<span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// must use super, as we override</span>&#125;</code></pre><p>åˆ°è¿™é‡Œï¼Œ<code>UsernamePasswordAuthenticationFilter#attemptAuthentication</code>å°±èµ°å®Œäº†ï¼Œå®é™…ä¸Šè°ƒç”¨<code>UsernamePasswordAuthenticationFilter#attemptAuthentication</code>çš„æ˜¯<code>AbstractAuthenticationProcessingFilter#doFilter</code>ï¼Œè¿™é‡Œå®ƒåšäº†ä¸€ç³»åˆ—çš„åˆ¤æ–­ï¼Œå¦‚æœéƒ½æ²¡é—®é¢˜ï¼Œåˆ™ä¼šè°ƒç”¨<code>successfulAuthentication</code>æ–¹æ³•ï¼Œå¦‚æœæœ‰é—®é¢˜ï¼Œ<code>UsernamePasswordAuthenticationFilter#attemptAuthentication</code>æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™è¿™é‡Œé¢å°±è¡Œäº†æ•è·å°±ä¼šè°ƒç”¨<code>unsuccessfulAuthentication</code>æ–¹æ³•</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest req, ServletResponse res, FilterChain chain)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;HttpServletRequest request = (HttpServletRequest) req;HttpServletResponse response = (HttpServletResponse) res;<span class="hljs-keyword">if</span> (!requiresAuthentication(request, response)) &#123;chain.doFilter(request, response);<span class="hljs-keyword">return</span>;&#125;<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;logger.debug(<span class="hljs-string">"Request is to process authentication"</span>);&#125;Authentication authResult;<span class="hljs-keyword">try</span> &#123;authResult = attemptAuthentication(request, response);<span class="hljs-keyword">if</span> (authResult == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-comment">// return immediately as subclass has indicated that it hasn't completed</span><span class="hljs-comment">// authentication</span><span class="hljs-keyword">return</span>;&#125;sessionStrategy.onAuthentication(authResult, request, response);&#125;<span class="hljs-keyword">catch</span> (InternalAuthenticationServiceException failed) &#123;logger.error(<span class="hljs-string">"An internal error occurred while trying to authenticate the user."</span>,failed);unsuccessfulAuthentication(request, response, failed);<span class="hljs-keyword">return</span>;&#125;<span class="hljs-keyword">catch</span> (AuthenticationException failed) &#123;<span class="hljs-comment">// Authentication failed</span>unsuccessfulAuthentication(request, response, failed);<span class="hljs-keyword">return</span>;&#125;<span class="hljs-comment">// Authentication success</span><span class="hljs-keyword">if</span> (continueChainBeforeSuccessfulAuthentication) &#123;chain.doFilter(request, response);&#125;successfulAuthentication(request, response, chain, authResult);&#125;</code></pre><p>successfulAuthenticationï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">successfulAuthentication</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">HttpServletResponse response, FilterChain chain, Authentication authResult)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;logger.debug(<span class="hljs-string">"Authentication success. Updating SecurityContextHolder to contain: "</span>+ authResult);&#125;SecurityContextHolder.getContext().setAuthentication(authResult);rememberMeServices.loginSuccess(request, response, authResult);<span class="hljs-comment">// Fire event</span><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.eventPublisher != <span class="hljs-keyword">null</span>) &#123;eventPublisher.publishEvent(<span class="hljs-keyword">new</span> InteractiveAuthenticationSuccessEvent(authResult, <span class="hljs-keyword">this</span>.getClass()));&#125;successHandler.onAuthenticationSuccess(request, response, authResult);&#125;</code></pre><ul><li><code>successHandler.onAuthenticationSuccess(request, response, authResult);</code>:è°ƒç”¨ä¹‹å‰ç¼–å†™çš„ç™»å½•æˆåŠŸå¤„ç†å™¨McrAuthenticationSuccessHandler#onAuthenticationSuccessï¼›</li><li><code>SecurityContextHolder.getContext().setAuthentication(authResult);</code>ï¼šå°†ç”¨æˆ·ä¿¡æ¯å­˜å‚¨åœ¨sesisonä¸­</li></ul><p>SecurityContextHolder.getContext().setAuthentication(authResult)ï¼š</p><p>è¿™é‡Œçš„SecurityContextHolder.getContext()è¿”å›ä¸€ä¸ªSecurityContextç±»ï¼ŒSecurityContextç±»çš„å®ç°ç±»æ˜¯SecurityContextImplï¼Œè°ƒç”¨çš„æ˜¯å®ƒçš„setAuthenticationæ–¹æ³•</p><blockquote><p>è¿™é‡Œçš„SecurityContextHolderçœ‹äº†åŠå¤©æ²¡åŠæ³•è¡¨è¾¾ï¼Œä»¥åå†è¡¥ä¸Š</p></blockquote><hr><p>unsuccessfulAuthenticationï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">unsuccessfulAuthentication</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">HttpServletResponse response, AuthenticationException failed)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;SecurityContextHolder.clearContext();<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) &#123;logger.debug(<span class="hljs-string">"Authentication request failed: "</span> + failed.toString(), failed);logger.debug(<span class="hljs-string">"Updated SecurityContextHolder to contain null Authentication"</span>);logger.debug(<span class="hljs-string">"Delegating to authentication failure handler "</span> + failureHandler);&#125;rememberMeServices.loginFail(request, response);failureHandler.onAuthenticationFailure(request, response, failed);&#125;</code></pre><p>è¿™é‡Œå°±æ˜¯è°ƒç”¨ä¹‹å‰ç¼–å†™çš„å¤±è´¥å¤„ç†å™¨McrAuthenticationFailureHandler</p><h1 id="è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯"><a href="#è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯"></a>è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</h1><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentUser</span><span class="hljs-params">()</span> </span>&#123;       <span class="hljs-keyword">return</span> SecurityContextHolder.getContext().getAuthentication();   &#125;<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me/2"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentUser</span><span class="hljs-params">(Authentication authentication)</span> </span>&#123;       <span class="hljs-keyword">return</span> authentication;   &#125;<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/me/v3"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCurrentUser</span><span class="hljs-params">(@AuthenticationPrincipal UserDetails authentication)</span> </span>&#123;       <span class="hljs-keyword">return</span> authentication;   &#125;</code></pre><hr><h1 id="å›¾å½¢éªŒè¯ç ç™»å½•"><a href="#å›¾å½¢éªŒè¯ç ç™»å½•" class="headerlink" title="å›¾å½¢éªŒè¯ç ç™»å½•"></a>å›¾å½¢éªŒè¯ç ç™»å½•</h1><h2 id="ç”Ÿæˆå›¾å½¢éªŒè¯ç "><a href="#ç”Ÿæˆå›¾å½¢éªŒè¯ç " class="headerlink" title="ç”Ÿæˆå›¾å½¢éªŒè¯ç "></a>ç”Ÿæˆå›¾å½¢éªŒè¯ç </h2><p>å°†å›¾ç‰‡éªŒè¯ç éœ€è¦çš„ä¿¡æ¯å°è£…æˆä¸€ä¸ªç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.model.dto;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> java.awt.image.BufferedImage;<span class="hljs-keyword">import</span> java.time.LocalDateTime;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCodeDTO</span> </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å›¾ç‰‡</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> BufferedImage image;<span class="hljs-comment">/**</span><span class="hljs-comment"> * éšæœºæ•°</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> String code;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è¿‡æœŸæ—¶é—´</span><span class="hljs-comment"> */</span><span class="hljs-keyword">private</span> LocalDateTime expireTime;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageCodeDTO</span><span class="hljs-params">(BufferedImage image, String code, <span class="hljs-keyword">int</span> expireIn)</span></span>&#123;<span class="hljs-keyword">this</span>.image = image;<span class="hljs-keyword">this</span>.code = code;<span class="hljs-comment">//å¤šå°‘ç§’å</span><span class="hljs-keyword">this</span>.expireTime = LocalDateTime.now().plusSeconds(expireIn);&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageCodeDTO</span><span class="hljs-params">(BufferedImage image, String code, LocalDateTime expireTime)</span></span>&#123;<span class="hljs-keyword">this</span>.image = image;<span class="hljs-keyword">this</span>.code = code;<span class="hljs-keyword">this</span>.expireTime = expireTime;&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isExpired</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> LocalDateTime.now().isAfter(expireTime);&#125;&#125;</code></pre><p>è·å–å›¾å½¢éªŒè¯ç çš„è¯·æ±‚</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/code"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeController</span> </span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SESSION_KEY = <span class="hljs-string">"SESSION_KEY_CODE"</span>;    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/image"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">imageCreateCode</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        <span class="hljs-comment">//1ï¼šæ ¹æ®éšæœºæ•°ç”Ÿæˆå›¾ç‰‡</span>        ImageCodeDTO imageCodeDTO = generate(<span class="hljs-keyword">new</span> ServletWebRequest(request));        <span class="hljs-comment">//2ï¼šå°†å›¾ç‰‡æ”¾å…¥sessionä¸­</span>        sessionStrategy.setAttribute(<span class="hljs-keyword">new</span> ServletWebRequest(request), SESSION_KEY + <span class="hljs-string">"/image"</span>, imageCodeDTO);        <span class="hljs-comment">//3ï¼šå°†ç”Ÿæˆçš„å›¾ç‰‡å†™å…¥æ¥å£çš„å“åº”ä¸­</span>        ImageIO.write(imageCodeDTO.getImage(), <span class="hljs-string">"JPEG"</span>, response.getOutputStream());    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> ImageCodeDTO <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        <span class="hljs-keyword">int</span> width = <span class="hljs-number">67</span>;        <span class="hljs-keyword">int</span> height = <span class="hljs-number">23</span>;        BufferedImage image = <span class="hljs-keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);        Graphics g = image.getGraphics();        Random random = <span class="hljs-keyword">new</span> Random();        g.setColor(getRandColor(<span class="hljs-number">200</span>, <span class="hljs-number">250</span>));        g.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);        g.setFont(<span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Times New Roman"</span>, Font.ITALIC, <span class="hljs-number">20</span>));        g.setColor(getRandColor(<span class="hljs-number">160</span>, <span class="hljs-number">200</span>));        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">155</span>; i++) &#123;            <span class="hljs-keyword">int</span> x = random.nextInt(width);            <span class="hljs-keyword">int</span> y = random.nextInt(height);            <span class="hljs-keyword">int</span> xl = random.nextInt(<span class="hljs-number">12</span>);            <span class="hljs-keyword">int</span> yl = random.nextInt(<span class="hljs-number">12</span>);            g.drawLine(x, y, x + xl, y + yl);        &#125;        String sRand = <span class="hljs-string">""</span>;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++) &#123;            String rand = String.valueOf(random.nextInt(<span class="hljs-number">10</span>));            sRand += rand;            g.setColor(<span class="hljs-keyword">new</span> Color(<span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>), <span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>), <span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>)));            g.drawString(rand, <span class="hljs-number">13</span> * i + <span class="hljs-number">6</span>, <span class="hljs-number">16</span>);        &#125;        g.dispose();        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ImageCodeDTO(image, sRand, <span class="hljs-number">60</span>);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”ŸæˆéšæœºèƒŒæ™¯æ¡çº¹</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fc</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bc</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> Color <span class="hljs-title">getRandColor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fc, <span class="hljs-keyword">int</span> bc)</span> </span>&#123;        Random random = <span class="hljs-keyword">new</span> Random();        <span class="hljs-keyword">if</span> (fc &gt; <span class="hljs-number">255</span>) &#123;            fc = <span class="hljs-number">255</span>;        &#125;        <span class="hljs-keyword">if</span> (bc &gt; <span class="hljs-number">255</span>) &#123;            bc = <span class="hljs-number">255</span>;        &#125;        <span class="hljs-keyword">int</span> r = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">int</span> g = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">int</span> b = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Color(r, g, b);    &#125;&#125;</code></pre><p>è®©è¿™ä¸ªè¯·æ±‚ä¸éœ€è¦æ ¡éªŒ</p><pre><code class="hljs java">.antMatchers(....                      <span class="hljs-string">"/code/**"</span></code></pre><p>åœ¨ç™»å½•é¡µé¢ä¸­åŠ å…¥ï¼š</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>å›¾å½¢éªŒè¯ç :<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"imageCode"</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/code/image"</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span></code></pre><h2 id="å›¾å½¢éªŒè¯ç éªŒè¯"><a href="#å›¾å½¢éªŒè¯ç éªŒè¯" class="headerlink" title="å›¾å½¢éªŒè¯ç éªŒè¯"></a>å›¾å½¢éªŒè¯ç éªŒè¯</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566723514793.png" srcset="/img/loading.gif" alt=""></p><p>å›¾å½¢éªŒè¯ç æ˜¯æ¯”ç”¨æˆ·çš„è´¦å·å¯†ç å…ˆæ•ˆéªŒçš„ï¼Œæ‰€ä»¥æˆ‘ä¼šåœ¨<code>UsernamePasswordAuthenticationFilter</code>å‰é¢åŠ ä¸€ä¸ªéªŒè¯ç”¨æˆ·å¡«çš„éªŒè¯ç æ˜¯å¦æ­£ç¡®çš„è¿‡æ»¤å™¨ï¼Œå¦‚æœéªŒè¯ä¸é€šè¿‡å°±æŠ›å‡ºå¼‚å¸¸ï¼Œè¿™é‡Œçš„å¼‚å¸¸æˆ‘å¸Œæœ›å¯ä»¥è®©<code>spring security</code>æ•è·ï¼Œå¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ªç±»ç»§æ‰¿<code>AuthenticationException</code> ï¼Œæˆ–è€…ç›´æ¥æŠ›å‡º<code>AuthenticationException</code> çš„å¼‚å¸¸ï¼Œè¿™é‡Œæˆ‘å°±è‡ªå®šä¹‰ä¸€ä¸ª</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AuthenticationException</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">7285211528095468156L</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ValidateCodeException</span><span class="hljs-params">(String msg)</span> </span>&#123;        <span class="hljs-keyword">super</span>(msg);    &#125;&#125;</code></pre><hr><p>è¿‡æ»¤å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageValidateCodeFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        <span class="hljs-keyword">if</span> (StringUtils.equals(<span class="hljs-string">"/authentication/form"</span>, request.getRequestURI())                &amp;&amp; StringUtils.equalsIgnoreCase(request.getMethod(), <span class="hljs-string">"post"</span>)) &#123;            <span class="hljs-keyword">try</span> &#123;                validate(<span class="hljs-keyword">new</span> ServletWebRequest(request));            &#125; <span class="hljs-keyword">catch</span> (ValidateCodeException e) &#123;                authenticationFailureHandler.onAuthenticationFailure(request, response, e);                <span class="hljs-comment">//å‡ºç°å¼‚å¸¸ä¸ç»§ç»­æ‰§è¡Œ</span>                <span class="hljs-keyword">return</span>;            &#125;        &#125;        filterChain.doFilter(request, response);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> ServletRequestBindingException </span>&#123;        ImageCodeDTO codeInSession = (ImageCodeDTO) sessionStrategy.getAttribute(request,                ValidateCodeController.SESSION_KEY + <span class="hljs-string">"/image"</span>);        String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), <span class="hljs-string">"imageCode"</span>);        <span class="hljs-keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç çš„å€¼ä¸èƒ½ä¸ºç©º"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession.isExpired()) &#123;            sessionStrategy.removeAttribute(request, ValidateCodeController.SESSION_KEY);            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç å·²è¿‡æœŸ"</span>);        &#125;        <span class="hljs-keyword">if</span> (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸åŒ¹é…"</span>);        &#125;        sessionStrategy.removeAttribute(request, ValidateCodeController.SESSION_KEY);    &#125;&#125;</code></pre><hr><p>å°†å›¾å½¢éªŒè¯ç è¿‡æ»¤æ·»åŠ åˆ°<code>UsernamePasswordAuthenticationFilter</code>çš„å‰é¢ï¼š</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;    ImageValidateCodeFilter imageValidateCodeFilter = <span class="hljs-keyword">new</span> ImageValidateCodeFilter();    imageValidateCodeFilter.setAuthenticationFailureHandler(authenticationFailureHandler);    http            .addFilterBefore(imageValidateCodeFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"> //...</span><span class="hljs-class"></span><span class="hljs-class">&#125;</span></code></pre><h1 id="æ‰‹æœºç™»å½•"><a href="#æ‰‹æœºç™»å½•" class="headerlink" title="æ‰‹æœºç™»å½•"></a>æ‰‹æœºç™»å½•</h1><h2 id="ç”ŸæˆçŸ­ä¿¡éªŒè¯ç "><a href="#ç”ŸæˆçŸ­ä¿¡éªŒè¯ç " class="headerlink" title="ç”ŸæˆçŸ­ä¿¡éªŒè¯ç "></a>ç”ŸæˆçŸ­ä¿¡éªŒè¯ç </h2><p>å’Œä¸Šé¢çš„å›¾å½¢éªŒè¯ç å·®ä¸å¤šï¼Œä¸å¤šåºŸè¯ç›´æ¥ä¸Šä»£ç </p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.model.dto;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> java.time.LocalDateTime;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeDTO</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯ç </span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> String code;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å¤±æ•ˆæ—¶é—´ </span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> LocalDateTime expireTime;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeDTO</span><span class="hljs-params">(String code, <span class="hljs-keyword">int</span> expireAfterSeconds)</span> </span>&#123;        <span class="hljs-keyword">this</span>.code = code;        <span class="hljs-comment">//å¤šå°‘ç§’å</span>        <span class="hljs-keyword">this</span>.expireTime = LocalDateTime.now().plusSeconds(expireAfterSeconds);    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeDTO</span><span class="hljs-params">(String code, LocalDateTime expireTime)</span> </span>&#123;        <span class="hljs-keyword">this</span>.code = code;        <span class="hljs-keyword">this</span>.expireTime = expireTime;    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ˜¯å¦å¤±æ•ˆ</span><span class="hljs-comment">     *</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isExpired</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> LocalDateTime.now().isAfter(expireTime);    &#125;&#125;</code></pre><hr><p>ValidateCodeController</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/sms"</span>)  <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">createSmsCode</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> </span>&#123;      String code = String.valueOf(RandomUtils.nextInt(<span class="hljs-number">9999</span>));      SmsCodeDTO smsCodeDTO = <span class="hljs-keyword">new</span> SmsCodeDTO(code, <span class="hljs-number">60</span>);      sessionStrategy.setAttribute(<span class="hljs-keyword">new</span> ServletWebRequest(request, response), SESSION_KEY + <span class="hljs-string">"/sms"</span>, smsCodeDTO);      <span class="hljs-keyword">return</span> code;  &#125;</code></pre><hr><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">hr</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>çŸ­ä¿¡ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/authentication/mobile"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>æ‰‹æœºå·:<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mobile"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"13012345678"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>çŸ­ä¿¡éªŒè¯ç :<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"smsCode"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/code/sms?mobile=13012345678"</span>&gt;</span>å‘é€éªŒè¯ç <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre><h2 id="æ‰‹æœºç™»å½•éªŒè¯"><a href="#æ‰‹æœºç™»å½•éªŒè¯" class="headerlink" title="æ‰‹æœºç™»å½•éªŒè¯"></a>æ‰‹æœºç™»å½•éªŒè¯</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567003728157.png" srcset="/img/loading.gif" alt="1567003728157"></p><p>æ‰‹æœºç™»å½•ï¼Œ1æ˜¯æ‰‹æœºå·ç ï¼Œ2æ˜¯æ‰‹æœºæ”¶åˆ°çš„éªŒè¯ç ï¼Œè¿™é‡Œçš„éªŒè¯ä¸å‰é¢çš„å›¾å½¢éªŒè¯ç éªŒè¯æ˜¯ä¸åŒçš„ï¼Œå®ƒä¸èƒ½é€šè¿‡<code>UsernamePasswordAuthenticationFilter</code>å»åšéªŒè¯ï¼Œåœ¨è¿™é‡Œå°±éœ€è¦è‡ªå·±è‡ªå®šä¹‰ä¸€ä¸ª<code>AtuehtncationFilter</code>ï¼Œç„¶åè¿˜éœ€è¦ä¸€ä¸ªåšéªŒè¯çš„<code>Provider</code>ä¹Ÿæ˜¯éœ€è¦è‡ªå·±æ¥åšçš„ï¼Œè¯»è€…ä¸ç”¨æ‹…å¿ƒå¾ˆå¤æ‚ï¼Œç¬”è€…è¿™é‡Œæ˜¯é€šè¿‡å¤åˆ¶è¿™äº›æºç ï¼Œæ¥è¿›è¡Œä¿®æ”¹å®Œæˆçš„ï¼Œå®é™…ä¸Šä¸ä¼šå¤ªéš¾</p><hr><p>SmsCodeAuthenticationTokenï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authentication.mobile;<span class="hljs-keyword">import</span> org.springframework.security.authentication.AbstractAuthenticationToken;<span class="hljs-keyword">import</span> org.springframework.security.core.GrantedAuthority;<span class="hljs-keyword">import</span> org.springframework.security.core.SpringSecurityCoreVersion;<span class="hljs-keyword">import</span> java.util.Collection;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeAuthenticationToken</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractAuthenticationToken</span> </span>&#123; <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID; <span class="hljs-comment">// ~ Instance fields</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object principal;<span class="hljs-comment">//å­˜æ”¾è®¤è¯ä¿¡æ¯ã€‚</span> <span class="hljs-comment">// ~ Constructors</span><span class="hljs-comment">/**</span><span class="hljs-comment"> * è®¤è¯ä¹‹å‰å­˜æ”¾æ‰‹æœºå·</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeAuthenticationToken</span><span class="hljs-params">(Object mobile)</span> </span>&#123;<span class="hljs-keyword">super</span>(<span class="hljs-keyword">null</span>);<span class="hljs-keyword">this</span>.principal = mobile;setAuthenticated(<span class="hljs-keyword">false</span>);&#125; <span class="hljs-comment">/**</span><span class="hljs-comment"> * è®¤è¯æˆåŠŸå­˜æ”¾ç”¨æˆ·</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeAuthenticationToken</span><span class="hljs-params">(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;<span class="hljs-keyword">super</span>(authorities);<span class="hljs-keyword">this</span>.principal = principal;<span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">true</span>); <span class="hljs-comment">// must use super, as we override</span>&#125; <span class="hljs-comment">// ~ Methods</span><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getPrincipal</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.principal;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAuthenticated</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> isAuthenticated)</span> <span class="hljs-keyword">throws</span> IllegalArgumentException </span>&#123;<span class="hljs-keyword">if</span> (isAuthenticated) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);&#125; <span class="hljs-keyword">super</span>.setAuthenticated(<span class="hljs-keyword">false</span>);&#125; <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eraseCredentials</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">super</span>.eraseCredentials();&#125; <span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getCredentials</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-comment">// TODO Auto-generated method stub</span><span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;&#125;&#125;</code></pre><p>SmsCodeAuthenticationFilterï¼š</p><blockquote><p>å®é™…ä¸Šä¸UsernamePasswordAuthenticationFilteråšçš„äº‹æƒ…æ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡å®ƒè¿™é‡Œæ‹¿çš„æ˜¯ç”¨æˆ·å¡«å†™çš„æ‰‹æœºå·ç å°è£…æˆSmsCodeAuthenticationToken</p></blockquote><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authentication.mobile;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeAuthenticationFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractAuthenticationProcessingFilter</span> </span>&#123;<span class="hljs-comment">//è¯·æ±‚ä¸­æºå¸¦çš„å‚æ•°å</span><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String IMOOC_FORM_MOBILE_KEY = <span class="hljs-string">"mobile"</span>;<span class="hljs-keyword">private</span> String mobileParameter = IMOOC_FORM_MOBILE_KEY;<span class="hljs-comment">// è¯·æ±‚ä¸­æºå¸¦å‚æ•°çš„åå­—æ˜¯ä»€ä¹ˆ</span><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> postOnly = <span class="hljs-keyword">true</span>;<span class="hljs-comment">//æ˜¯å¦ä»…å¤„ç†postè¯·æ±‚</span><span class="hljs-comment">// ~ Constructors</span><span class="hljs-comment">//å¤„ç†çš„çŸ­ä¿¡ç™»å½•çš„è¯·æ±‚æ˜¯ä»€ä¹ˆ</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeAuthenticationFilter</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> AntPathRequestMatcher(<span class="hljs-string">"/authentication/mobile"</span>, <span class="hljs-string">"POST"</span>));&#125;<span class="hljs-comment">// ~ Methods</span><span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">attemptAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;<span class="hljs-keyword">if</span> (postOnly &amp;&amp; !request.getMethod().equals(<span class="hljs-string">"POST"</span>)) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> AuthenticationServiceException(<span class="hljs-string">"Authentication method not supported: "</span> + request.getMethod());&#125;String mobile = obtainMobile(request);<span class="hljs-keyword">if</span> (mobile == <span class="hljs-keyword">null</span>) &#123;mobile = <span class="hljs-string">""</span>;&#125;mobile = mobile.trim();SmsCodeAuthenticationToken authRequest = <span class="hljs-keyword">new</span> SmsCodeAuthenticationToken(mobile);<span class="hljs-comment">// å°†è¯·æ±‚çš„ä¿¡æ¯è®¾ç½®åœ¨Tokenä¸­</span>setDetails(request, authRequest);<span class="hljs-comment">//æ‹¿ç€Tokenè°ƒç”¨AuthenticationManager</span><span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.getAuthenticationManager().authenticate(authRequest);&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * è·å–è¯·æ±‚å‚æ•°ä¸­çš„æ‰‹æœºå·</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span></span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">protected</span> String <span class="hljs-title">obtainMobile</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;<span class="hljs-keyword">return</span> request.getParameter(mobileParameter);&#125; <span class="hljs-comment">/**</span><span class="hljs-comment"> * å°†è¯·æ±‚çš„ä¿¡æ¯è®¾ç½®åœ¨Tokenä¸­</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> request</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> authRequest</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDetails</span><span class="hljs-params">(HttpServletRequest request, SmsCodeAuthenticationToken authRequest)</span> </span>&#123;authRequest.setDetails(authenticationDetailsSource.buildDetails(request));&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setMobileParameter</span><span class="hljs-params">(String mobileParameter)</span> </span>&#123;Assert.hasText(mobileParameter, <span class="hljs-string">"Mobile parameter must not be empty or null"</span>);<span class="hljs-keyword">this</span>.mobileParameter = mobileParameter;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPostOnly</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> postOnly)</span> </span>&#123;<span class="hljs-keyword">this</span>.postOnly = postOnly;&#125; <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> String <span class="hljs-title">getMobileParameter</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> mobileParameter;&#125;&#125;</code></pre><p>SmsCodeAuthenticationProviderï¼š</p><blockquote><p>ç”¨äºéªŒè¯SmsCodeAuthenticationToken</p></blockquote><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authentication.mobile;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeAuthenticationProvider</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationProvider</span> </span>&#123;<span class="hljs-meta">@Setter</span><span class="hljs-meta">@Getter</span><span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<span class="hljs-comment">/**</span><span class="hljs-comment"> * èº«ä»½è®¤è¯çš„é€»è¾‘</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> Authentication <span class="hljs-title">authenticate</span><span class="hljs-params">(Authentication authentication)</span> <span class="hljs-keyword">throws</span> AuthenticationException </span>&#123;SmsCodeAuthenticationToken smsCodeAuthenticationToken = (SmsCodeAuthenticationToken)authentication;UserDetails user = userDetailsService.loadUserByUsername((String) smsCodeAuthenticationToken.getPrincipal());<span class="hljs-keyword">if</span>(user == <span class="hljs-keyword">null</span>)&#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InternalAuthenticationServiceException(<span class="hljs-string">"æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯"</span>);&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * 1:ç”¨æˆ·è®¤è¯ä¿¡æ¯</span><span class="hljs-comment"> * 2ï¼šç”¨æˆ·æƒé™</span><span class="hljs-comment"> */</span>SmsCodeAuthenticationToken authenticationResult = <span class="hljs-keyword">new</span> SmsCodeAuthenticationToken(user, user.getAuthorities());<span class="hljs-comment">//å°†ä¹‹å‰æœªè®¤è¯çš„è¯·æ±‚æ”¾è¿›è®¤è¯åçš„Tokenä¸­</span>authenticationResult.setDetails(smsCodeAuthenticationToken);<span class="hljs-keyword">return</span> authenticationResult;&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * AuthenticationManagerå¸¦ç€Tokenè°ƒç”¨Provider</span><span class="hljs-comment"> * åˆ¤æ–­ä¼ è¿›æ¥çš„Tokenæœ€ç»ˆè°ƒç”¨çš„æ˜¯å“ªä¸ªProvider</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supports</span><span class="hljs-params">(Class&lt;?&gt; authentication)</span> </span>&#123;<span class="hljs-keyword">return</span> SmsCodeAuthenticationToken<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">isAssignableFrom</span>(<span class="hljs-title">authentication</span>)</span>;&#125;&#125;</code></pre><p>ImageValidateCodeFilterï¼š</p><blockquote><p>è¿™é‡Œçš„SmsValidateCodeFilter å’ŒImageValidateCodeFilteré€»è¾‘ä¸€æ ·</p></blockquote><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.sms;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.SmsCodeDTO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeController;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.validate.code.ValidateCodeException;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.HttpSessionSessionStrategy;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.SessionStrategy;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestBindingException;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestUtils;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;<span class="hljs-keyword">import</span> javax.servlet.FilterChain;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsValidateCodeFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        <span class="hljs-keyword">if</span> (request.getRequestURI().equals(<span class="hljs-string">"/authentication/mobile"</span>)                &amp;&amp; StringUtils.equalsIgnoreCase(request.getMethod(), <span class="hljs-string">"post"</span>)) &#123;            <span class="hljs-keyword">try</span> &#123;                validate(<span class="hljs-keyword">new</span> ServletWebRequest(request));            &#125; <span class="hljs-keyword">catch</span> (ValidateCodeException e) &#123;                authenticationFailureHandler.onAuthenticationFailure(request, response, e);                <span class="hljs-keyword">return</span>;            &#125;        &#125;        filterChain.doFilter(request, response);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> ServletRequestBindingException </span>&#123;        String key = ValidateCodeController.SESSION_KEY + <span class="hljs-string">"/sms"</span>;        SmsCodeDTO smsCodeDTO = (SmsCodeDTO) sessionStrategy.getAttribute(request,                key);        String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), <span class="hljs-string">"smsCode"</span>);        <span class="hljs-keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç çš„å€¼ä¸èƒ½ä¸ºç©º"</span>);        &#125;        <span class="hljs-keyword">if</span> (smsCodeDTO == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-keyword">if</span> (smsCodeDTO.isExpired()) &#123;            sessionStrategy.removeAttribute(request, key);            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç å·²è¿‡æœŸ"</span>);        &#125;        <span class="hljs-keyword">if</span> (!StringUtils.equals(smsCodeDTO.getCode(), codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸åŒ¹é…"</span>);        &#125;        sessionStrategy.removeAttribute(request, key);    &#125;&#125;</code></pre><p>ç°åœ¨å¯ä»¥å°†è¿™äº›ç±»é…ç½®åˆ°browseræ¨¡å—é‡Œï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä»¥åè¿˜æœ‰å¯¹appæ¨¡å—è¿›è¡Œcodeæ—¶ï¼Œå¸Œæœ›appæ¨¡å—ä¸­ä¹Ÿæä¾›æ‰‹æœºç™»å½•çš„åŠŸèƒ½ï¼Œé‚£åˆå¾—åœ¨appæ¨¡å—ä¸­è¿›è¡Œé…ç½®ï¼Œè¿™é‡Œå¯ä»¥å°†è¿™ä¸ªé…ç½®æŠ½è±¡èµ·æ¥ï¼Œé€šè¿‡ç»§æ‰¿<code>SecurityConfigurerAdapter</code>ç±»ï¼Œç„¶åå°†é…ç½®å†™åœ¨é‡Œé¢ï¼Œbrowserå’Œappæ¨¡å—åªéœ€è¦å¼•å…¥è¿™ä¸ªé…ç½®å°±å¯ä»¥äº†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.authentication.mobile;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.security.authentication.AuthenticationManager;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.SecurityConfigurerAdapter;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;<span class="hljs-keyword">import</span> org.springframework.security.web.DefaultSecurityFilterChain;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.AuthenticationFailureHandler;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.AuthenticationSuccessHandler;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeAuthenticationSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SecurityConfigurerAdapter</span>&lt;<span class="hljs-title">DefaultSecurityFilterChain</span>, <span class="hljs-title">HttpSecurity</span>&gt; </span>&#123;<span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;<span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;<span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> UserDetailsService userDetailsService;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;SmsCodeAuthenticationFilter smsCodeAuthenticationFilter = <span class="hljs-keyword">new</span> SmsCodeAuthenticationFilter();smsCodeAuthenticationFilter.setAuthenticationManager(http.getSharedObject(AuthenticationManager<span class="hljs-class">.<span class="hljs-keyword">class</span>))</span>;smsCodeAuthenticationFilter.setAuthenticationSuccessHandler(authenticationSuccessHandler);smsCodeAuthenticationFilter.setAuthenticationFailureHandler(authenticationFailureHandler);SmsCodeAuthenticationProvider smsCodeAuthenticationProvider = <span class="hljs-keyword">new</span> SmsCodeAuthenticationProvider();smsCodeAuthenticationProvider.setUserDetailsService(userDetailsService);http.authenticationProvider(smsCodeAuthenticationProvider).addFilterAfter(smsCodeAuthenticationFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span>;&#125;&#125;</code></pre><p>åœ¨SmsCodeAuthenticationSecurityConfigä¸­å°†<code>SmsValidateCodeFilter</code>è¿›è¡Œé…ç½®ï¼Œå¹¶å¼•å…¥SmsCodeAuthenticationSecurityConfigé…ç½®</p><p>SmsCodeAuthenticationSecurityConfig#configure</p><pre><code class="hljs java"><span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> SmsCodeAuthenticationSecurityConfig smsCodeAuthenticationSecurityConfig;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        SmsValidateCodeFilter smsValidateCodeFilter = <span class="hljs-keyword">new</span> SmsValidateCodeFilter();        smsValidateCodeFilter.setAuthenticationFailureHandler(authenticationFailureHandler);        http.apply(smsCodeAuthenticationSecurityConfig)                .and()                .addFilterBefore(smsValidateCodeFilter, UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span></code></pre><h1 id="é‡æ„ä»£ç "><a href="#é‡æ„ä»£ç " class="headerlink" title="é‡æ„ä»£ç "></a>é‡æ„ä»£ç </h1><p>è¿™é‡Œçš„é‡æ„ä»£ç ï¼Œä¸»è¦æ˜¯å°†ä¸€äº›å›ºå®šçš„å€¼ä½¿ymlã€propertieså¯é…ç½®ï¼Œæ¯”å¦‚è¯´ä¹‹å‰åšçš„è‡ªå®šä¹‰ç™»å½•é¡µé¢ï¼Œåœ¨åˆ«äººæ‹¿åˆ°æˆ‘ä»¬çš„ä»£ç åŠ å…¥ä»–çš„å·¥ç¨‹æ—¶ï¼Œä»–ç¼–å†™çš„ç™»å½•é¡µé¢è·¯å¾„å’Œåç§°å¿…é¡»æ˜¯å›ºå®šçš„ï¼Œä»–åœ¨å¼€å‘æ—¶å¯èƒ½å¹¶æ²¡æœ‰ä½¿ç”¨å‰åç«¯åˆ†ç¦»ï¼Œç™»å½•å¤±è´¥æ—¶ï¼Œåªæƒ³è·³å›ç™»å½•é¡µé¢ï¼Œä¸å¸Œæœ›æ˜¯è¿”å›ä¸€æ®µjosnâ€¦ï¼Œæˆ‘ä»¬å°±æ¥å®ç°è¿™äº›åŠŸèƒ½</p><h2 id="ç™»å½•é¡µé¢è·¯å¾„"><a href="#ç™»å½•é¡µé¢è·¯å¾„" class="headerlink" title="ç™»å½•é¡µé¢è·¯å¾„"></a>ç™»å½•é¡µé¢è·¯å¾„</h2><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityProperties</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç™»å½•é¡µè·¯å¾„</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> String loginUrl = <span class="hljs-string">"/mcr-login.html"</span>;&#125;</code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@ConfigurationProperties</span>(prefix = <span class="hljs-string">"mcr.b4.security"</span>)<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityProperties</span> </span>&#123;    <span class="hljs-keyword">private</span> BrowserSecurityProperties browser = <span class="hljs-keyword">new</span> BrowserSecurityProperties();&#125;</code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core; <span class="hljs-meta">@Configuration</span><span class="hljs-meta">@EnableConfigurationProperties</span>(SecurityProperties<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">class</span> <span class="hljs-title">SecurityCoreConfig</span> </span>&#123;&#125;</code></pre><p>com.b4.mcr.auth.browser.BrowserSecurityController#requireAuthenticationï¼š</p><pre><code class="hljs java">    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> SecurityProperties security; <span class="hljs-function"><span class="hljs-keyword">public</span> McrSecurityVO <span class="hljs-title">requireAuthentication</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;    <span class="hljs-comment">//..</span> redirectStrategy.sendRedirect(request, response, security.getBrowser().getLoginUrl());&#125;</code></pre><p>BrowserSecurityConfigï¼š</p><blockquote><p>è¿™é‡ŒæŠŠæ‰€æœ‰çš„@Resourceæ³¨è§£å»æ‰ï¼Œåœ¨ç±»ä¸Šæ–¹åŠ å…¥@AllArgsConstructor</p></blockquote><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationSuccessHandler authenticationSuccessHandler;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> SmsCodeAuthenticationSecurityConfig smsCodeAuthenticationSecurityConfig;    <span class="hljs-keyword">private</span> SecurityProperties security;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        BrowserSecurityProperties browser = security.getBrowser();<span class="hljs-comment">//....</span>                .antMatchers(browser.getLoginUrl(), <span class="hljs-string">"/authentication/require"</span>, <span class="hljs-string">"/code/**"</span>)                  &#125;&#125;</code></pre><h2 id="æˆåŠŸå¤±è´¥å¤„ç†å™¨"><a href="#æˆåŠŸå¤±è´¥å¤„ç†å™¨" class="headerlink" title="æˆåŠŸå¤±è´¥å¤„ç†å™¨"></a>æˆåŠŸå¤±è´¥å¤„ç†å™¨</h2><p>æˆåŠŸå¤±è´¥å¤„ç†å™¨å¯¹äºä¸€äº›å¼€å‘æ¥è¯´æ˜¯æ²¡å¿…è¦è¿”å›josnçš„ï¼Œä»–å¯èƒ½å¸Œæœ›å¾—æ˜¯è·³è½¬é¡µé¢</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> LoginType &#123;    JSON, REDIRECT&#125;</code></pre><p>BrowserSecurityProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> LoginType loginType = LoginType.JSON;</code></pre><p>æˆåŠŸå¤„ç†å™¨å’Œå¤±è´¥å¤„ç†å™¨éƒ½ä»iconå®¹å™¨ä¸­æ‹¿å–SecurityPropertiesç±»ï¼Œåˆ¤æ–­BrowserSecurityPropertiesä¸­çš„LoginTypeæ˜¯jsonçš„è¯å°±è¿”å›jsonï¼Œå¦åˆ™è·³è½¬é¡µé¢ï¼Œè¿™é‡Œè·³è½¬é¡µé¢å¯ä»¥ä¸ç”¨è‡ªå·±å†™ï¼Œspring securityä¸­çš„é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯è·³è½¬ï¼Œå¯ä»¥å°†ä¹‹å‰çš„å¤±è´¥ã€æˆåŠŸæ¥å£æ¢æˆç»§æ‰¿spring securityä¸­æä¾›çš„</p><p>æˆåŠŸå¤„ç†å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.authentication;<span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationSuccessHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SavedRequestAwareAuthenticationSuccessHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-keyword">private</span> SecurityProperties security;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationSuccess</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        <span class="hljs-keyword">if</span> (security.getBrowser().getLoginType().equals(LoginType.JSON)) &#123;            response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(authentication)));        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">super</span>.onAuthenticationSuccess(request, response, authentication);        &#125;    &#125;&#125;</code></pre><p>å¤±è´¥å¤„ç†å™¨ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser.authentication;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.vo.McrSecurityVO;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.LoginType;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.SecurityProperties;<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<span class="hljs-keyword">import</span> org.springframework.security.core.AuthenticationException;<span class="hljs-keyword">import</span> org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-meta">@Component</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthenticationFailureHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ExceptionMappingAuthenticationFailureHandler</span> </span>&#123;    <span class="hljs-keyword">private</span> ObjectMapper objectMapper;    <span class="hljs-keyword">private</span> SecurityProperties security;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onAuthenticationFailure</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;        <span class="hljs-keyword">if</span> (security.getBrowser().getLoginType().equals(LoginType.JSON)) &#123;            response.setContentType(<span class="hljs-string">"application/json;charset=utf-8"</span>);            response.getWriter().write(objectMapper.writeValueAsString(<span class="hljs-keyword">new</span> McrSecurityVO(exception.getMessage())));        &#125; <span class="hljs-keyword">else</span> &#123;            <span class="hljs-keyword">super</span>.onAuthenticationFailure(request, response, exception);        &#125;    &#125;&#125;</code></pre><h2 id="å›¾ç‰‡éªŒè¯ç "><a href="#å›¾ç‰‡éªŒè¯ç " class="headerlink" title="å›¾ç‰‡éªŒè¯ç "></a>å›¾ç‰‡éªŒè¯ç </h2><hr><p>å›¾ç‰‡éªŒè¯ç ç”Ÿæˆçš„å®½ã€é«˜ï¼ŒéªŒè¯ç é•¿åº¦ã€è¿‡æœŸæ—¶é—´</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCodeProperties</span> </span>&#123;<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">67</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> height = <span class="hljs-number">23</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> length = <span class="hljs-number">4</span>;<span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> expireIn = <span class="hljs-number">60</span>;&#125;</code></pre><p>å› ä¸ºä»¥åappæ¨¡å—ä¹Ÿä¼šå®ç°å›¾ç‰‡éªŒè¯ç åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œä¸åº”è¯¥æ”¾åˆ°BrowserSecurityPropertiesç±»ä¸­ï¼Œè¿™é‡Œåˆ›å»ºä¸€ä¸ªValidateCodePropertiesæ”¾åˆ°SecurityPropertiesä¸­</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeProperties</span> </span>&#123;<span class="hljs-keyword">private</span> ImageCodeProperties image = <span class="hljs-keyword">new</span> ImageCodeProperties();&#125;</code></pre><p>SecurityProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> ValidateCodeProperties code = <span class="hljs-keyword">new</span> ValidateCodeProperties();</code></pre><p>ä¹‹å‰æŠŠç”Ÿæˆå›¾ç‰‡éªŒè¯ç çš„é€»è¾‘æ”¾åˆ°äº†ValidateCodeControllerç±»ä¸­ï¼Œè¿™æ ·åšä¼šä¸å¥½æ‰©å±•ï¼Œå¦‚æœè¯´ä½¿ç”¨è€…ä¸æƒ³ç”¨æˆ‘æä¾›çš„å›¾ç‰‡éªŒè¯ç ç”Ÿæˆï¼Œè€Œæ˜¯ç”¨å…¶ä»–çš„é‚£å°±æ²¡æ³•å®ç°äº†ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨é‡Œæ°æ›¿æ¢åŸåˆ™å®ç°ï¼Œé¦–å…ˆè¿™é‡Œåšä¸€ä¸ªæ¥å£ï¼Œæä¾›ä¸€ä¸ªç”Ÿæˆå›¾ç‰‡ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.model.dto.ImageCodeDTO;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ValidateCodeGenerator</span> </span>&#123;<span class="hljs-function">ImageCodeDTO <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span></span>;&#125;</code></pre><p>é»˜è®¤å®ç°ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.demo.core.validate.code.image;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageValidateCodeGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeGenerator</span> </span>&#123;    <span class="hljs-meta">@Setter</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> ImageCodeDTO <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        <span class="hljs-keyword">int</span> width = ServletRequestUtils.getIntParameter(request.getRequest(), <span class="hljs-string">"width"</span>,                securityProperties.getCode().getImage().getWidth());        <span class="hljs-keyword">int</span> height = ServletRequestUtils.getIntParameter(request.getRequest(), <span class="hljs-string">"height"</span>,                securityProperties.getCode().getImage().getHeight());        BufferedImage image = <span class="hljs-keyword">new</span> BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);        Graphics g = image.getGraphics();        Random random = <span class="hljs-keyword">new</span> Random();        g.setColor(getRandColor(<span class="hljs-number">200</span>, <span class="hljs-number">250</span>));        g.fillRect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);        g.setFont(<span class="hljs-keyword">new</span> Font(<span class="hljs-string">"Times New Roman"</span>, Font.ITALIC, <span class="hljs-number">20</span>));        g.setColor(getRandColor(<span class="hljs-number">160</span>, <span class="hljs-number">200</span>));        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">155</span>; i++) &#123;            <span class="hljs-keyword">int</span> x = random.nextInt(width);            <span class="hljs-keyword">int</span> y = random.nextInt(height);            <span class="hljs-keyword">int</span> xl = random.nextInt(<span class="hljs-number">12</span>);            <span class="hljs-keyword">int</span> yl = random.nextInt(<span class="hljs-number">12</span>);            g.drawLine(x, y, x + xl, y + yl);        &#125;        String sRand = <span class="hljs-string">""</span>;        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; securityProperties.getCode().getImage().getLength(); i++) &#123;            String rand = String.valueOf(random.nextInt(<span class="hljs-number">10</span>));            sRand += rand;            g.setColor(<span class="hljs-keyword">new</span> Color(<span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>), <span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>), <span class="hljs-number">20</span> + random.nextInt(<span class="hljs-number">110</span>)));            g.drawString(rand, <span class="hljs-number">13</span> * i + <span class="hljs-number">6</span>, <span class="hljs-number">16</span>);        &#125;        g.dispose();                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ImageCodeDTO(image,sRand, securityProperties.getCode().getImage().getExpireIn());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”ŸæˆéšæœºèƒŒæ™¯æ¡çº¹</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> fc</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> bc</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> Color <span class="hljs-title">getRandColor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> fc, <span class="hljs-keyword">int</span> bc)</span> </span>&#123;        Random random = <span class="hljs-keyword">new</span> Random();        <span class="hljs-keyword">if</span> (fc &gt; <span class="hljs-number">255</span>) &#123;            fc = <span class="hljs-number">255</span>;        &#125;        <span class="hljs-keyword">if</span> (bc &gt; <span class="hljs-number">255</span>) &#123;            bc = <span class="hljs-number">255</span>;        &#125;        <span class="hljs-keyword">int</span> r = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">int</span> g = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">int</span> b = fc + random.nextInt(bc - fc);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Color(r, g, b);    &#125;&#125;</code></pre><p>ç¼–å†™ä¸€ä¸ªé…ç½®ç±»ï¼Œåˆ¤æ–­ä½¿ç”¨è€…æ˜¯å¦è‡ªå·±å®ç°äº†ValidateCodeGeneratorç±»å¹¶æ”¾å…¥IOCä¸­ï¼Œæ˜¯ï¼šå°±ç”¨ä»–è‡ªå·±çš„ï¼Œå¦ï¼šç”¨æˆ‘ä»¬é»˜è®¤æä¾›çš„</p><p>ValidateCodeBeanConfig</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.demo.core.validate.code;<span class="hljs-keyword">import</span> com.b4.demo.core.properties.SecurityProperties;<span class="hljs-keyword">import</span> com.b4.demo.core.validate.code.image.ImageValidateCodeGenerator;<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnMissingBean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-meta">@Configuration</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeBeanConfig</span> </span>&#123;    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-meta">@Bean</span>    <span class="hljs-meta">@ConditionalOnMissingBean</span>(name = <span class="hljs-string">"imageValidateCodeGenerator"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeGenerator <span class="hljs-title">imageValidateCodeGenerator</span><span class="hljs-params">()</span> </span>&#123;        ImageValidateCodeGenerator imageValidateCodeGenerator = <span class="hljs-keyword">new</span> ImageValidateCodeGenerator();        imageValidateCodeGenerator.setSecurityProperties(securityProperties);        <span class="hljs-keyword">return</span> imageValidateCodeGenerator;    &#125;&#125;</code></pre><p>ValidateCodeController#imageCreateCodeï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> ValidateCodeGenerator imageValidateCodeGenerator;    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/image"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">imageCreateCode</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;        <span class="hljs-comment">//1ï¼šæ ¹æ®éšæœºæ•°ç”Ÿæˆå›¾ç‰‡</span>        ImageCodeDTO imageCodeDTO = (ImageCodeDTO) imageValidateCodeGenerator.generate(<span class="hljs-keyword">new</span> ServletWebRequest(request));        <span class="hljs-comment">//2ï¼šå°†å›¾ç‰‡æ”¾å…¥sessionä¸­</span>        sessionStrategy.setAttribute(<span class="hljs-keyword">new</span> ServletWebRequest(request), SESSION_KEY + <span class="hljs-string">"/image"</span>, imageCodeDTO);        <span class="hljs-comment">//3ï¼šå°†ç”Ÿæˆçš„å›¾ç‰‡å†™å…¥æ¥å£çš„å“åº”ä¸­</span>        ImageIO.write(imageCodeDTO.getImage(), <span class="hljs-string">"JPEG"</span>, response.getOutputStream());    &#125;</code></pre><p>å‰é¢å®ç°äº†é€šè¿‡<code>SmsValidateCodeFilter</code>æ¥æ‹¦æˆªç™»å½•è¯·æ±‚ï¼Œåœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ï¼Œå¯èƒ½è¿˜éœ€è¦æ‹¦æˆªå…¶ä»–çš„åœ°å€ï¼Œè¿™é‡Œçš„åœ°å€æ˜¯å¯å˜çš„ï¼Œä¸‹é¢æˆ‘å°±æ¥æ»¡è¶³è¿™ä¸ªä¸šåŠ¡éœ€æ±‚</p><p>ImageCodePropertiesåœ¨åŠ å…¥urlå±æ€§</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> String url;</code></pre><p>ImageValidateCodeFilterï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.mcr.s.auth.core.validate.code.image;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageValidateCodeFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InitializingBean</span> </span>&#123;    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-comment">//é…ç½®æ–‡ä»¶ä¸­é…ç½®çš„éœ€è¦éªŒè¯ç çš„æ‹¦æˆªè·¯å¾„</span>    <span class="hljs-keyword">private</span> Set&lt;String&gt; urls = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-keyword">private</span> AntPathMatcher pathMatcher = <span class="hljs-keyword">new</span> AntPathMatcher();    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;        <span class="hljs-keyword">super</span>.afterPropertiesSet();        String[] configUrls = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">if</span> (securityProperties.getCode().getImage().getUrl() != <span class="hljs-keyword">null</span>) &#123;            configUrls = StringUtils.splitByWholeSeparatorPreserveAllTokens(securityProperties.getCode().getImage().getUrl(), <span class="hljs-string">","</span>);        &#125;        <span class="hljs-keyword">if</span> (configUrls != <span class="hljs-keyword">null</span>) &#123;            urls.addAll(Arrays.asList(configUrls));        &#125;        urls.add(<span class="hljs-string">"/authentication/form"</span>);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        <span class="hljs-keyword">boolean</span> action = <span class="hljs-keyword">false</span>;        <span class="hljs-keyword">for</span> (String url : urls) &#123;            <span class="hljs-keyword">if</span> (pathMatcher.match(url, request.getRequestURI())) &#123;                action = <span class="hljs-keyword">true</span>;                <span class="hljs-keyword">break</span>;            &#125;        &#125;        <span class="hljs-keyword">if</span> (action) &#123;            <span class="hljs-keyword">try</span> &#123;                validate(<span class="hljs-keyword">new</span> ServletWebRequest(request));            &#125; <span class="hljs-keyword">catch</span> (ValidateCodeException e) &#123;                authenticationFailureHandler.onAuthenticationFailure(request, response, e);                <span class="hljs-keyword">return</span>;            &#125;        &#125;        filterChain.doFilter(request, response);    &#125;    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> ServletRequestBindingException </span>&#123;        ImageCodeDTO codeInSession = (ImageCodeDTO) sessionStrategy.getAttribute(request,                ValidateCodeController.SESSION_KEY + <span class="hljs-string">"/image"</span>);        String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), <span class="hljs-string">"imageCode"</span>);        <span class="hljs-keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç çš„å€¼ä¸èƒ½ä¸ºç©º"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession.isExpired()) &#123;            sessionStrategy.removeAttribute(request, ValidateCodeController.SESSION_KEY);            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç å·²è¿‡æœŸ"</span>);        &#125;        <span class="hljs-keyword">if</span> (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ä¸åŒ¹é…"</span>);        &#125;        sessionStrategy.removeAttribute(request, ValidateCodeController.SESSION_KEY);    &#125;&#125;</code></pre><p>BrowserSecurityConfig#configure</p><pre><code class="hljs java">    imageValidateCodeFilter.setSecurityProperties(security);imageValidateCodeFilter.afterPropertiesSet();</code></pre><h2 id="æ‰‹æœºéªŒè¯ç "><a href="#æ‰‹æœºéªŒè¯ç " class="headerlink" title="æ‰‹æœºéªŒè¯ç "></a>æ‰‹æœºéªŒè¯ç </h2><p>ç°åœ¨ä½¿ç”¨è€…å¸Œæœ›ç”Ÿæˆçš„çŸ­ä¿¡éªŒè¯ç æ˜¯6ä½æ•°ï¼Œæˆ‘ä»¬ä¹‹å‰å› ä¸ºç»™çš„æ˜¯ä¸€ä¸ªæ— æ³•ä¿®æ”¹çš„é•¿åº¦ï¼Œä½¿ç”¨è€…æ¥è¯´æ˜¯æ— æ³•ä¿®æ”¹çš„ï¼Œè¿™äº›è¿›è¡Œé‡æ„</p><hr><p>åœ¨è¿™é‡Œå¼€å§‹ä¹‹å‰ï¼Œæ¥çœ‹çœ‹ä»¥UMLå›¾ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567164661098.png" srcset="/img/loading.gif" alt="1567164661098"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°<code>SmsCodeDTO</code>å’Œ<code>ImageCodeDTO</code>çš„å±æ€§æœ‰3ä¸ªæ˜¯ç›¸åŒçš„ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡ç»§æ‰¿å…³ç³»æ¥å‡å°‘ä»£ç ï¼Œ<code>ImageCodeDTO</code>ç»§æ‰¿<code>SmsCodeDTO</code>å°±OKäº†ï¼Œè¿™é‡Œå°†<code>SmsCodeDTO</code>çš„åå­—ä¿®æ”¹ä¸º<code>ValidateCodeDTO</code>ï¼Œè¿™æ ·æ‰æ›´åƒä¸€ä¸ªçˆ¶ç±»ï¼›</p><p>ImageCodeDTO</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.model.dto;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCodeDTO</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ValidateCodeDTO</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å›¾ç‰‡</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> BufferedImage image;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageCodeDTO</span><span class="hljs-params">(BufferedImage image, String code, <span class="hljs-keyword">int</span> expireAfterSeconds)</span> </span>&#123;        <span class="hljs-keyword">super</span>(code, expireAfterSeconds);        <span class="hljs-keyword">this</span>.image = image;    &#125;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageCodeDTO</span><span class="hljs-params">(BufferedImage image, String code, LocalDateTime expireTime)</span> </span>&#123;        <span class="hljs-keyword">super</span>(code, expireTime);        <span class="hljs-keyword">this</span>.image = image;    &#125;&#125;</code></pre><p>ValidateCodeGenerator</p><blockquote><p>è¿”å›ç±»å‹æ”¹ä¸ºValidateCodeDTO</p></blockquote><pre><code class="hljs java"><span class="hljs-function">ValidateCodeDTO <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span></span>;</code></pre><p>å¦‚æœä½¿ç”¨è€…æƒ³æŠŠæ‰‹æœºéªŒè¯ç çš„é•¿åº¦è¿›è¡Œä¿®æ”¹ï¼Œè¿™æ ·çš„éœ€æ±‚æ˜¯æ— æ³•å®ç°çš„ï¼Œå› ä¸ºæˆ‘ä»¬è¿™é‡Œçš„é•¿åº¦æ˜¯å†™æ­»çš„ï¼Œç„¶åå‡è®¾æˆ‘ä¹‹å‰çš„çš„çŸ­ä¿¡ä½¿ç”¨çš„æ˜¯è…¾è®¯çš„çŸ­ä¿¡æœåŠ¡ï¼Œè€Œä½¿ç”¨è€…å–œæ¬¢ç”¨é˜¿é‡Œäº‘çš„ï¼Œä½†æ˜¯æ²¡æ³•æ”¹å°±åªèƒ½å«æ³ªä½¿ç”¨è…¾è®¯çš„äº†ï¼Œè¿™é‡Œå°±æ¥é‡æ„è¿™äº›çš„ä»£ç å§ï¼Œè®©å®ƒå˜ä¸ºå¯å˜çš„</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsCodeProperties</span> </span>&#123;    <span class="hljs-comment">/*</span><span class="hljs-comment">     * é•¿åº¦</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> length = <span class="hljs-number">6</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è¿‡æœŸç§’æ•° é»˜è®¤3åˆ†é’Ÿ</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> expireIn = <span class="hljs-number">180</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ‹¦æˆªçš„è¯·æ±‚</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> String url;&#125;</code></pre><p>è¿™é‡Œä¼šæƒ³åˆ°ImageCodePropertieså’ŒSmsCodePropertiesçš„å±æ€§å¾ˆå¤šéƒ½ä¸€æ ·ï¼Œè¿™é‡Œä¹Ÿç”¨ç»§æ‰¿å…³ç³»æ¥ç®€åŒ–</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageCodeProperties</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SmsCodeProperties</span> </span>&#123;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> width = <span class="hljs-number">67</span>;    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> height = <span class="hljs-number">23</span>;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ImageCodeProperties</span><span class="hljs-params">()</span> </span>&#123;        setLength(<span class="hljs-number">4</span>);    &#125;&#125;</code></pre><p>ValidateCodeProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> SmsCodeProperties sms = <span class="hljs-keyword">new</span> SmsCodeProperties();</code></pre><p>å®šä¹‰ä¸€ä¸ªå‘é€å™¨æ¥å£ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.sms;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SmsCodeSender</span> </span>&#123;<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(String mobile, String code)</span></span>;&#125;</code></pre><p>å‘é€æ¥å£é»˜è®¤å®ç°ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.sms;<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;<span class="hljs-meta">@Slf</span>4j<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DefaultSmsCodeSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SmsCodeSender</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(String mobile, String code)</span> </span>&#123;        log.info(<span class="hljs-string">"è…¾è®¯äº‘æœåŠ¡å‘æ‰‹æœº-&gt;&#123;&#125;å‘é€çŸ­ä¿¡éªŒè¯ç -&gt;&#123;&#125;"</span>, mobile, code);    &#125;&#125;</code></pre><p>ValidateCodeBeanConfig</p><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><span class="hljs-meta">@ConditionalOnMissingBean</span>(SmsCodeSender<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">SmsCodeSender</span> <span class="hljs-title">smsCodeSender</span>() </span>&#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DefaultSmsCodeSender();&#125;</code></pre><p>å¦‚æœç”¨æˆ·æ²¡æœ‰å®ç°SmsCodeSenderçš„ç±»ï¼Œå°±ä½¿ç”¨æˆ‘æä¾›çš„DefaultSmsCodeSenderï¼Œä¹Ÿå°±æ˜¯è…¾è®¯æœåŠ¡</p><hr><p>SmsValidateCodeGenerator</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.sms;<span class="hljs-meta">@Component</span>(<span class="hljs-string">"smsValidateCodeGenerator"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsValidateCodeGenerator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeGenerator</span> </span>&#123;    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeDTO <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        String code = RandomStringUtils.randomNumeric(securityProperties.getCode().getSms().getLength());        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ValidateCodeDTO(code, securityProperties.getCode().getSms().getExpireIn());    &#125;&#125;</code></pre><p>ValidateCodeControllerï¼š</p><pre><code class="hljs java"><span class="hljs-meta">@Resource</span>  <span class="hljs-keyword">private</span> ValidateCodeGenerator smsValidateCodeGenerator;  <span class="hljs-meta">@Resource</span>  <span class="hljs-keyword">private</span> SmsCodeSender smsCodeSender;  <span class="hljs-comment">/**</span><span class="hljs-comment">   * è·å–å›¾ç‰‡éªŒè¯ç </span><span class="hljs-comment">   */</span>  <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/sms"</span>)  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createSms</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException, ServletRequestBindingException </span>&#123;      log.info(<span class="hljs-string">"è·å–çŸ­ä¿¡éªŒè¯ç "</span>);      <span class="hljs-comment">//1.è·å–çŸ­ä¿¡éªŒè¯ç </span>      ValidateCodeDTO validateCodeDTO = smsValidateCodeGenerator.generate(<span class="hljs-keyword">new</span> ServletWebRequest(request, response));      <span class="hljs-comment">//2.ä¿å­˜åˆ°sessionä¸­</span>      sessionStrategy.setAttribute(<span class="hljs-keyword">new</span> ServletWebRequest(request), SESSION_KEY + <span class="hljs-string">"/sms"</span>, validateCodeDTO);      <span class="hljs-comment">//3.å‘é€</span>      String mobile = ServletRequestUtils.getRequiredStringParameter(request, <span class="hljs-string">"mobile"</span>);      smsCodeSender.send(mobile, validateCodeDTO.getCode());  &#125;</code></pre><h2 id="ç¡¬å­—ç¬¦ä¸²é‡æ„"><a href="#ç¡¬å­—ç¬¦ä¸²é‡æ„" class="headerlink" title="ç¡¬å­—ç¬¦ä¸²é‡æ„"></a>ç¡¬å­—ç¬¦ä¸²é‡æ„</h2><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.properties;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">SecurityConstants</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é»˜è®¤çš„å¤„ç†éªŒè¯ç çš„urlå‰ç¼€</span><span class="hljs-comment">     */</span>    String DEFAULT_VALIDATE_CODE_URL_PREFIX = <span class="hljs-string">"/code"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å½“è¯·æ±‚éœ€è¦èº«ä»½è®¤è¯æ—¶ï¼Œé»˜è®¤è·³è½¬çš„url</span><span class="hljs-comment">     */</span>    String DEFAULT_UNAUTHENTICATED_URL = <span class="hljs-string">"/authentication/require"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é»˜è®¤çš„ç”¨æˆ·åå¯†ç ç™»å½•è¯·æ±‚å¤„ç†url</span><span class="hljs-comment">     */</span>    String DEFAULT_LOGIN_PROCESSING_URL_FORM = <span class="hljs-string">"/authentication/form"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é»˜è®¤çš„æ‰‹æœºéªŒè¯ç ç™»å½•è¯·æ±‚å¤„ç†url</span><span class="hljs-comment">     */</span>    String DEFAULT_LOGIN_PROCESSING_URL_MOBILE = <span class="hljs-string">"/authentication/mobile"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * é»˜è®¤ç™»å½•é¡µé¢</span><span class="hljs-comment">     */</span>    String DEFAULT_LOGIN_PAGE_URL = <span class="hljs-string">"/mcr-login.html"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯å›¾ç‰‡éªŒè¯ç æ—¶ï¼Œhttpè¯·æ±‚ä¸­é»˜è®¤çš„æºå¸¦å›¾ç‰‡éªŒè¯ç ä¿¡æ¯çš„å‚æ•°çš„åç§°</span><span class="hljs-comment">     */</span>    String DEFAULT_PARAMETER_NAME_CODE_IMAGE = <span class="hljs-string">"imageCode"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯çŸ­ä¿¡éªŒè¯ç æ—¶ï¼Œhttpè¯·æ±‚ä¸­é»˜è®¤çš„æºå¸¦çŸ­ä¿¡éªŒè¯ç ä¿¡æ¯çš„å‚æ•°çš„åç§°</span><span class="hljs-comment">     */</span>    String DEFAULT_PARAMETER_NAME_CODE_SMS = <span class="hljs-string">"smsCode"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é€çŸ­ä¿¡éªŒè¯ç  æˆ– éªŒè¯çŸ­ä¿¡éªŒè¯ç æ—¶ï¼Œä¼ é€’æ‰‹æœºå·çš„å‚æ•°çš„åç§°</span><span class="hljs-comment">     */</span>    String DEFAULT_PARAMETER_NAME_MOBILE = <span class="hljs-string">"mobile"</span>;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * sessionå¤±æ•ˆé»˜è®¤çš„è·³è½¬åœ°å€</span><span class="hljs-comment">     */</span>    String DEFAULT_SESSION_INVALID_URL = <span class="hljs-string">"/session/invalid"</span>;&#125;</code></pre><p>BrowserSecurityProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> String loginUrl = SecurityConstants.DEFAULT_LOGIN_PAGE_URL;</code></pre><p>BrowserSecurityConfig</p><pre><code class="hljs java">            .loginPage(SecurityConstants.DEFAULT_UNAUTHENTICATED_URL)               .loginProcessingUrl(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM)                          SecurityConstants.DEFAULT_UNAUTHENTICATED_URL, SecurityConstants.DEFAULT_VALIDATE_CODE_URL_PREFIX + <span class="hljs-string">"/*"</span>)           &#125;</code></pre><p>SmsValidateCodeFilter</p><pre><code class="hljs java"><span class="hljs-keyword">if</span> (request.getRequestURI().equals(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE)</code></pre><p>SmsCodeAuthenticationFilter</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SmsCodeAuthenticationFilter</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">super</span>(<span class="hljs-keyword">new</span> AntPathRequestMatcher(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE, <span class="hljs-string">"POST"</span>));&#125;</code></pre><p>ImageValidateCodeFilterï¼š</p><pre><code class="hljs java">String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_IMAGE);</code></pre><p>SmsValidateCodeFilter</p><pre><code class="hljs java">String codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(), SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_SMS);</code></pre><p>ValidateCodeController</p><pre><code class="hljs java">String mobile = ServletRequestUtils.getRequiredStringParameter(request, SecurityConstants.DEFAULT_PARAMETER_NAME_MOBILE);</code></pre><h2 id="éªŒè¯ç è¯»å†™é‡æ„"><a href="#éªŒè¯ç è¯»å†™é‡æ„" class="headerlink" title="éªŒè¯ç è¯»å†™é‡æ„"></a>éªŒè¯ç è¯»å†™é‡æ„</h2><p>é€šè¿‡ä»¥ä¸Šçš„é‡æ„ï¼Œæ˜¯ä¸æ˜¯å‘ç°,æ‰‹æœºéªŒè¯ç å’Œå›¾ç‰‡éªŒè¯ç çš„ç”Ÿæˆé€»è¾‘éå¸¸å¾—ç›¸ä¼¼ï¼š</p><ol><li>ç”ŸæˆéªŒè¯ç ï¼Œæ”¾å…¥session</li><li>ç”¨æˆ·ç™»å½•æ—¶ï¼Œæ‹¿å‡ºæ¥è¿›è¡Œå¯¹æ¯”</li></ol><p>è¿™é‡Œå®šä¹‰ä¸€ä¸ªæšä¸¾å•ä¾‹å·¥å‚</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> com.b4.mcr.auth.core.properties.SecurityConstants;<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> ValidateCodeType &#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * çŸ­ä¿¡éªŒè¯ç </span><span class="hljs-comment"> */</span>SMS &#123;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getParamNameOnValidate</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_SMS;&#125;&#125;,<span class="hljs-comment">/**</span><span class="hljs-comment"> * å›¾ç‰‡éªŒè¯ç </span><span class="hljs-comment"> */</span>IMAGE &#123;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getParamNameOnValidate</span><span class="hljs-params">()</span> </span>&#123;<span class="hljs-keyword">return</span> SecurityConstants.DEFAULT_PARAMETER_NAME_CODE_IMAGE;&#125;&#125;;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æ ¡éªŒæ—¶ä»è¯·æ±‚ä¸­è·å–çš„å‚æ•°çš„åå­—</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> String <span class="hljs-title">getParamNameOnValidate</span><span class="hljs-params">()</span></span>;&#125;</code></pre><p>è¿™é‡Œå®šä¹‰ä¸€ä¸ªå‘é€å™¨æ¥å£ï¼Œé‡Œé¢æœ‰2ä¸ªæ–¹æ³•ï¼Œcreateï¼šåˆ›å»ºéªŒè¯ç å¹¶å°†éªŒè¯ç ä¿å­˜åˆ°sessionä¸­ï¼Œç„¶åå“åº”ç»™å‰ç«¯ï¼Œvalidateï¼šæ•ˆéªŒç”¨æˆ·å¡«å†™çš„ä¿¡æ¯æ˜¯å¦å’Œsessionä¸­ä¸€æ ·</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æ ¡éªŒç å¤„ç†å™¨ï¼Œå°è£…ä¸åŒæ ¡éªŒç çš„å¤„ç†é€»è¾‘</span><span class="hljs-comment"> * </span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ValidateCodeProcessor</span> </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * éªŒè¯ç æ”¾å…¥sessionæ—¶çš„å‰ç¼€</span><span class="hljs-comment"> */</span>String SESSION_KEY_PREFIX = <span class="hljs-string">"SESSION_KEY_FOR_CODE_"</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * åˆ›å»ºæ ¡éªŒç </span><span class="hljs-comment"> * </span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> Exception</span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * æ ¡éªŒéªŒè¯ç </span><span class="hljs-comment"> * </span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest servletWebRequest)</span></span>;&#125;</code></pre><p>å‘é€å™¨æ¥å£çš„æŠ½è±¡å®ç°ç±»ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> org.apache.commons.lang.StringUtils;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.HttpSessionSessionStrategy;<span class="hljs-keyword">import</span> org.springframework.social.connect.web.SessionStrategy;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestBindingException;<span class="hljs-keyword">import</span> org.springframework.web.bind.ServletRequestUtils;<span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletWebRequest;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AbstractValidateCodeProcessor</span>&lt;<span class="hljs-title">C</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ValidateCodeDTO</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">ValidateCodeProcessor</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ“ä½œsessionçš„å·¥å…·ç±»</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> SessionStrategy sessionStrategy = <span class="hljs-keyword">new</span> HttpSessionSessionStrategy();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ”¶é›†ç³»ç»Ÿä¸­æ‰€æœ‰çš„ &#123;<span class="hljs-doctag">@link</span> ValidateCodeGenerator&#125; æ¥å£çš„å®ç°ã€‚</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> Map&lt;String, ValidateCodeGenerator&gt; validateCodeGenerators;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">create</span><span class="hljs-params">(ServletWebRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        C validateCode = generate(request);        save(request, validateCode);        send(request, validateCode);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç”Ÿæˆæ ¡éªŒç </span><span class="hljs-comment">     *</span><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> request</span><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> C <span class="hljs-title">generate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        String type = getValidateCodeType().toString().toLowerCase();        String generatorName = type + ValidateCodeGenerator<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getSimpleName</span>()</span>;<span class="hljs-comment">//                String generatorName = type + StringUtils.substringAfter(ValidateCodeGenerator.class.getSimpleName(), "Validate");</span>        ValidateCodeGenerator validateCodeGenerator = validateCodeGenerators.get(generatorName);        <span class="hljs-keyword">if</span> (validateCodeGenerator == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç ç”Ÿæˆå™¨"</span> + generatorName + <span class="hljs-string">"ä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-keyword">return</span> (C) validateCodeGenerator.generate(request);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ä¿å­˜æ ¡éªŒç </span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">save</span><span class="hljs-params">(ServletWebRequest request, C validateCode)</span> </span>&#123;        sessionStrategy.setAttribute(request, getSessionKey(), validateCode);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ„å»ºéªŒè¯ç æ”¾å…¥sessionæ—¶çš„key</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">getSessionKey</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> SESSION_KEY_PREFIX + getValidateCodeType().toString().toUpperCase();    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * æ ¹æ®è¯·æ±‚çš„urlè·å–æ ¡éªŒç çš„ç±»å‹</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> ValidateCodeType <span class="hljs-title">getValidateCodeType</span><span class="hljs-params">()</span> </span>&#123;        String type = StringUtils.substringBefore(getClass().getSimpleName(), <span class="hljs-string">"ValidateCodeProcessor"</span>);        <span class="hljs-keyword">return</span> ValidateCodeType.valueOf(type.toUpperCase());    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é€æ ¡éªŒç ï¼Œç”±å­ç±»å®ç°</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(ServletWebRequest request, C validateCode)</span> <span class="hljs-keyword">throws</span> Exception</span>;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">validate</span><span class="hljs-params">(ServletWebRequest request)</span> </span>&#123;        ValidateCodeType processorType = getValidateCodeType();        String sessionKey = getSessionKey();        C codeInSession = (C) sessionStrategy.getAttribute(request, sessionKey);        String codeInRequest;        <span class="hljs-keyword">try</span> &#123;            codeInRequest = ServletRequestUtils.getStringParameter(request.getRequest(),                    processorType.getParamNameOnValidate());        &#125; <span class="hljs-keyword">catch</span> (ServletRequestBindingException e) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"è·å–éªŒè¯ç çš„å€¼å¤±è´¥"</span>);        &#125;        <span class="hljs-keyword">if</span> (StringUtils.isBlank(codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(processorType + <span class="hljs-string">"éªŒè¯ç çš„å€¼ä¸èƒ½ä¸ºç©º"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession == <span class="hljs-keyword">null</span>) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(processorType + <span class="hljs-string">"éªŒè¯ç ä¸å­˜åœ¨"</span>);        &#125;        <span class="hljs-keyword">if</span> (codeInSession.isExpired()) &#123;            sessionStrategy.removeAttribute(request, sessionKey);            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(processorType + <span class="hljs-string">"éªŒè¯ç å·²è¿‡æœŸ"</span>);        &#125;        <span class="hljs-keyword">if</span> (!StringUtils.equals(codeInSession.getCode(), codeInRequest)) &#123;            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(processorType + <span class="hljs-string">"éªŒè¯ç ä¸åŒ¹é…"</span>);        &#125;        sessionStrategy.removeAttribute(request, sessionKey);    &#125;&#125;</code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.image;<span class="hljs-comment">/**</span><span class="hljs-comment"> * å›¾ç‰‡éªŒè¯ç å¤„ç†å™¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> zhailiang</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span>(<span class="hljs-string">"imageValidateCodeProcessor"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageValidateCodeProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractValidateCodeProcessor</span>&lt;<span class="hljs-title">ImageCodeDTO</span>&gt; </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å‘é€å›¾å½¢éªŒè¯ç ï¼Œå°†å…¶å†™åˆ°å“åº”ä¸­</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(ServletWebRequest request, ImageCodeDTO imageCode)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        ImageIO.write(imageCode.getImage(), <span class="hljs-string">"JPEG"</span>, request.getResponse().getOutputStream());    &#125;&#125;</code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code.sms;<span class="hljs-comment">/**</span><span class="hljs-comment"> * çŸ­ä¿¡éªŒè¯ç å¤„ç†å™¨</span><span class="hljs-comment"> *</span><span class="hljs-comment"> *</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Component</span>(<span class="hljs-string">"smsValidateCodeProcessor"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SmsValidateCodeProcessor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractValidateCodeProcessor</span>&lt;<span class="hljs-title">ValidateCodeDTO</span>&gt; </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * çŸ­ä¿¡éªŒè¯ç å‘é€å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Autowired</span>    <span class="hljs-keyword">private</span> SmsCodeSender smsCodeSender;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span><span class="hljs-params">(ServletWebRequest request, ValidateCodeDTO validateCode)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        String paramName = SecurityConstants.DEFAULT_PARAMETER_NAME_MOBILE;        String mobile = ServletRequestUtils.getRequiredStringParameter(request.getRequest(), paramName);        smsCodeSender.send(mobile, validateCode.getCode());    &#125;&#125;</code></pre><p>é‚£ä¹ˆcontrollerä¸­è¦å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿå†™2ä¸ªæ–¹æ³•ï¼Ÿè¿™é‡Œç”¨è¿™ä¹ˆä¸€ä¸ªåŠæ³•ï¼Œåªéœ€è¦ç¼–å†™ä¸€ä¸ªæ–¹æ³•å°±æå®šäº†,</p><p>é¦–å…ˆè¿™é‡Œçš„findValidateCodeProcessoræ–¹æ³•é€šè¿‡ä¸åŒçš„typeæ¥ä»validateCodeProcessorsæˆå‘˜å˜é‡ä¸­æ‹¿å–ä¸åŒçš„ValidateCodeProcessorå®ç°ã€‚è¿™é‡Œä½¿ç”¨äº†å®¹å™¨å•ä¾‹æ¨¡å¼</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeProcessorHolder</span> </span>&#123;<span class="hljs-meta">@Autowired</span><span class="hljs-keyword">private</span> Map&lt;String, ValidateCodeProcessor&gt; validateCodeProcessors;<span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeProcessor <span class="hljs-title">findValidateCodeProcessor</span><span class="hljs-params">(ValidateCodeType type)</span> </span>&#123;<span class="hljs-keyword">return</span> findValidateCodeProcessor(type.toString().toLowerCase());&#125;<span class="hljs-function"><span class="hljs-keyword">public</span> ValidateCodeProcessor <span class="hljs-title">findValidateCodeProcessor</span><span class="hljs-params">(String type)</span> </span>&#123;String name = type.toLowerCase() + ValidateCodeProcessor<span class="hljs-class">.<span class="hljs-keyword">class</span>.<span class="hljs-title">getSimpleName</span>()</span>;ValidateCodeProcessor processor = validateCodeProcessors.get(name);<span class="hljs-keyword">if</span> (processor == <span class="hljs-keyword">null</span>) &#123;<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ValidateCodeException(<span class="hljs-string">"éªŒè¯ç å¤„ç†å™¨"</span> + name + <span class="hljs-string">"ä¸å­˜åœ¨"</span>);&#125;<span class="hljs-keyword">return</span> processor;&#125;&#125;</code></pre><p>è·å–å›¾ç‰‡éªŒè¯ç çš„è¯·æ±‚ï¼š<code>/code/image</code>ï¼Œå‘é€çŸ­ä¿¡éªŒè¯ç çš„è¯·æ±‚ï¼š<code>/code/sms</code>ï¼Œè¿™é‡Œä¼šç»™åˆ°typeå‚æ•°ä¸Šï¼Œç„¶åäº¤ç»™<code>validateCodeProcessorHolder#findValidateCodeProcessor</code>ï¼Œè·å–å¯¹åº”çš„<code>ValidateCodeProcessor</code>å®ç°ï¼Œè°ƒç”¨å®ƒ2çš„createæ–¹æ³•ï¼Œè€Œå®ƒä¸¤çš„createæ–¹æ³•æ˜¯çˆ¶ç±»<code>AbstractValidateCodeProcessor</code>çš„ï¼Œé‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>generate</code>æ–¹æ³•ç”ŸæˆéªŒè¯ç ï¼Œç„¶åé€šè¿‡<code>save</code>ä¿å­˜åˆ°<code>session</code>ä¸­ï¼Œæœ€åè°ƒç”¨<code>send</code>æ–¹æ³•å‘é€å‡ºå»</p><p>ValidateCodeController</p><pre><code class="hljs java"><span class="hljs-meta">@Resource</span>   <span class="hljs-keyword">private</span> ValidateCodeProcessorHolder validateCodeProcessorHolder;   <span class="hljs-comment">/**</span><span class="hljs-comment">    * åˆ›å»ºéªŒè¯ç ï¼Œæ ¹æ®éªŒè¯ç ç±»å‹ä¸åŒï¼Œè°ƒç”¨ä¸åŒçš„ &#123;<span class="hljs-doctag">@link</span> ValidateCodeProcessor&#125;æ¥å£å®ç°</span><span class="hljs-comment">    */</span>   <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/&#123;type&#125;"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createCode</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, @PathVariable String type)</span></span><span class="hljs-function">           <span class="hljs-keyword">throws</span> Exception </span>&#123;       validateCodeProcessorHolder.findValidateCodeProcessor(type).create(<span class="hljs-keyword">new</span> ServletWebRequest(request, response));   &#125;</code></pre><p>ValidateCodeFilterï¼Œå°†2ä¸ªæ ¡éªŒè¿‡æ»¤å™¨ç»“åˆèµ·æ¥ï¼Œå…¶ä»–2ä¸ªå¯ä»¥åˆ é™¤æ‰äº†</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.core.validate.code;<span class="hljs-meta">@Component</span>(<span class="hljs-string">"validateCodeFilter"</span>)<span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ValidateCodeFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OncePerRequestFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InitializingBean</span> </span>&#123;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯ç æ ¡éªŒå¤±è´¥å¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> AuthenticationFailureHandler authenticationFailureHandler;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç³»ç»Ÿé…ç½®ä¿¡æ¯</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> SecurityProperties securityProperties;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * ç³»ç»Ÿä¸­çš„æ ¡éªŒç å¤„ç†å™¨</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> ValidateCodeProcessorHolder validateCodeProcessorHolder;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * å­˜æ”¾æ‰€æœ‰éœ€è¦æ ¡éªŒéªŒè¯ç çš„url</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, ValidateCodeType&gt; urlMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * éªŒè¯è¯·æ±‚urlä¸é…ç½®çš„urlæ˜¯å¦åŒ¹é…çš„å·¥å…·ç±»</span><span class="hljs-comment">     */</span>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AntPathMatcher pathMatcher = <span class="hljs-keyword">new</span> AntPathMatcher();    <span class="hljs-comment">/**</span><span class="hljs-comment">     * åˆå§‹åŒ–è¦æ‹¦æˆªçš„urlé…ç½®ä¿¡æ¯</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;        <span class="hljs-keyword">super</span>.afterPropertiesSet();        urlMap.put(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_FORM, ValidateCodeType.IMAGE);        addUrlToMap(securityProperties.getCode().getImage().getUrl(), ValidateCodeType.IMAGE);        urlMap.put(SecurityConstants.DEFAULT_LOGIN_PROCESSING_URL_MOBILE, ValidateCodeType.SMS);        addUrlToMap(securityProperties.getCode().getSms().getUrl(), ValidateCodeType.SMS);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è®²ç³»ç»Ÿä¸­é…ç½®çš„éœ€è¦æ ¡éªŒéªŒè¯ç çš„URLæ ¹æ®æ ¡éªŒçš„ç±»å‹æ”¾å…¥map</span><span class="hljs-comment">     *</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addUrlToMap</span><span class="hljs-params">(String urlString, ValidateCodeType type)</span> </span>&#123;        <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(urlString)) &#123;            String[] urls = StringUtils.splitByWholeSeparatorPreserveAllTokens(urlString, <span class="hljs-string">","</span>);            <span class="hljs-keyword">for</span> (String url : urls) &#123;                urlMap.put(url, type);            &#125;        &#125;    &#125;    <span class="hljs-comment">/*</span><span class="hljs-comment">     * (non-Javadoc)</span><span class="hljs-comment">     *</span><span class="hljs-comment">     * @see</span><span class="hljs-comment">     * org.springframework.web.filter.OncePerRequestFilter#doFilterInternal(</span><span class="hljs-comment">     * javax.servlet.http.HttpServletRequest,</span><span class="hljs-comment">     * javax.servlet.http.HttpServletResponse, javax.servlet.FilterChain)</span><span class="hljs-comment">     */</span>    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilterInternal</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><span class="hljs-function">            <span class="hljs-keyword">throws</span> ServletException, IOException </span>&#123;        ValidateCodeType type = getValidateCodeType(request);        <span class="hljs-keyword">if</span> (type != <span class="hljs-keyword">null</span>) &#123;            logger.info(<span class="hljs-string">"æ ¡éªŒè¯·æ±‚("</span> + request.getRequestURI() + <span class="hljs-string">")ä¸­çš„éªŒè¯ç ,éªŒè¯ç ç±»å‹"</span> + type);            <span class="hljs-keyword">try</span> &#123;                validateCodeProcessorHolder.findValidateCodeProcessor(type)                        .validate(<span class="hljs-keyword">new</span> ServletWebRequest(request, response));                logger.info(<span class="hljs-string">"éªŒè¯ç æ ¡éªŒé€šè¿‡"</span>);            &#125; <span class="hljs-keyword">catch</span> (ValidateCodeException exception) &#123;                authenticationFailureHandler.onAuthenticationFailure(request, response, exception);                <span class="hljs-keyword">return</span>;            &#125;        &#125;        chain.doFilter(request, response);    &#125;    <span class="hljs-comment">/**</span><span class="hljs-comment">     * è·å–æ ¡éªŒç çš„ç±»å‹ï¼Œå¦‚æœå½“å‰è¯·æ±‚ä¸éœ€è¦æ ¡éªŒï¼Œåˆ™è¿”å›null</span><span class="hljs-comment">     *</span><span class="hljs-comment">     */</span>    <span class="hljs-function"><span class="hljs-keyword">private</span> ValidateCodeType <span class="hljs-title">getValidateCodeType</span><span class="hljs-params">(HttpServletRequest request)</span> </span>&#123;        ValidateCodeType result = <span class="hljs-keyword">null</span>;        <span class="hljs-keyword">if</span> (!StringUtils.equalsIgnoreCase(request.getMethod(), <span class="hljs-string">"get"</span>)) &#123;            Set&lt;String&gt; urls = urlMap.keySet();            <span class="hljs-keyword">for</span> (String url : urls) &#123;                <span class="hljs-keyword">if</span> (pathMatcher.match(url, request.getRequestURI())) &#123;                    result = urlMap.get(url);                &#125;            &#125;        &#125;        <span class="hljs-keyword">return</span> result;    &#125;&#125;</code></pre><p>BrowserSecurityConfigï¼š</p><pre><code class="hljs java">   <span class="hljs-keyword">private</span> ValidateCodeFilter validateCodeFilter;    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<span class="hljs-comment">//...</span>http.                .addFilterBefore(validateCodeFilter,UsernamePasswordAuthenticationFilter<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"></span><span class="hljs-class"></span><span class="hljs-class">&#125;</span></code></pre><h1 id="è®°ä½æˆ‘"><a href="#è®°ä½æˆ‘" class="headerlink" title="è®°ä½æˆ‘"></a>è®°ä½æˆ‘</h1><p>å½“ç”¨æˆ·ç™»å½•ä¸€æ¬¡ä»¥åç³»ç»Ÿä¼šè®°ä½ç”¨æˆ·ä¸€æ®µæ—¶é—´ï¼Œåœ¨æ®µæ—¶é—´ç”¨æˆ·ä¸èƒ½åå¤ç™»å½•å°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„ç³»ç»Ÿ</p><h2 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h2><p>BrowserSecurityProperties</p><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> rememberMeSeconds = <span class="hljs-number">36000</span>;</code></pre><p>BrowserSecurityConfig</p><pre><code class="hljs java">  <span class="hljs-keyword">private</span> DataSource dataSource;    <span class="hljs-keyword">private</span> UserDetailsService userDetailsService;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> PersistentTokenRepository <span class="hljs-title">repository</span><span class="hljs-params">()</span> </span>&#123;        JdbcTokenRepositoryImpl jdbcTokenRepository = <span class="hljs-keyword">new</span> JdbcTokenRepositoryImpl();        jdbcTokenRepository.setDataSource(dataSource);        <span class="hljs-comment">//è‡ªåŠ¨åˆ›å»ºè¡¨</span>        jdbcTokenRepository.setCreateTableOnStartup(<span class="hljs-keyword">true</span>);        <span class="hljs-keyword">return</span> jdbcTokenRepository;    &#125;<span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        BrowserSecurityProperties browser = security.getBrowser();        http                <span class="hljs-comment">/*rememberMe*/</span>                .rememberMe()                .tokenRepository(repository())                .tokenValiditySeconds(browser.getRememberMeSeconds())                .userDetailsService(userDetailsService)                .and()</code></pre><p>mcr-login.html</p><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ç™»å½•é¡µé¢<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/authentication/form"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">table</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>è´¦å·<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span>/&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>å¯†ç <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>å›¾å½¢éªŒè¯ç :<span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"imageCode"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"/code/image"</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>                è®°ä½æˆ‘ <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"remember-me"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">tr</span>&gt;</span>            <span class="hljs-tag">&lt;<span class="hljs-name">td</span> <span class="hljs-attr">colspan</span>=<span class="hljs-string">"2"</span>&gt;</span>                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>ç™»å½•<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>            <span class="hljs-tag">&lt;/<span class="hljs-name">td</span>&gt;</span>        <span class="hljs-tag">&lt;/<span class="hljs-name">tr</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></code></pre><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567436120008.png" srcset="/img/loading.gif" alt="1567436120008"></p><p>UsernamePasswordAuthenticationFilterè®¤è¯æˆåŠŸå¤„ç†ä»¥åï¼Œå®ƒä¼šè°ƒç”¨ä¸€ä¸ªRememberMeServicesæœåŠ¡ï¼Œè¿™è¿™ä¸ªæœåŠ¡ä¸­æœ‰ä¸€ä¸ªTokenRepositoryï¼Œè¿™ä¸ªæœåŠ¡å®ƒä¼šç”Ÿæˆä¸€ä¸ªtokenï¼Œå°†è¿™ä¸ªtokenå†™å…¥æµè§ˆå™¨åˆ°æµè§ˆå™¨çš„cookieé‡Œé¢ï¼ŒåŒæ—¶å®ƒä¼šç”¨è¿™ä¸ªTokenRepositoryæŠŠç”Ÿæˆçš„tokenå†™åˆ°åˆ°æ•°æ®åº“é‡Œé¢ï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ä½œæ˜¯åœ¨èº«ä»½è®¤è¯æˆåŠŸä»¥ååšçš„ï¼Œæ‰€ä»¥å®ƒåœ¨ tokenå†™å…¥æ•°æ®åº“çš„æ—¶å€™ï¼Œä¼šæŠŠè®¤è¯æˆåŠŸçš„ç”¨æˆ·ååŒæ—¶å†™è¿›å»ï¼Œæ•°æ®åº“ä¸­tokenå’Œç”¨æˆ·åæ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯”å¦‚è¿‡äº†ä¸€å¤©ç”¨æˆ·åˆæ¥è®¿é—®ç³»ç»Ÿï¼Œä»–å°±ä¸éœ€è¦ç™»å½•äº†ï¼Œä»–å°±å¯ä»¥ç›´æ¥è®¿é—®æ”¶ä¿æŠ¤çš„æœåŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚ç»è¿‡è¿‡æ»¤å™¨é“¾çš„æ—¶å€™ä¼šç»è¿‡RememberMeAuthenticationFilterè¿‡æ»¤å™¨ï¼Œå®ƒä¼šè¯»å–cookieä¸­çš„ tokenï¼Œå› ä¸ºç”¨æˆ·åœ¨ç™»å½•æˆåŠŸçš„æ—¶å€™ï¼Œå°±æ˜¯æŠŠä¸€ä¸ªtokenå†™å…¥åˆ°æµè§ˆå™¨çš„cookieé‡Œï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªè¿‡æ»¤å™¨å®ƒä¼šæŠŠè¿™ä¸ªtokenä»cookieé‡Œè¯»å‡ºæ¥ï¼Œäº¤ç»™RememberMeServicesï¼ŒRememberMeServicesä¼šç”¨TokenRepositoryåˆ°æ•°æ®åº“é‡Œå»æŸ¥è¿™ä¸ªtokenæˆ‘æ•°æ®åº“é‡Œæœ‰æ²¡æœ‰è®°å½•ï¼Œå¦‚æœæ•°æ®åº“é‡Œæœ‰è®°å½•ï¼Œé‚£ä¹ˆå°±æŠŠå¯¹åº”çš„ç”¨æˆ·åå–å‡ºæ¥ï¼Œå–å‡ºæ¥ç”¨æˆ·åä»¥åï¼Œå®ƒä¼šå»è°ƒç”¨UserDetailsServiceï¼Œç„¶åå»è·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼ŒæŠŠå½“å‰è·å–åˆ°çš„ç”¨æˆ·ä¿¡æ¯æ”¾åˆ°SecurityContexté‡Œé¢ï¼Œè¿™æ ·å°±æŠŠç”¨æˆ·ç™»å½•ä¸Šäº†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1567436147796.png" srcset="/img/loading.gif" alt="1567436147796"></p><p>è¿™é‡Œçš„RememberMeAuthenticationFilterå®ƒåœ¨è¿‡æ»¤å™¨é“¾ä¸Šç»¿è‰²éƒ¨åˆ†çš„å€’æ•°ç¬¬2ä¸ªä½ç½®ï¼Œå‰é¢æ˜¯ä¸€äº›å…¶ä»–è®¤è¯è¿‡æ»¤å™¨ï¼Œå…¶ä»–è®¤è¯éƒ½æ²¡æ³•è®¤è¯ç”¨æˆ·ä¿¡æ¯çš„æ—¶å€™ï¼Œå®ƒä¼šå»å°è¯•å»åšè®¤è¯</p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ äºŒã€Form ã€‘  1.Spring SecrutiyåŸºæœ¬åŸç†</title>
    <link href="/spring-security-2.1.html"/>
    <url>/spring-security-2.1.html</url>
    
    <content type="html"><![CDATA[<p>è¯·å°†<code>yml</code>ä¸­çš„è¿™æ®µä»£ç åˆ é™¤ï¼Œæ¥ä¸‹æ¥å¼€å§‹å­¦ä¹ <code>Spring Security</code>,è¿™æ®µé…ç½®æ˜¯ç”¨æ¥å…³é—­/å¼€å¯å®ƒçš„åŠŸèƒ½çš„</p><pre><code class="hljs yaml"><span class="hljs-attr">security:</span>  <span class="hljs-attr">basic:</span>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span></code></pre><p>ç°åœ¨åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼Œä¼šå‡ºç°ä»¥ä¸‹å¼¹æ¡†</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566728660810.png" srcset="/img/loading.gif" alt="1566728660810"></p><p>è¿™ä¸ªæ˜¯<code>spring security</code>çš„é»˜è®¤é…ç½®ï¼Œè¿™äº›é…ç½®å†™åœ¨<code>WebSecurityConfigurerAdapter</code>ä¸­</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;logger.debug(<span class="hljs-string">"Using default configure(HttpSecurity). If subclassed this will potentially override subclass configure(HttpSecurity)."</span>);http.authorizeRequests().anyRequest().authenticated().and().formLogin().and().httpBasic();&#125;</code></pre><p>æˆ‘ä»¬æ¥ç™»å½•ä¸€ä¸‹ï¼Œè¿™é‡Œçš„å¯†ç å¯ä»¥åœ¨æ§åˆ¶å°ä¸­æ‰¾åˆ°ï¼Œè´¦å·æ˜¯å›ºå®šuserï¼Œå¯†ç å°±æ˜¯æ§åˆ¶å°ä¸Šçœ‹è§çš„è¿™ä¸ª</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566729135804.png" srcset="/img/loading.gif" alt="1566729135804"></p><p>è¡¨å•ç™»å½•ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.auth.browser;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;<span class="hljs-keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BrowserSecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebSecurityConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;        http                .formLogin().and()                .authorizeRequests()                .anyRequest().authenticated();    &#125;&#125;</code></pre><blockquote><p>è¿™é‡Œçš„ä»£ç æ˜¯é’ˆå¯¹æµè§ˆå™¨æ¥çš„é…ç½®ï¼Œæ‰€ä»¥æ˜¯ç¼–å†™åœ¨browseræ¨¡å—ä¸­çš„</p></blockquote><p>ç°åœ¨è®¿é—®æ¥å£æ—¶ä¼šæ˜¯è¿™æ ·å­ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566729509366.png" srcset="/img/loading.gif" alt="1566729509366"></p><p>åŸç†ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566723514793.png" srcset="/img/loading.gif" alt="1566723514793"></p><p><code>spring secrutiy</code>ä¸­æœ€æ ¸å¿ƒæ˜¯ä¸€ç»„è¿‡æ»¤å™¨é“¾ï¼Œä¹‹å‰é€šè¿‡è¿‡æ»¤å™¨æ¥æ‹¦æˆª<code>rest api</code>ï¼Œ<code>spring security</code>ä¹Ÿæ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥åšçš„ï¼Œè¿™äº›è¿‡æ»¤å™¨åœ¨ç³»ç»Ÿå¯åŠ¨çš„æ—¶å€™<code>spring boot</code>ä¼šè‡ªåŠ¨æŠŠå®ƒéƒ½é…è¿›å»ï¼Œé¦–å…ˆæ¥è¯¦ç»†ä»‹ç»æœ€ä¸»è¦çš„å‡ ä¸ªè¿‡æ»¤å™¨,æœ€æ ¸å¿ƒçš„å°±æ˜¯å›¾ä¸Šçš„ç»¿è‰²è¿‡æ»¤å™¨ï¼š</p><ul><li>UsernamePasswordAuthenticationFilterï¼šå¤„ç†è¡¨å•ç™»å½•</li><li>BasicAuthenticationFilterï¼šå¤„ç†http basicç™»å½•</li></ul><p>ç»¿è‰²çš„è¿‡æ»¤å™¨ç”¨æ¥æ£€æŸ¥è¯·æ±‚ä¸­æ˜¯å¦æœ‰å®ƒéœ€è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚<code>UsernamePasswordAuthenticationFilter</code>è¿™ä¸ªè¿‡æ»¤å™¨æ¥è¯´å®ƒä¼šæ£€æŸ¥ä½ çš„è¯·æ±‚æ˜¯ä¸æ˜¯ä¸€ä¸ªç™»å½•è¯·æ±‚ï¼Œç„¶ååœ¨è¿™ä¸ªç™»å½•è¯·æ±‚ä¸­çœ‹å¸¦æ²¡å¸¦ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚æœå¸¦äº†è¿™ä¸ªè¿‡æ»¤å™¨å°±ä¼šå°è¯•ç”¨ç”¨æˆ·åå’Œå¯†ç å»åšç”¨æˆ·çš„ç™»å½•ï¼Œå¦‚æœæ²¡æœ‰å¸¦ï¼Œå®ƒå°±ä¼šæ”¾è¿‡å»ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨æ¯”å¦‚è¯´æ˜¯<code>BasicAuthenticationFilter</code>ï¼Œå®ƒä¼šæ£€æŸ¥è¯·æ±‚çš„è¯·æ±‚å¤´é‡Œé¢æ˜¯å¦æœ‰<code>Basic Authorization</code>çš„ä¿¡æ¯ï¼Œå¦‚æœæœ‰ï¼Œå°è¯•æ‹¿å‡ºæ¥åš<code>base64</code>å­—èŠ‚ç å–å‡ºç”¨æˆ·åå¯†ç æ¥ç™»å½•ï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–çš„è®¤è¯æ–¹å¼ï¼ˆåœ¨spring securityï¼‰å®ƒè¿˜æä¾›äº†å¾ˆå¤šå…¶ä»–çš„è®¤è¯æ–¹å¼ï¼ŒæŒ‰ç…§è¿™ä¸ªåŸç†å®ƒä¼šä¸€ä¸ªä¸ªå¾€ä¸‹èµ°ï¼Œä»»ä½•ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå®ƒæˆåŠŸå®Œæˆäº†ç”¨æˆ·ç™»å½•ä»¥åï¼Œå®ƒä¼šåœ¨è¯·æ±‚ä¸Šåšä¸€ä¸ªæ ‡è®°ï¼šå½“å‰è¿™ä¸ªç”¨æˆ·è®¤è¯æˆåŠŸäº†ï¼Œè¯·æ±‚ç»è¿‡è¿™äº›ç»¿è‰²çš„è¿‡æ»¤å™¨ä¹‹åï¼Œä¼šåˆ°<code>FilterSecurityInterceptor</code>æ‹¦æˆªå™¨ä¸­ï¼Œè¿™ä¸ªè¿‡æ‹¦æˆªå™¨æ˜¯æ•´ä¸ª<code>spring security</code>è¿‡æ»¤å™¨é“¾ä¸Šçš„æœ€åä¸€ä¸ªï¼Œå®ƒæ˜¯æœ€ç»ˆçš„å®ˆé—¨äººï¼Œå®ƒé—¨åå°±æ˜¯æˆ‘ä»¬ç¼–å†™çš„<code>rest api</code>ï¼Œåœ¨ä¸ªæ‹¦æˆªå™¨ä¸­å®ƒä¼šå†³å®šå½“å‰è¯·æ±‚èƒ½ä¸èƒ½å»è®¿é—®åé¢çš„<code>rest api</code>ã€‚å®ƒä¼šä¾æ®ä½ ç¼–å†™çš„é…ç½®ï¼ˆ<code>BrowserSecurityConfig</code>ï¼‰è¿›è¡Œåˆ¤æ–­ï¼Œåˆ¤æ–­å½“å‰è¯·æ±‚æ˜¯ä¸æ˜¯ç»è¿‡å‰é¢æŸä¸€ä¸ªè¿‡æ»¤å™¨çš„èº«ä»½è®¤è¯ï¼Œåˆ¤æ–­çš„ç»“æœæ˜¯è¿‡ï¼Œå°±èƒ½è®¿é—®åˆ°<code>rest api</code>ï¼Œå¦‚æœä¸è¿‡ï¼Œå®ƒä¼šæ ¹æ®ä¸è¿‡çš„åŸå› æ¥æŠ›å‡ºä¸åŒçš„å¼‚å¸¸ï¼Œåœ¨å®ƒçš„å‰é¢çš„<code>ExceptionTranslationFilter</code>,è¿™ä¸ªè¿‡æ»¤å™¨ä¼šæ¥æ•è·<code>FilterSecurityInterceptor</code>æŠ›å‡ºæ¥çš„å¼‚å¸¸ï¼Œç„¶åæ ¹æ®ä¸åŒçš„å¼‚å¸¸åšç›¸åº”çš„å¤„ç†ï¼Œæ¯”å¦‚æ˜¯æ²¡æœ‰ç™»å½•ä¸èƒ½è®¿é—®ï¼Œå®ƒä¼šæ ¹æ®å‰é¢çš„é…ç½®å¼•å¯¼ç”¨æˆ·å»ç™»å½•ï¼Œä¾‹å¦‚ä½ é…ç½®çš„æ˜¯<code>formLogin</code>å°±ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œé…ç½®çš„æ˜¯<code>basicLogin</code>ï¼Œå°±æ˜¯å¼¹æ¡†ã€‚åœ¨è¿™é‡Œç»¿è‰²çš„è¿‡æ»¤å™¨ï¼Œä½ æ˜¯å¯ä»¥æ§åˆ¶çš„ï¼Œå…¶ä»–è¿‡æ»¤å™¨ä½ æ˜¯ä¸èƒ½æ§åˆ¶çš„ï¼Œå®ƒä¸€å®šä¼šåœ¨<code>spring security</code>è§„å®šçš„ä½ç½®æ‰§è¡Œã€‚</p><hr><p>ä¸‹é¢debugæ¥åˆ°è¿™å‡ ä¸ªè¿‡æ»¤å™¨ä¸ŠåŠ æ–­ç‚¹</p><p>è¿™ä¸ªæ˜¯ç­‰ä¼šæˆ‘è®¿é—®çš„æ¥å£</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566729706574.png" srcset="/img/loading.gif" alt="1566729706574"></p><hr><p>æ–­ç‚¹ä½ç½®ï¼š</p><ul><li><code>FilterSecurityInterceptor#invoke</code>-&gt;124è¡Œ</li><li><code>ExceptionTranslationFilter#doFilter</code>-&gt;123è¡Œ</li><li><code>ExceptionTranslationFilter#doFilter</code>-&gt;123è¡Œ</li><li><code>UsernamePasswordAuthenticationFilter</code>-&gt;61è¡Œ</li></ul><p>è®¿é—®<a href="http://localhost:8080/user" target="_blank" rel="noopener">http://localhost:8080/user</a></p><p>ç°åœ¨å®ƒæ¥åˆ°äº†ï¼š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566730453087.png" srcset="/img/loading.gif" alt="1566730453087"></p><p>å› ä¸ºè®¿é—®è¿™ä¸ª<code>/user</code>ï¼Œæ²¡å¸¦ç™»å½•ä¿¡æ¯ï¼Œæ‰€ä»¥å‰é¢çš„è¿‡æ»¤å™¨éƒ½ä¸èµ·ä½œç”¨ï¼Œä¸€ç›´è·‘åˆ°<code>FilterSecurityInterceptor</code>é‡Œé¢ï¼Œç”±è¿™ä¸ªæ–­ç‚¹ä½ç½®çš„ä»£ç åšåˆ¤æ–­ï¼šèƒ½ä¸èƒ½è®¿é—®<code>/user</code>æ¥å£</p><p>ç„¶åæ¥ç€æ‰§è¡Œå®Œè¿™é‡Œçš„ä»£ç ï¼Œå®ƒæŠ›å‡ºäº†ä¸€ä¸ªå¼‚å¸¸ï¼Œè¿™ä¸ªå¼‚å¸¸ä¼šæŠ›åˆ°<code>ExceptionTranslationFilter</code>è¿‡æ»¤å™¨ä¸­</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566730671953.png" srcset="/img/loading.gif" alt="1566730671953"></p><p>ç„¶åæ ¹æ®å¼‚å¸¸åšå¤„ç†ï¼Œå› ä¸ºæ²¡ç™»å½•ï¼Œæ‰€ä»¥ä¼šé‡å®šå‘åˆ°ç™»å½•é¡µé¢ä¸Šå»ï¼Œæˆ‘è¿™é‡Œå¡«å†™æ­£ç¡®çš„è´¦å·å’Œå¯†ç è¿›è¡Œç™»å½•ï¼Œè¿™ä¸ªæ—¶å€™ä¼šåœåœ¨<code>UsernamePasswordAuthenticationFilter</code>ï¼Œå®ƒè·å–ç”¨æˆ·å¡«å†™çš„ä¿¡æ¯è¿›è¡Œç™»å½•</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566730843749.png" srcset="/img/loading.gif" alt="1566730843749"></p><p>æ¥ç€å¾€ä¸‹èµ°</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566731054715.png" srcset="/img/loading.gif" alt="1566731054715"></p><p>å®ƒåœ¨è¿™é‡Œåˆæ¥éªŒè¯è¯·æ±‚æ˜¯å¦èƒ½è®¿é—®ï¼Œå†å¾€ä¸‹</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566731095879.png" srcset="/img/loading.gif" alt="1566731095879"></p><p>è¿™å›å®ƒæ²¡æŠ›å¼‚å¸¸äº†ï¼Œæ¥æ‰§è¡Œäº†<code>fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</code>ä»£ç ï¼Œè¿™é‡Œå®é™…ä¸Šä¹Ÿå°±æ˜¯è°ƒç”¨<code>/user</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566731157388.png" srcset="/img/loading.gif" alt="1566731157388"></p>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸€ã€Restful Api ã€‘  3.Restful Api</title>
    <link href="/spring-security-1.3.html"/>
    <url>/spring-security-1.3.html</url>
    
    <content type="html"><![CDATA[<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>åœ¨ä½¿ç”¨<code>spring mvc</code>æ¡†æ¶æ—¶ï¼Œ<code>get</code>ã€<code>post</code>è¯·æ±‚ç”¨å¾—æ˜¯æœ€å¤šå¾—ï¼Œåœ¨ä¸åŒçš„ä¸šåŠ¡åœºæ™¯è¿›è¡Œé€‰æ‹©ï¼Œåœ¨ç¬”è€…èº«è¾¹çš„åŒäº‹ä¸å¤ªæ³¨é‡è¿™äº›ï¼Œå¤¸å¼ ç‚¹å…¨éƒ¨ä½¿ç”¨postè¯·æ±‚ï¼Œè¿™æ ·æ˜¯ä¸åˆç†çš„ï¼Œç¬”è€…æ€»ç»“äº†ä»¥ä¸‹å‡ ç§ï¼š</p><table><thead><tr><th align="center">è¯·æ±‚</th><th align="center">ä¸šåŠ¡åœºæ™¯</th></tr></thead><tbody><tr><td align="center">get</td><td align="center">æŸ¥è¯¢</td></tr><tr><td align="center">post</td><td align="center">æ–°å¢</td></tr><tr><td align="center">put</td><td align="center">ä¿®æ”¹</td></tr><tr><td align="center">delete</td><td align="center">åˆ é™¤</td></tr></tbody></table><blockquote><p>åœ¨å›¢é˜Ÿå¼€å‘ä¸­éƒ½æ ¹æ®è¿™æ ·å»å†™ä»£ç ï¼Œçœ‹ä¸€ä¸ªæ¥å£åšäº†ä»€ä¹ˆè¡Œä¸ºåªéœ€è¦çœ‹è¯·æ±‚æ–¹å¼å°±OKäº†ï¼Œè‰¯å¥½çš„ç¼–ç ä¹ æƒ¯ä½¿ç³»ç»Ÿæ›´å®¹æ˜“ç»´æŠ¤ï¼Œå¦‚æœè¯»è€…ä¹‹å‰æ²¡æœ‰æŒ‰ç…§è¿™æ ·åšï¼Œè¯·ç°åœ¨å¼€å§‹å…»æˆè¿™ç§ä¹ æƒ¯ï¼Œ<strong>è‰¯å¥½çš„ç¼–ç ä¹ æƒ¯å¾ˆé‡è¦</strong>ï¼ï¼ï¼</p><hr><p>ç¬”è€…ä¼šç¼–å†™ä¸€å¥—<code>CRUD</code>ï¼Œç»™è¯»è€…è¿›è¡Œå‚è€ƒ</p></blockquote><h1 id="CRUD"><a href="#CRUD" class="headerlink" title="CRUD"></a>CRUD</h1><p>ä¸ºæŸ¥è¯¢æ¥å£çš„å“åº”å°è£…æˆä¸€ä¸ªç±»</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.model.vo;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> java.io.Serializable;<span class="hljs-meta">@Data</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-meta">@NoArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserVO</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">private</span> String userId;    <span class="hljs-keyword">private</span> String userName;    <span class="hljs-keyword">private</span> String password;&#125;</code></pre><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.controller;<span class="hljs-keyword">import</span> com.b4.mcr.model.vo.UserVO;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;<span class="hljs-keyword">import</span> java.util.Arrays;<span class="hljs-keyword">import</span> java.util.List;<span class="hljs-meta">@RestController</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/user"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>&#123;    <span class="hljs-meta">@GetMapping</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title">query</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> Arrays.asList(                <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"001"</span>, <span class="hljs-string">"t1"</span>, <span class="hljs-string">"t1"</span>),                <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"002"</span>, <span class="hljs-string">"t2"</span>, <span class="hljs-string">"t2"</span>),                <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"003"</span>, <span class="hljs-string">"t3"</span>, <span class="hljs-string">"t3"</span>)        );    &#125;    <span class="hljs-meta">@PostMapping</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(@RequestBody UserVO userVO)</span> </span>&#123;        <span class="hljs-comment">//æ–°å¢é€»è¾‘</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;    <span class="hljs-meta">@PutMapping</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">update</span><span class="hljs-params">(@RequestBody UserVO userVO)</span> </span>&#123;        <span class="hljs-comment">//ä¿®æ”¹é€»è¾‘</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;    <span class="hljs-meta">@DeleteMapping</span>(<span class="hljs-string">"/&#123;id&#125;"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">delete</span><span class="hljs-params">(@PathVariable String id)</span> </span>&#123;        <span class="hljs-comment">//åˆ é™¤é€»è¾‘</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/&#123;id&#125;"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> UserVO <span class="hljs-title">geInfo</span><span class="hljs-params">(@PathVariable String id)</span> </span>&#123;               <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"t001"</span>, <span class="hljs-string">"t1"</span>, <span class="hljs-string">"t1"</span>);    &#125;&#125;</code></pre><h2 id="æŸ¥è¯¢æ¥å£"><a href="#æŸ¥è¯¢æ¥å£" class="headerlink" title="æŸ¥è¯¢æ¥å£"></a>æŸ¥è¯¢æ¥å£</h2><p>ä»åˆšåˆšç¼–å†™çš„<code>list</code>æ–¹æ³•ä¸­ï¼Œæˆ‘ä¸å¸Œæœ›å°†æ‰€æœ‰å­—æ®µç»™å‰ç«¯å±•ç¤ºï¼Œè€Œè¿™ä¸ª<code>get</code>æ–¹æ³•è¦æ ¹æ®è§’è‰²çš„æƒé™æ‰èƒ½è®¿é—®ï¼Œä¾‹å¦‚adminï¼Œå¯ä»¥æŸ¥çœ‹æŒ‡å®šè´¦å·çš„å¯†ç ã€‚æˆ‘ä»¬åœ¨å¼€å‘ä¸­ï¼Œå‡è®¾ä½¿ç”¨çš„æ˜¯<code>mybatis plus</code>æ¡†æ¶ï¼Œé€šè¿‡è°ƒç”¨å®ƒè‡ªå¸¦çš„<code>get</code>ã€<code>getOne</code>æ–¹æ³•éƒ½æ˜¯å…¨å­—æ®µæŸ¥è¯¢ï¼Œå“ªæ”¹æ€ä¹ˆåŠï¼Ÿè¦è‡ªå·±åŠ¨æ‰‹å†™<code>mapper.xml</code>ï¼Œå°±ä¸ºäº†å°‘ä¸€ä¸ªå¯†ç å­—æ®µï¼Ÿé‚£å¦‚æœå“ªä¸€å¤©è¿™ä¸ªè¡¨å¯èƒ½å¤šäº†ä¸€ä¸ªå­—æ®µï¼Œåˆè¦æ”¹<code>mapper.xml</code>ä¸­çš„è¿™ä¸ªè¯­å¥ï¼Œæƒ³æƒ³éƒ½è§‰å¾—ç—›è‹¦ï¼Œç¬”è€…è¿™é‡Œä¼šç»™è¯»è€…ä»‹ç»ä¸€ä¸ªå¯¹è¿™ç§ä¸šåŠ¡åœºæ™¯ï¼Œéå¸¸é€‚ç”¨çš„è§£å†³æ–¹æ¡ˆâ€”â€”<code>@JsonView</code>æ³¨è§£ï¼Œä½¿ç”¨æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨æ¥å£æ¥å£°æ˜å¤šä¸ªè§†å›¾</li><li>åœ¨å€¼å¯¹è±¡çš„<code>get</code>æ–¹æ³•ä¸ŠæŒ‡å®šè§†å›¾</li><li>åœ¨<code>Controller</code>æ–¹æ³•ä¸ŠæŒ‡å®šè§†å›¾</li></ul><h2 id="abbrlink-1"><a href="#abbrlink-1" class="headerlink" title="abbrlink: 1"></a>abbrlink: 1</h2><p>åœ¨<code>UserVO</code>çš„ä¸­å£°æ˜äº† 2ä¸ªæ¥å£<code>UserSimpleView</code>ã€<code>UserDetailView</code>ï¼Œ<code>UserDetailView</code>æ¥å£ç»§æ‰¿ä¸<code>UserSimpleView</code>æ¥å£ï¼Œ<code>userName</code>å±æ€§ä¸Šä¿®é¥°äº†<code>@JsonView</code>ï¼ŒæŒ‡å®šçš„æ˜¯<code>UserSimpleView</code>å±æ€§ï¼Œè€Œ<code>password</code>æŒ‡å®šçš„æ˜¯<code>UserDetailView</code>ï¼Œç”±äº<code>UserDetailView</code>ç»§æ‰¿äº<code>UserSimpleView</code>ï¼Œæ‰€ä»¥å®ƒä¹ŸåŒ…å«äº†<code>userName</code></p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.model.vo;<span class="hljs-keyword">import</span> com.fasterxml.jackson.annotation.JsonView;<span class="hljs-keyword">import</span> lombok.AllArgsConstructor;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-keyword">import</span> java.io.Serializable;<span class="hljs-meta">@Data</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserSimpleView</span> </span>&#123;    &#125;    <span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserDetailView</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">UserSimpleView</span> </span>&#123;    &#125;    <span class="hljs-meta">@JsonView</span>(UserSimpleView<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    <span class="hljs-title">private</span> <span class="hljs-title">String</span> <span class="hljs-title">userName</span></span>;    <span class="hljs-meta">@JsonView</span>(UserDetailView<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    <span class="hljs-title">private</span> <span class="hljs-title">String</span> <span class="hljs-title">password</span></span>;&#125;</code></pre><p>åœ¨<code>UserController</code>çš„<code>list</code>ã€<code>get</code>æ–¹æ³•ä¸Šå£°æ˜</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span><span class="hljs-meta">@JsonView</span>(UserVO.UserSimpleView<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">UserVO</span>&gt; <span class="hljs-title">query</span>() </span>&#123;    <span class="hljs-keyword">return</span> Arrays.asList(            <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"t1"</span>, <span class="hljs-string">"t1"</span>),            <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"t2"</span>, <span class="hljs-string">"t2"</span>),            <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"t3"</span>, <span class="hljs-string">"t3"</span>)    );&#125;<span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/&#123;id&#125;"</span>)<span class="hljs-meta">@JsonView</span>(UserVO.UserDetailView<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> <span class="hljs-title">UserVO</span> <span class="hljs-title">geInfo</span>(@<span class="hljs-title">PathVariable</span> <span class="hljs-title">String</span> <span class="hljs-title">id</span>) </span>&#123;    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> UserVO(<span class="hljs-string">"t1"</span>, <span class="hljs-string">"t1"</span>);&#125;</code></pre><p>listæ–¹æ³•çš„å“åº”ï¼š</p><pre><code class="hljs json">[    &#123;        <span class="hljs-attr">"userName"</span>: <span class="hljs-string">"t1"</span>    &#125;,    &#123;        <span class="hljs-attr">"userName"</span>: <span class="hljs-string">"t2"</span>    &#125;,    &#123;        <span class="hljs-attr">"userName"</span>: <span class="hljs-string">"t3"</span>    &#125;]</code></pre><p>getæ–¹æ³•çš„å“åº”ï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"userName"</span>: <span class="hljs-string">"t1"</span>,    <span class="hljs-attr">"password"</span>: <span class="hljs-string">"t1"</span>&#125;</code></pre><h2 id="æ–°å¢ã€ä¿®æ”¹æ¥å£"><a href="#æ–°å¢ã€ä¿®æ”¹æ¥å£" class="headerlink" title="æ–°å¢ã€ä¿®æ”¹æ¥å£"></a>æ–°å¢ã€ä¿®æ”¹æ¥å£</h2><p>åœ¨åšæ–°å¢å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œè‚¯å®šä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªåœºæ™¯ï¼šå¯¹å®¢æˆ·ç«¯ä¼ é€’è¿‡æ¥çš„æ•°æ®è¿›è¡Œæ ¡éªŒï¼Œé€šè¿‡ifä¼ ç»Ÿçš„æ–¹å¼æ¥è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ä¿¡æ¯å°±å“åº”ç›¸å…³çš„æç¤ºä¿¡æ¯ï¼Œé¦–å…ˆè¿™æ ·å†™æ˜¯æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œä½†æ˜¯å„ç§ifçš„é€»è¾‘åœ¨å®é™…çš„å¼€å‘ä¸­å¾ˆå®¹æ˜“å‡ºç°å„ç§é—®é¢˜ï¼Œåšçš„å¥½ä¸€ç‚¹ï¼Œå¯ä»¥æŠ½è±¡æˆä¸€ä¸ªæ–¹æ³•ï¼Œåšçš„ä¸å¥½ä¸€ç‚¹å¯èƒ½ä¼šå‡ºç°å¤åˆ¶å‡ºç°å¤§é‡å†—ä½™çš„ä»£ç ï¼Œä¸€æ—¦å‡ºç°å¤åˆ¶ï¼Œåœ¨ä¿®æ”¹çš„æ—¶å€™å°±å¾ˆéº»çƒ¦ï¼Œéœ€è¦ä¸€ä¸ªä¸ªè¿›è¡Œä¿®æ”¹ï¼Œç¬”è€…ä¼šåœ¨è¿™é‡Œé€šè¿‡ä¸€äº›åŠæ³•æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>ä¼ ç»Ÿæ–¹å¼ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">if</span>(StringUtils.isBlank(userVO.getXXX()))&#123;<span class="hljs-keyword">if</span>(...)     <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> ...&#125;<span class="hljs-keyword">if</span> ...</code></pre><p>è§£å†³æ–¹æ¡ˆï¼š</p><p>åœ¨<code>org.hibernate.validator</code>è¿™ä¸ªåŒ…ä¸‹é¢æä¾›äº†ä¸€äº›æ ¡éªŒæ³¨è§£ï¼Œé€šè¿‡è¿™äº›æ³¨è§£å°±èƒ½è½»æ¾çš„è¿›è¡Œæ•°æ®æ•ˆéªŒ</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566701442199.png" srcset="/img/loading.gif" alt="1566701442199"></p><p>åœ¨<code>UserVO</code>ä¸­çš„ä½¿ç”¨<code>NotBlank</code>æ³¨è§£æ¥ä¿®é¥°passwordå±æ€§ï¼Œæ·»åŠ ä¸Šè¿™ä¸ªæ³¨è§£å°±å¯ä»¥ä¸ç”¨åœ¨æ§åˆ¶å™¨ä¸­å†™ifåˆ¤æ–­æ•°æ®æ˜¯ä¸æ˜¯ç©ºäº†</p><pre><code class="hljs java"><span class="hljs-meta">@Data</span><span class="hljs-meta">@AllArgsConstructor</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserVO</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span> </span>&#123;   <span class="hljs-comment">//...</span>    <span class="hljs-meta">@NotBlank</span>    <span class="hljs-keyword">private</span> String password;&#125;</code></pre><p>æˆ‘ä»¬è¿˜è¦åœ¨æ§åˆ¶å™¨çš„å‚æ•°ä¸­åŠ ä¸Š<code>Valid</code>æ³¨è§£æ¥å‘Šè¯‰è¿™é‡Œçš„å‚æ•°éœ€è¦éªŒè¯</p><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(@Valid @RequestBody UserVO userVO)</span> </span>&#123;   <span class="hljs-comment">//...</span>  &#125;</code></pre><p>ç°åœ¨é€šè¿‡<code>post man</code>å·¥å…·è¿›è¡Œè®¿é—®è¿™ä¸ªæ¥å£ï¼ˆå¦‚æœè¯»è€…ä¸æ¸…æ¥špost manæ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå¯ä»¥æ¥çœ‹ä¸‹è¿™ä¸ª<a href="https://www.jianshu.com/p/6c9b45994c34" target="_blank" rel="noopener">æ–‡æ¡£</a>ï¼‰</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566701998934.png" srcset="/img/loading.gif" alt="1566701998934"></p><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œæ ¡éªŒæ˜¯é€šè¿‡çš„ï¼Œè¿™é‡Œè¿˜éœ€è¦åŠ ä¸Šä¸€ä¸ª<code>BindingResult</code>å‚æ•°ï¼Œå®ƒé‡Œé¢å­˜å‚¨äº†è¿™äº›é”™è¯¯ä¿¡æ¯ï¼Œ</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add</span><span class="hljs-params">(@Valid @RequestBody UserVO userVO, BindingResult errors)</span> </span>&#123;        <span class="hljs-keyword">if</span> (errors.hasErrors()) &#123;            errors.getAllErrors().forEach(error -&gt; System.out.println(error.getDefaultMessage()));            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;        &#125;        <span class="hljs-comment">//æ–°å¢é€»è¾‘</span>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;</code></pre><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566702315546.png" srcset="/img/loading.gif" alt="1566702315546"></p><p>è¿™é‡Œè¿˜æœ‰å…¶ä»–çš„æ³¨è§£ï¼Œç¬”è€…å°±ä¸ä¸€ä¸€åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è‡ªå·±æ¥è¯•ä¸€ä¸‹</p><table><thead><tr><th align="center">æ³¨è§£</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">@NotNull</td><td align="center">å€¼ä¸èƒ½ä¸ºç©º</td></tr><tr><td align="center">@Null</td><td align="center">å€¼å¿…é¡»ä¸ºç©º</td></tr><tr><td align="center">@Pattern(regex=)</td><td align="center">å­—ç¬¦ä¸²å¿…é¡»åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼</td></tr><tr><td align="center">@Size(min=,max=)</td><td align="center">é›†åˆçš„å…ƒç´ å¿…é¡»åœ¨minå’Œmaxä¹‹é—´</td></tr><tr><td align="center">@CreditCardNumber</td><td align="center">å­—ç¬¦ä¸²å¿…é¡»æ˜¯ä¿¡ç”¨å¡å·ï¼ˆæŒ‰ç¾å›½çš„æ ‡å‡†éªŒè¯ï¼‰</td></tr><tr><td align="center">@Email</td><td align="center">å­—ç¬¦ä¸²å¿…é¡»æ˜¯Emailåœ°å€</td></tr><tr><td align="center">@Length(min=,max=)</td><td align="center">æ£€æŸ¥å­—ç¬¦ä¸²çš„é•¿åº¦</td></tr><tr><td align="center">@NotBlank</td><td align="center">å­—ç¬¦ä¸²å¿…é¡»æœ‰å­—ç¬¦</td></tr><tr><td align="center">@NotEmpty</td><td align="center">å­—ç¬¦ä¸²ä¸èƒ½ä¸ºnullï¼Œé›†åˆç”±å…ƒç´ </td></tr><tr><td align="center">@Range(min=,max=)</td><td align="center">æ•°å­—å¿…é¡»å¤§äºç­‰äºminï¼Œå°äºç­‰äºmax</td></tr><tr><td align="center">@SafeHtml</td><td align="center">å­—ç¬¦ä¸²æ˜¯å®‰å…¨çš„html</td></tr><tr><td align="center">@URL</td><td align="center">å­—ç¬¦ä¸²æ˜¯åˆæ³•çš„URL</td></tr><tr><td align="center">@AssertFalse</td><td align="center">å€¼å¿…é¡»æ˜¯false</td></tr><tr><td align="center">@AssertTrue</td><td align="center">å€¼å¿…é¡»æ˜¯true</td></tr><tr><td align="center">@DecimalMax(value=,inclusive=)</td><td align="center">å€¼å¿…é¡»å°äºç­‰ï¼ˆinclusive=trueï¼‰/å°äºï¼ˆinclusive=falseï¼‰,valueå±æ€§æŒ‡å®šçš„å€¼ã€‚å¯ä»¥æ³¨è§£åœ¨å­—ç¬¦ä¸²ç±»å‹å±æ€§ä¸Š</td></tr><tr><td align="center">@DecimalMin(value=,inclusive=)</td><td align="center">å€¼å¿…é¡»å¤§äºç­‰ï¼ˆinclusive=trueï¼‰/å¤§äºï¼ˆinclusive=falseï¼‰,valueå±æ€§æŒ‡å®šçš„å€¼ã€‚å¯ä»¥æ³¨è§£åœ¨å­—ç¬¦ä¸²ç±»å‹å±æ€§ä¸Š</td></tr><tr><td align="center">@Digits</td><td align="center">æ•°å­—æ ¼å¼æ£€æŸ¥ã€‚integeræŒ‡å®šæ•´æ•°éƒ¨åˆ†çš„æœ€å¤§é•¿åº¦ï¼ŒfractionæŒ‡å®šå°æ•°éƒ¨åˆ†çš„æœ€å¤§é•¿åº¦</td></tr><tr><td align="center">@Future</td><td align="center">å€¼å¿…é¡»æ˜¯æœªæ¥çš„æ—¥æœŸ</td></tr><tr><td align="center">@Past</td><td align="center">å€¼å¿…é¡»æ˜¯è¿‡å»çš„æ—¥æœŸ</td></tr><tr><td align="center">@Max</td><td align="center">å€¼å¿…é¡»å°äºç­‰äºvalueæŒ‡å®šçš„å€¼ã€‚ä¸èƒ½æ³¨è§£åœ¨å­—ç¬¦ä¸²ç±»å‹çš„å±æ€§ä¸Š</td></tr><tr><td align="center">@Min</td><td align="center">å€¼å¿…é¡»å¤§äºç­‰äºvalueæŒ‡å®šçš„å€¼ã€‚ä¸èƒ½æ³¨è§£åœ¨å­—ç¬¦ä¸²ç±»å‹çš„å±æ€§ä¸Š</td></tr></tbody></table><hr><p><code>Hibernate Validator</code>ä¸­æä¾›äº†ä¸€å¥—æ•ˆéªŒæ³¨è§£ä¾›æˆ‘ä»¬ä½¿ç”¨ï¼Œå¯åœ¨ä¸€äº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œè¿™äº›æ³¨è§£æ˜¯æ˜æ˜¾ä¸å¤Ÿç”¨çš„ï¼Œè¿™é‡Œç¬”è€…ä¼šå¸¦ç€å¤§å®¶æ¥è‡ªå®šä¹‰è¿™ç§æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.validator;<span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<span class="hljs-keyword">import</span> java.lang.annotation.Retention;<span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<span class="hljs-keyword">import</span> java.lang.annotation.Target;<span class="hljs-keyword">import</span> javax.validation.Constraint;<span class="hljs-keyword">import</span> javax.validation.Payload;<span class="hljs-meta">@Target</span>(&#123;ElementType.METHOD, ElementType.FIELD&#125;)<span class="hljs-meta">@Retention</span>(RetentionPolicy.RUNTIME)<span class="hljs-meta">@Constraint</span>(validatedBy = MyConstraintValidator<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class"><span class="hljs-title">public</span> @<span class="hljs-title">interface</span> <span class="hljs-title">MyConstraint</span> </span>&#123;<span class="hljs-function">String <span class="hljs-title">message</span><span class="hljs-params">()</span></span>;Class&lt;?&gt;[] groups() <span class="hljs-keyword">default</span> &#123; &#125;;Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword">default</span> &#123; &#125;;&#125;</code></pre><p>è¿™é‡Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªæ³¨è§£ç±»ï¼š<code>MyConstraint</code>ï¼Œå®ƒé‡Œé¢æœ‰<code>message</code>ã€<code>groups</code>ã€<code>payload</code>è¿™3ä¸ªæ–¹æ³•ï¼Œè¿™é‡Œæ˜¯æ ¹æ®<code>Hibernate Validator</code>çš„çº¦å®šæ¥çš„ï¼Œæ˜¯ä¸è¡Œè¦æœ‰çš„3ä¸ªæ–¹æ³•ï¼Œä½œç”¨ç¬”è€…ä¸ä¸€ä¸€ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»çœ‹<a href="https://hibernate.org/validator/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p>è¦å¯¹<code>MyConstraint</code>æ¥å£å®ç°æ ¡éªŒï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªç±»å®ç°<code>ConstraintValidator</code>æ¥å£ï¼Œå¹¶ä¸”åœ¨<code>MyConstraint</code>æ³¨è§£ç±»ä¸Šé€šè¿‡<code>@Constraint(validatedBy = xxx.class)</code>ï¼Œæ¥æ ‡è¯†æ•ˆéªŒå™¨ï¼Œå…ˆä¸æ€¥ç€å†™ï¼Œæ¥çœ‹çœ‹å®ƒé‡Œé¢çš„æºç æ˜¯æ€ä¹ˆå†™çš„ï¼Œæ¥çœ‹çœ‹<code>ConstraintValidator</code>ç±»</p><pre><code class="hljs java"><span class="hljs-comment">/*</span><span class="hljs-comment">* JBoss, Home of Professional Open Source</span><span class="hljs-comment">* Copyright 2009, Red Hat, Inc. and/or its affiliates, and individual contributors</span><span class="hljs-comment">* by the @authors tag. See the copyright.txt in the distribution for a</span><span class="hljs-comment">* full listing of individual contributors.</span><span class="hljs-comment">*</span><span class="hljs-comment">* Licensed under the Apache License, Version 2.0 (the "License");</span><span class="hljs-comment">* you may not use this file except in compliance with the License.</span><span class="hljs-comment">* You may obtain a copy of the License at</span><span class="hljs-comment">* http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment">* Unless required by applicable law or agreed to in writing, software</span><span class="hljs-comment">* distributed under the License is distributed on an "AS IS" BASIS,</span><span class="hljs-comment">* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="hljs-comment">* See the License for the specific language governing permissions and</span><span class="hljs-comment">* limitations under the License.</span><span class="hljs-comment">*/</span><span class="hljs-keyword">package</span> javax.validation;<span class="hljs-keyword">import</span> javax.validation.constraintvalidation.SupportedValidationTarget;<span class="hljs-keyword">import</span> java.lang.annotation.Annotation;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Defines the logic to validate a given constraint &#123;<span class="hljs-doctag">@code</span> A&#125;</span><span class="hljs-comment"> * for a given object type &#123;<span class="hljs-doctag">@code</span> T&#125;.</span><span class="hljs-comment"> * &lt;p/&gt;</span><span class="hljs-comment"> * Implementations must comply to the following restriction:</span><span class="hljs-comment"> * &lt;ul&gt;</span><span class="hljs-comment"> *     &lt;li&gt;&#123;<span class="hljs-doctag">@code</span> T&#125; must resolve to a non parameterized type&lt;/li&gt;</span><span class="hljs-comment"> *     &lt;li&gt;or generic parameters of &#123;<span class="hljs-doctag">@code</span> T&#125; must be unbounded</span><span class="hljs-comment"> *     wildcard types&lt;/li&gt;</span><span class="hljs-comment"> * &lt;/ul&gt;</span><span class="hljs-comment"> * &lt;p/&gt;</span><span class="hljs-comment"> * The annotation &#123;<span class="hljs-doctag">@link</span> SupportedValidationTarget&#125; can be put on a</span><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> ConstraintValidator&#125; implementation to mark it as supporting</span><span class="hljs-comment"> * cross-parameter constraints. Check out &#123;<span class="hljs-doctag">@link</span> SupportedValidationTarget&#125;</span><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@link</span> Constraint&#125; for more information.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Emmanuel Bernard</span><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Hardy Ferentschik</span><span class="hljs-comment"> */</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ConstraintValidator</span>&lt;<span class="hljs-title">A</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Annotation</span>, <span class="hljs-title">T</span>&gt; </span>&#123;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Initializes the validator in preparation for</span><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #isValid(Object, ConstraintValidatorContext)&#125; calls.</span><span class="hljs-comment"> * The constraint annotation for a given constraint declaration</span><span class="hljs-comment"> * is passed.</span><span class="hljs-comment"> * &lt;p/&gt;</span><span class="hljs-comment"> * This method is guaranteed to be called before any use of this instance for</span><span class="hljs-comment"> * validation.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> constraintAnnotation annotation instance for a given constraint declaration</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(A constraintAnnotation)</span></span>;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Implements the validation logic.</span><span class="hljs-comment"> * The state of &#123;<span class="hljs-doctag">@code</span> value&#125; must not be altered.</span><span class="hljs-comment"> * &lt;p/&gt;</span><span class="hljs-comment"> * This method can be accessed concurrently, thread-safety must be ensured</span><span class="hljs-comment"> * by the implementation.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> value object to validate</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> context context in which the constraint is evaluated</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> &#123;<span class="hljs-doctag">@code</span> false&#125; if &#123;<span class="hljs-doctag">@code</span> value&#125; does not pass the constraint</span><span class="hljs-comment"> */</span><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(T value, ConstraintValidatorContext context)</span></span>;&#125;</code></pre><p>ç¬”è€…æ•´ç†è¿™2ä¸ªç±»çš„ä½œç”¨ï¼š</p><ul><li>initialize:åˆå§‹åŒ–è‡ªå·±ï¼Œå®ƒè¿™é‡Œçš„<code>constraintAnnotation</code>å‚æ•°æ˜¯<code>Annotation</code>çš„å­ç±»ï¼Œä¹Ÿå°±æ˜¯é‚£äº›æ ¡éªŒçš„æ³¨è§£ï¼Œåœ¨è¿™å¯ä»¥é€šè¿‡è¿™ä¸ªå‚æ•°æ‹¿åˆ°åº”ç”¨å±‚ä¸­å†™çš„<code>message</code>ã€<code>max</code>è¿™äº›å€¼ï¼Œå­˜å‚¨åˆ°è‡ªå·±çš„æˆå‘˜å˜é‡ä¸­</li><li><code>isValid</code>ï¼šæ–¹æ³•ä¸­ç¼–å†™ä½ çš„æ•ˆéªŒé€»è¾‘ï¼Œç¬¬1ä¸ªå‚æ•°<code>value</code>:è·å–è¢«æ³¨è§£çš„å±æ€§ã€æ–¹æ³•çš„å€¼ï¼Œå¦å¤–ä¸€ä¸ªå°±ä¸å¤šè®²ï¼Œå¾ˆå°‘ç”¨å¾—ä¸Šï¼ˆPSï¼šç¬”è€…è¿™é‡Œæ²¡ç”¨è¿‡ï¼Œå“ˆå“ˆï¼‰ï¼Œè¿”å›å€¼æ˜¯<code>true</code>è¡¨ç¤ºéªŒè¯é€šè¿‡ï¼Œfalseè¡¨ç¤ºæ•°æ®æœ‰é—®é¢˜</li></ul><p>æ¥ç€æ¥çœ‹ä¸‹<code>Hibernate Validator</code>æ˜¯å¦‚ä½•å®ç°<code>ConstraintValidator</code>æ¥å£çš„å‘¢ï¼Ÿè¿™é‡Œä»¥<code>NotBlank</code>æ³¨è§£çš„æ•ˆéªŒå™¨ä¸ºä¾‹ï¼Œæˆ‘é€šè¿‡IDEAï¼ŒæŸ¥æ‰¾åˆ°<code>NotBlankValidator</code></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566705844750.png" srcset="/img/loading.gif" alt="1566705844750"></p><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NotBlankValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ConstraintValidator</span>&lt;<span class="hljs-title">NotBlank</span>, <span class="hljs-title">CharSequence</span>&gt; </span>&#123;<span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(NotBlank annotation)</span> </span>&#123;&#125;<span class="hljs-comment">/**</span><span class="hljs-comment"> * Checks that the trimmed string is not empty.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> charSequence The character sequence to validate.</span><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> constraintValidatorContext context in which the constraint is evaluated.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * <span class="hljs-doctag">@return</span> Returns &lt;code&gt;true&lt;/code&gt; if the string is &lt;code&gt;null&lt;/code&gt; or the length of &lt;code&gt;charSequence&lt;/code&gt; between the specified</span><span class="hljs-comment"> *         &lt;code&gt;min&lt;/code&gt; and &lt;code&gt;max&lt;/code&gt; values (inclusive), &lt;code&gt;false&lt;/code&gt; otherwise.</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(CharSequence charSequence, ConstraintValidatorContext constraintValidatorContext)</span> </span>&#123;<span class="hljs-keyword">if</span> ( charSequence == <span class="hljs-keyword">null</span> ) &#123;<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;&#125;<span class="hljs-keyword">return</span> charSequence.toString().trim().length() &gt; <span class="hljs-number">0</span>;&#125;&#125;</code></pre><p>å®ƒè¿™é‡Œ<code>initialize</code>æ²¡æœ‰å†™å†…å®¹ï¼Œæ¥çœ‹è¿™ä¸ª<code>isValid</code>æ–¹æ³•çš„å®ç°ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.validator;<span class="hljs-keyword">import</span> javax.validation.ConstraintValidator;<span class="hljs-keyword">import</span> javax.validation.ConstraintValidatorContext;<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConstraintValidator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ConstraintValidator</span>&lt;<span class="hljs-title">MyConstraint</span>, <span class="hljs-title">Object</span>&gt; </span>&#123;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(MyConstraint constraintAnnotation)</span> </span>&#123;        System.out.println(<span class="hljs-string">"my validator init"</span>);    &#125;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">isValid</span><span class="hljs-params">(Object value, ConstraintValidatorContext context)</span> </span>&#123;        System.out.println(value);        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;    &#125;&#125;</code></pre><p>ç„¶ååœ¨UserVOä¸­çš„usernameæ³¨è§£åˆšåˆšç¼–å†™çš„MyConstraint</p><pre><code class="hljs java"><span class="hljs-meta">@MyConstraint</span>(message = <span class="hljs-string">"test"</span>) <span class="hljs-keyword">private</span> String userName;</code></pre><p>æ¥æµ‹è¯•ä¸€ä¸‹ï¼Œè¿˜æ˜¯é€šè¿‡post manè®¿é—®addæ–¹æ³•</p><p>æ§åˆ¶å°å†…å®¹ï¼š</p><pre><code class="hljs applescript"><span class="hljs-keyword">my</span> validator initt1ä¸èƒ½ä¸ºç©º</code></pre><p>ç›¸ä¿¡ç¬”è€…åœ¨è¿™é‡Œä¹Ÿæ˜ç™½æ ¡éªŒå™¨çš„å£°æ˜å‘¨æœŸäº†ï¼Œå®ƒåœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œå¹¶ä¸ä¼šè¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œåœ¨è°ƒç”¨æ¥å£çš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªæ¥å£çš„å‚æ•°ä¸­çš„å±æ€§ä½¿ç”¨äº†æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„<code>MyConstraint</code>æ³¨è§£ï¼Œå®ƒå°±ä¼šå…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œç„¶åå†è¿›è¡Œæ ¡éªŒ</p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>ç¬”è€…ä¼šé¢†ç€è¯»è€…å…ˆå»æŸ¥çœ‹<code>spring boot</code>ä¸­ç»™æˆ‘ä»¬æä¾›çš„é»˜è®¤é”™è¯¯å¤„ç†ã€‚</p><p>ç°åœ¨è®¿é—®<a href="http://localhost:8080/xxxï¼Œè¿™ä¸ªæ¥å£æ˜¯ä¸å­˜åœ¨çš„ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨å“åº”è¿™ä¹ˆä¸€æ®µå†…å®¹" target="_blank" rel="noopener">http://localhost:8080/xxxï¼Œè¿™ä¸ªæ¥å£æ˜¯ä¸å­˜åœ¨çš„ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨å“åº”è¿™ä¹ˆä¸€æ®µå†…å®¹</a></p><pre><code class="hljs j">Whitelabel Error PageThis application has no explicit mapping for &#x2F;error, so you are seeing this as a fallback.Sun Aug 25 12:24:52 CST 2019There was an unexpected error (type&#x3D;Not Found, status&#x3D;404).No message available</code></pre><p>ä½¿ç”¨<code>post</code>å“åº”å†…å®¹</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"timestamp"</span>: <span class="hljs-number">1566707174774</span>,    <span class="hljs-attr">"status"</span>: <span class="hljs-number">404</span>,    <span class="hljs-attr">"error"</span>: <span class="hljs-string">"Not Found"</span>,    <span class="hljs-attr">"message"</span>: <span class="hljs-string">"No message available"</span>,    <span class="hljs-attr">"path"</span>: <span class="hljs-string">"/user1"</span>&#125;</code></pre><p>å®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæ¥çœ‹çœ‹<code>BasicErrorController</code>ç±»</p><pre><code class="hljs java"><span class="hljs-comment">/*</span><span class="hljs-comment"> * Copyright 2012-2016 the original author or authors.</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the "License");</span><span class="hljs-comment"> * you may not use this file except in compliance with the License.</span><span class="hljs-comment"> * You may obtain a copy of the License at</span><span class="hljs-comment"> *</span><span class="hljs-comment"> *      http://www.apache.org/licenses/LICENSE-2.0</span><span class="hljs-comment"> *</span><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><span class="hljs-comment"> * distributed under the License is distributed on an "AS IS" BASIS,</span><span class="hljs-comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span class="hljs-comment"> * See the License for the specific language governing permissions and</span><span class="hljs-comment"> * limitations under the License.</span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> org.springframework.boot.autoconfigure.web;<span class="hljs-meta">@Controller</span><span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"$&#123;server.error.path:$&#123;error.path:/error&#125;&#125;"</span>)<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicErrorController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractErrorController</span> </span>&#123;<span class="hljs-meta">@RequestMapping</span>(produces = <span class="hljs-string">"text/html"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">errorHtml</span><span class="hljs-params">(HttpServletRequest request,</span></span><span class="hljs-function"><span class="hljs-params">HttpServletResponse response)</span> </span>&#123;HttpStatus status = getStatus(request);Map&lt;String, Object&gt; model = Collections.unmodifiableMap(getErrorAttributes(request, isIncludeStackTrace(request, MediaType.TEXT_HTML)));response.setStatus(status.value());ModelAndView modelAndView = resolveErrorView(request, response, status, model);<span class="hljs-keyword">return</span> (modelAndView == <span class="hljs-keyword">null</span> ? <span class="hljs-keyword">new</span> ModelAndView(<span class="hljs-string">"error"</span>, model) : modelAndView);&#125;<span class="hljs-meta">@RequestMapping</span><span class="hljs-meta">@ResponseBody</span><span class="hljs-keyword">public</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt; error(HttpServletRequest request) &#123;Map&lt;String, Object&gt; body = getErrorAttributes(request,isIncludeStackTrace(request, MediaType.ALL));HttpStatus status = getStatus(request);<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ResponseEntity&lt;Map&lt;String, Object&gt;&gt;(body, status);&#125;<span class="hljs-comment">//...</span>&#125;</code></pre><p><code>errorHtml</code>æ–¹æ³•çš„ä¸Šé¢<code>@RequestMapping(produces = &quot;text/html&quot;)</code>,è¿™ä¹ˆæœ‰æ®µä»£ç ï¼Œåœ¨æµè§ˆå™¨ä¸­è®¿é—®æ—¶ï¼Œè¯·æ±‚å¤´å°±ä¼šå¸¦ä¸Š<code>text/html</code>ï¼Œæ‰€ä»¥å®ƒä¼šè‡ªåŠ¨èµ°åˆ°è¿™é‡Œé¢ï¼Œå¦‚æœä¸æ˜¯æµè§ˆå™¨è®¿é—®ï¼Œæ¯”å¦‚æ˜¯<code>post man</code>æˆ–è€…APPé€šè¿‡http clientæ¥è®¿é—®æ˜¯ä¸ä¼šå¸¦ä¸Š<code>text/html</code>è¿™æ ·çš„è¯·æ±‚å¤´çš„ï¼Œæ‰€ä»¥å®ƒä¼šè¿›erroræ–¹æ³•ä¸­ï¼Œè¿™ä¸ªæ–¹æ³•æ³¨è§£äº†<code>@ResponseBody</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¼šå“åº”<code>json</code>æ ¼å¼çš„æ•°æ®</p><p>è¿™é‡Œæˆ‘åœ¨<code>UserController</code>ä¸­å†åˆ›ä¸€ä¸ªæ¥å£</p><pre><code class="hljs java"><span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">"/v2"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">add2</span><span class="hljs-params">(@Valid @RequestBody UserVO userVO)</span> </span>&#123;       <span class="hljs-comment">//æ–°å¢é€»è¾‘</span>       <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;   &#125;</code></pre><p>ä½¿ç”¨<code>post man</code>è¿›è¡Œè®¿é—®ï¼Œè¿™é‡Œä¼ é€’ä¸€ä¸ªç©º<code>json</code>ï¼Œå“åº”ç»“æœï¼š</p><pre><code class="hljs json">&#123;    <span class="hljs-attr">"timestamp"</span>: <span class="hljs-number">1566708165191</span>,    <span class="hljs-attr">"status"</span>: <span class="hljs-number">400</span>,    <span class="hljs-attr">"error"</span>: <span class="hljs-string">"Bad Request"</span>,    <span class="hljs-attr">"exception"</span>: <span class="hljs-string">"org.springframework.web.bind.MethodArgumentNotValidException"</span>,    <span class="hljs-attr">"errors"</span>: [        &#123;            <span class="hljs-attr">"codes"</span>: [                <span class="hljs-string">"NotBlank.userVO.password"</span>,                <span class="hljs-string">"NotBlank.password"</span>,                <span class="hljs-string">"NotBlank.java.lang.String"</span>,                <span class="hljs-string">"NotBlank"</span>            ],            <span class="hljs-attr">"arguments"</span>: [                &#123;                    <span class="hljs-attr">"codes"</span>: [                        <span class="hljs-string">"userVO.password"</span>,                        <span class="hljs-string">"password"</span>                    ],                    <span class="hljs-attr">"arguments"</span>: <span class="hljs-literal">null</span>,                    <span class="hljs-attr">"defaultMessage"</span>: <span class="hljs-string">"password"</span>,                    <span class="hljs-attr">"code"</span>: <span class="hljs-string">"password"</span>                &#125;            ],            <span class="hljs-attr">"defaultMessage"</span>: <span class="hljs-string">"ä¸èƒ½ä¸ºç©º"</span>,            <span class="hljs-attr">"objectName"</span>: <span class="hljs-string">"userVO"</span>,            <span class="hljs-attr">"field"</span>: <span class="hljs-string">"password"</span>,            <span class="hljs-attr">"rejectedValue"</span>: <span class="hljs-literal">null</span>,            <span class="hljs-attr">"bindingFailure"</span>: <span class="hljs-literal">false</span>,            <span class="hljs-attr">"code"</span>: <span class="hljs-string">"NotBlank"</span>        &#125;    ],    <span class="hljs-attr">"message"</span>: <span class="hljs-string">"Validation failed for object='userVO'. Error count: 1"</span>,    <span class="hljs-attr">"path"</span>: <span class="hljs-string">"/user/v2"</span>&#125;</code></pre><p>å®ç°æµè§ˆå™¨ä¸­å¦‚æœå‡ºç°404å¼‚å¸¸ï¼Œå°±è·³è½¬åˆ°æŒ‡å®šé¡µé¢</p><p>åœ¨demoæ¨¡å—ä¸­åˆ›å»º<code>404.html</code>ï¼Œå½“ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¯·æ±‚å¦‚æœå‘ç”Ÿ404ï¼Œå°±ä¼šåˆ°è¿™ä¸ªé¡µé¢ä¸Š</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566712743738.png" srcset="/img/loading.gif" alt="1566712743738"></p><p>å®ç°å®¢æˆ·ç«¯è®¿é—®æ¥å£å‡ºç°å¼‚å¸¸ï¼Œå“åº”ç›¸å…³çš„æç¤ºjson</p><p>åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.exception;<span class="hljs-keyword">import</span> lombok.Data;<span class="hljs-meta">@Data</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserNotExistException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RuntimeException</span> </span>&#123;    <span class="hljs-keyword">private</span> String id;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserNotExistException</span><span class="hljs-params">(String id)</span> </span>&#123;        <span class="hljs-keyword">super</span>(<span class="hljs-string">"user not exist"</span>);        <span class="hljs-keyword">this</span>.id = id;    &#125;&#125;</code></pre><p>åœ¨UserControllerä¸­ç¼–å†™ä¸€ä¸ªæ–¹æ³•ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/v2"</span>)  <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title">query2</span><span class="hljs-params">()</span> </span>&#123;      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UserNotExistException(<span class="hljs-string">"1"</span>);  &#125;</code></pre><p>ç¼–å†™ä¸€ä¸ªå¤„ç†<code>UserNotExistException</code>å¼‚å¸¸çš„å¤„ç†å™¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.controller;<span class="hljs-keyword">import</span> com.b4.mcr.exception.UserNotExistException;<span class="hljs-keyword">import</span> org.springframework.http.HttpStatus;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ControllerAdvice;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ExceptionHandler;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.ResponseStatus;<span class="hljs-keyword">import</span> java.util.HashMap;<span class="hljs-keyword">import</span> java.util.Map;<span class="hljs-meta">@ControllerAdvice</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ControllerExceptionHandler</span> </span>&#123;    <span class="hljs-meta">@ExceptionHandler</span>(UserNotExistException<span class="hljs-class">.<span class="hljs-keyword">class</span>)</span><span class="hljs-class">    @<span class="hljs-title">ResponseBody</span></span><span class="hljs-class">    @<span class="hljs-title">ResponseStatus</span>(<span class="hljs-title">HttpStatus</span>.<span class="hljs-title">INTERNAL_SERVER_ERROR</span>)</span><span class="hljs-class">    <span class="hljs-title">public</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt; <span class="hljs-title">handleUserNotExistException</span>(<span class="hljs-title">UserNotExistException</span> <span class="hljs-title">ex</span>) </span>&#123;        Map&lt;String, Object&gt; result = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();        result.put(<span class="hljs-string">"id"</span>, ex.getId());        result.put(<span class="hljs-string">"message"</span>, ex.getMessage());        <span class="hljs-keyword">return</span> result;    &#125;&#125;</code></pre><blockquote><p>è¿™é‡Œé€šè¿‡ExceptionHandleræ³¨è§£æ¥ç›‘å¬UserNotExistExceptionå¼‚å¸¸ï¼Œè¿™é‡Œæ˜¯å¯ä»¥ç›‘å¬å¤šä¸ªçš„</p></blockquote><p>è®¿é—®<a href="http://localhost:8080/user/v2ï¼Œå“åº”ç»“æœï¼š" target="_blank" rel="noopener">http://localhost:8080/user/v2ï¼Œå“åº”ç»“æœï¼š</a></p><pre><code class="hljs java">&#123;    <span class="hljs-string">"id"</span>: <span class="hljs-string">"1"</span>,    <span class="hljs-string">"message"</span>: <span class="hljs-string">"user not exist"</span>&#125;</code></pre><h1 id="æ‹¦æˆªRestæœåŠ¡"><a href="#æ‹¦æˆªRestæœåŠ¡" class="headerlink" title="æ‹¦æˆªRestæœåŠ¡"></a>æ‹¦æˆªRestæœåŠ¡</h1><p>åœ¨æŸäº›ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬è¦å¯¹ä¸€äº›<code>restful api</code>åšä¸€äº›ç»Ÿä¸€çš„å¤„ç†ï¼Œè¿™é‡Œå°±å¯ä»¥ä½¿ç”¨æ‹¦æˆªæ¥å®ç°ï¼Œæ‹¦æˆªçš„æ–¹å¼æœ‰3ç§ï¼š</p><ul><li>è¿‡æ»¤å™¨ï¼ˆFilterï¼‰</li><li>æ‹¦æˆªå™¨ï¼ˆInterceptorï¼‰</li><li>åˆ‡ç‰‡ï¼ˆAspectï¼‰</li></ul><p>è¿™é‡Œæœ‰ä¸ªä¸šåŠ¡åœºæ™¯ï¼šè®°å½•æ‰€æœ‰çš„apiå¤„ç†æ—¶é—´</p><h2 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h2><pre><code class="hljs java"><span class="hljs-comment">/**</span><span class="hljs-comment"> * </span><span class="hljs-comment"> */</span><span class="hljs-keyword">package</span> com.b4.mcr.web.filter;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> java.io.IOException;<span class="hljs-keyword">import</span> java.util.Date;<span class="hljs-keyword">import</span> javax.servlet.Filter;<span class="hljs-keyword">import</span> javax.servlet.FilterChain;<span class="hljs-keyword">import</span> javax.servlet.FilterConfig;<span class="hljs-keyword">import</span> javax.servlet.ServletException;<span class="hljs-keyword">import</span> javax.servlet.ServletRequest;<span class="hljs-keyword">import</span> javax.servlet.ServletResponse;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Filter</span> </span>&#123;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see javax.servlet.Filter#destroy()</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> </span>&#123;System.out.println(<span class="hljs-string">"time filter destroy"</span>);&#125;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see javax.servlet.Filter#doFilter(javax.servlet.ServletRequest, javax.servlet.ServletResponse, javax.servlet.FilterChain)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doFilter</span><span class="hljs-params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> IOException, ServletException </span>&#123;System.out.println(<span class="hljs-string">"time filter start"</span>);<span class="hljs-keyword">long</span> start = <span class="hljs-keyword">new</span> Date().getTime();chain.doFilter(request, response);System.out.println(<span class="hljs-string">"time filter è€—æ—¶:"</span>+ (<span class="hljs-keyword">new</span> Date().getTime() - start));System.out.println(<span class="hljs-string">"time filter finish"</span>);&#125;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see javax.servlet.Filter#init(javax.servlet.FilterConfig)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">(FilterConfig arg0)</span> <span class="hljs-keyword">throws</span> ServletException </span>&#123;System.out.println(<span class="hljs-string">"time filter init"</span>);&#125;&#125;</code></pre><blockquote><p>ç¬”è€…è¿™é‡Œä½¿ç”¨äº†    <code>System.out.println()</code>ï¼Œåœ¨å®é™…å¼€å‘ä¸­å»ºè®®ä½¿ç”¨loggerï¼Œå› ä¸ºå®ƒæœ‰é”ï¼Œå½±å“æ€§èƒ½</p></blockquote><p>è¿™æ ·æ˜¯é’ˆå¯¹æ‰€æœ‰æ¥å£å»æ‹¦æˆªï¼Œç°åœ¨å¯èƒ½å¸Œæœ›åªé’ˆå¯¹ä¸€äº›æ¥å£å»æ‹¦æˆªè¯¥æ€ä¹ˆåšï¼Ÿé¦–å…ˆå»é™¤TimeFilterç±»çš„Componentæ³¨è§£ï¼Œç„¶åç¼–å†™ä¸€ä¸ªConfigç±»ï¼Œè¿›è¡Œé…ç½®ï¼Œè¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿæ¯”å¦‚ä½ å¸Œæœ›è¿™ä¸ªè¿‡æ»¤å™¨åªåœ¨å¼€å‘ã€æµ‹è¯•ç¯å¢ƒä¸Šä½¿ç”¨ï¼Œè€Œç”Ÿäº§ç¯å¢ƒä¸­ä¸ä½¿ç”¨ï¼Œå°±å¯ä»¥é€šè¿‡Profileæ³¨è§£æ¥æ§åˆ¶ï¼Œè¿™é‡Œè¯»è€…ä¸ä¼šå»ä»‹ç»Profileæ³¨è§£ï¼Œæ„Ÿå…´è¶£å»ç™¾åº¦å§~</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.config;<span class="hljs-keyword">import</span> com.b4.mcr.web.filter.TimeFilter;<span class="hljs-keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<span class="hljs-keyword">import</span> java.util.Arrays;<span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> </span>&#123;    <span class="hljs-meta">@Bean</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">timeFilter</span><span class="hljs-params">()</span> </span>&#123;        FilterRegistrationBean registrationbean = <span class="hljs-keyword">new</span> FilterRegistrationBean(<span class="hljs-keyword">new</span> TimeFilter());        registrationbean.setUrlPatterns(Arrays.asList(<span class="hljs-string">"/*"</span>));        <span class="hljs-keyword">return</span> registrationbean;    &#125;&#125;</code></pre><h2 id="æ‹¦æˆªå™¨"><a href="#æ‹¦æˆªå™¨" class="headerlink" title="æ‹¦æˆªå™¨"></a>æ‹¦æˆªå™¨</h2><p>ä¹‹å‰é€šè¿‡<code>Filter</code>æ¥æ‹¦æˆªï¼Œä½†æ˜¯è¿™æœ‰ä¸ªé—®é¢˜ï¼Œå®ƒåªèƒ½æ‹¿åˆ°httpçš„è¯·æ±‚å’Œå“åº”ï¼Œè¿™é‡Œå¸Œæœ›èƒ½çŸ¥é“è¿™ä¸ªè¯·æ±‚æ˜¯å“ªä¸ªæ§åˆ¶å™¨çš„æ–¹æ³•æ¥å¤„ç†çš„ï¼Œé€šè¿‡ä¸Šé¢çš„<code>Filter</code>æ˜¯æ— æ³•å®ç°çš„ï¼Œè¿™æ ·çš„åœºæ™¯å¯ä»¥é€šè¿‡æ‹¦æˆªå™¨æ¥å®ç°</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.interceptor;<span class="hljs-keyword">import</span> java.util.Date;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-keyword">import</span> org.springframework.web.method.HandlerMethod;<span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<span class="hljs-keyword">import</span> org.springframework.web.servlet.ModelAndView;<span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see org.springframework.web.servlet.HandlerInterceptor#preHandle(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, java.lang.Object)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> Exception </span>&#123;System.out.println(<span class="hljs-string">"preHandle"</span>);System.out.println(((HandlerMethod)handler).getBean().getClass().getName());System.out.println(((HandlerMethod)handler).getMethod().getName());request.setAttribute(<span class="hljs-string">"startTime"</span>, <span class="hljs-keyword">new</span> Date().getTime());<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;&#125;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see org.springframework.web.servlet.HandlerInterceptor#postHandle(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, java.lang.Object, org.springframework.web.servlet.ModelAndView)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler,</span></span><span class="hljs-function"><span class="hljs-params">ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;System.out.println(<span class="hljs-string">"postHandle"</span>);Long start = (Long) request.getAttribute(<span class="hljs-string">"startTime"</span>);System.out.println(<span class="hljs-string">"time interceptor è€—æ—¶:"</span>+ (<span class="hljs-keyword">new</span> Date().getTime() - start));&#125;<span class="hljs-comment">/* (non-Javadoc)</span><span class="hljs-comment"> * @see org.springframework.web.servlet.HandlerInterceptor#afterCompletion(javax.servlet.http.HttpServletRequest, javax.servlet.http.HttpServletResponse, java.lang.Object, java.lang.Exception)</span><span class="hljs-comment"> */</span><span class="hljs-meta">@Override</span><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span></span><span class="hljs-function"><span class="hljs-keyword">throws</span> Exception </span>&#123;System.out.println(<span class="hljs-string">"afterCompletion"</span>);Long start = (Long) request.getAttribute(<span class="hljs-string">"startTime"</span>);System.out.println(<span class="hljs-string">"time interceptor è€—æ—¶:"</span>+ (<span class="hljs-keyword">new</span> Date().getTime() - start));System.out.println(<span class="hljs-string">"ex is "</span>+ex);&#125;&#125;</code></pre><p>æ–¹æ³•ä»‹ç»ï¼š</p><ul><li>preHandleï¼šå®ƒçš„è¿”å›å€¼å†³å®šäº†åé¢çš„apiæ˜¯ä¸æ˜¯è¦æ‰§è¡Œï¼Œè¿”å›trueï¼šæ‰§è¡Œï¼Œfalseï¼šè¢«æ‹¦æˆªï¼Œä¸æ‰§è¡Œäº†</li><li>postHandleï¼špostè¯·æ±‚æ‰§è¡Œçš„æ–¹æ³•ï¼Œåœ¨apiæ‰§è¡Œä¹‹åï¼Œæ‰§è¡Œæ­¤æ–¹æ³•</li><li>afterCompletionï¼šå…¶ä»–è¯·æ±‚æ–¹å¼æ‰§è¡Œçš„æ–¹æ³•ï¼Œåœ¨apiæ‰§è¡Œä¹‹åï¼Œæ‰§è¡Œæ­¤æ–¹æ³•</li></ul><p>è¿™é‡Œé€šè¿‡@Componentè¿˜æ²¡ç”Ÿæ•ˆï¼Œè¿˜éœ€è¦åœ¨é…ç½®ç±»ä¸­è¿›è¡Œé…ç½®</p><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebMvcConfigurerAdapter</span> </span>&#123;    <span class="hljs-meta">@Resource</span>    <span class="hljs-keyword">private</span> TimeInterceptor timeInterceptor;    <span class="hljs-meta">@Override</span>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;        <span class="hljs-keyword">super</span>.addInterceptors(registry);        registry.addInterceptor(timeInterceptor);    &#125;    <span class="hljs-comment">//..</span>&#125;</code></pre><p>æµè§ˆå™¨ä¸­è¯·æ±‚<a href="http://localhost:8080/user/v2" target="_blank" rel="noopener">http://localhost:8080/user/v2</a></p><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><pre><code class="hljs java">preHandlecom.b4.mcr.web.controller.UserControllerquery2<span class="hljs-number">2019</span>-<span class="hljs-number">08</span>-<span class="hljs-number">25</span> <span class="hljs-number">15</span>:<span class="hljs-number">09</span>:<span class="hljs-number">57.339</span>  WARN <span class="hljs-number">13856</span> --- [nio-<span class="hljs-number">8080</span>-exec-<span class="hljs-number">2</span>] .m.m.a.ExceptionHandlerExceptionResolver : Resolved exception caused by Handler execution: UserNotExistException(id=<span class="hljs-number">1</span>)afterCompletiontime interceptor è€—æ—¶:<span class="hljs-number">1</span>ex is <span class="hljs-keyword">null</span></code></pre><p>è¿™é‡Œçš„/user/v2ä¸­æŠ›å‡ºäº†ä¸€ä¸ªUserNotExistExceptionå¼‚å¸¸</p><pre><code class="hljs java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"/v2"</span>)   <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;UserVO&gt; <span class="hljs-title">query2</span><span class="hljs-params">()</span> </span>&#123;       <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> UserNotExistException(<span class="hljs-string">"1"</span>);   &#125;</code></pre><p>è¿™æ˜¯å› ä¸ºï¼Œè¿™ä¸ªUserNotExistExceptionè¢«ControllerExceptionHandleræ£€æµ‹ï¼Œæ‰€ä»¥å°±æ‹¿ä¸åˆ°äº†ï¼Œè¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹</p><h2 id="åˆ‡ç‰‡"><a href="#åˆ‡ç‰‡" class="headerlink" title="åˆ‡ç‰‡"></a>åˆ‡ç‰‡</h2><p>ä¹‹å‰ä½¿ç”¨æ‹¦æˆªå™¨æ–¹å¼æ‹¿åˆ°äº†å¤„ç†å™¨ä¸­çš„æ–¹æ³•ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå®ƒæ‹¿ä¸åˆ°æ–¹æ³•ä¸­çš„å‚æ•°ï¼Œæ¥çœ‹ä¸‹<code>DispatcherServlet#doService</code>æ–¹æ³•çš„å†…å®¹</p><pre><code class="hljs java"><span class="hljs-keyword">try</span> &#123;doDispatch(request, response);&#125;</code></pre><p>å®ƒè¿™é‡Œä¼šè°ƒç”¨doDispatchæ–¹æ³•ï¼Œæ¥çœ‹ä¸‹doDispatchçš„è¿™æ®µä»£ç </p><pre><code class="hljs java"><span class="hljs-keyword">if</span> (!mappedHandler.applyPreHandle(processedRequest, response)) &#123;<span class="hljs-keyword">return</span>;&#125;<span class="hljs-comment">// Actually invoke the handler.</span>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code></pre><p>è¿™é‡Œé€šè¿‡<code>mappedHandler</code>è°ƒç”¨äº†<code>applyPreHandle</code>æ–¹æ³•å¹¶ä¼ é€’äº†<code>request</code>ï¼Œ<code>response</code></p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">applyPreHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;HandlerInterceptor[] interceptors = getInterceptors();<span class="hljs-keyword">if</span> (!ObjectUtils.isEmpty(interceptors)) &#123;<span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; interceptors.length; i++) &#123;HandlerInterceptor interceptor = interceptors[i];<span class="hljs-keyword">if</span> (!interceptor.preHandle(request, response, <span class="hljs-keyword">this</span>.handler)) &#123;triggerAfterCompletion(request, response, <span class="hljs-keyword">null</span>);<span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;&#125;<span class="hljs-keyword">this</span>.interceptorIndex = i;&#125;&#125;<span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;&#125;</code></pre><p>å®ƒè¿™é‡Œæ‹¿åˆ°æ‰€æœ‰çš„æ‹¦æˆªå™¨ï¼Œç„¶åéå†è°ƒç”¨<code>preHandle</code>æ–¹æ³•ï¼Œè¿™æ ·ä¸€æ¥å°±èƒ½è°ƒç”¨æˆ‘ä»¬å†™çš„<code>TimeInterceptor#preHandle</code>æ–¹æ³•äº†ï¼Œå¦‚æœè¿”å›<code>false</code>ï¼Œè¿™é‡Œçš„<code>mappedHandler</code>å¯¹è±¡çš„<code>applyPreHandle</code>ä¹Ÿä¼šè¿”å›<code>false</code>ï¼Œç„¶ååœ¨<code>DispatcherServlet#doDispatch</code>å°±ç›´æ¥è¿”å›ï¼Œä¸åœ¨å¾€ä¸‹èµ°äº†ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œ    <code>mv = ha.handle(processedRequest, response, mappedHandler.getHandler());</code>äº†ï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯è°ƒç”¨å¤„ç†å™¨çš„æ–¹æ³•ä¸è¢«æ‰§è¡Œï¼Œè¿™å°±æ˜¯åœ¨<code>TimeInterceptor#preHandle</code>æ–¹æ³•ä¸­è¿”å›<code>false</code>ï¼Œå°±ä¸ä¼šæ‰§è¡Œapiçš„åŸå› ï¼Œç„¶åå†è¯´ä¸‹æ‹¦æˆªå™¨ä¸ºä»€ä¹ˆæ‹¿ä¸åˆ°å¤„ç†å™¨æ–¹æ³•çš„å‚æ•°ï¼Ÿâ€”â€”è¯·çœ‹</p><pre><code class="hljs java">mappedHandler.applyPreHandle(processedRequest, response)</code></pre><p>è¿™æ˜¯ä¸æ˜¯åªä¼ äº†requestã€responseï¼Œè€Œæ²¡ä¼ é€’handlerå‚æ•°ï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªæ—¶å€™ï¼Œhandleræ˜¯ç©ºçš„</p><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span></span></code></pre><p>è¿™ä¸ªhandlerå‚æ•°æ˜¯åœ¨æ‰§è¡Œäº†è¿™æ®µä»£ç æ‰æ‹¿åˆ°çš„ï¼Œæ‰€ä»¥è¯´<code>preHandle</code>å¹¶ä¸çŸ¥é“å‚æ•°é•¿æˆä»€ä¹ˆä¸«å­çš„</p><pre><code class="hljs java">mv = ha.handle(processedRequest, response, mappedHandler.getHandler())</code></pre><hr><p>é€šè¿‡åˆ‡ç‰‡å°±å¯ä»¥æ»¡è¶³è¿™æ ·çš„ä¸šåŠ¡éœ€æ±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.aspect;<span class="hljs-keyword">import</span> java.util.Date;<span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;<span class="hljs-meta">@Aspect</span><span class="hljs-meta">@Component</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TimeAspect</span> </span>&#123;<span class="hljs-meta">@Around</span>(<span class="hljs-string">"execution(* com.b4.mcr.web.controller.*.*(..))"</span>)<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">handleControllerMethod</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;System.out.println(<span class="hljs-string">"time aspect start"</span>);Object[] args = pjp.getArgs();<span class="hljs-keyword">for</span> (Object arg : args) &#123;System.out.println(<span class="hljs-string">"arg is "</span>+arg);&#125;<span class="hljs-keyword">long</span> start = <span class="hljs-keyword">new</span> Date().getTime();Object object = pjp.proceed();System.out.println(<span class="hljs-string">"time aspect è€—æ—¶:"</span>+ (<span class="hljs-keyword">new</span> Date().getTime() - start));System.out.println(<span class="hljs-string">"time aspect end"</span>);<span class="hljs-keyword">return</span> object;&#125;&#125;</code></pre><p>ä½¿ç”¨<code>post man</code>å‘é€è¯·æ±‚</p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566719187552.png" srcset="/img/loading.gif" alt="1566719187552"></p><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><pre><code class="hljs pgsql">t1<span class="hljs-type">time</span> aspect <span class="hljs-keyword">start</span>arg <span class="hljs-keyword">is</span> UserVO(userName=t1, <span class="hljs-keyword">password</span>=t1)<span class="hljs-type">time</span> aspect è€—æ—¶:<span class="hljs-number">0</span><span class="hljs-type">time</span> aspect <span class="hljs-keyword">end</span></code></pre><h2 id="æ‰§è¡Œé¡ºåº"><a href="#æ‰§è¡Œé¡ºåº" class="headerlink" title="æ‰§è¡Œé¡ºåº"></a>æ‰§è¡Œé¡ºåº</h2><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566719359465.png" srcset="/img/loading.gif" alt="1566719359465"></p><h1 id="Swaggeræ–‡æ¡£"><a href="#Swaggeræ–‡æ¡£" class="headerlink" title="Swaggeræ–‡æ¡£"></a>Swaggeræ–‡æ¡£</h1><blockquote><p>ç¬”è€…æ­£åœ¨è¡¥å……~</p></blockquote>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸€ã€Restful Api ã€‘  2.Hello Spring Security</title>
    <link href="/spring-security-1.2.html"/>
    <url>/spring-security-1.2.html</url>
    
    <content type="html"><![CDATA[<p>åœ¨<code>demo</code>ä¸­ç¼–å†™<code>Application</code>å¹¶å¯åŠ¨</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr;<span class="hljs-keyword">import</span> org.springframework.boot.SpringApplication;<span class="hljs-keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;<span class="hljs-meta">@SpringBootApplication</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">McrAuthDemoApplication</span> </span>&#123;    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;        SpringApplication.run(McrAuthDemoApplication<span class="hljs-class">.<span class="hljs-keyword">class</span>, <span class="hljs-title">args</span>)</span>;    &#125;&#125;</code></pre><p>å¯åŠ¨ä¸­å‡ºç°ä¸€ä¸ªå¼‚å¸¸ï¼ŒåŸå› æ˜¯åœ¨<code>core</code>ä¸­ä¾èµ–äº†<code>spring-sesion</code></p><pre><code class="hljs routeros">019-08-24 13:46:59.655 <span class="hljs-builtin-name">ERROR</span> 27780 --- [ost-startStop-1] o.s.b.web.embedded.tomcat.TomcatStarter  : <span class="hljs-builtin-name">Error</span> starting Tomcat context. Exception: org.springframework.beans.factory.UnsatisfiedDependencyException. Message: <span class="hljs-builtin-name">Error</span> creating bean with name <span class="hljs-string">'sessionRepositoryFilterRegistration'</span> defined <span class="hljs-keyword">in</span> class path<span class="hljs-built_in"> resource </span>[org/springframework/boot/autoconfigure/session/SessionRepositoryFilterConfiguration.class]: Unsatisfied dependency expressed through method <span class="hljs-string">'sessionRepositoryFilterRegistration'</span> parameter 1; nested exception is org.springframework.beans.factory.BeanCreationException: <span class="hljs-builtin-name">Error</span> creating bean with name <span class="hljs-string">'org.springframework.boot.autoconfigure.session.JdbcSessionConfiguration$SpringBootJdbcHttpSessionConfiguration'</span>: Injection of autowired dependencies failed; nested exception is java.lang.NoSuchMethodError: org.springframework.boot.autoconfigure.session.JdbcSessionConfiguration<span class="hljs-variable">$SpringBootJdbcHttpSessionConfiguration</span>.setCleanupCron(Ljava/lang/String;)V</code></pre><p>è¿™é‡Œé…ç½®ä¸€ä¸‹<code>demo</code>æ¨¡å—çš„é…ç½®æ–‡ä»¶ï¼Œå†æ¬¡å¯åŠ¨å°±ä¸ä¼šå‡ºç°å¼‚å¸¸äº†</p><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span>  <span class="hljs-attr">session:</span>    <span class="hljs-attr">store-type:</span> <span class="hljs-string">none</span></code></pre><p>é¦–å…ˆç¼–å†™ä¸€ä¸ª<code>controller</code>è¿›è¡Œæµ‹è¯•</p><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.b4.mcr.web.controller;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<span class="hljs-meta">@RestController</span><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestController</span> </span>&#123;    <span class="hljs-meta">@RequestMapping</span>(<span class="hljs-string">"/test"</span>)    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>&#123;        <span class="hljs-keyword">return</span> <span class="hljs-string">"test"</span>;    &#125;&#125;</code></pre><p><em>è®¿é—®</em><a href="http://localhost:8080/test" target="_blank" rel="noopener">http://localhost:8080/test</a></p><p><img src="https://shui-blog.oss-cn-shenzhen.aliyuncs.com/1566658180434.png" srcset="/img/loading.gif" alt="1566658180434"></p><blockquote><p>spring bootä¼šæä¾›ä¸€äº›é»˜è®¤çš„spring securityé…ç½®ï¼Œæ‰€ä»¥åœ¨è¿›è¡Œè®¿é—®apiæ—¶ä¼šè¿›è¡Œæ‹¦æˆª</p></blockquote><p>åœ¨ç« èŠ‚å¼€å§‹ï¼Œç¬”è€…ä¸ä¼šç›´æ¥å»è®²spring securityçš„å†…å®¹ï¼Œè€Œä¼šå»è¯´ä¸€äº›Webçš„ç›¸å…³çŸ¥è¯†ï¼Œæ‰€ä»¥æŠŠspring bootæä¾›çš„é…ç½®ç¦ç”¨ä¸€ä¸‹</p><hr><p><code>application.yml</code></p><pre><code class="hljs yaml"><span class="hljs-attr">security:</span>  <span class="hljs-attr">basic:</span>    <span class="hljs-attr">enabled:</span> <span class="hljs-literal">false</span></code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ã€ ä¸€ã€Restful Api ã€‘  1.ä»£ç ç»“æ„ä»‹ç»</title>
    <link href="/spring-security-1.1.html"/>
    <url>/spring-security-1.1.html</url>
    
    <content type="html"><![CDATA[<h1 id="æ¨¡å—ä»‹ç»"><a href="#æ¨¡å—ä»‹ç»" class="headerlink" title="æ¨¡å—ä»‹ç»"></a>æ¨¡å—ä»‹ç»</h1><p>ç¬”è€…ä½¿ç”¨çš„æ˜¯<code>maven</code>è¿›è¡Œæ„å»ºçš„å·¥ç¨‹ï¼Œè¿™é‡Œç»™è¯»è€…ä»¬ä»‹ç»ä¸€ä¸‹æ¨¡å—çš„å«ä¹‰ä»¥åŠ<code>pom.xml</code>ä¸­æ‰€éœ€è¦çš„ä¾èµ–</p><table><thead><tr><th align="center">æ¨¡å—</th><th align="center">ä»‹ç»</th></tr></thead><tbody><tr><td align="center">mcr-auth</td><td align="center">ä¸»æ¨¡å—</td></tr><tr><td align="center">mcr-auth-core</td><td align="center">æ ¸å¿ƒä¸šåŠ¡é€»è¾‘</td></tr><tr><td align="center">mcr-auth-browser</td><td align="center">æµè§ˆå™¨å®‰å…¨ç‰¹å®šä»£ç </td></tr><tr><td align="center">mcr-auth-app</td><td align="center">appç›¸å…³ç‰¹å®šä»£ç </td></tr><tr><td align="center">mcr-auth-demo</td><td align="center">æ ·ä¾‹ç¨‹åº</td></tr></tbody></table><h1 id="mcr-auth"><a href="#mcr-auth" class="headerlink" title="mcr-auth"></a>mcr-auth</h1><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">mcr.version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">mcr.version</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>8.0.17<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>     <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mysql.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>         <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.spring.platform<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>platform-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>Brussels-SR4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>         <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>         <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>Dalston.SR2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>             <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>         <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>     <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span></code></pre><h1 id="mcr-auth-core"><a href="#mcr-auth-core" class="headerlink" title="mcr-auth-core"></a>mcr-auth-core</h1><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>   <span class="hljs-comment">&lt;!-- &lt;dependency&gt;</span><span class="hljs-comment">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><span class="hljs-comment">        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;</span><span class="hljs-comment">    &lt;/dependency&gt;--&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.social<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-social-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.social<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-social-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.social<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-social-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.social<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-social-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-collections<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-beanutils<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.5.7.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.projectlombok<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>lombok<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.18.8<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><h1 id="mcr-auth-browser"><a href="#mcr-auth-browser" class="headerlink" title="mcr-auth-browser"></a>mcr-auth-browser</h1><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mcr.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>      <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.session<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-session<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>          <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>      <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><h1 id="mcr-auth-app"><a href="#mcr-auth-app" class="headerlink" title="mcr-auth-app"></a>mcr-auth-app</h1><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;mcr.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></code></pre><h1 id="mcr-auth-demo"><a href="#mcr-auth-demo" class="headerlink" title="mcr-auth-demo"></a>mcr-auth-demo</h1><h2 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h2><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.b4<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mcr-auth-browser<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger2<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.springfox<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>springfox-swagger-ui<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.tomakehurst<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>wiremock<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>   <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>   <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>           <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>               <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>               <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>               <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>               <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>                   <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>                       <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>                           <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span>                       <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>                   <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>               <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>           <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>       <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>       <span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span>   <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span></code></pre><h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a><strong>application.yml</strong></h2><pre><code class="hljs yml"><span class="hljs-attr">server:</span>  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><span class="hljs-attr">spring:</span>  <span class="hljs-attr">datasource:</span>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://mcr.com:3306/mcr?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false</span></code></pre>]]></content>
    
    
    <categories>
      
      <category>åç«¯</category>
      
      <category>SpringSecurity</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å­¦ä¹ </tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
